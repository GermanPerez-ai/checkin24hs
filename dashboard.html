<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkin24hs - Panel de Administración</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="logo-checkin24hs-circular-olive.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        body.authenticated {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background-color: #1976d2;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: white;
            text-decoration: none;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .menu-item.active {
            background-color: rgba(255,255,255,0.2);
        }

        .menu-item .material-icons {
            margin-right: 12px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: 240px;
            flex: 1;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            color: #333;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .user-button:hover {
            background-color: #f5f5f5;
        }

        .user-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item .material-icons {
            margin-right: 8px;
            font-size: 18px;
        }

        /* Content Area */
        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 24px;
            color: #333;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: white;
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .trend-up {
            color: #2e7d32;
        }

        .trend-down {
            color: #d32f2f;
        }

        /* Activity and Chart Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .activity-card, .chart-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #1976d2;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }

        .chart-placeholder {
            min-height: 200px;
            background-color: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        #monthlySalesContent:has(table) {
            background-color: transparent;
            padding: 0;
            min-height: auto;
        }

        /* Form Buttons */
        .form-button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
        }

        .form-button:hover {
            background-color: #1565c0;
        }

        .form-button.secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .form-button.secondary:hover {
            background-color: #e0e0e0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #f5f5f5;
            font-weight: 500;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .hotel-name {
            font-weight: 500;
            color: #1976d2;
        }

        .hotel-location {
            color: #666;
            font-size: 0.9rem;
        }

        .rating-stars {
            color: #ffc107;
        }

        .status-active {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .action-btn.edit {
            color: #1976d2;
        }

        .action-btn.delete {
            color: #d32f2f;
        }

        .action-btn.view {
            color: #2e7d32;
        }
        
        /* Estilos para tabla de usuarios */
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-weight: 500;
            color: #333;
        }
        
        .user-email {
            font-size: 0.85rem;
            color: #666;
        }
        
        .user-type {
            font-size: 0.75rem;
            color: #999;
            font-style: italic;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-badge.inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .btn-edit, .btn-delete {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #1976d2;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        /* Estilos para la sección de cotizaciones */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-box input {
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 250px;
        }
        
        .search-box .material-icons {
            position: absolute;
            right: 12px;
            color: #666;
            font-size: 18px;
        }
        
        .quote-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .quote-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .quote-status.enviado {
            background: #cfe2ff;
            color: #084298;
        }
        
        .quote-status.processed {
            background: #d4edda;
            color: #155724;
        }
        
        .quote-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #1976d2;
        }
        
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-btn.secondary:hover {
            background: #5a6268;
        }
        
        .action-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .action-btn.danger:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        /* OCULTAR CAMPOS DE IMAGEN - SOLUCIÓN CSS DEFINITIVA */
        #editHotelImage,
        #editHotelPhotos,
        #editImagePreview,
        #editPhotosPreview,
        /* Botones de selección de imágenes - AHORA VISIBLES */
        #btnSelectMainImage,
        #btnSelectGalleryImages {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            width: auto !important;
            position: relative !important;
            left: auto !important;
            pointer-events: auto !important;
        }
        
        /* Ocultar form-group que contiene campos de imagen usando selector universal */
        #editHotelModal .form-group {
            position: relative;
        }
        
        #editHotelModal .form-group:has(#editHotelImage),
        #editHotelModal .form-group:has(#editHotelPhotos),
        #editHotelModal .form-group:has(#editImagePreview),
        #editHotelModal .form-group:has(#editPhotosPreview) {
            display: none !important;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-title {
            margin-bottom: 16px;
            color: #333;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        /* OCULTAR CAMPOS DE IMAGEN - SOLUCIÓN CSS DEFINITIVA */
        #editHotelImage,
        #editHotelPhotos,
        #editImagePreview,
        #editPhotosPreview {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Ocultar cualquier form-group que contenga campos de imagen */
        form#editHotelForm .form-group:has(#editHotelImage),
        form#editHotelForm .form-group:has(#editHotelPhotos) {
            display: none !important;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .form-input[type="number"] {
            width: 100%;
        }

        .form-input[type="url"] {
            width: 100%;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-top: 8px;
        }

        .photos-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .photo-preview {
            width: 80px;
            height: 60px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            object-fit: cover;
        }

        /* Image Manager Styles */
        .image-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            width: 120px;
            height: 140px;
            display: inline-block;
            margin: 5px;
        }

        .image-item:hover {
            border-color: #1976d2;
            transform: scale(1.05);
        }

        .image-item.selected {
            border-color: #2e7d32;
            background-color: #e8f5e8;
        }

        .image-preview {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .photo-placeholder {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            position: relative;
        }

        .photo-placeholder.selected {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .photo-placeholder .material-icons {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .photo-number {
            font-weight: bold;
            font-size: 0.6rem;
        }

        .image-item .image-name {
            padding: 5px;
            font-size: 0.7rem;
            color: #333;
            background-color: white;
            text-align: center;
            word-break: break-word;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .select-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #2e7d32;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-item.selected .select-overlay {
            opacity: 1;
        }

        .image-actions {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .btn-view, .btn-delete {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: #2196f3;
            color: white;
        }

        .btn-view:hover {
            background: #1976d2;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .photo-counter {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #388e3c;
        }

        .upload-progress {
            background-color: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            margin-top: 10px;
            overflow: hidden;
        }

        .upload-progress-bar {
            background-color: #1976d2;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 4px;
            }
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        /* Estilos para el carrusel de fotos */
        #photoCarouselModal .modal-content {
            background: transparent;
            box-shadow: none;
        }

        #carouselImage {
            transition: all 0.3s ease;
        }

        #carouselImage:hover {
            transform: scale(1.02);
        }

        #prevButton:hover, #nextButton:hover {
            background: rgba(0,0,0,0.9) !important;
            transform: translateY(-50%) scale(1.1);
        }

        #carouselThumbnails::-webkit-scrollbar {
            height: 6px;
        }

        #carouselThumbnails::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.7);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            #prevButton, #nextButton {
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
            }
            
            #carouselThumbnails {
                bottom: 60px !important;
                max-width: 90% !important;
            }
            
            #photoCounter {
                bottom: 15px !important;
                font-size: 12px !important;
            }
        }
        
        /* Estilos para botones de acción */
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            margin: 0 2px;
            transition: background-color 0.3s;
        }
        
        .action-btn.edit {
            color: #1976d2;
        }
        
        .action-btn.edit:hover {
            background-color: rgba(25, 118, 210, 0.1);
        }
        
        .action-btn.delete {
            color: #d32f2f;
        }
        
        .action-btn.delete:hover {
            background-color: rgba(211, 47, 47, 0.1);
        }
        
        .action-btn.view {
            color: #388e3c;
        }
        
        .action-btn.view:hover {
            background-color: rgba(56, 142, 60, 0.1);
        }
        
        /* Estilos para estados de hoteles */
        .status-activo {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-inactivo {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-en-mantenimiento {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Estilos para estados de reservas */
        .status-confirmada {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pendiente {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-cancelada {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-modificada {
            background-color: #03a9f4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Estilos para el modal de edición de reservas */
        .form-grid {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 12px;
        }

        .form-section h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Estilos para la tabla de hoteles */
        .hotel-name {
            font-weight: 500;
            color: #333;
        }
        
        .hotel-location {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Estilos para estrellas de calificación */
        .rating-stars {
            color: #ffc107;
            font-size: 16px;
        }

        /* Estilos para pantalla de login */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.85) 0%, rgba(118, 75, 162, 0.85) 100%),
                        url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=2073&q=80') center center / cover no-repeat;
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .login-container.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-input-group {
            position: relative;
        }

        .form-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-input-group input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-input-group .input-icon {
            position: absolute;
            right: 16px;
            top: 42px;
            color: #666;
            cursor: pointer;
        }

        .login-error {
            background-color: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            border: 1px solid #fcc;
        }

        .login-error.show {
            display: block;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn-login:hover {
            background-color: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .btn-login:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo img {
            max-width: 120px;
            height: auto;
        }

        .dashboard-content {
            display: none;
        }

        .dashboard-content.authenticated {
            display: flex;
            width: 100%;
        }

        body.authenticated .dashboard-content {
            display: flex;
        }
    </style>
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    <!-- Supabase Client -->
    <script src="supabase-client.js"></script>
    <!-- Migration Script (opcional - descomentar si quieres migrar automáticamente) -->
    <!-- <script src="migrate-to-supabase.js"></script> -->
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">
                <img src="logo-checkin24hs-circular-olive.svg" alt="Checkin24hs" onerror="this.style.display='none'">
            </div>
            <div class="login-header">
                <h1>Panel de Administración</h1>
                <p>Ingresa tus credenciales para continuar</p>
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-input-group">
                    <label for="loginUsername">Usuario</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        name="username" 
                        placeholder="Ingresa tu usuario" 
                        required 
                        autocomplete="username"
                    >
                </div>
                
                <div class="form-input-group">
                    <label for="loginPassword">Contraseña</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        name="password" 
                        placeholder="Ingresa tu contraseña" 
                        required 
                        autocomplete="current-password"
                    >
                    <span class="material-icons input-icon" onclick="togglePasswordVisibility()" style="pointer-events: all;">visibility</span>
                </div>
                
                <button type="submit" class="btn-login" id="loginButton">
                    Iniciar Sesión
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido del Dashboard (oculto hasta autenticación) -->
    <div class="dashboard-content" id="dashboardContent">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Checkin24hs Admin</h2>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="window.showSection('dashboard', event)">
                <span class="material-icons">dashboard</span>
                Dashboard
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('hotels', event)">
                <span class="material-icons">hotel</span>
                Hoteles
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('reservations', event)">
                <span class="material-icons">event</span>
                Reservas
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('users', event)">
                <span class="material-icons">people</span>
                Usuarios
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('quotes', event)">
                <span class="material-icons">receipt</span>
                Cotizaciones
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('expenses', event)">
                <span class="material-icons">account_balance_wallet</span>
                Gastos
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('administrators', event)" id="adminMenuLink" style="display: none;">
                <span class="material-icons">admin_panel_settings</span>
                Administradores
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <span class="material-icons">menu</span>
            </button>
            <h1>Panel de Administración</h1>
            <div class="user-menu">
                <button class="user-button" onclick="toggleUserMenu()">
                    <span class="material-icons">account_circle</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item">
                        <span class="material-icons">person</span>
                        Administrador
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <span class="material-icons">logout</span>
                        Cerrar Sesión
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="page-title">Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardTotalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsTotal">$0</h3>
                                <p>Sumatoria Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">event</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span style="font-size: 2rem; font-weight: bold; color: white;">$</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardMonthlySales">$0</h3>
                                <p>Ingresos del Mes Vigente</p>
                            </div>
                        </div>
                        <div class="stat-trend" id="dashboardMonthlyReservations">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                </div>

                <!-- Activity and Chart Grid -->
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Ventas Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlySalesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="monthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="monthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Hotel:</label>
                                <select id="hotelFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="all">Todos los hoteles</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#1565c0'" onmouseout="this.style.backgroundColor='#1976d2'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlySalesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Gastos Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlyExpensesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="expenseMonthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="expenseMonthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Categoría:</label>
                                    <select id="expenseCategoryFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todas las categorías</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Tipo de Gasto:</label>
                                    <select id="expenseTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todos los tipos</option>
                                        <option value="fixed">Fijo</option>
                                        <option value="variable">Variable</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#c62828'" onmouseout="this.style.backgroundColor='#d32f2f'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlyExpensesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>
                </div>

                <!-- Test Buttons for Debugging -->
                <div style="margin-top: 24px; margin-bottom: 24px; padding: 16px; background: #f0f8ff; border-radius: 8px; border: 1px solid #1976d2;">
                    <h4 style="margin-bottom: 12px; color: #1976d2;">🔧 Botones de Prueba</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="crearUsuariosPrueba()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add_circle</span>
                            Crear Usuarios Prueba
                        </button>
                                                    <button class="form-button" style="background: #2196f3; color: white;" onclick="window.showSection('users', event)">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">people</span>
                            Ir a Usuarios
                        </button>
                        <button class="form-button" style="background: #4caf50; color: white;" onclick="loadUsersData()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                            Cargar Datos
                        </button>
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="updateUsersFromReservations()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                            Actualizar Usuarios desde Reservas
                        </button>
                        <button class="form-button" style="background: #f44336; color: white;" onclick="deleteAllUsers()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete_forever</span>
                            Eliminar Todos los Usuarios
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hotels Section - NUEVO MÓDULO LIMPIO -->
            <div id="hotels-section" style="display: none;">
                <h2 class="page-title">🏨 Gestión de Hoteles</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewHotel()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Agregar Hotel
                    </button>
                    <button class="form-button secondary" onclick="exportHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Datos
                    </button>
                    <button class="form-button secondary" onclick="refreshHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">location_on</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalLocations">0</h3>
                                <p>Ubicaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="priceRange">$0-$0</h3>
                                <p>Rango de Precios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hotels Table -->
                <div class="activity-card">
                    <h3 class="card-title">Hoteles Vigentes</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Ubicación</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Calificación</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Precio</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="hotelsTableBody">
                                <!-- Los hoteles se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reservations Section -->
            <div id="reservations-section" style="display: none;">
                <h2 class="page-title">Gestión de Reservas</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewReservation()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Nueva Reserva
                    </button>
                    <button class="form-button" onclick="addNewAgent()" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Agente
                    </button>
                    <button class="form-button secondary" onclick="exportReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Reservas
                    </button>
                    <button class="form-button secondary" onclick="importReservations()" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Reservas
                    </button>
                    <button class="form-button secondary" onclick="refreshReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" onclick="deleteAllReservations()" style="background: #f44336; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete_forever</span>
                        Eliminar Todas las Reservas
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalReservations">0</h3>
                                <p>Total Reservas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="confirmedReservations">0</h3>
                                <p>Confirmadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #03a9f4;">
                                <span class="material-icons">edit</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="modifiedReservations">0</h3>
                                <p>Modificadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">cancel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="canceledReservations">0</h3>
                                <p>Canceladas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="showTotalRevenueModal()">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsCount">0</h3>
                                <p>Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>
                </div>

                <!-- Reservations Table -->
                <div class="activity-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">Reservas Activas</h3>
                        <div style="position: relative; width: 300px;">
                            <input 
                                type="text" 
                                id="reservationSearchInput" 
                                placeholder="Buscar por código, email, nombre, apellido, hotel..." 
                                style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                onkeyup="filterReservationsByCode(this.value)"
                                oninput="filterReservationsByCode(this.value)"
                            >
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">🔍</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Código</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Fechas</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Total</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reservationsTableBody">
                                <!-- Las reservas se cargarán dinámicamente -->
                            </tbody>
                        </table>
                                </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div id="editReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="editReservationTitle">Modificar Reserva</h2>
            </div>
            <form id="editReservationForm" onsubmit="saveReservationChanges(event)">
                <div class="form-grid">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3>👤 Información del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientName">Nombre Completo</label>
                                <input type="text" id="editClientName" name="clientName" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editClientEmail">Email</label>
                                <input type="email" id="editClientEmail" name="clientEmail" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientPhone">Teléfono</label>
                                <input type="tel" id="editClientPhone" name="clientPhone" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Reserva -->
                    <div class="form-section">
                        <h3>🏨 Información de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editHotelSelect">Hotel</label>
                                <select id="editHotelSelect" name="hotelId" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editReservationCode">Código de Reserva</label>
                                <input type="text" id="editReservationCode" name="reservationCode" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="editCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="editCheckOut">Fecha de Salida *</label>
                                <input type="date" id="editCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editReservationDate">Fecha de Registro</label>
                                <input type="date" id="editReservationDate" name="reservationDate" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editAgentSelect">Agente Responsable</label>
                                <select id="editAgentSelect" name="agentName" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Información de Pago -->
                    <div class="form-section">
                        <h3>💰 Información de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTotalAmount">Tarifa (USD) *</label>
                                <input type="number" id="editTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeEditReservationModal()" class="btn btn-secondary">Salir</button>
                    <button type="button" onclick="cancelReservation()" class="btn btn-secondary" style="background: #dc3545; color: white;">Cancelar Reserva</button>
                    <button type="submit" class="btn btn-primary">Modificar Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Reservation Modal -->
    <div id="newReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>🆕 Nueva Reserva</h2>
            </div>
            <form id="newReservationForm" onsubmit="saveNewReservation(event)">
                <div class="form-grid">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3>👤 Información del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientName">Nombre Completo *</label>
                                <input type="text" id="newClientName" name="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="newClientEmail">Email *</label>
                                <input type="email" id="newClientEmail" name="clientEmail" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientPhone">Teléfono *</label>
                                <input type="tel" id="newClientPhone" name="clientPhone" required>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Reserva -->
                    <div class="form-section">
                        <h3>🏨 Información de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newHotelSelect">Hotel *</label>
                                <select id="newHotelSelect" name="hotelId" required>
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newReservationCode">Código de Reserva *</label>
                                <input type="text" id="newReservationCode" name="reservationCode" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="newCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="newCheckOut">Fecha de Salida *</label>
                                <input type="date" id="newCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newReservationDate">Fecha de Registro *</label>
                                <input type="date" id="newReservationDate" name="reservationDate" required>
                            </div>
                            <div class="form-group">
                                <label for="newAgentSelect">Agente Responsable *</label>
                                <select id="newAgentSelect" name="agentName" required>
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- Información de Pago -->
                    <div class="form-section">
                        <h3>💰 Información de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newStatus">Estado de la Reserva *</label>
                                <select id="newStatus" name="status" required>
                                    <option value="Confirmada" selected>Confirmada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTotalAmount">Total (USD) *</label>
                                <input type="number" id="newTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeNewReservationModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Agent Modal -->
    <div id="newAgentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 505px; width: 85%;">
            <div class="modal-header">
                <h2>👤 Nuevo Agente</h2>
                <button onclick="closeNewAgentModal()" class="close-btn">&times;</button>
            </div>
            <form id="newAgentForm" onsubmit="saveNewAgent(event)">
                <div class="form-grid">
                    <div class="form-section">
                        <h3>📋 Información del Agente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentCode">Código de Agente *</label>
                                <input type="text" id="newAgentCode" name="agentCode" readonly required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentName">Nombre *</label>
                                <input type="text" id="newAgentName" name="agentName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentAgency">Agencia *</label>
                                <input type="text" id="newAgentAgency" name="agentAgency" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeNewAgentModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Agente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Reservations Modal -->
    <div id="importReservationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header">
                <h2>📥 Importar Reservas desde Excel</h2>
                <button onclick="closeImportReservationsModal()" class="close-btn">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">
                    Selecciona un archivo Excel (.xlsx) con las reservas a importar. 
                    El archivo debe tener las columnas: Código, Cliente, Email, Teléfono, Hotel, Fecha Entrada, Fecha Salida, Fecha Registro, Agente, Estado, Total.
                </p>
                <div style="margin-bottom: 20px;">
                    <label for="importFileInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Seleccionar archivo Excel:
                    </label>
                    <input type="file" id="importFileInput" accept=".xlsx,.xls" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>⚠️ Nota:</strong> Las reservas con códigos duplicados serán actualizadas. Las nuevas se agregarán.
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeImportReservationsModal()" class="form-button secondary">Cancelar</button>
                    <button type="button" onclick="processImportFile()" class="form-button" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Section -->
            <div id="users-section" style="display: none;">
                <h2 class="page-title">Gestión de Usuarios</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="showImportUsersModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="exportUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="refreshUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showMarketingTools()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">campaign</span>
                        Herramientas Marketing
                    </button>
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="showUserAnalytics()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                        Análisis Usuarios
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">person_add</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="newUsers">0</h3>
                                <p>Nuevos este mes</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                            <span class="material-icons">receipt</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalQuotes">0</h3>
                                <p>Total Cotizaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">star</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="avgUserRating">0.0</h3>
                                <p>Calificación Promedio</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="activity-card">
                    <h3 class="card-title">Usuarios Registrados - Panel de Administración</h3>
                    
                    <!-- Buscador de usuarios -->
                    <div style="margin-bottom: 16px; margin-top: 16px;">
                        <div style="position: relative;">
                            <input type="text" id="usersSearchInput" placeholder="Buscar usuarios por nombre, email o teléfono..." 
                                   style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s;"
                                   onkeyup="searchUsers()" oninput="searchUsers()">
                            <span class="material-icons" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">search</span>
                        </div>
                        <div id="usersSearchInfo" style="margin-top: 8px; font-size: 0.85rem; color: #666; display: none;">
                            <span id="usersSearchCount">0</span> resultados encontrados
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Teléfono</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cotizaciones</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Última Actividad</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Marketing</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Administrators Section -->
            <div id="administrators-section" style="display: none;">
                <h2 class="page-title">Gestión de Administradores</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showNewAdminModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Administrador
                    </button>
                    <button class="form-button secondary" onclick="refreshAdmins()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">admin_panel_settings</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdmins">0</h3>
                                <p>Total Administradores</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">verified_user</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsTotal">0</h3>
                                <p>Administradores Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">person</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsUser">0</h3>
                                <p>Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeAdmins">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Administrators Table -->
                <div class="activity-card">
                    <h3 class="card-title">Lista de Administradores</h3>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Rol</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Último Login</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Los administradores se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quotes Section -->
            <div id="quotes-section" style="display: none;">
                <h2 class="page-title">Gestión de Cotizaciones</h2>
                
                <!-- Estadísticas de Cotizaciones -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalQuotes">0</div>
                            <div class="stat-label">Total Cotizaciones</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏳</div>
                        <div class="stat-content">
                            <div class="stat-number" id="pendingQuotes">0</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="processedQuotes">0</div>
                            <div class="stat-label">Procesadas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgQuotesPerDay">0</div>
                            <div class="stat-label">Promedio/Día</div>
                        </div>
                    </div>
                </div>

                <!-- Controles de Cotizaciones -->
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="showNewQuoteModal()" style="background: #28a745;">
                            <span class="material-icons">add</span>
                            Nueva Cotización
                        </button>
                        <button class="action-btn primary" onclick="showSendCotizadorLinkModal()" style="background: #25d366;">
                            <span class="material-icons">link</span>
                            Enviar Link Cotizador
                        </button>
                        <button class="action-btn primary" onclick="refreshQuotes()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                        <button class="action-btn secondary" onclick="exportQuotes()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn danger" onclick="clearAllQuotes()">
                            <span class="material-icons">delete_sweep</span>
                            Limpiar Todo
                        </button>
                        <button class="action-btn primary" onclick="testQuotesSync()">
                            <span class="material-icons">bug_report</span>
                            Probar Sincronización
                        </button>
                        <input type="file" id="quoteImageUpload" accept="image/*" style="display: none;" onchange="handleQuoteImageUpload(event)">
                        <button class="action-btn primary" onclick="document.getElementById('quoteImageUpload').click()" style="background: #9c27b0;">
                            <span class="material-icons">image</span>
                            Subir Imagen
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="quotesSearch" placeholder="Buscar cotizaciones..." onkeyup="filterQuotes()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Tabla de Cotizaciones -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hotel</th>
                                <th>Cliente</th>
                                <th>Fechas</th>
                                <th>Huéspedes</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="quotesTableBody">
                            <!-- Las cotizaciones se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay cotizaciones -->
                <div id="noQuotesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">📋</div>
                    <h3>No hay cotizaciones</h3>
                    <p>Las cotizaciones enviadas desde el sitio web aparecerán aquí automáticamente.</p>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses-section" style="display: none;">
                <h2 class="page-title">Gestión de Gastos</h2>
                
                <!-- KPIs de Eficiencia de Costos -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #d32f2f;">
                                <span class="material-icons">trending_down</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpaValue">$0</h3>
                                <p>Costo por Adquisición (CPA)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpaSubtitle">Gasto Marketing / Reservas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f57c00;">
                                <span class="material-icons">phone</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpcValue">$0</h3>
                                <p>Costo por Llamada (CPC)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpcSubtitle">Costos Telecom + Agentes / Llamadas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">account_balance</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalExpenses">$0</h3>
                                <p>Gastos Totales</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="totalExpensesSubtitle">Fijos + Variables</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #388e3c;">
                                <span class="material-icons">compare_arrows</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="budgetVariance">0%</h3>
                                <p>Variación Presupuesto</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="budgetVarianceSubtitle">Real vs Presupuestado</span>
                        </div>
                    </div>
                </div>

                <!-- Controles de Gastos -->
                <div class="action-bar" style="margin-bottom: 24px;">
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="addNewExpense()">
                            <span class="material-icons">add</span>
                            Agregar Gasto
                        </button>
                        <button class="action-btn secondary" onclick="exportExpenses()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn secondary" onclick="refreshExpenses()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="expensesSearch" placeholder="Buscar gastos..." onkeyup="filterExpenses()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Grid de Gráficos y Tabla -->
                <div class="dashboard-grid">
                    <!-- Gráfico de Composición de Gastos (Pie Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Composición del Gasto</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="expensesCompositionChart"></canvas>
                        </div>
                        <div id="expensesCompositionLegend" style="margin-top: 16px; display: flex; justify-content: center; flex-wrap: wrap; gap: 16px;">
                            <!-- Leyenda se generará dinámicamente -->
                        </div>
                    </div>

                    <!-- Gráfico de Desglose de Gastos Variables (Bar Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Desglose de Gastos Variables</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="variableExpensesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Gasto vs Presupuesto (Line Chart) -->
                <div class="chart-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin: 0;">Gasto vs Presupuesto</h3>
                        <div style="display: flex; gap: 12px;">
                            <select id="budgetPeriodFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;" onchange="updateBudgetChart()">
                                <option value="monthly">Mensual</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                    </div>
                    <div style="position: relative; height: 350px;">
                        <canvas id="budgetComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Tabla de Gastos -->
                <div class="table-container" style="margin-top: 24px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Categoría</th>
                                <th>Subcategoría</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Monto</th>
                                <th>Tipo de Cambio</th>
                                <th>USD</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Los gastos se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay gastos -->
                <div id="noExpensesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">💰</div>
                    <h3>No hay gastos registrados</h3>
                    <p>Agrega gastos para comenzar a analizar los costos del call center.</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Agregar/Editar Hotel - NUEVO Y LIMPIO -->
    <div id="editHotelModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 85vh; overflow-y: auto;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 class="modal-title" id="editHotelModalTitle">🏨 Agregar Nuevo Hotel</h2>
            
            <form id="editHotelForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Columna Izquierda -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Nombre del Hotel *</label>
                            <input type="text" class="form-input" id="editHotelName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ubicación *</label>
                            <input type="text" class="form-input" id="editHotelLocation" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📍 Ubicación Google Maps</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelGoogleMaps" placeholder="https://maps.google.com/?q=..." style="flex: 1;">
                                <button type="button" class="form-button secondary" onclick="openGoogleMapsHelp()" style="white-space: nowrap;" title="Ayuda">
                                    <span class="material-icons" style="font-size: 16px;">help</span>
                                </button>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                💡 <strong>Tip:</strong> Busca el hotel en Google Maps, haz clic en "Compartir" y copia el enlace
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Calificación (1-5)</label>
                            <input type="number" class="form-input" id="editHotelRating" min="1" max="5" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rango de Precio</label>
                            <input type="text" class="form-input" id="editHotelPrice" placeholder="$150-$300 USD">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoría de Precio</label>
                            <select class="form-input" id="editHotelPriceRange">
                                <option value="low">Bajo</option>
                                <option value="medium">Medio</option>
                                <option value="high">Alto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-input" id="editHotelStatus">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Imagen Principal *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelImage" placeholder="Selecciona una imagen" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para imagen principal -->
                                <input type="file" id="mainImageFileInput" accept="image/*" style="display: none;" onchange="handleMainImageUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('mainImageFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('main')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editImagePreview" style="margin-top: 10px; min-height: 50px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Galería de Fotos</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelPhotos" placeholder="Selecciona imágenes para la galería" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para galería -->
                                <input type="file" id="galleryImagesFileInput" accept="image/*" multiple style="display: none;" onchange="handleGalleryImagesUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('galleryImagesFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('gallery')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editPhotosPreview" style="margin-top: 10px; min-height: 50px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-input" id="editHotelDescription" rows="4" placeholder="Descripción detallada del hotel"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amenities (separadas por comas)</label>
                            <input type="text" class="form-input" id="editHotelAmenities" placeholder="Spa, Restaurante, WiFi, Parking">
                        </div>
                    </div>
                </div>
                
                <!-- Botones -->
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="form-button secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="form-button" onclick="saveHotelChanges()">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal del Carrusel de Fotos -->
    <div id="photoCarouselModal" class="modal">
                        <div class="modal-content" style="max-width: 85vw; max-height: 85vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; width: 100%; height: 100%;">
                <!-- Botón cerrar -->
                <button class="close" onclick="closePhotoCarousel()" style="position: absolute; top: 20px; right: 20px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">&times;</button>
                
                <!-- Imagen principal -->
                <div id="carouselImageContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9);">
                    <img id="carouselImage" src="" alt="Foto" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
                </div>
                
                <!-- Controles de navegación -->
                <button id="prevButton" onclick="previousPhoto()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">‹</button>
                <button id="nextButton" onclick="nextPhoto()" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">›</button>
                
                <!-- Indicador de posición -->
                <div id="photoCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1001;"></div>
                
                <!-- Miniaturas -->
                <div id="carouselThumbnails" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001; max-width: 80%; overflow-x: auto; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal del Gestor de Imágenes -->
    <div id="imageManagerModal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;">📸 Gestor de Imágenes - <span id="currentHotelName">Nuevo Hotel</span></h2>
                <button onclick="closeImageManagerSimple()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 35px; height: 35px; line-height: 35px;">&times;</button>
            </div>
            
            <!-- Sección de Subir Imágenes -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">📤 Subir Imágenes desde tu Disco Duro</h3>
                
                <!-- Input de archivo oculto -->
                <input 
                    type="file" 
                    id="imageUploadInput" 
                    multiple 
                    accept="image/*" 
                    style="display: none;"
                    onchange="handleFileSelection(event)">
                
                <!-- Botón grande y visible para seleccionar archivos -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <button 
                        type="button" 
                        id="selectFilesButton"
                        onclick="
                            console.log('🔵 Botón de seleccionar archivos clickeado');
                            const input = document.getElementById('imageUploadInput');
                            if (input) {
                                console.log('✅ Input encontrado, abriendo explorador...');
                                input.click();
                            } else {
                                console.error('❌ Input imageUploadInput no encontrado');
                                alert('Error: No se puede abrir el explorador. Recarga la página.');
                            }
                        "
                        style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 20px 40px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 1.1rem;
                            font-weight: 600;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            min-width: 300px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                        <span class="material-icons" style="font-size: 28px;">folder_open</span>
                        <span>📁 Seleccionar Imágenes desde tu Disco Duro</span>
                    </button>
                </div>
                
                <!-- Información de archivos seleccionados -->
                <div id="selectedFilesInfo" style="display: none; margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                    <strong>📁 Archivos seleccionados:</strong> <span id="fileCount">0</span> imagen(es)
                </div>
                
                <!-- Botón para subir -->
                <div style="text-align: center;">
                    <button 
                        type="button" 
                        id="uploadButton"
                        onclick="uploadImagesSimple()"
                        disabled
                        style="
                            background: #4caf50;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            opacity: 0.5;
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                        ">
                        <span class="material-icons" style="font-size: 20px;">cloud_upload</span>
                        <span>Subir Imágenes</span>
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 0.9rem; color: #1565c0;">
                    <strong>💡 Información:</strong> Haz clic en el botón de arriba para abrir el explorador de archivos. Puedes seleccionar múltiples imágenes a la vez. Las imágenes se comprimirán automáticamente (máximo 10MB por imagen antes de comprimir).
                </div>
            </div>
            
            <!-- Vista Previa de Imágenes Subidas -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">🖼️ Imágenes Disponibles</h3>
                <div id="uploadedImagesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; min-height: 100px;">
                    <p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                        No hay imágenes subidas aún. Selecciona imágenes desde tu disco duro arriba.
                    </p>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="form-button secondary" onclick="closeImageManagerSimple()">
                    Cancelar
                </button>
                <button type="button" class="form-button" onclick="applyImageSelectionSimple()" style="background: #4caf50; color: white;">
                    Aplicar Selección
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar/Editar Gasto -->
    <div id="expenseModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeExpenseModal()">&times;</span>
            <h2 class="modal-title" id="expenseModalTitle">Agregar Gasto</h2>
            <form id="expenseForm" onsubmit="saveExpense(event)">
                <div class="form-group">
                    <label class="form-label">Fecha *</label>
                    <input type="date" id="expenseDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Gasto *</label>
                    <select id="expenseType" class="form-input" required onchange="updateExpenseCategories()">
                        <option value="">Seleccionar tipo</option>
                        <option value="fixed">Fijo</option>
                        <option value="variable">Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoría *</label>
                    <select id="expenseCategory" class="form-input" required>
                        <option value="">Seleccionar categoría</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subcategoría</label>
                    <input type="text" id="expenseSubcategory" class="form-input" placeholder="Ej: Meta Ads, Google Ads, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción *</label>
                    <textarea id="expenseDescription" class="form-input" rows="3" required placeholder="Descripción detallada del gasto"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto *</label>
                    <input type="number" id="expenseAmount" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio *</label>
                    <input type="number" id="expenseExchangeRate" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">USD</label>
                    <input type="number" id="expenseUSD" class="form-input" step="0.01" min="0" placeholder="0.00" readonly style="background-color: #f5f5f5;">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeExpenseModal()">Cancelar</button>
                    <button type="submit" class="form-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Nueva Cotización -->
    <div id="newQuoteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeNewQuoteModal()">&times;</span>
            <h2 class="modal-title">📋 Nueva Cotización</h2>
            <form id="quoteForm" onsubmit="createAndSendQuote(event)">
                <div class="form-group">
                    <label class="form-label">Hotel *</label>
                    <select id="quoteHotel" class="form-input" required>
                        <option value="">Seleccionar hotel</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" id="quoteCheckIn" class="form-input" required onchange="calculateNights()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" id="quoteCheckOut" class="form-input" required onchange="calculateNights()">
                    </div>
                </div>
                
                <div id="nightsDisplay" style="padding: 10px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <strong>Noches: <span id="nightsCount">0</span></strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Adultos *</label>
                        <input type="number" id="quoteAdults" class="form-input" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niños</label>
                        <input type="number" id="quoteChildren" class="form-input" min="0" value="0" onchange="toggleChildrenAges()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Infantes</label>
                        <input type="number" id="quoteInfants" class="form-input" min="0" value="0">
                    </div>
                </div>
                
                <div id="childrenAgesContainer" style="display: none; margin-bottom: 15px;">
                    <label class="form-label">Edades de los niños</label>
                    <div id="childrenAgesInputs"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Módulo *</label>
                    <select id="quoteModule" class="form-input" required>
                        <option value="">Seleccionar módulo</option>
                        <option value="Nothofagus">Nothofagus</option>
                        <option value="Reino Fungi">Reino Fungi</option>
                        <option value="Montaña Magica">Montaña Magica</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Tarifa *</label>
                        <input type="number" id="quoteTariff" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descuento</label>
                        <input type="number" id="quoteDiscount" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tarifa Final</label>
                    <input type="number" id="quoteFinalTariff" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" value="0.00">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Se calcula automáticamente: Tarifa - Descuento
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas adicionales (opcional)</label>
                    <textarea id="quoteNotes" class="form-input" rows="3" placeholder="Agregar notas o comentarios adicionales para la cotización"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Número de WhatsApp del destinatario *</label>
                    <input type="tel" id="quotePhoneNumber" class="form-input" required 
                           placeholder="Ej: +56912345678 o 56912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el número de teléfono con código de país (ej: +56912345678). El mensaje se enviará directamente por WhatsApp Business API.
                    </small>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>📱 Envío directo por WhatsApp:</strong> La cotización se enviará automáticamente al número ingresado usando WhatsApp Business API. Asegúrate de tener configuradas las credenciales de WhatsApp Business.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px; align-items: center;">
                    <button type="button" class="form-button secondary" onclick="showWhatsAppConfig()" style="background: #6c757d; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">settings</span>
                        Configurar WhatsApp
                    </button>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="form-button secondary" onclick="closeNewQuoteModal()">Cancelar</button>
                        <button type="submit" class="form-button" style="background: #25d366; color: white;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                            Crear y Enviar por WhatsApp
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Enviar Link del Cotizador -->
    <div id="sendCotizadorLinkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeSendCotizadorLinkModal()">&times;</span>
            <h2 class="modal-title">📱 Enviar Link del Cotizador</h2>
            <form id="sendLinkForm" onsubmit="sendCotizadorLink(event)">
                <div class="form-group">
                    <label class="form-label">Número de WhatsApp del Cliente *</label>
                    <input type="tel" id="linkPhoneNumber" class="form-input" required 
                           placeholder="Ej: +54912345678 o 54912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el número de teléfono con código de país
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mensaje Personalizado (Opcional)</label>
                    <textarea id="linkMessage" class="form-input" rows="3" 
                              placeholder="Hola! Te envío el link para que puedas solicitar tu cotización personalizada..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagen (Opcional)</label>
                    <input type="file" id="linkImageInput" class="form-input" accept="image/*" onchange="previewLinkImage(event)">
                    <div id="linkImagePreview" style="margin-top: 10px; display: none;">
                        <img id="linkImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <button type="button" onclick="removeLinkImage()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                    </div>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>ℹ️ Información:</strong> Se enviará un link único del cotizador. Cuando el cliente complete el formulario, la cotización aparecerá automáticamente como "Pendiente" en tu dashboard.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeSendCotizadorLinkModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #25d366; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                        Enviar Link por WhatsApp
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importar Usuarios -->
    <div id="importUsersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeImportUsersModal()">&times;</span>
            <h2 class="modal-title">📥 Importar Usuarios</h2>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Importa usuarios desde un archivo CSV o JSON. Los campos requeridos son: <strong>nombre</strong> y <strong>teléfono</strong> (o <strong>email</strong>).
                </p>
                
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <strong>⚠️ Validación de duplicados:</strong><br>
                        • Si el usuario tiene email: se mantiene el que se creó primero<br>
                        • Si el usuario no tiene email: se valida por teléfono y se mantiene el que ya estaba
                    </p>
                </div>
            </div>
            
            <form id="importUsersForm" onsubmit="importUsers(event)">
                <div class="form-group">
                    <label class="form-label">Seleccionar archivo *</label>
                    <input type="file" id="usersFile" class="form-input" accept=".csv,.json" required>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Formatos soportados: CSV, JSON
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Formato del archivo</label>
                    <select id="fileFormat" class="form-input" required>
                        <option value="auto">Detectar automáticamente</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                
                <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem;">Vista previa:</h3>
                    <div id="previewContent" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;"></div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeImportUsersModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #2196f3; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">upload</span>
                        Importar Usuarios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configuración de WhatsApp -->
    <div id="whatsappConfigModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeWhatsAppConfig()">&times;</span>
            <h2 class="modal-title">⚙️ Configuración de WhatsApp Business API</h2>
            <form id="whatsappConfigForm" onsubmit="saveWhatsAppConfig(event)">
                <div class="form-group">
                    <label class="form-label">Access Token *</label>
                    <input type="text" id="whatsappAccessToken" class="form-input" required 
                           placeholder="Tu Access Token de WhatsApp Business API">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Obtén tu Access Token desde el panel de Facebook Developers
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number ID *</label>
                    <input type="text" id="whatsappPhoneNumberId" class="form-input" required 
                           placeholder="Tu Phone Number ID">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        ID del número de teléfono verificado en WhatsApp Business
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Version</label>
                    <input type="text" id="whatsappApiVersion" class="form-input" 
                           value="v18.0" placeholder="v18.0">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Versión de la API de Facebook (por defecto: v18.0)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL del Servidor (Opcional)</label>
                    <input type="text" id="whatsappServerURL" class="form-input" 
                           placeholder="http://localhost:3001">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Si tienes un servidor con endpoint de WhatsApp, ingresa su URL aquí
                    </small>
                </div>
                
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <strong>ℹ️ Información:</strong> Para obtener tus credenciales de WhatsApp Business API, visita 
                        <a href="https://developers.facebook.com/docs/whatsapp/cloud-api/get-started" target="_blank" style="color: #1976d2;">Facebook Developers</a>
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeWhatsAppConfig()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #25d366; color: white;">
                        Guardar Configuración
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div>
    <!-- Fin del contenido del Dashboard -->

    <script>
        // ============================================
        // CAMPOS DE IMAGEN - AHORA SON NECESARIOS, NO ELIMINAR
        // ============================================
        // NOTA: Este script anteriormente eliminaba los campos de imagen cada 100ms
        // Ahora los campos son necesarios para subir fotos reales desde el disco duro
        // Por lo tanto, este script está COMPLETAMENTE DESACTIVADO
        console.log('✅ Script de eliminación de campos de imagen DESACTIVADO');
        console.log('✅ Los campos de imagen ahora son necesarios y se preservarán');
        
        // Función vacía para evitar errores si algo intenta llamarla
        (function preservarCamposImagen() {
            // Esta función ya no hace nada - los campos se preservan
            // No hay setInterval, no hay MutationObserver, no hay eliminación
            console.log('✅ Campos de imagen preservados - script desactivado');
        })();
        
        // ============================================
        // SOLUCIÓN INMEDIATA PARA MODAL DE IMÁGENES
        // ============================================
        // Esta función se ejecuta inmediatamente y sobrescribe cualquier función en caché
        (function() {
            window.abrirModalImagenesDirecto = function(mode) {
                console.log('🚀 ABRIENDO MODAL DIRECTO - Modo:', mode);
                const modal = document.getElementById('imageManagerModal');
                if (!modal) {
                    console.error('❌ Modal no encontrado');
                    alert('Error: Modal no encontrado. Recarga la página.');
                    return;
                }
                modal.style.display = 'block';
                modal.style.zIndex = '10000';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                console.log('✅ Modal abierto directamente');
                
                // Configurar nombre del hotel
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    if (nameInput && nameInput.value) {
                        hotelNameSpan.textContent = nameInput.value;
                    } else {
                        hotelNameSpan.textContent = 'Nuevo Hotel';
                    }
                }
            };
            console.log('✅ Función abrirModalImagenesDirecto disponible globalmente');
        })();

        // ============================================
        // SISTEMA DE AUTENTICACIÓN - EJECUTAR PRIMERO
        // ============================================
        console.log('🔐 Script de autenticación cargado');
        
        // IMPORTANTE: Ocultar dashboard y mostrar login por defecto INMEDIATAMENTE
        (function() {
            function hideDashboardAndShowLogin() {
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                const body = document.body;
                
                if (dashboardContent) {
                    dashboardContent.classList.remove('authenticated');
                }
                if (loginContainer) {
                    loginContainer.classList.remove('hidden');
                }
                if (body) {
                    body.classList.remove('authenticated');
                }
            }
            
            // Ejecutar inmediatamente si el DOM está listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideDashboardAndShowLogin);
            } else {
                hideDashboardAndShowLogin();
            }
        })();
        
        // Sistema de gestión de usuarios administradores
        // Inicializar usuarios administradores en localStorage si no existen
        function initAdminUsers() {
            const storedUsers = localStorage.getItem('dashboard_admin_users');
            if (!storedUsers) {
                const defaultUsers = [
                    {
                        id: 'admin-001',
                        username: 'admin',
                        password: 'admin123',
                        name: 'Administrador',
                        role: 'admin_total', // admin_total o usuario
                        email: 'admin@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    },
                    {
                        id: 'admin-002',
                        username: 'german',
                        password: 'Checkin24hs2025',
                        name: 'German Perez',
                        role: 'admin_total',
                        email: 'german@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    }
                ];
                localStorage.setItem('dashboard_admin_users', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return JSON.parse(storedUsers);
        }

        // Obtener todos los usuarios administradores
        function getAdminUsers() {
            return JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
        }

        // Guardar usuarios administradores
        function saveAdminUsers(users) {
            localStorage.setItem('dashboard_admin_users', JSON.stringify(users));
        }

        // Inicializar usuarios al cargar
        initAdminUsers();

        // Verificar si hay sesión activa al cargar la página
        function checkAuthStatus() {
            console.log('🔐 Verificando autenticación...');
            
            // Primero, asegurar que el dashboard esté oculto y el login visible
            const dashboardContent = document.getElementById('dashboardContent');
            const loginContainer = document.getElementById('loginContainer');
            
            if (!dashboardContent || !loginContainer) {
                console.error('❌ Elementos de autenticación no encontrados');
                return false;
            }
            
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    // Verificar si la sesión no ha expirado (24 horas)
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        console.log('✅ Sesión válida encontrada para:', session.username);
                        showDashboard();
                        return true;
                    } else {
                        // Sesión expirada
                        console.log('⏰ Sesión expirada, eliminando...');
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    console.error('❌ Error al verificar sesión:', e);
                    localStorage.removeItem('dashboard_auth_session');
                }
            } else {
                console.log('🔓 No hay sesión activa');
            }
            
            // No hay sesión válida, mostrar login
            showLogin();
            return false;
        }

        // Mostrar pantalla de login
        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.remove('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.remove('authenticated');
            }
            if (body) {
                body.classList.remove('authenticated');
            }
        }

        // Mostrar dashboard
        function showDashboard() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.add('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.add('authenticated');
            }
            if (body) {
                body.classList.add('authenticated');
            }
        }

        // Manejar el login
        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            console.log('🔐 Intentando iniciar sesión...');
            
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            if (!usernameInput || !passwordInput || !errorDiv || !loginButton) {
                console.error('❌ Elementos del formulario no encontrados');
                return;
            }
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            // Limpiar error anterior
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
            
            // Validar que los campos no estén vacíos
            if (!username || !password) {
                showError('Por favor, completa todos los campos');
                return;
            }
            
            // Deshabilitar botón mientras se procesa
            loginButton.disabled = true;
            loginButton.textContent = 'Iniciando sesión...';
            
            // Simular delay de autenticación (para mejor UX)
            setTimeout(() => {
                // Buscar usuario en localStorage
                const adminUsers = getAdminUsers();
                const user = adminUsers.find(u => 
                    u.username.toLowerCase() === username.toLowerCase() && 
                    u.password === password &&
                    u.status === 'active'
                );
                
                if (user) {
                    // Actualizar último login
                    user.lastLogin = new Date().toISOString();
                    saveAdminUsers(adminUsers);
                    
                    // Login exitoso
                    const session = {
                        username: user.username,
                        name: user.name,
                        role: user.role,
                        userId: user.id,
                        loginTime: Date.now(),
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
                    };
                    
                    localStorage.setItem('dashboard_auth_session', JSON.stringify(session));
                    
                    // Limpiar formulario
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.reset();
                    }
                    
                    // Mostrar dashboard
                    showDashboard();
                    
                    // Actualizar nombre de usuario en el dropdown
                    updateUserMenu(user.name, user.role);
                    
                    // Actualizar visibilidad del menú de administradores
                    setTimeout(() => {
                        if (typeof updateAdminMenuVisibility === 'function') {
                            updateAdminMenuVisibility();
                        }
                    }, 100);
                    
                    // Inicializar dashboard si no está inicializado
                    if (typeof initializeDashboard === 'function') {
                        initializeDashboard();
                    }
                    if (typeof setupAutoSync === 'function') {
                        setupAutoSync();
                    }
                    
                    console.log('✅ Login exitoso:', user.username, 'Rol:', user.role);
                } else {
                    // Credenciales incorrectas
                    console.log('❌ Credenciales incorrectas');
                    showError('Usuario o contraseña incorrectos');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                
                // Rehabilitar botón
                loginButton.disabled = false;
                loginButton.textContent = 'Iniciar Sesión';
            }, 500);
        }

        // Mostrar error de login
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Toggle visibilidad de contraseña
        function togglePasswordVisibility(event) {
            const passwordInput = document.getElementById('loginPassword');
            if (!passwordInput) return;
            
            const icon = event ? event.target : document.querySelector('#loginPassword + .input-icon');
            if (!icon) return;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility_off';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility';
            }
        }

        // Actualizar menú de usuario
        function updateUserMenu(userName, userRole) {
            const userNameElement = document.querySelector('.user-dropdown .dropdown-item:first-child');
            if (userNameElement) {
                const roleText = userRole === 'admin_total' ? 'Administrador Total' : 'Usuario';
                userNameElement.innerHTML = `<span class="material-icons">person</span>${userName} (${roleText})`;
            }
        }

        // Verificar si el usuario actual es admin_total
        function isAdminTotal() {
            const session = localStorage.getItem('dashboard_auth_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    return sessionData.role === 'admin_total';
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        // Función de logout mejorada
        function logout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                localStorage.removeItem('dashboard_auth_session');
                
                // Limpiar formulario
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.reset();
                }
                
                // Ocultar dropdown de usuario
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                // Mostrar login y ocultar dashboard
                showLogin();
                
                console.log('👋 Sesión cerrada');
            }
        }

        // ============================================
        // FIN SISTEMA DE AUTENTICACIÓN
        // ============================================

        // Variables globales
        let currentSection = 'dashboard';
        let expensesCharts = {
            composition: null,
            variable: null,
            budget: null
        };
        
        // Función global para evitar errores de referencia
        window.showSection = function(section, event) {
            console.log('🔄 Cambiando a sección:', section);
            
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });

            // Mostrar la sección seleccionada
            const targetSection = document.getElementById(section + '-section');
            
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log('✅ Sección mostrada:', section);
            } else {
                console.error('❌ Sección no encontrada:', section + '-section');
            }

            // Actualizar menú activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Solo actualizar el menú activo si se proporciona el evento
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si no hay evento, buscar el elemento del menú correspondiente
                const menuItem = document.querySelector(`[onclick*="window.showSection('${section}')"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            }

            currentSection = section;
            
            // Cargar datos específicos según la sección
            if (section === 'users') {
                setTimeout(() => {
                    if (typeof loadUsersData === 'function') {
                        loadUsersData();
                    }
                }, 100);
            }
            
            if (section === 'administrators') {
                setTimeout(() => {
                    if (typeof loadAdminsTable === 'function') {
                        loadAdminsTable();
                    }
                    if (typeof updateAdminMenuVisibility === 'function') {
                        updateAdminMenuVisibility();
                    }
                }, 100);
            }
            
            if (section === 'hotels') {
                setTimeout(() => {
                    if (typeof loadHotelsTable === 'function') {
                        loadHotelsTable();
                    }
                }, 100);
            }
            
            if (section === 'expenses') {
                setTimeout(() => {
                    if (typeof loadExpensesData === 'function') {
                        loadExpensesData();
                    }
                }, 100);
            }
            
            if (section === 'reservations') {
                setTimeout(() => {
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                }, 100);
            }
            
            if (section === 'dashboard') {
                setTimeout(() => {
                    if (typeof loadHotelsForMonthlySalesFilter === 'function') {
                        loadHotelsForMonthlySalesFilter();
                    }
                    if (typeof loadMonthlySales === 'function') {
                        loadMonthlySales();
                    }
                    if (typeof loadExpenseCategoriesForFilter === 'function') {
                        loadExpenseCategoriesForFilter();
                    }
                    if (typeof loadMonthlyExpenses === 'function') {
                        loadMonthlyExpenses();
                    }
                    if (typeof updateStats === 'function') {
                        updateStats();
                    }
                }, 100);
            }
        };

        // Función para cerrar modal de edición de hoteles
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para cerrar modal de vista previa de imágenes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para toggle del menú de usuario
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Función para toggle del sidebar en móvil
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        // Función de logout (reemplazada por la nueva implementación arriba)

        // Cerrar dropdown cuando se hace clic fuera
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            
            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Cerrar sidebar en móvil cuando se hace clic en un enlace
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('open');
                    }
                }
            });
        });

        // Datos de hoteles (sistema limpio)
        const hotels = [];

        // Función para generar estrellas
        function getStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="material-icons rating-stars">star</span>';
                } else if (i - 0.5 <= rating) {
                    stars += '<span class="material-icons rating-stars">star_half</span>';
                } else {
                    stars += '<span class="material-icons" style="color: #e0e0e0;">star</span>';
                }
            }
            return stars;
        }

        // Función para cargar hoteles en la tabla
        async function loadHotelsTable() {
            console.log('🔄 Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('❌ Tbody de hoteles no encontrado');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`✅ ${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('💾 Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            console.log(`📋 Encontrados ${hotels.length} hoteles:`, hotels.map(h => h.name));
            
            tbody.innerHTML = '';

            if (hotels.length === 0) {
                // Mostrar mensaje si no hay hoteles
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-hotel" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">No hay hoteles registrados</h3>
                        <p style="margin-bottom: 20px; color: #666;">Comienza agregando tu primer hotel</p>
                        <button onclick="addNewHotel()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Primer Hotel
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price || 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status?.toLowerCase() || 'activo'}">${hotel.status || 'Activo'}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="viewHotel('${hotel.id}')" class="action-btn view" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla de hoteles cargada con ${hotels.length} hoteles`);
        }

        // Función para actualizar estadísticas del dashboard
        function updateStats() {
            console.log('📊 Actualizando estadísticas del dashboard...');
            
            // Actualizar Total Hoteles (solo activos)
            const dashboardTotalHotelsElement = document.getElementById('dashboardTotalHotels');
            if (dashboardTotalHotelsElement) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                // Contar solo hoteles activos (considera tanto is_active como status)
                const activeHotels = hotels.filter(hotel => {
                    // Un hotel está activo si:
                    // - is_active es true (o undefined/null, se considera activo por defecto)
                    // - O status es 'Activo' (o undefined/null, se considera activo por defecto)
                    const isActiveBool = hotel.is_active !== false; // true, undefined, null = activo
                    const isActiveStatus = hotel.status !== 'Inactivo'; // 'Activo', undefined, null = activo
                    return isActiveBool && isActiveStatus;
                });
                dashboardTotalHotelsElement.textContent = activeHotels.length;
                
                // Actualizar el mensaje de tendencia
                const trendElement = dashboardTotalHotelsElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (activeHotels.length > 0) {
                        trendElement.innerHTML = '<span class="material-icons">trending_up</span> Hoteles activos';
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">info</span> Sin datos disponibles';
                    }
                }
                
                console.log(`✅ Total Hoteles actualizado: ${activeHotels.length} hoteles activos`);
            }
            
            // Actualizar tarjeta de Ingresos del Mes Vigente
            const dashboardMonthlySalesElement = document.getElementById('dashboardMonthlySales');
            const dashboardMonthlyReservationsElement = document.getElementById('dashboardMonthlyReservations');
            if (dashboardMonthlySalesElement && dashboardMonthlyReservationsElement) {
                // Calcular acumulado de ventas del mes vigente
                const monthlyAccumulated = calculateMonthlySalesAccumulated();
                const formattedAmount = monthlyAccumulated.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Mostrar el acumulado de ventas como número principal
                dashboardMonthlySalesElement.textContent = `$${formattedAmount}`;
                
                // Calcular cantidad de reservas acumuladas en el mes vigente
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                const monthlyReservations = reservations.filter(reservation => {
                    if (!reservation.checkIn || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                        return false;
                    }
                    
                    let dateStr = reservation.checkIn;
                    if (dateStr.includes('T')) {
                        dateStr = dateStr.split('T')[0];
                    }
                    
                    const dateParts = dateStr.split('-');
                    if (dateParts.length !== 3) {
                        return false;
                    }
                    
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    
                    return year === currentYear && month === currentMonth;
                });
                
                const reservationsCount = monthlyReservations.length;
                const reservationsTotal = monthlyReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                const formattedReservationsTotal = reservationsTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                if (reservationsCount > 0) {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">trending_up</span> Cantidad de reservas Acumuladas en el mes: ${reservationsCount}`;
                } else {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">info</span> Sin reservas este mes`;
                }
                
                console.log(`✅ Tarjeta de Ingresos del Mes Vigente actualizada: Acumulado: $${formattedAmount}, Reservas: ${reservationsCount}, Sumatoria: $${formattedReservationsTotal}`);
            }
            
            // Actualizar Sumatoria de Reservas Futuras
            const futureReservationsTotalElement = document.getElementById('futureReservationsTotal');
            if (futureReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Función auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Verificar si tiene checkIn
                    if (!reservation.checkIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(reservation.checkIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                // Calcular sumatoria de reservas futuras
                const futureTotal = futureReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                // Formatear el total
                futureReservationsTotalElement.textContent = `$${futureTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                console.log(`✅ Sumatoria de Reservas Futuras actualizada: $${futureTotal.toLocaleString('es-AR')} (${futureReservations.length} reservas)`);
            }
            
            // Actualizar Ingresos de Hoy
            const todayReservationsTotalElement = document.getElementById('todayReservationsTotal');
            if (todayReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                console.log('🔍 Calculando Ingresos de Hoy...');
                console.log(`📊 Total de reservas en BD: ${reservations.length}`);
                
                // Mostrar muestra de las primeras 3 reservas para entender la estructura
                if (reservations.length > 0) {
                    console.log('📋 Muestra de estructura de reservas (primeras 3):');
                    reservations.slice(0, 3).forEach((r, index) => {
                        console.log(`  Reserva ${index + 1} (${r.reservationCode || r.id}):`);
                        console.log(`    - id: ${r.id}`);
                        console.log(`    - code: ${r.reservationCode}`);
                        console.log(`    - createdAt: ${r.createdAt || 'NO EXISTE'}`);
                        console.log(`    - created_at: ${r.created_at || 'NO EXISTE'}`);
                        console.log(`    - updatedAt: ${r.updatedAt || 'NO EXISTE'}`);
                        console.log(`    - updated_at: ${r.updated_at || 'NO EXISTE'}`);
                        console.log(`    - reservationDate: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`    - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`    - status: ${r.status || 'NO EXISTE'}`);
                        console.log('');
                    });
                }
                
                // Obtener la fecha de hoy en formato YYYY-MM-DD usando fecha LOCAL (no UTC)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                console.log(`📅 Fecha de hoy (LOCAL): ${todayStr}`);
                console.log(`📅 Fecha de hoy (UTC): ${today.toISOString().split('T')[0]}`);
                
                // Función auxiliar para normalizar fecha a YYYY-MM-DD usando fecha LOCAL
                const normalizeDate = (dateValue) => {
                    if (!dateValue) return null;
                    
                    let dateStr = dateValue;
                    let date;
                    
                    // Si es un objeto Date, usar directamente
                    if (dateStr instanceof Date) {
                        date = dateStr;
                    }
                    // Si es un string, intentar parsearlo
                    else if (typeof dateStr === 'string') {
                        // Si ya está en formato YYYY-MM-DD, retornarlo directamente
                        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            return dateStr;
                        }
                        // Si incluye hora (formato ISO), parsearlo
                        else if (dateStr.includes('T')) {
                            date = new Date(dateStr);
                        }
                        // Intentar parsear cualquier otro formato
                        else {
                            date = new Date(dateStr);
                        }
                    } else {
                        return null;
                    }
                    
                    // Si no se pudo parsear, retornar null
                    if (!date || isNaN(date.getTime())) {
                        return null;
                    }
                    
                    // Convertir a fecha LOCAL (no UTC) en formato YYYY-MM-DD
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Mostrar muestra de las primeras 5 reservas para depuración
                console.log('🔍 Muestra de reservas (primeras 5):', reservations.slice(0, 5).map(r => ({
                    id: r.id,
                    code: r.reservationCode,
                    createdAt: r.createdAt || r.created_at,
                    updatedAt: r.updatedAt || r.updated_at,
                    reservationDate: r.reservationDate,
                    totalAmount: r.totalAmount,
                    status: r.status
                })));
                
                // Filtrar reservas que tienen checkIn de HOY (fecha de entrada)
                const todayReservations = reservations.filter(reservation => {
                    // Verificar si tiene checkIn de HOY (fecha de entrada)
                    const checkIn = normalizeDate(reservation.checkIn);
                    const checkInToday = checkIn !== null && checkIn === todayStr;
                    
                    // Incluir solo si tiene checkIn de HOY
                    const isToday = checkInToday;
                    
                    if (isToday) {
                        console.log(`✅ Reserva de hoy encontrada (checkIn hoy):`, {
                            id: reservation.id,
                            code: reservation.reservationCode,
                            checkIn: reservation.checkIn,
                            checkInNormalizado: checkIn,
                            totalAmount: reservation.totalAmount,
                            status: reservation.status
                        });
                    }
                    
                    return isToday;
                });
                
                console.log(`📊 Reservas encontradas para hoy: ${todayReservations.length}`);
                
                // Buscar específicamente la reserva VRETNG si existe
                const vretngReservation = reservations.find(r => r.reservationCode === 'VRETNG');
                if (vretngReservation) {
                    console.log('🔍 RESERVA VRETNG ENCONTRADA:');
                    const vretngCheckIn = normalizeDate(vretngReservation.checkIn);
                    console.log(`  - checkIn original: ${vretngReservation.checkIn || 'NO EXISTE'}`);
                    console.log(`  - checkIn normalizado: ${vretngCheckIn || 'null'}`);
                    console.log(`  - Fecha de hoy: ${todayStr}`);
                    console.log(`  - totalAmount: ${vretngReservation.totalAmount || 'NO EXISTE'}`);
                    console.log(`  - status: ${vretngReservation.status || 'NO EXISTE'}`);
                    console.log(`  - ¿checkIn coincide con hoy?: ${vretngCheckIn === todayStr ? 'SÍ' : 'NO'}`);
                    console.log(`  - ¿Está en todayReservations?: ${todayReservations.some(r => r.reservationCode === 'VRETNG') ? 'SÍ' : 'NO'}`);
                } else {
                    console.log('⚠️ Reserva VRETNG NO ENCONTRADA en la base de datos');
                }
                
                // Si no se encontraron reservas, mostrar algunas fechas cercanas para depuración
                if (todayReservations.length === 0 && reservations.length > 0) {
                    console.log('⚠️ No se encontraron reservas para hoy. Mostrando fechas de las últimas 10 reservas:');
                    const recentReservations = reservations.slice(-10).reverse();
                    recentReservations.forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt original: ${r.createdAt || r.created_at || 'NO EXISTE'}`);
                        console.log(`     - createdAt normalizado: ${createdAt || 'null'}`);
                        console.log(`     - updatedAt original: ${r.updatedAt || r.updated_at || 'NO EXISTE'}`);
                        console.log(`     - updatedAt normalizado: ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate original: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`     - reservationDate normalizado: ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log(`     - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`     - status: ${r.status || 'NO EXISTE'}`);
                        console.log(`     - ¿Coincide con hoy?: ${createdAt === todayStr || updatedAt === todayStr || reservationDate === todayStr ? 'SÍ' : 'NO'}`);
                        console.log('');
                    });
                    
                    // También mostrar las primeras 5 reservas
                    console.log('📋 Muestra de las primeras 5 reservas:');
                    reservations.slice(0, 5).forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt: ${r.createdAt || r.created_at || 'NO EXISTE'} → ${createdAt || 'null'}`);
                        console.log(`     - updatedAt: ${r.updatedAt || r.updated_at || 'NO EXISTE'} → ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate: ${r.reservationDate || 'NO EXISTE'} → ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log('');
                    });
                }
                
                // Calcular el total de ingresos de hoy
                // Solo contar reservas que no estén canceladas (Confirmadas o Modificadas)
                const todayTotal = todayReservations
                    .filter(res => {
                        const status = res.status || '';
                        const isNotCanceled = status !== 'Cancelada' && status !== 'cancelada';
                        if (!isNotCanceled) {
                            console.log(`⚠️ Reserva cancelada excluida: ${res.reservationCode} - $${res.totalAmount}`);
                        }
                        return isNotCanceled;
                    })
                    .reduce((sum, res) => {
                        // Intentar obtener el monto de diferentes campos posibles
                        const amount = parseFloat(res.totalAmount) || 
                                     parseFloat(res.total_amount) || 
                                     parseFloat(res.amount) || 
                                     parseFloat(res.price) || 0;
                        
                        if (amount > 0) {
                            console.log(`💰 Sumando: $${amount} de reserva ${res.reservationCode || res.id}`);
                        } else {
                            console.warn(`⚠️ Reserva sin monto: ${res.reservationCode || res.id}`, res);
                        }
                        
                        return sum + amount;
                    }, 0);
                
                // Contar reservas con checkIn de hoy
                const checkInToday = todayReservations.length;
                
                // Formatear el total con separador de miles
                todayReservationsTotalElement.textContent = `$${todayTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                // Actualizar el mensaje de tendencia
                const trendElement = todayReservationsTotalElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (todayReservations.length > 0) {
                        trendElement.innerHTML = `<span class="material-icons">today</span> ${todayReservations.length} reserva(s) con check-in hoy`;
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">today</span> Sin reservas con check-in hoy';
                    }
                }
                
                console.log(`✅ Ingresos de Hoy actualizado: $${todayTotal.toLocaleString('es-AR')} (${checkInToday} reserva(s) con check-in hoy)`);
                console.log('📊 Detalle completo de reservas de hoy:', todayReservations.map(r => {
                    const createdAt = normalizeDate(r.createdAt || r.created_at);
                    const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                    const reservationDate = normalizeDate(r.reservationDate);
                    return {
                        id: r.id,
                        code: r.reservationCode,
                        createdAt: r.createdAt || r.created_at,
                        updatedAt: r.updatedAt || r.updated_at,
                        reservationDate: r.reservationDate,
                        totalAmount: r.totalAmount,
                        status: r.status,
                        normalizedDates: { createdAt, updatedAt, reservationDate }
                    };
                }));
            } else {
                console.warn('⚠️ No se encontró el elemento todayReservationsTotal');
            }
        }



        // Función para editar hotel
        function editHotel(hotelId) {
            // Implementar lógica para editar hotel
            console.log('Editando hotel:', hotelId);
        }

        // Función para cerrar modal de edición
        function closeEditModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para actualizar vista previa de imagen (ELIMINADA - campo de imagen removido)
        function updateImagePreview() {
            const imageInput = document.getElementById('editHotelImage');
            const previewContainer = document.getElementById('editImagePreview');
            
            if (!imageInput || !previewContainer) {
                return;
            }
            
            const imagePath = imageInput.value.trim();
            
            if (imagePath) {
                const isUrl = !imagePath.startsWith('data:');
                previewContainer.innerHTML = `
                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: #f9f9f9;">
                        <img src="${imagePath}" alt="Vista previa" 
                             style="max-width: 100%; max-height: 300px; border-radius: 4px; display: block; margin: 0 auto;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; text-align: center; color: #999; padding: 20px;">
                            <span class="material-icons" style="font-size: 48px;">broken_image</span>
                            <p>No se pudo cargar la imagen</p>
                        </div>
                        ${isUrl ? '<div style="text-align: center; margin-top: 8px; font-size: 12px; color: #4caf50;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">link</span> URL Externa</div>' : ''}
                    </div>
                `;
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // Función para actualizar vista previa de fotos (ELIMINADA - campo de galería removido)
        function updatePhotosPreview() {
            const photosInput = document.getElementById('editHotelPhotos');
            const previewContainer = document.getElementById('editPhotosPreview');
            
            if (!photosInput || !previewContainer) {
                return;
            }
            
            const photosValue = photosInput.value.trim();
            const photoPaths = photosValue ? photosValue.split(',').map(p => p.trim()).filter(p => p) : [];
            
            previewContainer.innerHTML = '';
            
            if (photoPaths.length > 0) {
                photoPaths.forEach((photoPath, index) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.style.cssText = 'position: relative; width: 150px; height: 150px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; margin: 5px; display: inline-block;';
                    
                    const isUrl = !photoPath.startsWith('data:');
                    photoDiv.innerHTML = `
                        <img src="${photoPath}" alt="Foto ${index + 1}" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 100%; height: 100%; background: #f0f0f0; align-items: center; justify-content: center; flex-direction: column;">
                            <span class="material-icons" style="font-size: 32px; color: #999;">broken_image</span>
                            <span style="font-size: 12px; color: #999;">Error</span>
                        </div>
                        <div style="position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                            ${index + 1}
                        </div>
                        ${isUrl ? '<div style="position: absolute; bottom: 5px; right: 5px; background: rgba(33,150,243,0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;"><span class="material-icons" style="font-size: 12px; vertical-align: middle;">link</span></div>' : ''}
                    `;
                    
                    previewContainer.appendChild(photoDiv);
                });
            }
        }

        // Función para guardar cambios del hotel
        function saveHotelChanges() {
            // Implementar lógica para guardar cambios
            console.log('Guardando cambios del hotel...');
            closeEditHotelModal();
        }

        // Función para sincronizar con index.html
        function syncWithIndexHtml() {
            // Implementar sincronización
            console.log('Sincronizando con index.html...');
        }

        // Función simple para abrir modal directamente (sin caché)
        function abrirModalImagenesDirecto(mode) {
            console.log('🚀 ABRIENDO MODAL DIRECTO - Modo:', mode);
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('❌ Modal no encontrado');
                alert('Error: Modal no encontrado. Recarga la página.');
                return;
            }
            
            // Abrir modal inmediatamente
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            console.log('✅ Modal abierto directamente - Display:', modal.style.display);
            
            // Llamar a la función completa después de abrir el modal
            if (typeof openImageManager === 'function') {
                setTimeout(() => openImageManager(mode), 100);
            } else {
                console.warn('⚠️ openImageManager no está disponible, configurando modal básico...');
                // Configuración básica del modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                }
            }
        }

        // Función para abrir gestor de imágenes
        function openImageManager(mode) {
            // Prevenir aperturas múltiples
            if (isImageManagerOpening) {
                console.log('⚠️ El gestor de imágenes ya se está abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            
            if (!modal) {
                console.error('❌ ERROR: Modal no encontrado');
                alert('❌ Error: Modal no encontrado. Recarga la página.');
                return;
            }
            
            // Verificar si el modal ya está abierto
            if (modal.style.display === 'block' || window.getComputedStyle(modal).display === 'block') {
                console.log('⚠️ El gestor de imágenes ya está abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('📁 ABRIENDO GESTOR DE IMÁGENES - MODO:', mode);
            
            console.log('✅ Modal encontrado, abriendo...');
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            console.log('✅ Modal abierto - Display:', modal.style.display);
            
            // Permitir nueva apertura después de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
            
            // AHORA configurar el resto
            try {
                
                // Intentar obtener hotelId de varias fuentes
                let hotelId = null;
                
                // 1. Intentar desde variable global
                if (typeof globalEditingHotelId !== 'undefined' && globalEditingHotelId) {
                    hotelId = globalEditingHotelId;
                    console.log('✅ HotelId obtenido de variable global:', hotelId);
                }
                
                // 2. Intentar desde el formulario
                if (!hotelId) {
                    const form = document.getElementById('editHotelForm');
                    if (form && form.dataset && form.dataset.hotelId) {
                        hotelId = form.dataset.hotelId;
                        if (hotelId && hotelId !== 'null' && hotelId !== 'undefined') {
                            console.log('✅ HotelId obtenido del formulario:', hotelId);
                        }
                    }
                }
                
                // 3. Si aún no tenemos hotelId, intentar obtenerlo del nombre del hotel
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    try {
                        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            const hotel = hotels.find(h => h.name === nameInput.value);
                            if (hotel && hotel.id) {
                                hotelId = hotel.id;
                                console.log('✅ HotelId obtenido por nombre del hotel:', hotelId);
                            }
                        }
                    } catch (error) {
                        console.warn('⚠️ Error buscando hotel por nombre:', error);
                    }
                }
                
                // 4. Si es un nuevo hotel, crear ID temporal
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    hotelId = 'new-hotel-' + Date.now();
                    console.log('⚠️ Usando ID temporal para nuevo hotel:', hotelId);
                }
                
                currentEditingHotelId = hotelId;
                currentImageManagerMode = mode || 'main';
                
                // Obtener datos del hotel (si existe)
                let hotelName = 'Nuevo Hotel';
                try {
                    const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                    const hotel = hotels.find(h => h.id === hotelId);
                    
                    if (hotel && hotel.name) {
                        hotelName = hotel.name;
                    } else {
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            hotelName = nameInput.value;
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Error obteniendo nombre del hotel:', error);
                }
                
                // Mostrar nombre del hotel en el modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    hotelNameSpan.textContent = hotelName;
                }
                
                // Mostrar carpeta del hotel
                const hotelFolderPath = document.getElementById('hotelFolderPath');
                if (hotelFolderPath) {
                    try {
                        const slug = getHotelSlug(hotelName);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}-${slug}/`;
                    } catch (error) {
                        console.warn('⚠️ Error generando slug:', error);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}/`;
                    }
                }
                
                // Limpiar imágenes subidas si es una nueva sesión
                uploadedImages = [];
                
                // Renderizar gestor
                try {
                    renderImageManager();
                } catch (error) {
                    console.error('❌ Error renderizando gestor:', error);
                }
                
                console.log('✅ Gestor de imágenes completamente inicializado');
                
            } catch (error) {
                console.error('❌ Error crítico en openImageManager:', error);
                alert('❌ Error al abrir el gestor de imágenes: ' + error.message);
            }
        }

        // Función para cerrar gestor de imágenes (compatibilidad)
        function closeImageManager() {
            closeImageManagerSimple();
        }

        // Función para obtener slug del hotel
        function getHotelSlug(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        }

        // Función para cargar imágenes disponibles
        function loadAvailableImages(hotelId) {
            // Implementar carga de imágenes
            console.log('Cargando imágenes para hotel:', hotelId);
        }

        // Función para cargar fotos del hotel
        function loadHotelPhotos(hotel) {
            // Implementar carga de fotos
            console.log('Cargando fotos del hotel:', hotel);
        }

        // Función para renderizar gestor de imágenes
        function renderImageManager() {
            console.log('🎨 Renderizando gestor de imágenes...');
            
            const availableContainer = document.getElementById('availableImages');
            const selectedContainer = document.getElementById('selectedImages');
            
            if (!availableContainer || !selectedContainer) {
                console.error('❌ Contenedores de imágenes no encontrados');
                return;
            }
            
            // Limpiar contenedores
            availableContainer.innerHTML = '';
            selectedContainer.innerHTML = '';
            
            // Obtener imágenes ya seleccionadas del formulario
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = photosInput.value.split(',').map(img => img.trim()).filter(img => img);
                }
            }
            
            // Agregar imágenes subidas (nuevas)
            uploadedImages.forEach((img, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item';
                imgDiv.dataset.imagePath = img.data;
                imgDiv.dataset.imageName = img.name;
                
                if (selectedImages.includes(img.data)) {
                    imgDiv.classList.add('selected');
                }
                
                imgDiv.innerHTML = `
                    <img src="${img.data}" alt="${img.name}" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                    <div class="image-name">${img.name}</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                imgDiv.onclick = () => toggleImageSelection(img.data);
                availableContainer.appendChild(imgDiv);
            });
            
            // Mostrar imágenes seleccionadas
            selectedImages.forEach(imagePath => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item selected';
                
                imgDiv.innerHTML = `
                    <img src="${imagePath}" alt="Seleccionada" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="photo-placeholder" style="display: none;">
                        <span class="material-icons">photo</span>
                    </div>
                    <div class="image-name">Imagen seleccionada</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                selectedContainer.appendChild(imgDiv);
            });
            
            // Actualizar contador
            updatePhotoCounter();
        }

        // Función para alternar selección de imagen
        function toggleImageSelection(imagePath) {
            console.log('🔄 Alternando selección de imagen:', imagePath);
            
            // Obtener imágenes seleccionadas actuales
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = photosInput.value.split(',').map(img => img.trim()).filter(img => img);
                }
            }
            
            // Si es modo 'main', solo puede haber una imagen seleccionada
            if (currentImageManagerMode === 'main') {
                selectedImages = [imagePath];
            } else {
                // Modo 'gallery', puede haber múltiples
                const index = selectedImages.indexOf(imagePath);
                if (index > -1) {
                    selectedImages.splice(index, 1); // Deseleccionar
                } else {
                    if (selectedImages.length < 10) {
                        selectedImages.push(imagePath); // Seleccionar
                    } else {
                        alert('⚠️ Máximo 10 imágenes en la galería');
                        return;
                    }
                }
            }
            
            // Actualizar formulario
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = selectedImages[0] || '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = selectedImages.join(', ');
                }
            }
            
            // Re-renderizar
            renderImageManager();
        }

        // Función para ver foto
        function viewPhoto(imagePath) {
            // Implementar vista de foto
            console.log('Viendo foto:', imagePath);
        }

        // Función para eliminar foto
        function deletePhoto(imagePath) {
            // Implementar eliminación de foto
            console.log('Eliminando foto:', imagePath);
        }

        // Función para actualizar contador de fotos
        function updatePhotoCounter() {
            let selectedCount = 0;
            
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedCount = 1;
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    const images = photosInput.value.split(',').map(img => img.trim()).filter(img => img);
                    selectedCount = images.length;
                }
            }
            
            const counter = document.getElementById('photoCounter');
            if (counter) {
                const maxCount = currentImageManagerMode === 'main' ? 1 : 10;
                counter.textContent = `${selectedCount}/${maxCount} ${currentImageManagerMode === 'main' ? 'imagen' : 'fotos'} seleccionada(s)`;
                counter.style.color = selectedCount > 0 ? '#388e3c' : '#666';
            }
        }

        // Función para aplicar selección de imagen
        function applyImageSelection() {
            console.log('✅ Aplicando selección de imagen...');
            
            // Los valores ya están actualizados en el formulario por toggleImageSelection
            // Solo necesitamos cerrar el modal y actualizar previews
            
            // Actualizar previews
            if (currentImageManagerMode === 'main') {
                updateImagePreview();
            } else {
                updatePhotosPreview();
            }
            
            // Cerrar modal
            closeImageManager();
            
            alert('✅ Imágenes aplicadas correctamente');
        }

        // ============================================
        // GESTOR DE IMÁGENES - VERSIÓN NUEVA Y SIMPLE
        // ============================================
        
        // Variables globales
        let imageManagerMode = 'main'; // 'main' o 'gallery'
        let uploadedImagesBase64 = []; // Array de imágenes en base64
        let globalEditingHotelId = null; // ID del hotel que se está editando actualmente

        // Variable para prevenir aperturas múltiples del modal
        let isImageManagerOpening = false;
        
        // Función para abrir el modal de imágenes - VERSIÓN NUEVA Y SIMPLE
        function openImageManagerSimple(mode) {
            console.log('🔵 openImageManagerSimple llamada con modo:', mode);
            
            // Prevenir aperturas múltiples
            if (isImageManagerOpening) {
                console.log('⚠️ El gestor de imágenes ya se está abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('❌ Modal imageManagerModal no encontrado en el DOM');
                alert('❌ Error: Modal no encontrado. Recarga la página (F5).');
                return;
            }
            
            console.log('✅ Modal encontrado:', modal);
            
            // Verificar si el modal ya está abierto
            const currentDisplay = window.getComputedStyle(modal).display;
            if (modal.style.display === 'block' || currentDisplay === 'block') {
                console.log('⚠️ El gestor de imágenes ya está abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('🚀 Abriendo modal de imágenes - Modo:', mode);
            
            // Guardar el modo
            imageManagerMode = mode || 'main';
            
            // Configurar nombre del hotel
            const hotelNameSpan = document.getElementById('currentHotelName');
            if (hotelNameSpan) {
                const nameInput = document.getElementById('editHotelName');
                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
            }
            
            // Limpiar imágenes subidas
            uploadedImagesBase64 = [];
            updateUploadedImagesPreview();
            
            // Abrir modal con estilos forzados
            modal.style.setProperty('display', 'block', 'important');
            modal.style.setProperty('z-index', '10000', 'important');
            modal.style.setProperty('position', 'fixed', 'important');
            modal.style.setProperty('top', '0', 'important');
            modal.style.setProperty('left', '0', 'important');
            modal.style.setProperty('width', '100%', 'important');
            modal.style.setProperty('height', '100%', 'important');
            modal.style.setProperty('background-color', 'rgba(0,0,0,0.5)', 'important');
            
            console.log('✅ Modal abierto - Display:', window.getComputedStyle(modal).display);
            console.log('✅ Modal z-index:', window.getComputedStyle(modal).zIndex);
            
            // Verificar que el input de archivo existe
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput) {
                console.error('❌ Input imageUploadInput no encontrado');
            } else {
                console.log('✅ Input de archivo encontrado:', fileInput);
            }
            
            // Permitir nueva apertura después de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
        }
        
        // Función para cerrar el modal
        function closeImageManagerSimple() {
            const modal = document.getElementById('imageManagerModal');
            if (modal) {
                modal.style.display = 'none';
                isImageManagerOpening = false; // Resetear el flag
                console.log('✅ Modal cerrado');
            }
        }

        // Función para comprimir imagen antes de convertir a base64
        function compressImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo proporción
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresión
                        const compressedBase64 = canvas.toDataURL(file.type, quality);
                        const originalSize = file.size;
                        const compressedSize = Math.round((compressedBase64.length - 22) * 3 / 4); // Aproximación del tamaño
                        const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                        
                        console.log(`📦 Imagen comprimida: ${file.name} - Original: ${(originalSize / 1024).toFixed(2)} KB, Comprimida: ${(compressedSize / 1024).toFixed(2)} KB (${compressionRatio}% reducción)`);
                        
                        resolve({
                            name: file.name,
                            data: compressedBase64,
                            type: file.type,
                            size: compressedSize,
                            originalSize: originalSize
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Función para agregar imagen desde URL
        async function addImageFromURL() {
            const helpText = `🔗 Ingresa la URL de la imagen:

📋 Ejemplos de URLs que funcionan:
• https://images.unsplash.com/photo-1566073771259-6a8506099945
• https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg
• https://i.imgur.com/abc123.jpg
• https://ejemplo.com/imagen.jpg

💡 Cómo obtener la URL:
1. Haz clic derecho en la imagen
2. Selecciona "Copiar dirección de imagen"
3. Pega aquí

⚠️ La URL debe ser accesible públicamente.`;
            
            const url = prompt(helpText, 'https://');
            if (!url || !url.trim() || url === 'https://') {
                return;
            }
            
            const imageUrl = url.trim();
            
            // Validar que sea una URL válida
            try {
                new URL(imageUrl);
            } catch (e) {
                alert('❌ Por favor, ingresa una URL válida\n\nEjemplo: https://images.unsplash.com/photo-123.jpg');
                return;
            }
            
            // Verificar que sea una imagen
            const isImageExtension = imageUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i);
            const hasImageKeyword = imageUrl.toLowerCase().includes('image') || 
                                   imageUrl.toLowerCase().includes('photo') || 
                                   imageUrl.toLowerCase().includes('picture') ||
                                   imageUrl.toLowerCase().includes('img');
            
            if (!isImageExtension && !hasImageKeyword) {
                const confirm = window.confirm('⚠️ La URL no parece ser una imagen.\n\n¿Deseas continuar de todos modos?\n\n(Recomendado: URLs que terminen en .jpg, .png, etc.)');
                if (!confirm) return;
            }
            
            try {
                console.log('📥 Cargando imagen desde URL:', imageUrl);
                
                // Crear objeto de imagen
                const fileName = imageUrl.split('/').pop().split('?')[0] || 'imagen-desde-url.jpg';
                const imgObj = {
                    name: fileName.length > 50 ? fileName.substring(0, 50) + '...' : fileName,
                    data: imageUrl,
                    type: 'image/url',
                    size: 0,
                    isUrl: true,
                    originalUrl: imageUrl
                };
                
                uploadedImagesBase64.push(imgObj);
                updateUploadedImagesPreview();
                
                // Mostrar mensaje con información
                const serviceName = getImageServiceName(imageUrl);
                const message = serviceName 
                    ? `✅ Imagen agregada desde ${serviceName}\n\nLa imagen se cargará desde:\n${imageUrl.substring(0, 60)}...`
                    : `✅ Imagen agregada desde URL correctamente\n\nLa imagen se cargará desde la URL proporcionada.`;
                
                alert(message);
                
            } catch (error) {
                console.error('❌ Error agregando imagen desde URL:', error);
                alert('❌ Error al agregar la imagen.\n\nVerifica que:\n• La URL sea accesible públicamente\n• La URL sea correcta\n• El servidor permita acceso desde otros sitios\n\n💡 Tip: Prueba abriendo la URL en una nueva pestaña primero.');
            }
        }
        
        // Función auxiliar para identificar el servicio de imagen
        function getImageServiceName(url) {
            const urlLower = url.toLowerCase();
            if (urlLower.includes('unsplash.com')) return 'Unsplash';
            if (urlLower.includes('pexels.com')) return 'Pexels';
            if (urlLower.includes('pixabay.com')) return 'Pixabay';
            if (urlLower.includes('imgur.com')) return 'Imgur';
            if (urlLower.includes('imgbb.com')) return 'ImgBB';
            if (urlLower.includes('postimg.cc')) return 'Postimg';
            if (urlLower.includes('booking.com') || urlLower.includes('bstatic.com')) return 'Booking.com';
            if (urlLower.includes('tripadvisor.com')) return 'TripAdvisor';
            return null;
        }
        
        // Función para manejar la subida de imagen principal directamente desde disco
        async function handleMainImageUpload(event) {
            console.log('📁 handleMainImageUpload llamada');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('⚠️ No se seleccionó ningún archivo');
                return;
            }
            
            console.log(`📤 Procesando imagen principal: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            
            // Validar tamaño
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            try {
                // Comprimir y convertir a base64
                const compressed = await compressImage(file);
                console.log('✅ Imagen principal comprimida y lista');
                
                // Guardar en el campo del formulario
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = compressed.data;
                    updateImagePreview();
                    alert(`✅ Imagen principal "${file.name}" agregada correctamente`);
                }
                
                // Limpiar input para permitir seleccionar otra vez
                event.target.value = '';
                
            } catch (error) {
                console.error('❌ Error procesando imagen principal:', error);
                alert(`❌ Error procesando imagen "${file.name}"`);
                event.target.value = ''; // Limpiar input
            }
        }
        
        // Función para manejar la subida de imágenes de galería directamente desde disco
        async function handleGalleryImagesUpload(event) {
            console.log('📁 handleGalleryImagesUpload llamada');
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                console.log('⚠️ No se seleccionaron archivos');
                return;
            }
            
            console.log(`📤 Procesando ${files.length} imagen(es) para galería...`);
            
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput) {
                console.error('❌ Campo editHotelPhotos no encontrado');
                return;
            }
            
            const currentImages = photosInput.value ? photosInput.value.split(',').map(i => i.trim()).filter(i => i) : [];
            const maxSize = 10 * 1024 * 1024; // 10MB
            let processedCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tamaño
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    errorCount++;
                    continue;
                }
                
                // Validar límite de galería
                if (currentImages.length + processedCount >= 10) {
                    alert(`⚠️ Máximo 10 imágenes en la galería. Solo se procesarán las primeras ${10 - currentImages.length} imágenes.`);
                    break;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    currentImages.push(compressed.data);
                    processedCount++;
                    console.log(`✅ Imagen ${i + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    errorCount++;
                }
            }
            
            // Actualizar campo del formulario
            photosInput.value = currentImages.join(', ');
            updatePhotosPreview();
            
            // Mostrar resultado
            if (processedCount > 0) {
                const message = `✅ ${processedCount} imagen(es) agregada(s) a la galería${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
            
            // Limpiar input para permitir seleccionar otra vez
            event.target.value = '';
        }
        
        // Función para manejar la selección de archivos (para el modal)
        function handleFileSelection(event) {
            console.log('📁 handleFileSelection llamada');
            const files = event.target.files;
            const fileCount = files ? files.length : 0;
            console.log(`📁 ${fileCount} archivo(s) seleccionado(s)`);
            
            const infoDiv = document.getElementById('selectedFilesInfo');
            const countSpan = document.getElementById('fileCount');
            const uploadButton = document.getElementById('uploadButton');
            
            if (!infoDiv || !countSpan || !uploadButton) {
                console.error('❌ Elementos del formulario no encontrados');
                return;
            }
            
            if (fileCount > 0) {
                infoDiv.style.display = 'block';
                countSpan.textContent = fileCount;
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';
                console.log(`✅ ${fileCount} archivo(s) seleccionado(s) - Botón de subir habilitado`);
            } else {
                infoDiv.style.display = 'none';
                uploadButton.disabled = true;
                uploadButton.style.opacity = '0.5';
                uploadButton.style.cursor = 'not-allowed';
            }
        }
        
        // Función para subir imágenes (con compresión)
        async function uploadImagesSimple() {
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor, selecciona al menos una imagen');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const maxSize = 10 * 1024 * 1024; // 10MB (aumentado porque comprimiremos)
            
            console.log(`📤 Procesando ${files.length} imagen(es) con compresión...`);
            
            uploadedImagesBase64 = [];
            let processedCount = 0;
            let errorCount = 0;
            
            for (let index = 0; index < files.length; index++) {
                const file = files[index];
                
                // Validar tamaño original
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    uploadedImagesBase64.push(compressed);
                    processedCount++;
                    
                    console.log(`✅ Imagen ${index + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    alert(`❌ Error procesando imagen "${file.name}"`);
                    errorCount++;
                }
            }
            
            if (uploadedImagesBase64.length > 0) {
                updateUploadedImagesPreview();
                const message = `✅ ${processedCount} imagen(es) procesada(s) correctamente${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
                fileInput.value = '';
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
        }
        
        // Función para actualizar preview de imágenes subidas
        function updateUploadedImagesPreview() {
            const container = document.getElementById('uploadedImagesPreview');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (uploadedImagesBase64.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No hay imágenes subidas aún</p>';
                return;
            }
            
            uploadedImagesBase64.forEach((img, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; cursor: pointer;';
                
                // Determinar si es URL o base64
                const isUrl = img.isUrl || (!img.data.startsWith('data:'));
                const imageSrc = isUrl ? img.data : img.data;
                const badgeText = isUrl ? 'URL' : (img.originalSize ? `${Math.round((1 - img.size / img.originalSize) * 100)}%` : '');
                
                div.innerHTML = `
                    <img src="${imageSrc}" alt="${img.name}" 
                         style="width: 100%; height: 150px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'150\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'200\\' height=\\'150\\'/%3E%3Ctext fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'14\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3EError cargando imagen%3C/text%3E%3C/svg%3E';">
                    <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                        ${index + 1}
                    </div>
                    ${badgeText ? `<div style="position: absolute; top: 5px; left: 5px; background: rgba(76,175,80,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                        ${badgeText}
                    </div>` : ''}
                    ${isUrl ? `<div style="position: absolute; bottom: 30px; left: 0; right: 0; background: rgba(33,150,243,0.9); color: white; padding: 4px; font-size: 10px; text-align: center;">
                        🔗 URL Externa
                    </div>` : ''}
                    <div style="padding: 8px; font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${img.name}
                    </div>
                `;
                div.onclick = function() {
                    selectImage(img.data);
                };
                container.appendChild(div);
            });
        }
        
        // Función para seleccionar una imagen (acepta base64 o URL)
        function selectImage(imageData) {
            // imageData puede ser base64 o URL
            if (imageManagerMode === 'main') {
                // Modo imagen principal - solo una imagen
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = imageData;
                    updateImagePreview();
                }
            } else {
                // Modo galería - múltiples imágenes
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    const currentImages = photosInput.value ? photosInput.value.split(',').map(i => i.trim()) : [];
                    if (!currentImages.includes(imageData)) {
                        currentImages.push(imageData);
                        photosInput.value = currentImages.join(', ');
                        updatePhotosPreview();
                    }
                }
            }
            
            alert('✅ Imagen seleccionada correctamente');
        }
        
        // Función para aplicar selección
        function applyImageSelectionSimple() {
            closeImageManagerSimple();
            alert('✅ Selección aplicada correctamente');
        }

        // Función antigua (mantener por compatibilidad)
        async function uploadImages() {
            const fileInput = document.getElementById('imageUpload');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor, selecciona al menos una imagen');
                return;
            }

            const files = Array.from(fileInput.files);
            const maxSize = 5 * 1024 * 1024; // 5MB máximo
            
            console.log(`📤 Subiendo ${files.length} imagen(es)...`);
            
            uploadedImages = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tamaño
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 5MB)`);
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    continue;
                }
                
                try {
                    // Convertir a base64
                    const base64 = await fileToBase64(file);
                    uploadedImages.push({
                        name: file.name,
                        data: base64,
                        type: file.type,
                        size: file.size
                    });
                    
                    console.log(`✅ Imagen "${file.name}" convertida a base64 (${(file.size / 1024).toFixed(2)} KB)`);
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    alert(`❌ Error procesando imagen "${file.name}"`);
                }
            }
            
            if (uploadedImages.length > 0) {
                // Agregar las imágenes a las disponibles
                renderImageManager();
                alert(`✅ ${uploadedImages.length} imagen(es) procesada(s) correctamente. Ahora puedes seleccionarlas.`);
                
                // Limpiar el input
                fileInput.value = '';
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
        }
        
        // Función auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Función para crear archivo de imagen
        function createImageFile(path, fileName, hotel, photoNumber) {
            // Implementar creación de archivo
            console.log('Creando archivo de imagen:', fileName);
        }

        // Función para verificar si existe imagen
        function checkImageExists(imagePath) {
            // Implementar verificación de imagen
            console.log('Verificando imagen:', imagePath);
            return true;
        }

        // Función para validar ruta de imagen
        function validateImagePath(imagePath) {
            // Implementar validación de ruta
            console.log('Validando ruta:', imagePath);
            return true;
        }

        // Función para mostrar ayuda de imagen
        function showImageHelp() {
            // Implementar ayuda de imagen
            console.log('Mostrando ayuda de imagen...');
        }

        // Función para eliminar hotel
        function deleteHotel(hotelId) {
            if (confirm('¿Estás seguro de que quieres eliminar este hotel?')) {
                // Implementar eliminación
                console.log('Eliminando hotel:', hotelId);
            }
        }

        // Función para ver hotel
        function viewHotel(hotelId) {
            // Implementar vista de hotel
            console.log('Viendo hotel:', hotelId);
        }

        // Función para exportar hoteles
        function exportHotels() {
            // Implementar exportación
            console.log('Exportando hoteles...');
        }

        // Función para refrescar hoteles
        function refreshHotels() {
            loadHotelsTable();
            updateStats();
            alert('Datos actualizados correctamente');
        }

        // Función para inicializar dashboard
        function initializeDashboard() {
            // Inicializar bases de datos
            if (typeof initClientesDB === 'function') {
                initClientesDB();
            }
            if (typeof initHotelsDB === 'function') {
                initHotelsDB();
            }
            if (typeof initReservationsDB === 'function') {
                initReservationsDB();
            }
            if (typeof initQuotesDB === 'function') {
                initQuotesDB();
            }
            if (typeof syncQuotesFromIndex === 'function') {
                syncQuotesFromIndex();
            }
            
            window.showSection('dashboard', null);
            
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            // Actualizar estadísticas del dashboard (incluye Ingresos de Hoy)
            if (typeof updateStats === 'function') {
                updateStats();
            }
            
            // Event listeners para el formulario de edición de hoteles
            const editHotelForm = document.getElementById('editHotelForm');
            if (editHotelForm) {
                editHotelForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveHotelChanges();
                });
            }
            
            // Event listeners para previews en tiempo real (ELIMINADOS - campos de imagen removidos)
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                const editModal = document.getElementById('editHotelModal');
                const imageModal = document.getElementById('imageManagerModal');
                const carouselModal = document.getElementById('photoCarouselModal');
                const newQuoteModal = document.getElementById('newQuoteModal');
                const whatsappConfigModal = document.getElementById('whatsappConfigModal');
                const sendCotizadorLinkModal = document.getElementById('sendCotizadorLinkModal');
                const importUsersModal = document.getElementById('importUsersModal');
                
                if (event.target === editModal) {
                    closeEditModal();
                }
                // NO cerrar el modal de imágenes al hacer clic fuera - solo cerrar cuando se hace clic en el botón cerrar
                // if (event.target === imageModal) {
                //     closeImageManager();
                // }
                if (event.target === carouselModal) {
                    // Implementar cierre de carrusel
                }
                if (event.target === newQuoteModal) {
                    closeNewQuoteModal();
                }
                if (event.target === whatsappConfigModal) {
                    closeWhatsAppConfig();
                }
                if (event.target === sendCotizadorLinkModal) {
                    closeSendCotizadorLinkModal();
                }
                if (event.target === importUsersModal) {
                    closeImportUsersModal();
                }
            });
        }

        // Función para limpiar imágenes duplicadas
        function cleanDuplicateImages() {
            // Implementar limpieza
            console.log('Limpiando imágenes duplicadas...');
        }

        // Función para resetear gestor de imágenes
        function resetImageManager() {
            console.log('🔄 Reseteando gestor de imágenes...');
            
            // Limpiar imágenes subidas
            uploadedImages = [];
            
            // Limpiar selecciones
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = '';
                }
            }
            
            // Limpiar input de archivos
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Re-renderizar
            renderImageManager();
            
            alert('✅ Gestor de imágenes reseteado');
        }

        // Función para abrir carrusel de fotos
        function openPhotoCarousel() {
            // Implementar carrusel
            console.log('Abriendo carrusel de fotos...');
        }

        // Función para cerrar carrusel de fotos
        function closePhotoCarousel() {
            // Implementar cierre de carrusel
            console.log('Cerrando carrusel de fotos...');
        }

        // Función para actualizar imagen del carrusel
        function updateCarouselImage() {
            // Implementar actualización de imagen
            console.log('Actualizando imagen del carrusel...');
        }

        // Función para actualizar miniaturas del carrusel
        function updateCarouselThumbnails() {
            // Implementar actualización de miniaturas
            console.log('Actualizando miniaturas del carrusel...');
        }

        // Función para actualizar contador del carrusel
        function updateCarouselCounter() {
            // Implementar contador
            console.log('Actualizando contador del carrusel...');
        }

        // Función para foto anterior
        function previousPhoto() {
            // Implementar foto anterior
            console.log('Foto anterior...');
        }

        // Función para foto siguiente
        function nextPhoto() {
            // Implementar foto siguiente
            console.log('Foto siguiente...');
        }

        // Función para manejar teclas del carrusel
        function handleCarouselKeydown(event) {
            // Implementar manejo de teclas
            console.log('Manejando tecla:', event.key);
        }

        // Función para cargar fotos guardadas
        function loadSavedPhotos() {
            // Implementar carga de fotos
            console.log('Cargando fotos guardadas...');
        }

        // ===== FUNCIONES PARA GESTIÓN DE COTIZACIONES =====
        
        // Función para inicializar base de datos de cotizaciones
        function initQuotesDB() {
            console.log('📋 Inicializando base de datos de cotizaciones...');
            
            // Verificar si ya existen cotizaciones en localStorage
            let existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            console.log(`📊 Estado inicial: ${existingQuotes.length} cotizaciones en quotesDB`);
            
            // Verificar si hay cotizaciones en el sistema antiguo (checkin24hs_quotes)
            const oldQuotes = JSON.parse(localStorage.getItem('checkin24hs_quotes') || '[]');
            console.log(`📊 Cotizaciones en sistema antiguo: ${oldQuotes.length}`);
            
            // Migrar cotizaciones del sistema antiguo al nuevo si existen
            if (oldQuotes.length > 0) {
                console.log('🔄 Migrando cotizaciones del sistema antiguo...');
                
                // Convertir formato antiguo al nuevo formato
                const migratedQuotes = oldQuotes.map(oldQuote => {
                    // Buscar si ya existe esta cotización en el nuevo sistema (por ID)
                    const exists = existingQuotes.some(q => 
                        q.id === oldQuote.id || 
                        (q.id && String(q.id) === String(oldQuote.id))
                    );
                    
                    if (exists) {
                        console.log(`⏭️ Cotización ${oldQuote.id} ya existe, omitiendo...`);
                        return null;
                    }
                    
                    // Convertir formato antiguo al nuevo
                    const newQuote = {
                        id: oldQuote.id ? `COT-${oldQuote.id}` : `COT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        hotel: oldQuote.hotel || `Hotel ${oldQuote.hotel_id || 'Desconocido'}`,
                        hotelId: oldQuote.hotel_id,
                        checkIn: oldQuote.check_in_date,
                        checkOut: oldQuote.check_out_date,
                        dateRange: oldQuote.check_in_date && oldQuote.check_out_date 
                            ? `${formatDateForDisplay(oldQuote.check_in_date)} - ${formatDateForDisplay(oldQuote.check_out_date)}`
                            : 'Fechas no especificadas',
                        travelers: oldQuote.guests ? `${oldQuote.guests} huésped${oldQuote.guests > 1 ? 'es' : ''}` : 'No especificado',
                        adults: oldQuote.guests || 1,
                        children: 0,
                        tariff: oldQuote.total_price || 0,
                        finalTariff: oldQuote.total_price || 0,
                        clientName: oldQuote.clientName || 'Anónimo',
                        notes: oldQuote.special_requests || '',
                        status: oldQuote.status || 'pending',
                        timestamp: oldQuote.created_at || oldQuote.timestamp || new Date().toISOString(),
                        source: 'migrado'
                    };
                    
                    return newQuote;
                }).filter(q => q !== null); // Eliminar nulls (duplicados)
                
                if (migratedQuotes.length > 0) {
                    // Agregar cotizaciones migradas al array existente
                    existingQuotes = [...existingQuotes, ...migratedQuotes];
                    localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
                    console.log(`✅ ${migratedQuotes.length} cotizaciones migradas exitosamente`);
                    
                    // Marcar como migrado (no eliminar por si acaso)
                    localStorage.setItem('checkin24hs_quotes_migrated', 'true');
                } else {
                    console.log('ℹ️ No hay cotizaciones nuevas para migrar');
                }
            }
            
            console.log(`📊 Total de cotizaciones después de migración: ${existingQuotes.length}`);
            
            if (existingQuotes.length === 0) {
                console.log('📋 No hay cotizaciones, la base de datos se inicializará cuando lleguen las primeras cotizaciones');
            }
            
            // Cargar cotizaciones iniciales
            loadQuotesTable();
            updateQuotesStats();
        }
        
        // Función auxiliar para formatear fechas
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }
        
        // Función para obtener etiqueta de estado de cotización
        function getStatusLabel(status) {
            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'processed': 'Procesada',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada',
                'rejected': 'Rechazada',
                'sent': 'Enviada',
                'completed': 'Completada'
            };
            return statusLabels[status] || status || 'Pendiente';
        }
        
        // Función para cargar tabla de cotizaciones
        async function loadQuotesTable() {
            console.log('📋 Cargando tabla de cotizaciones...');
            
            // Intentar cargar desde Supabase primero
            let quotes = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando cotizaciones desde Supabase...');
                    quotes = await window.supabaseClient.getQuotes();
                    console.log(`✅ ${quotes.length} cotizaciones cargadas desde Supabase`);
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                }
            } else {
                console.log('💾 Cargando cotizaciones desde localStorage...');
                quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            }
            const tbody = document.getElementById('quotesTableBody');
            const noQuotesMessage = document.getElementById('noQuotesMessage');
            
            if (!tbody) {
                console.error('❌ No se encontró el tbody de cotizaciones');
                return;
            }
            
            if (quotes.length === 0) {
                tbody.innerHTML = '';
                if (noQuotesMessage) noQuotesMessage.style.display = 'block';
                console.log('📋 No hay cotizaciones para mostrar');
                return;
            }
            
            if (noQuotesMessage) noQuotesMessage.style.display = 'none';
            
            tbody.innerHTML = '';
            
            quotes.forEach((quote, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${quote.id || `COT-${String(index + 1).padStart(3, '0')}`}</td>
                    <td>${quote.hotel}</td>
                    <td>${quote.clientName || 'Anónimo'}</td>
                    <td>${quote.dateRange}</td>
                    <td>${quote.travelers}</td>
                    <td><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></td>
                    <td>${formatDate(quote.timestamp || new Date())}</td>
                    <td>
                        <button onclick="viewQuote('${quote.id || index}')" class="action-btn view" title="Ver detalles">
                            <span class="material-icons">visibility</span>
                        </button>
                        ${(quote.status === 'pending' || !quote.status) ? `
                        <button onclick="editQuote('${quote.id || index}')" class="action-btn edit" title="Editar y Cotizar" style="background: #ff9800;">
                            <span class="material-icons">edit</span>
                        </button>
                        ` : ''}
                        <button onclick="processQuote('${quote.id || index}')" class="action-btn edit" title="Procesar">
                            <span class="material-icons">check_circle</span>
                        </button>
                        <button onclick="deleteQuote('${quote.id || index}')" class="action-btn delete" title="Eliminar">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla de cotizaciones cargada: ${quotes.length} cotizaciones`);
        }
        
        // Función para actualizar estadísticas de cotizaciones
        function updateQuotesStats() {
            console.log('📊 Actualizando estadísticas de cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            // Calcular estadísticas
            const totalQuotes = quotes.length;
            const pendingQuotes = quotes.filter(q => !q.status || q.status === 'pending').length;
            const processedQuotes = quotes.filter(q => q.status === 'processed').length;
            
            // Calcular promedio por día (últimos 7 días)
            const last7Days = quotes.filter(q => {
                const quoteDate = new Date(q.timestamp);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return quoteDate >= weekAgo;
            });
            const avgQuotesPerDay = last7Days.length / 7;
            
            // Actualizar elementos en el DOM
            const totalElement = document.getElementById('totalQuotes');
            const pendingElement = document.getElementById('pendingQuotes');
            const processedElement = document.getElementById('processedQuotes');
            const avgElement = document.getElementById('avgQuotesPerDay');
            
            if (totalElement) totalElement.textContent = totalQuotes;
            if (pendingElement) pendingElement.textContent = pendingQuotes;
            if (processedElement) processedElement.textContent = processedQuotes;
            if (avgElement) avgElement.textContent = avgQuotesPerDay.toFixed(1);
            
            console.log(`📊 Estadísticas actualizadas: Total=${totalQuotes}, Pendientes=${pendingQuotes}, Procesadas=${processedQuotes}, Promedio/Día=${avgQuotesPerDay.toFixed(1)}`);
        }
        
        // Función para calcular acumulado de ventas del mes vigente
        function calculateMonthlySalesAccumulated() {
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            console.log('📅 Calculando acumulado para:', currentYear, 'mes', currentMonth);
            console.log('📊 Total de reservas:', reservations.length);
            
            // Filtrar reservas del mes actual que no estén canceladas
            const monthlyReservations = reservations.filter(reservation => {
                if (!reservation.checkIn || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                    return false;
                }
                
                // Normalizar fecha de check-in
                let dateStr = reservation.checkIn;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return false;
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                // Verificar que sea del mes actual
                return year === currentYear && month === currentMonth;
            });
            
            console.log('📋 Reservas del mes actual:', monthlyReservations.length);
            
            // Calcular total acumulado
            const total = monthlyReservations.reduce((sum, res) => {
                const amount = parseFloat(res.totalAmount) || 
                             parseFloat(res.total_amount) || 
                             parseFloat(res.amount) || 
                             parseFloat(res.price) || 0;
                return sum + amount;
            }, 0);
            
            console.log('💰 Total acumulado:', total);
            return total;
        }
        
        // Función para ver detalles de una cotización
        function viewQuote(quoteId) {
            console.log('👁️ Viendo detalles de cotización:', quoteId);
            
            try {
                const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
                
                if (!quote) {
                    alert('❌ Cotización no encontrada');
                    return;
                }
                
                // Crear modal con detalles de la cotización
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90%; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; margin: 2% auto;">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <h2>Detalles de Cotización</h2>
                        
                        <div style="display: grid; gap: 15px;">
                        ${quote.clientName ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #1976d2;">
                            <span style="font-size: 1.5rem;">👤</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Cliente</div>
                                <div style="color: #1976d2; font-size: 1.1rem; font-weight: 500;">${quote.clientName}</div>
                                ${quote.clientFirstName && quote.clientLastName ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                    ${quote.clientFirstName} ${quote.clientLastName}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">🏨</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Hotel</div>
                                <div style="color: #666;">${quote.hotel}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📅</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fechas</div>
                                <div style="color: #666;">${quote.dateRange}</div>
                                <div style="font-size: 0.8rem; color: #888;">Check-in: ${quote.checkIn} | Check-out: ${quote.checkOut}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">👥</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Huéspedes</div>
                                <div style="color: #666;">${quote.travelers}</div>
                                ${quote.children > 0 ? `<div style="font-size: 0.8rem; color: #888;">Edades: ${quote.childrenAges.join(', ')} años</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📊</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Estado</div>
                                <div style="color: #666;"><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">🕐</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fecha de Solicitud</div>
                                <div style="color: #666;">${formatDate(quote.timestamp)}</div>
                            </div>
                        </div>
                        
                        ${quote.module ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📦</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Módulo</div>
                                <div style="color: #666;">${quote.module}</div>
                    </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientEmail ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📧</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Email</div>
                                <div style="color: #666;">${quote.clientEmail}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientPhone ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📱</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Teléfono</div>
                                <div style="color: #666;">${quote.clientPhone}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.notes ? `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">📝 Notas</div>
                            <div style="color: #666;">${quote.notes}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${(quote.status === 'pending' || !quote.status) && (!quote.tariff || quote.tariff === 0) ? `
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="margin-bottom: 15px; color: #856404;">💰 Asignar Tarifa</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa *</label>
                                <input type="number" id="quoteTariffInput" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Descuento</label>
                                <input type="number" id="quoteDiscountInput" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa Final</label>
                            <input type="number" id="quoteFinalTariffInput" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; width: 100%;" value="0.00">
                        </div>
                        <button onclick="assignTariffToQuote('${quoteId}')" class="form-button" style="background: #ffc107; color: #333; width: 100%;">
                            💰 Asignar Tarifa y Enviar al Cliente
                        </button>
                    </div>
                    ` : quote.tariff > 0 ? `
                    <div style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #155724;">💰 Tarifa Asignada</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa</div>
                                <div style="color: #666; font-size: 1.2rem;">$${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Descuento</div>
                                <div style="color: #666; font-size: 1.2rem;">$${(quote.discount || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #c3e6cb;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa Final</div>
                            <div style="color: #155724; font-size: 1.5rem; font-weight: bold;">$${(quote.finalTariff || quote.tariff).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${(quote.status === 'pending' || !quote.status) ? `
                        <button onclick="processQuote('${quoteId}')" class="form-button" style="background: #28a745; color: white;">
                            ✅ Marcar como Procesada
                        </button>
                        ` : ''}
                        <button onclick="deleteQuote('${quoteId}')" class="form-button" style="background: #dc3545; color: white;">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
                document.body.appendChild(modal);
                console.log('✅ Modal creado y agregado al DOM');
                
                // Cerrar modal al hacer clic fuera
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('❌ Error al mostrar modal de cotización:', error);
                alert('❌ Error al mostrar los detalles de la cotización: ' + error.message);
            }
        }
        
        // Función para editar y cotizar una cotización pendiente
        function editQuote(quoteId) {
            console.log('✏️ Editando cotización:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (!quote) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>✏️ Editar y Cotizar</h2>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">👤 Información del Cliente</div>
                        <div style="color: #666;">
                            <div><strong>Nombre Completo:</strong> ${quote.clientName || 'No especificado'}</div>
                            ${quote.clientFirstName ? `<div><strong>Nombre:</strong> ${quote.clientFirstName}</div>` : ''}
                            ${quote.clientLastName ? `<div><strong>Apellido:</strong> ${quote.clientLastName}</div>` : ''}
                            ${quote.clientEmail ? `<div><strong>Email:</strong> ${quote.clientEmail}</div>` : ''}
                            ${quote.clientPhone ? `<div><strong>Teléfono:</strong> ${quote.clientPhone}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">📋 Detalles de la Cotización</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            <div><strong>Hotel:</strong> ${quote.hotel}</div>
                            <div><strong>Módulo:</strong> ${quote.module || 'No especificado'}</div>
                            <div><strong>Fechas:</strong> ${quote.dateRange}</div>
                            <div><strong>Noches:</strong> ${quote.nights || 'N/A'}</div>
                            <div><strong>Huéspedes:</strong> ${quote.travelers}</div>
                        </div>
                    </div>
                    
                    <form id="editQuoteForm" onsubmit="saveEditedQuote(event, '${quoteId}')">
                        <h3 style="margin-bottom: 15px; color: #333;">💰 Asignar Tarifa</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label class="form-label">Tarifa *</label>
                                <input type="number" id="editQuoteTariff" class="form-input" min="0" step="0.01" required 
                                       placeholder="0.00" value="${quote.tariff || ''}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descuento</label>
                                <input type="number" id="editQuoteDiscount" class="form-input" min="0" step="0.01" 
                                       placeholder="0.00" value="${quote.discount || 0}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Tarifa Final</label>
                            <input type="number" id="editQuoteFinalTariff" class="form-input" step="0.01" readonly 
                                   style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" 
                                   value="${(quote.finalTariff || quote.tariff || 0).toFixed(2)}">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Notas adicionales (opcional)</label>
                            <textarea id="editQuoteNotes" class="form-input" rows="3" 
                                      placeholder="Agregar notas o comentarios adicionales">${quote.notes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button type="button" class="form-button secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="submit" class="form-button" style="background: #25d366; color: white;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                                Guardar y Enviar al Cliente
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calcular tarifa final inicial
            calculateEditQuoteFinalTariff();
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Función para calcular tarifa final en el modal de edición
        function calculateEditQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('editQuoteTariff')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('editQuoteDiscount')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('editQuoteFinalTariff');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Función para guardar cotización editada y enviar al cliente
        async function saveEditedQuote(event, quoteId) {
            event.preventDefault();
            console.log('💾 Guardando cotización editada:', quoteId);
            
            const tariff = parseFloat(document.getElementById('editQuoteTariff').value);
            const discount = parseFloat(document.getElementById('editQuoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('editQuoteFinalTariff').value);
            const notes = document.getElementById('editQuoteNotes').value.trim();
            
            if (!tariff || tariff <= 0) {
                alert('❌ Por favor ingresa una tarifa válida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Actualizar cotización
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            if (notes) {
                quotes[quoteIndex].notes = notes;
            }
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Cotización actualizada:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Enviar al cliente por WhatsApp
            if (quotes[quoteIndex].clientPhone) {
                const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                
                try {
                    await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                    
                    // Cambiar estado a "enviado"
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('✅ Cotización guardada y enviada exitosamente al cliente por WhatsApp!');
                } catch (error) {
                    console.error('Error enviando:', error);
                    const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                    window.open(whatsappUrl, '_blank');
                    
                    // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('✅ Cotización guardada. Se abrió WhatsApp Web/App. Por favor, envía el mensaje manualmente.');
                }
            } else {
                alert('✅ Cotización guardada exitosamente');
            }
        }
        
        // Función para calcular tarifa final en el modal
        function calculateQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('quoteFinalTariffInput');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Función para asignar tarifa a una cotización
        async function assignTariffToQuote(quoteId) {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0);
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariffInput')?.value || 0);
            
            if (!tariff || tariff <= 0) {
                alert('❌ Por favor ingresa una tarifa válida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Actualizar cotización con tarifa
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Tarifa asignada a cotización:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal actual
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Preguntar si desea enviar al cliente
            if (quotes[quoteIndex].clientPhone) {
                if (confirm('✅ Tarifa asignada. ¿Deseas enviar la cotización con la tarifa al cliente por WhatsApp?')) {
                    // Formatear mensaje con tarifa
                    const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                    
                    // Enviar por WhatsApp
                    try {
                        await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                        
                        // Cambiar estado a "enviado"
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('✅ Cotización con tarifa enviada exitosamente al cliente!');
                    } catch (error) {
                        console.error('Error enviando:', error);
                        const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                        window.open(whatsappUrl, '_blank');
                        
                        // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('⚠️ Se abrió WhatsApp Web/App. Por favor, envía el mensaje manualmente.');
                    }
                }
            } else {
                alert('✅ Tarifa asignada exitosamente');
            }
        }
        
        // Función para procesar una cotización
        function processQuote(quoteId) {
            console.log('✅ Procesando cotización:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            quotes[quoteIndex].status = 'processed';
            quotes[quoteIndex].processedAt = new Date().toISOString();
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estadísticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Cotización marcada como procesada');
            
            // Cerrar modal si está abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para eliminar una cotización
        function deleteQuote(quoteId) {
            console.log('🗑️ Eliminando cotización:', quoteId);
            
            if (!confirm('¿Estás seguro de que quieres eliminar esta cotización?')) {
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            quotes.splice(quoteIndex, 1);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estadísticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Cotización eliminada');
            
            // Cerrar modal si está abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para actualizar cotizaciones
        function refreshQuotes() {
            console.log('🔄 Actualizando cotizaciones...');
            loadQuotesTable();
            updateQuotesStats();
            alert('✅ Cotizaciones actualizadas');
        }
        
        // Función para exportar cotizaciones
        function exportQuotes() {
            console.log('📤 Exportando cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            if (quotes.length === 0) {
                alert('❌ No hay cotizaciones para exportar');
                return;
            }
            
            // Crear CSV
            let csv = 'ID,Hotel,Cliente,Fechas,Huéspedes,Estado,Fecha\n';
            
            quotes.forEach((quote, index) => {
                csv += `${quote.id || `COT-${String(index + 1).padStart(3, '0')}`},`;
                csv += `"${quote.hotel}",`;
                csv += `"${quote.clientName || 'Anónimo'}",`;
                csv += `"${quote.dateRange}",`;
                csv += `"${quote.travelers}",`;
                csv += `"${quote.status || 'Pendiente'}",`;
                csv += `"${formatDate(quote.timestamp)}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cotizaciones_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('✅ Cotizaciones exportadas correctamente');
        }
        
        // Función para limpiar todas las cotizaciones
        function clearAllQuotes() {
            console.log('🗑️ Limpiando todas las cotizaciones...');
            
            if (!confirm('¿Estás seguro de que quieres eliminar TODAS las cotizaciones? Esta acción no se puede deshacer.')) {
                return;
            }
            
            localStorage.removeItem('quotesDB');
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Todas las cotizaciones han sido eliminadas');
        }
        
        // Función para filtrar cotizaciones
        function filterQuotes() {
            console.log('🔍 Filtrando cotizaciones...');
            
            const searchTerm = document.getElementById('quotesSearch').value.toLowerCase();
            const tbody = document.getElementById('quotesTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ========== FUNCIONES DEL COTIZADOR ==========
        
        // Función para mostrar modal de envío de link del cotizador
        function showSendCotizadorLinkModal() {
            console.log('📱 Abriendo modal para enviar link del cotizador...');
            
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('sendLinkForm').reset();
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            // Formatear mensaje con el link en una línea separada para que sea más visible
            document.getElementById('linkMessage').value = `Hola! 👋\n\nTe envío el link para que puedas solicitar tu cotización personalizada:\n\n${cotizadorLink}\n\n✅ Completa el formulario y te enviaremos tu cotización personalizada.\n\n¡Gracias por confiar en nosotros! 🙏`;
            // Limpiar imagen seleccionada
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
            
            // Si hay una imagen subida en la página de cotizaciones, usarla
            if (quoteImageFile) {
                // Crear un DataTransfer para asignar el archivo al input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(quoteImageFile);
                document.getElementById('linkImageInput').files = dataTransfer.files;
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(quoteImageFile);
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar modal de envío de link
        function closeSendCotizadorLinkModal() {
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para previsualizar imagen en el modal
        function previewLinkImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Función para eliminar imagen del modal
        function removeLinkImage() {
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
        }
        
        // Variable global para almacenar la imagen subida en la página de cotizaciones
        let quoteImageFile = null;
        
        // Función para manejar la subida de imagen en la página de cotizaciones
        function handleQuoteImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                quoteImageFile = file;
                alert(`✅ Imagen seleccionada: ${file.name}\n\nLa imagen se incluirá cuando envíes el link del cotizador.`);
            }
        }
        
        // Función para generar link del cotizador
        function getCotizadorLink() {
            // Si estamos en un servidor web, usar la URL actual
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) || window.location.origin;
                return `${baseUrl}/cotizador-cliente.html`;
            }
            
            // Si estamos en file://, generar una URL relativa que funcione
            // Nota: Para que funcione completamente, el archivo debe estar en un servidor web
            return './cotizador-cliente.html';
        }
        
        // Función para enviar link del cotizador por WhatsApp
        async function sendCotizadorLink(event) {
            event.preventDefault();
            console.log('📱 Enviando link del cotizador...');
            
            const phoneNumber = document.getElementById('linkPhoneNumber').value.trim();
            const customMessage = document.getElementById('linkMessage').value.trim();
            
            if (!phoneNumber) {
                alert('❌ Por favor ingresa el número de WhatsApp del cliente');
                return;
            }
            
            // Limpiar número de teléfono
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('❌ El número de teléfono no es válido. Debe incluir el código de país.');
                return;
            }
            
            // Obtener imagen si está seleccionada
            const imageInput = document.getElementById('linkImageInput');
            const imageFile = imageInput.files[0];
            
            // Formatear mensaje con link clickeable
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            let message = customMessage;
            if (!message) {
                message = `Hola! 👋\n\nTe envío el link para que puedas solicitar tu cotización personalizada:\n\n${cotizadorLink}\n\n✅ Completa el formulario y te enviaremos tu cotización personalizada.\n\n¡Gracias por confiar en nosotros! 🙏`;
            }
            
            // Asegurar que el link esté en una línea separada y bien formateado
            // Reemplazar cualquier variación del link para asegurar formato consistente
            message = message.replace(/file:\/\/\/C:\/Users\/German\/Downloads\/Checkin24hs\/cotizador-cliente\.html/gi, cotizadorLink);
            
            // Nota: Los links file:// no son clickeables en WhatsApp Web, 
            // pero funcionan en algunas aplicaciones de escritorio de WhatsApp
            
            // Intentar enviar por WhatsApp Business API
            try {
                if (imageFile) {
                    // Si hay imagen, enviar primero la imagen con el mensaje como caption
                    await sendWhatsAppImage(cleanPhone, imageFile, message);
                } else {
                    // Si no hay imagen, enviar solo el mensaje
                    await sendWhatsAppMessage(cleanPhone, message);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
                
                alert(`✅ Link del cotizador enviado exitosamente a ${phoneNumber} por WhatsApp!`);
                
            } catch (error) {
                console.error('❌ Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar método alternativo (wa.me)
                // Nota: wa.me no soporta envío de imágenes directamente
                // Abrir WhatsApp con el mensaje y notificar al usuario sobre la imagen
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Si hay imagen, mostrar instrucciones más detalladas
                if (imageFile) {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE' 
                        ? '⚠️ No hay configuración de WhatsApp Business API configurada y el servidor no está disponible.\n\nSe abrió WhatsApp Web/App con el mensaje prellenado.\n\n📸 IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.\n\n💡 Para enviar imágenes automáticamente, configura las credenciales de WhatsApp Business API en la configuración del sistema.'
                        : '⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado.\n\n📸 IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.';
                    alert(errorMessage);
                } else {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE'
                        ? '⚠️ No hay configuración de WhatsApp Business API configurada y el servidor no está disponible.\n\nSe abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.\n\n💡 Para enviar mensajes automáticamente, configura las credenciales de WhatsApp Business API en la configuración del sistema.'
                        : '⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.';
                    alert(errorMessage);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
            }
        }
        
        // Función para mostrar el modal de nueva cotización
        function showNewQuoteModal() {
            console.log('📋 Abriendo modal de nueva cotización...');
            
            const modal = document.getElementById('newQuoteModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('quoteForm').reset();
            document.getElementById('quoteAdults').value = 1;
            document.getElementById('quoteChildren').value = 0;
            document.getElementById('quoteInfants').value = 0;
            document.getElementById('quoteTariff').value = '';
            document.getElementById('quoteDiscount').value = 0;
            document.getElementById('quoteFinalTariff').value = '0.00';
            document.getElementById('childrenAgesContainer').style.display = 'none';
            document.getElementById('nightsDisplay').style.display = 'none';
            
            // Cargar hoteles
            loadHotelsForQuote();
            
            // Establecer fecha mínima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteCheckIn').setAttribute('min', today);
            document.getElementById('quoteCheckOut').setAttribute('min', today);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar el modal de nueva cotización
        function closeNewQuoteModal() {
            const modal = document.getElementById('newQuoteModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para mostrar modal de configuración de WhatsApp
        function showWhatsAppConfig() {
            console.log('⚙️ Abriendo configuración de WhatsApp...');
            
            const modal = document.getElementById('whatsappConfigModal');
            if (!modal) {
                alert('❌ Error: Modal de configuración no encontrado');
                return;
            }
            
            // Cargar configuración existente
            const config = getWhatsAppConfig();
            const serverUrl = getServerURL();
            
            document.getElementById('whatsappAccessToken').value = config.accessToken || '';
            document.getElementById('whatsappPhoneNumberId').value = config.phoneNumberId || '';
            document.getElementById('whatsappApiVersion').value = config.apiVersion || 'v18.0';
            document.getElementById('whatsappServerURL').value = serverUrl || '';
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar modal de configuración de WhatsApp
        function closeWhatsAppConfig() {
            const modal = document.getElementById('whatsappConfigModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para guardar configuración de WhatsApp
        function saveWhatsAppConfig(event) {
            event.preventDefault();
            console.log('💾 Guardando configuración de WhatsApp...');
            
            const accessToken = document.getElementById('whatsappAccessToken').value.trim();
            const phoneNumberId = document.getElementById('whatsappPhoneNumberId').value.trim();
            const apiVersion = document.getElementById('whatsappApiVersion').value.trim() || 'v18.0';
            const serverURL = document.getElementById('whatsappServerURL').value.trim();
            
            if (!accessToken || !phoneNumberId) {
                alert('❌ Por favor completa los campos obligatorios (Access Token y Phone Number ID)');
                return;
            }
            
            // Guardar configuración
            const config = {
                accessToken: accessToken,
                phoneNumberId: phoneNumberId,
                apiVersion: apiVersion
            };
            
            localStorage.setItem('whatsappConfig', JSON.stringify(config));
            
            if (serverURL) {
                localStorage.setItem('whatsappServerURL', serverURL);
            }
            
            console.log('✅ Configuración guardada');
            alert('✅ Configuración de WhatsApp guardada exitosamente');
            
            // Cerrar modal
            closeWhatsAppConfig();
        }
        
        // Función para cargar hoteles en el selector
        function loadHotelsForQuote() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const select = document.getElementById('quoteHotel');
            
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar hotel</option>';
            
            if (hotels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay hoteles disponibles';
                select.appendChild(option);
                return;
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.name;
                option.textContent = hotel.name || 'Hotel sin nombre';
                select.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el cotizador`);
        }
        
        // Función para cargar contactos con teléfono en el selector
        function loadContactsForQuote() {
            // Cargar usuarios desde diferentes fuentes
            const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Combinar todos los usuarios
            const allContacts = [];
            
            // Agregar usuarios del dashboard
            dashboardUsers.forEach(user => {
                if (user.phone) {
                    allContacts.push({
                        name: user.name || 'Sin nombre',
                        phone: user.phone,
                        email: user.email || '',
                        source: 'Dashboard'
                    });
                }
            });
            
            // Agregar usuarios móviles
            mobileUsers.forEach(user => {
                if (user.phone) {
                    const exists = allContacts.find(c => c.phone === user.phone);
                    if (!exists) {
                        allContacts.push({
                            name: user.name || 'Sin nombre',
                            phone: user.phone,
                            email: user.email || '',
                            source: 'Móvil'
                        });
                    }
                }
            });
            
            // Agregar contactos de reservas
            reservations.forEach(reservation => {
                if (reservation.guestPhone) {
                    const exists = allContacts.find(c => c.phone === reservation.guestPhone);
                    if (!exists) {
                        allContacts.push({
                            name: reservation.guestName || 'Sin nombre',
                            phone: reservation.guestPhone,
                            email: reservation.guestEmail || '',
                            source: 'Reserva'
                        });
                    }
                }
            });
            
            const select = document.getElementById('quoteContact');
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar contacto</option>';
            
            if (allContacts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay contactos con teléfono disponibles';
                select.appendChild(option);
                return;
            }
            
            // Ordenar por nombre
            allContacts.sort((a, b) => a.name.localeCompare(b.name));
            
            allContacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.phone;
                option.textContent = `${contact.name} - ${contact.phone} (${contact.source})`;
                option.setAttribute('data-name', contact.name);
                select.appendChild(option);
            });
            
            console.log(`✅ ${allContacts.length} contactos cargados en el cotizador`);
        }
        
        // Función para calcular noches
        function calculateNights() {
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const display = document.getElementById('nightsDisplay');
            const count = document.getElementById('nightsCount');
            
            if (!checkIn || !checkOut) {
                display.style.display = 'none';
                return;
            }
            
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            if (checkOutDate <= checkInDate) {
                display.style.display = 'none';
                alert('⚠️ La fecha de check-out debe ser posterior al check-in');
                return;
            }
            
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            count.textContent = diffDays;
            display.style.display = 'block';
        }
        
        // Función para calcular tarifa final
        function calculateFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            document.getElementById('quoteFinalTariff').value = finalTariff.toFixed(2);
        }
        
        // Función para mostrar/ocultar campos de edades de niños
        function toggleChildrenAges() {
            const childrenCount = parseInt(document.getElementById('quoteChildren').value) || 0;
            const container = document.getElementById('childrenAgesContainer');
            const inputsContainer = document.getElementById('childrenAgesInputs');
            
            if (childrenCount > 0) {
                container.style.display = 'block';
                inputsContainer.innerHTML = '';
                
                for (let i = 0; i < childrenCount; i++) {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">
                            Edad del niño ${i + 1}:
                        </label>
                        <input type="number" class="form-input" min="0" max="17" 
                               id="childAge${i}" placeholder="Edad" required 
                               style="width: 100%;">
                    `;
                    inputsContainer.appendChild(div);
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Función para crear y enviar cotización por WhatsApp
        function createAndSendQuote(event) {
            event.preventDefault();
            console.log('📋 Creando y enviando cotización...');
            
            // Obtener valores del formulario
            const hotelId = document.getElementById('quoteHotel').value;
            const hotelName = document.getElementById('quoteHotel').selectedOptions[0].text;
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const adults = parseInt(document.getElementById('quoteAdults').value) || 1;
            const children = parseInt(document.getElementById('quoteChildren').value) || 0;
            const infants = parseInt(document.getElementById('quoteInfants').value) || 0;
            const module = document.getElementById('quoteModule').value;
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariff').value) || 0;
            const notes = document.getElementById('quoteNotes').value;
            
            // Validaciones
            if (!hotelId || !checkIn || !checkOut || !module || tariff <= 0) {
                alert('❌ Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Obtener edades de niños
            const childrenAges = [];
            if (children > 0) {
                for (let i = 0; i < children; i++) {
                    const age = parseInt(document.getElementById(`childAge${i}`).value);
                    if (age) childrenAges.push(age);
                }
            }
            
            // Calcular noches
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Formatear fechas para mostrar
            const checkInFormatted = new Date(checkIn).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const checkOutFormatted = new Date(checkOut).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Formatear descripción de huéspedes
            let travelersDesc = `${adults} adulto${adults > 1 ? 's' : ''}`;
            if (children > 0) travelersDesc += `, ${children} niño${children > 1 ? 's' : ''}`;
            if (infants > 0) travelersDesc += `, ${infants} infante${infants > 1 ? 's' : ''}`;
            
            // Crear objeto de cotización
            const quote = {
                id: 'COT-' + Date.now(),
                hotel: hotelName,
                hotelId: hotelId,
                checkIn: checkIn,
                checkOut: checkOut,
                dateRange: `${checkInFormatted} - ${checkOutFormatted}`,
                nights: nights,
                adults: adults,
                children: children,
                infants: infants,
                childrenAges: childrenAges,
                travelers: travelersDesc,
                module: module,
                tariff: tariff,
                discount: discount,
                finalTariff: finalTariff,
                notes: notes,
                status: 'pending',
                timestamp: new Date().toISOString(),
                source: 'dashboard'
            };
            
            // Guardar cotización en localStorage
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            quotes.push(quote);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Cotización guardada:', quote);
            
            // Obtener número de teléfono
            const phoneNumber = document.getElementById('quotePhoneNumber').value.trim();
            
            if (!phoneNumber) {
                alert('❌ Por favor ingresa el número de WhatsApp del destinatario');
                return;
            }
            
            // Limpiar número de teléfono (solo números, con código de país)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('❌ El número de teléfono no es válido. Debe incluir el código de país.');
                return;
            }
            
            // Formatear mensaje para WhatsApp
            const whatsappMessage = formatWhatsAppMessage(quote);
            
            // Actualizar cotización con número de teléfono
            quote.clientPhone = cleanPhone;
            const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
            if (quoteIndex !== -1) {
                quotesUpdated[quoteIndex] = quote;
                localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
            }
            
            // Intentar enviar por WhatsApp Business API
            sendWhatsAppMessage(cleanPhone, whatsappMessage).then(() => {
                // Cambiar estado a "enviado"
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotización en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estadísticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert(`✅ Cotización creada y enviada exitosamente a ${phoneNumber} por WhatsApp!`);
            }).catch(error => {
                console.error('❌ Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar método alternativo (wa.me)
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrl, '_blank');
                
                // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotización en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estadísticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert('⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.');
            });
        }
        
        // Función para enviar mensaje por WhatsApp Business API
        async function sendWhatsAppMessage(phoneNumber, message) {
            console.log('📱 Enviando mensaje por WhatsApp API a:', phoneNumber);
            
            // Obtener configuración de WhatsApp (puede estar en localStorage o variables globales)
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuración, intentar usar endpoint del servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
            
            // Enviar usando WhatsApp Business API directamente
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'text',
                        text: {
                            body: message
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error al enviar mensaje');
                }
                
                const result = await response.json();
                console.log('✅ Mensaje enviado exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en API directa, intentando servidor:', error);
                // Si falla, intentar con el servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
        }
        
        // Función para enviar vía endpoint del servidor
        async function sendViaServerAPI(phoneNumber, message) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuración de WhatsApp ni servidor disponible');
            }
            
            try {
                const response = await fetch(`${serverUrl}/api/whatsapp/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('✅ Mensaje enviado vía servidor:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en servidor:', error);
                throw new Error('No se pudo enviar el mensaje. Verifica la configuración de WhatsApp.');
            }
        }
        
        // Función para enviar imagen por WhatsApp Business API
        async function sendWhatsAppImage(phoneNumber, imageFile, caption = '') {
            console.log('📱 Enviando imagen por WhatsApp API a:', phoneNumber);
            
            // Obtener configuración de WhatsApp
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuración, verificar si hay servidor disponible
                const serverUrl = getServerURL();
                if (serverUrl) {
                    console.log('⚠️ No hay configuración de WhatsApp, intentando servidor...');
                    try {
                        return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                    } catch (serverError) {
                        console.error('❌ Servidor no disponible:', serverError);
                        // Lanzar error específico para que se maneje en el catch principal
                        throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                    }
                } else {
                    // No hay configuración ni servidor
                    console.error('❌ No hay configuración de WhatsApp ni servidor disponible');
                    throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                }
            }
            
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                
                // Paso 1: Subir la imagen primero para obtener el media ID
                console.log('📤 Subiendo imagen a WhatsApp...');
                const mediaId = await uploadWhatsAppMedia(imageFile, whatsappConfig);
                console.log('✅ Imagen subida, media ID:', mediaId);
                
                // Paso 2: Enviar mensaje con imagen usando el media ID
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                console.log('📨 Enviando mensaje con imagen...');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'image',
                        image: {
                            id: mediaId
                        },
                        caption: caption.substring(0, 1024) // WhatsApp limita el caption a 1024 caracteres
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('❌ Error en respuesta:', errorData);
                    throw new Error(errorData.error?.message || `Error al enviar imagen: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Imagen enviada exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en API directa:', error);
                // Si falla, intentar con el servidor
                try {
                    return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                } catch (serverError) {
                    console.error('❌ Error también en servidor:', serverError);
                    throw error; // Lanzar el error original para que se maneje en el catch principal
                }
            }
        }
        
        // Función para subir media a WhatsApp
        async function uploadWhatsAppMedia(file, config) {
            const apiVersion = config.apiVersion || 'v18.0';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('messaging_product', 'whatsapp');
            formData.append('type', 'image');
            
            console.log('📤 Subiendo archivo:', file.name, 'Tamaño:', file.size);
            
            const response = await fetch(`https://graph.facebook.com/${apiVersion}/${config.phoneNumberId}/media`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.accessToken}`
                    // No establecer Content-Type para FormData, el navegador lo hace automáticamente
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('❌ Error al subir imagen:', errorData);
                throw new Error(errorData.error?.message || `Error al subir imagen: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('✅ Media subido exitosamente:', result);
            return result.id;
        }
        
        // Función auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Función para enviar imagen vía endpoint del servidor
        async function sendImageViaServerAPI(phoneNumber, imageFile, caption) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuración de WhatsApp ni servidor disponible');
            }
            
            try {
                const formData = new FormData();
                formData.append('phoneNumber', phoneNumber);
                formData.append('image', imageFile);
                formData.append('caption', caption);
                
                const response = await fetch(`${serverUrl}/api/whatsapp/send-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('✅ Imagen enviada vía servidor:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en servidor:', error);
                throw new Error('No se pudo enviar la imagen. Verifica la configuración de WhatsApp.');
            }
        }
        
        // Función para obtener configuración de WhatsApp
        function getWhatsAppConfig() {
            // Intentar obtener desde localStorage
            const stored = localStorage.getItem('whatsappConfig');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error parseando configuración:', e);
                }
            }
            
            // Valores por defecto (deben configurarse)
            return {
                accessToken: '',
                phoneNumberId: '',
                apiVersion: 'v18.0'
            };
        }
        
        // Función para obtener URL del servidor
        function getServerURL() {
            // Intentar obtener desde localStorage
            const serverUrl = localStorage.getItem('whatsappServerURL');
            if (serverUrl && serverUrl.trim() !== '') {
                return serverUrl.trim();
            }
            
            // No devolver valor por defecto - el servidor debe estar explícitamente configurado
            return null;
        }
        
        // Función para formatear mensaje de WhatsApp
        function formatWhatsAppMessage(quote) {
            let message = `*📋 COTIZACIÓN DE RESERVA*\n\n`;
            message += `Hola! 👋\n\n`;
            message += `Te envío la cotización que solicitaste:\n\n`;
            message += `🏨 *Hotel:* ${quote.hotel}\n`;
            message += `📦 *Módulo:* ${quote.module}\n`;
            message += `📅 *Check-in:* ${quote.checkIn}\n`;
            message += `📅 *Check-out:* ${quote.checkOut}\n`;
            message += `🌙 *Noches:* ${quote.nights}\n`;
            message += `👥 *Huéspedes:* ${quote.travelers}\n`;
            
            if (quote.children > 0 && quote.childrenAges && quote.childrenAges.length > 0) {
                message += `👶 *Edades de niños:* ${quote.childrenAges.join(', ')} años\n`;
            }
            
            message += `\n💰 *DETALLES DE PRECIO:*\n`;
            message += `💵 *Tarifa:* $${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.discount > 0) {
                message += `🎁 *Descuento:* $${quote.discount.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            }
            
            message += `💳 *Tarifa Final:* $${quote.finalTariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.notes) {
                message += `\n📝 *Notas:* ${quote.notes}\n`;
            }
            
            message += `\n📅 *Fecha de cotización:* ${new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}\n\n`;
            message += `¿Te gustaría realizar esta reserva? Estoy disponible para ayudarte. 😊\n\n`;
            message += `¡Gracias por confiar en nosotros! 🙏`;
            
            return message;
        }
        
        // Funciones auxiliares para promociones de hoteles
        function showPromotionTab(tabName) {
            console.log('🏨 Cambiando a pestaña de promoción:', tabName);
            
            // Buscar el contenedor de promociones (puede estar en modal o en la sección)
            const promotionContent = document.getElementById('promotion-content');
            if (!promotionContent) return;
            
            // Ocultar todas las pestañas dentro del contenedor
            const tabContents = promotionContent.querySelectorAll('.promotion-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostrar la pestaña seleccionada
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Actualizar estilos de los botones de pestaña
            const tabButtons = promotionContent.parentElement.querySelectorAll('.promotion-tab');
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.style.background = '#ff9800';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#333';
                }
            });
        }
        
        function editHotelPromotion(hotelId) {
            console.log('✏️ Editando promoción del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            // Cargar promociones existentes del hotel
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            
            showEditPromotionModal(hotel, hotelPromotions);
        }
        
        function viewHotelPromotion(hotelId) {
            console.log('👁️ Viendo promoción del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            showViewPromotionModal(hotel, hotelPromotions);
        }
        
        function deactivateHotelPromotion(hotelId) {
            console.log('⏸️ Pausando promoción del hotel:', hotelId);
            
            if (confirm('¿Estás seguro de que quieres pausar esta promoción?')) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const hotelIndex = hotels.findIndex(h => h.id === hotelId);
                
                if (hotelIndex !== -1) {
                    hotels[hotelIndex].promotionStatus = 'paused';
                    localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                    
                    // Actualizar la interfaz - recargar contenido de promociones si está visible
                    const promotionsContent = document.getElementById('promotions-tab-content');
                    if (promotionsContent && promotionsContent.style.display !== 'none') {
                        loadHotelPromotionsContent();
                    } else {
                    showHotelPromotions();
                    }
                    alert('Promoción pausada correctamente');
                }
            }
        }
        
        function createHotelPromotion() {
            console.log('➕ Creando nueva promoción de hotel...');
            
            const hotelId = document.getElementById('promotionHotel').value;
            const promotionType = document.getElementById('promotionType').value;
            const discount = document.getElementById('promotionDiscount').value;
            const price = document.getElementById('promotionPrice').value;
            const description = document.getElementById('promotionDescription').value;
            const startDate = document.getElementById('promotionStartDate').value;
            const endDate = document.getElementById('promotionEndDate').value;
            
            if (!hotelId || !promotionType || !description || !startDate || !endDate) {
                alert('❌ Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Aquí se guardaría la promoción en localStorage
            const promotion = {
                id: `PROM-${Date.now()}`,
                hotelId: hotelId,
                type: promotionType,
                discount: discount,
                price: price,
                description: description,
                startDate: startDate,
                endDate: endDate,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Guardar en localStorage (implementación futura)
            console.log('✅ Promoción creada:', promotion);
            alert('✅ Promoción creada correctamente');
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para mostrar modal de edición de promociones
        function showEditPromotionModal(hotel, existingPromotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">✏️ Editar Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Promociones existentes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">Promociones Existentes</h3>
                        <div id="existing-promotions" style="display: grid; gap: 12px;">
                            ${existingPromotions.map((promo, index) => `
                                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; color: #333;">${promo.name}</h4>
                                        <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                    </div>
                                    <p style="margin: 0 0 8px 0; color: #666;">${promo.description}</p>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editSpecificPromotion('${hotel.id}', ${index})" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Editar</button>
                                        <button onclick="deletePromotion('${hotel.id}', ${index})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Eliminar</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Formulario para nueva promoción -->
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">➕ Agregar Nueva Promoción</h3>
                        
                        <form id="newPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre de la Promoción</label>
                                    <input type="text" id="promoName" placeholder="Ej: Descuento de Verano" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                    <select id="promoType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                        <option value="seasonal">Temporada</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción</label>
                                <textarea id="promoDescription" placeholder="Describe la promoción..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promoDiscount" min="0" max="100" placeholder="20" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promoStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promoEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Guardar Promoción</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para el formulario
            document.getElementById('newPromotionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewPromotion(hotel.id);
            });
        }
        
        // Función para guardar nueva promoción
        function saveNewPromotion(hotelId) {
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promoName').value,
                type: document.getElementById('promoType').value,
                description: document.getElementById('promoDescription').value,
                discount: document.getElementById('promoDiscount').value,
                startDate: document.getElementById('promoStartDate').value,
                endDate: document.getElementById('promoEndDate').value,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.name || !promoData.description) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Guardar promoción
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoción guardada correctamente');
            
            // Cerrar modal si existe
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            
            // Actualizar la interfaz - recargar contenido de promociones si está visible
            const promotionsContent = document.getElementById('promotions-tab-content');
            if (promotionsContent && promotionsContent.style.display !== 'none') {
                loadHotelPromotionsContent();
            } else {
                showHotelPromotions();
            }
        }
        
        // Función para guardar promoción desde el formulario en la sección
        function savePromotion() {
            const hotelId = document.getElementById('promotionHotel').value;
            if (!hotelId) {
                alert('Por favor selecciona un hotel');
                return;
            }
            
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promotionType').value,
                type: document.getElementById('promotionType').value,
                description: document.getElementById('promotionDescription').value,
                discount: document.getElementById('promotionDiscount').value,
                startDate: document.getElementById('promotionStartDate').value,
                endDate: document.getElementById('promotionEndDate').value,
                status: document.getElementById('promotionStatus').value,
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.description) {
                alert('Por favor completa la descripción');
                return;
            }
            
            // Guardar promoción
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoción guardada correctamente');
            
            // Recargar contenido de promociones
            loadHotelPromotionsContent();
            
            // Cambiar a pestaña de promociones activas
            showPromotionTab('active');
        }
        
        // Función para mostrar modal de vista de promociones
        function showViewPromotionModal(hotel, promotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">👁️ Ver Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        ${promotions.length > 0 ? promotions.map(promo => `
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <h3 style="margin: 0; color: #333;">${promo.name}</h3>
                                    <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                </div>
                                <p style="margin: 0 0 12px 0; color: #666;">${promo.description}</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <strong>Tipo:</strong> ${promo.type}
                                    </div>
                                    <div>
                                        <strong>Descuento:</strong> ${promo.discount}%
                                    </div>
                                    <div>
                                        <strong>Inicio:</strong> ${promo.startDate}
                                    </div>
                                    <div>
                                        <strong>Fin:</strong> ${promo.endDate}
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <strong>Creado:</strong> ${new Date(promo.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('') : `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <p>No hay promociones activas para este hotel</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Función para editar promoción específica
        function editSpecificPromotion(hotelId, promoIndex) {
            console.log('✏️ Editando promoción específica:', hotelId, promoIndex);
            // Implementar edición de promoción específica
            alert('Función de edición específica en desarrollo');
        }
        
        // Función para eliminar promoción
        function deletePromotion(hotelId, promoIndex) {
            if (confirm('¿Estás seguro de que quieres eliminar esta promoción?')) {
                const promotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
                promotions.splice(promoIndex, 1);
                localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(promotions));
                
                alert('Promoción eliminada correctamente');
                
                // Actualizar la interfaz - recargar contenido de promociones si está visible
                const promotionsContent = document.getElementById('promotions-tab-content');
                if (promotionsContent && promotionsContent.style.display !== 'none') {
                    loadHotelPromotionsContent();
                } else {
                showHotelPromotions();
                }
            }
        }
        
        // Función para probar la sincronización de cotizaciones
        function testQuotesSync() {
            console.log('🧪 Probando sincronización de cotizaciones...');
            
            // Crear una cotización de prueba
            const testQuote = {
                id: `TEST-${Date.now()}`,
                hotel: 'Hotel de Prueba',
                clientName: 'Usuario de Prueba',
                dateRange: '15/12/2025 - 18/12/2025',
                travelers: '2 adultos • 1 niño',
                status: 'pending',
                timestamp: new Date().toLocaleString('es-ES'),
                checkIn: '2025-12-15',
                checkOut: '2025-12-18',
                adults: 2,
                children: 1,
                childrenAges: [8]
            };
            
            // Agregar a localStorage
            const existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            existingQuotes.push(testQuote);
            localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
            
            // Disparar evento
            window.dispatchEvent(new CustomEvent('quotesDBChanged'));
            
            console.log('✅ Cotización de prueba agregada');
            alert('✅ Cotización de prueba agregada. Verifica que aparezca en la tabla.');
        }
        
        // Función para sincronizar cotizaciones desde index.html
        function syncQuotesFromIndex() {
            console.log('🔄 Sincronizando cotizaciones desde index.html...');
            
            // Escuchar cambios en localStorage de cotizaciones (desde otras pestañas)
            window.addEventListener('storage', function(e) {
                if (e.key === 'quotesDB') {
                    console.log('📋 Cambio detectado en quotesDB desde otra pestaña, actualizando...');
                    loadQuotesTable();
                    updateQuotesStats();
                }
            });
            
            // Escuchar eventos personalizados (desde la misma pestaña)
            window.addEventListener('quotesDBChanged', function() {
                console.log('📋 Evento local detectado, actualizando...');
                loadQuotesTable();
                updateQuotesStats();
            });
            
            // También verificar cambios periódicamente (como respaldo)
            setInterval(function() {
                const currentQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                if (window.lastQuotesCount === undefined) {
                    window.lastQuotesCount = currentQuotes.length;
                } else if (window.lastQuotesCount !== currentQuotes.length) {
                    console.log('📋 Cambio detectado en quotesDB (verificación periódica), actualizando...');
                    window.lastQuotesCount = currentQuotes.length;
                    loadQuotesTable();
                    updateQuotesStats();
                }
            }, 2000); // Verificar cada 2 segundos
        }

        // Función para inicializar base de datos de hoteles
        async function initHotelsDB() {
            console.log('🏨 Inicializando base de datos de hoteles...');
            
            // Intentar cargar desde Supabase primero
            let existingHotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando hoteles desde Supabase...');
                    existingHotels = await window.supabaseClient.getHotels();
                    console.log(`📊 Estado inicial: ${existingHotels.length} hoteles en Supabase`);
                    
                    // Sincronizar con localStorage
                    if (existingHotels.length > 0) {
                        localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                    }
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            console.log(`📊 Estado inicial: ${existingHotels.length} hoteles`);
            
            if (existingHotels.length > 0) {
                console.log('📋 Hoteles existentes:', existingHotels.map(h => h.name));
            }
            
            // Forzar la carga de hoteles por defecto si no hay suficientes
            if (existingHotels.length < 6) {
                console.log(`🆕 Solo hay ${existingHotels.length} hoteles, agregando hoteles por defecto...`);
                
                // Limpiar localStorage para asegurar una carga limpia
                localStorage.removeItem('hotelsDB');
                
                // Hoteles por defecto basados en index.html
                const defaultHotels = [
                    {
                        id: 'hotel-termas-chillan',
                        name: 'Hotel Termas Chillán',
                        location: 'Chillán, Ñuble, Chile',
                        description: 'Termas y Spa en la cordillera de Chillán',
                        rating: 4.3,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Termas', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Carriel Sur',
                            code: 'CCP',
                            distance: '85 km',
                            city: 'Concepción'
                        },
                        borderCrossing: {
                            name: 'Paso Pehuenche',
                            distance: '120 km',
                            route: 'Ruta CH-115'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -36.6064, lng: -71.2167 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Termas+Chillán,+Chillán,+Ñuble,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-puyehue',
                        name: 'Hotel Terma de Puyehue',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Termas y Spa de lujo en la Patagonia',
                        rating: 4.5,
                        price: '$200',
                        status: 'Activo',
                        amenities: ['Piscina', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '45 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '45 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.683222, lng: -72.274986 },
                        googleMaps: 'https://maps.google.com/?q=Termas+de+Puyehue,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-huilo-huilo',
                        name: 'Hotel Huilo-Huilo',
                        location: 'Panguipulli, Los Ríos, Chile',
                        description: 'Inmersión en el bosque nativo',
                        rating: 4.2,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Naturaleza', 'Trekking', 'Aves', 'Restaurante', 'WiFi'],
                        badge: 'Bosque',
                        airport: {
                            name: 'Aeropuerto Pucón',
                            code: 'ZPC',
                            distance: '45 km',
                            city: 'Pucón'
                        },
                        borderCrossing: {
                            name: 'Paso Mamuil Malal',
                            distance: '85 km',
                            route: 'Ruta CH-199'
                        },
                        image: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -39.8500, lng: -72.0000 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Huilo-Huilo,+Panguipulli,+Los+Ríos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-corralco',
                        name: 'Hotel Corralco Resort',
                        location: 'Lonquimay, La Araucanía, Chile',
                        description: 'Esquí y aventura en la montaña',
                        rating: 4.7,
                        price: '$240',
                        status: 'Activo',
                        amenities: ['Esquí', 'Montaña', 'Chimenea', 'Restaurante', 'WiFi'],
                        badge: 'Esquí',
                        airport: {
                            name: 'Aeropuerto La Araucanía',
                            code: 'ZCO',
                            distance: '65 km',
                            city: 'Temuco'
                        },
                        borderCrossing: {
                            name: 'Paso Icalma',
                            distance: '95 km',
                            route: 'Ruta CH-181'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -38.6500, lng: -71.6500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Corralco+Resort,+Lonquimay,+La+Araucanía,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-futangue',
                        name: 'Hotel Futangue',
                        location: 'Lago Ranco, Los Ríos, Chile',
                        description: 'Lujo y naturaleza en su máxima expresión',
                        rating: 5.0,
                        price: '$330',
                        status: 'Activo',
                        amenities: ['5 Estrellas', 'Vinos', 'Piscina', 'Spa', 'Restaurante'],
                        badge: 'Lujo',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '75 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '110 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.3500, lng: -72.4500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Futangue,+Lago+Ranco,+Los+Ríos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'cabanas-aguas-calientes',
                        name: 'Cabañas Termas de Aguas Calientes',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Aguas Calientes - Experiencia única',
                        rating: 4.0,
                        price: '$110',
                        status: 'Activo',
                        amenities: ['Cabañas', 'Termas', 'Naturaleza', 'WiFi', 'Estacionamiento'],
                        badge: 'Cabañas',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '25 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '35 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.735366, lng: -72.307616 },
                        googleMaps: 'https://maps.google.com/?q=Termas+Aguas+Calientes,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // Guardar hoteles por defecto en localStorage
                localStorage.setItem('hotelsDB', JSON.stringify(defaultHotels));
                
                console.log(`✅ ${defaultHotels.length} hoteles por defecto agregados a la base de datos`);
                console.log('📋 Hoteles agregados:', defaultHotels.map(h => h.name));
                
                // Verificar que se guardaron correctamente
                const savedHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                console.log(`🔍 Verificación: ${savedHotels.length} hoteles guardados en localStorage`);
                console.log('🔍 Hoteles guardados:', savedHotels.map(h => h.name));
                
                // Notificar a index.html sobre el cambio
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'hotelsDB',
                    newValue: JSON.stringify(defaultHotels),
                    oldValue: '[]'
                }));
                
            } else {
                console.log(`ℹ️ Ya existen ${existingHotels.length} hoteles en la base de datos`);
            }
            
            // Mostrar estado final
            showHotelsStatus();
        }

        // Función para mostrar estado actual de hoteles
        function showHotelsStatus() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            console.log('🏨 ESTADO ACTUAL DE HOTELES EN DASHBOARD:');
            console.log(`📊 Total de hoteles: ${hotels.length}`);
            console.log('📋 Lista de hoteles:');
            hotels.forEach((hotel, index) => {
                console.log(`   ${index + 1}. ${hotel.name} (${hotel.location})`);
            });
            
            if (hotels.length === 0) {
                console.log('⚠️ No hay hoteles en localStorage');
            } else if (hotels.length < 6) {
                console.log(`⚠️ Solo hay ${hotels.length} hoteles, deberían ser 6`);
            } else {
                console.log('✅ Todos los hoteles están cargados correctamente');
            }
        }
        
        // Función para guardar base de datos de hoteles
        function saveHotelsDB() {
            // Implementar guardado
            console.log('Guardando base de datos de hoteles...');
        }

        // Función para agregar nuevo hotel
        function addNewHotel() {
            console.log('🆕 Abriendo formulario para agregar nuevo hotel...');
            
            // Verificar si el modal existe
            const modal = document.getElementById('editHotelModal');
            if (!modal) {
                console.error('❌ Modal no encontrado');
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            console.log('✅ Modal encontrado, procediendo...');
            
            // Limpiar el formulario
            const form = document.getElementById('editHotelForm');
            if (form) {
                form.reset();
                console.log('✅ Formulario reseteado');
            } else {
                console.error('❌ Formulario no encontrado');
            }
            
            // Limpiar campos específicos
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const ratingInput = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            
            console.log('Campos encontrados:', {
                nameInput: !!nameInput,
                locationInput: !!locationInput,
                ratingInput: !!ratingInput,
                priceInput: !!priceInput,
                descriptionTextarea: !!descriptionTextarea,
                amenitiesInput: !!amenitiesInput,
                statusSelect: !!statusSelect
            });
            
            if (nameInput) nameInput.value = '';
            if (locationInput) locationInput.value = '';
            if (ratingInput) ratingInput.value = '';
            if (priceInput) priceInput.value = '';
            if (descriptionTextarea) descriptionTextarea.value = '';
            if (amenitiesInput) amenitiesInput.value = '';
            if (statusSelect) statusSelect.value = 'Activo';
            
            // Cambiar el título del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = '🏨 Agregar Nuevo Hotel';
                console.log('✅ Título del modal actualizado');
            } else {
                console.error('❌ Título del modal no encontrado');
            }
            
            // ELIMINAR CAMPOS DE IMAGEN SI APARECEN (debido a caché del navegador)
            setTimeout(function() {
                // Buscar y eliminar campo de Imagen Principal
                var imageField = document.getElementById('editHotelImage');
                if (imageField) {
                    var formGroup = imageField.closest('.form-group');
                    if (formGroup) {
                        formGroup.remove();
                        console.log('✅ Campo editHotelImage eliminado');
                    }
                }
                
                // Buscar y eliminar campo de Galería de Fotos
                var photosField = document.getElementById('editHotelPhotos');
                if (photosField) {
                    var formGroup = photosField.closest('.form-group');
                    if (formGroup) {
                        formGroup.remove();
                        console.log('✅ Campo editHotelPhotos eliminado');
                    }
                }
                
                // Buscar y eliminar cualquier label que diga "Imagen Principal"
                var labels = document.querySelectorAll('#editHotelModal .form-label');
                labels.forEach(function(label) {
                    if (label.textContent && label.textContent.includes('Imagen Principal')) {
                        var formGroup = label.closest('.form-group');
                        if (formGroup) {
                            formGroup.remove();
                            console.log('✅ Campo "Imagen Principal" eliminado por label');
                        }
                    }
                });
                
                // Buscar y eliminar cualquier label que diga "Galería de Fotos"
                labels.forEach(function(label) {
                    if (label.textContent && label.textContent.includes('Galería de Fotos')) {
                        var formGroup = label.closest('.form-group');
                        if (formGroup) {
                            formGroup.remove();
                            console.log('✅ Campo "Galería de Fotos" eliminado por label');
                        }
                    }
                });
            }, 50);
            
            // Mostrar el modal
            modal.style.display = 'block';
            console.log('✅ Modal mostrado');
            
            // Configurar el formulario para modo "agregar"
            if (form) {
                form.dataset.mode = 'add';
                form.dataset.hotelId = null;
                console.log('✅ Formulario configurado para modo agregar');
            }
            
            console.log('✅ Función addNewHotel completada');
        }

        // Función para actualizar hotel
        function updateHotel(hotelId, updatedData) {
            // Implementar actualización
            console.log('Actualizando hotel:', hotelId);
        }

        // Función para eliminar hotel
        function deleteHotel(hotelId) {
            console.log('🗑️ Eliminando hotel:', hotelId);
            
            if (!confirm('¿Estás seguro de que quieres eliminar este hotel? Esta acción no se puede deshacer.')) {
                return;
            }
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotelIndex = hotels.findIndex(h => h.id === hotelId);
            
            if (hotelIndex === -1) {
                console.error('❌ Hotel no encontrado:', hotelId);
                alert('❌ Hotel no encontrado');
                return;
            }
            
            const deletedHotel = hotels[hotelIndex];
            hotels.splice(hotelIndex, 1);
            
            localStorage.setItem('hotelsDB', JSON.stringify(hotels));
            
            console.log('✅ Hotel eliminado correctamente:', deletedHotel.name);
            alert(`✅ Hotel "${deletedHotel.name}" eliminado correctamente`);
            
            // Notificar a index.html sobre el cambio
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'hotelsDB',
                newValue: JSON.stringify(hotels),
                oldValue: JSON.stringify([...hotels, deletedHotel])
            }));
            
            // Actualizar la tabla y estadísticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
        }

        // Función para obtener hotel por ID
        function getHotelById(hotelId) {
            // Implementar obtención
            console.log('Obteniendo hotel:', hotelId);
            return null;
        }

        // Función para cargar tabla de hoteles (versión actualizada con Supabase)
        async function loadHotelsTable() {
            console.log('📋 Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('❌ Tabla de hoteles no encontrada');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`✅ ${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('💾 Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            tbody.innerHTML = '';
            
            if (hotels.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-icons" style="font-size: 48px; color: #ddd;"></i>
                                <p>No hay hoteles registrados</p>
                                <button onclick="addNewHotel()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
                                    Agregar Primer Hotel
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price ? `$${hotel.price.toLocaleString()}` : 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status.toLowerCase().replace(' ', '-')}">${hotel.status}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <span class="material-icons">delete</span>
                        </button>
                        <button onclick="viewHotelDetails('${hotel.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla actualizada con ${hotels.length} hoteles`);
        }

        // Función para actualizar estadísticas de hoteles
        function updateHotelsStats() {
            console.log('📊 Actualizando estadísticas de hoteles...');
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Actualizar contadores
            const totalHotelsElement = document.getElementById('totalHotels');
            const avgRatingElement = document.getElementById('avgRating');
            const totalLocationsElement = document.getElementById('totalLocations');
            const priceRangeElement = document.getElementById('priceRange');
            
            if (totalHotelsElement) {
                totalHotelsElement.textContent = hotels.length;
            }
            
            if (avgRatingElement) {
                if (hotels.length > 0) {
                    const totalRating = hotels.reduce((sum, hotel) => sum + hotel.rating, 0);
                    const averageRating = (totalRating / hotels.length).toFixed(1);
                    avgRatingElement.textContent = averageRating;
                } else {
                    avgRatingElement.textContent = '0.0';
                }
            }
            
            if (totalLocationsElement) {
                const uniqueLocations = new Set(hotels.map(hotel => hotel.location));
                totalLocationsElement.textContent = uniqueLocations.size;
            }
            
            if (priceRangeElement) {
                if (hotels.length > 0) {
                    const prices = hotels.filter(hotel => hotel.price > 0).map(hotel => hotel.price);
                    if (prices.length > 0) {
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        priceRangeElement.textContent = `$${minPrice.toLocaleString()}-$${maxPrice.toLocaleString()}`;
                    } else {
                        priceRangeElement.textContent = '$0-$0';
                    }
                } else {
                    priceRangeElement.textContent = '$0-$0';
                }
            }
            
            console.log(`✅ Estadísticas actualizadas: ${hotels.length} hoteles`);
            
            // Actualizar estadísticas del dashboard si está visible
            if (currentSection === 'dashboard' && typeof updateStats === 'function') {
                updateStats();
            }
        }

        // Función para ver detalles del hotel
        function viewHotel(hotelId) {
            console.log('👁️ Viendo detalles del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                console.error('❌ Hotel no encontrado:', hotelId);
                alert('❌ Hotel no encontrado');
                return;
            }
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">🏨 ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>📍 Ubicación:</strong> ${hotel.location}</p>
                        <p><strong>⭐ Calificación:</strong> ${hotel.rating}</p>
                        <p><strong>💰 Precio:</strong> ${hotel.price || 'No especificado'}</p>
                        <p><strong>📋 Estado:</strong> ${hotel.status}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>📝 Descripción:</strong></p>
                        <p>${hotel.description || 'Sin descripción'}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>🎯 Amenities:</strong></p>
                        <p>${Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : 'No especificadas'}</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ✏️ Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Función para editar hotel
        function editHotel(hotelId) {
            console.log('✏️ Editando hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                console.error('❌ Hotel no encontrado:', hotelId);
                alert('❌ Hotel no encontrado');
                return;
            }
            
            // Llenar el formulario con los datos del hotel
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            if (nameInput) nameInput.value = hotel.name || '';
            if (locationInput) locationInput.value = hotel.location || '';
            if (googleMapsInput) {
                googleMapsInput.value = hotel.googleMaps || '';
                // Mostrar coordenadas extraídas si están disponibles
                if (hotel.googleMaps) {
                    const extractedCoords = extractCoordinatesFromGoogleMaps(hotel.googleMaps);
                    if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                        console.log(`📍 Coordenadas extraídas de Google Maps para ${hotel.name}:`, extractedCoords);
                        // Agregar un indicador visual de coordenadas extraídas
                        const coordInfo = document.createElement('div');
                        coordInfo.style.cssText = 'margin-top: 5px; font-size: 0.85rem; color: #28a745; font-weight: 600;';
                        coordInfo.innerHTML = `✅ Coordenadas extraídas: ${extractedCoords.lat.toFixed(4)}, ${extractedCoords.lng.toFixed(4)}`;
                        googleMapsInput.parentNode.appendChild(coordInfo);
                    } else if (extractedCoords && extractedCoords.modernUrl) {
                        console.log(`🌐 URL moderna de Google Maps para ${hotel.name}`);
                        // Agregar un indicador visual para URLs modernas
                        const coordInfo = document.createElement('div');
                        coordInfo.style.cssText = 'margin-top: 5px; font-size: 0.85rem; color: #ff9800; font-weight: 600;';
                        coordInfo.innerHTML = `🌐 URL moderna detectada - Coordenadas se extraerán automáticamente`;
                        googleMapsInput.parentNode.appendChild(coordInfo);
                    }
                }
            }
            if (ratingSelect) ratingSelect.value = hotel.rating || '0';
            if (priceInput) priceInput.value = hotel.price || '';
            if (descriptionTextarea) descriptionTextarea.value = hotel.description || '';
            if (amenitiesInput) amenitiesInput.value = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : '';
            if (statusSelect) statusSelect.value = hotel.status || 'Activo';
            // NOTA: Campo imagesInput eliminado - ya no se usa
            
            // Cambiar el título del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = '🏨 Editar Hotel';
            }
            
            // Guardar hotelId globalmente para acceso desde el gestor de imágenes
            globalEditingHotelId = hotelId;
            console.log('✅ HotelId guardado globalmente:', globalEditingHotelId);
            
            // Mostrar el modal
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                // ELIMINAR CAMPOS DE IMAGEN SI APARECEN (debido a caché del navegador)
                setTimeout(function() {
                    // Buscar y eliminar campo de Imagen Principal
                    var imageField = document.getElementById('editHotelImage');
                    if (imageField) {
                        var formGroup = imageField.closest('.form-group');
                        if (formGroup) {
                            formGroup.remove();
                            console.log('✅ Campo editHotelImage eliminado');
                        }
                    }
                    
                    // Buscar y eliminar campo de Galería de Fotos
                    var photosField = document.getElementById('editHotelPhotos');
                    if (photosField) {
                        var formGroup = photosField.closest('.form-group');
                        if (formGroup) {
                            formGroup.remove();
                            console.log('✅ Campo editHotelPhotos eliminado');
                        }
                    }
                    
                    // Buscar y eliminar cualquier label que diga "Imagen Principal"
                    var labels = document.querySelectorAll('#editHotelModal .form-label');
                    labels.forEach(function(label) {
                        if (label.textContent && label.textContent.includes('Imagen Principal')) {
                            var formGroup = label.closest('.form-group');
                            if (formGroup) {
                                formGroup.remove();
                                console.log('✅ Campo "Imagen Principal" eliminado por label');
                            }
                        }
                    });
                    
                    // Buscar y eliminar cualquier label que diga "Galería de Fotos"
                    labels.forEach(function(label) {
                        if (label.textContent && label.textContent.includes('Galería de Fotos')) {
                            var formGroup = label.closest('.form-group');
                            if (formGroup) {
                                formGroup.remove();
                                console.log('✅ Campo "Galería de Fotos" eliminado por label');
                            }
                        }
                    });
                }, 50);
                
                modal.style.display = 'block';
                
                // Configurar el formulario para modo "editar"
                const form = document.getElementById('editHotelForm');
                if (form) {
                    form.dataset.mode = 'edit';
                    form.dataset.hotelId = hotelId;
                    console.log('✅ Formulario configurado - modo: edit, hotelId:', hotelId);
                    console.log('✅ Dataset del formulario:', {
                        mode: form.dataset.mode,
                        hotelId: form.dataset.hotelId
                    });
                }
                
                // NOTA: Código de configuración de botones de imágenes eliminado - los campos fueron removidos
            }
        }

        // Función para exportar hoteles
        function exportHotels() {
            // Implementar exportación
            console.log('Exportando hoteles...');
        }

        // Función para refrescar hoteles
        function refreshHotels() {
            // Implementar refresco
            console.log('Refrescando hoteles...');
        }

        // Función para abrir modal de edición de hotel
        function openEditHotelModal(hotel) {
            // Implementar apertura de modal
            console.log('Abriendo modal de edición:', hotel);
        }

        // Función para cerrar modal de edición de hotel
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para obtener coordenadas por defecto según el nombre del hotel
        function getDefaultCoordinatesForHotel(hotelName) {
            const coordinatesMap = {
                'Hotel Termas Chillán': { lat: -36.6064, lng: -71.2167 },
                'Hotel Terma de Puyehue': { lat: -40.6500, lng: -72.6167 },
                'Hotel Huilo-Huilo': { lat: -39.8500, lng: -71.9000 },
                'Hotel Corralco Resort': { lat: -38.6500, lng: -71.6500 },
                'Hotel Futangue': { lat: -40.3500, lng: -72.4500 },
                'Cabañas Termas de Aguas Calientes': { lat: -40.735366, lng: -72.307616 }
            };
            
            return coordinatesMap[hotelName] || null;
        }
        
        // Función para extraer coordenadas de URL de Google Maps
        function extractCoordinatesFromGoogleMaps(url) {
            if (!url) return null;
            
            try {
                // Patrón 1: URL con coordenadas directas
                // https://maps.google.com/?q=-36.6064,-71.2167
                const coordPattern1 = /q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match1 = url.match(coordPattern1);
                if (match1) {
                    return {
                        lat: parseFloat(match1[1]),
                        lng: parseFloat(match1[2])
                    };
                }
                
                // Patrón 2: URL con coordenadas en formato @lat,lng
                // https://maps.google.com/?q=Hotel+Termas+Chillán@-36.6064,-71.2167
                const coordPattern2 = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match2 = url.match(coordPattern2);
                if (match2) {
                    return {
                        lat: parseFloat(match2[1]),
                        lng: parseFloat(match2[2])
                    };
                }
                
                // Patrón 3: URL con coordenadas en formato ll=lat,lng
                // https://maps.google.com/?ll=-36.6064,-71.2167
                const coordPattern3 = /ll=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match3 = url.match(coordPattern3);
                if (match3) {
                    return {
                        lat: parseFloat(match3[1]),
                        lng: parseFloat(match3[2])
                    };
                }
                
                // Patrón 4: URLs modernas de Google Maps (maps.app.goo.gl)
                // https://maps.app.goo.gl/cxC7gREKNFuoiuj4A
                if (url.includes('maps.app.goo.gl') || url.includes('goo.gl/maps')) {
                    console.log('🌐 URL moderna de Google Maps detectada, intentando obtener coordenadas...');
                    
                    // Para URLs modernas, necesitamos hacer una petición HTTP para obtener las coordenadas
                    // Por ahora, mostraremos un mensaje informativo
                    return {
                        lat: null,
                        lng: null,
                        modernUrl: true,
                        message: 'URL moderna de Google Maps detectada. Las coordenadas se extraerán automáticamente cuando se guarde el hotel.'
                    };
                }
                
                // Patrón 5: URLs con coordenadas en formato decimal
                // https://maps.google.com/?q=-36.6064,-71.2167&z=15
                const coordPattern5 = /[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match5 = url.match(coordPattern5);
                if (match5) {
                    return {
                        lat: parseFloat(match5[1]),
                        lng: parseFloat(match5[2])
                    };
                }
                
                console.log('⚠️ No se pudieron extraer coordenadas de la URL:', url);
                return null;
            } catch (error) {
                console.error('❌ Error al extraer coordenadas:', error);
                return null;
            }
        }
        
        // Función para mostrar ayuda de Google Maps
        function openGoogleMapsHelp() {
            const helpText = `
🌍 <strong>¿Cómo obtener el enlace de Google Maps?</strong>

1. <strong>Busca el hotel</strong> en Google Maps
2. <strong>Haz clic en "Compartir"</strong> (botón azul)
3. <strong>Selecciona "Copiar enlace"</strong>
4. <strong>Pega el enlace</strong> en el campo de arriba

<strong>Formatos de URL soportados:</strong>

✅ <strong>URL con coordenadas directas:</strong>
https://maps.google.com/?q=-36.6064,-71.2167

✅ <strong>URL con nombre del hotel:</strong>
https://maps.google.com/?q=Hotel+Termas+Chillán

✅ <strong>URL moderna (maps.app.goo.gl):</strong>
https://maps.app.goo.gl/cxC7gREKNFuoiuj4A

<strong>💡 Coordenadas se extraerán automáticamente para el mapa interactivo!</strong>

<strong>⚠️ Nota:</strong> Las URLs modernas se procesarán automáticamente al guardar el hotel.
            `;
            
            alert(helpText);
        }
        
        // Función para probar extracción de coordenadas
        function testCoordinatesExtraction() {
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            if (!googleMapsInput || !googleMapsInput.value) {
                alert('⚠️ Por favor ingresa una URL de Google Maps primero');
                return;
            }
            
            const url = googleMapsInput.value.trim();
            const extractedCoords = extractCoordinatesFromGoogleMaps(url);
            
            if (extractedCoords && extractedCoords.modernUrl) {
                alert(`🌐 URL moderna de Google Maps detectada:\n\n${url}\n\n✅ Esta URL será guardada y las coordenadas se extraerán automáticamente cuando se guarde el hotel.\n\n💡 Tip: Para obtener coordenadas inmediatas, usa el formato:\nhttps://maps.google.com/?q=-36.6064,-71.2167`);
            } else if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                alert(`✅ Coordenadas extraídas exitosamente:\n\nLatitud: ${extractedCoords.lat}\nLongitud: ${extractedCoords.lng}\n\nEstas coordenadas se usarán automáticamente en el mapa interactivo.`);
            } else {
                alert(`❌ No se pudieron extraer coordenadas de la URL:\n\n${url}\n\n💡 Sugerencias:\n1. Usa el formato: https://maps.google.com/?q=-36.6064,-71.2167\n2. O busca el hotel en Google Maps y copia el enlace completo\n3. Para URLs modernas, las coordenadas se extraerán automáticamente al guardar.`);
            }
        }

        // Función para guardar cambios del hotel
        async function saveHotelChanges() {
            console.log('💾 Guardando cambios del hotel...');
            
            const form = document.getElementById('editHotelForm');
            if (!form) {
                console.error('❌ Formulario no encontrado');
                return;
            }
            
            // Obtener datos del formulario
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            if (!nameInput || !locationInput) {
                console.error('❌ Campos requeridos no encontrados');
                return;
            }
            
            // Obtener imágenes del formulario (pueden ser base64 o URLs)
            const imageInput = document.getElementById('editHotelImage');
            const photosInput = document.getElementById('editHotelPhotos');
            const mainImage = imageInput?.value?.trim() || '';
            const galleryImages = photosInput?.value ? photosInput.value.split(',').map(img => img.trim()).filter(img => img) : [];
            
            const hotelData = {
                name: nameInput.value.trim(),
                location: locationInput.value.trim(),
                googleMaps: googleMapsInput?.value?.trim() || '',
                rating: parseInt(ratingSelect?.value || '0'),
                price: priceInput?.value ? parseInt(priceInput.value) : 0,
                description: descriptionTextarea?.value || '',
                amenities: amenitiesInput?.value ? amenitiesInput.value.split(',').map(a => a.trim()) : [],
                status: statusSelect?.value || 'Activo',
                mainImage: mainImage, // Imagen principal (base64 o URL)
                galleryImages: galleryImages, // Galería de fotos (array de base64 o URLs)
                images: mainImage ? [mainImage, ...galleryImages] : galleryImages // Compatibilidad con versiones anteriores
            };
            
            // Extraer coordenadas de Google Maps si está disponible
            if (hotelData.googleMaps) {
                const extractedCoords = extractCoordinatesFromGoogleMaps(hotelData.googleMaps);
                if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                    hotelData.coordinates = extractedCoords;
                    console.log(`✅ Coordenadas extraídas de Google Maps para ${hotelData.name}:`, extractedCoords);
                } else if (extractedCoords && extractedCoords.modernUrl) {
                    console.log(`🌐 URL moderna de Google Maps guardada para ${hotelData.name}. Las coordenadas se extraerán automáticamente.`);
                    // Para URLs modernas, usamos coordenadas por defecto temporalmente
                    const defaultCoords = getDefaultCoordinatesForHotel(hotelData.name);
                    if (defaultCoords) {
                        hotelData.coordinates = defaultCoords;
                        console.log(`📍 Usando coordenadas por defecto para ${hotelData.name}:`, defaultCoords);
                    }
                }
            }
            
            // Validar campos requeridos
            if (!hotelData.name || !hotelData.location) {
                alert('❌ Por favor completa los campos requeridos (Nombre y Ubicación)');
                return;
            }
            
            const mode = form.dataset.mode;
            const hotelId = form.dataset.hotelId;
            
            if (mode === 'add') {
                // Agregar nuevo hotel
                try {
                    // Preparar datos para Supabase
                    const hotelForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description,
                        rating: hotelData.rating,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status,
                        amenities: hotelData.amenities,
                        mainImage: hotelData.mainImage || '',
                        galleryImages: hotelData.galleryImages || [],
                        images: hotelData.images || [], // Compatibilidad
                        coordinates: hotelData.coordinates,
                        google_maps: hotelData.googleMaps
                    };

                    // Intentar guardar en Supabase primero
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            const savedHotel = await window.supabaseClient.createHotel(hotelForSupabase);
                            console.log('✅ Hotel guardado en Supabase:', savedHotel);
                            alert('✅ Hotel agregado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('⚠️ Error guardando en Supabase, guardando en localStorage:', error);
                            // Fallback a localStorage
                const newHotel = {
                                id: Date.now().toString(),
                    ...hotelData,
                    createdAt: new Date().toISOString()
                };
                const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                existingHotels.push(newHotel);
                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                            alert('✅ Hotel agregado correctamente (guardado localmente)');
                        }
                    } else {
                        // Solo localStorage si Supabase no está disponible
                        const newHotel = {
                            id: Date.now().toString(),
                            ...hotelData,
                            createdAt: new Date().toISOString()
                        };
                        const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        existingHotels.push(newHotel);
                        localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                        alert('✅ Hotel agregado correctamente (guardado localmente)');
                    }
                } catch (error) {
                    console.error('❌ Error guardando hotel:', error);
                    alert('❌ Error al guardar el hotel');
                }
                
            } else {
                // Editar hotel existente
                if (!hotelId) {
                    console.error('❌ ID de hotel no encontrado para edición');
                    return;
                }
                
                try {
                    // Preparar datos para Supabase
                    const updatesForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description,
                        rating: hotelData.rating,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status,
                        amenities: hotelData.amenities,
                        mainImage: hotelData.mainImage || '',
                        galleryImages: hotelData.galleryImages || [],
                        images: hotelData.images || [], // Compatibilidad
                        coordinates: hotelData.coordinates,
                        google_maps: hotelData.googleMaps
                    };

                    // Intentar actualizar en Supabase primero
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            await window.supabaseClient.updateHotel(hotelId, updatesForSupabase);
                            console.log('✅ Hotel actualizado en Supabase');
                            alert('✅ Hotel actualizado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('⚠️ Error actualizando en Supabase, actualizando en localStorage:', error);
                            // Fallback a localStorage
                const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                if (hotelIndex !== -1) {
                    existingHotels[hotelIndex] = {
                        ...existingHotels[hotelIndex],
                        ...hotelData,
                        updatedAt: new Date().toISOString()
                    };
                    localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                alert('✅ Hotel actualizado correctamente (guardado localmente)');
                            }
                        }
                    } else {
                        // Solo localStorage si Supabase no está disponible
                        const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                        if (hotelIndex !== -1) {
                            existingHotels[hotelIndex] = {
                                ...existingHotels[hotelIndex],
                                ...hotelData,
                                updatedAt: new Date().toISOString()
                            };
                            localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                            alert('✅ Hotel actualizado correctamente (guardado localmente)');
                } else {
                    console.error('❌ Hotel no encontrado para editar');
                    alert('❌ Error: Hotel no encontrado');
                        }
                    }
                } catch (error) {
                    console.error('❌ Error actualizando hotel:', error);
                    alert('❌ Error al actualizar el hotel');
                }
            }
            
            // Cerrar modal
            closeEditHotelModal();
            
            // Actualizar tabla y estadísticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            
            // Notificar actualización del mapa interactivo
            console.log('🗺️ Notificando actualización del mapa interactivo...');
            window.dispatchEvent(new CustomEvent('hotelsMapUpdated', {
                detail: { 
                    hotelId: hotelId || newHotel?.id, 
                    coordinates: hotelData.coordinates,
                    hotelName: hotelData.name 
                }
            }));
            
            // Actualizar la tabla y estadísticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
        }

        // Función para abrir modal de vista previa de imágenes
        function openImagePreviewModal() {
            // Implementar apertura de modal
            console.log('Abriendo modal de vista previa...');
        }

        // Función para cerrar modal de vista previa de imágenes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para inicializar base de datos de clientes
        function initClientesDB() {
            // Implementar inicialización
            console.log('Inicializando base de datos de clientes...');
        }

        // Función para inicializar base de datos de hoteles (duplicada - eliminada)

        // Función para buscar cliente por email
        function buscarClientePorEmail(email) {
            // Implementar búsqueda
            console.log('Buscando cliente por email:', email);
            return null;
        }

        // Función para validar email
        function validarEmail(email) {
            // Implementar validación
            console.log('Validando email:', email);
            return true;
        }

        // Función de logout (reemplazada por la nueva implementación arriba)

        // Función para actualizar dashboard para usuario logueado
        function updateDashboardForLoggedInUser() {
            // Implementar actualización
            console.log('Actualizando dashboard para usuario logueado...');
        }

        // Función para cargar contenido del dashboard
        function loadDashboardContent() {
            // Implementar carga de contenido
            console.log('Cargando contenido del dashboard...');
        }

        // Función para restaurar secciones del dashboard
        function restoreDashboardSections() {
            // Implementar restauración
            console.log('Restaurando secciones del dashboard...');
        }

        // Función para actualizar dashboard para usuario deslogueado
        function updateDashboardForLoggedOutUser() {
            // Implementar actualización
            console.log('Actualizando dashboard para usuario deslogueado...');
        }

        // Función para actualizar estadísticas personales
        function updatePersonalStats() {
            // Implementar estadísticas personales
            console.log('Actualizando estadísticas personales...');
        }

        // Función para mostrar pantalla de login
        function showLoginScreen() {
            // Implementar pantalla de login
            console.log('Mostrando pantalla de login...');
        }

        // Función para mostrar formulario de registro
        function showRegisterForm() {
            // Implementar formulario de registro
            console.log('Mostrando formulario de registro...');
        }

        // ============================================
        // SOBRESCRIBIR BOTONES DE IMAGENES - EVITA CACHE
        // ============================================
        function sobrescribirBotonesImagenes() {
            // Buscar todos los botones que abren el gestor de imágenes
            const buttons = document.querySelectorAll('button[onclick*="imageManager"], button[onclick*="abrirModal"], button[onclick*="openImage"]');
            
            buttons.forEach(function(btn) {
                // Verificar si el botón tiene el texto "Seleccionar" y un ícono folder_open
                const icon = btn.querySelector('.material-icons');
                if (icon && icon.textContent === 'folder_open') {
                    btn.onclick = function() {
                        console.log('🚀 Botón clickeado - Abriendo modal directamente');
                        var modal = document.getElementById('imageManagerModal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.style.zIndex = '99999';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                            console.log('✅ Modal abierto - Display:', modal.style.display);
                            
                            // Configurar nombre del hotel
                            var hotelNameSpan = document.getElementById('currentHotelName');
                            if (hotelNameSpan) {
                                var nameInput = document.getElementById('editHotelName');
                                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                            }
                        } else {
                            alert('ERROR: Modal no encontrado. Por favor, recarga la página.');
                        }
                    };
                    console.log('✅ Botón sobrescrito:', btn);
                }
            });
        }

        // Event listener para cuando el DOM esté listo
        // IMPORTANTE: Este código se ejecuta DESPUÉS de la verificación de autenticación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard DOMContentLoaded ejecutado');
            
            // Sobrescribir botones inmediatamente
            sobrescribirBotonesImagenes();
            
            // También sobrescribir después de un pequeño delay por si el HTML se carga después
            setTimeout(sobrescribirBotonesImagenes, 500);
            setTimeout(sobrescribirBotonesImagenes, 1000);
            setTimeout(sobrescribirBotonesImagenes, 2000);
            
            // CONFIGURAR EVENT LISTENERS DEL MODAL DE IMÁGENES
            setTimeout(function() {
                // Botón cerrar modal
                const btnClose = document.getElementById('btnCloseImageManager');
                if (btnClose) {
                    btnClose.onclick = closeImageManagerSimple;
                }
                
                // Botón cancelar
                const btnCancel = document.getElementById('btnCancelImageManager');
                if (btnCancel) {
                    btnCancel.onclick = closeImageManagerSimple;
                }
                
                // Botón subir imágenes
                const btnUpload = document.getElementById('btnUploadImages');
                if (btnUpload) {
                    btnUpload.onclick = uploadImagesSimple;
                }
                
                // Botón aplicar selección
                const btnApply = document.getElementById('btnApplyImageSelection');
                if (btnApply) {
                    btnApply.onclick = applyImageSelectionSimple;
                }
                
                // NOTA: Código de botones de imágenes eliminado - los campos fueron removidos
                
                console.log('✅ Event listeners del modal de imágenes configurados');
            }, 500);
            
            // Verificar si hay sesión válida
            const authSession = localStorage.getItem('dashboard_auth_session');
            let isAuthenticated = false;
            
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        isAuthenticated = true;
                    } else {
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    localStorage.removeItem('dashboard_auth_session');
                }
            }
            
            // Solo inicializar el dashboard si el usuario está autenticado
            if (isAuthenticated) {
                console.log('✅ Usuario autenticado, inicializando dashboard...');
            // Inicializar dashboard
                if (typeof initializeDashboard === 'function') {
            initializeDashboard();
                }
            
            // Configurar sincronización automática
                if (typeof setupAutoSync === 'function') {
            setupAutoSync();
                }
            
            console.log('✅ Dashboard inicializado correctamente');
            } else {
                console.log('🔒 Usuario no autenticado, NO inicializando dashboard');
                // Asegurar que el dashboard esté oculto
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                if (dashboardContent) dashboardContent.classList.remove('authenticated');
                if (loginContainer) loginContainer.classList.remove('hidden');
            }
        });

        // Función para configurar sincronización automática
        function setupAutoSync() {
            console.log('🔄 Configurando sincronización automática...');
            
            // Cargar datos iniciales
            loadUsersData();
            
            // Configurar listener para cambios en localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'checkin24hs_users') {
                    console.log('🔄 Cambio detectado en usuarios, actualizando dashboard...');
                    loadUsersData();
                }
            });
            
            // Sincronización automática cada 30 segundos
            setInterval(() => {
                console.log('🔄 Sincronización automática...');
                loadUsersData();
            }, 30000);
            
            console.log('✅ Sincronización automática configurada');
        }

        // Función para abrir base de datos de usuarios
        function openUserDatabase() {
            // Implementar apertura de base de datos
            console.log('Abriendo base de datos de usuarios...');
        }

        // Función para exportar usuarios
        // Función para exportar usuarios
        function exportUsers() {
            console.log('📤 Exportando usuarios...');
            
            try {
                // Cargar usuarios
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                
                if (users.length === 0) {
                    alert('❌ No hay usuarios para exportar');
                    return;
                }
                
                // Preparar datos para exportar
                const exportData = users.map(user => ({
                    nombre: user.name || '',
                    apellido: user.lastName || '',
                    email: user.email || '',
                    telefono: user.phone || '',
                    estado: user.status || 'active',
                    fecha_registro: user.createdAt || user.fechaRegistro || '',
                    tipo_cuenta: user.tipoCuenta || 'registrado'
                }));
                
                // Crear CSV
                const headers = ['nombre', 'apellido', 'email', 'telefono', 'estado', 'fecha_registro', 'tipo_cuenta'];
                let csv = headers.join(',') + '\n';
                
                exportData.forEach(user => {
                    const row = headers.map(header => {
                        const value = user[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    });
                    csv += row.join(',') + '\n';
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `usuarios_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`✅ ${users.length} usuarios exportados exitosamente`);
                
            } catch (error) {
                console.error('Error exportando usuarios:', error);
                alert('❌ Error al exportar usuarios: ' + error.message);
            }
        }

        // Función para refrescar usuarios
        function refreshUsers() {
            loadUsersData();
            alert('✅ Usuarios actualizados');
        }
        
        // Función para mostrar modal de importar usuarios
        function showImportUsersModal() {
            console.log('📥 Abriendo modal de importar usuarios...');
            
            const modal = document.getElementById('importUsersModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('importUsersForm').reset();
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileFormat').value = 'auto';
            
            // Agregar evento para vista previa
            const fileInput = document.getElementById('usersFile');
            fileInput.removeEventListener('change', previewImportFile);
            fileInput.addEventListener('change', previewImportFile);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar modal de importar usuarios
        function closeImportUsersModal() {
            const modal = document.getElementById('importUsersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para previsualizar archivo antes de importar
        function previewImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const format = document.getElementById('fileFormat').value;
                
                try {
                    let preview = '';
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        const data = JSON.parse(content);
                        const previewData = Array.isArray(data) ? data.slice(0, 3) : [data];
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${JSON.stringify(previewData, null, 2)}</pre>`;
                        if ((Array.isArray(data) ? data.length : 1) > 3) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y ${(Array.isArray(data) ? data.length : 1) - 3} más</p>`;
                        }
                    } else {
                        const lines = content.split('\n').slice(0, 5);
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${lines.join('\n')}</pre>`;
                        if (content.split('\n').length > 5) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y más líneas</p>`;
                        }
                    }
                    
                    document.getElementById('previewContent').innerHTML = preview;
                    document.getElementById('importPreview').style.display = 'block';
                } catch (error) {
                    console.error('Error en vista previa:', error);
                    document.getElementById('previewContent').innerHTML = `<p style="color: #dc3545;">Error al leer el archivo: ${error.message}</p>`;
                    document.getElementById('importPreview').style.display = 'block';
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Función para importar usuarios
        function importUsers(event) {
            event.preventDefault();
            console.log('📥 Importando usuarios...');
            
            const fileInput = document.getElementById('usersFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('❌ Por favor selecciona un archivo');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedUsers = [];
                    const content = e.target.result;
                    
                    // Parsear según el formato
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        importedUsers = JSON.parse(content);
                        if (!Array.isArray(importedUsers)) {
                            importedUsers = [importedUsers];
                        }
                    } else {
                        // Parsear CSV
                        importedUsers = parseCSV(content);
                    }
                    
                    if (importedUsers.length === 0) {
                        alert('❌ El archivo no contiene usuarios válidos');
                        return;
                    }
                    
                    // Procesar e importar usuarios
                    processImportedUsers(importedUsers);
                    
                } catch (error) {
                    console.error('Error importando usuarios:', error);
                    alert('❌ Error al procesar el archivo: ' + error.message);
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Función para parsear CSV
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            // Detectar delimitador
            const delimiter = csvContent.includes(';') ? ';' : ',';
            
            // Obtener headers
            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            
            // Parsear datos
            const users = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                if (values.length === 0 || values.every(v => !v)) continue;
                
                const user = {};
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    // Mapear headers comunes
                    if (header.includes('nombre') || header.includes('name')) {
                        user.name = value;
                    } else if (header.includes('email') || header.includes('correo')) {
                        user.email = value;
                    } else if (header.includes('telefono') || header.includes('phone') || header.includes('tel')) {
                        user.phone = value;
                    } else if (header.includes('apellido') || header.includes('lastname') || header.includes('surname')) {
                        user.lastName = value;
                    } else {
                        user[header] = value;
                    }
                });
                
                if (user.name || user.email || user.phone) {
                    users.push(user);
                }
            }
            
            return users;
        }
        
        // Función para procesar usuarios importados con validación de duplicados
        function processImportedUsers(importedUsers) {
            console.log('🔄 Procesando usuarios importados:', importedUsers.length);
            
            // Cargar usuarios existentes
            const existingUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            
            let added = 0;
            let skipped = 0;
            const errors = [];
            
            importedUsers.forEach((importedUser, index) => {
                try {
                    // Validar que tenga nombre y (email o teléfono)
                    if (!importedUser.name && !importedUser.nombre) {
                        errors.push(`Fila ${index + 1}: Falta el nombre`);
                        skipped++;
                        return;
                    }
                    
                    const name = importedUser.name || importedUser.nombre || '';
                    const email = (importedUser.email || importedUser.correo || '').toLowerCase().trim();
                    const phone = (importedUser.phone || importedUser.telefono || importedUser.tel || '').trim();
                    
                    if (!email && !phone) {
                        errors.push(`Fila ${index + 1}: Falta email y teléfono`);
                        skipped++;
                        return;
                    }
                    
                    // Buscar duplicados
                    let duplicate = null;
                    
                    if (email) {
                        // Buscar por email
                        duplicate = existingUsers.find(u => u.email && u.email.toLowerCase().trim() === email);
                        if (duplicate) {
                            console.log(`⚠️ Usuario con email ${email} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    if (!email && phone) {
                        // Si no hay email, buscar por teléfono
                        const cleanPhone = phone.replace(/\D/g, '');
                        duplicate = existingUsers.find(u => {
                            if (!u.phone) return false;
                            const existingPhone = u.phone.replace(/\D/g, '');
                            return existingPhone === cleanPhone;
                        });
                        
                        if (duplicate) {
                            console.log(`⚠️ Usuario con teléfono ${phone} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    // Crear nuevo usuario
                    const newUser = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: name,
                        email: email || null,
                        phone: phone || null,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        tipoCuenta: 'importado',
                        source: 'import'
                    };
                    
                    // Agregar apellido si existe
                    if (importedUser.lastName || importedUser.apellido) {
                        newUser.lastName = importedUser.lastName || importedUser.apellido;
                        newUser.name = `${name} ${newUser.lastName}`.trim();
                    }
                    
                    existingUsers.push(newUser);
                    added++;
                    
                } catch (error) {
                    console.error(`Error procesando usuario ${index + 1}:`, error);
                    errors.push(`Fila ${index + 1}: ${error.message}`);
                    skipped++;
                }
            });
            
            // Guardar usuarios actualizados
            localStorage.setItem('checkin24hs_users', JSON.stringify(existingUsers));
            
            // Mostrar resumen
            let message = `✅ Importación completada:\n\n`;
            message += `• Agregados: ${added}\n`;
            message += `• Omitidos (duplicados): ${skipped}\n`;
            if (errors.length > 0) {
                message += `• Errores: ${errors.length}\n\n`;
                message += `Errores:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) message += `\n... y ${errors.length - 5} más`;
            }
            
            alert(message);
            
            // Cerrar modal
            closeImportUsersModal();
            
            // Actualizar tabla
            loadUsersData();
            
            console.log(`✅ Importación: ${added} agregados, ${skipped} omitidos`);
        }

        // Función para crear usuario de prueba
        function createTestUser() {
            // Implementar creación de usuario de prueba
            console.log('Creando usuario de prueba...');
        }

        // Función para crear usuarios de prueba
        function crearUsuariosPrueba() {
            // Implementar creación de usuarios de prueba
            console.log('Creando usuarios de prueba...');
        }

        // Función para mostrar promociones de hoteles
        function showHotelPromotions() {
            console.log('🏨 Mostrando promociones de hoteles...');
            
            // Mostrar sección de hoteles y cambiar a pestaña de promociones
            window.showSection('hotels', null);
            setTimeout(() => {
                showHotelsTab('promotions');
            }, 100);
        }
        
        // Función para cambiar entre pestañas de Hoteles
        function showHotelsTab(tab) {
            console.log('🔄 Cambiando a pestaña:', tab);
            
            // Ocultar todos los contenidos de pestañas
            const hotelsContent = document.getElementById('hotels-tab-content');
            const promotionsContent = document.getElementById('promotions-tab-content');
            
            // Ocultar todos los botones activos
            const hotelsBtn = document.getElementById('hotels-tab-btn');
            const promotionsBtn = document.getElementById('promotions-tab-btn');
            
            if (tab === 'hotels') {
                if (hotelsContent) hotelsContent.style.display = 'block';
                if (promotionsContent) promotionsContent.style.display = 'none';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#1976d2';
                    hotelsBtn.style.color = 'white';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#f0f0f0';
                    promotionsBtn.style.color = '#333';
                }
            } else if (tab === 'promotions') {
                if (hotelsContent) hotelsContent.style.display = 'none';
                if (promotionsContent) promotionsContent.style.display = 'block';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#f0f0f0';
                    hotelsBtn.style.color = '#333';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#1976d2';
                    promotionsBtn.style.color = 'white';
                }
                
                // Cargar contenido de promociones
                loadHotelPromotionsContent();
            }
        }
        
        // Función para cargar el contenido de promociones dentro de la sección
        function loadHotelPromotionsContent() {
            const contentDiv = document.getElementById('hotel-promotions-content');
            if (!contentDiv) return;
            
            // Cargar datos de hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Generar el contenido de promociones (similar al modal pero sin el modal)
            contentDiv.innerHTML = `
                    <!-- Pestañas de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                    <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">🔥 Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">➕ Crear Promoción</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📈 Analytics</button>
                    </div>
                    
                    <!-- Contenido de pestañas -->
                    <div id="promotion-content">
                    <!-- Pestaña de Promociones Activas -->
                    <div id="active-tab" class="promotion-tab-content" style="display: block;">
                        <h3 style="margin-bottom: 16px; color: #333;">🔥 Promociones Activas</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${hotels.map(hotel => `
                                <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                        <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                    </div>
                                    <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                        <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ⭐</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">✏️ Editar</button>
                                        <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">👁️ Ver</button>
                                        <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">⏸️ Pausar</button>
                                    </div>
                                </div>
                            `).join('')}
                                </div>
                            </div>
                            
                    <!-- Pestaña de Crear Promoción -->
                    <div id="create-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">➕ Crear Nueva Promoción</h3>
                        
                        <form id="createPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                    <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Seleccionar hotel</option>
                                        ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                    </select>
                                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                    <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                    </select>
                                                </div>
                                                </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                    </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Estado</label>
                                    <select id="promotionStatus" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="active">Activa</option>
                                        <option value="paused">Pausada</option>
                                    </select>
                                        </div>
                                        </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción</label>
                                <textarea id="promotionDescription" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="showHotelsTab('hotels')" style="background: #f0f0f0; color: #333; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoción</button>
                                        </div>
                        </form>
                                        </div>
                                        
                    <!-- Pestaña de Historial -->
                    <div id="history-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">📊 Historial de Promociones</h3>
                        <p style="color: #666;">No hay historial de promociones disponibles.</p>
                                        </div>
                                        
                    <!-- Pestaña de Analytics -->
                    <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">📈 Analytics de Promociones</h3>
                        <p style="color: #666;">No hay datos de analytics disponibles.</p>
                                        </div>
                </div>
            `;
            
            // Agregar event listener al formulario
            const form = document.getElementById('createPromotionForm');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    savePromotion();
                };
            }
        }
        
        // Función para mostrar modal de promociones de hoteles
        function showHotelPromotionsModal(hotels) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">🏨 Promociones de Hoteles</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                            </div>
                            
                    <!-- Pestañas de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">🔥 Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">➕ Crear Promoción</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📈 Analytics</button>
                        </div>
                        
                    <!-- Contenido de pestañas -->
                    <div id="promotion-content">
                        <!-- Pestaña de Promociones Activas -->
                        <div id="active-tab" class="promotion-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">🔥 Promociones Activas</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                                ${hotels.map(hotel => `
                                    <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                            <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                        </div>
                                        <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                            <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ⭐</span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">✏️ Editar</button>
                                            <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">👁️ Ver</button>
                                            <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">⏸️ Pausar</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Pestaña de Crear Promoción -->
                        <div id="create-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">➕ Crear Nueva Promoción</h3>
                            
                            <form id="createPromotionForm" style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                        <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Seleccionar hotel</option>
                                            ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                        <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="discount">Descuento</option>
                                            <option value="package">Paquete</option>
                                            <option value="early-bird">Early Bird</option>
                                            <option value="last-minute">Last Minute</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                        <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Precio Promocional</label>
                                        <input type="text" id="promotionPrice" placeholder="Ej: $150 USD" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción de la Promoción</label>
                                    <textarea id="promotionDescription" rows="4" placeholder="Describe los beneficios de esta promoción..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Inicio</label>
                                        <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Fin</label>
                                        <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                    <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoción</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Pestaña de Historial -->
                        <div id="history-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📊 Historial de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">📊</span>
                                <p style="margin: 16px 0 0 0; color: #666;">El historial de promociones estará disponible próximamente</p>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Analytics -->
                        <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📈 Analytics de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">📈</span>
                                <p style="margin: 16px 0 0 0; color: #666;">Los analytics de promociones estará disponible próximamente</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners para pestañas
            const tabs = modal.querySelectorAll('.promotion-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todas las pestañas
                    tabs.forEach(t => t.classList.remove('active'));
                    t.style.background = '#f0f0f0';
                    t.style.color = '#333';
                    
                    // Agregar clase active a la pestaña clickeada
                    this.classList.add('active');
                    this.style.background = '#ff9800';
                    this.style.color = 'white';
                    
                    // Mostrar contenido correspondiente
                    const tabName = this.getAttribute('data-tab');
                    showPromotionTab(tabName);
                });
            });
            
            // Event listener para el formulario
            const form = modal.querySelector('#createPromotionForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createHotelPromotion();
                });
            }
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Función para mostrar herramientas de marketing
        function showMarketingTools() {
            console.log('📢 Mostrando herramientas de marketing...');
            
            // Cargar datos de usuarios
            const users = loadUsersData();
            
            // Crear y mostrar modal de herramientas de marketing
            showMarketingModal(users);
        }
        
        // Función para mostrar modal de herramientas de marketing
        function showMarketingModal(users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">📢 Herramientas de Marketing</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Pestañas de herramientas -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showMarketingTab('segments')" class="marketing-tab active" data-tab="segments" style="padding: 12px 20px; border: none; background: #4caf50; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">👥 Segmentación</button>
                        <button onclick="showMarketingTab('campaigns')" class="marketing-tab" data-tab="campaigns" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📧 Campañas</button>
                        <button onclick="showMarketingTab('templates')" class="marketing-tab" data-tab="templates" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📝 Plantillas</button>
                        <button onclick="showMarketingTab('analytics')" class="marketing-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Analytics</button>
                    </div>
                    
                    <!-- Contenido de pestañas -->
                    <div id="marketing-content">
                        <!-- Pestaña de Segmentación -->
                        <div id="segments-tab" class="marketing-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">👥 Segmentación de Usuarios</h3>
                            
                            <!-- Segmentos predefinidos -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">✅ Usuarios Activos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han tenido actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'active' || u.status === 'Activo').length} usuarios</span>
                                        <button onclick="exportSegment('active')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">📊 Con Cotizaciones</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han solicitado cotizaciones</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length} usuarios</span>
                                        <button onclick="exportSegment('withQuotes')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">🆕 Nuevos este Mes</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios registrados en el mes actual</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => {
                                            const userDate = new Date(u.createdAt);
                                            const currentDate = new Date();
                                            return userDate.getMonth() === currentDate.getMonth() && 
                                                   userDate.getFullYear() === currentDate.getFullYear();
                                        }).length} usuarios</span>
                                        <button onclick="exportSegment('newThisMonth')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">❌ Inactivos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios sin actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'inactive' || u.status === 'Inactivo').length} usuarios</span>
                                        <button onclick="exportSegment('inactive')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Segmento personalizado -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">🔧 Crear Segmento Personalizado</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Criterio:</label>
                                        <select id="customSegmentCriteria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="status">Estado</option>
                                            <option value="cotizaciones">Cotizaciones</option>
                                            <option value="fechaRegistro">Fecha de Registro</option>
                                            <option value="tipoCuenta">Tipo de Cuenta</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Valor:</label>
                                        <input type="text" id="customSegmentValue" placeholder="Ej: Activo, >0, etc." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div style="display: flex; align-items: end;">
                                        <button onclick="createCustomSegment()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Crear Segmento</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Campañas -->
                        <div id="campaigns-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📧 Gestión de Campañas</h3>
                            
                            <!-- Crear nueva campaña -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">🆕 Nueva Campaña</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre de la Campaña:</label>
                                        <input type="text" id="campaignName" placeholder="Ej: Promoción Verano 2025" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Segmento Objetivo:</label>
                                        <select id="campaignSegment" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="all">Todos los usuarios</option>
                                            <option value="active">Usuarios activos</option>
                                            <option value="withQuotes">Con cotizaciones</option>
                                            <option value="newThisMonth">Nuevos este mes</option>
                                            <option value="inactive">Inactivos</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tipo de Campaña:</label>
                                        <select id="campaignType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="email">Email Marketing</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="sms">SMS</option>
                                            <option value="push">Push Notification</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Mensaje:</label>
                                    <textarea id="campaignMessage" placeholder="Escribe tu mensaje aquí..." rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                <button onclick="createCampaign()" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">🚀 Crear Campaña</button>
                            </div>
                            
                            <!-- Campañas existentes -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: #333;">📋 Campañas Existentes</h4>
                                <div id="campaignsList" style="display: grid; gap: 12px;">
                                    <!-- Las campañas se cargarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Plantillas -->
                        <div id="templates-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📝 Plantillas de Mensajes</h3>
                            
                            <!-- Plantillas predefinidas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">🎉 Bienvenida</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Bienvenido a Checkin24hs! Descubre nuestras mejores ofertas de hoteles.</p>
                                    <button onclick="useTemplate('welcome')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">🔥 Oferta Especial</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Oferta especial por tiempo limitado! Descuentos exclusivos en hoteles premium.</p>
                                    <button onclick="useTemplate('specialOffer')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">📅 Recordatorio</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">No olvides revisar nuestras nuevas ofertas. ¡Tu próxima aventura te espera!</p>
                                    <button onclick="useTemplate('reminder')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">🎯 Reactivación</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Te extrañamos! Vuelve a descubrir las mejores ofertas en Checkin24hs.</p>
                                    <button onclick="useTemplate('reactivation')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Analytics -->
                        <div id="analytics-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📊 Analytics de Marketing</h3>
                            
                            <!-- Métricas de engagement -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #2e7d32; font-size: 24px;">${users.length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Audiencia Total</p>
                                </div>
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #f57c00; font-size: 24px;">${Math.round((users.filter(u => u.status === 'active' || u.status === 'Activo').length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Engagement</p>
                                </div>
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #1976d2; font-size: 24px;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Conversiones</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((users.filter(u => u.cotizaciones && u.cotizaciones > 0).length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Conversión</p>
                                </div>
                            </div>
                            
                            <!-- Gráfico de engagement por mes -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">📈 Engagement por Mes</h4>
                                <div style="height: 200px; display: flex; align-items: end; gap: 8px; padding: 16px;">
                                    ${generateEngagementChart(users)}
                                </div>
                            </div>
                            
                            <!-- Recomendaciones -->
                            <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #f57c00;">💡 Recomendaciones de Marketing</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li style="margin-bottom: 8px;">Enfócate en reactivar usuarios inactivos con ofertas especiales</li>
                                    <li style="margin-bottom: 8px;">Crea campañas personalizadas para usuarios con cotizaciones</li>
                                    <li style="margin-bottom: 8px;">Implementa un programa de fidelización para usuarios activos</li>
                                    <li style="margin-bottom: 8px;">Optimiza el timing de las campañas basado en el engagement</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Función para cambiar pestañas de marketing
        function showMarketingTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.marketing-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.marketing-tab').forEach(btn => {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Activar botón seleccionado
            event.target.style.background = '#4caf50';
            event.target.style.color = 'white';
        }
        
        // Función para exportar segmentos
        function exportSegment(segmentType) {
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(segmentType) {
                case 'active':
                    segmentUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    segmentUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    segmentUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Estado,Fecha Registro\n' +
                segmentUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `segmento_${segmentType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Segmento "${segmentType}" exportado correctamente (${segmentUsers.length} usuarios)`);
        }
        
        // Función para crear segmento personalizado
        function createCustomSegment() {
            const criteria = document.getElementById('customSegmentCriteria').value;
            const value = document.getElementById('customSegmentValue').value;
            
            if (!value) {
                alert('❌ Por favor ingresa un valor para el segmento');
                return;
            }
            
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(criteria) {
                case 'status':
                    segmentUsers = users.filter(u => u.status === value);
                    break;
                case 'cotizaciones':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > parseInt(value));
                    break;
                case 'tipoCuenta':
                    segmentUsers = users.filter(u => u.tipoCuenta === value);
                    break;
            }
            
            if (segmentUsers.length === 0) {
                alert('❌ No se encontraron usuarios con los criterios especificados');
                return;
            }
            
            alert(`✅ Segmento personalizado creado: ${segmentUsers.length} usuarios encontrados`);
            exportSegment('custom');
        }
        
        // Función para crear campaña
        function createCampaign() {
            const name = document.getElementById('campaignName').value;
            const segment = document.getElementById('campaignSegment').value;
            const type = document.getElementById('campaignType').value;
            const message = document.getElementById('campaignMessage').value;
            
            if (!name || !message) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            const campaign = {
                id: 'camp-' + Date.now(),
                name: name,
                segment: segment,
                type: type,
                message: message,
                createdAt: new Date().toISOString(),
                status: 'draft'
            };
            
            // Guardar campaña en localStorage
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            campaigns.push(campaign);
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert('✅ Campaña creada correctamente');
            
            // Limpiar formulario
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignMessage').value = '';
            
            // Actualizar lista de campañas
            loadCampaigns();
        }
        
        // Función para cargar campañas
        function loadCampaigns() {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaignsList = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                campaignsList.innerHTML = '<p style="color: #666; text-align: center;">No hay campañas creadas</p>';
                return;
            }
            
            campaignsList.innerHTML = campaigns.map(campaign => `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: #333;">${campaign.name}</h5>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${campaign.message.substring(0, 100)}${campaign.message.length > 100 ? '...' : ''}</p>
                            <div style="display: flex; gap: 12px; font-size: 12px; color: #666;">
                                <span>Segmento: ${campaign.segment}</span>
                                <span>Tipo: ${campaign.type}</span>
                                <span>Estado: ${campaign.status}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="sendCampaign('${campaign.id}')" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Enviar</button>
                            <button onclick="deleteCampaign('${campaign.id}')" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Función para usar plantilla
        function useTemplate(templateType) {
            const templates = {
                welcome: '¡Bienvenido a Checkin24hs! 🏨 Descubre nuestras mejores ofertas de hoteles y disfruta de descuentos exclusivos. ¡Tu próxima aventura te espera!',
                specialOffer: '🔥 ¡OFERTA ESPECIAL POR TIEMPO LIMITADO! 🔥 Descuentos exclusivos en hoteles premium. ¡No te pierdas esta oportunidad única!',
                reminder: '📅 ¿Ya planificaste tu próxima escapada? No olvides revisar nuestras nuevas ofertas. ¡Tu próxima aventura te espera en Checkin24hs!',
                reactivation: '👋 ¡Te extrañamos! Vuelve a descubrir las mejores ofertas en Checkin24hs. Tenemos descuentos especiales esperándote.'
            };
            
            const message = templates[templateType];
            if (message) {
                // Cambiar a la pestaña de campañas
                showMarketingTab('campaigns');
                
                // Llenar el formulario con la plantilla
                setTimeout(() => {
                    document.getElementById('campaignMessage').value = message;
                }, 100);
            }
        }
        
        // Función para generar gráfico de engagement
        function generateEngagementChart(users) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
            const engagement = months.map((month, index) => {
                const monthUsers = users.filter(user => {
                    const userDate = new Date(user.createdAt);
                    return userDate.getMonth() === index;
                });
                return monthUsers.length;
            });
            
            const maxEngagement = Math.max(...engagement);
            
            return engagement.map((value, index) => `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="width: 100%; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div style="height: ${(value / maxEngagement) * 150}px; background: #2196f3; transition: height 0.3s;"></div>
                    </div>
                    <span style="font-size: 12px; color: #666;">${months[index]}</span>
                    <span style="font-size: 10px; color: #999;">${value}</span>
                </div>
            `).join('');
        }
        
        // Función para enviar campaña
        function sendCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (!campaign) {
                alert('❌ Campaña no encontrada');
                return;
            }
            
            // Simular envío de campaña
            const users = loadUsersData();
            let targetUsers = [];
            
            switch(campaign.segment) {
                case 'all':
                    targetUsers = users;
                    break;
                case 'active':
                    targetUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    targetUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    targetUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    targetUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            // Actualizar estado de la campaña
            campaign.status = 'sent';
            campaign.sentAt = new Date().toISOString();
            campaign.recipients = targetUsers.length;
            
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert(`✅ Campaña "${campaign.name}" enviada a ${targetUsers.length} usuarios`);
            
            // Actualizar lista de campañas
            loadCampaigns();
        }
        
        // Función para eliminar campaña
        function deleteCampaign(campaignId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta campaña?')) {
                const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
                const updatedCampaigns = campaigns.filter(c => c.id !== campaignId);
                localStorage.setItem('marketing_campaigns', JSON.stringify(updatedCampaigns));
                
                alert('✅ Campaña eliminada correctamente');
                loadCampaigns();
            }
        }

        // Función para mostrar analytics de usuarios
        function showUserAnalytics() {
            console.log('📊 Mostrando analytics de usuarios...');
            
            // Cargar datos de usuarios
            const users = loadUsersData();
            
            // Calcular estadísticas
            const stats = calculateUserStats(users);
            
            // Crear y mostrar modal de analytics
            showAnalyticsModal(stats, users);
        }
        
        // Función para calcular estadísticas de usuarios
        function calculateUserStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo').length;
            const inactiveUsers = users.filter(user => user.status === 'inactive' || user.status === 'Inactivo').length;
            
            // Usuarios por mes (últimos 6 meses)
            const monthlyStats = {};
            const currentDate = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                monthlyStats[monthKey] = 0;
            }
            
            users.forEach(user => {
                const userDate = new Date(user.createdAt);
                const monthKey = userDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                if (monthlyStats[monthKey] !== undefined) {
                    monthlyStats[monthKey]++;
                }
            });
            
            // Usuarios por tipo de cuenta
            const accountTypes = {};
            users.forEach(user => {
                const type = user.tipoCuenta || 'registrado';
                accountTypes[type] = (accountTypes[type] || 0) + 1;
            });
            
            // Usuarios con cotizaciones
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0).length;
            
            return {
                totalUsers,
                activeUsers,
                inactiveUsers,
                monthlyStats,
                accountTypes,
                usersWithQuotes,
                usersWithoutQuotes: totalUsers - usersWithQuotes
            };
        }
        
        // Función para mostrar modal de analytics
        function showAnalyticsModal(stats, users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">📊 Análisis de Usuarios</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Estadísticas principales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #1976d2; font-size: 24px;">${stats.totalUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Total Usuarios</p>
                        </div>
                        <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #2e7d32; font-size: 24px;">${stats.activeUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Usuarios Activos</p>
                        </div>
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #f57c00; font-size: 24px;">${stats.usersWithQuotes}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Con Cotizaciones</p>
                        </div>
                        <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Tasa de Actividad</p>
                        </div>
                    </div>
                    
                    <!-- Gráfico de usuarios por mes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">📈 Registros por Mes</h3>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            ${Object.entries(stats.monthlyStats).map(([month, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500;">${month}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 200px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${(count / Math.max(...Object.values(stats.monthlyStats))) * 100}%; height: 100%; background: #2196f3;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 30px; text-align: right;">${count}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Tipos de cuenta -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">👥 Distribución por Tipo de Cuenta</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${Object.entries(stats.accountTypes).map(([type, count]) => `
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                                    <h4 style="margin: 0; color: #333; font-size: 18px;">${count}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">${type}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Acciones rápidas -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">⚡ Acciones Rápidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button onclick="exportActiveUsers()" style="background: #4caf50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📧 Exportar Usuarios Activos
                            </button>
                            <button onclick="exportUsersWithQuotes()" style="background: #ff9800; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📊 Exportar Con Cotizaciones
                            </button>
                            <button onclick="generateUserReport()" style="background: #2196f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📋 Generar Reporte Completo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabla de usuarios recientes -->
                    <div>
                        <h3 style="margin-bottom: 16px; color: #333;">🆕 Usuarios Recientes</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Usuario</th>
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Email</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Estado</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.slice(0, 5).map(user => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-size: 14px;">${user.name}</td>
                                            <td style="padding: 8px; font-size: 14px;">${user.email}</td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">
                                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; ${user.status === 'active' || user.status === 'Activo' ? 'background: #e8f5e8; color: #2e7d32;' : 'background: #ffebee; color: #c62828;'}">
                                                    ${user.status === 'active' || user.status === 'Activo' ? 'Activo' : 'Inactivo'}
                                                </span>
                                            </td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">${new Date(user.createdAt).toLocaleDateString('es-ES')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funciones auxiliares para las acciones rápidas
        function exportActiveUsers() {
            const users = loadUsersData();
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo');
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Estado,Fecha Registro\n' +
                activeUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_activos.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Usuarios activos exportados correctamente');
        }
        
        function exportUsersWithQuotes() {
            const users = loadUsersData();
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0);
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Cotizaciones,Estado\n' +
                usersWithQuotes.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.cotizaciones || 0}","${user.status}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_con_cotizaciones.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Usuarios con cotizaciones exportados correctamente');
        }
        
        function generateUserReport() {
            const users = loadUsersData();
            const stats = calculateUserStats(users);
            
            const report = `
REPORTE DE USUARIOS - CHECKIN24HS
Fecha: ${new Date().toLocaleDateString('es-ES')}

ESTADÍSTICAS GENERALES:
- Total de usuarios: ${stats.totalUsers}
- Usuarios activos: ${stats.activeUsers}
- Usuarios inactivos: ${stats.inactiveUsers}
- Tasa de actividad: ${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%
- Usuarios con cotizaciones: ${stats.usersWithQuotes}
- Usuarios sin cotizaciones: ${stats.usersWithoutQuotes}

DISTRIBUCIÓN POR TIPO DE CUENTA:
${Object.entries(stats.accountTypes).map(([type, count]) => `- ${type}: ${count}`).join('\n')}

REGISTROS POR MES:
${Object.entries(stats.monthlyStats).map(([month, count]) => `- ${month}: ${count} usuarios`).join('\n')}

USUARIOS RECIENTES (últimos 10):
${users.slice(0, 10).map(user => `- ${user.name} (${user.email}) - ${new Date(user.createdAt).toLocaleDateString('es-ES')}`).join('\n')}
            `;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_usuarios_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            alert('✅ Reporte completo generado correctamente');
        }

        // Función para exportar emails para campaña
        function exportEmailsForCampaign() {
            // Implementar exportación de emails
            console.log('Exportando emails para campaña...');
        }

        // Función para exportar teléfonos para WhatsApp
        function exportPhonesForWhatsApp() {
            // Implementar exportación de teléfonos
            console.log('Exportando teléfonos para WhatsApp...');
        }

        // Función para generar reporte de usuarios activos
        function generateActiveUsersReport() {
            // Implementar reporte
            console.log('Generando reporte de usuarios activos...');
        }

        // Función para crear segmento de usuarios de cotizaciones
        function createQuoteUsersSegment() {
            // Implementar segmento
            console.log('Creando segmento de usuarios de cotizaciones...');
        }

        // Función para cargar datos de usuarios
        function loadUsersData() {
            try {
                // Primero, sincronizar usuarios desde reservas
                syncUsersFromReservations();
                
                // Cargar usuarios desde checkin24hs_users (dashboard)
                const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                
                // Cargar usuarios desde clientesDB (index.html)
                const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                
                console.log('🔍 Datos encontrados en localStorage:', {
                    checkin24hs_users: dashboardUsers,
                    clientesDB: mobileUsers
                });
                
                // Combinar usuarios únicos
                const allUsers = [...dashboardUsers];
                
                // Agregar usuarios móviles que no estén en dashboard
                mobileUsers.forEach(mobileUser => {
                    const exists = allUsers.find(user => user.email === mobileUser.email);
                    if (!exists) {
                        // Convertir formato de usuario móvil a formato dashboard
                        const convertedUser = {
                            id: mobileUser.id,
                            name: mobileUser.name,
                            email: mobileUser.email,
                            phone: mobileUser.phone,
                            status: mobileUser.status || 'active',
                            createdAt: mobileUser.fechaRegistro || new Date().toISOString(),
                            tipoCuenta: mobileUser.tipoCuenta || 'registrado',
                            birthDay: mobileUser.birthDay,
                            birthMonth: mobileUser.birthMonth
                        };
                        allUsers.push(convertedUser);
                    }
                });
                
                console.log('📊 Cargando datos de usuarios...', {
                    dashboard: dashboardUsers.length,
                    mobile: mobileUsers.length,
                    total: allUsers.length,
                    allUsers: allUsers
                });
                
                // Guardar todos los usuarios en variable global
                allUsersData = allUsers;
                
                // Actualizar tabla de usuarios (solo primeros 20)
                loadUsersTable(allUsers.slice(0, 20));
                
                // Actualizar estadísticas
                updateDashboardStats(allUsers);
                
                return allUsers;
            } catch (error) {
                console.error('❌ Error al cargar usuarios:', error);
                return [];
            }
        }

        // Función para sincronizar usuarios desde reservas (versión silenciosa)
        function syncUsersFromReservations() {
            try {
                // Obtener todas las reservas
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                if (reservations.length === 0) {
                    return;
                }
                
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const existingEmails = new Set(users.map(user => 
                    user.email ? user.email.toLowerCase() : ''
                ));
                
                let newUsersCount = 0;
                const processedEmails = new Set();
                
                // Procesar cada reserva
                reservations.forEach(reservation => {
                    if (!reservation.clientEmail) {
                        return;
                    }
                    
                    const email = reservation.clientEmail.toLowerCase();
                    
                    // Si ya procesamos este email, saltar
                    if (processedEmails.has(email)) {
                        return;
                    }
                    
                    processedEmails.add(email);
                    
                    if (!existingEmails.has(email)) {
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
                        }
                        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: reservation.clientName || '',
                            email: reservation.clientEmail,
                            phone: reservation.clientPhone || '',
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            last_activity: reservation.updatedAt || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(email);
                        newUsersCount++;
                        console.log('✅ Usuario sincronizado desde reserva:', newUser.email);
                    }
                });
                
                // Guardar usuarios actualizados si hay nuevos
                if (newUsersCount > 0) {
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log(`🔄 Sincronización automática: ${newUsersCount} nuevos usuarios agregados desde reservas`);
                }
                
            } catch (error) {
                console.error('❌ Error al sincronizar usuarios desde reservas:', error);
            }
        }

        // Función para actualizar estadísticas del dashboard
        function updateDashboardStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const newUsersThisMonth = users.filter(user => {
                const userDate = new Date(user.createdAt);
                const currentDate = new Date();
                return userDate.getMonth() === currentDate.getMonth() && 
                       userDate.getFullYear() === currentDate.getFullYear();
            }).length;
            
            // Actualizar contadores en el dashboard
            const totalUsersElement = document.querySelector('#totalUsers');
            const activeUsersElement = document.querySelector('#activeUsers');
            const newUsersElement = document.querySelector('#newUsers');
            
            if (totalUsersElement) totalUsersElement.textContent = totalUsers;
            if (activeUsersElement) activeUsersElement.textContent = activeUsers;
            if (newUsersElement) newUsersElement.textContent = newUsersThisMonth;
            
            console.log('📊 Estadísticas actualizadas:', {
                total: totalUsers,
                active: activeUsers,
                newThisMonth: newUsersThisMonth
            });
        }

        // Función para sincronizar con index.html
        function syncWithIndexHTML() {
            console.log('🔄 Sincronizando datos de usuarios...');
            
            // Cargar datos actualizados
            const users = loadUsersData();
            
            // Guardar todos los usuarios en variable global
            allUsersData = users;
            
            // Actualizar interfaz
            updateDashboardStats(users);
            loadUsersTable(users.slice(0, 20));
            
            console.log('✅ Sincronización completada');
        }
        
        // Función para iniciar sincronización automática
        function startAutoSync() {
            // Sincronizar cada 30 segundos
            setInterval(() => {
                syncWithIndexHTML();
            }, 30000);
            
            console.log('🔄 Sincronización automática iniciada (cada 30 segundos)');
        }

        // Variable global para almacenar todos los usuarios
        let allUsersData = [];
        
        // Función para buscar usuarios
        function searchUsers() {
            const searchInput = document.getElementById('usersSearchInput');
            const searchInfo = document.getElementById('usersSearchInfo');
            const searchCount = document.getElementById('usersSearchCount');
            
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm === '') {
                // Si no hay búsqueda, mostrar los primeros 20
                loadUsersTable(allUsersData.slice(0, 20));
                if (searchInfo) searchInfo.style.display = 'none';
                return;
            }
            
            // Filtrar usuarios por término de búsqueda
            const filteredUsers = allUsersData.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                const phone = (user.phone || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       phone.includes(searchTerm);
            });
            
            // Mostrar resultados
            loadUsersTable(filteredUsers);
            
            // Mostrar información de búsqueda
            if (searchInfo && searchCount) {
                searchInfo.style.display = 'block';
                searchCount.textContent = filteredUsers.length;
            }
            
            console.log(`🔍 Búsqueda: "${searchTerm}" - ${filteredUsers.length} resultados`);
        }
        
        // Función para cargar tabla de usuarios
        function loadUsersTable(users) {
            console.log('🔄 Cargando tabla de usuarios con:', users.length, 'usuarios');
            
            const tableBody = document.querySelector('#usersTableBody');
            if (!tableBody) {
                console.error('❌ No se encontró la tabla de usuarios');
                return;
            }
            
            console.log('✅ Tabla encontrada, limpiando contenido...');
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                console.log('📝 No hay usuarios, mostrando mensaje vacío');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-users"></i> No hay usuarios registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agregar usuarios a la tabla
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const userType = user.tipoCuenta || 'registrado';
                const userSource = user.fechaRegistro ? 'Móvil' : (user.tipoCuenta === 'cliente_reserva' ? 'Reserva' : 'Dashboard');
                const cotizaciones = user.cotizaciones ? user.cotizaciones.length : 0;
                const ultimaActividad = user.last_activity || user.ultimaActividad || user.updatedAt || user.createdAt || user.created_at;
                
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <div class="user-info">
                            <div class="user-name">${user.name || 'Sin nombre'}</div>
                            <div class="user-type">${userType} - ${userSource}</div>
                        </div>
                    </td>
                    <td style="padding: 12px;">${user.email || 'Sin email'}</td>
                    <td style="padding: 12px; text-align: center;">${user.phone || 'Sin teléfono'}</td>
                    <td style="padding: 12px; text-align: center;">${cotizaciones}</td>
                    <td style="padding: 12px; text-align: center;">${formatDate(ultimaActividad)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span class="status-badge ${user.status === 'active' || user.status === 'activo' ? 'active' : 'inactive'}">
                            ${user.status === 'active' || user.status === 'activo' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="action-btn marketing" onclick="showMarketingTools('${user.id}')" title="Marketing">
                            <i class="fas fa-bullhorn"></i>
                        </button>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editUser('${user.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteUser('${user.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log('✅ Tabla de usuarios actualizada:', users.length, 'usuarios');
            console.log('📋 Filas agregadas a la tabla');
            
            // Mostrar información si hay más usuarios disponibles (solo si no hay búsqueda activa)
            const searchInput = document.getElementById('usersSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allUsersData.length > users.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'users-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando ${users.length} de ${allUsersData.length} usuarios. Usa el buscador para encontrar más usuarios.`;
                
                const tableContainer = tableBody.closest('.activity-card');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay búsqueda activa
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Función para editar usuario
        function editUser(userId) {
            alert('Funcionalidad de edición en desarrollo');
        }

        // Función para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Fecha inválida';
            }
        }
        
        // Función para eliminar usuario
        function deleteUser(userId) {
            if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                try {
                    // Cargar usuarios actuales
                    const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Filtrar el usuario a eliminar
                    const updatedUsers = users.filter(user => user.id !== userId);
                    
                    // Guardar usuarios actualizados
                    localStorage.setItem('checkin24hs_users', JSON.stringify(updatedUsers));
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('✅ Usuario eliminado:', userId);
                    alert('✅ Usuario eliminado correctamente');
                } catch (error) {
                    console.error('❌ Error al eliminar usuario:', error);
                    alert('❌ Error al eliminar usuario');
                }
            }
        }
        
        // Función para eliminar todos los usuarios de index.html
        function deleteAllUsers() {
            if (confirm('⚠️ ¿Estás seguro de que quieres eliminar TODOS los usuarios registrados?\n\nEsta acción eliminará todos los usuarios de la aplicación móvil (index.html) y no se puede deshacer.')) {
                try {
                    // Eliminar usuarios de checkin24hs_users (dashboard)
                    localStorage.removeItem('checkin24hs_users');
                    
                    // Eliminar usuarios de clientesDB (index.html)
                    localStorage.removeItem('clientesDB');
                    
                    // Eliminar usuario actual si existe
                    localStorage.removeItem('currentUser');
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('🗑️ Todos los usuarios eliminados');
                    alert('✅ Todos los usuarios han sido eliminados correctamente\n\n- Usuarios del dashboard eliminados\n- Usuarios de la app móvil eliminados\n- Sesiones activas cerradas');
                    
                    // Actualizar estadísticas
                    updateDashboardStats([]);
                    
                } catch (error) {
                    console.error('❌ Error al eliminar usuarios:', error);
                    alert('❌ Error al eliminar usuarios');
                }
            }
        }

        // ===== FUNCIONES DE RESERVAS =====

        // Función para inicializar base de datos de reservas
        function initReservationsDB() {
            console.log('Inicializando base de datos de reservas...');
            
            // Verificar si ya existen reservas en localStorage
            const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            if (existingReservations.length === 0) {
                console.log('🆕 No hay reservas en la base de datos, agregando reservas de ejemplo...');
                
                // Reservas de ejemplo
                const defaultReservations = [
                    {
                        id: 'res-001',
                        reservationCode: 'RES-2024-001',
                        clientName: 'María González',
                        clientEmail: 'maria.gonzalez@email.com',
                        clientPhone: '+56912345678',
                        hotelId: 'hotel-puyehue',
                        hotelName: 'Hotel Terma de Puyehue',
                        checkIn: '2024-02-15',
                        checkOut: '2024-02-18',
                        guests: 2,
                        adults: 2,
                        children: 0,
                        roomType: 'Doble',
                        status: 'Confirmada',
                        totalAmount: 600,
                        paymentStatus: 'Pagado',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'res-002',
                        reservationCode: 'RES-2024-002',
                        clientName: 'Carlos Rodríguez',
                        clientEmail: 'carlos.rodriguez@email.com',
                        clientPhone: '+56987654321',
                        hotelId: 'hotel-huilo-huilo',
                        hotelName: 'Hotel Huilo-Huilo',
                        checkIn: '2024-02-20',
                        checkOut: '2024-02-22',
                        guests: 4,
                        adults: 2,
                        children: 2,
                        roomType: 'Familiar',
                        status: 'Pendiente',
                        totalAmount: 480,
                        paymentStatus: 'Pendiente',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'res-003',
                        reservationCode: 'RES-2024-003',
                        clientName: 'Ana Silva',
                        clientEmail: 'ana.silva@email.com',
                        clientPhone: '+56911223344',
                        hotelId: 'hotel-corralco',
                        hotelName: 'Hotel Corralco Resort',
                        checkIn: '2024-02-25',
                        checkOut: '2024-02-28',
                        guests: 2,
                        adults: 2,
                        children: 0,
                        roomType: 'Doble',
                        status: 'Confirmada',
                        totalAmount: 720,
                        paymentStatus: 'Pagado',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // Guardar reservas de ejemplo en localStorage
                localStorage.setItem('reservationsDB', JSON.stringify(defaultReservations));
                
                console.log(`✅ ${defaultReservations.length} reservas de ejemplo agregadas`);
                
            } else {
                console.log(`ℹ️ Ya existen ${existingReservations.length} reservas en la base de datos`);
            }
        }

        // Variable global para almacenar todas las reservas
        let allReservationsData = [];
        
        // Función para cargar tabla de reservas
        async function loadReservationsTable(searchFilter = '') {
            console.log('🔄 Cargando tabla de reservas...');
            
            const tbody = document.getElementById('reservationsTableBody');
            if (!tbody) {
                console.error('❌ Tbody de reservas no encontrado');
                return;
            }
            
            // Intentar cargar desde Supabase primero
            let reservations = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando reservas desde Supabase...');
                    reservations = await window.supabaseClient.getReservations();
                    console.log(`✅ ${reservations.length} reservas cargadas desde Supabase`);
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                console.log('💾 Cargando reservas desde localStorage...');
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            console.log(`📋 Encontradas ${reservations.length} reservas`);
            
            // Guardar todas las reservas en variable global
            allReservationsData = reservations;
            
            // Ordenar reservas por fecha (más recientes primero)
            reservations.sort((a, b) => {
                const dateA = new Date(a.checkIn || a.createdAt || 0);
                const dateB = new Date(b.checkIn || b.createdAt || 0);
                return dateB - dateA; // Más reciente primero
            });
            
            // Filtrar por múltiples campos si hay un filtro
            if (searchFilter && searchFilter.trim() !== '') {
                const filter = searchFilter.trim().toLowerCase();
                reservations = reservations.filter(reservation => {
                    // Buscar en código de reserva
                    const code = (reservation.reservationCode || reservation.code || '').toLowerCase();
                    
                    // Buscar en email del cliente
                    const email = (reservation.clientEmail || reservation.email || '').toLowerCase();
                    
                    // Buscar en nombre del cliente
                    const clientName = (reservation.clientName || reservation.name || '').toLowerCase();
                    
                    // Buscar en nombre y apellido por separado
                    const firstName = (reservation.clientFirstName || reservation.firstName || '').toLowerCase();
                    const lastName = (reservation.clientLastName || reservation.lastName || '').toLowerCase();
                    const fullName = `${firstName} ${lastName}`.trim().toLowerCase();
                    
                    // Buscar en nombre del hotel
                    const hotelName = (reservation.hotelName || reservation.hotel || '').toLowerCase();
                    
                    // Buscar en teléfono
                    const phone = (reservation.clientPhone || reservation.phone || '').toLowerCase();
                    
                    // Buscar en ID de reserva
                    const id = (reservation.id || '').toString().toLowerCase();
                    
                    // Verificar si el término de búsqueda está en alguno de estos campos
                    return code.includes(filter) ||
                           email.includes(filter) ||
                           clientName.includes(filter) ||
                           firstName.includes(filter) ||
                           lastName.includes(filter) ||
                           fullName.includes(filter) ||
                           hotelName.includes(filter) ||
                           phone.includes(filter) ||
                           id.includes(filter);
                });
                console.log(`🔍 Filtradas ${reservations.length} reservas que contienen "${searchFilter}"`);
            } else {
                // Si no hay búsqueda, mostrar solo las últimas 20
                reservations = reservations.slice(0, 20);
                console.log(`📋 Mostrando las últimas 20 reservas de ${allReservationsData.length} totales`);
            }
            
            tbody.innerHTML = '';

            if (reservations.length === 0) {
                // Mostrar mensaje si no hay reservas
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-calendar" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">${searchFilter ? 'No se encontraron reservas' : 'No hay reservas registradas'}</h3>
                        <p style="margin-bottom: 20px; color: #666;">${searchFilter ? `No hay reservas con código que contenga "${searchFilter}"` : 'Comienza agregando tu primera reserva'}</p>
                        ${!searchFilter ? `<button onclick="addNewReservation()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nueva Reserva
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            reservations.forEach(reservation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500; color: #1976d2;">
                        <strong>${reservation.reservationCode || 'N/A'}</strong>
                    </td>
                    <td>
                        <div>
                            <div class="hotel-name">${reservation.clientName}</div>
                            <div class="hotel-location">${reservation.clientEmail}</div>
                        </div>
                    </td>
                    <td>${reservation.hotelName}</td>
                    <td style="text-align: center;">
                        <div>
                            <div><strong>Entrada:</strong> ${formatDate(reservation.checkIn)}</div>
                            <div><strong>Salida:</strong> ${formatDate(reservation.checkOut)}</div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <span class="status-${reservation.status.toLowerCase()}">${reservation.status}</span>
                    </td>
                    <td style="text-align: center;">
                        <strong>$${reservation.totalAmount.toLocaleString()}</strong>
                        ${reservation.paymentStatus ? `<div style="font-size: 0.8em; color: #666;">${reservation.paymentStatus}</div>` : ''}
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewReservation('${reservation.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button onclick="editReservation('${reservation.id}')" class="action-btn edit" title="Modificar">
                            <span class="material-icons">edit</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla de reservas cargada con ${reservations.length} reservas`);
            
            // Mostrar información si hay más reservas disponibles (solo si no hay búsqueda activa)
            const searchInput = document.getElementById('reservationSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allReservationsData.length > reservations.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'reservations-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando las últimas ${reservations.length} reservas de ${allReservationsData.length} totales. Usa el buscador para encontrar más reservas.`;
                
                const tableContainer = tbody.closest('.activity-card') || tbody.closest('div');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay búsqueda activa
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Función para filtrar reservas por código
        function filterReservationsByCode(searchValue) {
            console.log('🔍 Filtrando reservas por código:', searchValue);
            loadReservationsTable(searchValue);
        }

        // Función para actualizar estadísticas de reservas
        function updateReservationsStats() {
            console.log('📊 Actualizando estadísticas de reservas...');
            
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Actualizar contadores
            const totalReservationsElement = document.getElementById('totalReservations');
            const confirmedReservationsElement = document.getElementById('confirmedReservations');
            const modifiedReservationsElement = document.getElementById('modifiedReservations');
            const canceledReservationsElement = document.getElementById('canceledReservations');
            // Actualizar cantidad de Reservas Futuras
            const futureReservationsCountElement = document.getElementById('futureReservationsCount');
            
            if (totalReservationsElement) {
                totalReservationsElement.textContent = reservations.length;
            }
            
            if (confirmedReservationsElement) {
                const confirmed = reservations.filter(r => r.status === 'Confirmada').length;
                confirmedReservationsElement.textContent = confirmed;
            }
            
            if (modifiedReservationsElement) {
                const modified = reservations.filter(r => r.status === 'Modificada').length;
                modifiedReservationsElement.textContent = modified;
            }
            
            if (canceledReservationsElement) {
                const canceled = reservations.filter(r => r.status === 'Cancelada').length;
                canceledReservationsElement.textContent = canceled;
            }
            
            if (futureReservationsCountElement) {
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Función auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Verificar si tiene checkIn
                    if (!reservation.checkIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(reservation.checkIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                const count = futureReservations.length;
                futureReservationsCountElement.textContent = count;
                
                console.log(`✅ Cantidad de Reservas Futuras actualizada: ${count} reservas`);
            }
            
            console.log(`✅ Estadísticas de reservas actualizadas: ${reservations.length} reservas`);
            
            // Actualizar ventas mensuales si el dashboard está visible
            if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                loadMonthlySales();
            }
        }

        // Función para mostrar modal de Cantidad de Reservas Futuras
        function showTotalRevenueModal() {
            console.log('📊 Abriendo modal de Cantidad de Reservas Futuras...');
            
            // Obtener todas las reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Obtener fecha de hoy en formato YYYY-MM-DD (fecha local)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Función auxiliar para normalizar fechas
            function normalizeDate(dateStr) {
                if (!dateStr) return null;
                if (dateStr.includes('T')) {
                    return dateStr.split('T')[0];
                }
                return dateStr;
            }
            
            // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
            const futureReservations = reservations.filter(reservation => {
                // Excluir canceladas
                const status = reservation.status || '';
                if (status === 'Cancelada' || status === 'cancelada') {
                    return false;
                }
                
                // Verificar si tiene checkIn
                if (!reservation.checkIn) {
                    return false;
                }
                
                // Normalizar fecha de checkIn
                const checkInDate = normalizeDate(reservation.checkIn);
                if (!checkInDate) {
                    return false;
                }
                
                // Comparar con fecha de hoy (checkIn >= hoy)
                return checkInDate >= todayStr;
            });
            
            // Calcular cantidad de reservas futuras
            const futureReservationsCount = futureReservations.length;
            
            console.log('📊 Reservas futuras:', {
                cantidad: futureReservationsCount,
                fechaHoy: todayStr
            });
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333; font-size: 1.5rem;">📅 Cantidad de Reservas Futuras</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 8px; padding: 30px; text-align: center;">
                        <div style="width: 80px; height: 80px; background-color: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <span class="material-icons" style="color: white; font-size: 40px;">event</span>
                        </div>
                        <h3 style="margin: 0; font-size: 3rem; color: #333; font-weight: 700;">${futureReservationsCount}</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 1.1rem; font-weight: 500;">Reservas Futuras</p>
                        <p style="margin: 12px 0 0 0; color: #999; font-size: 0.9rem;">Reservas desde hoy (${todayStr}) hacia adelante</p>
                    </div>
                    
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="margin: 0; color: #666; font-size: 0.9rem; text-align: center;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</span>
                            Solo se incluyen reservas confirmadas o modificadas (no canceladas)
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Función para cargar ventas mensuales con filtros
        function loadMonthlySales(filterFrom = null, filterTo = null, filterHotelId = 'all') {
            console.log('📊 Cargando ventas mensuales...', { filterFrom, filterTo, filterHotelId });
            
            const monthlySalesContent = document.getElementById('monthlySalesContent');
            if (!monthlySalesContent) {
                console.error('❌ Contenedor de ventas mensuales no encontrado');
                return;
            }
            
            // Obtener todas las reservas
            let reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            if (!reservations || reservations.length === 0) {
                // Restaurar estilos por defecto
                monthlySalesContent.style.display = 'flex';
                monthlySalesContent.style.alignItems = 'center';
                monthlySalesContent.style.justifyContent = 'center';
                monthlySalesContent.style.background = '#f5f5f5';
                monthlySalesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtro de hotel
            if (filterHotelId && filterHotelId !== 'all') {
                reservations = reservations.filter(reservation => {
                    return reservation.hotelId === filterHotelId || 
                           reservation.hotelId === parseInt(filterHotelId) ||
                           (reservation.hotelId && reservation.hotelId.toString() === filterHotelId.toString());
                });
                console.log(`🏨 Filtrado por hotel ${filterHotelId}: ${reservations.length} reservas`);
            }
            
            // Objeto para agrupar ventas por mes/año
            const monthlySales = {};
            
            // Procesar cada reserva
            reservations.forEach(reservation => {
                // Obtener fecha de check-in
                const checkInDate = reservation.checkIn;
                const totalAmount = parseFloat(reservation.totalAmount) || 0;
                
                if (!checkInDate || totalAmount <= 0) {
                    return; // Saltar reservas sin fecha de check-in o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = checkInDate;
                if (checkInDate.includes('T')) {
                    dateStr = checkInDate.split('T')[0];
                }
                
                // Extraer año y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inválido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inválida
                }
                
                // Crear clave única para mes/año (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToYear = parseInt(filterTo.split('-')[0]);
                    const filterToMonth = parseInt(filterTo.split('-')[1]);
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (después del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlySales[monthKey]) {
                    monthlySales[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        count: 0
                    };
                }
                
                // Sumar venta (solo si no está cancelada)
                if (reservation.status !== 'Cancelada') {
                    monthlySales[monthKey].total += totalAmount;
                    monthlySales[monthKey].count += 1;
                }
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                // Ajustar si el mes es negativo (año anterior)
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                // Ajustar si el mes es mayor a 12 (año siguiente)
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalSalesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlySales[monthKey]) {
                    // Si hay datos para este mes, usar los datos reales
                    return monthlySales[monthKey];
                } else {
                    // Si no hay datos, crear entrada con valores en 0
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por año y mes (más reciente primero para mostrar: futuro -> presente -> pasado)
            finalSalesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year; // Año más reciente primero
                }
                return b.month - a.month; // Mes más reciente primero
            });
            
            // Nombres de meses en español
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/Año</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Reservas</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalSalesArray.forEach(sale => {
                const monthName = monthNames[sale.month - 1];
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${sale.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${sale.count}</td>
                        <td style="padding: 10px; text-align: right; color: #1976d2; font-weight: 600;">$${sale.total.toLocaleString('es-AR')}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor para que no use flex cuando hay tabla
            monthlySalesContent.style.display = 'block';
            monthlySalesContent.style.alignItems = 'stretch';
            monthlySalesContent.style.justifyContent = 'flex-start';
            monthlySalesContent.style.background = 'transparent';
            monthlySalesContent.innerHTML = html;
            
            console.log(`✅ Ventas mensuales cargadas: ${finalSalesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Función para cargar hoteles en el selector de filtro
        function loadHotelsForMonthlySalesFilter() {
            const hotelFilter = document.getElementById('hotelFilter');
            if (!hotelFilter) {
                return;
            }
            
            // Obtener hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Limpiar opciones excepto "Todos los hoteles"
            hotelFilter.innerHTML = '<option value="all">Todos los hoteles</option>';
            
            // Agregar hoteles
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name || `Hotel ${hotel.id}`;
                hotelFilter.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el filtro`);
        }
        
        // Función para aplicar filtros de ventas mensuales
        function applyMonthlySalesFilters() {
            const monthFrom = document.getElementById('monthFilterFrom').value;
            const monthTo = document.getElementById('monthFilterTo').value;
            const hotelId = document.getElementById('hotelFilter').value;
            
            // Validar que si hay "desde", también debe haber "hasta" o viceversa (opcional, pero mejor si ambos están)
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('⚠️ El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlySales(monthFrom || null, monthTo || null, hotelId || 'all');
        }
        
        // Función para limpiar filtros de ventas mensuales
        function clearMonthlySalesFilters() {
            document.getElementById('monthFilterFrom').value = '';
            document.getElementById('monthFilterTo').value = '';
            document.getElementById('hotelFilter').value = 'all';
            loadMonthlySales(null, null, 'all');
        }
        
        // Función para cargar gastos mensuales con filtros
        function loadMonthlyExpenses(filterFrom = null, filterTo = null, filterCategory = 'all', filterType = 'all') {
            console.log('💰 Cargando gastos mensuales...', { filterFrom, filterTo, filterCategory, filterType });
            
            const monthlyExpensesContent = document.getElementById('monthlyExpensesContent');
            if (!monthlyExpensesContent) {
                console.error('❌ Contenedor de gastos mensuales no encontrado');
                return;
            }
            
            // Obtener todos los gastos
            let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            if (!expenses || expenses.length === 0) {
                monthlyExpensesContent.style.display = 'flex';
                monthlyExpensesContent.style.alignItems = 'center';
                monthlyExpensesContent.style.justifyContent = 'center';
                monthlyExpensesContent.style.background = '#f5f5f5';
                monthlyExpensesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtros
            if (filterCategory && filterCategory !== 'all') {
                expenses = expenses.filter(expense => expense.category === filterCategory);
                console.log(`📂 Filtrado por categoría ${filterCategory}: ${expenses.length} gastos`);
            }
            
            if (filterType && filterType !== 'all') {
                expenses = expenses.filter(expense => expense.type === filterType);
                console.log(`📋 Filtrado por tipo ${filterType}: ${expenses.length} gastos`);
            }
            
            // Objeto para agrupar gastos por mes/año
            const monthlyExpenses = {};
            
            // Procesar cada gasto
            expenses.forEach(expense => {
                const expenseDate = expense.date;
                const totalAmount = parseFloat(expense.amount) || 0;
                
                if (!expenseDate || totalAmount <= 0) {
                    return; // Saltar gastos sin fecha o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = expenseDate;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                // Extraer año y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inválido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inválida
                }
                
                // Crear clave única para mes/año (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToDate = new Date(filterTo + '-01');
                    const filterToYear = filterToDate.getFullYear();
                    const filterToMonth = filterToDate.getMonth() + 1;
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (después del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlyExpenses[monthKey]) {
                    monthlyExpenses[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        count: 0
                    };
                }
                
                // Sumar gasto
                monthlyExpenses[monthKey].total += totalAmount;
                monthlyExpenses[monthKey].count += 1;
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalExpensesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlyExpenses[monthKey]) {
                    return monthlyExpenses[monthKey];
                } else {
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por año y mes (más reciente primero)
            finalExpensesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year;
                }
                return b.month - a.month;
            });
            
            // Nombres de meses en español
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/Año</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Gastos</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalExpensesArray.forEach(expense => {
                const monthName = monthNames[expense.month - 1];
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${expense.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${expense.count}</td>
                        <td style="padding: 10px; text-align: right; color: #d32f2f; font-weight: 600;">$${expense.total.toLocaleString('es-AR')}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor
            monthlyExpensesContent.style.display = 'block';
            monthlyExpensesContent.style.alignItems = 'stretch';
            monthlyExpensesContent.style.justifyContent = 'flex-start';
            monthlyExpensesContent.style.background = 'transparent';
            monthlyExpensesContent.innerHTML = html;
            
            console.log(`✅ Gastos mensuales cargados: ${finalExpensesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Función para cargar categorías en el filtro de gastos
        function loadExpenseCategoriesForFilter() {
            const categoryFilter = document.getElementById('expenseCategoryFilter');
            if (!categoryFilter) {
                return;
            }
            
            // Limpiar opciones excepto "Todas las categorías"
            categoryFilter.innerHTML = '<option value="all">Todas las categorías</option>';
            
            // Agregar categorías
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categoryFilter.appendChild(option);
            });
            
            console.log(`✅ ${Object.keys(expenseCategories).length} categorías cargadas en el filtro`);
        }
        
        // Función para aplicar filtros de gastos mensuales
        function applyMonthlyExpensesFilters() {
            const monthFrom = document.getElementById('expenseMonthFilterFrom').value;
            const monthTo = document.getElementById('expenseMonthFilterTo').value;
            const category = document.getElementById('expenseCategoryFilter').value;
            const type = document.getElementById('expenseTypeFilter').value;
            
            // Validar que si hay "desde", también debe haber "hasta" o viceversa
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('⚠️ El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlyExpenses(monthFrom || null, monthTo || null, category || 'all', type || 'all');
        }
        
        // Función para limpiar filtros de gastos mensuales
        function clearMonthlyExpensesFilters() {
            document.getElementById('expenseMonthFilterFrom').value = '';
            document.getElementById('expenseMonthFilterTo').value = '';
            document.getElementById('expenseCategoryFilter').value = 'all';
            document.getElementById('expenseTypeFilter').value = 'all';
            loadMonthlyExpenses(null, null, 'all', 'all');
        }

        // Función para agregar nueva reserva
        function addNewReservation() {
            console.log('🆕 Abriendo formulario para nueva reserva...');
            
            // Limpiar el formulario
            const form = document.getElementById('newReservationForm');
            if (form) {
                form.reset();
            }
            
            // Generar código de reserva automático
            const reservationCodeInput = document.getElementById('newReservationCode');
            if (reservationCodeInput) {
                reservationCodeInput.value = generateReservationCode();
            }
            
            // Establecer fecha mínima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newCheckIn').min = today;
            document.getElementById('newCheckOut').min = today;
            
            // Establecer fecha de registro como hoy
            const reservationDateInput = document.getElementById('newReservationDate');
            if (reservationDateInput) {
                reservationDateInput.value = today;
            }
            
            // Cargar hoteles en el select
            loadHotelsForNewReservation();
            
            // Cargar agentes en el select
            loadAgentsForNewReservation();
            
            // Mostrar el modal
            document.getElementById('newReservationModal').style.display = 'block';
            
            console.log('✅ Modal de nueva reserva abierto');
        }

        // Función para editar reserva
        function editReservation(reservationId) {
            console.log('✏️ Editando reserva:', reservationId);
            
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservation = reservations.find(r => r.id === reservationId);
            
            if (!reservation) {
                console.error('❌ Reserva no encontrada:', reservationId);
                alert('❌ Reserva no encontrada');
                return;
            }
            
            // Función auxiliar para normalizar fechas al formato YYYY-MM-DD
            // Evita problemas de zona horaria parseando manualmente
            const normalizeDate = (dateString) => {
                if (!dateString) return '';
                
                // Si ya está en formato YYYY-MM-DD, devolverlo tal cual
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                // Si está en formato ISO (YYYY-MM-DDTHH:mm:ss), extraer solo la fecha
                const isoMatch = dateString.match(/^(\d{4}-\d{2}-\d{2})/);
                if (isoMatch) {
                    return isoMatch[1];
                }
                
                // Si está en formato DD/MM/YYYY o DD-MM-YYYY, convertir manualmente
                const ddmmyyyyMatch = dateString.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
                if (ddmmyyyyMatch) {
                    const day = ddmmyyyyMatch[1];
                    const month = ddmmyyyyMatch[2];
                    const year = ddmmyyyyMatch[3];
                    return `${year}-${month}-${day}`;
                }
                
                // Si está en formato YYYY/MM/DD, convertir manualmente
                const yyyymmddMatch = dateString.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
                if (yyyymmddMatch) {
                    return dateString.replace(/[\/\-]/g, '-');
                }
                
                // Como último recurso, intentar con Date pero usando UTC para evitar problemas de zona horaria
                try {
                    // Si la fecha incluye hora, extraer solo la parte de fecha
                    const dateOnly = dateString.split('T')[0];
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) {
                        return dateOnly;
                    }
                    
                    // Parsear manualmente para evitar problemas de zona horaria
                    const date = new Date(dateString + 'T12:00:00'); // Usar mediodía para evitar cambios de día
                    if (isNaN(date.getTime())) return '';
                    
                    // Usar UTC para evitar problemas de zona horaria
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error('Error normalizando fecha:', dateString, e);
                    return '';
                }
            };
            
            // Llenar el formulario con los datos de la reserva
            document.getElementById('editClientName').value = reservation.clientName || '';
            document.getElementById('editClientEmail').value = reservation.clientEmail || '';
            document.getElementById('editClientPhone').value = reservation.clientPhone || '';
            document.getElementById('editReservationCode').value = reservation.reservationCode || '';
            document.getElementById('editCheckIn').value = normalizeDate(reservation.checkIn);
            document.getElementById('editCheckOut').value = normalizeDate(reservation.checkOut);
            document.getElementById('editReservationDate').value = normalizeDate(reservation.reservationDate);
            document.getElementById('editTotalAmount').value = reservation.totalAmount || 0;
            
            // Cargar hoteles en el select y seleccionar el correcto
            loadHotelsForEdit(reservation.hotelId);
            
            // Cargar agentes en el select y seleccionar el correcto
            loadAgentsForEdit(reservation.agentName);
            
            // Actualizar el título del modal
            document.getElementById('editReservationTitle').textContent = `Editar Reserva - ${reservation.reservationCode || reservation.id}`;
            
            // Guardar el ID de la reserva en el formulario
            document.getElementById('editReservationForm').dataset.reservationId = reservationId;
            
            // Mostrar el modal
            document.getElementById('editReservationModal').style.display = 'block';
            
            console.log('✅ Modal de edición abierto para reserva:', reservation.reservationCode);
        }

        // Función para eliminar reserva
        function deleteReservation(reservationId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta reserva?')) {
                console.log('🗑️ Eliminando reserva:', reservationId);
                
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const updatedReservations = reservations.filter(r => r.id !== reservationId);
                
                localStorage.setItem('reservationsDB', JSON.stringify(updatedReservations));
                
                console.log('✅ Reserva eliminada correctamente');
                alert('✅ Reserva eliminada correctamente');
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            }
        }

        // Función para ver detalles de reserva
        function viewReservation(reservationId) {
            console.log('👁️ Viendo detalles de reserva:', reservationId);
            
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservation = reservations.find(r => r.id === reservationId);
            
            if (!reservation) {
                console.error('❌ Reserva no encontrada:', reservationId);
                alert('❌ Reserva no encontrada');
                return;
            }
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">📅 ${reservation.reservationCode || `Reserva #${reservation.id}`}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>👤 Información del Cliente</h3>
                        <p><strong>Nombre:</strong> ${reservation.clientName}</p>
                        <p><strong>Email:</strong> ${reservation.clientEmail}</p>
                        <p><strong>Teléfono:</strong> ${reservation.clientPhone}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>🏨 Información de la Reserva</h3>
                        <p><strong>Hotel:</strong> ${reservation.hotelName}</p>
                        <p><strong>Entrada:</strong> ${formatDate(reservation.checkIn)}</p>
                        <p><strong>Salida:</strong> ${formatDate(reservation.checkOut)}</p>
                        <p><strong>Habitación:</strong> ${reservation.roomType}</p>
                        <p><strong>Huéspedes:</strong> ${reservation.guests} personas (${reservation.adults} adultos, ${reservation.children} niños)</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>💰 Información de Pago</h3>
                        <p><strong>Estado:</strong> <span class="status-${reservation.status.toLowerCase()}">${reservation.status}</span></p>
                        <p><strong>Pago:</strong> ${reservation.paymentStatus}</p>
                        <p><strong>Total:</strong> $${reservation.totalAmount.toLocaleString()} USD</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editReservation('${reservation.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ✏️ Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Función para exportar reservas a Excel
        function exportReservations() {
            console.log('📤 Exportando reservas a Excel...');
            
            try {
                // Obtener reservas del localStorage
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                if (reservations.length === 0) {
                    alert('⚠️ No hay reservas para exportar');
                    return;
                }
                
                // Preparar datos para Excel
                const excelData = reservations.map(reservation => {
                    return {
                        'Código': reservation.reservationCode || '',
                        'Cliente': reservation.clientName || '',
                        'Email': reservation.clientEmail || '',
                        'Teléfono': reservation.clientPhone || '',
                        'Hotel': reservation.hotelName || '',
                        'Fecha Entrada': reservation.checkIn || '',
                        'Fecha Salida': reservation.checkOut || '',
                        'Fecha Registro': reservation.reservationDate || '',
                        'Agente': reservation.agentName || '',
                        'Estado': reservation.status || '',
                        'Total': reservation.totalAmount || 0
                    };
                });
                
                // Crear workbook y worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // Código
                    { wch: 25 }, // Cliente
                    { wch: 30 }, // Email
                    { wch: 15 }, // Teléfono
                    { wch: 30 }, // Hotel
                    { wch: 15 }, // Fecha Entrada
                    { wch: 15 }, // Fecha Salida
                    { wch: 15 }, // Fecha Registro
                    { wch: 20 }, // Agente
                    { wch: 12 }, // Estado
                    { wch: 12 }  // Total
                ];
                ws['!cols'] = colWidths;
                
                // Agregar worksheet al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Reservas');
                
                // Generar nombre de archivo con fecha
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0];
                const fileName = `Reservas_${dateStr}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, fileName);
                
                console.log(`✅ ${reservations.length} reservas exportadas correctamente`);
                alert(`✅ ${reservations.length} reservas exportadas correctamente a ${fileName}`);
                
            } catch (error) {
                console.error('❌ Error al exportar reservas:', error);
                alert('❌ Error al exportar reservas: ' + error.message);
            }
        }
        
        // Función para abrir modal de importación
        function importReservations() {
            console.log('📥 Abriendo modal de importación...');
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'flex';
                // Limpiar input de archivo
                const fileInput = document.getElementById('importFileInput');
                if (fileInput) {
                    fileInput.value = '';
                }
            }
        }
        
        // Función para cerrar modal de importación
        function closeImportReservationsModal() {
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para procesar archivo Excel importado
        function processImportFile() {
            const fileInput = document.getElementById('importFileInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor selecciona un archivo Excel');
                return;
            }
            
            const file = fileInput.files[0];
            console.log('📥 Procesando archivo:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Leer el archivo Excel
                    // Usar cellDates: true para que SheetJS intente parsear fechas automáticamente cuando sea posible
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // Obtener la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON con raw: true para obtener valores originales
                    // Esto nos permite detectar números seriales de Excel y convertirlos correctamente
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
                    
                    if (jsonData.length === 0) {
                        alert('⚠️ El archivo Excel está vacío o no tiene datos válidos');
                        return;
                    }
                    
                    console.log(`📋 ${jsonData.length} filas encontradas en el archivo`);
                    
                    // Obtener reservas existentes
                    const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    const reservationsMap = new Map();
                    
                    // Crear mapa de reservas existentes por código
                    existingReservations.forEach(res => {
                        if (res.reservationCode) {
                            reservationsMap.set(res.reservationCode, res);
                        }
                    });
                    
                    let added = 0;
                    let updated = 0;
                    let errors = 0;
                    const errorMessages = [];
                    
                    // Procesar cada fila del Excel
                    jsonData.forEach((row, index) => {
                        try {
                            // Mapear columnas del Excel a campos de reserva
                            const reservationCode = (row['Código'] || row['Codigo'] || '').toString().trim();
                            const clientName = (row['Cliente'] || '').toString().trim();
                            const clientEmail = (row['Email'] || '').toString().trim();
                            const clientPhone = (row['Teléfono'] || row['Telefono'] || '').toString().trim();
                            const hotelName = (row['Hotel'] || '').toString().trim();
                            const checkIn = (row['Fecha Entrada'] || row['FechaEntrada'] || '').toString().trim();
                            const checkOut = (row['Fecha Salida'] || row['FechaSalida'] || '').toString().trim();
                            const reservationDate = (row['Fecha Registro'] || row['FechaRegistro'] || '').toString().trim();
                            const agentName = (row['Agente'] || '').toString().trim();
                            const status = (row['Estado'] || 'Confirmada').toString().trim();
                            const totalAmount = parseFloat(row['Total'] || 0);
                            
                            // Validar campos requeridos
                            if (!reservationCode || !clientName || !clientEmail || !checkIn || !checkOut) {
                                errors++;
                                errorMessages.push(`Fila ${index + 2}: Faltan campos requeridos (Código, Cliente, Email, Fechas)`);
                                return;
                            }
                            
                            // Buscar hotel por nombre
                            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotel = hotels.find(h => h.name === hotelName);
                            const hotelId = hotel ? hotel.id : '';
                            
                            // Normalizar fechas (formato YYYY-MM-DD)
                            const normalizeDate = (dateStr) => {
                                if (!dateStr) return '';
                                
                                // Convertir a string si es necesario
                                const dateValue = dateStr.toString().trim();
                                
                                // Detectar si es un número serial de Excel (puede venir como número o string)
                                // Los números seriales de Excel suelen ser > 1 (desde 1900) y < 1000000 (hasta ~2174)
                                const numericValue = typeof dateStr === 'number' ? dateStr : parseFloat(dateValue);
                                
                                if (!isNaN(numericValue) && numericValue > 1 && numericValue < 1000000) {
                                    // Es probablemente un número serial de Excel
                                    // Excel cuenta días desde el 1 de enero de 1900 como día 1
                                    // Hay un bug conocido: Excel trata 1900 como año bisiesto (aunque no lo es)
                                    // La fórmula más precisa para convertir números seriales de Excel:
                                    // Usamos 1899-12-30 como base y sumamos el número serial
                                    // Esto compensa el bug del año bisiesto 1900
                                    const excelEpoch = new Date(1899, 11, 30); // 30 de diciembre de 1899
                                    const date = new Date(excelEpoch.getTime() + numericValue * 24 * 60 * 60 * 1000);
                                    
                                    if (!isNaN(date.getTime())) {
                                        // Verificar que la fecha sea razonable (entre 1900 y 2100)
                                        const year = date.getFullYear();
                                        if (year >= 1900 && year <= 2100) {
                                            const yearStr = String(date.getFullYear());
                                            const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                            const dayStr = String(date.getDate()).padStart(2, '0');
                                            return `${yearStr}-${monthStr}-${dayStr}`;
                                        }
                                    }
                                }
                                
                                // Si es un objeto Date (cuando SheetJS parsea fechas con cellDates: true)
                                if (dateStr instanceof Date) {
                                    const yearStr = String(dateStr.getFullYear());
                                    const monthStr = String(dateStr.getMonth() + 1).padStart(2, '0');
                                    const dayStr = String(dateStr.getDate()).padStart(2, '0');
                                    return `${yearStr}-${monthStr}-${dayStr}`;
                                }
                                
                                // Si ya está en formato YYYY-MM-DD, devolverlo tal cual
                                if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                                    return dateValue;
                                }
                                
                                // Intentar parsear diferentes formatos de fecha
                                let date = null;
                                
                                // Formato con barras DD/MM/YYYY o MM/DD/YYYY
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('/');
                                    // Si el primer número es > 12, es DD/MM/YYYY, sino intentar MM/DD/YYYY
                                    if (parseInt(parts[0]) > 12) {
                                        // DD/MM/YYYY
                                        date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    } else {
                                        // Intentar MM/DD/YYYY primero
                                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                        // Si la fecha no es válida, intentar DD/MM/YYYY
                                        if (isNaN(date.getTime())) {
                                            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                        }
                                    }
                                }
                                // Formato con guiones DD-MM-YYYY
                                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('-');
                                    date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                }
                                // Otros formatos (intentar parseo directo)
                                else {
                                    date = new Date(dateValue);
                                }
                                
                                if (date && !isNaN(date.getTime())) {
                                    // Verificar que la fecha sea razonable
                                    const year = date.getFullYear();
                                    if (year >= 1900 && year <= 2100) {
                                        const yearStr = String(year);
                                        const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                        const dayStr = String(date.getDate()).padStart(2, '0');
                                        return `${yearStr}-${monthStr}-${dayStr}`;
                                    }
                                }
                                
                                // Si no se pudo parsear, devolver string vacío o el valor original
                                console.warn('⚠️ No se pudo normalizar la fecha:', dateStr);
                                return '';
                            };
                            
                            const normalizedCheckIn = normalizeDate(checkIn);
                            const normalizedCheckOut = normalizeDate(checkOut);
                            const normalizedReservationDate = normalizeDate(reservationDate) || new Date().toISOString().split('T')[0];
                            
                            // Verificar si la reserva ya existe
                            const existingReservation = reservationsMap.get(reservationCode);
                            
                            if (existingReservation) {
                                // Actualizar reserva existente
                                existingReservation.clientName = clientName;
                                existingReservation.clientEmail = clientEmail;
                                existingReservation.clientPhone = clientPhone;
                                existingReservation.hotelId = hotelId;
                                existingReservation.hotelName = hotelName;
                                existingReservation.checkIn = normalizedCheckIn;
                                existingReservation.checkOut = normalizedCheckOut;
                                existingReservation.reservationDate = normalizedReservationDate;
                                existingReservation.agentName = agentName;
                                existingReservation.status = status;
                                existingReservation.totalAmount = totalAmount;
                                existingReservation.updatedAt = new Date().toISOString();
                                updated++;
                            } else {
                                // Crear nueva reserva
                                const newReservation = {
                                    id: 'res-' + Date.now() + '-' + index,
                                    reservationCode: reservationCode,
                                    clientName: clientName,
                                    clientEmail: clientEmail,
                                    clientPhone: clientPhone,
                                    hotelId: hotelId,
                                    hotelName: hotelName,
                                    checkIn: normalizedCheckIn,
                                    checkOut: normalizedCheckOut,
                                    reservationDate: normalizedReservationDate,
                                    agentName: agentName,
                                    status: status,
                                    totalAmount: totalAmount,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                existingReservations.push(newReservation);
                                reservationsMap.set(reservationCode, newReservation);
                                added++;
                                
                                // Guardar o actualizar usuario
                                if (typeof saveUserFromReservation === 'function') {
                                    saveUserFromReservation(newReservation);
                                }
                            }
                        } catch (error) {
                            errors++;
                            errorMessages.push(`Fila ${index + 2}: ${error.message}`);
                            console.error(`Error procesando fila ${index + 2}:`, error);
                        }
                    });
                    
                    // Guardar todas las reservas
                    localStorage.setItem('reservationsDB', JSON.stringify(existingReservations));
                    
                    // Mostrar resumen
                    let message = `✅ Importación completada:\n`;
                    message += `• ${added} reservas agregadas\n`;
                    message += `• ${updated} reservas actualizadas\n`;
                    if (errors > 0) {
                        message += `• ${errors} errores encontrados\n\n`;
                        message += `Errores:\n${errorMessages.slice(0, 5).join('\n')}`;
                        if (errorMessages.length > 5) {
                            message += `\n... y ${errorMessages.length - 5} más`;
                        }
                    }
                    
                    alert(message);
                    
                    // Cerrar modal
                    closeImportReservationsModal();
                    
                    // Actualizar tabla y estadísticas
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                    
                    console.log(`✅ Importación completada: ${added} agregadas, ${updated} actualizadas, ${errors} errores`);
                    
                } catch (error) {
                    console.error('❌ Error al procesar archivo:', error);
                    alert('❌ Error al procesar el archivo Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('❌ Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Función para refrescar reservas
        function refreshReservations() {
            console.log('🔄 Refrescando reservas...');
            loadReservationsTable();
            updateReservationsStats();
        }

        // Función para eliminar todas las reservas
        function deleteAllReservations() {
            console.log('🗑️ Eliminando todas las reservas...');
            
            // Obtener cantidad de reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const count = reservations.length;
            
            if (count === 0) {
                alert('ℹ️ No hay reservas para eliminar');
                return;
            }
            
            // Primera confirmación
            const confirmMessage = `⚠️ ¿Estás seguro de que quieres eliminar TODAS las reservas?\n\n` +
                                 `Se eliminarán ${count} reserva(s).\n\n` +
                                 `Esta acción NO se puede deshacer.\n\n` +
                                 `Escribe "ELIMINAR" para confirmar:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === null) {
                // Usuario canceló
                console.log('❌ Eliminación cancelada por el usuario');
                return;
            }
            
            if (userInput.trim().toUpperCase() !== 'ELIMINAR') {
                alert('❌ Confirmación incorrecta. La eliminación fue cancelada.');
                console.log('❌ Confirmación incorrecta');
                return;
            }
            
            // Segunda confirmación
            if (!confirm(`⚠️ ÚLTIMA CONFIRMACIÓN\n\n¿Realmente quieres eliminar las ${count} reserva(s)?\n\nEsta acción es IRREVERSIBLE.`)) {
                console.log('❌ Eliminación cancelada en segunda confirmación');
                return;
            }
            
            try {
                // Eliminar todas las reservas
                localStorage.setItem('reservationsDB', JSON.stringify([]));
                
                console.log(`✅ ${count} reserva(s) eliminada(s) correctamente`);
                alert(`✅ ${count} reserva(s) eliminada(s) correctamente`);
                
                // Actualizar tabla y estadísticas
                if (typeof loadReservationsTable === 'function') {
                    loadReservationsTable();
                }
                if (typeof updateReservationsStats === 'function') {
                    updateReservationsStats();
                }
                
                // Actualizar ventas mensuales si el dashboard está visible
                if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                    loadMonthlySales();
                }
                
                // Actualizar gastos mensuales si el dashboard está visible
                if (currentSection === 'dashboard' && typeof loadMonthlyExpenses === 'function') {
                    loadMonthlyExpenses();
                }
                
            } catch (error) {
                console.error('❌ Error al eliminar reservas:', error);
                alert('❌ Error al eliminar reservas: ' + error.message);
            }
        }

        // Función auxiliar para formatear fechas
        // Evita problemas de zona horaria parseando manualmente fechas YYYY-MM-DD
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            // Si la fecha está en formato YYYY-MM-DD, parsearla manualmente para evitar problemas de zona horaria
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                const [year, month, day] = dateString.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                return date.toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // Para otros formatos, usar el método estándar
            try {
            const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Fecha inválida';
            return date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            } catch (e) {
                console.error('Error formateando fecha:', dateString, e);
                return 'Fecha inválida';
            }
        }

        // Función para generar código de reserva automático
        function generateReservationCode() {
            const year = new Date().getFullYear();
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const nextNumber = reservations.length + 1;
            return `RES-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Función para cargar hoteles en el select de edición
        function loadHotelsForEdit(selectedHotelId = '') {
            const hotelSelect = document.getElementById('editHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                option.selected = hotel.id === selectedHotelId;
                hotelSelect.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el select de edición`);
        }

        // Función para cargar agentes en el select de edición
        function loadAgentsForEdit(selectedAgentName = '') {
            const agentSelect = document.getElementById('editAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes del localStorage
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('⚠️ No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                option.textContent = `${agent.code} - ${agent.name} (${agent.agency})`;
                option.selected = agent.name === selectedAgentName;
                agentSelect.appendChild(option);
            });
            
            console.log(`✅ ${activeAgents.length} agentes cargados en el select de edición`);
        }

        // Función para cerrar modal de edición de reservas
        function closeEditReservationModal() {
            const modal = document.getElementById('editReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para cancelar una reserva
        function cancelReservation() {
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('❌ ID de reserva no encontrado');
                alert('❌ Error: ID de reserva no encontrado');
                return;
            }
            
            // Confirmar cancelación
            if (!confirm('¿Estás seguro de que quieres cancelar esta reserva?')) {
                return;
            }
            
            // Obtener reservas existentes
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId);
            
            if (reservationIndex !== -1) {
                // Cambiar el estado a "Cancelada"
                reservations[reservationIndex].status = 'Cancelada';
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar última actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('✅ Reserva cancelada correctamente');
                alert('✅ Reserva cancelada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('❌ Reserva no encontrada para cancelar');
                alert('❌ Error: Reserva no encontrada');
            }
        }

        // Función para guardar cambios de la reserva
        function saveReservationChanges(event) {
            event.preventDefault();
            
            console.log('💾 Guardando cambios de la reserva...');
            
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('❌ ID de reserva no encontrado');
                alert('❌ Error: ID de reserva no encontrado');
                return;
            }
            
            // Obtener datos del formulario - Solo tarifa y fechas son editables
            const formData = new FormData(form);
            let checkIn = formData.get('checkIn');
            let checkOut = formData.get('checkOut');
            const totalAmount = parseInt(formData.get('totalAmount'));
            
            // Validar campos requeridos
            if (!checkIn || !checkOut || !totalAmount || totalAmount <= 0) {
                alert('❌ Por favor completa todos los campos requeridos (fechas y tarifa)');
                return;
            }
            
            // Asegurar que las fechas estén en formato YYYY-MM-DD
            // Los inputs type="date" ya devuelven este formato, pero por seguridad lo validamos
            if (!/^\d{4}-\d{2}-\d{2}$/.test(checkIn) || !/^\d{4}-\d{2}-\d{2}$/.test(checkOut)) {
                console.error('Formato de fecha inválido:', { checkIn, checkOut });
                alert('❌ Error: Formato de fecha inválido. Por favor, selecciona las fechas nuevamente.');
                return;
            }
            
            // Validar fechas
            if (checkOut <= checkIn) {
                alert('❌ La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            // Obtener reservas existentes
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId);
            
            if (reservationIndex !== -1) {
                // Obtener la reserva actual para mantener datos no editables
                const currentReservation = reservations[reservationIndex];
                
                // Obtener reservationDate del formulario si existe
                const reservationDate = formData.get('reservationDate');
                
                // Actualizar solo tarifa y fechas (campos editables)
                // Asegurar que las fechas se guarden en formato correcto (YYYY-MM-DD)
                reservations[reservationIndex].checkIn = checkIn;
                reservations[reservationIndex].checkOut = checkOut;
                reservations[reservationIndex].totalAmount = totalAmount;
                if (reservationDate) {
                    reservations[reservationIndex].reservationDate = reservationDate;
                }
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                // Cambiar el estado a "Modificada" cuando se modifica una reserva
                // Si estaba cancelada, cambiar a "Modificada" (celeste)
                // Si estaba confirmada, cambiar a "Modificada" (celeste)
                if (currentReservation.status === 'Cancelada' || currentReservation.status === 'Confirmada' || currentReservation.status === 'Modificada') {
                    reservations[reservationIndex].status = 'Modificada';
                }
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar última actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('✅ Reserva modificada correctamente');
                console.log('📅 Fechas actualizadas:', { checkIn, checkOut });
                alert('✅ Reserva modificada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('❌ Reserva no encontrada para actualizar');
                alert('❌ Error: Reserva no encontrada');
            }
        }

        // Función auxiliar para obtener nombre del hotel por ID
        function getHotelNameById(hotelId) {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            return hotel ? hotel.name : 'Hotel no encontrado';
        }

        // Función para cargar hoteles en el select de nueva reserva
        function loadHotelsForNewReservation() {
            const hotelSelect = document.getElementById('newHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                hotelSelect.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el select de nueva reserva`);
        }

        // Función para cargar agentes en el select de nueva reserva
        function loadAgentsForNewReservation() {
            const agentSelect = document.getElementById('newAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes del localStorage
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('⚠️ No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                option.textContent = `${agent.code} - ${agent.name} (${agent.agency})`;
                agentSelect.appendChild(option);
            });
            
            console.log(`✅ ${activeAgents.length} agentes cargados en el select de nueva reserva`);
        }

        // Función para cerrar modal de nueva reserva
        function closeNewReservationModal() {
            const modal = document.getElementById('newReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para generar código de agente automático
        function generateAgentCode() {
            const year = new Date().getFullYear();
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            const nextNumber = agents.length + 1;
            return `AGT-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Función para abrir modal de nuevo agente
        function addNewAgent() {
            console.log('👤 Abriendo formulario para nuevo agente...');
            
            // Limpiar el formulario
            const form = document.getElementById('newAgentForm');
            if (form) {
                form.reset();
            }
            
            // Generar código de agente automático
            const agentCodeInput = document.getElementById('newAgentCode');
            if (agentCodeInput) {
                agentCodeInput.value = generateAgentCode();
            }
            
            // Mostrar el modal
            document.getElementById('newAgentModal').style.display = 'block';
            
            console.log('✅ Modal de nuevo agente abierto');
        }

        // Función para cerrar modal de nuevo agente
        function closeNewAgentModal() {
            const modal = document.getElementById('newAgentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para guardar nuevo agente
        function saveNewAgent(event) {
            event.preventDefault();
            
            console.log('💾 Guardando nuevo agente...');
            
            const form = document.getElementById('newAgentForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const agentData = {
                code: formData.get('agentCode'),
                name: formData.get('agentName'),
                agency: formData.get('agentAgency')
            };
            
            // Validar campos requeridos
            if (!agentData.code || !agentData.name || !agentData.agency) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            // Obtener agentes existentes
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            
            // Verificar si el código ya existe
            const existingAgent = agents.find(a => a.code === agentData.code);
            if (existingAgent) {
                alert('❌ Ya existe un agente con este código. Se generará un nuevo código.');
                agentData.code = generateAgentCode();
                document.getElementById('newAgentCode').value = agentData.code;
            }
            
            // Generar ID único
            const agentId = 'agent-' + Date.now();
            
            // Crear nuevo agente
            const newAgent = {
                id: agentId,
                ...agentData,
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Agregar a la lista
            agents.push(newAgent);
            
            // Guardar en localStorage
            localStorage.setItem('agentsDB', JSON.stringify(agents));
            
            console.log('✅ Nuevo agente guardado:', newAgent);
            
            // Cerrar modal
            closeNewAgentModal();
            
            // Mostrar mensaje de éxito
            alert('✅ Agente creado exitosamente');
            
            // Recargar agentes en el select de reservas si está abierto
            const agentSelect = document.getElementById('newAgentSelect');
            if (agentSelect) {
                loadAgentsForNewReservation();
            }
        }

        // Función para guardar nueva reserva
        function saveNewReservation(event) {
            event.preventDefault();
            
            console.log('💾 Guardando nueva reserva...');
            
            const form = document.getElementById('newReservationForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const reservationData = {
                clientName: formData.get('clientName'),
                clientEmail: formData.get('clientEmail'),
                clientPhone: formData.get('clientPhone'),
                hotelId: formData.get('hotelId'),
                hotelName: getHotelNameById(formData.get('hotelId')),
                reservationCode: formData.get('reservationCode'),
                checkIn: formData.get('checkIn'),
                checkOut: formData.get('checkOut'),
                reservationDate: formData.get('reservationDate'),
                agentName: formData.get('agentName'),
                status: formData.get('status'),
                totalAmount: parseInt(formData.get('totalAmount'))
            };
            
            // Validar campos requeridos
            if (!reservationData.clientName || !reservationData.clientEmail || !reservationData.clientPhone || !reservationData.hotelId || 
                !reservationData.checkIn || !reservationData.checkOut) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            // Validar fechas
            if (reservationData.checkOut <= reservationData.checkIn) {
                alert('❌ La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            // Generar ID y código únicos
            const reservationId = 'res-' + Date.now();
            const reservationCode = reservationData.reservationCode || generateReservationCode();
            
            // Crear nueva reserva - El estado siempre es "Confirmada" por defecto
            const newReservation = {
                id: reservationId,
                reservationCode: reservationCode,
                ...reservationData,
                status: 'Confirmada', // Siempre confirmada al crear
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Obtener reservas existentes
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            reservations.push(newReservation);
            
            // Guardar en localStorage
            localStorage.setItem('reservationsDB', JSON.stringify(reservations));
            
            // Guardar o actualizar usuario en Gestión de Usuarios
            saveUserFromReservation(reservationData);
            
            console.log('✅ Nueva reserva creada:', newReservation);
            alert(`✅ Reserva ${reservationCode} creada correctamente`);
            
            // Cerrar modal
            closeNewReservationModal();
            
            // Actualizar tabla y estadísticas
            loadReservationsTable();
            updateReservationsStats();
        }

        // Función para guardar usuario desde una reserva
        function saveUserFromReservation(reservationData) {
            try {
                console.log('💾 Guardando usuario desde reserva:', reservationData.clientEmail);
                
                // Obtener usuarios existentes
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`👥 Usuarios existentes antes: ${users.length}`);
                
                // Verificar si el usuario ya existe por email
                const existingUserIndex = users.findIndex(user => 
                    user.email && user.email.toLowerCase() === reservationData.clientEmail.toLowerCase()
                );
            
                if (existingUserIndex !== -1) {
                    // Actualizar usuario existente
                    const existingUser = users[existingUserIndex];
                    // Actualizar datos si están disponibles
                    if (reservationData.clientName && !existingUser.name) {
                        existingUser.name = reservationData.clientName;
                    }
                    if (reservationData.clientPhone && !existingUser.phone) {
                        existingUser.phone = reservationData.clientPhone;
                    }
                    // Actualizar última actividad
                    existingUser.last_activity = new Date().toISOString();
                    existingUser.updatedAt = new Date().toISOString();
                    
                    users[existingUserIndex] = existingUser;
                    console.log('🔄 Usuario actualizado desde reserva:', existingUser.email);
            } else {
                    // Calcular nuevo ID
                    let newId = 1;
                    if (users.length > 0) {
                        const numericIds = users.map(u => {
                            const id = parseInt(u.id);
                            return isNaN(id) ? 0 : id;
                        }).filter(id => id > 0);
                        newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
            }
            
                    // Crear nuevo usuario
                    const newUser = {
                        id: newId,
                        name: reservationData.clientName,
                        email: reservationData.clientEmail,
                        phone: reservationData.clientPhone || '',
                        status: 'active',
                        is_active: true,
                        createdAt: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        last_activity: new Date().toISOString(),
                        rewards_points: 0,
                        tipoCuenta: 'cliente_reserva',
                        avatar_url: null
                    };
                    
                    users.push(newUser);
                    console.log('✅ Nuevo usuario creado desde reserva:', newUser.email, newUser);
            }
            
                // Guardar usuarios actualizados
                localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                console.log(`💾 Usuarios guardados en checkin24hs_users: ${users.length} usuarios`);
                
            } catch (error) {
                console.error('❌ Error al guardar usuario desde reserva:', error);
            }
        }
        
        // Función para actualizar la última actividad de un usuario
        function updateUserActivity(userEmail) {
            try {
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const userIndex = users.findIndex(user => 
                    user.email && user.email.toLowerCase() === userEmail.toLowerCase()
                );
                
                if (userIndex !== -1) {
                    users[userIndex].last_activity = new Date().toISOString();
                    users[userIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log('🔄 Última actividad actualizada para:', userEmail);
                }
            } catch (error) {
                console.error('❌ Error al actualizar actividad del usuario:', error);
            }
        }
        
        // Función para actualizar usuarios desde reservas existentes
        function updateUsersFromReservations() {
            try {
                console.log('🔄 Actualizando usuarios desde reservas...');
                
                // Obtener todas las reservas
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                console.log(`📋 Encontradas ${reservations.length} reservas`);
            
                if (reservations.length === 0) {
                    alert('ℹ️ No hay reservas para procesar');
                return;
            }
            
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`👥 Usuarios existentes: ${users.length}`);
                
                const existingEmails = new Set(users.map(user => 
                    user.email ? user.email.toLowerCase() : ''
                ));
                
                let newUsersCount = 0;
                let updatedUsersCount = 0;
                const processedEmails = new Set(); // Para evitar procesar el mismo email múltiples veces
                
                // Procesar cada reserva
                console.log('📋 Procesando reservas...');
                reservations.forEach((reservation, index) => {
                    console.log(`📝 Procesando reserva ${index + 1}/${reservations.length}:`, {
                        code: reservation.reservationCode,
                        name: reservation.clientName,
                        email: reservation.clientEmail,
                        phone: reservation.clientPhone
                    });
                    
                    if (!reservation.clientEmail) {
                        console.warn('⚠️ Reserva sin email de cliente:', reservation.reservationCode);
                return;
            }
            
                    const email = reservation.clientEmail.toLowerCase();
                    console.log(`📧 Email procesado: ${email}`);
            
                    // Si ya procesamos este email en esta ejecución, solo actualizar actividad
                    if (processedEmails.has(email)) {
                        console.log(`🔄 Email ${email} ya procesado, actualizando actividad...`);
                        updateUserActivity(reservation.clientEmail);
                return;
            }
            
                    processedEmails.add(email);
                    console.log(`✅ Email ${email} agregado a procesados`);
                    
                    if (!existingEmails.has(email)) {
                        console.log(`🆕 Email ${email} no existe, creando nuevo usuario...`);
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
        }
        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: reservation.clientName || '',
                            email: reservation.clientEmail,
                            phone: reservation.clientPhone || '',
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            last_activity: reservation.updatedAt || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(email);
                        newUsersCount++;
                        console.log('✅ Nuevo usuario creado desde reserva:', newUser.email, newUser);
                        } else {
                        // Actualizar última actividad si el usuario ya existe
                        const userIndex = users.findIndex(user => 
                            user.email && user.email.toLowerCase() === email
                        );
                        if (userIndex !== -1) {
                            users[userIndex].last_activity = reservation.updatedAt || new Date().toISOString();
                            users[userIndex].updatedAt = new Date().toISOString();
                            // Actualizar datos si están disponibles y faltan
                            if (reservation.clientName && !users[userIndex].name) {
                                users[userIndex].name = reservation.clientName;
                            }
                            if (reservation.clientPhone && !users[userIndex].phone) {
                                users[userIndex].phone = reservation.clientPhone;
                            }
                            console.log('🔄 Usuario actualizado:', users[userIndex].email);
                        }
                        updatedUsersCount++;
                    }
                });
                
                // Guardar todos los usuarios actualizados
                localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                console.log('💾 Usuarios guardados en localStorage:', users.length);
                console.log('📊 Usuarios guardados:', users);
                
                console.log(`✅ Proceso completado: ${newUsersCount} nuevos usuarios, ${updatedUsersCount} usuarios actualizados`);
            
                // Mostrar mensaje de éxito
                alert(`✅ Actualización completada:\n- ${newUsersCount} nuevos usuarios agregados\n- ${updatedUsersCount} usuarios actualizados`);
                
                // Recargar datos de usuarios si estamos en la sección de usuarios
                if (typeof loadUsersData === 'function') {
                    console.log('🔄 Recargando datos de usuarios...');
                    loadUsersData();
            } else {
                    console.warn('⚠️ Función loadUsersData no encontrada');
                    }
                
                } catch (error) {
                console.error('❌ Error al actualizar usuarios desde reservas:', error);
                alert('❌ Error al actualizar usuarios: ' + error.message);
                }
            }
        function deleteUser(userId) {
            if (confirm('¿Estás seguro de que quieres eliminar este usuario? Esta acción no se puede deshacer.')) {
                const clientesDB = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                const updatedDB = clientesDB.filter(c => c.id !== userId);
                localStorage.setItem('clientesDB', JSON.stringify(updatedDB));
                
                if (typeof loadUsersData === 'function') {
                    loadUsersData();
                }
                alert('✅ Usuario eliminado correctamente');
            }
        }

        // ===== FUNCIONES PARA GESTIÓN DE GASTOS =====
        
        // Categorías de gastos
        const expenseCategories = {
            'sueldos': 'Sueldos',
            'servicios': 'Servicios',
            'alquiler': 'Alquiler',
            'telefonia': 'Telefonía',
            'publicidad_meta': 'Publicidad Meta',
            'gastos_bancario': 'Gastos Bancario',
            'tecnologia_oficina': 'Tecnología de Oficina',
            'varios': 'Varios'
        };

        // Inicializar base de datos de gastos
        function initExpensesDB() {
            console.log('💰 Inicializando base de datos de gastos...');
            const existingExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            console.log(`📊 Estado inicial: ${existingExpenses.length} gastos en localStorage`);
            
            // Inicializar presupuestos si no existen
            if (!localStorage.getItem('expensesBudget')) {
                const defaultBudget = {
                    monthly: 50000,
                    quarterly: 150000,
                    yearly: 600000
                };
                localStorage.setItem('expensesBudget', JSON.stringify(defaultBudget));
            }
        }

        // Cargar todos los datos de gastos
        function loadExpensesData() {
            console.log('💰 Cargando datos de gastos...');
            loadExpensesTable();
            updateExpensesKPIs();
            updateExpensesCharts();
        }

        // Actualizar categorías según tipo de gasto
        function updateExpenseCategories() {
            const categorySelect = document.getElementById('expenseCategory');
            categorySelect.innerHTML = '<option value="">Seleccionar categoría</option>';
            
            // Mostrar todas las categorías sin importar el tipo de gasto
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categorySelect.appendChild(option);
            });
        }

        // Abrir modal para agregar gasto
        function addNewExpense() {
            document.getElementById('expenseModalTitle').textContent = 'Agregar Gasto';
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            // Cargar categorías al abrir el modal
            updateExpenseCategories();
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Cerrar modal de gasto
        function closeExpenseModal() {
            document.getElementById('expenseModal').style.display = 'none';
            document.getElementById('expenseForm').reset();
        }

        // Función para calcular USD automáticamente
        function calculateUSD() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('expenseExchangeRate').value) || 0;
            const usdField = document.getElementById('expenseUSD');
            
            if (exchangeRate > 0) {
                const usd = amount / exchangeRate;
                usdField.value = usd.toFixed(2);
            } else {
                usdField.value = '0.00';
            }
        }
        
        // Guardar gasto
        async function saveExpense(event) {
            event.preventDefault();
            
            const expenseId = document.getElementById('expenseForm').dataset.expenseId;
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const exchangeRate = parseFloat(document.getElementById('expenseExchangeRate').value);
            const usd = exchangeRate > 0 ? amount / exchangeRate : 0;
            
            const expenseData = {
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                category: document.getElementById('expenseCategory').value,
                subcategory: document.getElementById('expenseSubcategory').value || '',
                description: document.getElementById('expenseDescription').value,
                amount: amount,
                exchange_rate: exchangeRate || null,
                usd_amount: parseFloat(usd.toFixed(2)) || null
            };
            
            try {
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        if (expenseId) {
                            await window.supabaseClient.updateExpense(expenseId, expenseData);
                            console.log('✅ Gasto actualizado en Supabase');
                            alert('✅ Gasto actualizado correctamente (guardado en la nube)');
                        } else {
                            await window.supabaseClient.createExpense(expenseData);
                            console.log('✅ Gasto guardado en Supabase');
                            alert('✅ Gasto guardado correctamente (guardado en la nube)');
                        }
                    } catch (error) {
                        console.warn('⚠️ Error guardando en Supabase, guardando en localStorage:', error);
                        // Fallback a localStorage
                        const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                        const expense = {
                            id: expenseId || Date.now().toString(),
                            ...expenseData,
                            exchangeRate: expenseData.exchange_rate,
                            usd: expenseData.usd_amount,
                createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (expenseId) {
                const index = expenses.findIndex(e => e.id === expenseId);
                if (index !== -1) {
                    expenses[index] = expense;
                }
            } else {
                expenses.push(expense);
            }
                        localStorage.setItem('expensesDB', JSON.stringify(expenses));
                        alert('✅ Gasto guardado correctamente (guardado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no está disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const expense = {
                        id: expenseId || Date.now().toString(),
                        ...expenseData,
                        exchangeRate: expenseData.exchange_rate,
                        usd: expenseData.usd_amount,
                        createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (expenseId) {
                        const index = expenses.findIndex(e => e.id === expenseId);
                        if (index !== -1) {
                            expenses[index] = expense;
                        }
                    } else {
                        expenses.push(expense);
                    }
            localStorage.setItem('expensesDB', JSON.stringify(expenses));
                    alert('✅ Gasto guardado correctamente (guardado localmente)');
                }
            
            closeExpenseModal();
            loadExpensesData();
            } catch (error) {
                console.error('❌ Error guardando gasto:', error);
                alert('❌ Error al guardar el gasto');
            }
        }

        // Cargar tabla de gastos
        async function loadExpensesTable() {
            // Intentar cargar desde Supabase primero
            let expenses = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando gastos desde Supabase...');
                    expenses = await window.supabaseClient.getExpenses();
                    console.log(`✅ ${expenses.length} gastos cargados desde Supabase`);
                } catch (error) {
                    console.warn('⚠️ Error cargando desde Supabase, usando localStorage:', error);
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
            } else {
                console.log('💾 Cargando gastos desde localStorage...');
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            }
            
            const tbody = document.getElementById('expensesTableBody');
            const noExpensesMessage = document.getElementById('noExpensesMessage');
            
            if (!tbody) return;
            
            if (expenses.length === 0) {
                tbody.innerHTML = '';
                if (noExpensesMessage) noExpensesMessage.style.display = 'block';
                return;
            }
            
            if (noExpensesMessage) noExpensesMessage.style.display = 'none';
            
            // Ordenar por fecha descendente
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                const categoryName = expenseCategories[expense.category] || expense.category;
                const typeLabel = expense.type === 'fixed' ? 'Fijo' : 'Variable';
                const typeColor = expense.type === 'fixed' ? '#1976d2' : '#f57c00';
                
                row.innerHTML = `
                    <td>${new Date(expense.date).toLocaleDateString('es-ES')}</td>
                    <td>${categoryName}</td>
                    <td>${expense.subcategory || '-'}</td>
                    <td><span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">${typeLabel}</span></td>
                    <td>${expense.description}</td>
                    <td style="font-weight: 600; color: #d32f2f;">$${expense.amount.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${expense.exchangeRate ? expense.exchangeRate.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td style="font-weight: 600; color: #1976d2;">${expense.usd ? '$' + expense.usd.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td>
                        <button onclick="editExpense('${expense.id}')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                        </button>
                        <button onclick="deleteExpense('${expense.id}')" style="background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Editar gasto
        function editExpense(expenseId) {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const expense = expenses.find(e => e.id === expenseId);
            
            if (!expense) {
                alert('❌ Gasto no encontrado');
                return;
            }
            
            document.getElementById('expenseModalTitle').textContent = 'Editar Gasto';
            document.getElementById('expenseForm').dataset.expenseId = expenseId;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseType').value = expense.type;
            updateExpenseCategories();
            setTimeout(() => {
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseSubcategory').value = expense.subcategory || '';
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseExchangeRate').value = expense.exchangeRate || '';
                // Calcular USD automáticamente al cargar
                calculateUSD();
            }, 100);
            
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Eliminar gasto
        async function deleteExpense(expenseId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este gasto?')) return;
            
            try {
                // Intentar eliminar de Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        await window.supabaseClient.deleteExpense(expenseId);
                        console.log('✅ Gasto eliminado de Supabase');
                        alert('✅ Gasto eliminado correctamente (eliminado de la nube)');
                    } catch (error) {
                        console.warn('⚠️ Error eliminando de Supabase, eliminando de localStorage:', error);
                        // Fallback a localStorage
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const filtered = expenses.filter(e => e.id !== expenseId);
            localStorage.setItem('expensesDB', JSON.stringify(filtered));
                        alert('✅ Gasto eliminado correctamente (eliminado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no está disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const filtered = expenses.filter(e => e.id !== expenseId);
                    localStorage.setItem('expensesDB', JSON.stringify(filtered));
                    alert('✅ Gasto eliminado correctamente (eliminado localmente)');
                }
            
            loadExpensesData();
            } catch (error) {
                console.error('❌ Error eliminando gasto:', error);
                alert('❌ Error al eliminar el gasto');
            }
        }

        // Actualizar KPIs de gastos
        function updateExpensesKPIs() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Calcular gastos totales
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Calcular CPA (Costo por Adquisición)
            const marketingExpenses = expenses
                .filter(e => e.category === 'publicidad_meta')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalReservations = reservations.length;
            const cpa = totalReservations > 0 ? marketingExpenses / totalReservations : 0;
            document.getElementById('cpaValue').textContent = `$${cpa.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpaSubtitle').textContent = `Publicidad Meta: $${marketingExpenses.toLocaleString('es-ES')} / ${totalReservations} reservas`;
            
            // Calcular CPC (Costo por Llamada) - Simulado
            const telecomExpenses = expenses
                .filter(e => e.category === 'telefonia')
                .reduce((sum, e) => sum + e.amount, 0);
            const salesPersonnelExpenses = expenses
                .filter(e => e.category === 'sueldos')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalCalls = totalReservations * 3; // Estimación: 3 llamadas por reserva
            const cpc = totalCalls > 0 ? (telecomExpenses + salesPersonnelExpenses) / totalCalls : 0;
            document.getElementById('cpcValue').textContent = `$${cpc.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpcSubtitle').textContent = `Telecom + Agentes: $${(telecomExpenses + salesPersonnelExpenses).toLocaleString('es-ES')} / ${totalCalls} llamadas`;
            
            // Calcular variación de presupuesto
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000}');
            const currentMonth = new Date().getMonth();
            const monthlyBudget = budget.monthly || 50000;
            const monthlyExpenses = expenses
                .filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === new Date().getFullYear();
                })
                .reduce((sum, e) => sum + e.amount, 0);
            const variance = monthlyBudget > 0 ? ((monthlyExpenses - monthlyBudget) / monthlyBudget) * 100 : 0;
            document.getElementById('budgetVariance').textContent = `${variance >= 0 ? '+' : ''}${variance.toFixed(1)}%`;
            document.getElementById('budgetVarianceSubtitle').textContent = `Real: $${monthlyExpenses.toLocaleString('es-ES')} vs Presupuesto: $${monthlyBudget.toLocaleString('es-ES')}`;
        }

        // Actualizar gráficos de gastos
        function updateExpensesCharts() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            updateCompositionChart(expenses);
            updateVariableExpensesChart(expenses);
            updateBudgetChart(expenses);
        }

        // Gráfico de composición (Pie Chart)
        function updateCompositionChart(expenses) {
            const fixedExpenses = expenses
                .filter(e => e.type === 'fixed')
                .reduce((sum, e) => sum + e.amount, 0);
            const variableExpenses = expenses
                .filter(e => e.type === 'variable')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const ctx = document.getElementById('expensesCompositionChart');
            if (!ctx) return;
            
            if (expensesCharts.composition) {
                expensesCharts.composition.destroy();
            }
            
            expensesCharts.composition = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Gastos Fijos', 'Gastos Variables'],
                    datasets: [{
                        data: [fixedExpenses, variableExpenses],
                        backgroundColor: ['#1976d2', '#f57c00'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = fixedExpenses + variableExpenses;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: $${value.toLocaleString('es-ES', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de gastos variables (Bar Chart)
        function updateVariableExpensesChart(expenses) {
            const variableExpenses = expenses.filter(e => e.type === 'variable');
            
            const categories = {
                'sales_personnel': 'Personal Ventas',
                'marketing': 'Marketing',
                'telecom': 'Telecomunicaciones',
                'acquisition': 'Adquisición'
            };
            
            const data = {};
            Object.keys(categories).forEach(key => {
                data[key] = variableExpenses
                    .filter(e => e.category === key)
                    .reduce((sum, e) => sum + e.amount, 0);
            });
            
            const ctx = document.getElementById('variableExpensesChart');
            if (!ctx) return;
            
            if (expensesCharts.variable) {
                expensesCharts.variable.destroy();
            }
            
            expensesCharts.variable = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(categories),
                    datasets: [{
                        label: 'Monto ($)',
                        data: Object.values(data),
                        backgroundColor: ['#1976d2', '#f57c00', '#388e3c', '#9c27b0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Gasto vs Presupuesto (Line Chart)
        function updateBudgetChart(expenses) {
            const period = document.getElementById('budgetPeriodFilter')?.value || 'monthly';
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000, "quarterly": 150000, "yearly": 600000}');
            
            // Agrupar gastos por período
            const groupedExpenses = {};
            const now = new Date();
            
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                let key;
                
                if (period === 'monthly') {
                    key = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
                } else if (period === 'quarterly') {
                    const quarter = Math.floor(expenseDate.getMonth() / 3) + 1;
                    key = `${expenseDate.getFullYear()}-Q${quarter}`;
                } else {
                    key = expenseDate.getFullYear().toString();
                }
                
                if (!groupedExpenses[key]) {
                    groupedExpenses[key] = 0;
                }
                groupedExpenses[key] += expense.amount;
            });
            
            const labels = Object.keys(groupedExpenses).sort();
            const actualData = labels.map(label => groupedExpenses[label] || 0);
            const budgetValue = budget[period] || budget.monthly;
            const budgetData = labels.map(() => budgetValue);
            
            const ctx = document.getElementById('budgetComparisonChart');
            if (!ctx) return;
            
            if (expensesCharts.budget) {
                expensesCharts.budget.destroy();
            }
            
            expensesCharts.budget = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gasto Real',
                            data: actualData,
                            borderColor: '#d32f2f',
                            backgroundColor: 'rgba(211, 47, 47, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Presupuesto',
                            data: budgetData,
                            borderColor: '#388e3c',
                            backgroundColor: 'rgba(56, 142, 60, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filtrar gastos
        function filterExpenses() {
            const searchTerm = document.getElementById('expensesSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#expensesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Exportar gastos
        function exportExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            if (expenses.length === 0) {
                alert('❌ No hay gastos para exportar');
                return;
            }
            
            let csv = 'Fecha,Tipo,Categoría,Subcategoría,Descripción,Monto,Tipo de Cambio,USD\n';
            expenses.forEach(expense => {
                const categoryName = expenseCategories[expense.category] || expense.category;
                csv += `"${expense.date}","${expense.type === 'fixed' ? 'Fijo' : 'Variable'}","${categoryName}","${expense.subcategory || ''}","${expense.description}","${expense.amount}","${expense.exchangeRate || ''}","${expense.usd || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `gastos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Gastos exportados correctamente');
        }

        // Actualizar gastos
        function refreshExpenses() {
            loadExpensesData();
            alert('✅ Gastos actualizados');
        }

        // IMPORTANTE: NO inicializar nada hasta verificar autenticación
        // Solo inicializar gastos si el usuario está autenticado
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
        initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesión para gastos:', e);
                }
            }
        }
        
        // Verificar autenticación cuando el DOM esté listo (esto se ejecuta ANTES del DOMContentLoaded del dashboard)
        (function() {
            function verifyAuth() {
                console.log('🔐 Verificando autenticación...');
                checkAuthStatus();
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', verifyAuth);
            } else {
                setTimeout(verifyAuth, 10);
            }
        })();
        
        // Inicializar gastos solo si está autenticado (después de verificar)
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
                            initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesión para gastos:', e);
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExpensesIfAuthenticated);
        } else {
            setTimeout(initExpensesIfAuthenticated, 200);
        }

        // ============================================
        // GESTIÓN DE ADMINISTRADORES
        // ============================================

        // Cargar administradores en la tabla
        function loadAdminsTable() {
            const admins = getAdminUsers();
            const tableBody = document.getElementById('adminsTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            admins.forEach(admin => {
                const row = document.createElement('tr');
                const roleText = admin.role === 'admin_total' ? 'Administrador Total' : 'Usuario';
                const roleBadge = admin.role === 'admin_total' ? 
                    '<span style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Admin Total</span>' :
                    '<span style="background: #666; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Usuario</span>';
                
                const statusBadge = admin.status === 'active' ?
                    '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Activo</span>' :
                    '<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Inactivo</span>';

                const lastLogin = admin.lastLogin ? new Date(admin.lastLogin).toLocaleString('es-ES') : 'Nunca';

                row.innerHTML = `
                    <td style="padding: 12px;">${admin.username}</td>
                    <td style="padding: 12px;">${admin.name}</td>
                    <td style="padding: 12px;">${admin.email || '-'}</td>
                    <td style="padding: 12px; text-align: center;">${roleBadge}</td>
                    <td style="padding: 12px; text-align: center;">${lastLogin}</td>
                    <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button class="btn-edit" onclick="editAdmin('${admin.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-edit" onclick="showResetPasswordModal('${admin.id}')" title="Resetear Contraseña" style="background: #ff9800;">
                                <i class="fas fa-key"></i>
                            </button>
                            ${admin.status === 'active' ? 
                                `<button class="btn-delete" onclick="deactivateAdmin('${admin.id}')" title="Dar de Baja">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button class="btn-edit" onclick="activateAdmin('${admin.id}')" title="Activar" style="background: #4caf50;">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Actualizar estadísticas
            updateAdminStats();
        }

        // Actualizar estadísticas de administradores
        function updateAdminStats() {
            const admins = getAdminUsers();
            const total = admins.length;
            const totalAdmins = admins.filter(a => a.role === 'admin_total').length;
            const totalUsers = admins.filter(a => a.role === 'usuario').length;
            const active = admins.filter(a => a.status === 'active').length;

            document.getElementById('totalAdmins').textContent = total;
            document.getElementById('totalAdminsTotal').textContent = totalAdmins;
            document.getElementById('totalAdminsUser').textContent = totalUsers;
            document.getElementById('activeAdmins').textContent = active;
        }

        // Mostrar modal para nuevo administrador
        function showNewAdminModal() {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden crear nuevos administradores');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Nuevo Administrador';
            document.getElementById('adminId').value = '';
            document.getElementById('adminForm').reset();
            document.getElementById('adminPassword').required = true;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Editar administrador
        function editAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden editar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Editar Administrador';
            document.getElementById('adminId').value = admin.id;
            document.getElementById('adminUsername').value = admin.username;
            document.getElementById('adminName').value = admin.name;
            document.getElementById('adminEmail').value = admin.email || '';
            document.getElementById('adminRole').value = admin.role;
            document.getElementById('adminStatus').value = admin.status;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').required = false;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Guardar administrador
        function saveAdmin(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden guardar administradores');
                return;
            }

            const adminId = document.getElementById('adminId').value;
            const username = document.getElementById('adminUsername').value.trim();
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const role = document.getElementById('adminRole').value;
            const status = document.getElementById('adminStatus').value;
            const password = document.getElementById('adminPassword').value;

            const admins = getAdminUsers();

            if (adminId) {
                // Editar
                const adminIndex = admins.findIndex(a => a.id === adminId);
                if (adminIndex === -1) {
                    alert('❌ Administrador no encontrado');
                    return;
                }

                // Verificar que el username no esté en uso por otro admin
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase() && a.id !== adminId);
                if (usernameExists) {
                    alert('❌ El nombre de usuario ya está en uso');
                    return;
                }

                admins[adminIndex].username = username;
                admins[adminIndex].name = name;
                admins[adminIndex].email = email;
                admins[adminIndex].role = role;
                admins[adminIndex].status = status;
                
                if (password && password.length >= 6) {
                    admins[adminIndex].password = password;
                } else if (password && password.length > 0) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }

                saveAdminUsers(admins);
                alert('✅ Administrador actualizado correctamente');
            } else {
                // Nuevo
                if (!password || password.length < 6) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }

                // Verificar que el username no esté en uso
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase());
                if (usernameExists) {
                    alert('❌ El nombre de usuario ya está en uso');
                    return;
                }

                const newAdmin = {
                    id: 'admin-' + Date.now(),
                    username: username,
                    password: password,
                    name: name,
                    email: email,
                    role: role,
                    status: status,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };

                admins.push(newAdmin);
                saveAdminUsers(admins);
                alert('✅ Administrador creado correctamente');
            }

            closeAdminModal();
            loadAdminsTable();
        }

        // Dar de baja administrador
        function deactivateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden dar de baja administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            if (confirm(`¿Estás seguro de que quieres dar de baja a ${admin.name}?`)) {
                admin.status = 'inactive';
                saveAdminUsers(admins);
                loadAdminsTable();
                alert('✅ Administrador dado de baja correctamente');
            }
        }

        // Activar administrador
        function activateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden activar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            admin.status = 'active';
            saveAdminUsers(admins);
            loadAdminsTable();
            alert('✅ Administrador activado correctamente');
        }

        // Mostrar modal para resetear contraseña
        function showResetPasswordModal(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden resetear contraseñas');
                return;
            }

            document.getElementById('resetAdminId').value = adminId;
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Resetear contraseña
        function resetAdminPassword(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden resetear contraseñas');
                return;
            }

            const adminId = document.getElementById('resetAdminId').value;
            const password = document.getElementById('resetPassword').value;
            const passwordConfirm = document.getElementById('resetPasswordConfirm').value;

            if (password !== passwordConfirm) {
                alert('❌ Las contraseñas no coinciden');
                return;
            }

            if (password.length < 6) {
                alert('❌ La contraseña debe tener al menos 6 caracteres');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            admin.password = password;
            saveAdminUsers(admins);
            closeResetPasswordModal();
            alert('✅ Contraseña reseteada correctamente');
        }

        // Cerrar modales
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        // Refrescar administradores
        function refreshAdmins() {
            loadAdminsTable();
        }

        // Mostrar/ocultar menú de administradores según el rol
        function updateAdminMenuVisibility() {
            const adminMenuLink = document.getElementById('adminMenuLink');
            if (adminMenuLink) {
                if (isAdminTotal()) {
                    adminMenuLink.style.display = 'block';
                } else {
                    adminMenuLink.style.display = 'none';
                }
            }
        }

        // Cargar administradores cuando se muestra la sección
        if (typeof window.showSection === 'function') {
            const originalShowSection = window.showSection;
            window.showSection = function(section, event) {
                originalShowSection(section, event);
                if (section === 'administrators') {
                    setTimeout(() => {
                        loadAdminsTable();
                        updateAdminMenuVisibility();
                    }, 100);
                }
            };
        }

        // Actualizar visibilidad del menú al iniciar sesión
        // Esto se ejecuta después de que showDashboard se define
        setTimeout(() => {
            if (typeof updateAdminMenuVisibility === 'function') {
                // Verificar si ya hay sesión activa
                const authSession = localStorage.getItem('dashboard_auth_session');
                if (authSession) {
                    updateAdminMenuVisibility();
                }
            }
        }, 500);
    </script>
    
    <!-- Modales para Administradores -->
    <!-- Modal Nuevo/Editar Administrador -->
    <div id="adminModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h2 class="modal-title" id="adminModalTitle">Nuevo Administrador</h2>
            <form id="adminForm" onsubmit="saveAdmin(event)">
                <input type="hidden" id="adminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Usuario *</label>
                    <input type="text" id="adminUsername" class="form-input" required placeholder="Nombre de usuario">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="adminName" class="form-input" required placeholder="Nombre completo">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="adminEmail" class="form-input" required placeholder="email@ejemplo.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rol *</label>
                    <select id="adminRole" class="form-input" required>
                        <option value="admin_total">Administrador Total</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
                
                <div class="form-group" id="adminPasswordGroup">
                    <label class="form-label">Contraseña *</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="Mínimo 6 caracteres">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Dejar en blanco para mantener la contraseña actual (solo al editar)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select id="adminStatus" class="form-input">
                        <option value="active">Activo</option>
                        <option value="inactive">Inactivo</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAdminModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Resetear Contraseña -->
    <div id="resetPasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeResetPasswordModal()">&times;</span>
            <h2 class="modal-title">Resetear Contraseña</h2>
            <form id="resetPasswordForm" onsubmit="resetAdminPassword(event)">
                <input type="hidden" id="resetAdminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Nueva Contraseña *</label>
                    <input type="password" id="resetPassword" class="form-input" required placeholder="Mínimo 6 caracteres" minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirmar Contraseña *</label>
                    <input type="password" id="resetPasswordConfirm" class="form-input" required placeholder="Confirma la contraseña" minlength="6">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Resetear Contraseña</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Widget Chatbot Flor -->
    <script src="flor-widget.js"></script>
    
    <!-- Script de Migración (cargar después de todo lo demás) -->
    <script src="migrate-to-supabase.js"></script>
    
    <!-- Verificar conexión con Supabase al cargar -->
    <script>
        // Verificar conexión cuando el dashboard esté listo
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const testResult = await window.supabaseClient.testConnection();
                        if (testResult.success) {
                            console.log('✅ Conexión con Supabase verificada correctamente');
                            console.log('💾 Los datos se guardarán en la nube automáticamente');
                        } else {
                            console.warn('⚠️ No se pudo conectar con Supabase:', testResult.error);
                            console.warn('💾 Se usará localStorage como respaldo');
                        }
                    } catch (error) {
                        console.warn('⚠️ Error verificando conexión con Supabase:', error);
                        console.warn('💾 Se usará localStorage como respaldo');
                    }
                } else {
                    console.warn('⚠️ Supabase no está configurado. Los datos se guardarán solo en localStorage.');
                    console.warn('📖 Para activar el guardado en la nube, configura tus credenciales en supabase-config.js');
                }
            }, 1000);
        });
    </script>
    </div>
    <!-- Fin del contenido del Dashboard -->
</body>
</html> 