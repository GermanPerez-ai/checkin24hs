<!DOCTYPE html>
<html lang="es">
<head>
    <!-- CRÍTICO: Verificación de versión LO PRIMERO - antes de cualquier otro código -->
    <script>
        // Log inmediato para verificar que el código nuevo se está cargando
        console.log('🔍 ============================================');
        console.log('🔍 VERIFICACIÓN TEMPRANA DE VERSIÓN DEL CÓDIGO');
        console.log('🔍 ============================================');
        console.log('📅 Timestamp de carga:', new Date().toISOString());
        console.log('🔍 Este log aparece SIEMPRE si el código nuevo está cargado');
        console.log('🔍 Si NO ves este log, el navegador está usando caché');
        console.log('🔍 ============================================');
        
        // Marcar que el código nuevo está presente
        window.CODIGO_ACTUALIZADO_2026_01_10 = true;
        console.log('✅ Variable de verificación establecida: window.CODIGO_ACTUALIZADO_2026_01_10 =', window.CODIGO_ACTUALIZADO_2026_01_10);
    </script>
    
    <!-- CRÍTICO: Definir showSection LO PRIMERO - antes de cualquier otro código -->
    <script>
        window.showSection = function(section, event) {
            try {
                if (event && event.preventDefault) event.preventDefault();
                var sections = document.querySelectorAll('[id$="-section"]');
                for (var i = 0; i < sections.length; i++) sections[i].style.display = 'none';
                var target = document.getElementById(section + '-section');
                if (target) {
                    target.style.display = 'block';
                    var items = document.querySelectorAll('.menu-item');
                    for (var j = 0; j < items.length; j++) items[j].classList.remove('active');
                    if (event && event.target) event.target.classList.add('active');
                }
            } catch(e) { console.error('showSection error:', e); }
        };
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Checkin24hs - Panel de Administración</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        body.authenticated {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background-color: #1976d2;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            position: relative;
            flex-wrap: nowrap;
            font-size: 0.85rem;
            gap: 10px;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }

        .menu-item.active {
            background-color: rgba(255,255,255,0.2);
        }

        .menu-item .material-icons {
            font-size: 18px;
            min-width: 28px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
            box-shadow: 
                2px 2px 4px rgba(0,0,0,0.3),
                -1px -1px 2px rgba(255,255,255,0.1),
                inset 1px 1px 2px rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .menu-item .menu-text,
        .menu-item span:not(.material-icons):not(.menu-text) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
            flex: 1;
        }

        .menu-item:hover .material-icons {
            transform: scale(1.1) rotateY(10deg);
            box-shadow: 
                4px 4px 8px rgba(0,0,0,0.4),
                -2px -2px 4px rgba(255,255,255,0.15),
                inset 1px 1px 3px rgba(255,255,255,0.3);
            background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.1));
        }

        .menu-item.active .material-icons {
            background: linear-gradient(145deg, #4fc3f7, #0288d1);
            box-shadow: 
                4px 4px 10px rgba(0,0,0,0.4),
                -2px -2px 6px rgba(255,255,255,0.1),
                inset 2px 2px 4px rgba(255,255,255,0.3),
                0 0 15px rgba(79, 195, 247, 0.5);
            transform: scale(1.05);
        }

        /* Flor Tabs */
        .flor-tab {
            padding: 10px 20px;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .flor-tab:hover {
            background: #e0e0e0;
        }
        .flor-tab.active {
            background: #1976d2;
            color: white;
        }
        .flor-tab-content {
            display: none;
        }
        .flor-tab-content.active {
            display: block;
        }

        /* Main Content */
        .main-content {
            margin-left: 220px;
            flex: 1;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            display: flex !important;
            flex-direction: column !important;
            width: auto !important;
            min-width: 800px !important;
        }

        /* Header */
        .header {
            background-color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            color: #333;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .user-button:hover {
            background-color: #f5f5f5;
        }

        .user-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item .material-icons {
            margin-right: 8px;
            font-size: 18px;
        }

        /* Content Area */
        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 24px;
            color: #333;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: white;
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .trend-up {
            color: #2e7d32;
        }

        .trend-down {
            color: #d32f2f;
        }

        /* Activity and Chart Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Table Container */
        .table-container {
            width: 100%;
            min-width: 100%;
            min-height: 200px;
            overflow-x: auto;
            margin-top: 24px;
            display: block;
            visibility: visible;
        }
        
        .table-container table {
            width: 100%;
            display: table;
            visibility: visible;
            background-color: white;
        }
        
        .table-container table tbody {
            display: table-row-group;
            visibility: visible;
        }
        
        .table-container table tbody tr {
            display: table-row;
            visibility: visible;
        }
        
        .table-container table tbody td {
            display: table-cell;
            visibility: visible;
            color: #333;
            background-color: white;
        }
        
        /* Estilos simplificados para tablas de gastos y cotizaciones */
        #expenses-section .table-container,
        #quotes-section .table-container {
            display: block !important;
            visibility: visible !important;
            width: 100% !important;
            min-width: 100% !important;
            min-height: 400px !important;
            height: auto !important;
            overflow-x: auto !important;
            overflow-y: visible !important;
            background-color: white !important;
            position: relative !important;
            z-index: 1 !important;
            margin-top: 24px !important;
        }
        
        #expenses-section .table-container table,
        #quotes-section .table-container table {
            width: 100% !important;
            min-width: 100% !important;
            display: table !important;
            visibility: visible !important;
            border-collapse: collapse !important;
            table-layout: auto !important;
            background-color: white !important;
        }
        
        #expenses-section .table-container table tbody,
        #quotes-section .table-container table tbody {
            display: table-row-group !important;
            visibility: visible !important;
        }
        
        #expenses-section .table-container table tbody tr,
        #quotes-section .table-container table tbody tr {
            display: table-row !important;
            visibility: visible !important;
        }
        
        #expenses-section .table-container table tbody td,
        #quotes-section .table-container table tbody td {
            display: table-cell !important;
            visibility: visible !important;
            color: #333 !important;
        }
        
        #expenses-section .table-container table {
            opacity: 1 !important;
            background-color: white !important;
        }
        
        #expenses-section .table-container table tbody {
            opacity: 1 !important;
            background-color: white !important;
        }
        
        #expenses-section .table-container table tbody tr {
            opacity: 1 !important;
            background-color: white !important;
        }
        
        #expenses-section .table-container table tbody td {
            opacity: 1 !important;
            background-color: white !important;
            color: #333 !important;
        }

        .activity-card, .chart-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #1976d2;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }

        .chart-placeholder {
            min-height: 200px;
            background-color: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        #monthlySalesContent:has(table) {
            background-color: transparent;
            padding: 0;
            min-height: auto;
        }

        /* Form Buttons */
        .form-button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
        }

        .form-button:hover {
            background-color: #1565c0;
        }

        .form-button.secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .form-button.secondary:hover {
            background-color: #e0e0e0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        
        table.data-table {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody {
            display: table-row-group;
            visibility: visible;
        }
        
        tbody tr {
            display: table-row;
            visibility: visible;
        }
        
        tbody td {
            display: table-cell;
            visibility: visible;
        }

        th {
            background-color: #f5f5f5;
            font-weight: 500;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .hotel-name {
            font-weight: 500;
            color: #1976d2;
        }

        .hotel-location {
            color: #666;
            font-size: 0.9rem;
        }

        .rating-stars {
            color: #ffc107;
        }

        .status-active {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .action-btn.edit {
            color: #1976d2;
        }

        .action-btn.delete {
            color: #d32f2f;
        }

        .action-btn.view {
            color: #2e7d32;
        }
        
        /* Estilos para tabla de usuarios */
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-weight: 500;
            color: #333;
        }
        
        .user-email {
            font-size: 0.85rem;
            color: #666;
        }
        
        .user-type {
            font-size: 0.75rem;
            color: #999;
            font-style: italic;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-badge.inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .btn-edit, .btn-delete {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #1976d2;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        /* Estilos para la sección de cotizaciones */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Secciones del dashboard */
        [id$="-section"] {
            position: relative;
            z-index: 1;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            z-index: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
            z-index: 1;
        }
        
        .search-box input {
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 250px;
            position: relative;
            z-index: 1;
        }
        
        .search-box .material-icons {
            position: absolute;
            right: 12px;
            color: #666;
            font-size: 18px;
            z-index: 2;
            pointer-events: none;
        }
        
        .quote-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .quote-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .quote-status.enviado {
            background: #cfe2ff;
            color: #084298;
        }
        
        .quote-status.processed {
            background: #d4edda;
            color: #155724;
        }
        
        .quote-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #1976d2;
        }
        
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-btn.secondary:hover {
            background: #5a6268;
        }
        
        .action-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .action-btn.danger:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        /* Estilos específicos para los nuevos modales */
        #expenseModalNew,
        #quoteModalNew,
        #cameraModalNew {
            display: none !important;
            position: fixed !important;
            z-index: 10000 !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.5) !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        #expenseModalNew[style*="display: flex"],
        #quoteModalNew[style*="display: flex"],
        #cameraModalNew[style*="display: flex"] {
            display: flex !important;
        }
        
        /* MOSTRAR CAMPOS DE IMAGEN - AHORA VISIBLES */
        #editHotelModal .form-group {
            position: relative;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-title {
            margin-bottom: 16px;
            color: #333;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        /* CAMPOS DE IMAGEN AHORA VISIBLES - CSS eliminado */

        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .form-input[type="number"] {
            width: 100%;
        }

        .form-input[type="url"] {
            width: 100%;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-top: 8px;
        }

        .photos-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .photo-preview {
            width: 80px;
            height: 60px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            object-fit: cover;
        }

        /* Image Manager Styles */
        .image-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            width: 120px;
            height: 140px;
            display: inline-block;
            margin: 5px;
        }

        .image-item:hover {
            border-color: #1976d2;
            transform: scale(1.05);
        }

        .image-item.selected {
            border-color: #2e7d32;
            background-color: #e8f5e8;
        }

        .image-preview {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .photo-placeholder {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            position: relative;
        }

        .photo-placeholder.selected {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .photo-placeholder .material-icons {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .photo-number {
            font-weight: bold;
            font-size: 0.6rem;
        }

        .image-item .image-name {
            padding: 5px;
            font-size: 0.7rem;
            color: #333;
            background-color: white;
            text-align: center;
            word-break: break-word;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .select-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #2e7d32;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-item.selected .select-overlay {
            opacity: 1;
        }

        .image-actions {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .btn-view, .btn-delete {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: #2196f3;
            color: white;
        }

        .btn-view:hover {
            background: #1976d2;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .photo-counter {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #388e3c;
        }

        .upload-progress {
            background-color: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            margin-top: 10px;
            overflow: hidden;
        }

        .upload-progress-bar {
            background-color: #1976d2;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 4px;
            }
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        /* Estilos para el carrusel de fotos */
        #photoCarouselModal .modal-content {
            background: transparent;
            box-shadow: none;
        }

        #carouselImage {
            transition: all 0.3s ease;
        }

        #carouselImage:hover {
            transform: scale(1.02);
        }

        #prevButton:hover, #nextButton:hover {
            background: rgba(0,0,0,0.9) !important;
            transform: translateY(-50%) scale(1.1);
        }

        #carouselThumbnails::-webkit-scrollbar {
            height: 6px;
        }

        #carouselThumbnails::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.7);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            #prevButton, #nextButton {
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
            }
            
            #carouselThumbnails {
                bottom: 60px !important;
                max-width: 90% !important;
            }
            
            #photoCounter {
                bottom: 15px !important;
                font-size: 12px !important;
            }
            
            /* ===== MODALES RESPONSIVOS ===== */
            .modal {
                padding: 10px !important;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: 100% !important;
                margin: 10px auto !important;
                padding: 15px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                border-radius: 12px !important;
            }
            
            .modal-content h2,
            .modal-content .modal-title {
                font-size: 1.2rem !important;
                margin-bottom: 15px !important;
            }
            
            .modal-content form {
                padding: 0 !important;
            }
            
            .modal-content .form-group {
                margin-bottom: 12px !important;
            }
            
            .modal-content input,
            .modal-content select,
            .modal-content textarea {
                width: 100% !important;
                padding: 12px !important;
                font-size: 16px !important; /* Evita zoom en iOS */
                box-sizing: border-box !important;
            }
            
            .modal-content label {
                font-size: 0.9rem !important;
                margin-bottom: 5px !important;
                display: block !important;
            }
            
            .modal-content button[type="submit"],
            .modal-content .btn-primary,
            .modal-content .form-button {
                width: 100% !important;
                padding: 14px !important;
                font-size: 1rem !important;
                margin-top: 10px !important;
            }
            
            .modal-content .form-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .modal-content .form-section {
                margin-bottom: 15px !important;
                padding: 10px !important;
            }
            
            .modal-content .close,
            .modal-content .close-btn {
                font-size: 28px !important;
                padding: 5px 10px !important;
            }
            
            /* Botones de acción en modales */
            .modal-content .modal-actions,
            .modal-content .form-actions {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .modal-content .modal-actions button,
            .modal-content .form-actions button {
                width: 100% !important;
            }
        }
        
        /* Extra pequeño (teléfonos muy pequeños) */
        @media (max-width: 480px) {
            .modal-content {
                width: 98% !important;
                padding: 12px !important;
                margin: 5px auto !important;
            }
            
            .modal-content h2,
            .modal-content .modal-title {
                font-size: 1.1rem !important;
            }
            
            .modal-content input,
            .modal-content select,
            .modal-content textarea {
                padding: 10px !important;
            }
        }
        
        /* Estilos para botones de acción */
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            margin: 0 2px;
            transition: background-color 0.3s;
        }
        
        .action-btn.edit {
            color: #1976d2;
        }
        
        .action-btn.edit:hover {
            background-color: rgba(25, 118, 210, 0.1);
        }
        
        .action-btn.delete {
            color: #d32f2f;
        }
        
        .action-btn.delete:hover {
            background-color: rgba(211, 47, 47, 0.1);
        }
        
        .action-btn.view {
            color: #388e3c;
        }
        
        .action-btn.view:hover {
            background-color: rgba(56, 142, 60, 0.1);
        }
        
        /* Estilos para estados de hoteles */
        .status-activo {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-inactivo {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-en-mantenimiento {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Estilos para estados de reservas */
        .status-confirmada {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pendiente {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-cancelada {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-modificada {
            background-color: #03a9f4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Estilos para el modal de edición de reservas */
        .form-grid {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 12px;
        }

        .form-section h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Estilos para la tabla de hoteles */
        .hotel-name {
            font-weight: 500;
            color: #333;
        }
        
        .hotel-location {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Estilos para estrellas de calificación */
        .rating-stars {
            color: #ffc107;
            font-size: 16px;
        }

        /* Estilos para pantalla de login */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.85) 0%, rgba(118, 75, 162, 0.85) 100%),
                        url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=2073&q=80') center center / cover no-repeat;
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .login-container.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-input-group {
            position: relative;
        }

        .form-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-input-group input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-input-group .input-icon {
            position: absolute;
            right: 16px;
            top: 42px;
            color: #666;
            cursor: pointer;
        }

        .login-error {
            background-color: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            border: 1px solid #fcc;
        }

        .login-error.show {
            display: block;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn-login:hover {
            background-color: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .btn-login:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo img {
            max-width: 120px;
            height: auto;
        }

        .dashboard-content {
            display: none;
        }

        .dashboard-content.authenticated {
            display: flex;
            width: 100%;
        }

        body.authenticated .dashboard-content {
            display: flex;
        }
        
        /* Animación de spin para carga */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- showSection ya está definido en la línea 6 del head -->
    
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    <!-- Supabase Client -->
    <script src="supabase-client.js?v=3.1.0" onerror="console.warn('supabase-client.js no encontrado');"></script>
    
    <!-- showSection ya está definido en la línea 6 del head -->
    
    <!-- Migration Script (opcional - descomentar si quieres migrar automáticamente) -->
    <!-- <script src="migrate-to-supabase.js"></script> -->
</head>
<body>
    <!-- showSection ya está definido en la línea 6 del head -->
    
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">
                <img src="logo.png" alt="Checkin24hs" style="height: 40px; width: auto;" onerror="this.style.display='none'">
            </div>
            <div class="login-header">
                <h1>Panel de Administración</h1>
                <p>Ingresa tus credenciales para continuar</p>
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-input-group">
                    <label for="loginUsername">Usuario</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        name="username" 
                        placeholder="Ingresa tu usuario" 
                        required 
                        autocomplete="username"
                    >
                </div>
                
                <div class="form-input-group">
                    <label for="loginPassword">Contraseña</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        name="password" 
                        placeholder="Ingresa tu contraseña" 
                        required 
                        autocomplete="current-password"
                    >
                    <span class="material-icons input-icon" onclick="togglePasswordVisibility()" style="pointer-events: all;">visibility</span>
                </div>
                
                <button type="submit" class="btn-login" id="loginButton">
                    Iniciar Sesión
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido del Dashboard (oculto hasta autenticación) -->
    <div class="dashboard-content" id="dashboardContent">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Checkin24hs Admin</h2>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="window.showSection('dashboard', event)">
                <span class="material-icons">dashboard</span>
                Dashboard
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('hotels', event)">
                <span class="material-icons">hotel</span>
                Hoteles
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('reservations', event)">
                <span class="material-icons">event</span>
                Reservas
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('flexi', event)">
                <span class="material-icons">card_giftcard</span>
                Programa Flexi
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('users', event)">
                <span class="material-icons">people</span>
                Usuarios
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('quotes', event)">
                <span class="material-icons">receipt</span>
                Cotizaciones
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('expenses', event)">
                <span class="material-icons">account_balance_wallet</span>
                Gastos
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('agents', event)">
                <span class="material-icons">support_agent</span>
                Agentes
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('interactions', event)">
                <span class="material-icons">chat</span>
                Interacciones
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('chats', event)">
                <span class="material-icons">forum</span>
                Chats
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('flor-config', event)">
                <span class="material-icons">smart_toy</span>
                Flor IA
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('administrators', event)" id="adminMenuLink" style="display: none;">
                <span class="material-icons">admin_panel_settings</span>
                <span class="menu-text">Administradores</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <span class="material-icons">menu</span>
            </button>
            <img src="logo.png" alt="Checkin24hs" style="height: 40px; margin-right: 12px;" onerror="this.style.display='none'">
            <h1>Panel de Administración</h1>
            <div class="user-menu">
                <button class="user-button" onclick="toggleUserMenu()">
                    <span class="material-icons">account_circle</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item">
                        <span class="material-icons">person</span>
                        Administrador
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <span class="material-icons">logout</span>
                        Cerrar Sesión
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="page-title">Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardTotalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsTotal">$0</h3>
                                <p>Sumatoria Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">event</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span style="font-size: 2rem; font-weight: bold; color: white;">$</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardMonthlySales">$0</h3>
                                <p>Ingresos del Mes Vigente</p>
                            </div>
                        </div>
                        <div class="stat-trend" id="dashboardMonthlyReservations">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                </div>

                <!-- Activity and Chart Grid -->
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Ventas Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlySalesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="monthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="monthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Hotel:</label>
                                <select id="hotelFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="all">Todos los hoteles</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#1565c0'" onmouseout="this.style.backgroundColor='#1976d2'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlySalesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Gastos Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlyExpensesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="expenseMonthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="expenseMonthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Categoría:</label>
                                    <select id="expenseCategoryFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todas las categorías</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Tipo de Gasto:</label>
                                    <select id="expenseTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todos los tipos</option>
                                        <option value="fixed">Fijo</option>
                                        <option value="variable">Variable</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#c62828'" onmouseout="this.style.backgroundColor='#d32f2f'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlyExpensesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>
                </div>

                <!-- Test Buttons for Debugging -->
                <div style="margin-top: 24px; margin-bottom: 24px; padding: 16px; background: #f0f8ff; border-radius: 8px; border: 1px solid #1976d2;">
                    <h4 style="margin-bottom: 12px; color: #1976d2;">🔧 Botones de Prueba</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="crearUsuariosPrueba()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add_circle</span>
                            Crear Usuarios Prueba
                        </button>
                                                    <button class="form-button" style="background: #2196f3; color: white;" onclick="window.showSection('users', event)">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">people</span>
                            Ir a Usuarios
                        </button>
                        <button class="form-button" style="background: #4caf50; color: white;" onclick="loadUsersData()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                            Cargar Datos
                        </button>
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="updateUsersFromReservations()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                            Actualizar Usuarios desde Reservas
                        </button>
                        <button class="form-button" style="background: #f44336; color: white;" onclick="deleteAllUsers()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete_forever</span>
                            Eliminar Todos los Usuarios
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hotels Section - NUEVO MÓDULO LIMPIO -->
            <div id="hotels-section" style="display: none;">
                <h2 class="page-title">🏨 Gestión de Hoteles</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewHotel()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Agregar Hotel
                    </button>
                    <button class="form-button secondary" onclick="exportHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Datos
                    </button>
                    <button class="form-button secondary" onclick="refreshHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" style="background: #ff9800; color: white;" onclick="showHotelPromotions()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">local_offer</span>
                        Promociones
                    </button>
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showMarketingTools()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">campaign</span>
                        Marketing
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">location_on</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalLocations">0</h3>
                                <p>Ubicaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="priceRange">$0-$0</h3>
                                <p>Rango de Precios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hotels Table -->
                <div class="activity-card">
                    <h3 class="card-title">Hoteles Vigentes</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Ubicación</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Calificación</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Precio</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="hotelsTableBody">
                                <!-- Los hoteles se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reservations Section -->
            <div id="reservations-section" style="display: none;">
                <h2 class="page-title">Gestión de Reservas</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewReservation()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Nueva Reserva
                    </button>
                    <button class="form-button" onclick="addNewAgent()" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Agente
                    </button>
                    <button class="form-button secondary" onclick="exportReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Reservas
                    </button>
                    <button class="form-button secondary" onclick="importReservations()" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Reservas
                    </button>
                    <button class="form-button secondary" onclick="refreshReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <!-- Botón de eliminar reservas removido por seguridad -->
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalReservations">0</h3>
                                <p>Total Reservas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="confirmedReservations">0</h3>
                                <p>Confirmadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #03a9f4;">
                                <span class="material-icons">edit</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="modifiedReservations">0</h3>
                                <p>Modificadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">cancel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="canceledReservations">0</h3>
                                <p>Canceladas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="showTotalRevenueModal()">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsCount">0</h3>
                                <p>Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>
                </div>

                <!-- Filtros Avanzados de Reservas -->
                <div class="activity-card" style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #e3f2fd, #f5f5f5);">
                    <h4 style="margin: 0 0 12px 0; color: #1976d2;">🔍 Filtros de Búsqueda</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Código de Reserva</label>
                            <input type="text" id="filterReservationCode" placeholder="Ej: 589704504" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onkeyup="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Nombre Cliente</label>
                            <input type="text" id="filterClientName" placeholder="Nombre o apellido" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onkeyup="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Fecha Entrada (desde)</label>
                            <input type="date" id="filterCheckInFrom" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Fecha Entrada (hasta)</label>
                            <input type="date" id="filterCheckInTo" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Estado</label>
                            <select id="filterStatus" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                                <option value="">Todos</option>
                                <option value="CONFIRMADA">Confirmada</option>
                                <option value="Modificada">Modificada</option>
                                <option value="CANCELADA">Cancelada</option>
                                <option value="PENDIENTE">Pendiente</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Hotel</label>
                            <select id="filterHotel" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                                <option value="">Todos los hoteles</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button type="button" onclick="clearReservationFilters()" 
                            style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🗑️ Limpiar Filtros
                        </button>
                        <button type="button" onclick="filterTodayReservations()" 
                            style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            📅 Ver Check-in de Hoy
                        </button>
                        <button type="button" onclick="filterFutureReservations()" 
                            style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            🔮 Ver Reservas Futuras
                        </button>
                        <span id="filterResultsCount" style="padding: 8px; color: #666; font-size: 13px;"></span>
                    </div>
                </div>

                <!-- Reservations Table -->
                <div class="activity-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">Reservas Activas</h3>
                        <div style="position: relative; width: 300px;">
                            <input 
                                type="text" 
                                id="reservationSearchInput" 
                                placeholder="Búsqueda rápida..." 
                                style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                onkeyup="filterReservationsByCode(this.value)"
                                oninput="filterReservationsByCode(this.value)"
                            >
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">🔍</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Código</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Fechas</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Total</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reservationsTableBody">
                                <!-- Las reservas se cargarán dinámicamente -->
                            </tbody>
                        </table>
                                </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div id="editReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="editReservationTitle">Modificar Reserva</h2>
            </div>
            <form id="editReservationForm" onsubmit="saveReservationChanges(event)">
                <div class="form-grid">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3>👤 Información del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientName">Nombre Completo</label>
                                <input type="text" id="editClientName" name="clientName" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editClientEmail">Email</label>
                                <input type="email" id="editClientEmail" name="clientEmail" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientPhone">Teléfono</label>
                                <input type="tel" id="editClientPhone" name="clientPhone" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Reserva -->
                    <div class="form-section">
                        <h3>🏨 Información de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editHotelSelect">Hotel</label>
                                <select id="editHotelSelect" name="hotelId" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editReservationCode">Código de Reserva</label>
                                <input type="text" id="editReservationCode" name="reservationCode" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="editCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="editCheckOut">Fecha de Salida *</label>
                                <input type="date" id="editCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editReservationDate">Fecha de Registro</label>
                                <input type="date" id="editReservationDate" name="reservationDate" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editAgentSelect">Agente Responsable</label>
                                <select id="editAgentSelect" name="agentName" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Información de Pago -->
                    <div class="form-section">
                        <h3>💰 Información de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTotalAmount">Tarifa (USD) *</label>
                                <input type="number" id="editTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeEditReservationModal()" class="btn btn-secondary">Salir</button>
                    <button type="button" onclick="cancelReservation()" class="btn btn-secondary" style="background: #dc3545; color: white;">Cancelar Reserva</button>
                    <button type="submit" class="btn btn-primary">Modificar Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Reservation Modal -->
    <div id="newReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>🆕 Nueva Reserva</h2>
            </div>
            <form id="newReservationForm" onsubmit="saveNewReservation(event)">
                <div class="form-grid">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3>👤 Información del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientName">Nombre Completo *</label>
                                <input type="text" id="newClientName" name="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="newClientEmail">Email *</label>
                                <input type="email" id="newClientEmail" name="clientEmail" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientPhone">Teléfono *</label>
                                <input type="tel" id="newClientPhone" name="clientPhone" required>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Reserva -->
                    <div class="form-section">
                        <h3>🏨 Información de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newHotelSelect">Hotel *</label>
                                <select id="newHotelSelect" name="hotelId" required>
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newReservationCode">Código de Reserva *</label>
                                <input type="text" id="newReservationCode" name="reservationCode" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="newCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="newCheckOut">Fecha de Salida *</label>
                                <input type="date" id="newCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newReservationDate">Fecha de Registro *</label>
                                <input type="date" id="newReservationDate" name="reservationDate" required>
                            </div>
                            <div class="form-group">
                                <label for="newAgentSelect">Agente Responsable *</label>
                                <select id="newAgentSelect" name="agentName" required>
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- Información de Pago -->
                    <div class="form-section">
                        <h3>💰 Información de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newStatus">Estado de la Reserva *</label>
                                <select id="newStatus" name="status" required>
                                    <option value="Confirmada" selected>Confirmada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTotalAmount">Total (USD) *</label>
                                <input type="number" id="newTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeNewReservationModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Agent Modal -->
    <div id="newAgentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 505px; width: 85%;">
            <div class="modal-header">
                <h2>👤 Nuevo Agente</h2>
                <button onclick="closeNewAgentModal()" class="close-btn">&times;</button>
            </div>
            <form id="newAgentForm" onsubmit="saveNewAgent(event)">
                <div class="form-grid">
                    <div class="form-section">
                        <h3>📋 Información del Agente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentCode">Código de Agente *</label>
                                <input type="text" id="newAgentCode" name="agentCode" readonly required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentName">Nombre *</label>
                                <input type="text" id="newAgentName" name="agentName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentAgency">Agencia *</label>
                                <input type="text" id="newAgentAgency" name="agentAgency" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeNewAgentModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Agente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div id="editAgentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 505px; width: 85%;">
            <div class="modal-header">
                <h2>✏️ Editar Agente</h2>
                <button onclick="closeEditAgentModal()" class="close-btn">&times;</button>
            </div>
            <form id="editAgentForm" onsubmit="saveEditedAgent(event)">
                <input type="hidden" id="editAgentId" name="agentId">
                <div class="form-grid">
                    <div class="form-section">
                        <h3>📋 Información del Agente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentCode">Código de Agente</label>
                                <input type="text" id="editAgentCode" name="agentCode" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentName">Nombre *</label>
                                <input type="text" id="editAgentName" name="agentName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentAgency">Agencia *</label>
                                <input type="text" id="editAgentAgency" name="agentAgency" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentStatus">Estado *</label>
                                <select id="editAgentStatus" name="agentStatus" required>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeEditAgentModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Reservations Modal -->
    <div id="importReservationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header">
                <h2>📥 Importar Reservas desde Excel</h2>
                <button onclick="closeImportReservationsModal()" class="close-btn">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">
                    Selecciona un archivo Excel (.xlsx) con las reservas a importar. 
                    El archivo debe tener las columnas: <strong>Código, Cliente, Hotel, Fecha Entrada, Fecha Salida, Total</strong> (requeridos) y opcionalmente: Email, Teléfono, Fecha Registro, Agente, Estado.
                </p>
                <div style="margin-bottom: 20px;">
                    <label for="importFileInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Seleccionar archivo Excel:
                    </label>
                    <input type="file" id="importFileInput" accept=".xlsx,.xls" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>⚠️ Nota:</strong> Las reservas con códigos duplicados serán actualizadas. Las nuevas se agregarán.
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeImportReservationsModal()" class="form-button secondary">Cancelar</button>
                    <button type="button" onclick="processImportFile()" class="form-button" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flexi Program Section -->
            <div id="flexi-section" style="display: none;">
                <h2 class="page-title">🎫 Programa Flexi - Gestión de Vouchers</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="openNewFlexiProgramModal()" style="background: #9c27b0; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add_circle</span>
                        Nuevo Programa
                    </button>
                    <button class="form-button" onclick="openEmitVoucherModal()" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        Emitir Voucher
                    </button>
                    <button class="form-button" onclick="openRegisterCanjeModal()" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">swap_horiz</span>
                        Registrar Canje
                    </button>
                    <button class="form-button secondary" onclick="exportFlexiVouchers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar
                    </button>
                    <button class="form-button secondary" onclick="refreshFlexiData()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">card_giftcard</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalFlexiVouchers">0</h3>
                                <p>Vouchers Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeFlexiVouchers">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ff9800;">
                                <span class="material-icons">hourglass_empty</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="partialFlexiVouchers">0</h3>
                                <p>Parcialmente Usados</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2196f3;">
                                <span class="material-icons">done_all</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="usedFlexiVouchers">0</h3>
                                <p>Completamente Usados</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">event_busy</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="expiredFlexiVouchers">0</h3>
                                <p>Vencidos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #607d8b;">
                                <span class="material-icons">confirmation_number</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalCuposDisponibles">0</h3>
                                <p>Cupos Disponibles</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Card: Cómo funciona el Programa Flexi -->
                <div class="activity-card" style="margin-bottom: 24px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #9c27b0;">
                    <h3 class="card-title" style="color: #7b1fa2; margin-bottom: 12px;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">info</span>
                        ¿Cómo funciona el Programa Flexi?
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">🗓️ Paso 1: Elegir Fechas</h4>
                            <p style="color: #666; font-size: 14px;">El cliente selecciona fechas de Check-in y Check-out dentro del Periodo de Uso del voucher.</p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">📞 Paso 2: Solicitar Canje</h4>
                            <p style="color: #666; font-size: 14px;">El cliente contacta al equipo con: Código de Voucher, Hotel, Fechas y Número de Personas.</p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">✅ Paso 3: Confirmación</h4>
                            <p style="color: #666; font-size: 14px;">El equipo verifica disponibilidad, registra el canje y envía confirmación al cliente.</p>
                        </div>
                    </div>
                </div>

                <!-- Programs Table -->
                <div class="activity-card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">📋 Programas Flexi Disponibles</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f3e5f5; border-bottom: 2px solid #ce93d8;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos/Voucher</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Precio USD</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Periodo de Uso</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiProgramsTableBody">
                                <!-- Los programas se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vouchers Table -->
                <div class="activity-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">🎫 Vouchers Emitidos</h3>
                        <div style="position: relative; width: 300px;">
                            <input 
                                type="text" 
                                id="flexiVoucherSearchInput" 
                                placeholder="Buscar por código, cliente, hotel..." 
                                style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                onkeyup="filterFlexiVouchers(this.value)"
                            >
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">🔍</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Código Voucher</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Periodo de Uso</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiVouchersTableBody">
                                <!-- Los vouchers se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Canjes History Table -->
                <div class="activity-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">📜 Historial de Canjes</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #fff3e0; border-bottom: 2px solid #ffcc80;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Voucher</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Fechas Estadía</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Personas</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos Usados</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiCanjesTableBody">
                                <!-- Los canjes se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

    <!-- Users Section -->
            <div id="users-section" style="display: none;">
                <h2 class="page-title">Gestión de Usuarios</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="showImportUsersModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="exportUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="refreshUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" style="background: #9c27b0; color: white;" onclick="restoreUsersFromSupabase()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_download</span>
                        Restaurar de Supabase
                    </button>
                    <button class="form-button" style="background: #ff9800; color: white;" onclick="updateUsersFromReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                        Desde Reservas
                    </button>
                    <button class="form-button" style="background: #e91e63; color: white;" onclick="removeDuplicateUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">filter_alt</span>
                        Quitar Duplicados
                    </button>
                    <button class="form-button" style="background: #673ab7; color: white;" onclick="mergeDuplicateUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">merge</span>
                        Fusionar Duplicados
                    </button>
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showMarketingTools()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">campaign</span>
                        Herramientas Marketing
                    </button>
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="showUserAnalytics()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                        Análisis Usuarios
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">person_add</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="newUsers">0</h3>
                                <p>Nuevos este mes</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                            <span class="material-icons">receipt</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalQuotes">0</h3>
                                <p>Total Cotizaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">star</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="avgUserRating">0.0</h3>
                                <p>Calificación Promedio</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="activity-card">
                    <h3 class="card-title">Usuarios Registrados - Panel de Administración</h3>
                    
                    <!-- Buscador de usuarios -->
                    <div style="margin-bottom: 16px; margin-top: 16px; position: relative; z-index: 1;">
                        <div style="position: relative; z-index: 1; max-width: 100%;">
                            <input type="text" id="usersSearchInput" placeholder="Buscar usuarios por nombre, email o teléfono..." 
                                   style="width: 100%; max-width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; position: relative; z-index: 1; box-sizing: border-box;"
                                   onkeyup="searchUsers()" oninput="searchUsers()">
                            <span class="material-icons" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; z-index: 2;">search</span>
                        </div>
                        <div id="usersSearchInfo" style="margin-top: 8px; font-size: 0.85rem; color: #666; display: none;">
                            <span id="usersSearchCount">0</span> resultados encontrados
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Teléfono</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cotizaciones</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Última Actividad</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Marketing</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Agents Section -->
            <div id="agents-section" style="display: none;">
                <h2 class="page-title">👥 Gestión de Agentes</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="addNewAgent()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Agente
                    </button>
                    <button class="form-button secondary" onclick="refreshAgents()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">support_agent</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAgents">0</h3>
                                <p>Total Agentes</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2196f3;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeAgents">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">cancel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="inactiveAgents">0</h3>
                                <p>Inactivos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agents Table -->
                <div class="activity-card">
                    <h3 class="card-title">Lista de Agentes</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Código</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Agencia</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Reservas</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Fecha Creación</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody">
                                <!-- Los agentes se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Interactions Section -->
            <div id="interactions-section" style="display: none;">
                <h2 class="page-title">Interacciones con Flor</h2>
                
                <!-- Información sobre el Aprendizaje -->
                <div class="stat-card" style="margin-bottom: 24px; background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); border-left: 4px solid #2196f3;">
                    <div style="padding: 20px;">
                        <h3 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.5rem;">🧠</span>
                            Sistema de Aprendizaje de Flor IA
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
                            <div>
                                <strong style="color: #1976d2;">📚 Fuentes de Conocimiento:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #555; font-size: 0.9rem;">
                                    <li>Información de cada hotel (pestaña Conocimiento)</li>
                                    <li>Interacciones previas con usuarios</li>
                                    <li>Patrones de conversación exitosos</li>
                                    <li>Palabras clave y contextos comunes</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #1976d2;">🔄 Proceso de Aprendizaje:</strong>
                                <ul style="margin: 8px 0 0 20px; color: #555; font-size: 0.9rem;">
                                    <li>Guarda cada interacción automáticamente</li>
                                    <li>Analiza respuestas exitosas vs fallidas</li>
                                    <li>Identifica intents más comunes</li>
                                    <li>Mejora respuestas basándose en el historial</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas de Aprendizaje -->
                <div id="interactions-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card" style="text-align: center; padding: 20px;">
                        <div id="stat-total-interactions" style="font-size: 2rem; font-weight: 700; color: #1976d2;">0</div>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 4px;">Total Interacciones</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px;">
                        <div id="stat-success-rate" style="font-size: 2rem; font-weight: 700; color: #4caf50;">0%</div>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 4px;">Tasa de Éxito</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px;">
                        <div id="stat-common-intents" style="font-size: 2rem; font-weight: 700; color: #ff9800;">0</div>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 4px;">Intents Únicos</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px;">
                        <div id="stat-ai-responses" style="font-size: 2rem; font-weight: 700; color: #9c27b0;">0</div>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 4px;">Respuestas IA</div>
                    </div>
                </div>

                <!-- Análisis de Aprendizaje -->
                <div class="stat-card" style="margin-bottom: 24px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #e0e0e0;">
                        <h3 style="margin: 0; font-size: 1.2rem;">📊 Análisis de Aprendizaje</h3>
                        <button class="form-button secondary" onclick="analyzeFlorLearning()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                            Analizar
                        </button>
                    </div>
                    <div id="learning-analysis" style="padding: 16px;">
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Haz clic en "Analizar" para ver el análisis de aprendizaje de Flor
                        </p>
                    </div>
                </div>
                
                <!-- Historial de Conversaciones -->
                <div class="stat-card" style="margin-bottom: 24px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">💬 Historial de Conversaciones</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="form-button secondary" onclick="exportInteractions()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                                Exportar
                            </button>
                            <button class="form-button secondary" onclick="loadInteractions()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                                Actualizar
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 12px; text-align: left;">Fecha</th>
                                    <th style="padding: 12px; text-align: left;">Cliente</th>
                                    <th style="padding: 12px; text-align: left;">Mensaje del Usuario</th>
                                    <th style="padding: 12px; text-align: center;">Intent</th>
                                    <th style="padding: 12px; text-align: center;">Estado</th>
                                    <th style="padding: 12px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="interactionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                        <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">chat</span>
                                        No hay interacciones registradas aún
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Chats Section -->
            <div id="chats-section" style="display: none;">
                <h2 class="page-title">Chats Activos</h2>
                
                <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: calc(100vh - 200px);">
                    <!-- Lista de Chats -->
                    <div class="stat-card" style="overflow-y: auto;">
                        <div style="padding: 16px; border-bottom: 1px solid #e0e0e0;">
                            <h3 style="margin: 0 0 12px 0; font-size: 1.1rem;">Conversaciones</h3>
                            <button class="form-button secondary" onclick="loadChats()" style="width: 100%;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                                Actualizar
                            </button>
                        </div>
                        <div id="chatsList" style="padding: 8px;">
                            <div style="text-align: center; padding: 40px 16px; color: #666;">
                                <span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span>
                                <p style="margin-top: 12px;">No hay chats activos</p>
                            </div>
                        </div>
                    </div>

                    <!-- Área de Chat -->
                    <div class="stat-card" style="display: flex; flex-direction: column;">
                        <div id="chatHeader" style="padding: 16px; border-bottom: 1px solid #e0e0e0; background: #f5f5f5;">
                            <h3 style="margin: 0; font-size: 1.1rem;">Selecciona un chat para ver la conversación</h3>
                        </div>
                        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: #fafafa;">
                            <p style="text-align: center; color: #666; margin-top: 60px;">
                                <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">question_answer</span>
                                Selecciona un chat de la lista para comenzar
                            </p>
                        </div>
                        <div id="chatInputContainer" style="padding: 16px; border-top: 1px solid #e0e0e0; display: none;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="chatMessageInput" placeholder="Escribe tu respuesta..." 
                                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;"
                                       onkeypress="if(event.key === 'Enter') sendChatMessage()">
                                <button class="form-button" style="background: #1976d2; color: white; padding: 12px 24px;" onclick="sendChatMessage()">
                                    <span class="material-icons" style="vertical-align: middle;">send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flor Configuration Section -->
            <div id="flor-config-section" style="display: none;">
                <h2 class="page-title">Configuración de Flor IA</h2>
                
                <!-- Tabs -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px;">
                    <button class="flor-tab active" onclick="showFlorTab('general')" data-tab="general">⚙️ General</button>
                    <button class="flor-tab" onclick="showFlorTab('knowledge')" data-tab="knowledge">📚 Conocimiento</button>
                    <button class="flor-tab" onclick="showFlorTab('responses')" data-tab="responses">💬 Respuestas</button>
                    <button class="flor-tab" onclick="showFlorTab('policies')" data-tab="policies">📋 Políticas</button>
                    <button class="flor-tab" onclick="showFlorTab('ai')" data-tab="ai">🤖 IA</button>
                    <button class="flor-tab" onclick="showFlorTab('whatsapp')" data-tab="whatsapp">📱 WhatsApp</button>
                </div>

                <!-- General Tab -->
                <div id="flor-tab-general" class="flor-tab-content active">
                    <!-- Configuración Básica -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">⚙️ Configuración General</h3>
                        <div style="display: grid; gap: 16px; max-width: 600px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Nombre del Agente</label>
                                <input type="text" id="flor-name" value="Flor" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Rol</label>
                                <input type="text" id="flor-role" value="Agente Multimodal de Conversación" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Mensaje de Bienvenida</label>
                                <textarea id="flor-greeting" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¡Hola! Soy Flor, tu asistente virtual de Checkin24hs. Puedo ayudarte con texto, audio o imágenes. ¿En qué puedo ayudarte hoy?</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Personalidad</label>
                                <input type="text" id="flor-personality" value="Amable, eficiente y profesional" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Capacidades Multimodales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">🖼️ Capacidades Multimodales</h3>
                        <p style="color: #666; margin-bottom: 20px;">Flor puede procesar texto, audio e imágenes para responder consultas de forma más completa.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Protocolo de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">🎤</span> Protocolo de Audio
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="audio-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Habilitar recepción de audios</span>
                                    </label>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Duración máxima de audio (segundos)</label>
                                        <input type="number" id="audio-max-duration" value="45" min="10" max="120" style="width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                        <span style="font-size: 0.85rem; color: #666; margin-left: 8px;">Recomendado: 45 seg</span>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0;">
                                        📋 <strong>Comportamiento:</strong> El audio se transcribe a texto y se procesa como una consulta normal. Si excede el límite o es de mala calidad, se muestra el mensaje de fallback.
                                    </p>
                                </div>
                            </div>

                            <!-- Protocolo de Imágenes (Entrada) -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">📸</span> Protocolo de Imágenes (Entrada)
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="image-input-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Habilitar análisis de imágenes enviadas por clientes</span>
                                    </label>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0;">
                                        📋 <strong>Uso principal:</strong> Identificación de productos, tipos de habitaciones o problemas. La imagen se compara con la Base de Conocimiento para dar una respuesta relevante.
                                    </p>
                                    <div style="background: #fff3e0; padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                                        🔒 <strong>Seguridad:</strong> Las imágenes de clientes nunca se almacenan. Solo se usan para la respuesta inmediata.
                                    </div>
                                </div>
                            </div>

                            <!-- Protocolo de Envío de Imágenes (Salida) -->
                            <div style="background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #e91e63;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">📤</span> Protocolo de Envío de Imágenes (Salida)
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="image-output-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Permitir que Flor envíe imágenes proactivamente</span>
                                    </label>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0 0 8px 0;">
                                        📋 <strong>Condiciones de envío:</strong>
                                    </p>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: #555;">
                                        <li><strong>Solicitud visual:</strong> Cliente pregunta por apariencia de hotel/habitación</li>
                                        <li><strong>Documentación:</strong> Mapas de ubicación, infografías de servicios</li>
                                    </ul>
                                    <div style="margin-top: 8px;">
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Endpoint de imágenes (API)</label>
                                        <input type="text" id="image-api-endpoint" value="/api/hoteles/imagen/{nombre_hotel}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón Guardar -->
                    <div class="stat-card" style="padding: 24px;">
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveFlorGeneral()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Configuración General
                        </button>
                    </div>
                </div>

                <!-- Knowledge Tab -->
                <div id="flor-tab-knowledge" class="flor-tab-content" style="display: none;">
                    <!-- Info Banner -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px 20px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">🔄</span>
                        <div>
                            <strong>Conocimiento Sincronizado</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.9rem; color: #1565c0;">La información básica se sincroniza automáticamente desde la sección <strong>Hoteles</strong>. Aquí puedes agregar información adicional específica para Flor.</p>
                        </div>
                    </div>

                    <!-- Selector de Hotel -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">📚 Base de Conocimiento por Hotel</h3>
                        <div style="margin-bottom: 24px;">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">🏨 Seleccionar Hotel:</label>
                            <select id="knowledge-hotel-selector" style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="loadSelectedHotelKnowledge()">
                                <option value="">-- Seleccione un hotel --</option>
                            </select>
                        </div>
                        
                        <!-- Contenedor principal de conocimiento -->
                        <div id="hotels-knowledge-list">
                            <p style="color: #666; text-align: center; padding: 40px;">Seleccione un hotel para ver/editar su base de conocimiento</p>
                        </div>
                    </div>
                </div>

                <!-- Responses Tab -->
                <div id="flor-tab-responses" class="flor-tab-content" style="display: none;">
                    <!-- Respuestas Generales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">💬 Respuestas Generales</h3>
                        <div style="display: grid; gap: 16px; max-width: 700px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Cuando no entiende</label>
                                <textarea id="response-no-entendido" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Lo siento, no he podido entender tu consulta. ¿Podrías reformularla o prefieres que te conecte con un agente humano?</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Transferir a humano</label>
                                <textarea id="response-transferir" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Entendido, voy a transferirte con uno de nuestros agentes. Por favor espera un momento.</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Despedida</label>
                                <textarea id="response-despedida" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¡Gracias por contactarnos! Si tienes más preguntas, estaré aquí para ayudarte. ¡Hasta pronto!</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Respuestas Multimodales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">🖼️ Respuestas Multimodales</h3>
                        <p style="color: #666; margin-bottom: 20px;">Mensajes que Flor usará cuando reciba audio o imágenes con problemas.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Fallback de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>🎤</span> Fallback de Audio
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Audio muy largo o de mala calidad</label>
                                        <textarea id="response-audio-fallback" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Disculpa, el audio no fue del todo claro. Para atenderte con la rapidez que mereces, ¿podrías enviarme tu consulta por escrito, o prefieres que te conecte con un agente ahora mismo?</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Audio procesándose</label>
                                        <textarea id="response-audio-processing" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Un momento, estoy escuchando tu mensaje de voz... 🎧</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Fallback de Imágenes -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>📸</span> Fallback de Imágenes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen no reconocida</label>
                                        <textarea id="response-image-fallback" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">No pude identificar claramente la imagen. ¿Podrías describirme qué estás buscando o enviar otra foto con mejor iluminación?</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen procesándose</label>
                                        <textarea id="response-image-processing" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Un momento, estoy analizando la imagen... 🔍</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen de hotel identificada</label>
                                        <textarea id="response-image-hotel-found" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¡Reconozco esa imagen! Se trata de {nombre_hotel}. Te cuento más sobre este hotel:</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Respuestas de Envío de Imágenes -->
                            <div style="background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>📤</span> Envío de Imágenes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Antes de enviar imagen de hotel</label>
                                        <textarea id="response-image-sending" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Aquí te muestro una foto de {nombre_hotel}:</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen no disponible</label>
                                        <textarea id="response-image-not-available" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Lo siento, no tengo imágenes disponibles de este hotel en este momento. ¿Te gustaría que te conecte con un agente que pueda mostrarte fotos?</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón Guardar -->
                    <div class="stat-card" style="padding: 24px;">
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveFlorResponses()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Todas las Respuestas
                        </button>
                    </div>
                </div>

                <!-- Policies Tab -->
                <div id="flor-tab-policies" class="flor-tab-content" style="display: none;">
                    <!-- Políticas por Hotel -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">🏨 Políticas por Hotel</h3>
                        <div style="margin-bottom: 24px;">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Seleccionar Hotel:</label>
                            <select id="policy-hotel-select" style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="loadHotelPolicies()">
                                <option value="">-- Seleccione un hotel --</option>
                            </select>
                        </div>
                        <div id="hotel-policies-form" style="display: none; max-width: 700px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Condiciones para la Reserva</label>
                                <textarea id="policy-condiciones-reserva" rows="5" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Ej: Se requiere un depósito del 30% para confirmar..."></textarea>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Políticas de Cancelación</label>
                                <textarea id="policy-cancelacion-modificacion" rows="5" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Ej: Cancelación gratuita hasta 72 horas antes..."></textarea>
                            </div>
                            <button class="form-button" style="background: #4caf50; color: white;" onclick="saveFlorPolicies()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                                Guardar Políticas del Hotel
                            </button>
                        </div>
                    </div>

                    <!-- Políticas de Privacidad Multimedia -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">🔒 Políticas de Privacidad Multimedia</h3>
                        <p style="color: #666; margin-bottom: 20px;">Reglas de seguridad para el manejo de archivos multimedia de clientes.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Política de Imágenes -->
                            <div style="background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #f44336;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>📸</span> Política de Imágenes de Clientes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-store-images" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No almacenar imágenes de clientes</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Las imágenes enviadas por clientes (personas, documentos) solo se usan para la respuesta inmediata y nunca se guardan.</p>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-share-images" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No compartir imágenes con terceros</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Las imágenes de clientes nunca se comparten con servicios externos excepto para su análisis inmediato.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Política de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>🎤</span> Política de Audios de Clientes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-store-audio" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No almacenar grabaciones de voz</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Los audios se transcriben a texto y se eliminan inmediatamente. Solo se guarda la transcripción para la conversación.</p>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-audio-privacy" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">Transcripción privada</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">La transcripción de audio se procesa de forma segura y no se usa para entrenamiento de modelos.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Reglas de Envío de Imágenes -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>📤</span> Reglas de Envío de Imágenes
                                </h4>
                                <p style="font-size: 0.9rem; color: #555; margin-bottom: 12px;">
                                    Flor solo enviará imágenes bajo estas condiciones:
                                </p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.9rem; color: #555;">
                                    <li style="margin-bottom: 8px;"><strong>Solicitud explícita:</strong> El cliente pregunta por la apariencia de un hotel o habitación</li>
                                    <li style="margin-bottom: 8px;"><strong>Documentación estándar:</strong> Mapas de ubicación, infografías de servicios pre-aprobadas</li>
                                    <li><strong>Contenido funcional:</strong> Las imágenes deben ser útiles, no decorativas</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje de Conformidad -->
                    <div class="stat-card" style="padding: 24px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 2rem;">✅</span>
                            <div>
                                <h4 style="margin: 0 0 4px 0;">Políticas de Privacidad Activas</h4>
                                <p style="margin: 0; color: #2e7d32; font-size: 0.9rem;">Las políticas de seguridad multimedia están habilitadas y no pueden ser desactivadas para proteger la privacidad de los clientes.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Tab -->
                <div id="flor-tab-ai" class="flor-tab-content" style="display: none;">
                    <div class="stat-card" style="padding: 24px;">
                        <h3 style="margin: 0 0 8px 0;">🤖 Configuración de Inteligencia Artificial</h3>
                        <p style="color: #666; margin-bottom: 24px;">Conecta Flor con una API de IA para respuestas más naturales e inteligentes.</p>
                        
                        <div style="max-width: 600px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="ai-enabled" onchange="toggleAIConfig()">
                                    <span style="font-weight: 500;">Habilitar respuestas con IA</span>
                                </label>
                            </div>

                            <div id="ai-config-fields" style="display: none;">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Proveedor</label>
                                    <select id="ai-provider" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="updateAIModel()">
                                        <option value="gemini">Google Gemini - GRATIS</option>
                                        <option value="openai">OpenAI (GPT-4) - Pago</option>
                                        <option value="claude">Claude (Anthropic) - Pago</option>
                                    </select>
                                    <p style="font-size: 0.8rem; color: #666; margin-top: 4px;">💡 Gemini es gratis con límites generosos</p>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">API Key</label>
                                    <input type="password" id="ai-api-key" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Tu API key...">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Modelo</label>
                                    <input type="text" id="ai-model" value="gemini-2.5-flash" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                    <p id="ai-model-help" style="font-size: 0.8rem; color: #666; margin-top: 4px;">Modelos: gemini-2.5-flash (recomendado), gemini-2.0-flash, gemini-2.5-pro</p>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Temperature</label>
                                        <input type="number" id="ai-temperature" value="0.7" min="0" max="2" step="0.1" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                        <p style="font-size: 0.8rem; color: #666; margin-top: 4px;">Balance creatividad/consistencia (0-2)</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Max Tokens</label>
                                        <input type="number" id="ai-max-tokens" value="500" min="100" max="4000" step="50" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                        <p style="font-size: 0.8rem; color: #666; margin-top: 4px;">Longitud máxima de respuesta</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="form-button" style="background: #4caf50; color: white;" onclick="saveAIConfig()">
                                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                                        Guardar
                                    </button>
                                    <button class="form-button secondary" onclick="testAIConfig()">
                                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">wifi</span>
                                        Probar Conexión
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Tab -->
                <div id="flor-tab-whatsapp" class="flor-tab-content" style="display: none;">
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">📱 Conectar Múltiples WhatsApp con IA</h3>
                        <p style="color: #666; margin-bottom: 24px;">
                            💡 <strong>Con IA Integrada:</strong> Cada número conectado utilizará Flor IA para responder automáticamente a los mensajes entrantes.
                        </p>
                        
                        <!-- Configuración del servidor -->
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">🔗 URL del Servidor WhatsApp:</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="whatsapp-server-url" 
                                    placeholder="http://72.61.58.240" 
                                    style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
                                    value="">
                                <button class="btn btn-secondary" onclick="saveWhatsAppServerUrl()" style="white-space: nowrap;">
                                    Guardar
                                </button>
                            </div>
                            <small style="color: #666; display: block; margin-top: 8px;">
                                URL base del servidor (sin puerto). Los servicios están en los puertos 3001, 3002, 3003 y 3004.
                            </small>
                        </div>
                        
                        <div id="whatsapp-cards-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Las tarjetas de WhatsApp se cargarán dinámicamente aquí -->
                        </div>
                    </div>
                </div>
                
                <!-- Modal para mostrar QR Code -->
                <div id="whatsapp-qr-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">📱 Conectar WhatsApp <span id="qr-modal-instance">1</span></h3>
                            <button onclick="closeWhatsAppQRModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        <div id="qr-modal-content" style="text-align: center;">
                            <p style="color: #666; margin-bottom: 20px;">Escanea este código QR con WhatsApp:</p>
                            <div id="qr-code-container" style="margin: 20px 0; min-height: 256px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: #999;">Cargando QR...</p>
                            </div>
                            <div id="qr-status" style="margin-top: 20px; padding: 12px; border-radius: 6px; background: #fff3cd; color: #856404;">
                                Esperando escaneo...
                            </div>
                            <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                                <strong>📱 Instrucciones:</strong>
                                <ol style="margin: 10px 0 0 20px; color: #666;">
                                    <li>Abre WhatsApp en tu teléfono</li>
                                    <li>Ve a <strong>Configuración</strong> → <strong>Dispositivos vinculados</strong></li>
                                    <li>Toca <strong>Vincular un dispositivo</strong></li>
                                    <li>Escanea el código QR</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Administrators Section -->
            <div id="administrators-section" style="display: none;">
                <h2 class="page-title">Gestión de Administradores</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showNewAdminModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Administrador
                    </button>
                    <button class="form-button secondary" onclick="refreshAdmins()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Backup & Sync Section -->
                <div class="activity-card" style="margin-bottom: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 class="card-title" style="color: white; margin-bottom: 16px;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">backup</span>
                        Backup y Sincronización
                    </h3>
                    <p style="margin-bottom: 16px; opacity: 0.9;">Crea un punto de restauración de todos los datos del sistema o restaura desde un backup anterior.</p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="form-button" style="background: #4caf50; color: white;" onclick="createFullBackup()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_download</span>
                            Crear Backup Completo
                        </button>
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="showRestoreBackupModal()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_upload</span>
                            Restaurar Backup
                        </button>
                        <button class="form-button" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="checkSyncStatus()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                            Estado de Sincronización
                        </button>
                        <button class="form-button" style="background: linear-gradient(135deg, #4caf50, #2e7d32); color: white;" onclick="syncAllTablesToSupabase()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_sync</span>
                            Sincronizar TODO
                        </button>
                    </div>
                    <div id="syncStatusIndicator" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                        <span id="syncStatusText"></span>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">admin_panel_settings</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdmins">0</h3>
                                <p>Total Administradores</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">verified_user</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsTotal">0</h3>
                                <p>Administradores Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">person</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsUser">0</h3>
                                <p>Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeAdmins">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Administrators Table -->
                <div class="activity-card">
                    <h3 class="card-title">Lista de Administradores</h3>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Rol</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Último Login</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Los administradores se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quotes Section -->
            <div id="quotes-section" style="display: none;">
                <h2 class="page-title">Gestión de Cotizaciones</h2>
                
                <!-- Estadísticas de Cotizaciones -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalQuotes">0</div>
                            <div class="stat-label">Total Cotizaciones</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏳</div>
                        <div class="stat-content">
                            <div class="stat-number" id="pendingQuotes">0</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-number" id="processedQuotes">0</div>
                            <div class="stat-label">Procesadas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgQuotesPerDay">0</div>
                            <div class="stat-label">Promedio/Día</div>
                        </div>
                    </div>
                </div>

                <!-- Controles de Cotizaciones -->
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="openQuoteModalNew()" style="background: #28a745;">
                            <span class="material-icons">add</span>
                            Nueva Cotización
                        </button>
                        <button class="action-btn primary" onclick="showSendCotizadorLinkModal()" style="background: #25d366;">
                            <span class="material-icons">link</span>
                            Enviar Link Cotizador
                        </button>
                        <button class="action-btn primary" onclick="refreshQuotes()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                        <button class="action-btn secondary" onclick="exportQuotes()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn danger" onclick="clearAllQuotes()">
                            <span class="material-icons">delete_sweep</span>
                            Limpiar Todo
                        </button>
                        <button class="action-btn primary" onclick="testQuotesSync()">
                            <span class="material-icons">bug_report</span>
                            Probar Sincronización
                        </button>
                        <input type="file" id="quoteImageUpload" accept="image/*" style="display: none;" onchange="handleQuoteImageUpload(event)">
                        <button class="action-btn primary" onclick="document.getElementById('quoteImageUpload').click()" style="background: #9c27b0;">
                            <span class="material-icons">image</span>
                            Subir Imagen
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="quotesSearch" placeholder="Buscar cotizaciones..." onkeyup="filterQuotes()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Tabla de Cotizaciones -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hotel</th>
                                <th>Cliente</th>
                                <th>Fechas</th>
                                <th>Huéspedes</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="quotesTableBody">
                            <!-- Las cotizaciones se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay cotizaciones -->
                <div id="noQuotesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">📋</div>
                    <h3>No hay cotizaciones</h3>
                    <p>Las cotizaciones enviadas desde el sitio web aparecerán aquí automáticamente.</p>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses-section" style="display: none;">
                <h2 class="page-title">Gestión de Gastos</h2>
                
                <!-- KPIs de Eficiencia de Costos -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #d32f2f;">
                                <span class="material-icons">trending_down</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpaValue">$0</h3>
                                <p>Costo por Adquisición (CPA)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpaSubtitle">Gasto Marketing / Reservas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f57c00;">
                                <span class="material-icons">phone</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpcValue">$0</h3>
                                <p>Costo por Llamada (CPC)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpcSubtitle">Costos Telecom + Agentes / Llamadas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">account_balance</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalExpenses">$0</h3>
                                <p>Gastos Totales</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="totalExpensesSubtitle">Fijos + Variables</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #388e3c;">
                                <span class="material-icons">compare_arrows</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="budgetVariance">0%</h3>
                                <p>Variación Presupuesto</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="budgetVarianceSubtitle">Real vs Presupuestado</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalExpensesUSD" style="color: #2e7d32;">$0</h3>
                                <p>Acumulado en Dólares (USD)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">currency_exchange</span>
                            <span id="totalExpensesUSDSubtitle">Tipo de cambio: $1 USD</span>
                        </div>
                    </div>
                </div>

                <!-- Controles de Gastos -->
                <div class="action-bar" style="margin-bottom: 24px;">
                    <div class="action-buttons" style="flex-wrap: wrap;">
                        <button class="action-btn primary" onclick="addNewExpenseNew()">
                            <span class="material-icons">add</span>
                            Agregar Gasto
                        </button>
                        <button class="action-btn secondary" onclick="exportExpenses()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn secondary" onclick="refreshExpenses()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                        <button class="action-btn secondary" onclick="openMassUpdateExchangeRate()" style="background: #ff9800; color: white;">
                            <span class="material-icons">currency_exchange</span>
                            Actualizar TC Masivo
                        </button>
                        <button class="action-btn secondary" onclick="cleanDuplicateExpenses()" style="background: #d32f2f; color: white; border: 2px solid #b71c1c;">
                            <span class="material-icons">cleaning_services</span>
                            🧹 Limpiar Duplicados
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="expensesSearch" placeholder="Buscar gastos..." onkeyup="filterExpenses()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Grid de Gráficos y Tabla -->
                <div class="dashboard-grid">
                    <!-- Gráfico de Composición de Gastos (Pie Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Composición del Gasto</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="expensesCompositionChart"></canvas>
                        </div>
                        <div id="expensesCompositionLegend" style="margin-top: 16px; display: flex; justify-content: center; flex-wrap: wrap; gap: 16px;">
                            <!-- Leyenda se generará dinámicamente -->
                        </div>
                    </div>

                    <!-- Gráfico de Desglose de Gastos Variables (Bar Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Desglose de Gastos Variables</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="variableExpensesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Gasto vs Presupuesto (Line Chart) -->
                <div class="chart-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin: 0;">Gasto vs Presupuesto</h3>
                        <div style="display: flex; gap: 12px;">
                            <select id="budgetPeriodFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;" onchange="updateBudgetChart()">
                                <option value="monthly">Mensual</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                    </div>
                    <div style="position: relative; height: 350px;">
                        <canvas id="budgetComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Tabla de Gastos -->
                <div class="table-container" style="margin-top: 24px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Categoría</th>
                                <th>Subcategoría</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Monto</th>
                                <th>Tipo de Cambio</th>
                                <th>USD</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Los gastos se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay gastos -->
                <div id="noExpensesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">💰</div>
                    <h3>No hay gastos registrados</h3>
                    <p>Agrega gastos para comenzar a analizar los costos del call center.</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Agregar/Editar Hotel - NUEVO Y LIMPIO -->
    <div id="editHotelModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 85vh; overflow-y: auto;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 class="modal-title" id="editHotelModalTitle">🏨 Agregar Nuevo Hotel</h2>
            
            <form id="editHotelForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Columna Izquierda -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Nombre del Hotel *</label>
                            <input type="text" class="form-input" id="editHotelName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ubicación *</label>
                            <input type="text" class="form-input" id="editHotelLocation" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📍 Ubicación Google Maps</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelGoogleMaps" placeholder="https://maps.google.com/?q=..." style="flex: 1;">
                                <button type="button" class="form-button secondary" onclick="openGoogleMapsHelp()" style="white-space: nowrap;" title="Ayuda">
                                    <span class="material-icons" style="font-size: 16px;">help</span>
                                </button>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                💡 <strong>Tip:</strong> Busca el hotel en Google Maps, haz clic en "Compartir" y copia el enlace
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🌐 Sitio Web del Hotel</label>
                            <input type="url" class="form-input" id="editHotelWebsite" placeholder="https://www.nombrehotel.com">
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                🤖 <strong>Flor IA</strong> usará esta URL para obtener información adicional
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Calificación (1-5)</label>
                            <input type="number" class="form-input" id="editHotelRating" min="1" max="5" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rango de Precio</label>
                            <input type="text" class="form-input" id="editHotelPrice" placeholder="$150-$300 USD">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categoría de Precio</label>
                            <select class="form-input" id="editHotelPriceRange">
                                <option value="low">Bajo</option>
                                <option value="medium">Medio</option>
                                <option value="high">Alto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-input" id="editHotelStatus">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Imagen Principal *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelImage" placeholder="Selecciona una imagen" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para imagen principal -->
                                <input type="file" id="mainImageFileInput" accept="image/*" style="display: none;" onchange="handleMainImageUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('mainImageFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('main')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editImagePreview" style="margin-top: 10px; min-height: 50px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Galería de Fotos</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelPhotos" placeholder="Selecciona imágenes para la galería" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para galería -->
                                <input type="file" id="galleryImagesFileInput" accept="image/*" multiple style="display: none;" onchange="handleGalleryImagesUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('galleryImagesFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('gallery')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editPhotosPreview" style="margin-top: 10px; min-height: 50px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descripción Breve</label>
                            <textarea class="form-input" id="editHotelDescription" rows="2" placeholder="Descripción corta del hotel"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amenities (separadas por comas)</label>
                            <input type="text" class="form-input" id="editHotelAmenities" placeholder="Spa, Restaurante, WiFi, Parking">
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Información para Flor IA -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e8f5e9, #f3e5f5); border-radius: 12px; border: 2px solid #9c27b0;">
                    <h3 style="margin: 0 0 15px 0; color: #7b1fa2; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">🤖</span> Información para Flor IA
                        <span style="font-size: 12px; background: #9c27b0; color: white; padding: 3px 8px; border-radius: 10px;">Flor usará estos datos</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Columna Izquierda -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">📝 Descripción Detallada</label>
                                <textarea class="form-input" id="editHotelFlorDescription" rows="4" 
                                    placeholder="Descripción completa del hotel para que Flor pueda contarle a los clientes...
Ej: Hotel boutique de lujo con vistas al lago. Ideal para parejas y familias que buscan una experiencia única en la Patagonia."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">🏊 Servicios e Instalaciones</label>
                                <textarea class="form-input" id="editHotelFlorServices" rows="4" 
                                    placeholder="Lista detallada de servicios...
Ej:
• Spa con piscina climatizada y jacuzzi
• Restaurante gourmet con cocina local
• Bar con vista panorámica
• WiFi gratuito en todas las áreas
• Estacionamiento privado"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">🎿 Excursiones y Actividades</label>
                                <textarea class="form-input" id="editHotelFlorExcursions" rows="4" 
                                    placeholder="Actividades disponibles...
Ej:
• Trekking por el bosque nativo ($45 USD)
• Paseo en kayak por el lago ($60 USD)
• Avistamiento de aves (incluido)
• Esquí en temporada (traslado incluido)
• Canopy y tirolesa ($80 USD)"></textarea>
                            </div>
                        </div>
                        
                        <!-- Columna Derecha -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">💰 Información de Precios</label>
                                <textarea class="form-input" id="editHotelFlorPrices" rows="4" 
                                    placeholder="Tarifas y precios...
Ej:
• Habitación Doble: $180-$250 USD/noche
• Suite Familiar: $320-$400 USD/noche
• Todo Incluido disponible: +$80 USD/persona
• Niños menores de 5 años: Gratis
• Temporada alta: +30%"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">📋 Políticas del Hotel</label>
                                <textarea class="form-input" id="editHotelFlorPolicies" rows="4" 
                                    placeholder="Políticas importantes...
Ej:
• Check-in: 15:00 hrs / Check-out: 11:00 hrs
• Cancelación gratuita hasta 48 hrs antes
• Se aceptan mascotas pequeñas (+$30 USD)
• Depósito de garantía: $100 USD
• All-inclusive: desayuno, almuerzo y cena"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">🚗 Cómo Llegar</label>
                                <textarea class="form-input" id="editHotelFlorTransport" rows="4" 
                                    placeholder="Información de transporte...
Ej:
• A 2 horas del aeropuerto de Temuco
• Transfer desde aeropuerto: $80 USD (ida y vuelta)
• Bus desde Santiago: 12 horas, terminal Panguipulli
• Coordenadas GPS: -39.8500, -71.9000
• Ruta pavimentada hasta el hotel"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">📞 Información de Contacto</label>
                        <textarea class="form-input" id="editHotelFlorContact" rows="2" 
                            placeholder="Teléfono: +56 9 1234 5678 | Email: reservas@hotel.com | WhatsApp: +56 9 1234 5678"></textarea>
                    </div>
                </div>
                
                <!-- Base de Conocimiento Adicional (Expandible) -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 12px; border: 2px solid #2196f3;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="toggleKnowledgeSection()">
                        <h3 style="margin: 0; color: #1565c0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">📚</span> Base de Conocimiento Adicional
                            <span style="font-size: 12px; background: #2196f3; color: white; padding: 3px 8px; border-radius: 10px;">Opcional</span>
                        </h3>
                        <span id="knowledgeToggleIcon" class="material-icons" style="color: #1565c0; transition: transform 0.3s;">expand_more</span>
                    </div>
                    
                    <div id="knowledgeAdditionalSection" style="display: none;">
                        <p style="font-size: 0.9rem; color: #1565c0; margin-bottom: 20px;">
                            💡 Esta información adicional complementa la información básica y ayuda a Flor a dar respuestas más detalladas y personalizadas.
                        </p>
                        
                        <div style="display: grid; gap: 16px;">
                            <div>
                                <label class="form-label" style="color: #1565c0;">📝 Descripción Detallada para Flor</label>
                                <textarea class="form-input" id="editHotelKnowledgeDescription" rows="4" 
                                    placeholder="Descripción ampliada que Flor usará para responder consultas. Ejemplo: características únicas, ambiente, qué hace especial a este hotel..."></textarea>
                            </div>
                            
                            <div>
                                <label class="form-label" style="color: #1565c0;">🎯 Detalle de Servicios para Flor</label>
                                <textarea class="form-input" id="editHotelKnowledgeServicesDetail" rows="4" 
                                    placeholder="Información detallada de servicios. Ejemplo: horarios de spa, tipo de comida en restaurante, actividades disponibles..."></textarea>
                            </div>
                            
                            <div>
                                <label class="form-label" style="color: #1565c0;">💰 Información de Precios para Flor</label>
                                <textarea class="form-input" id="editHotelKnowledgePricing" rows="3" 
                                    placeholder="Información de tarifas. Ejemplo: temporada alta/baja, promociones, qué incluye el precio..."></textarea>
                            </div>
                            
                            <div>
                                <label class="form-label" style="color: #1565c0;">🚗 Cómo Llegar / Transporte</label>
                                <textarea class="form-input" id="editHotelKnowledgeTransport" rows="3" 
                                    placeholder="Información de transporte. Ejemplo: distancia desde aeropuerto, transfers disponibles, acceso en auto..."></textarea>
                            </div>
                            
                            <div>
                                <label class="form-label" style="color: #1565c0;">📋 Notas Adicionales</label>
                                <textarea class="form-input" id="editHotelKnowledgeNotes" rows="3" 
                                    placeholder="Cualquier otra información relevante que Flor deba saber..."></textarea>
                            </div>
                            
                            <div>
                                <label class="form-label" style="color: #1565c0;">🌐 Información Adicional del Sitio Web</label>
                                <textarea class="form-input" id="editHotelKnowledgeWebsiteInfo" rows="3" 
                                    placeholder="Información adicional opcional que no está en la web: promociones especiales, políticas internas, datos de contacto directos..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones -->
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="form-button secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="form-button" onclick="saveHotelChanges()" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                        💾 Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal del Carrusel de Fotos -->
    <div id="photoCarouselModal" class="modal">
                        <div class="modal-content" style="max-width: 85vw; max-height: 85vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; width: 100%; height: 100%;">
                <!-- Botón cerrar -->
                <button class="close" onclick="closePhotoCarousel()" style="position: absolute; top: 20px; right: 20px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">&times;</button>
                
                <!-- Imagen principal -->
                <div id="carouselImageContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9);">
                    <img id="carouselImage" src="" alt="Foto" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
                </div>
                
                <!-- Controles de navegación -->
                <button id="prevButton" onclick="previousPhoto()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">‹</button>
                <button id="nextButton" onclick="nextPhoto()" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">›</button>
                
                <!-- Indicador de posición -->
                <div id="photoCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1001;"></div>
                
                <!-- Miniaturas -->
                <div id="carouselThumbnails" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001; max-width: 80%; overflow-x: auto; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal del Gestor de Imágenes -->
    <div id="imageManagerModal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;">📸 Gestor de Imágenes - <span id="currentHotelName">Nuevo Hotel</span></h2>
                <button onclick="closeImageManagerSimple()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 35px; height: 35px; line-height: 35px;">&times;</button>
            </div>
            
            <!-- Sección de Subir Imágenes -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">📤 Subir Imágenes desde tu Disco Duro</h3>
                
                <!-- Input de archivo oculto -->
                <input 
                    type="file" 
                    id="imageUploadInput" 
                    multiple 
                    accept="image/*" 
                    style="display: none;"
                    onchange="handleFileSelection(event)">
                
                <!-- Botón grande y visible para seleccionar archivos -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <button 
                        type="button" 
                        id="selectFilesButton"
                        onclick="
                            console.log('🔵 Botón de seleccionar archivos clickeado');
                            const input = document.getElementById('imageUploadInput');
                            if (input) {
                                console.log('Input encontrado, abriendo explorador...');
                                input.click();
                            } else {
                                console.error('Input imageUploadInput no encontrado');
                                alert('Error: No se puede abrir el explorador. Recarga la página.');
                            }
                        "
                        style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 20px 40px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 1.1rem;
                            font-weight: 600;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            min-width: 300px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                        <span class="material-icons" style="font-size: 28px;">folder_open</span>
                        <span>📁 Seleccionar Imágenes desde tu Disco Duro</span>
                    </button>
                </div>
                
                <!-- Información de archivos seleccionados -->
                <div id="selectedFilesInfo" style="display: none; margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                    <strong>📁 Archivos seleccionados:</strong> <span id="fileCount">0</span> imagen(es)
                </div>
                
                <!-- Botón para subir -->
                <div style="text-align: center;">
                    <button 
                        type="button" 
                        id="uploadButton"
                        onclick="uploadImagesSimple()"
                        disabled
                        style="
                            background: #4caf50;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            opacity: 0.5;
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                        ">
                        <span class="material-icons" style="font-size: 20px;">cloud_upload</span>
                        <span>Subir Imágenes</span>
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 0.9rem; color: #1565c0;">
                    <strong>💡 Información:</strong> Haz clic en el botón de arriba para abrir el explorador de archivos. Puedes seleccionar múltiples imágenes a la vez. Las imágenes se comprimirán automáticamente (máximo 10MB por imagen antes de comprimir).
                </div>
            </div>
            
            <!-- Vista Previa de Imágenes Subidas -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">🖼️ Imágenes Disponibles</h3>
                <div id="uploadedImagesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; min-height: 100px;">
                    <p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                        No hay imágenes subidas aún. Selecciona imágenes desde tu disco duro arriba.
                    </p>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="form-button secondary" onclick="closeImageManagerSimple()">
                    Cancelar
                </button>
                <button type="button" class="form-button" onclick="applyImageSelectionSimple()" style="background: #4caf50; color: white;">
                    Aplicar Selección
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODAL ANTIGUO DE GASTOS - ELIMINADO (usar expenseModalNew)
         ============================================
    <div id="expenseModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeExpenseModal()">&times;</span>
            <h2 class="modal-title" id="expenseModalTitle">Agregar Gasto</h2>
            <form id="expenseForm" onsubmit="saveExpense(event)">
                <div class="form-group">
                    <label class="form-label">Fecha *</label>
                    <input type="date" id="expenseDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Gasto *</label>
                    <select id="expenseType" class="form-input" required onchange="updateExpenseCategories()">
                        <option value="">Seleccionar tipo</option>
                        <option value="fixed">Fijo</option>
                        <option value="variable">Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoría *</label>
                    <select id="expenseCategory" class="form-input" required>
                        <option value="">Seleccionar categoría</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subcategoría</label>
                    <input type="text" id="expenseSubcategory" class="form-input" placeholder="Ej: Meta Ads, Google Ads, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción *</label>
                    <textarea id="expenseDescription" class="form-input" rows="3" required placeholder="Descripción detallada del gasto"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto *</label>
                    <input type="number" id="expenseAmount" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio *</label>
                    <input type="number" id="expenseExchangeRate" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">USD</label>
                    <input type="number" id="expenseUSD" class="form-input" step="0.01" min="0" placeholder="0.00" readonly style="background-color: #f5f5f5;">
                </div>
                
                <!-- Campo de Imagen/Comprobante -->
                <div class="form-group">
                    <label class="form-label">📷 Comprobante (opcional)</label>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <button type="button" class="form-button secondary" onclick="document.getElementById('expenseImageFile').click()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">upload_file</span>
                            Subir Archivo
                        </button>
                        <button type="button" class="form-button secondary" onclick="openCameraCapture()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">photo_camera</span>
                            Tomar Foto
                        </button>
                    </div>
                    <input type="file" id="expenseImageFile" accept="image/*" style="display: none;" onchange="previewExpenseImage(this)">
                    <div id="expenseImagePreview" style="display: none; margin-top: 12px; position: relative;">
                        <img id="expenseImagePreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeExpenseImage()" style="position: absolute; top: -8px; right: -8px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                    </div>
                    <input type="hidden" id="expenseImageUrl">
                    <input type="hidden" id="expenseImageName">
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeExpenseModal()">Cancelar</button>
                    <button type="submit" class="form-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Captura de Cámara -->
    <div id="cameraModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeCameraModal()">&times;</span>
            <h2 class="modal-title">📷 Capturar Comprobante</h2>
            <div style="text-align: center;">
                <video id="cameraVideo" autoplay playsinline style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button type="button" class="form-button secondary" onclick="closeCameraModal()">Cancelar</button>
                <button type="button" class="form-button" onclick="capturePhoto()" style="background: #4caf50;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">camera</span>
                    Capturar
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         NUEVO MODAL DE GASTOS - VERSIÓN SIMPLIFICADA
         ============================================ -->
    <div id="expenseModalNew" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 650px; position: relative; background: white; border-radius: 12px; padding: 24px;">
            <span class="close" onclick="closeExpenseModalNew()" style="position: absolute; top: 16px; right: 16px; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;">&times;</span>
            <h2 class="modal-title" id="expenseModalNewTitle" style="margin-top: 0; margin-bottom: 24px; color: #1976d2;">Agregar Gasto</h2>
            <form id="expenseFormNew" onsubmit="saveExpenseNew(event)">
                <div class="form-group">
                    <label class="form-label">Fecha *</label>
                    <input type="date" id="expenseDateNew" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Gasto *</label>
                    <select id="expenseTypeNew" class="form-input" required onchange="updateExpenseCategoriesNew()">
                        <option value="">Seleccionar tipo</option>
                        <option value="fixed">Fijo</option>
                        <option value="variable">Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categoría *</label>
                    <select id="expenseCategoryNew" class="form-input" required>
                        <option value="">Seleccionar categoría</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subcategoría</label>
                    <input type="text" id="expenseSubcategoryNew" class="form-input" placeholder="Ej: Meta Ads, Google Ads, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción *</label>
                    <textarea id="expenseDescriptionNew" class="form-input" rows="3" required placeholder="Descripción detallada del gasto"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto (ARS) *</label>
                    <input type="number" id="expenseAmountNew" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSDNew()">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio *</label>
                    <input type="number" id="expenseExchangeRateNew" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSDNew()">
                </div>
                <div class="form-group">
                    <label class="form-label">USD (calculado automáticamente)</label>
                    <input type="number" id="expenseUSDNew" class="form-input" step="0.01" min="0" placeholder="0.00" readonly style="background-color: #f5f5f5;">
                </div>
                
                <!-- Campo de Imagen/Comprobante -->
                <div class="form-group">
                    <label class="form-label">📷 Comprobante (opcional)</label>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <button type="button" class="form-button secondary" onclick="document.getElementById('expenseImageFileNew').click()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">upload_file</span>
                            Subir Archivo
                        </button>
                        <button type="button" class="form-button secondary" onclick="openCameraCaptureNew()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">photo_camera</span>
                            Tomar Foto
                        </button>
                    </div>
                    <input type="file" id="expenseImageFileNew" accept="image/*" style="display: none;" onchange="previewExpenseImageNew(this)">
                    <div id="expenseImagePreviewNew" style="display: none; margin-top: 12px; position: relative;">
                        <img id="expenseImagePreviewImgNew" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeExpenseImageNew()" style="position: absolute; top: -8px; right: -8px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                    </div>
                    <input type="hidden" id="expenseImageUrlNew">
                    <input type="hidden" id="expenseImageNameNew">
                </div>
                
                <input type="hidden" id="expenseIdNew">
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeExpenseModalNew()">Cancelar</button>
                    <button type="submit" class="form-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Captura de Cámara - NUEVO -->
    <div id="cameraModalNew" class="modal" style="display: none; z-index: 10001;">
        <div class="modal-content" style="max-width: 500px; position: relative; background: white; border-radius: 12px; padding: 24px;">
            <span class="close" onclick="closeCameraModalNew()" style="position: absolute; top: 16px; right: 16px; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;">&times;</span>
            <h2 class="modal-title" style="margin-top: 0; margin-bottom: 16px;">📷 Capturar Comprobante</h2>
            <div style="text-align: center;">
                <video id="cameraVideoNew" autoplay playsinline style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;"></video>
                <canvas id="cameraCanvasNew" style="display: none;"></canvas>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button type="button" class="form-button secondary" onclick="closeCameraModalNew()">Cancelar</button>
                <button type="button" class="form-button" onclick="capturePhotoNew()" style="background: #4caf50;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">camera</span>
                    Capturar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nueva Cotización -->
    <div id="newQuoteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeNewQuoteModal()">&times;</span>
            <h2 class="modal-title">📋 Nueva Cotización</h2>
            <form id="quoteForm" onsubmit="createAndSendQuote(event)">
                <div class="form-group">
                    <label class="form-label">Hotel *</label>
                    <select id="quoteHotel" class="form-input" required>
                        <option value="">Seleccionar hotel</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" id="quoteCheckIn" class="form-input" required onchange="calculateNights()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" id="quoteCheckOut" class="form-input" required onchange="calculateNights()">
                    </div>
                </div>
                
                <div id="nightsDisplay" style="padding: 10px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <strong>Noches: <span id="nightsCount">0</span></strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Adultos *</label>
                        <input type="number" id="quoteAdults" class="form-input" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niños</label>
                        <input type="number" id="quoteChildren" class="form-input" min="0" value="0" onchange="toggleChildrenAges()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Infantes</label>
                        <input type="number" id="quoteInfants" class="form-input" min="0" value="0">
                    </div>
                </div>
                
                <div id="childrenAgesContainer" style="display: none; margin-bottom: 15px;">
                    <label class="form-label">Edades de los niños</label>
                    <div id="childrenAgesInputs"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Módulo *</label>
                    <select id="quoteModule" class="form-input" required>
                        <option value="">Seleccionar módulo</option>
                        <option value="Nothofagus">Nothofagus</option>
                        <option value="Reino Fungi">Reino Fungi</option>
                        <option value="Montaña Magica">Montaña Magica</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Tarifa *</label>
                        <input type="number" id="quoteTariff" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descuento</label>
                        <input type="number" id="quoteDiscount" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tarifa Final</label>
                    <input type="number" id="quoteFinalTariff" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" value="0.00">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Se calcula automáticamente: Tarifa - Descuento
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas adicionales (opcional)</label>
                    <textarea id="quoteNotes" class="form-input" rows="3" placeholder="Agregar notas o comentarios adicionales para la cotización"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Número de WhatsApp del destinatario *</label>
                    <input type="tel" id="quotePhoneNumber" class="form-input" required 
                           placeholder="Ej: +56912345678 o 56912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el número de teléfono con código de país (ej: +56912345678). El mensaje se enviará directamente por WhatsApp Business API.
                    </small>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>📱 Envío directo por WhatsApp:</strong> La cotización se enviará automáticamente al número ingresado usando WhatsApp Business API. Asegúrate de tener configuradas las credenciales de WhatsApp Business.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeNewQuoteModal()">Cancelar</button>
                    <button type="submit" class="form-button">Crear y Enviar Cotización</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================
         NUEVO MODAL DE COTIZACIONES - VERSIÓN SIMPLIFICADA
         ============================================ -->
    <div id="quoteModalNew" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 750px; max-height: 90vh; overflow-y: auto; position: relative; background: white; border-radius: 12px; padding: 24px;">
            <span class="close" onclick="closeQuoteModalNew()" style="position: absolute; top: 16px; right: 16px; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;">&times;</span>
            <h2 class="modal-title" style="margin-top: 0; margin-bottom: 24px; color: #1976d2;">📋 Nueva Cotización</h2>
            <form id="quoteFormNew" onsubmit="createAndSendQuoteNew(event)">
                <div class="form-group">
                    <label class="form-label">Hotel *</label>
                    <select id="quoteHotelNew" class="form-input" required>
                        <option value="">Seleccionar hotel</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" id="quoteCheckInNew" class="form-input" required onchange="calculateNightsNew()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" id="quoteCheckOutNew" class="form-input" required onchange="calculateNightsNew()">
                    </div>
                </div>
                
                <div id="nightsDisplayNew" style="padding: 10px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <strong>Noches: <span id="nightsCountNew">0</span></strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Adultos *</label>
                        <input type="number" id="quoteAdultsNew" class="form-input" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niños</label>
                        <input type="number" id="quoteChildrenNew" class="form-input" min="0" value="0" onchange="toggleChildrenAgesNew()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Infantes</label>
                        <input type="number" id="quoteInfantsNew" class="form-input" min="0" value="0">
                    </div>
                </div>
                
                <div id="childrenAgesContainerNew" style="display: none; margin-bottom: 15px;">
                    <label class="form-label">Edades de los niños</label>
                    <div id="childrenAgesInputsNew"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Módulo *</label>
                    <select id="quoteModuleNew" class="form-input" required>
                        <option value="">Seleccionar módulo</option>
                        <option value="Nothofagus">Nothofagus</option>
                        <option value="Reino Fungi">Reino Fungi</option>
                        <option value="Montaña Magica">Montaña Magica</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Tarifa *</label>
                        <input type="number" id="quoteTariffNew" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateFinalTariffNew()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descuento</label>
                        <input type="number" id="quoteDiscountNew" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateFinalTariffNew()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tarifa Final</label>
                    <input type="number" id="quoteFinalTariffNew" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" value="0.00">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Se calcula automáticamente: Tarifa - Descuento
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas adicionales (opcional)</label>
                    <textarea id="quoteNotesNew" class="form-input" rows="3" placeholder="Agregar notas o comentarios adicionales para la cotización"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Número de WhatsApp del destinatario *</label>
                    <input type="tel" id="quotePhoneNumberNew" class="form-input" required 
                           placeholder="Ej: +56912345678 o 56912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el número de teléfono con código de país (ej: +56912345678). El mensaje se enviará directamente por WhatsApp Business API.
                    </small>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>📱 Envío directo por WhatsApp:</strong> La cotización se enviará automáticamente al número ingresado usando WhatsApp Business API. Asegúrate de tener configuradas las credenciales de WhatsApp Business.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeQuoteModalNew()">Cancelar</button>
                    <button type="submit" class="form-button">Crear y Enviar Cotización</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================
         FIN DE NUEVOS MODALES
         ============================================ -->

    <div style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px; align-items: center;">
                    <!-- Botón Configurar WhatsApp - ELIMINADO -->
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="form-button secondary" onclick="closeNewQuoteModal()">Cancelar</button>
                        <button type="submit" class="form-button" style="background: #25d366; color: white;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                            Crear y Enviar por WhatsApp
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Enviar Link del Cotizador -->
    <div id="sendCotizadorLinkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeSendCotizadorLinkModal()">&times;</span>
            <h2 class="modal-title">📱 Enviar Link del Cotizador</h2>
            <form id="sendLinkForm" onsubmit="sendCotizadorLink(event)">
                <div class="form-group">
                    <label class="form-label">Número de WhatsApp del Cliente *</label>
                    <input type="tel" id="linkPhoneNumber" class="form-input" required 
                           placeholder="Ej: +54912345678 o 54912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el número de teléfono con código de país
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mensaje Personalizado (Opcional)</label>
                    <textarea id="linkMessage" class="form-input" rows="3" 
                              placeholder="Hola! Te envío el link para que puedas solicitar tu cotización personalizada..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagen (Opcional)</label>
                    <input type="file" id="linkImageInput" class="form-input" accept="image/*" onchange="previewLinkImage(event)">
                    <div id="linkImagePreview" style="margin-top: 10px; display: none;">
                        <img id="linkImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <button type="button" onclick="removeLinkImage()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                    </div>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>ℹ️ Información:</strong> Se enviará un link único del cotizador. Cuando el cliente complete el formulario, la cotización aparecerá automáticamente como "Pendiente" en tu dashboard.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeSendCotizadorLinkModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #25d366; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                        Enviar Link por WhatsApp
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importar Usuarios -->
    <div id="importUsersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeImportUsersModal()">&times;</span>
            <h2 class="modal-title">📥 Importar Usuarios</h2>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Importa usuarios desde un archivo CSV o JSON. Los campos requeridos son: <strong>nombre</strong> y <strong>teléfono</strong> (o <strong>email</strong>).
                </p>
                
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <strong>⚠️ Validación de duplicados:</strong><br>
                        • Si el usuario tiene email: se mantiene el que se creó primero<br>
                        • Si el usuario no tiene email: se valida por teléfono y se mantiene el que ya estaba
                    </p>
                </div>
            </div>
            
            <form id="importUsersForm" onsubmit="importUsers(event)">
                <div class="form-group">
                    <label class="form-label">Seleccionar archivo *</label>
                    <input type="file" id="usersFile" class="form-input" accept=".csv,.json" required>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Formatos soportados: CSV, JSON
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Formato del archivo</label>
                    <select id="fileFormat" class="form-input" required>
                        <option value="auto">Detectar automáticamente</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                
                <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem;">Vista previa:</h3>
                    <div id="previewContent" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;"></div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeImportUsersModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #2196f3; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">upload</span>
                        Importar Usuarios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configuración de WhatsApp - ELIMINADO -->
    </div>
    <!-- Fin del contenido del Dashboard -->

    <script>
        // ============================================
        // CAMPOS DE IMAGEN - AHORA SON NECESARIOS, NO ELIMINAR
        // ============================================
        // NOTA: Este script anteriormente eliminaba los campos de imagen cada 100ms
        // Ahora los campos son necesarios para subir fotos reales desde el disco duro
        // Por lo tanto, este script está COMPLETAMENTE DESACTIVADO
        console.log('Script de eliminacion de campos de imagen DESACTIVADO');
        console.log('Los campos de imagen ahora son necesarios y se preservaran');
        
        // Función vacía para evitar errores si algo intenta llamarla
        (function preservarCamposImagen() {
            // Esta función ya no hace nada - los campos se preservan
            // No hay setInterval, no hay MutationObserver, no hay eliminación
            console.log('Campos de imagen preservados - script desactivado');
        })();
        
        // ============================================
        // SOLUCIÓN INMEDIATA PARA MODAL DE IMÁGENES
        // ============================================
        // Esta función se ejecuta inmediatamente y sobrescribe cualquier función en caché
        (function() {
            window.abrirModalImagenesDirecto = function(mode) {
                console.log('🚀 ABRIENDO MODAL DIRECTO - Modo:', mode);
                const modal = document.getElementById('imageManagerModal');
                if (!modal) {
                    console.error('Modal no encontrado');
                    alert('Error: Modal no encontrado. Recarga la página.');
                    return;
                }
                modal.style.display = 'block';
                modal.style.zIndex = '10000';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                console.log('Modal abierto directamente');
                
                // Configurar nombre del hotel
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    if (nameInput && nameInput.value) {
                        hotelNameSpan.textContent = nameInput.value;
                    } else {
                        hotelNameSpan.textContent = 'Nuevo Hotel';
                    }
                }
            };
            console.log('Funcion abrirModalImagenesDirecto disponible globalmente');
        })();

        // ============================================
        // SISTEMA DE AUTENTICACIÓN - EJECUTAR PRIMERO
        // ============================================
        console.log('Script de autenticacion cargado');
        
        // IMPORTANTE: Ocultar dashboard y mostrar login por defecto INMEDIATAMENTE
        (function() {
            function hideDashboardAndShowLogin() {
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                const body = document.body;
                
                if (dashboardContent) {
                    dashboardContent.classList.remove('authenticated');
                }
                if (loginContainer) {
                    loginContainer.classList.remove('hidden');
                }
                if (body) {
                    body.classList.remove('authenticated');
                }
            }
            
            // Ejecutar inmediatamente si el DOM está listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideDashboardAndShowLogin);
            } else {
                hideDashboardAndShowLogin();
            }
        })();
        
        // Sistema de gestión de usuarios administradores
        // Inicializar usuarios administradores en localStorage si no existen
        function initAdminUsers() {
            const storedUsers = localStorage.getItem('dashboard_admin_users');
            if (!storedUsers) {
                const defaultUsers = [
                    {
                        id: 'admin-001',
                        username: 'admin',
                        password: 'admin123',
                        password_hash: 'admin123',
                        name: 'Administrador',
                        role: 'admin_total', // admin_total o usuario
                        email: 'admin@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    },
                    {
                        id: 'admin-002',
                        username: 'German',
                        password: '123456',
                        password_hash: '123456',
                        name: 'German Perez',
                        role: 'admin_total',
                        email: 'german@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    },
                    {
                        id: 'admin-003',
                        username: 'Axel',
                        password: '123456',
                        password_hash: '123456',
                        name: 'Axel',
                        role: 'admin_total',
                        email: 'axel@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    }
                ];
                localStorage.setItem('dashboard_admin_users', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return JSON.parse(storedUsers);
        }

        // Obtener todos los usuarios administradores
        function getAdminUsers() {
            return JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
        }

        // Guardar usuarios administradores
        function saveAdminUsers(users) {
            localStorage.setItem('dashboard_admin_users', JSON.stringify(users));
        }

        // Inicializar usuarios al cargar
        initAdminUsers();

        // Verificar si hay sesion activa al cargar la pagina
        function checkAuthStatus() {
            console.log('Verificando autenticacion...');
            
            // Primero, asegurar que el dashboard este oculto y el login visible
            const dashboardContent = document.getElementById('dashboardContent');
            const loginContainer = document.getElementById('loginContainer');
            
            if (!dashboardContent || !loginContainer) {
                console.error('Elementos de autenticacion no encontrados');
                return false;
            }
            
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    // Verificar si la sesion no ha expirado (24 horas)
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        console.log('Sesion valida encontrada para:', session.username);
                        showDashboard();
                        return true;
                    } else {
                        // Sesion expirada
                        console.log('Sesion expirada, eliminando...');
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    console.error('Error al verificar sesion:', e);
                    localStorage.removeItem('dashboard_auth_session');
                }
            } else {
                console.log('No hay sesion activa');
            }
            
            // No hay sesion valida, mostrar login
            showLogin();
            return false;
        }

        // Mostrar pantalla de login
        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.remove('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.remove('authenticated');
            }
            if (body) {
                body.classList.remove('authenticated');
            }
        }

        // Mostrar dashboard
        function showDashboard() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.add('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.add('authenticated');
            }
            if (body) {
                body.classList.add('authenticated');
            }
            
            // Inicializar sincronizacion en tiempo real despues de un pequeño delay
            setTimeout(function() {
                if (typeof initRealtimeSubscriptions === 'function') {
                    initRealtimeSubscriptions();
                }
            }, 1000);
        }

        // Manejar el login - SIMPLIFICADO: siempre mostrar dashboard
        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            console.log('Login interceptado - forzando dashboard...');
            
            // SIEMPRE mostrar dashboard sin importar las credenciales
            if (typeof showDashboard === 'function') {
                showDashboard();
            } else {
                console.error('showDashboard no esta definida');
            }
            return false;
        }
        
        // Sobrescribir funcion global
        window.handleLogin = handleLogin;

        // Mostrar error de login
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Toggle visibilidad de contraseña
        function togglePasswordVisibility(event) {
            const passwordInput = document.getElementById('loginPassword');
            if (!passwordInput) return;
            
            const icon = event ? event.target : document.querySelector('#loginPassword + .input-icon');
            if (!icon) return;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility_off';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility';
            }
        }

        // Actualizar menú de usuario
        function updateUserMenu(userName, userRole) {
            const userNameElement = document.querySelector('.user-dropdown .dropdown-item:first-child');
            if (userNameElement) {
                const roleText = userRole === 'admin_total' ? 'Administrador Total' : 'Usuario';
                userNameElement.innerHTML = `<span class="material-icons">person</span>${userName} (${roleText})`;
            }
        }

        // Verificar si el usuario actual es admin_total
        function isAdminTotal() {
            const session = localStorage.getItem('dashboard_auth_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    return sessionData.role === 'admin_total';
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        // Función de logout mejorada
        function logout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                localStorage.removeItem('dashboard_auth_session');
                
                // Limpiar formulario
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.reset();
                }
                
                // Ocultar dropdown de usuario
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                // Mostrar login y ocultar dashboard
                showLogin();
                
                console.log('Sesion cerrada');
            }
        }

        // ============================================
        // FIN SISTEMA DE AUTENTICACIÓN
        // ============================================

        // Variables globales
        let currentSection = 'dashboard';
        let expensesCharts = {
            composition: null,
            variable: null,
            budget: null
        };
        
        // ============================================
        // VERIFICACIÓN DE VERSIÓN DEL CÓDIGO
        // ============================================
        // Esta función verifica qué versión del código está cargada
        window.verificarVersionCodigo = function() {
            console.log('🔍 ============================================');
            console.log('🔍 VERIFICACIÓN DE VERSIÓN DEL CÓDIGO');
            console.log('🔍 ============================================');
            console.log('📅 Timestamp:', new Date().toISOString());
            console.log('🔍 loadExpensesData es función:', typeof window.loadExpensesData);
            console.log('🔍 forceExpensesSectionDimensions es función:', typeof window.forceExpensesSectionDimensions);
            console.log('🔍 forceMainContentDimensions es función:', typeof window.forceMainContentDimensions);
            console.log('🔍 forceQuotesSectionDimensions es función:', typeof window.forceQuotesSectionDimensions);
            
            // Verificar si loadExpensesData tiene el log de versión actualizada
            const loadExpensesDataStr = window.loadExpensesData?.toString() || '';
            const tieneVersionActualizada = loadExpensesDataStr.includes('VERSIÓN ACTUALIZADA');
            console.log('🔍 loadExpensesData tiene "VERSIÓN ACTUALIZADA":', tieneVersionActualizada);
            
            if (tieneVersionActualizada) {
                console.log('✅ CÓDIGO ACTUALIZADO: La versión con forzado de dimensiones está cargada');
            } else {
                console.error('❌ CÓDIGO ANTIGUO: La versión en el servidor no tiene los cambios recientes');
                console.error('❌ Necesitas ejecutar: ./FORZAR_ACTUALIZACION_DASHBOARD.sh');
            }
            console.log('🔍 ============================================');
        };
        
        // Ejecutar verificación inmediatamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('🔍 DOMContentLoaded ejecutado, verificando versión...');
                window.verificarVersionCodigo();
            });
        } else {
            console.log('🔍 DOM ya está listo, verificando versión inmediatamente...');
            window.verificarVersionCodigo();
        }
        
        // Verificar también la variable de verificación temprana
        if (window.CODIGO_ACTUALIZADO_2026_01_10) {
            console.log('✅ Variable de verificación temprana encontrada - código nuevo está cargado');
        } else {
            console.error('❌ Variable de verificación temprana NO encontrada - el código nuevo NO se cargó');
            console.error('❌ El navegador está usando caché. Presiona Ctrl+Shift+R para forzar recarga');
        }
        
        // Función auxiliar para forzar dimensiones en .main-content (compartida)
        window.forceMainContentDimensions = function forceMainContentDimensions() {
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                const viewportWidth = window.innerWidth;
                const sidebarWidth = 220;
                const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                
                const currentWidth = mainContent.offsetWidth;
                if (currentWidth === 0 || currentWidth < 100) {
                    console.log(`🔧 Forzando .main-content a ${mainWidth}px (actual: ${currentWidth}px)`);
                    mainContent.style.cssText = `
                        display: block !important;
                        width: ${mainWidth}px !important;
                        min-width: ${mainWidth}px !important;
                        margin-left: ${sidebarWidth}px !important;
                        flex: 1 !important;
                        position: relative !important;
                        visibility: visible !important;
                        overflow: visible !important;
                    `;
                    mainContent.setAttribute('data-forced-width', mainWidth);
                    void mainContent.offsetHeight;
                    void mainContent.offsetWidth; // Forzar reflow
                }
            }
        }
        
        // Función auxiliar para forzar dimensiones en expenses-section (CORREGIDA - Sin bucle infinito)
        window.forceExpensesSectionDimensions = function forceExpensesSectionDimensions() {
            // 1. Forzar .main-content PRIMERO (SIEMPRE) - Usando flex-basis para elementos flex
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                const viewportWidth = window.innerWidth;
                const sidebarWidth = 220;
                const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                
                // Usar flex-basis en lugar de width para elementos flex
                mainContent.style.cssText = `
                    display: flex !important;
                    flex-direction: column !important;
                    flex: 1 1 ${mainWidth}px !important;
                    flex-basis: ${mainWidth}px !important;
                    min-width: ${mainWidth}px !important;
                    max-width: ${mainWidth}px !important;
                    width: ${mainWidth}px !important;
                    margin-left: ${sidebarWidth}px !important;
                    position: relative !important;
                    visibility: visible !important;
                    overflow: visible !important;
                `;
                
                // Forzar reflow del main-content
                void mainContent.offsetWidth;
            }
            
            // 2. Esperar un momento para que main-content se aplique
            setTimeout(() => {
                // Forzar expenses-section DESPUÉS de que main-content esté listo
                const expensesSection = document.getElementById('expenses-section');
                if (expensesSection) {
                    // Verificar que esté visible
                    const computedDisplay = window.getComputedStyle(expensesSection).display;
                    if (computedDisplay === 'none') {
                        expensesSection.style.setProperty('display', 'block', 'important');
                    }
                    
                    const viewportWidth = window.innerWidth;
                    const sidebarWidth = 220;
                    const availableWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                    
                    // Aplicar dimensiones usando cssText (más confiable para múltiples propiedades)
                    expensesSection.style.cssText = `
                        display: block !important;
                        width: ${availableWidth}px !important;
                        min-width: ${availableWidth}px !important;
                        max-width: ${availableWidth}px !important;
                        visibility: visible !important;
                        position: relative !important;
                        padding: 20px !important;
                        box-sizing: border-box !important;
                        overflow: visible !important;
                    `;
                    
                    expensesSection.setAttribute('data-forced-width', availableWidth);
                    
                    // Forzar múltiples reflows después de aplicar estilos
                    void expensesSection.offsetWidth;
                    requestAnimationFrame(() => {
                        void expensesSection.offsetWidth;
                        void expensesSection.offsetHeight;
                        requestAnimationFrame(() => {
                            void expensesSection.offsetWidth;
                        });
                    });
                }
            }, 100); // Esperar 100ms para que main-content se aplique primero
        }
        
        // Función auxiliar para forzar dimensiones en quotes-section
        window.forceQuotesSectionDimensions = function forceQuotesSectionDimensions() {
            console.log('🔧 SOLUCIÓN ULTRA AGRESIVA: Forzando dimensiones antes de cargar quotes...');
            
            // 1. Forzar .main-content PRIMERO (SIEMPRE)
            forceMainContentDimensions();
            
            // 2. Forzar quotes-section
            const quotesSection = document.getElementById('quotes-section');
            if (quotesSection) {
                const viewportWidth = window.innerWidth;
                const sidebarWidth = 220;
                const availableWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                
                console.log(`🔧 Forzando quotes-section a ${availableWidth}px`);
                quotesSection.style.cssText = `
                    display: block !important;
                    width: ${availableWidth}px !important;
                    min-width: ${availableWidth}px !important;
                    max-width: ${availableWidth}px !important;
                    visibility: visible !important;
                    position: relative !important;
                    padding: 20px !important;
                    box-sizing: border-box !important;
                    overflow: visible !important;
                `;
                quotesSection.setAttribute('data-forced-width', availableWidth);
                void quotesSection.offsetHeight;
                void quotesSection.offsetWidth; // Forzar reflow
            }
        }
        
        // Redefinir función showSection para agregar funcionalidad adicional
        const originalShowSection = window.showSection;
        window.showSection = function(section, event) {
            // Llamar a la función original si existe
            if (originalShowSection) {
                originalShowSection(section, event);
            }
            
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // CERRAR TODOS LOS MODALES cuando se cambia de sección
            const modalsToClose = [
                'expenseModalNew',
                'quoteModalNew',
                'cameraModalNew',
                'expenseModal',
                'quoteModal',
                'newQuoteModal',
                'cameraModal'
            ];
            modalsToClose.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });

            // Mostrar la sección seleccionada
            const targetSection = document.getElementById(section + '-section');
            
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log('Seccion mostrada:', section);
                
                // SIEMPRE forzar dimensiones si es expenses-section (DESPUÉS de mostrar)
                if (section === 'expenses') {
                    // Asegurar que .main-content esté visible y tenga dimensiones PRIMERO
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        const viewportWidth = window.innerWidth;
                        const sidebarWidth = 220;
                        const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                        mainContent.style.cssText = `
                            display: flex !important;
                            flex-direction: column !important;
                            width: ${mainWidth}px !important;
                            min-width: ${mainWidth}px !important;
                            max-width: ${mainWidth}px !important;
                            margin-left: ${sidebarWidth}px !important;
                            flex: 1 1 auto !important;
                            position: relative !important;
                            visibility: visible !important;
                        `;
                        void mainContent.offsetWidth; // Forzar reflow
                    }
                    
                    // CRÍTICO: Esperar a que expenses-section esté realmente visible y tenga dimensiones
                    // Usar un intervalo que verifica hasta que el elemento tenga dimensiones
                    let attempts = 0;
                    const maxAttempts = 20; // 2 segundos máximo (20 * 100ms)
                    
                    const checkAndForceDimensions = () => {
                        attempts++;
                        const expensesSection = document.getElementById('expenses-section');
                        
                        if (!expensesSection) {
                            if (attempts < maxAttempts) {
                                setTimeout(checkAndForceDimensions, 100);
                            }
                            return;
                        }
                        
                        // Verificar que esté visible
                        const computedDisplay = window.getComputedStyle(expensesSection).display;
                        if (computedDisplay === 'none') {
                            expensesSection.style.setProperty('display', 'block', 'important');
                        }
                        
                        // Verificar dimensiones
                        const sectionWidth = expensesSection.offsetWidth || expensesSection.getBoundingClientRect().width;
                        const viewportWidth = window.innerWidth;
                        const sidebarWidth = 220;
                        const targetWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                        
                        if (sectionWidth > 0 || attempts >= maxAttempts) {
                            // El elemento tiene dimensiones o hemos intentado suficientes veces
                            console.log(`✅ expenses-section ${sectionWidth > 0 ? 'tiene dimensiones' : 'forzando dimensiones después de ' + attempts + ' intentos'}: ${sectionWidth}px`);
                            
                            // Forzar dimensiones de expenses-section
                            expensesSection.style.cssText = `
                                display: block !important;
                                width: ${targetWidth}px !important;
                                min-width: ${targetWidth}px !important;
                                max-width: ${targetWidth}px !important;
                                visibility: visible !important;
                                position: relative !important;
                                padding: 20px !important;
                                box-sizing: border-box !important;
                                overflow: visible !important;
                            `;
                            
                            void expensesSection.offsetWidth;
                            void expensesSection.offsetHeight;
                            
                            // Ahora llamar a forceExpensesSectionDimensions
                            if (typeof forceExpensesSectionDimensions === 'function') {
                                forceExpensesSectionDimensions();
                            }
                        } else {
                            // Aún no tiene dimensiones, seguir intentando
                            setTimeout(checkAndForceDimensions, 100);
                        }
                    };
                    
                    // Iniciar verificación después de un pequeño delay
                    setTimeout(checkAndForceDimensions, 50);
                }
            } else {
                console.error('Seccion no encontrada:', section + '-section');
            }

            // Actualizar menú activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Solo actualizar el menú activo si se proporciona el evento
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si no hay evento, buscar el elemento del menú correspondiente
                const menuItem = document.querySelector(`[onclick*="window.showSection('${section}')"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            }

            currentSection = section;
            
            // Cargar datos específicos según la sección
            if (section === 'users') {
                setTimeout(() => {
                    if (typeof loadUsersData === 'function') {
                        loadUsersData();
                    }
                }, 100);
            }
            
            if (section === 'administrators') {
                setTimeout(() => {
                    if (typeof loadAdminsTable === 'function') {
                        loadAdminsTable();
                    }
                    if (typeof updateAdminMenuVisibility === 'function') {
                        updateAdminMenuVisibility();
                    }
                }, 100);
            }
            
            if (section === 'hotels') {
                setTimeout(() => {
                    if (typeof loadHotelsTable === 'function') {
                        loadHotelsTable();
                    }
                }, 100);
            }
            
            if (section === 'expenses') {
                // La función forceExpensesSectionDimensions() ya se ejecutó arriba
                // Solo cargar los datos después de un pequeño delay
                setTimeout(() => {
                    if (typeof loadExpensesData === 'function') {
                        loadExpensesData();
                    }
                }, 200);
            }
            
            if (section === 'quotes') {
                // Forzar dimensiones antes de cargar datos
                if (typeof forceQuotesSectionDimensions === 'function') {
                    requestAnimationFrame(() => {
                        forceQuotesSectionDimensions();
                    });
                }
                setTimeout(() => {
                    if (typeof loadQuotesTable === 'function') {
                        loadQuotesTable();
                    }
                    if (typeof updateQuotesStats === 'function') {
                        updateQuotesStats();
                    }
                }, 200);
            }
            
            if (section === 'agents') {
                setTimeout(() => {
                    if (typeof loadAgentsTable === 'function') {
                        loadAgentsTable();
                    }
                }, 100);
            }
            
            if (section === 'reservations') {
                setTimeout(() => {
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                }, 100);
            }
            
            if (section === 'dashboard') {
                setTimeout(() => {
                    if (typeof loadHotelsForMonthlySalesFilter === 'function') {
                        loadHotelsForMonthlySalesFilter();
                    }
                    if (typeof loadMonthlySales === 'function') {
                        loadMonthlySales();
                    }
                    if (typeof loadExpenseCategoriesForFilter === 'function') {
                        loadExpenseCategoriesForFilter();
                    }
                    if (typeof loadMonthlyExpenses === 'function') {
                        loadMonthlyExpenses();
                    }
                    if (typeof updateStats === 'function') {
                        updateStats();
                    }
                }, 100);
            }
        };

        // Función para cerrar modal de edición de hoteles
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para cerrar modal de vista previa de imágenes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para toggle del menú de usuario
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Función para toggle del sidebar en móvil
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        // Función de logout (reemplazada por la nueva implementación arriba)

        // Cerrar dropdown cuando se hace clic fuera
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            
            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Cerrar sidebar en móvil cuando se hace clic en un enlace
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('open');
                    }
                }
            });
        });

        // Datos de hoteles (sistema limpio)
        const hotels = [];

        // Función para generar estrellas
        function getStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="material-icons rating-stars">star</span>';
                } else if (i - 0.5 <= rating) {
                    stars += '<span class="material-icons rating-stars">star_half</span>';
                } else {
                    stars += '<span class="material-icons" style="color: #e0e0e0;">star</span>';
                }
            }
            return stars;
        }

        // Función para cargar hoteles en la tabla
        async function loadHotelsTable() {
            console.log('Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('Tbody de hoteles no encontrado');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            console.log(`📋 Encontrados ${hotels.length} hoteles:`, hotels.map(h => h.name));
            
            tbody.innerHTML = '';

            if (hotels.length === 0) {
                // Mostrar mensaje si no hay hoteles
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-hotel" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">No hay hoteles registrados</h3>
                        <p style="margin-bottom: 20px; color: #666;">Comienza agregando tu primer hotel</p>
                        <button onclick="addNewHotel()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Primer Hotel
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price || 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status?.toLowerCase() || 'activo'}">${hotel.status || 'Activo'}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="viewHotel('${hotel.id}')" class="action-btn view" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`Tabla de hoteles cargada con ${hotels.length} hoteles`);
        }

        // Función para actualizar estadísticas del dashboard
        function updateStats() {
            console.log('Actualizando estadisticas del dashboard...');
            
            // Actualizar Total Hoteles (solo activos)
            const dashboardTotalHotelsElement = document.getElementById('dashboardTotalHotels');
            if (dashboardTotalHotelsElement) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                // Contar solo hoteles activos (considera tanto is_active como status)
                const activeHotels = hotels.filter(hotel => {
                    // Un hotel está activo si:
                    // - is_active es true (o undefined/null, se considera activo por defecto)
                    // - O status es 'Activo' (o undefined/null, se considera activo por defecto)
                    const isActiveBool = hotel.is_active !== false; // true, undefined, null = activo
                    const isActiveStatus = hotel.status !== 'Inactivo'; // 'Activo', undefined, null = activo
                    return isActiveBool && isActiveStatus;
                });
                dashboardTotalHotelsElement.textContent = activeHotels.length;
                
                // Actualizar el mensaje de tendencia
                const trendElement = dashboardTotalHotelsElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (activeHotels.length > 0) {
                        trendElement.innerHTML = '<span class="material-icons">trending_up</span> Hoteles activos';
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">info</span> Sin datos disponibles';
                    }
                }
                
                console.log(`Total Hoteles actualizado: ${activeHotels.length} hoteles activos`);
            }
            
            // Actualizar tarjeta de Ingresos del Mes Vigente
            const dashboardMonthlySalesElement = document.getElementById('dashboardMonthlySales');
            const dashboardMonthlyReservationsElement = document.getElementById('dashboardMonthlyReservations');
            if (dashboardMonthlySalesElement && dashboardMonthlyReservationsElement) {
                // Calcular acumulado de ventas del mes vigente
                const monthlyAccumulated = calculateMonthlySalesAccumulated();
                const formattedAmount = monthlyAccumulated.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Mostrar el acumulado de ventas como número principal
                dashboardMonthlySalesElement.textContent = `$${formattedAmount}`;
                
                // Calcular cantidad de reservas acumuladas en el mes vigente
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                const monthlyReservations = reservations.filter(reservation => {
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const checkInDate = reservation.checkIn || reservation.check_in;
                    
                    if (!checkInDate || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                        return false;
                    }
                    
                    let dateStr = checkInDate;
                    if (dateStr.includes('T')) {
                        dateStr = dateStr.split('T')[0];
                    }
                    
                    const dateParts = dateStr.split('-');
                    if (dateParts.length !== 3) {
                        return false;
                    }
                    
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    
                    return year === currentYear && month === currentMonth;
                });
                
                const reservationsCount = monthlyReservations.length;
                const reservationsTotal = monthlyReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                const formattedReservationsTotal = reservationsTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                if (reservationsCount > 0) {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">trending_up</span> Cantidad de reservas Acumuladas en el mes: ${reservationsCount}`;
                } else {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">info</span> Sin reservas este mes`;
                }
                
                console.log(`Tarjeta de Ingresos del Mes Vigente actualizada: Acumulado: $${formattedAmount}, Reservas: ${reservationsCount}, Sumatoria: $${formattedReservationsTotal}`);
            }
            
            // Actualizar Sumatoria de Reservas Futuras
            const futureReservationsTotalElement = document.getElementById('futureReservationsTotal');
            if (futureReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Función auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const rawCheckIn = reservation.checkIn || reservation.check_in;
                    if (!rawCheckIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(rawCheckIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                // Calcular sumatoria de reservas futuras
                const futureTotal = futureReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                // Formatear el total
                futureReservationsTotalElement.textContent = `$${futureTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                console.log(`Sumatoria de Reservas Futuras actualizada: $${futureTotal.toLocaleString('es-AR')} (${futureReservations.length} reservas)`);
            }
            
            // Actualizar Ingresos de Hoy
            const todayReservationsTotalElement = document.getElementById('todayReservationsTotal');
            if (todayReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                console.log('🔍 Calculando Ingresos de Hoy...');
                console.log(`Total de reservas en BD: ${reservations.length}`);
                
                // Mostrar muestra de las primeras 3 reservas para entender la estructura
                if (reservations.length > 0) {
                    console.log('📋 Muestra de estructura de reservas (primeras 3):');
                    reservations.slice(0, 3).forEach((r, index) => {
                        console.log(`  Reserva ${index + 1} (${r.reservationCode || r.id}):`);
                        console.log(`    - id: ${r.id}`);
                        console.log(`    - code: ${r.reservationCode}`);
                        console.log(`    - createdAt: ${r.createdAt || 'NO EXISTE'}`);
                        console.log(`    - created_at: ${r.created_at || 'NO EXISTE'}`);
                        console.log(`    - updatedAt: ${r.updatedAt || 'NO EXISTE'}`);
                        console.log(`    - updated_at: ${r.updated_at || 'NO EXISTE'}`);
                        console.log(`    - reservationDate: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`    - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`    - status: ${r.status || 'NO EXISTE'}`);
                        console.log('');
                    });
                }
                
                // Obtener la fecha de hoy en formato YYYY-MM-DD usando fecha LOCAL (no UTC)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                console.log(`📅 Fecha de hoy (LOCAL): ${todayStr}`);
                console.log(`📅 Fecha de hoy (UTC): ${today.toISOString().split('T')[0]}`);
                
                // Función auxiliar para normalizar fecha a YYYY-MM-DD usando fecha LOCAL
                const normalizeDate = (dateValue) => {
                    if (!dateValue) return null;
                    
                    let dateStr = dateValue;
                    let date;
                    
                    // Si es un objeto Date, usar directamente
                    if (dateStr instanceof Date) {
                        date = dateStr;
                    }
                    // Si es un string, intentar parsearlo
                    else if (typeof dateStr === 'string') {
                        // Si ya está en formato YYYY-MM-DD, retornarlo directamente
                        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            return dateStr;
                        }
                        // Si incluye hora (formato ISO), parsearlo
                        else if (dateStr.includes('T')) {
                            date = new Date(dateStr);
                        }
                        // Intentar parsear cualquier otro formato
                        else {
                            date = new Date(dateStr);
                        }
                    } else {
                        return null;
                    }
                    
                    // Si no se pudo parsear, retornar null
                    if (!date || isNaN(date.getTime())) {
                        return null;
                    }
                    
                    // Convertir a fecha LOCAL (no UTC) en formato YYYY-MM-DD
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Mostrar muestra de las primeras 5 reservas para depuración
                console.log('🔍 Muestra de reservas (primeras 5):', reservations.slice(0, 5).map(r => ({
                    id: r.id,
                    code: r.reservationCode,
                    createdAt: r.createdAt || r.created_at,
                    updatedAt: r.updatedAt || r.updated_at,
                    reservationDate: r.reservationDate,
                    totalAmount: r.totalAmount,
                    status: r.status
                })));
                
                // Filtrar reservas que tienen checkIn de HOY (fecha de entrada)
                const todayReservations = reservations.filter(reservation => {
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const rawCheckIn = reservation.checkIn || reservation.check_in;
                    const checkIn = normalizeDate(rawCheckIn);
                    const checkInToday = checkIn !== null && checkIn === todayStr;
                    
                    // Incluir solo si tiene checkIn de HOY
                    const isToday = checkInToday;
                    
                    if (isToday) {
                        console.log(`Reserva de hoy encontrada (checkIn hoy):`, {
                            id: reservation.id,
                            code: reservation.reservationCode || reservation.reservation_code,
                            checkIn: rawCheckIn,
                            checkInNormalizado: checkIn,
                            totalAmount: reservation.totalAmount || reservation.total_amount,
                            status: reservation.status
                        });
                    }
                    
                    return isToday;
                });
                
                console.log(`Reservas encontradas para hoy: ${todayReservations.length}`);
                
                // Buscar específicamente la reserva VRETNG si existe
                const vretngReservation = reservations.find(r => r.reservationCode === 'VRETNG');
                if (vretngReservation) {
                    console.log('🔍 RESERVA VRETNG ENCONTRADA:');
                    const vretngCheckIn = normalizeDate(vretngReservation.checkIn);
                    console.log(`  - checkIn original: ${vretngReservation.checkIn || 'NO EXISTE'}`);
                    console.log(`  - checkIn normalizado: ${vretngCheckIn || 'null'}`);
                    console.log(`  - Fecha de hoy: ${todayStr}`);
                    console.log(`  - totalAmount: ${vretngReservation.totalAmount || 'NO EXISTE'}`);
                    console.log(`  - status: ${vretngReservation.status || 'NO EXISTE'}`);
                    console.log(`  - ¿checkIn coincide con hoy?: ${vretngCheckIn === todayStr ? 'SÍ' : 'NO'}`);
                    console.log(`  - ¿Está en todayReservations?: ${todayReservations.some(r => r.reservationCode === 'VRETNG') ? 'SÍ' : 'NO'}`);
                } else {
                    console.log('Reserva VRETNG NO ENCONTRADA en la base de datos');
                }
                
                // Si no se encontraron reservas, mostrar algunas fechas cercanas para depuración
                if (todayReservations.length === 0 && reservations.length > 0) {
                    console.log('No se encontraron reservas para hoy. Mostrando fechas de las ultimas 10 reservas:');
                    const recentReservations = reservations.slice(-10).reverse();
                    recentReservations.forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt original: ${r.createdAt || r.created_at || 'NO EXISTE'}`);
                        console.log(`     - createdAt normalizado: ${createdAt || 'null'}`);
                        console.log(`     - updatedAt original: ${r.updatedAt || r.updated_at || 'NO EXISTE'}`);
                        console.log(`     - updatedAt normalizado: ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate original: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`     - reservationDate normalizado: ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log(`     - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`     - status: ${r.status || 'NO EXISTE'}`);
                        console.log(`     - ¿Coincide con hoy?: ${createdAt === todayStr || updatedAt === todayStr || reservationDate === todayStr ? 'SÍ' : 'NO'}`);
                        console.log('');
                    });
                    
                    // También mostrar las primeras 5 reservas
                    console.log('📋 Muestra de las primeras 5 reservas:');
                    reservations.slice(0, 5).forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt: ${r.createdAt || r.created_at || 'NO EXISTE'} → ${createdAt || 'null'}`);
                        console.log(`     - updatedAt: ${r.updatedAt || r.updated_at || 'NO EXISTE'} → ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate: ${r.reservationDate || 'NO EXISTE'} → ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log('');
                    });
                }
                
                // Calcular el total de ingresos de hoy
                // Solo contar reservas que no estén canceladas (Confirmadas o Modificadas)
                const todayTotal = todayReservations
                    .filter(res => {
                        const status = res.status || '';
                        const isNotCanceled = status !== 'Cancelada' && status !== 'cancelada';
                        if (!isNotCanceled) {
                            console.log(`Reserva cancelada excluida: ${res.reservationCode} - $${res.totalAmount}`);
                        }
                        return isNotCanceled;
                    })
                    .reduce((sum, res) => {
                        // Intentar obtener el monto de diferentes campos posibles
                        const amount = parseFloat(res.totalAmount) || 
                                     parseFloat(res.total_amount) || 
                                     parseFloat(res.amount) || 
                                     parseFloat(res.price) || 0;
                        
                        if (amount > 0) {
                            console.log(`💰 Sumando: $${amount} de reserva ${res.reservationCode || res.id}`);
                        } else {
                            console.warn(`⚠️ Reserva sin monto: ${res.reservationCode || res.id}`, res);
                        }
                        
                        return sum + amount;
                    }, 0);
                
                // Contar reservas con checkIn de hoy
                const checkInToday = todayReservations.length;
                
                // Formatear el total con separador de miles
                todayReservationsTotalElement.textContent = `$${todayTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                // Actualizar el mensaje de tendencia
                const trendElement = todayReservationsTotalElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (todayReservations.length > 0) {
                        trendElement.innerHTML = `<span class="material-icons">today</span> ${todayReservations.length} reserva(s) con check-in hoy`;
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">today</span> Sin reservas con check-in hoy';
                    }
                }
                
                console.log(`Ingresos de Hoy actualizado: $${todayTotal.toLocaleString('es-AR')} (${checkInToday} reserva(s) con check-in hoy)`);
                console.log('Detalle completo de reservas de hoy:', todayReservations.map(r => {
                    const createdAt = normalizeDate(r.createdAt || r.created_at);
                    const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                    const reservationDate = normalizeDate(r.reservationDate);
                    return {
                        id: r.id,
                        code: r.reservationCode,
                        createdAt: r.createdAt || r.created_at,
                        updatedAt: r.updatedAt || r.updated_at,
                        reservationDate: r.reservationDate,
                        totalAmount: r.totalAmount,
                        status: r.status,
                        normalizedDates: { createdAt, updatedAt, reservationDate }
                    };
                }));
            } else {
                console.warn('⚠️ No se encontró el elemento todayReservationsTotal');
            }
        }



        // Función para editar hotel
        async function editHotel(hotelId) {
            console.log('Editando hotel:', hotelId);
            
            // Buscar hotel en Supabase primero
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                } catch (error) {
                    console.error('Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback a localStorage
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
            }
            
            if (!hotel) {
                alert('❌ Hotel no encontrado');
                return;
            }
            
            // Usar el modal principal en lugar del dinámico
            const mainModal = document.getElementById('editHotelModal');
            if (mainModal) {
                // Cargar datos en el modal principal
                document.getElementById('editHotelModalTitle').textContent = '✏️ Editar Hotel';
                document.getElementById('editHotelName').value = hotel.name || '';
                document.getElementById('editHotelLocation').value = hotel.location || '';
                document.getElementById('editHotelGoogleMaps').value = hotel.googleMaps || hotel.google_maps || '';
                document.getElementById('editHotelWebsite').value = hotel.website || '';
                document.getElementById('editHotelRating').value = hotel.rating || '';
                document.getElementById('editHotelPrice').value = hotel.price || '';
                document.getElementById('editHotelDescription').value = hotel.description || '';
                document.getElementById('editHotelAmenities').value = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : (hotel.amenities || '');
                document.getElementById('editHotelStatus').value = hotel.status || 'Activo';
                document.getElementById('editHotelImage').value = hotel.mainImage || hotel.images?.[0] || '';
                
                // Cargar campos de Flor IA (soportar ambos formatos: camelCase y snake_case)
                const florInfo = hotel.florInfo || hotel.flor_info || {};
                document.getElementById('editHotelFlorDescription').value = florInfo.description || '';
                document.getElementById('editHotelFlorServices').value = florInfo.services || '';
                document.getElementById('editHotelExcursions').value = florInfo.excursions || '';
                document.getElementById('editHotelFlorPrices').value = florInfo.prices || '';
                document.getElementById('editHotelFlorPolicies').value = florInfo.policies || '';
                document.getElementById('editHotelFlorTransport').value = florInfo.transport || '';
                document.getElementById('editHotelFlorContact').value = florInfo.contact || '';
                
                // Cargar conocimiento adicional desde flor_hotel_knowledge
                const florKnowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
                const extraKnowledge = florKnowledge[hotelId] || {};
                document.getElementById('editHotelKnowledgeDescription').value = extraKnowledge.description || '';
                document.getElementById('editHotelKnowledgeServicesDetail').value = extraKnowledge.servicesDetail || '';
                document.getElementById('editHotelKnowledgePricing').value = extraKnowledge.pricing || '';
                document.getElementById('editHotelKnowledgeTransport').value = extraKnowledge.transport || '';
                document.getElementById('editHotelKnowledgeNotes').value = extraKnowledge.notes || '';
                document.getElementById('editHotelKnowledgeWebsiteInfo').value = extraKnowledge.websiteInfo || '';
                
                // Si hay conocimiento adicional, expandir la sección automáticamente
                const hasKnowledge = extraKnowledge.description || extraKnowledge.servicesDetail || 
                                    extraKnowledge.pricing || extraKnowledge.transport || 
                                    extraKnowledge.notes || extraKnowledge.websiteInfo;
                if (hasKnowledge) {
                    const section = document.getElementById('knowledgeAdditionalSection');
                    const icon = document.getElementById('knowledgeToggleIcon');
                    if (section) {
                        section.style.display = 'block';
                    }
                    if (icon) {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
                
                console.log('📋 Datos cargados del hotel:', {
                    name: hotel.name,
                    florInfo: florInfo,
                    extraKnowledge: extraKnowledge,
                    hotelId: hotelId,
                    hasKnowledge: hasKnowledge
                });
                
                // Configurar el modo de edición
                const form = document.getElementById('editHotelForm');
                form.dataset.mode = 'edit';
                form.dataset.hotelId = hotelId;
                
                // Actualizar vista previa de imagen
                const previewContainer = document.getElementById('editImagePreview');
                if (previewContainer && (hotel.mainImage || hotel.images?.[0])) {
                    previewContainer.innerHTML = `<img src="${hotel.mainImage || hotel.images?.[0]}" style="max-width: 150px; max-height: 100px; border-radius: 8px;">`;
                }
                
                // Mostrar modal
                mainModal.style.display = 'block';
                console.log('Modal de edicion abierto para:', hotel.name);
                return;
            }
            
            // Fallback: Crear modal dinámico si no existe el principal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editHotelModalDynamic';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            const hotelName = hotel.name || hotel.hotel_name || '';
            const hotelLocation = hotel.location || hotel.address || '';
            const hotelPrice = hotel.price || hotel.base_price || '';
            const hotelRating = hotel.rating || hotel.stars || 0;
            const hotelStatus = hotel.status || 'Activo';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 500px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">✏️ Editar Hotel</h2>
                        <button onclick="document.getElementById('editHotelModalDynamic').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <form id="editHotelForm" onsubmit="saveHotelChanges(event, '${hotelId}')">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del Hotel *</label>
                            <input type="text" id="editHotelName" value="${hotelName}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Ubicación</label>
                            <input type="text" id="editHotelLocation" value="${hotelLocation}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Precio Base (USD)</label>
                            <input type="number" id="editHotelPrice" value="${hotelPrice}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Calificación (1-5)</label>
                            <input type="number" id="editHotelRating" value="${hotelRating}" min="0" max="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado</label>
                            <select id="editHotelStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Activo" ${hotelStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                <option value="Inactivo" ${hotelStatus === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="document.getElementById('editHotelModalDynamic').remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            <button type="submit" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }
        
        async function saveHotelChanges(event, hotelId) {
            event.preventDefault();
            
            const updates = {
                name: document.getElementById('editHotelName').value,
                location: document.getElementById('editHotelLocation').value,
                price: parseFloat(document.getElementById('editHotelPrice').value) || 0,
                rating: parseInt(document.getElementById('editHotelRating').value) || 0,
                status: document.getElementById('editHotelStatus').value,
                updated_at: new Date().toISOString()
            };
            
            console.log('Guardando cambios del hotel:', hotelId, updates);
            
            let updatedHotel = null;
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    updatedHotel = await window.supabaseClient.updateHotel(hotelId, updates);
                    console.log('Hotel actualizado en Supabase');
                    
                    // Sincronizar con Flor IA
                    if (updatedHotel && typeof window.syncHotelToFlorKnowledge === 'function') {
                        window.syncHotelToFlorKnowledge(hotelId, updatedHotel);
                    }
                    
                    alert('Hotel actualizado correctamente');
                    document.getElementById('editHotelModalDynamic').remove();
                    loadHotelsTable();
                    return;
                }
            } catch (error) {
                console.error('Error actualizando hotel:', error);
            }
            
            // Fallback localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const index = hotels.findIndex(h => h.id === hotelId || h.id == hotelId);
            if (index !== -1) {
                updatedHotel = { ...hotels[index], ...updates };
                hotels[index] = updatedHotel;
                localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                
                // Sincronizar con Flor IA
                if (typeof window.syncHotelToFlorKnowledge === 'function') {
                    window.syncHotelToFlorKnowledge(hotelId, updatedHotel);
                }
                
                alert('✅ Hotel actualizado correctamente');
                document.getElementById('editHotelModalDynamic').remove();
                loadHotelsTable();
            }
        }

        // Función para cerrar modal de edición
        function closeEditModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para expandir/colapsar sección de conocimiento adicional
        function toggleKnowledgeSection() {
            const section = document.getElementById('knowledgeAdditionalSection');
            const icon = document.getElementById('knowledgeToggleIcon');
            if (section && icon) {
                const isVisible = section.style.display !== 'none';
                section.style.display = isVisible ? 'none' : 'block';
                icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
        
        // Hacer la función disponible globalmente
        window.toggleKnowledgeSection = toggleKnowledgeSection;
        
        // Función para guardar conocimiento adicional del hotel
        function saveHotelKnowledgeAdditional(hotelId) {
            if (!hotelId) {
                console.warn('⚠️ No se puede guardar conocimiento adicional: hotelId no válido');
                return;
            }
            
            const knowledge = {
                description: document.getElementById('editHotelKnowledgeDescription')?.value?.trim() || '',
                servicesDetail: document.getElementById('editHotelKnowledgeServicesDetail')?.value?.trim() || '',
                pricing: document.getElementById('editHotelKnowledgePricing')?.value?.trim() || '',
                transport: document.getElementById('editHotelKnowledgeTransport')?.value?.trim() || '',
                notes: document.getElementById('editHotelKnowledgeNotes')?.value?.trim() || '',
                websiteInfo: document.getElementById('editHotelKnowledgeWebsiteInfo')?.value?.trim() || ''
            };
            
            // Guardar en localStorage
            const allKnowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
            allKnowledge[hotelId] = knowledge;
            localStorage.setItem('flor_hotel_knowledge', JSON.stringify(allKnowledge));
            
            // Si existe FlorKnowledgeBase, guardar también ahí
            if (typeof FlorKnowledgeBase !== 'undefined' && typeof FlorKnowledgeBase.saveHotelKnowledge === 'function') {
                FlorKnowledgeBase.saveHotelKnowledge(hotelId, knowledge);
            }
            
            console.log('✅ Conocimiento adicional guardado para hotel:', hotelId);
            
            // Si la pestaña de conocimiento está abierta y este hotel está seleccionado, recargar
            const knowledgeTab = document.getElementById('flor-tab-knowledge');
            if (knowledgeTab && knowledgeTab.style.display !== 'none') {
                const selector = document.getElementById('knowledge-hotel-selector');
                if (selector && selector.value === String(hotelId)) {
                    if (typeof loadSelectedHotelKnowledge === 'function') {
                        loadSelectedHotelKnowledge();
                    }
                }
            }
        }

        // Función para eliminar imagen principal
        function deleteMainImage() {
            const imageInput = document.getElementById('editHotelImage');
            if (imageInput) imageInput.value = '';
            
            const mainImageFileInput = document.getElementById('mainImageFileInput');
            if (mainImageFileInput) mainImageFileInput.value = '';
            
            updateImagePreview();
            console.log('Imagen principal eliminada');
        }
        
        // Función para actualizar vista previa de imagen
        function updateImagePreview() {
            const imageInput = document.getElementById('editHotelImage');
            const previewContainer = document.getElementById('editImagePreview');
            
            if (!imageInput || !previewContainer) {
                return;
            }
            
            const imagePath = imageInput.value.trim();
            
            if (imagePath) {
                const isUrl = !imagePath.startsWith('data:');
                previewContainer.innerHTML = `
                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: #f9f9f9; position: relative;">
                        <button type="button" onclick="deleteMainImage()" 
                                style="position: absolute; top: 5px; right: 5px; background: #d32f2f; color: white; border: none; 
                                       border-radius: 50%; width: 30px; height: 30px; cursor: pointer; z-index: 10; 
                                       display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"
                                title="Eliminar imagen principal">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                        <img src="${imagePath}" alt="Vista previa" 
                             style="max-width: 100%; max-height: 300px; border-radius: 4px; display: block; margin: 0 auto;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; text-align: center; color: #999; padding: 20px;">
                            <span class="material-icons" style="font-size: 48px;">broken_image</span>
                            <p>No se pudo cargar la imagen</p>
                        </div>
                        ${isUrl ? '<div style="text-align: center; margin-top: 8px; font-size: 12px; color: #4caf50;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">link</span> URL Externa</div>' : ''}
                    </div>
                `;
            } else {
                previewContainer.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">Sin imagen principal - Selecciona una imagen</p>';
            }
        }

        // Función para actualizar vista previa de fotos (ELIMINADA - campo de galería removido)
        // Función auxiliar para leer imágenes del campo (compatible con ||| y comas)
        function getGalleryImagesFromInput() {
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput || !photosInput.value) {
                return [];
            }
            
            const photosValue = photosInput.value.trim();
            // Intentar primero con ||| (nuevo formato), luego con comas (formato antiguo)
            if (photosValue.includes('|||')) {
                return photosValue.split('|||').map(p => p.trim()).filter(p => p);
            } else {
                // Para formato antiguo con comas, ser más inteligente con base64
                if (photosValue.includes('data:image')) {
                    const dataImageRegex = /data:image\/[^;]+;base64,[^,]+(?:,|$)/g;
                    const matches = photosValue.match(dataImageRegex);
                    if (matches) {
                        return matches.map(m => m.replace(/,$/, '').trim()).filter(p => p);
                    }
                }
                return photosValue.split(',').map(p => p.trim()).filter(p => p);
            }
        }
        
        // Función para eliminar una foto de la galería por índice
        function deleteGalleryPhoto(index) {
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput) return;
            
            const photoPaths = getGalleryImagesFromInput();
            photoPaths.splice(index, 1); // Eliminar la foto en el índice indicado
            
            // Actualizar el input con las fotos restantes
            photosInput.value = photoPaths.join('|||');
            
            // Refrescar la vista previa
            updatePhotosPreview();
            console.log(`🗑️ Foto ${index + 1} eliminada de la galería. Quedan ${photoPaths.length} fotos.`);
        }
        
        // Función para limpiar toda la galería
        function clearAllGalleryPhotos() {
            if (!confirm('¿Estás seguro de que deseas eliminar TODAS las fotos de la galería?')) {
                return;
            }
            
            const photosInput = document.getElementById('editHotelPhotos');
            if (photosInput) photosInput.value = '';
            
            const galleryFileInput = document.getElementById('galleryImagesFileInput');
            if (galleryFileInput) galleryFileInput.value = '';
            
            updatePhotosPreview();
            console.log('🗑️ Galería de fotos vaciada completamente');
        }
        
        function updatePhotosPreview() {
            console.log('🖼️ updatePhotosPreview llamada');
            const photosInput = document.getElementById('editHotelPhotos');
            const previewContainer = document.getElementById('editPhotosPreview');
            
            if (!photosInput) {
                console.error('❌ Campo editHotelPhotos no encontrado');
                return;
            }
            
            if (!previewContainer) {
                console.error('❌ Contenedor editPhotosPreview no encontrado');
                return;
            }
            
            const photoPaths = getGalleryImagesFromInput();
            console.log(`🖼️ ${photoPaths.length} imagen(es) encontrada(s) para previsualizar`);
            
            previewContainer.innerHTML = '';
            
            if (photoPaths.length > 0) {
                // Agregar botón para limpiar toda la galería
                const clearAllBtn = document.createElement('button');
                clearAllBtn.type = 'button';
                clearAllBtn.onclick = clearAllGalleryPhotos;
                clearAllBtn.style.cssText = 'background: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 5px;';
                clearAllBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete_sweep</span> Eliminar todas las fotos';
                previewContainer.appendChild(clearAllBtn);
                
                // Contenedor para las fotos
                const photosWrapper = document.createElement('div');
                photosWrapper.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px;';
                
                photoPaths.forEach((photoPath, index) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.style.cssText = 'position: relative; width: 150px; height: 150px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: #f0f0f0;';
                    
                    const isUrl = !photoPath.startsWith('data:');
                    const imgSrc = photoPath.trim();
                    
                    console.log(`🖼️ Creando preview ${index + 1}: ${isUrl ? 'URL' : 'Base64'} (${imgSrc.substring(0, 50)}...)`);
                    
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.alt = `Foto ${index + 1}`;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; display: block;';
                    img.onload = function() {
                        console.log(`✅ Imagen ${index + 1} cargada correctamente`);
                    };
                    img.onerror = function() {
                        console.error(`❌ Error cargando imagen ${index + 1}`);
                        this.style.display = 'none';
                        const errorDiv = photoDiv.querySelector('.error-message');
                        if (errorDiv) errorDiv.style.display = 'flex';
                    };
                    
                    // Botón de eliminar para cada foto
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.onclick = () => deleteGalleryPhoto(index);
                    deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; z-index: 15; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);';
                    deleteBtn.title = 'Eliminar esta foto';
                    deleteBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">close</span>';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = 'display: none; width: 100%; height: 100%; background: #f0f0f0; align-items: center; justify-content: center; flex-direction: column; position: absolute; top: 0; left: 0;';
                    errorDiv.innerHTML = `
                        <span class="material-icons" style="font-size: 32px; color: #999;">broken_image</span>
                        <span style="font-size: 12px; color: #999;">Error</span>
                    `;
                    
                    const numberBadge = document.createElement('div');
                    numberBadge.style.cssText = 'position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; z-index: 10;';
                    numberBadge.textContent = index + 1;
                    
                    photoDiv.appendChild(img);
                    photoDiv.appendChild(errorDiv);
                    photoDiv.appendChild(numberBadge);
                    photoDiv.appendChild(deleteBtn);
                    
                    if (isUrl) {
                        const urlBadge = document.createElement('div');
                        urlBadge.style.cssText = 'position: absolute; bottom: 5px; right: 5px; background: rgba(33,150,243,0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 10;';
                        urlBadge.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">link</span>';
                        photoDiv.appendChild(urlBadge);
                    }
                    
                    photosWrapper.appendChild(photoDiv);
                });
                
                previewContainer.appendChild(photosWrapper);
            } else {
                previewContainer.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">Sin fotos en la galería - Agrega fotos</p>';
            }
        }

        // Función simple para abrir modal directamente (sin caché)
        function abrirModalImagenesDirecto(mode) {
            console.log('🚀 ABRIENDO MODAL DIRECTO - Modo:', mode);
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('❌ Modal no encontrado');
                alert('Error: Modal no encontrado. Recarga la página.');
                return;
            }
            
            // Abrir modal inmediatamente
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            console.log('✅ Modal abierto directamente - Display:', modal.style.display);
            
            // Llamar a la función completa después de abrir el modal
            if (typeof openImageManager === 'function') {
                setTimeout(() => openImageManager(mode), 100);
            } else {
                console.warn('⚠️ openImageManager no está disponible, configurando modal básico...');
                // Configuración básica del modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                }
            }
        }

        // Función para abrir gestor de imágenes
        function openImageManager(mode) {
            // Prevenir aperturas múltiples
            if (isImageManagerOpening) {
                console.log('⚠️ El gestor de imágenes ya se está abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            
            if (!modal) {
                console.error('❌ ERROR: Modal no encontrado');
                alert('❌ Error: Modal no encontrado. Recarga la página.');
                return;
            }
            
            // Verificar si el modal ya está abierto
            if (modal.style.display === 'block' || window.getComputedStyle(modal).display === 'block') {
                console.log('⚠️ El gestor de imágenes ya está abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('📁 ABRIENDO GESTOR DE IMÁGENES - MODO:', mode);
            
            console.log('✅ Modal encontrado, abriendo...');
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            console.log('✅ Modal abierto - Display:', modal.style.display);
            
            // Permitir nueva apertura después de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
            
            // AHORA configurar el resto
            try {
                
                // Intentar obtener hotelId de varias fuentes
                let hotelId = null;
                
                // 1. Intentar desde variable global
                if (typeof globalEditingHotelId !== 'undefined' && globalEditingHotelId) {
                    hotelId = globalEditingHotelId;
                    console.log('✅ HotelId obtenido de variable global:', hotelId);
                }
                
                // 2. Intentar desde el formulario
                if (!hotelId) {
                    const form = document.getElementById('editHotelForm');
                    if (form && form.dataset && form.dataset.hotelId) {
                        hotelId = form.dataset.hotelId;
                        if (hotelId && hotelId !== 'null' && hotelId !== 'undefined') {
                            console.log('✅ HotelId obtenido del formulario:', hotelId);
                        }
                    }
                }
                
                // 3. Si aún no tenemos hotelId, intentar obtenerlo del nombre del hotel
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    try {
                        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            const hotel = hotels.find(h => h.name === nameInput.value);
                            if (hotel && hotel.id) {
                                hotelId = hotel.id;
                                console.log('✅ HotelId obtenido por nombre del hotel:', hotelId);
                            }
                        }
                    } catch (error) {
                        console.warn('⚠️ Error buscando hotel por nombre:', error);
                    }
                }
                
                // 4. Si es un nuevo hotel, crear ID temporal
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    hotelId = 'new-hotel-' + Date.now();
                    console.log('⚠️ Usando ID temporal para nuevo hotel:', hotelId);
                }
                
                currentEditingHotelId = hotelId;
                currentImageManagerMode = mode || 'main';
                
                // Obtener datos del hotel (si existe)
                let hotelName = 'Nuevo Hotel';
                try {
                    const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                    const hotel = hotels.find(h => h.id === hotelId);
                    
                    if (hotel && hotel.name) {
                        hotelName = hotel.name;
                    } else {
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            hotelName = nameInput.value;
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Error obteniendo nombre del hotel:', error);
                }
                
                // Mostrar nombre del hotel en el modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    hotelNameSpan.textContent = hotelName;
                }
                
                // Mostrar carpeta del hotel
                const hotelFolderPath = document.getElementById('hotelFolderPath');
                if (hotelFolderPath) {
                    try {
                        const slug = getHotelSlug(hotelName);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}-${slug}/`;
                    } catch (error) {
                        console.warn('⚠️ Error generando slug:', error);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}/`;
                    }
                }
                
                // Limpiar imágenes subidas si es una nueva sesión
                uploadedImages = [];
                
                // Renderizar gestor
                try {
                    renderImageManager();
                } catch (error) {
                    console.error('❌ Error renderizando gestor:', error);
                }
                
                console.log('✅ Gestor de imágenes completamente inicializado');
                
            } catch (error) {
                console.error('❌ Error crítico en openImageManager:', error);
                alert('❌ Error al abrir el gestor de imágenes: ' + error.message);
            }
        }

        // Función para cerrar gestor de imágenes (compatibilidad)
        function closeImageManager() {
            closeImageManagerSimple();
        }

        // Función para obtener slug del hotel
        function getHotelSlug(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        }

        // Función para cargar imágenes disponibles
        function loadAvailableImages(hotelId) {
            // Implementar carga de imágenes
            console.log('Cargando imágenes para hotel:', hotelId);
        }

        // Función para cargar fotos del hotel
        function loadHotelPhotos(hotel) {
            // Implementar carga de fotos
            console.log('Cargando fotos del hotel:', hotel);
        }

        // Función para renderizar gestor de imágenes
        function renderImageManager() {
            console.log('🎨 Renderizando gestor de imágenes...');
            
            const availableContainer = document.getElementById('availableImages');
            const selectedContainer = document.getElementById('selectedImages');
            
            if (!availableContainer || !selectedContainer) {
                console.error('❌ Contenedores de imágenes no encontrados');
                return;
            }
            
            // Limpiar contenedores
            availableContainer.innerHTML = '';
            selectedContainer.innerHTML = '';
            
            // Obtener imágenes ya seleccionadas del formulario
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = getGalleryImagesFromInput();
                }
            }
            
            // Agregar imágenes subidas (nuevas)
            uploadedImages.forEach((img, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item';
                imgDiv.dataset.imagePath = img.data;
                imgDiv.dataset.imageName = img.name;
                
                if (selectedImages.includes(img.data)) {
                    imgDiv.classList.add('selected');
                }
                
                imgDiv.innerHTML = `
                    <img src="${img.data}" alt="${img.name}" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                    <div class="image-name">${img.name}</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                imgDiv.onclick = () => toggleImageSelection(img.data);
                availableContainer.appendChild(imgDiv);
            });
            
            // Mostrar imágenes seleccionadas
            selectedImages.forEach(imagePath => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item selected';
                
                imgDiv.innerHTML = `
                    <img src="${imagePath}" alt="Seleccionada" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="photo-placeholder" style="display: none;">
                        <span class="material-icons">photo</span>
                    </div>
                    <div class="image-name">Imagen seleccionada</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                selectedContainer.appendChild(imgDiv);
            });
            
            // Actualizar contador
            updatePhotoCounter();
        }

        // Función para alternar selección de imagen
        function toggleImageSelection(imagePath) {
            console.log('🔄 Alternando selección de imagen:', imagePath);
            
            // Obtener imágenes seleccionadas actuales
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = getGalleryImagesFromInput();
                }
            }
            
            // Si es modo 'main', solo puede haber una imagen seleccionada
            if (currentImageManagerMode === 'main') {
                selectedImages = [imagePath];
            } else {
                // Modo 'gallery', puede haber múltiples
                const index = selectedImages.indexOf(imagePath);
                if (index > -1) {
                    selectedImages.splice(index, 1); // Deseleccionar
                } else {
                    if (selectedImages.length < 10) {
                        selectedImages.push(imagePath); // Seleccionar
                    } else {
                        alert('⚠️ Máximo 10 imágenes en la galería');
                        return;
                    }
                }
            }
            
            // Actualizar formulario
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = selectedImages[0] || '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = selectedImages.join(', ');
                }
            }
            
            // Re-renderizar
            renderImageManager();
        }

        // Función para ver foto
        function viewPhoto(imagePath) {
            // Implementar vista de foto
            console.log('Viendo foto:', imagePath);
        }

        // Función para eliminar foto
        function deletePhoto(imagePath) {
            // Implementar eliminación de foto
            console.log('Eliminando foto:', imagePath);
        }

        // Función para actualizar contador de fotos
        function updatePhotoCounter() {
            let selectedCount = 0;
            
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedCount = 1;
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    const images = getGalleryImagesFromInput();
                    selectedCount = images.length;
                }
            }
            
            const counter = document.getElementById('photoCounter');
            if (counter) {
                const maxCount = currentImageManagerMode === 'main' ? 1 : 10;
                counter.textContent = `${selectedCount}/${maxCount} ${currentImageManagerMode === 'main' ? 'imagen' : 'fotos'} seleccionada(s)`;
                counter.style.color = selectedCount > 0 ? '#388e3c' : '#666';
            }
        }

        // Función para aplicar selección de imagen
        function applyImageSelection() {
            console.log('✅ Aplicando selección de imagen...');
            
            // Los valores ya están actualizados en el formulario por toggleImageSelection
            // Solo necesitamos cerrar el modal y actualizar previews
            
            // Actualizar previews
            if (currentImageManagerMode === 'main') {
                updateImagePreview();
            } else {
                updatePhotosPreview();
            }
            
            // Cerrar modal
            closeImageManager();
            
            alert('✅ Imágenes aplicadas correctamente');
        }

        // ============================================
        // GESTOR DE IMÁGENES - VERSIÓN NUEVA Y SIMPLE
        // ============================================
        
        // Variables globales
        let imageManagerMode = 'main'; // 'main' o 'gallery'
        let uploadedImagesBase64 = []; // Array de imágenes en base64
        let globalEditingHotelId = null; // ID del hotel que se está editando actualmente

        // Variable para prevenir aperturas múltiples del modal
        let isImageManagerOpening = false;
        
        // Función para abrir el modal de imágenes - VERSIÓN NUEVA Y SIMPLE
        function openImageManagerSimple(mode) {
            console.log('🔵 openImageManagerSimple llamada con modo:', mode);
            
            // Prevenir aperturas múltiples
            if (isImageManagerOpening) {
                console.log('⚠️ El gestor de imágenes ya se está abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('❌ Modal imageManagerModal no encontrado en el DOM');
                alert('❌ Error: Modal no encontrado. Recarga la página (F5).');
                return;
            }
            
            console.log('✅ Modal encontrado:', modal);
            
            // Verificar si el modal ya está abierto
            const currentDisplay = window.getComputedStyle(modal).display;
            if (modal.style.display === 'block' || currentDisplay === 'block') {
                console.log('⚠️ El gestor de imágenes ya está abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('🚀 Abriendo modal de imágenes - Modo:', mode);
            
            // Guardar el modo
            imageManagerMode = mode || 'main';
            
            // Configurar nombre del hotel
            const hotelNameSpan = document.getElementById('currentHotelName');
            if (hotelNameSpan) {
                const nameInput = document.getElementById('editHotelName');
                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
            }
            
            // Limpiar imágenes subidas
            uploadedImagesBase64 = [];
            updateUploadedImagesPreview();
            
            // Abrir modal con estilos forzados
            modal.style.setProperty('display', 'block', 'important');
            modal.style.setProperty('z-index', '10000', 'important');
            modal.style.setProperty('position', 'fixed', 'important');
            modal.style.setProperty('top', '0', 'important');
            modal.style.setProperty('left', '0', 'important');
            modal.style.setProperty('width', '100%', 'important');
            modal.style.setProperty('height', '100%', 'important');
            modal.style.setProperty('background-color', 'rgba(0,0,0,0.5)', 'important');
            
            console.log('✅ Modal abierto - Display:', window.getComputedStyle(modal).display);
            console.log('✅ Modal z-index:', window.getComputedStyle(modal).zIndex);
            
            // Verificar que el input de archivo existe
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput) {
                console.error('❌ Input imageUploadInput no encontrado');
            } else {
                console.log('✅ Input de archivo encontrado:', fileInput);
            }
            
            // Permitir nueva apertura después de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
        }
        
        // Función para cerrar el modal
        function closeImageManagerSimple() {
            const modal = document.getElementById('imageManagerModal');
            if (modal) {
                modal.style.display = 'none';
                isImageManagerOpening = false; // Resetear el flag
                console.log('✅ Modal cerrado');
            }
        }

        // Función para comprimir imagen antes de convertir a base64
        function compressImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo proporción
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresión
                        const compressedBase64 = canvas.toDataURL(file.type, quality);
                        const originalSize = file.size;
                        const compressedSize = Math.round((compressedBase64.length - 22) * 3 / 4); // Aproximación del tamaño
                        const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                        
                        console.log(`📦 Imagen comprimida: ${file.name} - Original: ${(originalSize / 1024).toFixed(2)} KB, Comprimida: ${(compressedSize / 1024).toFixed(2)} KB (${compressionRatio}% reducción)`);
                        
                        resolve({
                            name: file.name,
                            data: compressedBase64,
                            type: file.type,
                            size: compressedSize,
                            originalSize: originalSize
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Función para agregar imagen desde URL
        async function addImageFromURL() {
            const helpText = `🔗 Ingresa la URL de la imagen:

📋 Ejemplos de URLs que funcionan:
• https://images.unsplash.com/photo-1566073771259-6a8506099945
• https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg
• https://i.imgur.com/abc123.jpg
• https://ejemplo.com/imagen.jpg

💡 Cómo obtener la URL:
1. Haz clic derecho en la imagen
2. Selecciona "Copiar dirección de imagen"
3. Pega aquí

⚠️ La URL debe ser accesible públicamente.`;
            
            const url = prompt(helpText, 'https://');
            if (!url || !url.trim() || url === 'https://') {
                return;
            }
            
            const imageUrl = url.trim();
            
            // Validar que sea una URL válida
            try {
                new URL(imageUrl);
            } catch (e) {
                alert('❌ Por favor, ingresa una URL válida\n\nEjemplo: https://images.unsplash.com/photo-123.jpg');
                return;
            }
            
            // Verificar que sea una imagen
            const isImageExtension = imageUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i);
            const hasImageKeyword = imageUrl.toLowerCase().includes('image') || 
                                   imageUrl.toLowerCase().includes('photo') || 
                                   imageUrl.toLowerCase().includes('picture') ||
                                   imageUrl.toLowerCase().includes('img');
            
            if (!isImageExtension && !hasImageKeyword) {
                const confirm = window.confirm('⚠️ La URL no parece ser una imagen.\n\n¿Deseas continuar de todos modos?\n\n(Recomendado: URLs que terminen en .jpg, .png, etc.)');
                if (!confirm) return;
            }
            
            try {
                console.log('📥 Cargando imagen desde URL:', imageUrl);
                
                // Crear objeto de imagen
                const fileName = imageUrl.split('/').pop().split('?')[0] || 'imagen-desde-url.jpg';
                const imgObj = {
                    name: fileName.length > 50 ? fileName.substring(0, 50) + '...' : fileName,
                    data: imageUrl,
                    type: 'image/url',
                    size: 0,
                    isUrl: true,
                    originalUrl: imageUrl
                };
                
                uploadedImagesBase64.push(imgObj);
                updateUploadedImagesPreview();
                
                // Mostrar mensaje con información
                const serviceName = getImageServiceName(imageUrl);
                const message = serviceName 
                    ? `✅ Imagen agregada desde ${serviceName}\n\nLa imagen se cargará desde:\n${imageUrl.substring(0, 60)}...`
                    : `✅ Imagen agregada desde URL correctamente\n\nLa imagen se cargará desde la URL proporcionada.`;
                
                alert(message);
                
            } catch (error) {
                console.error('❌ Error agregando imagen desde URL:', error);
                alert('❌ Error al agregar la imagen.\n\nVerifica que:\n• La URL sea accesible públicamente\n• La URL sea correcta\n• El servidor permita acceso desde otros sitios\n\n💡 Tip: Prueba abriendo la URL en una nueva pestaña primero.');
            }
        }
        
        // Función auxiliar para identificar el servicio de imagen
        function getImageServiceName(url) {
            const urlLower = url.toLowerCase();
            if (urlLower.includes('unsplash.com')) return 'Unsplash';
            if (urlLower.includes('pexels.com')) return 'Pexels';
            if (urlLower.includes('pixabay.com')) return 'Pixabay';
            if (urlLower.includes('imgur.com')) return 'Imgur';
            if (urlLower.includes('imgbb.com')) return 'ImgBB';
            if (urlLower.includes('postimg.cc')) return 'Postimg';
            if (urlLower.includes('booking.com') || urlLower.includes('bstatic.com')) return 'Booking.com';
            if (urlLower.includes('tripadvisor.com')) return 'TripAdvisor';
            return null;
        }
        
        // Función para manejar la subida de imagen principal directamente desde disco
        async function handleMainImageUpload(event) {
            console.log('📁 handleMainImageUpload llamada');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('⚠️ No se seleccionó ningún archivo');
                return;
            }
            
            console.log(`📤 Procesando imagen principal: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            
            // Validar tamaño
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            try {
                // Comprimir y convertir a base64
                const compressed = await compressImage(file);
                console.log('✅ Imagen principal comprimida y lista');
                
                // Guardar en el campo del formulario
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = compressed.data;
                    updateImagePreview();
                    alert(`✅ Imagen principal "${file.name}" agregada correctamente`);
                }
                
                // Limpiar input para permitir seleccionar otra vez
                event.target.value = '';
                
            } catch (error) {
                console.error('❌ Error procesando imagen principal:', error);
                alert(`❌ Error procesando imagen "${file.name}"`);
                event.target.value = ''; // Limpiar input
            }
        }
        
        // Función para manejar la subida de imágenes de galería directamente desde disco
        async function handleGalleryImagesUpload(event) {
            console.log('📁 handleGalleryImagesUpload llamada');
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                console.log('⚠️ No se seleccionaron archivos');
                return;
            }
            
            console.log(`📤 Procesando ${files.length} imagen(es) para galería...`);
            
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput) {
                console.error('❌ Campo editHotelPhotos no encontrado');
                return;
            }
            
            const currentImages = getGalleryImagesFromInput();
            const maxSize = 10 * 1024 * 1024; // 10MB
            let processedCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tamaño
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    errorCount++;
                    continue;
                }
                
                // Validar límite de galería
                if (currentImages.length + processedCount >= 10) {
                    alert(`⚠️ Máximo 10 imágenes en la galería. Solo se procesarán las primeras ${10 - currentImages.length} imágenes.`);
                    break;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    currentImages.push(compressed.data);
                    processedCount++;
                    console.log(`✅ Imagen ${i + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    errorCount++;
                }
            }
            
            // Actualizar campo del formulario
            // Usar separador ||| para evitar conflictos con comas en base64
            photosInput.value = currentImages.join('|||');
            console.log(`💾 Guardando ${currentImages.length} imagen(es) en el campo`);
            updatePhotosPreview();
            
            // Mostrar resultado
            if (processedCount > 0) {
                const message = `✅ ${processedCount} imagen(es) agregada(s) a la galería${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
            
            // Limpiar input para permitir seleccionar otra vez
            event.target.value = '';
        }
        
        // Función para manejar la selección de archivos (para el modal)
        function handleFileSelection(event) {
            console.log('📁 handleFileSelection llamada');
            const files = event.target.files;
            const fileCount = files ? files.length : 0;
            console.log(`📁 ${fileCount} archivo(s) seleccionado(s)`);
            
            const infoDiv = document.getElementById('selectedFilesInfo');
            const countSpan = document.getElementById('fileCount');
            const uploadButton = document.getElementById('uploadButton');
            
            if (!infoDiv || !countSpan || !uploadButton) {
                console.error('❌ Elementos del formulario no encontrados');
                return;
            }
            
            if (fileCount > 0) {
                infoDiv.style.display = 'block';
                countSpan.textContent = fileCount;
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';
                console.log(`✅ ${fileCount} archivo(s) seleccionado(s) - Botón de subir habilitado`);
            } else {
                infoDiv.style.display = 'none';
                uploadButton.disabled = true;
                uploadButton.style.opacity = '0.5';
                uploadButton.style.cursor = 'not-allowed';
            }
        }
        
        // Función para subir imágenes (con compresión)
        async function uploadImagesSimple() {
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor, selecciona al menos una imagen');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const maxSize = 10 * 1024 * 1024; // 10MB (aumentado porque comprimiremos)
            
            console.log(`📤 Procesando ${files.length} imagen(es) con compresión...`);
            
            uploadedImagesBase64 = [];
            let processedCount = 0;
            let errorCount = 0;
            
            for (let index = 0; index < files.length; index++) {
                const file = files[index];
                
                // Validar tamaño original
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    uploadedImagesBase64.push(compressed);
                    processedCount++;
                    
                    console.log(`✅ Imagen ${index + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    alert(`❌ Error procesando imagen "${file.name}"`);
                    errorCount++;
                }
            }
            
            if (uploadedImagesBase64.length > 0) {
                updateUploadedImagesPreview();
                const message = `✅ ${processedCount} imagen(es) procesada(s) correctamente${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
                fileInput.value = '';
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
        }
        
        // Función para actualizar preview de imágenes subidas
        function updateUploadedImagesPreview() {
            const container = document.getElementById('uploadedImagesPreview');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (uploadedImagesBase64.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No hay imágenes subidas aún</p>';
                return;
            }
            
            uploadedImagesBase64.forEach((img, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; cursor: pointer;';
                
                // Determinar si es URL o base64
                const isUrl = img.isUrl || (!img.data.startsWith('data:'));
                const imageSrc = isUrl ? img.data : img.data;
                const badgeText = isUrl ? 'URL' : (img.originalSize ? `${Math.round((1 - img.size / img.originalSize) * 100)}%` : '');
                
                div.innerHTML = `
                    <img src="${imageSrc}" alt="${img.name}" 
                         style="width: 100%; height: 150px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'150\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'200\\' height=\\'150\\'/%3E%3Ctext fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'14\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3EError cargando imagen%3C/text%3E%3C/svg%3E';">
                    <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                        ${index + 1}
                    </div>
                    ${badgeText ? `<div style="position: absolute; top: 5px; left: 5px; background: rgba(76,175,80,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                        ${badgeText}
                    </div>` : ''}
                    ${isUrl ? `<div style="position: absolute; bottom: 30px; left: 0; right: 0; background: rgba(33,150,243,0.9); color: white; padding: 4px; font-size: 10px; text-align: center;">
                        🔗 URL Externa
                    </div>` : ''}
                    <div style="padding: 8px; font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${img.name}
                    </div>
                `;
                div.onclick = function() {
                    selectImage(img.data);
                };
                container.appendChild(div);
            });
        }
        
        // Función para seleccionar una imagen (acepta base64 o URL)
        function selectImage(imageData) {
            // imageData puede ser base64 o URL
            if (imageManagerMode === 'main') {
                // Modo imagen principal - solo una imagen
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = imageData;
                    updateImagePreview();
                }
            } else {
                // Modo galería - múltiples imágenes
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    const currentImages = getGalleryImagesFromInput();
                    if (!currentImages.includes(imageData)) {
                        currentImages.push(imageData);
                        photosInput.value = currentImages.join('|||');
                        updatePhotosPreview();
                    }
                }
            }
            
            alert('✅ Imagen seleccionada correctamente');
        }
        
        // Función para aplicar selección
        function applyImageSelectionSimple() {
            closeImageManagerSimple();
            alert('✅ Selección aplicada correctamente');
        }

        // Función antigua (mantener por compatibilidad)
        async function uploadImages() {
            const fileInput = document.getElementById('imageUpload');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor, selecciona al menos una imagen');
                return;
            }

            const files = Array.from(fileInput.files);
            const maxSize = 5 * 1024 * 1024; // 5MB máximo
            
            console.log(`📤 Subiendo ${files.length} imagen(es)...`);
            
            uploadedImages = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tamaño
                if (file.size > maxSize) {
                    alert(`⚠️ La imagen "${file.name}" es demasiado grande (máximo 5MB)`);
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ El archivo "${file.name}" no es una imagen válida`);
                    continue;
                }
                
                try {
                    // Convertir a base64
                    const base64 = await fileToBase64(file);
                    uploadedImages.push({
                        name: file.name,
                        data: base64,
                        type: file.type,
                        size: file.size
                    });
                    
                    console.log(`✅ Imagen "${file.name}" convertida a base64 (${(file.size / 1024).toFixed(2)} KB)`);
                } catch (error) {
                    console.error(`❌ Error procesando imagen "${file.name}":`, error);
                    alert(`❌ Error procesando imagen "${file.name}"`);
                }
            }
            
            if (uploadedImages.length > 0) {
                // Agregar las imágenes a las disponibles
                renderImageManager();
                alert(`✅ ${uploadedImages.length} imagen(es) procesada(s) correctamente. Ahora puedes seleccionarlas.`);
                
                // Limpiar el input
                fileInput.value = '';
            } else {
                alert('⚠️ No se pudo procesar ninguna imagen');
            }
        }
        
        // Función auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Función para crear archivo de imagen
        function createImageFile(path, fileName, hotel, photoNumber) {
            // Implementar creación de archivo
            console.log('Creando archivo de imagen:', fileName);
        }

        // Función para verificar si existe imagen
        function checkImageExists(imagePath) {
            // Implementar verificación de imagen
            console.log('Verificando imagen:', imagePath);
            return true;
        }

        // Función para validar ruta de imagen
        function validateImagePath(imagePath) {
            // Implementar validación de ruta
            console.log('Validando ruta:', imagePath);
            return true;
        }

        // Función para mostrar ayuda de imagen
        function showImageHelp() {
            // Implementar ayuda de imagen
            console.log('Mostrando ayuda de imagen...');
        }

        // Función para eliminar hotel
        async function deleteHotel(hotelId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este hotel? Esta acción no se puede deshacer.')) {
                return;
            }
            
            console.log('🗑️ Eliminando hotel:', hotelId);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.deleteHotel(hotelId);
                    console.log('✅ Hotel eliminado de Supabase');
                    alert('✅ Hotel eliminado correctamente');
                    loadHotelsTable();
                    updateHotelsStats();
                    return;
                }
            } catch (error) {
                console.error('Error eliminando hotel:', error);
            }
            
            // Fallback localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const index = hotels.findIndex(h => h.id === hotelId || h.id == hotelId);
            if (index !== -1) {
                hotels.splice(index, 1);
                localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                alert('✅ Hotel eliminado correctamente');
                loadHotelsTable();
                updateHotelsStats();
            }
        }

        // Función para ver hotel
        async function viewHotel(hotelId) {
            console.log('👁️ Viendo hotel:', hotelId);
            
            // Buscar hotel en Supabase primero
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                    console.log('📡 Hotel cargado de Supabase:', hotel?.name);
                } catch (error) {
                    console.error('Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback localStorage
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                console.log('💾 Hotel cargado de localStorage:', hotel?.name);
            }
            
            if (!hotel) {
                alert('❌ Hotel no encontrado');
                console.error('Hotel no encontrado con ID:', hotelId);
                return;
            }
            
            // Obtener valores soportando ambos formatos
            const hotelName = hotel.name || hotel.hotel_name || 'Sin nombre';
            const hotelLocation = hotel.location || hotel.address || 'Sin ubicación';
            const hotelPrice = hotel.price || hotel.base_price || 0;
            const hotelRating = hotel.rating || hotel.stars || 0;
            const hotelStatus = hotel.status || 'Activo';
            const hotelDescription = hotel.description || '';
            const hotelWebsite = hotel.website || '';
            const hotelGoogleMaps = hotel.googleMaps || hotel.google_maps || '';
            const florInfo = hotel.florInfo || hotel.flor_info || {};
            const amenities = hotel.amenities || [];
            
            // Crear modal de vista
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            // Generar estrellas
            let stars = '';
            for (let i = 0; i < 5; i++) {
                stars += i < hotelRating ? '⭐' : '☆';
            }
            
            // Generar sección de amenities
            let amenitiesHtml = '';
            if (amenities && amenities.length > 0) {
                amenitiesHtml = `<p style="margin: 8px 0;"><strong>🏊 Amenities:</strong> ${Array.isArray(amenities) ? amenities.join(', ') : amenities}</p>`;
            }
            
            // Generar sección de Flor IA
            let florInfoHtml = '';
            if (florInfo && Object.keys(florInfo).length > 0) {
                florInfoHtml = `
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9, #f3e5f5); border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #7b1fa2;">🤖 Información para Flor IA</h4>
                        ${florInfo.services ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Servicios:</strong> ${florInfo.services.substring(0, 100)}...</p>` : ''}
                        ${florInfo.excursions ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Excursiones:</strong> ${florInfo.excursions.substring(0, 100)}...</p>` : ''}
                        ${florInfo.prices ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Precios:</strong> ${florInfo.prices.substring(0, 100)}...</p>` : ''}
                        <p style="margin: 5px 0; font-size: 0.8rem; color: #666;">✅ Flor puede responder sobre este hotel</p>
                    </div>
                `;
            } else {
                florInfoHtml = `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">⚠️ Sin información para Flor IA</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem;">Edita este hotel para agregar información que Flor pueda usar.</p>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">🏨 ${hotelName}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>📍 Ubicación:</strong> ${hotelLocation}</p>
                        <p style="margin: 8px 0;"><strong>💰 Precio:</strong> ${hotelPrice ? '$' + hotelPrice + ' USD' : 'No especificado'}</p>
                        <p style="margin: 8px 0;"><strong>⭐ Calificación:</strong> ${stars} (${hotelRating}/5)</p>
                        <p style="margin: 8px 0;"><strong>📊 Estado:</strong> 
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${hotelStatus === 'Activo' ? '#e8f5e9' : '#ffebee'}; color: ${hotelStatus === 'Activo' ? '#2e7d32' : '#c62828'};">
                                ${hotelStatus}
                            </span>
                        </p>
                        ${hotelDescription ? `<p style="margin: 8px 0;"><strong>📝 Descripción:</strong> ${hotelDescription}</p>` : ''}
                        ${amenitiesHtml}
                        ${hotelWebsite ? `<p style="margin: 8px 0;"><strong>🌐 Web:</strong> <a href="${hotelWebsite}" target="_blank">${hotelWebsite}</a></p>` : ''}
                        ${hotelGoogleMaps ? `<p style="margin: 8px 0;"><strong>🗺️ Google Maps:</strong> <a href="${hotelGoogleMaps}" target="_blank">Ver ubicación</a></p>` : ''}
                    </div>
                    
                    ${florInfoHtml}
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="this.closest('.modal').remove(); editHotel('${hotelId}')" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ✏️ Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        // Función para exportar hoteles
        function exportHotels() {
            // Implementar exportación
            console.log('Exportando hoteles...');
        }

        // Función para refrescar hoteles
        function refreshHotels() {
            loadHotelsTable();
            updateStats();
            alert('Datos actualizados correctamente');
        }

        // Función para inicializar dashboard
        async function initializeDashboard() {
            // Inicializar bases de datos
            if (typeof initClientesDB === 'function') {
                initClientesDB();
            }
            if (typeof initHotelsDB === 'function') {
                initHotelsDB();
            }
            // IMPORTANTE: Esperar a que las reservas se carguen de Supabase antes de continuar
            if (typeof initReservationsDB === 'function') {
                await initReservationsDB();
            }
            if (typeof initQuotesDB === 'function') {
                initQuotesDB();
            }
            if (typeof syncQuotesFromIndex === 'function') {
                syncQuotesFromIndex();
            }
            
            window.showSection('dashboard', null);
            
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            // Actualizar estadísticas del dashboard (incluye Ingresos de Hoy)
            // AHORA los datos de reservas ya están cargados de Supabase
            if (typeof updateStats === 'function') {
                updateStats();
            }
            
            // Event listeners para el formulario de edición de hoteles
            const editHotelForm = document.getElementById('editHotelForm');
            if (editHotelForm) {
                editHotelForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveHotelChanges();
                });
            }
            
            // Event listeners para previews en tiempo real (ELIMINADOS - campos de imagen removidos)
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                const editModal = document.getElementById('editHotelModal');
                const imageModal = document.getElementById('imageManagerModal');
                const carouselModal = document.getElementById('photoCarouselModal');
                const newQuoteModal = document.getElementById('newQuoteModal');
                // const whatsappConfigModal = document.getElementById('whatsappConfigModal'); // ELIMINADO
                const sendCotizadorLinkModal = document.getElementById('sendCotizadorLinkModal');
                const importUsersModal = document.getElementById('importUsersModal');
                
                if (event.target === editModal) {
                    closeEditModal();
                }
                // NO cerrar el modal de imágenes al hacer clic fuera - solo cerrar cuando se hace clic en el botón cerrar
                // if (event.target === imageModal) {
                //     closeImageManager();
                // }
                if (event.target === carouselModal) {
                    // Implementar cierre de carrusel
                }
                if (event.target === newQuoteModal) {
                    closeNewQuoteModal();
                }
                // if (event.target === whatsappConfigModal) { // ELIMINADO - Modal ya no existe
                //     closeWhatsAppConfig();
                // }
                if (event.target === sendCotizadorLinkModal) {
                    closeSendCotizadorLinkModal();
                }
                if (event.target === importUsersModal) {
                    closeImportUsersModal();
                }
            });
            
            // ============================================
            // SUSCRIPCIONES EN TIEMPO REAL
            // ============================================
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                console.log('🔄 Activando suscripciones en tiempo real...');
                
                window.supabaseClient.subscribeToAllChanges({
                    onReservationChange: (payload) => {
                        console.log('🔔 Cambio en reservas detectado:', payload.eventType);
                        // Recargar datos de reservas
                        if (typeof initReservationsDB === 'function') {
                            initReservationsDB().then(() => {
                                if (typeof updateStats === 'function') updateStats();
                                if (typeof loadReservationsTable === 'function') loadReservationsTable();
                            });
                        }
                    },
                    onHotelChange: (payload) => {
                        console.log('🔔 Cambio en hoteles detectado:', payload.eventType);
                        if (typeof loadHotelsTable === 'function') loadHotelsTable();
                        if (typeof updateHotelsStats === 'function') updateHotelsStats();
                    },
                    onAgentChange: (payload) => {
                        console.log('🔔 Cambio en agentes detectado:', payload.eventType);
                        if (typeof loadAgentsTable === 'function') loadAgentsTable();
                    },
                    onExpenseChange: (payload) => {
                        console.log('🔔 Cambio en gastos detectado:', payload.eventType);
                        if (typeof loadExpensesTable === 'function') loadExpensesTable();
                        if (typeof updateExpensesStats === 'function') updateExpensesStats();
                    },
                    onQuoteChange: (payload) => {
                        console.log('🔔 Cambio en cotizaciones detectado:', payload.eventType);
                        if (typeof loadQuotesTable === 'function') loadQuotesTable();
                    },
                    onUserChange: (payload) => {
                        console.log('🔔 Cambio en usuarios detectado:', payload.eventType);
                        if (typeof loadUsersTable === 'function') loadUsersTable();
                    }
                });
                
                console.log('✅ Suscripciones en tiempo real activas');
            } else {
                console.warn('⚠️ Supabase no disponible - no hay sincronización en tiempo real');
            }
        }

        // Función para limpiar imágenes duplicadas
        function cleanDuplicateImages() {
            // Implementar limpieza
            console.log('Limpiando imágenes duplicadas...');
        }

        // Función para resetear gestor de imágenes
        function resetImageManager() {
            console.log('🔄 Reseteando gestor de imágenes...');
            
            // Limpiar imágenes subidas
            uploadedImages = [];
            
            // Limpiar selecciones
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = '';
                }
            }
            
            // Limpiar input de archivos
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Re-renderizar
            renderImageManager();
            
            alert('✅ Gestor de imágenes reseteado');
        }

        // Función para abrir carrusel de fotos
        function openPhotoCarousel() {
            // Implementar carrusel
            console.log('Abriendo carrusel de fotos...');
        }

        // Función para cerrar carrusel de fotos
        function closePhotoCarousel() {
            // Implementar cierre de carrusel
            console.log('Cerrando carrusel de fotos...');
        }

        // Función para actualizar imagen del carrusel
        function updateCarouselImage() {
            // Implementar actualización de imagen
            console.log('Actualizando imagen del carrusel...');
        }

        // Función para actualizar miniaturas del carrusel
        function updateCarouselThumbnails() {
            // Implementar actualización de miniaturas
            console.log('Actualizando miniaturas del carrusel...');
        }

        // Función para actualizar contador del carrusel
        function updateCarouselCounter() {
            // Implementar contador
            console.log('Actualizando contador del carrusel...');
        }

        // Función para foto anterior
        function previousPhoto() {
            // Implementar foto anterior
            console.log('Foto anterior...');
        }

        // Función para foto siguiente
        function nextPhoto() {
            // Implementar foto siguiente
            console.log('Foto siguiente...');
        }

        // Función para manejar teclas del carrusel
        function handleCarouselKeydown(event) {
            // Implementar manejo de teclas
            console.log('Manejando tecla:', event.key);
        }

        // Función para cargar fotos guardadas
        function loadSavedPhotos() {
            // Implementar carga de fotos
            console.log('Cargando fotos guardadas...');
        }

        // ===== FUNCIONES PARA GESTIÓN DE COTIZACIONES =====
        
        // Función para inicializar base de datos de cotizaciones
        function initQuotesDB() {
            console.log('📋 Inicializando base de datos de cotizaciones...');
            
            // Verificar si ya existen cotizaciones en localStorage
            let existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            console.log(`📊 Estado inicial: ${existingQuotes.length} cotizaciones en quotesDB`);
            
            // Verificar si hay cotizaciones en el sistema antiguo (checkin24hs_quotes)
            const oldQuotes = JSON.parse(localStorage.getItem('checkin24hs_quotes') || '[]');
            console.log(`📊 Cotizaciones en sistema antiguo: ${oldQuotes.length}`);
            
            // Migrar cotizaciones del sistema antiguo al nuevo si existen
            if (oldQuotes.length > 0) {
                console.log('🔄 Migrando cotizaciones del sistema antiguo...');
                
                // Convertir formato antiguo al nuevo formato
                const migratedQuotes = oldQuotes.map(oldQuote => {
                    // Buscar si ya existe esta cotización en el nuevo sistema (por ID)
                    const exists = existingQuotes.some(q => 
                        q.id === oldQuote.id || 
                        (q.id && String(q.id) === String(oldQuote.id))
                    );
                    
                    if (exists) {
                        console.log(`⏭️ Cotización ${oldQuote.id} ya existe, omitiendo...`);
                        return null;
                    }
                    
                    // Convertir formato antiguo al nuevo
                    const newQuote = {
                        id: oldQuote.id ? `COT-${oldQuote.id}` : `COT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        hotel: oldQuote.hotel || `Hotel ${oldQuote.hotel_id || 'Desconocido'}`,
                        hotelId: oldQuote.hotel_id,
                        checkIn: oldQuote.check_in_date,
                        checkOut: oldQuote.check_out_date,
                        dateRange: oldQuote.check_in_date && oldQuote.check_out_date 
                            ? `${formatDateForDisplay(oldQuote.check_in_date)} - ${formatDateForDisplay(oldQuote.check_out_date)}`
                            : 'Fechas no especificadas',
                        travelers: oldQuote.guests ? `${oldQuote.guests} huésped${oldQuote.guests > 1 ? 'es' : ''}` : 'No especificado',
                        adults: oldQuote.guests || 1,
                        children: 0,
                        tariff: oldQuote.total_price || 0,
                        finalTariff: oldQuote.total_price || 0,
                        clientName: oldQuote.clientName || 'Anónimo',
                        notes: oldQuote.special_requests || '',
                        status: oldQuote.status || 'pending',
                        timestamp: oldQuote.created_at || oldQuote.timestamp || new Date().toISOString(),
                        source: 'migrado'
                    };
                    
                    return newQuote;
                }).filter(q => q !== null); // Eliminar nulls (duplicados)
                
                if (migratedQuotes.length > 0) {
                    // Agregar cotizaciones migradas al array existente
                    existingQuotes = [...existingQuotes, ...migratedQuotes];
                    localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
                    console.log(`✅ ${migratedQuotes.length} cotizaciones migradas exitosamente`);
                    
                    // Marcar como migrado (no eliminar por si acaso)
                    localStorage.setItem('checkin24hs_quotes_migrated', 'true');
                } else {
                    console.log('ℹ️ No hay cotizaciones nuevas para migrar');
                }
            }
            
            console.log(`📊 Total de cotizaciones después de migración: ${existingQuotes.length}`);
            
            if (existingQuotes.length === 0) {
                console.log('📋 No hay cotizaciones, la base de datos se inicializará cuando lleguen las primeras cotizaciones');
            }
            
            // Cargar cotizaciones iniciales
            loadQuotesTable();
            updateQuotesStats();
        }
        
        // Función auxiliar para formatear fechas
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }
        
        // Función para obtener etiqueta de estado de cotización
        function getStatusLabel(status) {
            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'processed': 'Procesada',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada',
                'rejected': 'Rechazada',
                'sent': 'Enviada',
                'completed': 'Completada'
            };
            return statusLabels[status] || status || 'Pendiente';
        }
        
        // Función para cargar tabla de cotizaciones
        // Cargar tabla de cotizaciones - VERSIÓN SIMPLIFICADA
        async function loadQuotesTable() {
            // FORZAR DIMENSIONES PRIMERO (antes de cargar datos) - MÚLTIPLES INTENTOS
            if (typeof forceQuotesSectionDimensions === 'function') {
                console.log('🔧 Llamando a forceQuotesSectionDimensions desde loadQuotesTable...');
                // Ejecutar inmediatamente
                forceQuotesSectionDimensions();
                // Ejecutar después de un frame
                requestAnimationFrame(() => {
                    forceQuotesSectionDimensions();
                });
                // Ejecutar después de un pequeño delay
                setTimeout(() => {
                    forceQuotesSectionDimensions();
                }, 100);
            } else {
                console.warn('⚠️ forceQuotesSectionDimensions no está definida');
            }
            
            try {
                // Cargar datos desde Supabase o localStorage
                let quotes = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        quotes = await window.supabaseClient.getQuotes();
                    } catch (error) {
                        quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                    }
                } else {
                    quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                }
                
                const tbody = document.getElementById('quotesTableBody');
                const noQuotesMessage = document.getElementById('noQuotesMessage');
                const tableContainer = document.querySelector('#quotes-section .table-container');
                
                if (!tbody) {
                    console.error('❌ No se encontró quotesTableBody');
                    return;
                }
                
                // Ocultar mensaje de "no hay cotizaciones" si hay datos
                if (noQuotesMessage) {
                    noQuotesMessage.style.display = quotes.length === 0 ? 'block' : 'none';
                }
                
                if (quotes.length === 0) {
                    tbody.innerHTML = '';
                    return;
                }
                
                // Limpiar y renderizar tabla
                tbody.innerHTML = '';
                quotes.forEach((quote, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${quote.id || `COT-${String(index + 1).padStart(3, '0')}`}</td>
                        <td>${quote.hotel}</td>
                        <td>${quote.clientName || 'Anónimo'}</td>
                        <td>${quote.dateRange}</td>
                        <td>${quote.travelers}</td>
                        <td><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></td>
                        <td>${formatDate(quote.timestamp || new Date())}</td>
                        <td>
                            <button onclick="viewQuote('${quote.id || index}')" class="action-btn view" title="Ver detalles">
                                <span class="material-icons">visibility</span>
                            </button>
                            ${(quote.status === 'pending' || !quote.status) ? `
                            <button onclick="editQuote('${quote.id || index}')" class="action-btn edit" title="Editar y Cotizar" style="background: #ff9800;">
                                <span class="material-icons">edit</span>
                            </button>
                            ` : ''}
                            <button onclick="processQuote('${quote.id || index}')" class="action-btn edit" title="Procesar">
                                <span class="material-icons">check_circle</span>
                            </button>
                            <button onclick="deleteQuote('${quote.id || index}')" class="action-btn delete" title="Eliminar">
                                <span class="material-icons">delete</span>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Asegurar que el contenedor tenga dimensiones visibles
                if (tableContainer) {
                    const rowCount = quotes.length;
                    const minHeight = Math.max(400, rowCount * 50);
                    tableContainer.style.cssText = `
                        display: block !important;
                        visibility: visible !important;
                        width: 100% !important;
                        min-width: 100% !important;
                        min-height: ${minHeight}px !important;
                        height: auto !important;
                        overflow-x: auto !important;
                        overflow-y: visible !important;
                        background-color: white !important;
                        position: relative !important;
                        z-index: 1 !important;
                    `;
                    
                    const table = tableContainer.querySelector('table');
                    if (table) {
                        table.style.cssText = `
                            width: 100% !important;
                            min-width: 100% !important;
                            display: table !important;
                            visibility: visible !important;
                            border-collapse: collapse !important;
                            table-layout: auto !important;
                        `;
                    }
                }
                
                console.log(`✅ ${quotes.length} cotizaciones cargadas en la tabla`);
            } catch (error) {
                console.error('❌ Error en loadQuotesTable:', error);
            }
        }
        
        // Función para actualizar estadísticas de cotizaciones
        function updateQuotesStats() {
            console.log('📊 Actualizando estadísticas de cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            // Calcular estadísticas
            const totalQuotes = quotes.length;
            const pendingQuotes = quotes.filter(q => !q.status || q.status === 'pending').length;
            const processedQuotes = quotes.filter(q => q.status === 'processed').length;
            
            // Calcular promedio por día (últimos 7 días)
            const last7Days = quotes.filter(q => {
                const quoteDate = new Date(q.timestamp);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return quoteDate >= weekAgo;
            });
            const avgQuotesPerDay = last7Days.length / 7;
            
            // Actualizar elementos en el DOM
            const totalElement = document.getElementById('totalQuotes');
            const pendingElement = document.getElementById('pendingQuotes');
            const processedElement = document.getElementById('processedQuotes');
            const avgElement = document.getElementById('avgQuotesPerDay');
            
            if (totalElement) totalElement.textContent = totalQuotes;
            if (pendingElement) pendingElement.textContent = pendingQuotes;
            if (processedElement) processedElement.textContent = processedQuotes;
            if (avgElement) avgElement.textContent = avgQuotesPerDay.toFixed(1);
            
            console.log(`📊 Estadísticas actualizadas: Total=${totalQuotes}, Pendientes=${pendingQuotes}, Procesadas=${processedQuotes}, Promedio/Día=${avgQuotesPerDay.toFixed(1)}`);
        }
        
        // Función para calcular acumulado de ventas del mes vigente
        function calculateMonthlySalesAccumulated() {
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            console.log('📅 Calculando acumulado para:', currentYear, 'mes', currentMonth);
            console.log('📊 Total de reservas:', reservations.length);
            
            // Filtrar reservas del mes actual que no estén canceladas
            const monthlyReservations = reservations.filter(reservation => {
                // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                const checkInDate = reservation.checkIn || reservation.check_in;
                
                if (!checkInDate || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                    return false;
                }
                
                // Normalizar fecha de check-in
                let dateStr = checkInDate;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return false;
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                // Verificar que sea del mes actual
                return year === currentYear && month === currentMonth;
            });
            
            console.log('📋 Reservas del mes actual:', monthlyReservations.length);
            
            // Calcular total acumulado
            const total = monthlyReservations.reduce((sum, res) => {
                const amount = parseFloat(res.totalAmount) || 
                             parseFloat(res.total_amount) || 
                             parseFloat(res.amount) || 
                             parseFloat(res.price) || 0;
                return sum + amount;
            }, 0);
            
            console.log('💰 Total acumulado:', total);
            return total;
        }
        
        // Función para ver detalles de una cotización
        function viewQuote(quoteId) {
            console.log('👁️ Viendo detalles de cotización:', quoteId);
            
            try {
                const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
                
                if (!quote) {
                    alert('❌ Cotización no encontrada');
                    return;
                }
                
                // Crear modal con detalles de la cotización
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90%; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; margin: 2% auto;">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <h2>Detalles de Cotización</h2>
                        
                        <div style="display: grid; gap: 15px;">
                        ${quote.clientName ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #1976d2;">
                            <span style="font-size: 1.5rem;">👤</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Cliente</div>
                                <div style="color: #1976d2; font-size: 1.1rem; font-weight: 500;">${quote.clientName}</div>
                                ${quote.clientFirstName && quote.clientLastName ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                    ${quote.clientFirstName} ${quote.clientLastName}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">🏨</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Hotel</div>
                                <div style="color: #666;">${quote.hotel}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📅</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fechas</div>
                                <div style="color: #666;">${quote.dateRange}</div>
                                <div style="font-size: 0.8rem; color: #888;">Check-in: ${quote.checkIn} | Check-out: ${quote.checkOut}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">👥</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Huéspedes</div>
                                <div style="color: #666;">${quote.travelers}</div>
                                ${quote.children > 0 ? `<div style="font-size: 0.8rem; color: #888;">Edades: ${quote.childrenAges.join(', ')} años</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📊</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Estado</div>
                                <div style="color: #666;"><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">🕐</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fecha de Solicitud</div>
                                <div style="color: #666;">${formatDate(quote.timestamp)}</div>
                            </div>
                        </div>
                        
                        ${quote.module ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📦</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Módulo</div>
                                <div style="color: #666;">${quote.module}</div>
                    </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientEmail ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📧</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Email</div>
                                <div style="color: #666;">${quote.clientEmail}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientPhone ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">📱</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Teléfono</div>
                                <div style="color: #666;">${quote.clientPhone}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.notes ? `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">📝 Notas</div>
                            <div style="color: #666;">${quote.notes}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${(quote.status === 'pending' || !quote.status) && (!quote.tariff || quote.tariff === 0) ? `
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="margin-bottom: 15px; color: #856404;">💰 Asignar Tarifa</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa *</label>
                                <input type="number" id="quoteTariffInput" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Descuento</label>
                                <input type="number" id="quoteDiscountInput" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa Final</label>
                            <input type="number" id="quoteFinalTariffInput" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; width: 100%;" value="0.00">
                        </div>
                        <button onclick="assignTariffToQuote('${quoteId}')" class="form-button" style="background: #ffc107; color: #333; width: 100%;">
                            💰 Asignar Tarifa y Enviar al Cliente
                        </button>
                    </div>
                    ` : quote.tariff > 0 ? `
                    <div style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #155724;">💰 Tarifa Asignada</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa</div>
                                <div style="color: #666; font-size: 1.2rem;">$${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Descuento</div>
                                <div style="color: #666; font-size: 1.2rem;">$${(quote.discount || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #c3e6cb;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa Final</div>
                            <div style="color: #155724; font-size: 1.5rem; font-weight: bold;">$${(quote.finalTariff || quote.tariff).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${(quote.status === 'pending' || !quote.status) ? `
                        <button onclick="processQuote('${quoteId}')" class="form-button" style="background: #28a745; color: white;">
                            ✅ Marcar como Procesada
                        </button>
                        ` : ''}
                        <button onclick="deleteQuote('${quoteId}')" class="form-button" style="background: #dc3545; color: white;">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
                document.body.appendChild(modal);
                console.log('✅ Modal creado y agregado al DOM');
                
                // Cerrar modal al hacer clic fuera
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('❌ Error al mostrar modal de cotización:', error);
                alert('❌ Error al mostrar los detalles de la cotización: ' + error.message);
            }
        }
        
        // Función para editar y cotizar una cotización pendiente
        function editQuote(quoteId) {
            console.log('✏️ Editando cotización:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (!quote) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>✏️ Editar y Cotizar</h2>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">👤 Información del Cliente</div>
                        <div style="color: #666;">
                            <div><strong>Nombre Completo:</strong> ${quote.clientName || 'No especificado'}</div>
                            ${quote.clientFirstName ? `<div><strong>Nombre:</strong> ${quote.clientFirstName}</div>` : ''}
                            ${quote.clientLastName ? `<div><strong>Apellido:</strong> ${quote.clientLastName}</div>` : ''}
                            ${quote.clientEmail ? `<div><strong>Email:</strong> ${quote.clientEmail}</div>` : ''}
                            ${quote.clientPhone ? `<div><strong>Teléfono:</strong> ${quote.clientPhone}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">📋 Detalles de la Cotización</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            <div><strong>Hotel:</strong> ${quote.hotel}</div>
                            <div><strong>Módulo:</strong> ${quote.module || 'No especificado'}</div>
                            <div><strong>Fechas:</strong> ${quote.dateRange}</div>
                            <div><strong>Noches:</strong> ${quote.nights || 'N/A'}</div>
                            <div><strong>Huéspedes:</strong> ${quote.travelers}</div>
                        </div>
                    </div>
                    
                    <form id="editQuoteForm" onsubmit="saveEditedQuote(event, '${quoteId}')">
                        <h3 style="margin-bottom: 15px; color: #333;">💰 Asignar Tarifa</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label class="form-label">Tarifa *</label>
                                <input type="number" id="editQuoteTariff" class="form-input" min="0" step="0.01" required 
                                       placeholder="0.00" value="${quote.tariff || ''}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descuento</label>
                                <input type="number" id="editQuoteDiscount" class="form-input" min="0" step="0.01" 
                                       placeholder="0.00" value="${quote.discount || 0}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Tarifa Final</label>
                            <input type="number" id="editQuoteFinalTariff" class="form-input" step="0.01" readonly 
                                   style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" 
                                   value="${(quote.finalTariff || quote.tariff || 0).toFixed(2)}">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Notas adicionales (opcional)</label>
                            <textarea id="editQuoteNotes" class="form-input" rows="3" 
                                      placeholder="Agregar notas o comentarios adicionales">${quote.notes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button type="button" class="form-button secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="submit" class="form-button" style="background: #25d366; color: white;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                                Guardar y Enviar al Cliente
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calcular tarifa final inicial
            calculateEditQuoteFinalTariff();
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Función para calcular tarifa final en el modal de edición
        function calculateEditQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('editQuoteTariff')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('editQuoteDiscount')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('editQuoteFinalTariff');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Función para guardar cotización editada y enviar al cliente
        async function saveEditedQuote(event, quoteId) {
            event.preventDefault();
            console.log('💾 Guardando cotización editada:', quoteId);
            
            const tariff = parseFloat(document.getElementById('editQuoteTariff').value);
            const discount = parseFloat(document.getElementById('editQuoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('editQuoteFinalTariff').value);
            const notes = document.getElementById('editQuoteNotes').value.trim();
            
            if (!tariff || tariff <= 0) {
                alert('❌ Por favor ingresa una tarifa válida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Actualizar cotización
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            if (notes) {
                quotes[quoteIndex].notes = notes;
            }
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Cotización actualizada:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Enviar al cliente por WhatsApp
            if (quotes[quoteIndex].clientPhone) {
                const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                
                try {
                    await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                    
                    // Cambiar estado a "enviado"
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('✅ Cotización guardada y enviada exitosamente al cliente por WhatsApp!');
                } catch (error) {
                    console.error('Error enviando:', error);
                    const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                    window.open(whatsappUrl, '_blank');
                    
                    // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('✅ Cotización guardada. Se abrió WhatsApp Web/App. Por favor, envía el mensaje manualmente.');
                }
            } else {
                alert('✅ Cotización guardada exitosamente');
            }
        }
        
        // Función para calcular tarifa final en el modal
        function calculateQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('quoteFinalTariffInput');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Función para asignar tarifa a una cotización
        async function assignTariffToQuote(quoteId) {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0);
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariffInput')?.value || 0);
            
            if (!tariff || tariff <= 0) {
                alert('❌ Por favor ingresa una tarifa válida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            // Actualizar cotización con tarifa
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Tarifa asignada a cotización:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal actual
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Preguntar si desea enviar al cliente
            if (quotes[quoteIndex].clientPhone) {
                if (confirm('✅ Tarifa asignada. ¿Deseas enviar la cotización con la tarifa al cliente por WhatsApp?')) {
                    // Formatear mensaje con tarifa
                    const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                    
                    // Enviar por WhatsApp
                    try {
                        await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                        
                        // Cambiar estado a "enviado"
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('✅ Cotización con tarifa enviada exitosamente al cliente!');
                    } catch (error) {
                        console.error('Error enviando:', error);
                        const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                        window.open(whatsappUrl, '_blank');
                        
                        // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('⚠️ Se abrió WhatsApp Web/App. Por favor, envía el mensaje manualmente.');
                    }
                }
            } else {
                alert('✅ Tarifa asignada exitosamente');
            }
        }
        
        // Función para procesar una cotización
        function processQuote(quoteId) {
            console.log('✅ Procesando cotización:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            quotes[quoteIndex].status = 'processed';
            quotes[quoteIndex].processedAt = new Date().toISOString();
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estadísticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Cotización marcada como procesada');
            
            // Cerrar modal si está abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para eliminar una cotización
        function deleteQuote(quoteId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            console.log('🗑️ Eliminando cotización:', quoteId);
            
            if (!confirm('¿Estás seguro de que quieres eliminar esta cotización?')) {
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('❌ Cotización no encontrada');
                return;
            }
            
            quotes.splice(quoteIndex, 1);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estadísticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Cotización eliminada');
            
            // Cerrar modal si está abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para actualizar cotizaciones
        function refreshQuotes() {
            console.log('🔄 Actualizando cotizaciones...');
            loadQuotesTable();
            updateQuotesStats();
            alert('✅ Cotizaciones actualizadas');
        }
        
        // Función para exportar cotizaciones
        function exportQuotes() {
            console.log('📤 Exportando cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            if (quotes.length === 0) {
                alert('❌ No hay cotizaciones para exportar');
                return;
            }
            
            // Crear CSV
            let csv = 'ID,Hotel,Cliente,Fechas,Huéspedes,Estado,Fecha\n';
            
            quotes.forEach((quote, index) => {
                csv += `${quote.id || `COT-${String(index + 1).padStart(3, '0')}`},`;
                csv += `"${quote.hotel}",`;
                csv += `"${quote.clientName || 'Anónimo'}",`;
                csv += `"${quote.dateRange}",`;
                csv += `"${quote.travelers}",`;
                csv += `"${quote.status || 'Pendiente'}",`;
                csv += `"${formatDate(quote.timestamp)}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cotizaciones_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('✅ Cotizaciones exportadas correctamente');
        }
        
        // Función para limpiar todas las cotizaciones
        function clearAllQuotes() {
            console.log('🗑️ Limpiando todas las cotizaciones...');
            
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (!confirm('¿Estás seguro de que quieres eliminar TODAS las cotizaciones? Esta acción no se puede deshacer.')) {
                return;
            }
            
            localStorage.removeItem('quotesDB');
            loadQuotesTable();
            updateQuotesStats();
            
            alert('✅ Todas las cotizaciones han sido eliminadas');
        }
        
        // Función para filtrar cotizaciones
        function filterQuotes() {
            console.log('🔍 Filtrando cotizaciones...');
            
            const searchTerm = document.getElementById('quotesSearch').value.toLowerCase();
            const tbody = document.getElementById('quotesTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ========== FUNCIONES DEL COTIZADOR ==========
        
        // Función para mostrar modal de envío de link del cotizador
        function showSendCotizadorLinkModal() {
            console.log('📱 Abriendo modal para enviar link del cotizador...');
            
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('sendLinkForm').reset();
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            // Formatear mensaje con el link en una línea separada para que sea más visible
            document.getElementById('linkMessage').value = `Hola! 👋\n\nTe envío el link para que puedas solicitar tu cotización personalizada:\n\n${cotizadorLink}\n\n✅ Completa el formulario y te enviaremos tu cotización personalizada.\n\n¡Gracias por confiar en nosotros! 🙏`;
            // Limpiar imagen seleccionada
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
            
            // Si hay una imagen subida en la página de cotizaciones, usarla
            if (quoteImageFile) {
                // Crear un DataTransfer para asignar el archivo al input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(quoteImageFile);
                document.getElementById('linkImageInput').files = dataTransfer.files;
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(quoteImageFile);
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar modal de envío de link
        function closeSendCotizadorLinkModal() {
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para previsualizar imagen en el modal
        function previewLinkImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Función para eliminar imagen del modal
        function removeLinkImage() {
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
        }
        
        // Variable global para almacenar la imagen subida en la página de cotizaciones
        let quoteImageFile = null;
        
        // Función para manejar la subida de imagen en la página de cotizaciones
        function handleQuoteImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                quoteImageFile = file;
                alert(`✅ Imagen seleccionada: ${file.name}\n\nLa imagen se incluirá cuando envíes el link del cotizador.`);
            }
        }
        
        // Función para generar link del cotizador
        function getCotizadorLink() {
            // Si estamos en un servidor web, usar la URL actual
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) || window.location.origin;
                return `${baseUrl}/cotizador-cliente.html`;
            }
            
            // Si estamos en file://, generar una URL relativa que funcione
            // Nota: Para que funcione completamente, el archivo debe estar en un servidor web
            return './cotizador-cliente.html';
        }
        
        // Función para enviar link del cotizador por WhatsApp
        async function sendCotizadorLink(event) {
            event.preventDefault();
            console.log('📱 Enviando link del cotizador...');
            
            const phoneNumber = document.getElementById('linkPhoneNumber').value.trim();
            const customMessage = document.getElementById('linkMessage').value.trim();
            
            if (!phoneNumber) {
                alert('❌ Por favor ingresa el número de WhatsApp del cliente');
                return;
            }
            
            // Limpiar número de teléfono
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('❌ El número de teléfono no es válido. Debe incluir el código de país.');
                return;
            }
            
            // Obtener imagen si está seleccionada
            const imageInput = document.getElementById('linkImageInput');
            const imageFile = imageInput.files[0];
            
            // Formatear mensaje con link clickeable
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            let message = customMessage;
            if (!message) {
                message = `Hola! 👋\n\nTe envío el link para que puedas solicitar tu cotización personalizada:\n\n${cotizadorLink}\n\n✅ Completa el formulario y te enviaremos tu cotización personalizada.\n\n¡Gracias por confiar en nosotros! 🙏`;
            }
            
            // Asegurar que el link esté en una línea separada y bien formateado
            // Reemplazar cualquier variación del link para asegurar formato consistente
            message = message.replace(/file:\/\/\/C:\/Users\/German\/Downloads\/Checkin24hs\/cotizador-cliente\.html/gi, cotizadorLink);
            
            // Nota: Los links file:// no son clickeables en WhatsApp Web, 
            // pero funcionan en algunas aplicaciones de escritorio de WhatsApp
            
            // Intentar enviar por WhatsApp Business API
            try {
                if (imageFile) {
                    // Si hay imagen, enviar primero la imagen con el mensaje como caption
                    await sendWhatsAppImage(cleanPhone, imageFile, message);
                } else {
                    // Si no hay imagen, enviar solo el mensaje
                    await sendWhatsAppMessage(cleanPhone, message);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
                
                alert(`✅ Link del cotizador enviado exitosamente a ${phoneNumber} por WhatsApp!`);
                
            } catch (error) {
                console.error('❌ Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar método alternativo (wa.me)
                // Nota: wa.me no soporta envío de imágenes directamente
                // Abrir WhatsApp con el mensaje y notificar al usuario sobre la imagen
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Si hay imagen, mostrar instrucciones más detalladas
                if (imageFile) {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE' 
                        ? '⚠️ No hay configuración de WhatsApp Business API configurada y el servidor no está disponible.\n\nSe abrió WhatsApp Web/App con el mensaje prellenado.\n\n📸 IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.\n\n💡 Para enviar imágenes automáticamente, configura las credenciales de WhatsApp Business API en la configuración del sistema.'
                        : '⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado.\n\n📸 IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.';
                    alert(errorMessage);
                } else {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE'
                        ? '⚠️ No hay configuración de WhatsApp Business API configurada y el servidor no está disponible.\n\nSe abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.\n\n💡 Para enviar mensajes automáticamente, configura las credenciales de WhatsApp Business API en la configuración del sistema.'
                        : '⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.';
                    alert(errorMessage);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
            }
        }
        
        // Función para mostrar el modal de nueva cotización
        function showNewQuoteModal() {
            console.log('📋 Abriendo modal de nueva cotización...');
            
            const modal = document.getElementById('newQuoteModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('quoteForm').reset();
            document.getElementById('quoteAdults').value = 1;
            document.getElementById('quoteChildren').value = 0;
            document.getElementById('quoteInfants').value = 0;
            document.getElementById('quoteTariff').value = '';
            document.getElementById('quoteDiscount').value = 0;
            document.getElementById('quoteFinalTariff').value = '0.00';
            document.getElementById('childrenAgesContainer').style.display = 'none';
            document.getElementById('nightsDisplay').style.display = 'none';
            
            // Cargar hoteles
            loadHotelsForQuote();
            
            // Establecer fecha mínima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteCheckIn').setAttribute('min', today);
            document.getElementById('quoteCheckOut').setAttribute('min', today);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar el modal de nueva cotización
        function closeNewQuoteModal() {
            const modal = document.getElementById('newQuoteModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funciones de WhatsApp - ELIMINADAS
        
        // Función para cargar hoteles en el selector
        function loadHotelsForQuote() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const select = document.getElementById('quoteHotel');
            
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar hotel</option>';
            
            if (hotels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay hoteles disponibles';
                select.appendChild(option);
                return;
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.name;
                option.textContent = hotel.name || 'Hotel sin nombre';
                select.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el cotizador`);
        }
        
        // Función para cargar contactos con teléfono en el selector
        function loadContactsForQuote() {
            // Cargar usuarios desde diferentes fuentes
            const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Combinar todos los usuarios
            const allContacts = [];
            
            // Agregar usuarios del dashboard
            dashboardUsers.forEach(user => {
                if (user.phone) {
                    allContacts.push({
                        name: user.name || 'Sin nombre',
                        phone: user.phone,
                        email: user.email || '',
                        source: 'Dashboard'
                    });
                }
            });
            
            // Agregar usuarios móviles
            mobileUsers.forEach(user => {
                if (user.phone) {
                    const exists = allContacts.find(c => c.phone === user.phone);
                    if (!exists) {
                        allContacts.push({
                            name: user.name || 'Sin nombre',
                            phone: user.phone,
                            email: user.email || '',
                            source: 'Móvil'
                        });
                    }
                }
            });
            
            // Agregar contactos de reservas
            reservations.forEach(reservation => {
                if (reservation.guestPhone) {
                    const exists = allContacts.find(c => c.phone === reservation.guestPhone);
                    if (!exists) {
                        allContacts.push({
                            name: reservation.guestName || 'Sin nombre',
                            phone: reservation.guestPhone,
                            email: reservation.guestEmail || '',
                            source: 'Reserva'
                        });
                    }
                }
            });
            
            const select = document.getElementById('quoteContact');
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar contacto</option>';
            
            if (allContacts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay contactos con teléfono disponibles';
                select.appendChild(option);
                return;
            }
            
            // Ordenar por nombre
            allContacts.sort((a, b) => a.name.localeCompare(b.name));
            
            allContacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.phone;
                option.textContent = `${contact.name} - ${contact.phone} (${contact.source})`;
                option.setAttribute('data-name', contact.name);
                select.appendChild(option);
            });
            
            console.log(`✅ ${allContacts.length} contactos cargados en el cotizador`);
        }
        
        // Función para calcular noches
        function calculateNights() {
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const display = document.getElementById('nightsDisplay');
            const count = document.getElementById('nightsCount');
            
            if (!checkIn || !checkOut) {
                display.style.display = 'none';
                return;
            }
            
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            if (checkOutDate <= checkInDate) {
                display.style.display = 'none';
                alert('⚠️ La fecha de check-out debe ser posterior al check-in');
                return;
            }
            
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            count.textContent = diffDays;
            display.style.display = 'block';
        }
        
        // Función para calcular tarifa final
        function calculateFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            document.getElementById('quoteFinalTariff').value = finalTariff.toFixed(2);
        }
        
        // Función para mostrar/ocultar campos de edades de niños
        function toggleChildrenAges() {
            const childrenCount = parseInt(document.getElementById('quoteChildren').value) || 0;
            const container = document.getElementById('childrenAgesContainer');
            const inputsContainer = document.getElementById('childrenAgesInputs');
            
            if (childrenCount > 0) {
                container.style.display = 'block';
                inputsContainer.innerHTML = '';
                
                for (let i = 0; i < childrenCount; i++) {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">
                            Edad del niño ${i + 1}:
                        </label>
                        <input type="number" class="form-input" min="0" max="17" 
                               id="childAge${i}" placeholder="Edad" required 
                               style="width: 100%;">
                    `;
                    inputsContainer.appendChild(div);
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Función para crear y enviar cotización por WhatsApp
        function createAndSendQuote(event) {
            event.preventDefault();
            console.log('📋 Creando y enviando cotización...');
            
            // Obtener valores del formulario
            const hotelId = document.getElementById('quoteHotel').value;
            const hotelName = document.getElementById('quoteHotel').selectedOptions[0].text;
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const adults = parseInt(document.getElementById('quoteAdults').value) || 1;
            const children = parseInt(document.getElementById('quoteChildren').value) || 0;
            const infants = parseInt(document.getElementById('quoteInfants').value) || 0;
            const module = document.getElementById('quoteModule').value;
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariff').value) || 0;
            const notes = document.getElementById('quoteNotes').value;
            
            // Validaciones
            if (!hotelId || !checkIn || !checkOut || !module || tariff <= 0) {
                alert('❌ Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Obtener edades de niños
            const childrenAges = [];
            if (children > 0) {
                for (let i = 0; i < children; i++) {
                    const age = parseInt(document.getElementById(`childAge${i}`).value);
                    if (age) childrenAges.push(age);
                }
            }
            
            // Calcular noches
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Formatear fechas para mostrar
            const checkInFormatted = new Date(checkIn).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const checkOutFormatted = new Date(checkOut).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Formatear descripción de huéspedes
            let travelersDesc = `${adults} adulto${adults > 1 ? 's' : ''}`;
            if (children > 0) travelersDesc += `, ${children} niño${children > 1 ? 's' : ''}`;
            if (infants > 0) travelersDesc += `, ${infants} infante${infants > 1 ? 's' : ''}`;
            
            // Crear objeto de cotización
            const quote = {
                id: 'COT-' + Date.now(),
                hotel: hotelName,
                hotelId: hotelId,
                checkIn: checkIn,
                checkOut: checkOut,
                dateRange: `${checkInFormatted} - ${checkOutFormatted}`,
                nights: nights,
                adults: adults,
                children: children,
                infants: infants,
                childrenAges: childrenAges,
                travelers: travelersDesc,
                module: module,
                tariff: tariff,
                discount: discount,
                finalTariff: finalTariff,
                notes: notes,
                status: 'pending',
                timestamp: new Date().toISOString(),
                source: 'dashboard'
            };
            
            // Guardar cotización en localStorage
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            quotes.push(quote);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('✅ Cotización guardada:', quote);
            
            // Obtener número de teléfono
            const phoneNumber = document.getElementById('quotePhoneNumber').value.trim();
            
            if (!phoneNumber) {
                alert('❌ Por favor ingresa el número de WhatsApp del destinatario');
                return;
            }
            
            // Limpiar número de teléfono (solo números, con código de país)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('❌ El número de teléfono no es válido. Debe incluir el código de país.');
                return;
            }
            
            // Formatear mensaje para WhatsApp
            const whatsappMessage = formatWhatsAppMessage(quote);
            
            // Actualizar cotización con número de teléfono
            quote.clientPhone = cleanPhone;
            const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
            if (quoteIndex !== -1) {
                quotesUpdated[quoteIndex] = quote;
                localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
            }
            
            // Intentar enviar por WhatsApp Business API
            sendWhatsAppMessage(cleanPhone, whatsappMessage).then(() => {
                // Cambiar estado a "enviado"
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotización en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estadísticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert(`✅ Cotización creada y enviada exitosamente a ${phoneNumber} por WhatsApp!`);
            }).catch(error => {
                console.error('❌ Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar método alternativo (wa.me)
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrl, '_blank');
                
                // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotización en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estadísticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert('⚠️ No se pudo enviar automáticamente por la API. Se abrió WhatsApp Web/App con el mensaje prellenado. Por favor, envía el mensaje manualmente.');
            });
        }
        
        // Funciones de WhatsApp - ELIMINADAS (solo conexión, envío mantenido para cotizaciones)
        // async function sendWhatsAppMessage(phoneNumber, message) { // DESHABILITADA
        async function sendWhatsAppMessage_DISABLED(phoneNumber, message) {
            console.log('📱 Enviando mensaje por WhatsApp API a:', phoneNumber);
            
            // Obtener configuración de WhatsApp (puede estar en localStorage o variables globales)
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuración, intentar usar endpoint del servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
            
            // Enviar usando WhatsApp Business API directamente
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'text',
                        text: {
                            body: message
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error al enviar mensaje');
                }
                
                const result = await response.json();
                console.log('✅ Mensaje enviado exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en API directa, intentando servidor:', error);
                // Si falla, intentar con el servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
        }
        
        // Función para enviar vía endpoint del servidor
        async function sendViaServerAPI(phoneNumber, message) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuración de WhatsApp ni servidor disponible');
            }
            
            try {
                const response = await fetch(`${serverUrl}/api/whatsapp/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('✅ Mensaje enviado vía servidor:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en servidor:', error);
                throw new Error('No se pudo enviar el mensaje. Verifica la configuración de WhatsApp.');
            }
        }
        
        // async function sendWhatsAppImage(phoneNumber, imageFile, caption = '') { // DESHABILITADA
        async function sendWhatsAppImage_DISABLED(phoneNumber, imageFile, caption = '') {
            console.log('📱 Enviando imagen por WhatsApp API a:', phoneNumber);
            
            // Obtener configuración de WhatsApp
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuración, verificar si hay servidor disponible
                const serverUrl = getServerURL();
                if (serverUrl) {
                    console.log('⚠️ No hay configuración de WhatsApp, intentando servidor...');
                    try {
                        return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                    } catch (serverError) {
                        console.error('❌ Servidor no disponible:', serverError);
                        // Lanzar error específico para que se maneje en el catch principal
                        throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                    }
                } else {
                    // No hay configuración ni servidor
                    console.error('❌ No hay configuración de WhatsApp ni servidor disponible');
                    throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                }
            }
            
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                
                // Paso 1: Subir la imagen primero para obtener el media ID
                console.log('📤 Subiendo imagen a WhatsApp...');
                const mediaId = await uploadWhatsAppMedia(imageFile, whatsappConfig);
                console.log('✅ Imagen subida, media ID:', mediaId);
                
                // Paso 2: Enviar mensaje con imagen usando el media ID
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                console.log('📨 Enviando mensaje con imagen...');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'image',
                        image: {
                            id: mediaId
                        },
                        caption: caption.substring(0, 1024) // WhatsApp limita el caption a 1024 caracteres
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('❌ Error en respuesta:', errorData);
                    throw new Error(errorData.error?.message || `Error al enviar imagen: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Imagen enviada exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en API directa:', error);
                // Si falla, intentar con el servidor
                try {
                    return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                } catch (serverError) {
                    console.error('❌ Error también en servidor:', serverError);
                    throw error; // Lanzar el error original para que se maneje en el catch principal
                }
            }
        }
        
        // async function uploadWhatsAppMedia(file, config) { // DESHABILITADA
        async function uploadWhatsAppMedia_DISABLED(file, config) {
            const apiVersion = config.apiVersion || 'v18.0';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('messaging_product', 'whatsapp');
            formData.append('type', 'image');
            
            console.log('📤 Subiendo archivo:', file.name, 'Tamaño:', file.size);
            
            const response = await fetch(`https://graph.facebook.com/${apiVersion}/${config.phoneNumberId}/media`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.accessToken}`
                    // No establecer Content-Type para FormData, el navegador lo hace automáticamente
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('❌ Error al subir imagen:', errorData);
                throw new Error(errorData.error?.message || `Error al subir imagen: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('✅ Media subido exitosamente:', result);
            return result.id;
        }
        
        // Función auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Función para enviar imagen vía endpoint del servidor
        async function sendImageViaServerAPI(phoneNumber, imageFile, caption) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuración de WhatsApp ni servidor disponible');
            }
            
            try {
                const formData = new FormData();
                formData.append('phoneNumber', phoneNumber);
                formData.append('image', imageFile);
                formData.append('caption', caption);
                
                const response = await fetch(`${serverUrl}/api/whatsapp/send-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('✅ Imagen enviada vía servidor:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Error en servidor:', error);
                throw new Error('No se pudo enviar la imagen. Verifica la configuración de WhatsApp.');
            }
        }
        
        // Función para obtener configuración de WhatsApp
        // function getWhatsAppConfig() { // DESHABILITADA
        function getWhatsAppConfig_DISABLED() {
            // Intentar obtener desde localStorage
            const stored = localStorage.getItem('whatsappConfig');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error parseando configuración:', e);
                }
            }
            
            // Valores por defecto (deben configurarse)
            return {
                accessToken: '',
                phoneNumberId: '',
                apiVersion: 'v18.0'
            };
        }
        
        // Función para obtener URL del servidor
        function getServerURL() {
            // Intentar obtener desde localStorage
            const serverUrl = localStorage.getItem('whatsappServerURL');
            if (serverUrl && serverUrl.trim() !== '') {
                return serverUrl.trim();
            }
            
            // No devolver valor por defecto - el servidor debe estar explícitamente configurado
            return null;
        }
        
        // Función para formatear mensaje de WhatsApp
        function formatWhatsAppMessage(quote) {
            let message = `*📋 COTIZACIÓN DE RESERVA*\n\n`;
            message += `Hola! 👋\n\n`;
            message += `Te envío la cotización que solicitaste:\n\n`;
            message += `🏨 *Hotel:* ${quote.hotel}\n`;
            message += `📦 *Módulo:* ${quote.module}\n`;
            message += `📅 *Check-in:* ${quote.checkIn}\n`;
            message += `📅 *Check-out:* ${quote.checkOut}\n`;
            message += `🌙 *Noches:* ${quote.nights}\n`;
            message += `👥 *Huéspedes:* ${quote.travelers}\n`;
            
            if (quote.children > 0 && quote.childrenAges && quote.childrenAges.length > 0) {
                message += `👶 *Edades de niños:* ${quote.childrenAges.join(', ')} años\n`;
            }
            
            message += `\n💰 *DETALLES DE PRECIO:*\n`;
            message += `💵 *Tarifa:* $${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.discount > 0) {
                message += `🎁 *Descuento:* $${quote.discount.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            }
            
            message += `💳 *Tarifa Final:* $${quote.finalTariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.notes) {
                message += `\n📝 *Notas:* ${quote.notes}\n`;
            }
            
            message += `\n📅 *Fecha de cotización:* ${new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}\n\n`;
            message += `¿Te gustaría realizar esta reserva? Estoy disponible para ayudarte. 😊\n\n`;
            message += `¡Gracias por confiar en nosotros! 🙏`;
            
            return message;
        }
        
        // Funciones auxiliares para promociones de hoteles
        function showPromotionTab(tabName) {
            console.log('🏨 Cambiando a pestaña de promoción:', tabName);
            
            // Buscar el contenedor de promociones (puede estar en modal o en la sección)
            const promotionContent = document.getElementById('promotion-content');
            if (!promotionContent) return;
            
            // Ocultar todas las pestañas dentro del contenedor
            const tabContents = promotionContent.querySelectorAll('.promotion-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostrar la pestaña seleccionada
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Actualizar estilos de los botones de pestaña
            const tabButtons = promotionContent.parentElement.querySelectorAll('.promotion-tab');
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.style.background = '#ff9800';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#333';
                }
            });
        }
        
        function editHotelPromotion(hotelId) {
            console.log('✏️ Editando promoción del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            // Cargar promociones existentes del hotel
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            
            showEditPromotionModal(hotel, hotelPromotions);
        }
        
        function viewHotelPromotion(hotelId) {
            console.log('👁️ Viendo promoción del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            showViewPromotionModal(hotel, hotelPromotions);
        }
        
        function deactivateHotelPromotion(hotelId) {
            console.log('⏸️ Pausando promoción del hotel:', hotelId);
            
            if (confirm('¿Estás seguro de que quieres pausar esta promoción?')) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const hotelIndex = hotels.findIndex(h => h.id === hotelId);
                
                if (hotelIndex !== -1) {
                    hotels[hotelIndex].promotionStatus = 'paused';
                    localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                    
                    // Actualizar la interfaz - recargar contenido de promociones si está visible
                    const promotionsContent = document.getElementById('promotions-tab-content');
                    if (promotionsContent && promotionsContent.style.display !== 'none') {
                        loadHotelPromotionsContent();
                    } else {
                    showHotelPromotions();
                    }
                    alert('Promoción pausada correctamente');
                }
            }
        }
        
        function createHotelPromotion() {
            console.log('➕ Creando nueva promoción de hotel...');
            
            const hotelId = document.getElementById('promotionHotel').value;
            const promotionType = document.getElementById('promotionType').value;
            const discount = document.getElementById('promotionDiscount').value;
            const price = document.getElementById('promotionPrice').value;
            const description = document.getElementById('promotionDescription').value;
            const startDate = document.getElementById('promotionStartDate').value;
            const endDate = document.getElementById('promotionEndDate').value;
            
            if (!hotelId || !promotionType || !description || !startDate || !endDate) {
                alert('❌ Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Aquí se guardaría la promoción en localStorage
            const promotion = {
                id: `PROM-${Date.now()}`,
                hotelId: hotelId,
                type: promotionType,
                discount: discount,
                price: price,
                description: description,
                startDate: startDate,
                endDate: endDate,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Guardar en localStorage (implementación futura)
            console.log('✅ Promoción creada:', promotion);
            alert('✅ Promoción creada correctamente');
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Función para mostrar modal de edición de promociones
        function showEditPromotionModal(hotel, existingPromotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">✏️ Editar Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Promociones existentes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">Promociones Existentes</h3>
                        <div id="existing-promotions" style="display: grid; gap: 12px;">
                            ${existingPromotions.map((promo, index) => `
                                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; color: #333;">${promo.name}</h4>
                                        <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                    </div>
                                    <p style="margin: 0 0 8px 0; color: #666;">${promo.description}</p>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editSpecificPromotion('${hotel.id}', ${index})" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Editar</button>
                                        <button onclick="deletePromotion('${hotel.id}', ${index})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Eliminar</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Formulario para nueva promoción -->
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">➕ Agregar Nueva Promoción</h3>
                        
                        <form id="newPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre de la Promoción</label>
                                    <input type="text" id="promoName" placeholder="Ej: Descuento de Verano" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                    <select id="promoType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                        <option value="seasonal">Temporada</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción</label>
                                <textarea id="promoDescription" placeholder="Describe la promoción..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promoDiscount" min="0" max="100" placeholder="20" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promoStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promoEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Guardar Promoción</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para el formulario
            document.getElementById('newPromotionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewPromotion(hotel.id);
            });
        }
        
        // Función para guardar nueva promoción
        function saveNewPromotion(hotelId) {
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promoName').value,
                type: document.getElementById('promoType').value,
                description: document.getElementById('promoDescription').value,
                discount: document.getElementById('promoDiscount').value,
                startDate: document.getElementById('promoStartDate').value,
                endDate: document.getElementById('promoEndDate').value,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.name || !promoData.description) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Guardar promoción
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoción guardada correctamente');
            
            // Cerrar modal si existe
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            
            // Actualizar la interfaz - recargar contenido de promociones si está visible
            const promotionsContent = document.getElementById('promotions-tab-content');
            if (promotionsContent && promotionsContent.style.display !== 'none') {
                loadHotelPromotionsContent();
            } else {
                showHotelPromotions();
            }
        }
        
        // Función para guardar promoción desde el formulario en la sección
        function savePromotion() {
            const hotelId = document.getElementById('promotionHotel').value;
            if (!hotelId) {
                alert('Por favor selecciona un hotel');
                return;
            }
            
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promotionType').value,
                type: document.getElementById('promotionType').value,
                description: document.getElementById('promotionDescription').value,
                discount: document.getElementById('promotionDiscount').value,
                startDate: document.getElementById('promotionStartDate').value,
                endDate: document.getElementById('promotionEndDate').value,
                status: document.getElementById('promotionStatus').value,
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.description) {
                alert('Por favor completa la descripción');
                return;
            }
            
            // Guardar promoción
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoción guardada correctamente');
            
            // Recargar contenido de promociones
            loadHotelPromotionsContent();
            
            // Cambiar a pestaña de promociones activas
            showPromotionTab('active');
        }
        
        // Función para mostrar modal de vista de promociones
        function showViewPromotionModal(hotel, promotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">👁️ Ver Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        ${promotions.length > 0 ? promotions.map(promo => `
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <h3 style="margin: 0; color: #333;">${promo.name}</h3>
                                    <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                </div>
                                <p style="margin: 0 0 12px 0; color: #666;">${promo.description}</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <strong>Tipo:</strong> ${promo.type}
                                    </div>
                                    <div>
                                        <strong>Descuento:</strong> ${promo.discount}%
                                    </div>
                                    <div>
                                        <strong>Inicio:</strong> ${promo.startDate}
                                    </div>
                                    <div>
                                        <strong>Fin:</strong> ${promo.endDate}
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <strong>Creado:</strong> ${new Date(promo.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('') : `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <p>No hay promociones activas para este hotel</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Función para editar promoción específica
        function editSpecificPromotion(hotelId, promoIndex) {
            console.log('✏️ Editando promoción específica:', hotelId, promoIndex);
            // Implementar edición de promoción específica
            alert('Función de edición específica en desarrollo');
        }
        
        // Función para eliminar promoción
        function deletePromotion(hotelId, promoIndex) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar esta promoción?')) {
                const promotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
                promotions.splice(promoIndex, 1);
                localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(promotions));
                
                alert('Promoción eliminada correctamente');
                
                // Actualizar la interfaz - recargar contenido de promociones si está visible
                const promotionsContent = document.getElementById('promotions-tab-content');
                if (promotionsContent && promotionsContent.style.display !== 'none') {
                    loadHotelPromotionsContent();
                } else {
                showHotelPromotions();
                }
            }
        }
        
        // Función para probar la sincronización de cotizaciones
        function testQuotesSync() {
            console.log('🧪 Probando sincronización de cotizaciones...');
            
            // Crear una cotización de prueba
            const testQuote = {
                id: `TEST-${Date.now()}`,
                hotel: 'Hotel de Prueba',
                clientName: 'Usuario de Prueba',
                dateRange: '15/12/2025 - 18/12/2025',
                travelers: '2 adultos • 1 niño',
                status: 'pending',
                timestamp: new Date().toLocaleString('es-ES'),
                checkIn: '2025-12-15',
                checkOut: '2025-12-18',
                adults: 2,
                children: 1,
                childrenAges: [8]
            };
            
            // Agregar a localStorage
            const existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            existingQuotes.push(testQuote);
            localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
            
            // Disparar evento
            window.dispatchEvent(new CustomEvent('quotesDBChanged'));
            
            console.log('✅ Cotización de prueba agregada');
            alert('✅ Cotización de prueba agregada. Verifica que aparezca en la tabla.');
        }
        
        // Función para sincronizar cotizaciones desde index.html
        function syncQuotesFromIndex() {
            console.log('🔄 Sincronizando cotizaciones desde index.html...');
            
            // Escuchar cambios en localStorage de cotizaciones (desde otras pestañas)
            window.addEventListener('storage', function(e) {
                if (e.key === 'quotesDB') {
                    console.log('📋 Cambio detectado en quotesDB desde otra pestaña, actualizando...');
                    loadQuotesTable();
                    updateQuotesStats();
                }
            });
            
            // Escuchar eventos personalizados (desde la misma pestaña)
            window.addEventListener('quotesDBChanged', function() {
                console.log('📋 Evento local detectado, actualizando...');
                loadQuotesTable();
                updateQuotesStats();
            });
            
            // También verificar cambios periódicamente (como respaldo)
            setInterval(function() {
                const currentQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                if (window.lastQuotesCount === undefined) {
                    window.lastQuotesCount = currentQuotes.length;
                } else if (window.lastQuotesCount !== currentQuotes.length) {
                    console.log('📋 Cambio detectado en quotesDB (verificación periódica), actualizando...');
                    window.lastQuotesCount = currentQuotes.length;
                    loadQuotesTable();
                    updateQuotesStats();
                }
            }, 2000); // Verificar cada 2 segundos
        }

        // Función para inicializar base de datos de hoteles
        async function initHotelsDB() {
            console.log('🏨 Inicializando base de datos de hoteles...');
            
            // Intentar cargar desde Supabase primero
            let existingHotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('Cargando hoteles desde Supabase...');
                    existingHotels = await window.supabaseClient.getHotels();
                    console.log(`📊 Estado inicial: ${existingHotels.length} hoteles en Supabase`);
                    console.log('✅ Hoteles cargados desde Supabase - NO guardando en localStorage (versión corregida v2)');
                    
                    // NO sincronizar con localStorage si los datos vienen de Supabase
                    // localStorage tiene límites de quota y Supabase es la fuente de verdad
                    // Solo usar localStorage como fallback si Supabase no está disponible
                } catch (error) {
                    console.warn('Error cargando desde Supabase, usando localStorage:', error);
                    // NO intentar guardar en localStorage si hay error de quota
                    if (error && error.name === 'QuotaExceededError') {
                        console.error('❌ localStorage está lleno. Usando solo Supabase.');
                        existingHotels = [];
                    } else {
                        try {
                            existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        } catch (localError) {
                            console.warn('⚠️ Error leyendo localStorage:', localError);
                            existingHotels = [];
                        }
                    }
                }
            } else {
                // Solo usar localStorage si Supabase no está disponible
                try {
                    existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                } catch (localError) {
                    console.warn('⚠️ Error leyendo localStorage:', localError);
                    existingHotels = [];
                }
            }
            
            console.log(`📊 Estado inicial: ${existingHotels.length} hoteles`);
            
            if (existingHotels.length > 0) {
                console.log('📋 Hoteles existentes:', existingHotels.map(h => h.name));
            }
            
            // DESACTIVADO: Ya no agregar hoteles por defecto automáticamente
            // El usuario debe agregar sus propios hoteles manualmente
            if (false && existingHotels.length < 6) {
                console.log(`🆕 Solo hay ${existingHotels.length} hoteles, agregando hoteles por defecto...`);
                
                // Limpiar localStorage para asegurar una carga limpia
                localStorage.removeItem('hotelsDB');
                
                // Hoteles por defecto basados en index.html
                const defaultHotels = [
                    {
                        id: 'hotel-termas-chillan',
                        name: 'Hotel Termas Chillán',
                        location: 'Chillán, Ñuble, Chile',
                        description: 'Termas y Spa en la cordillera de Chillán',
                        rating: 4.3,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Termas', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Carriel Sur',
                            code: 'CCP',
                            distance: '85 km',
                            city: 'Concepción'
                        },
                        borderCrossing: {
                            name: 'Paso Pehuenche',
                            distance: '120 km',
                            route: 'Ruta CH-115'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -36.6064, lng: -71.2167 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Termas+Chillán,+Chillán,+Ñuble,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-puyehue',
                        name: 'Hotel Terma de Puyehue',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Termas y Spa de lujo en la Patagonia',
                        rating: 4.5,
                        price: '$200',
                        status: 'Activo',
                        amenities: ['Piscina', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '45 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '45 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.683222, lng: -72.274986 },
                        googleMaps: 'https://maps.google.com/?q=Termas+de+Puyehue,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-huilo-huilo',
                        name: 'Hotel Huilo-Huilo',
                        location: 'Panguipulli, Los Ríos, Chile',
                        description: 'Inmersión en el bosque nativo',
                        rating: 4.2,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Naturaleza', 'Trekking', 'Aves', 'Restaurante', 'WiFi'],
                        badge: 'Bosque',
                        airport: {
                            name: 'Aeropuerto Pucón',
                            code: 'ZPC',
                            distance: '45 km',
                            city: 'Pucón'
                        },
                        borderCrossing: {
                            name: 'Paso Mamuil Malal',
                            distance: '85 km',
                            route: 'Ruta CH-199'
                        },
                        image: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -39.8500, lng: -72.0000 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Huilo-Huilo,+Panguipulli,+Los+Ríos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-corralco',
                        name: 'Hotel Corralco Resort',
                        location: 'Lonquimay, La Araucanía, Chile',
                        description: 'Esquí y aventura en la montaña',
                        rating: 4.7,
                        price: '$240',
                        status: 'Activo',
                        amenities: ['Esquí', 'Montaña', 'Chimenea', 'Restaurante', 'WiFi'],
                        badge: 'Esquí',
                        airport: {
                            name: 'Aeropuerto La Araucanía',
                            code: 'ZCO',
                            distance: '65 km',
                            city: 'Temuco'
                        },
                        borderCrossing: {
                            name: 'Paso Icalma',
                            distance: '95 km',
                            route: 'Ruta CH-181'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -38.6500, lng: -71.6500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Corralco+Resort,+Lonquimay,+La+Araucanía,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-futangue',
                        name: 'Hotel Futangue',
                        location: 'Lago Ranco, Los Ríos, Chile',
                        description: 'Lujo y naturaleza en su máxima expresión',
                        rating: 5.0,
                        price: '$330',
                        status: 'Activo',
                        amenities: ['5 Estrellas', 'Vinos', 'Piscina', 'Spa', 'Restaurante'],
                        badge: 'Lujo',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '75 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '110 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.3500, lng: -72.4500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Futangue,+Lago+Ranco,+Los+Ríos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'cabanas-aguas-calientes',
                        name: 'Cabañas Termas de Aguas Calientes',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Aguas Calientes - Experiencia única',
                        rating: 4.0,
                        price: '$110',
                        status: 'Activo',
                        amenities: ['Cabañas', 'Termas', 'Naturaleza', 'WiFi', 'Estacionamiento'],
                        badge: 'Cabañas',
                        airport: {
                            name: 'Aeropuerto Cañal Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '25 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samoré',
                            distance: '35 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.735366, lng: -72.307616 },
                        googleMaps: 'https://maps.google.com/?q=Termas+Aguas+Calientes,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // Guardar hoteles por defecto en localStorage
                localStorage.setItem('hotelsDB', JSON.stringify(defaultHotels));
                
                console.log(`✅ ${defaultHotels.length} hoteles por defecto agregados a la base de datos`);
                console.log('📋 Hoteles agregados:', defaultHotels.map(h => h.name));
                
                // Verificar que se guardaron correctamente
                const savedHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                console.log(`🔍 Verificación: ${savedHotels.length} hoteles guardados en localStorage`);
                console.log('🔍 Hoteles guardados:', savedHotels.map(h => h.name));
                
                // Notificar a index.html sobre el cambio
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'hotelsDB',
                    newValue: JSON.stringify(defaultHotels),
                    oldValue: '[]'
                }));
                
            } else {
                console.log(`ℹ️ Ya existen ${existingHotels.length} hoteles en la base de datos`);
            }
            
            // Mostrar estado final
            showHotelsStatus();
        }

        // Función para mostrar estado actual de hoteles
        function showHotelsStatus() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            console.log('🏨 ESTADO ACTUAL DE HOTELES EN DASHBOARD:');
            console.log(`📊 Total de hoteles: ${hotels.length}`);
            console.log('📋 Lista de hoteles:');
            hotels.forEach((hotel, index) => {
                console.log(`   ${index + 1}. ${hotel.name} (${hotel.location})`);
            });
            
            if (hotels.length === 0) {
                console.log('⚠️ No hay hoteles en localStorage');
            } else if (hotels.length < 6) {
                console.log(`⚠️ Solo hay ${hotels.length} hoteles, deberían ser 6`);
            } else {
                console.log('✅ Todos los hoteles están cargados correctamente');
            }
        }
        
        // Función para guardar base de datos de hoteles
        function saveHotelsDB() {
            // Implementar guardado
            console.log('Guardando base de datos de hoteles...');
        }

        // Función para limpiar completamente el formulario de hotel
        function clearHotelForm() {
            console.log('🧹 Limpiando formulario de hotel...');
            
            // Resetear formulario
            const form = document.getElementById('editHotelForm');
            if (form) form.reset();
            
            // Limpiar TODOS los campos de texto
            const fieldsToClean = [
                'editHotelName', 'editHotelLocation', 'editHotelGoogleMaps', 
                'editHotelWebsite', 'editHotelPrice', 'editHotelDescription', 
                'editHotelAmenities'
            ];
            fieldsToClean.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Resetear selects
            const ratingSelect = document.getElementById('editHotelRating');
            const statusSelect = document.getElementById('editHotelStatus');
            if (ratingSelect) ratingSelect.value = '0';
            if (statusSelect) statusSelect.value = 'Activo';
            
            // Limpiar campos de Flor IA
            const florFields = [
                'editHotelFlorDescription', 'editHotelFlorServices', 'editHotelFlorExcursions',
                'editHotelFlorPrices', 'editHotelFlorPolicies', 'editHotelFlorTransport', 'editHotelFlorContact'
            ];
            florFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Limpiar campos de conocimiento adicional
            const knowledgeFields = [
                'editHotelKnowledgeDescription', 'editHotelKnowledgeServicesDetail',
                'editHotelKnowledgePricing', 'editHotelKnowledgeTransport',
                'editHotelKnowledgeNotes', 'editHotelKnowledgeWebsiteInfo'
            ];
            knowledgeFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Colapsar sección de conocimiento adicional
            const knowledgeSection = document.getElementById('knowledgeAdditionalSection');
            const knowledgeIcon = document.getElementById('knowledgeToggleIcon');
            if (knowledgeSection) {
                knowledgeSection.style.display = 'none';
            }
            if (knowledgeIcon) {
                knowledgeIcon.style.transform = 'rotate(0deg)';
            }
            
            // LIMPIAR IMAGEN PRINCIPAL - Preview y input
            const mainImageInput = document.getElementById('editHotelImage');
            if (mainImageInput) mainImageInput.value = '';
            
            const mainImagePreview = document.getElementById('editImagePreview');
            if (mainImagePreview) {
                mainImagePreview.innerHTML = '';
            }
            
            // Limpiar el input de archivo
            const mainImageFileInput = document.getElementById('mainImageFileInput');
            if (mainImageFileInput) mainImageFileInput.value = '';
            
            // LIMPIAR GALERÍA DE FOTOS - Preview y input
            const galleryInput = document.getElementById('editHotelPhotos');
            if (galleryInput) galleryInput.value = '';
            
            const galleryPreview = document.getElementById('editPhotosPreview');
            if (galleryPreview) {
                galleryPreview.innerHTML = '';
            }
            
            // Limpiar el input de archivo de galería
            const galleryFileInput = document.getElementById('galleryImagesFileInput');
            if (galleryFileInput) galleryFileInput.value = '';
            
            // Limpiar elementos dinámicos de coordenadas (los mensajes verdes/naranjas)
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            if (googleMapsInput && googleMapsInput.parentNode) {
                const dynamicElements = googleMapsInput.parentNode.querySelectorAll('div[style*="color: #28a745"], div[style*="color: #ff9800"]');
                dynamicElements.forEach(el => el.remove());
            }
            
            console.log('✅ Formulario limpiado completamente');
        }

        // Función para agregar nuevo hotel
        function addNewHotel() {
            console.log('🆕 Abriendo formulario para agregar nuevo hotel...');
            
            const modal = document.getElementById('editHotelModal');
            if (!modal) {
                console.error('❌ Modal no encontrado');
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // LIMPIAR TODO EL FORMULARIO
            clearHotelForm();
            
            // Cambiar el título del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = '🏨 Agregar Nuevo Hotel';
            }
            
            // Mostrar el modal
            modal.style.display = 'block';
            
            // Configurar el formulario para modo "agregar"
            const form = document.getElementById('editHotelForm');
            if (form) {
                form.dataset.mode = 'add';
                form.dataset.hotelId = '';
            }
            
            console.log('✅ Formulario listo para agregar nuevo hotel');
        }

        // Nota: Las funciones editHotel, deleteHotel y viewHotel están definidas arriba con soporte para Supabase

        // Función para obtener hotel por ID
        function getHotelById(hotelId) {
            // Implementar obtención
            console.log('Obteniendo hotel:', hotelId);
            return null;
        }

        // Función para cargar tabla de hoteles (versión actualizada con Supabase)
        async function loadHotelsTable() {
            console.log('📋 Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('❌ Tabla de hoteles no encontrada');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            tbody.innerHTML = '';
            
            if (hotels.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-icons" style="font-size: 48px; color: #ddd;"></i>
                                <p>No hay hoteles registrados</p>
                                <button onclick="addNewHotel()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
                                    Agregar Primer Hotel
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price ? `$${hotel.price.toLocaleString()}` : 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status.toLowerCase().replace(' ', '-')}">${hotel.status}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <span class="material-icons">delete</span>
                        </button>
                        <button onclick="viewHotel('${hotel.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla actualizada con ${hotels.length} hoteles`);
        }

        // Función para actualizar estadísticas de hoteles
        function updateHotelsStats() {
            console.log('📊 Actualizando estadísticas de hoteles...');
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Actualizar contadores
            const totalHotelsElement = document.getElementById('totalHotels');
            const avgRatingElement = document.getElementById('avgRating');
            const totalLocationsElement = document.getElementById('totalLocations');
            const priceRangeElement = document.getElementById('priceRange');
            
            if (totalHotelsElement) {
                totalHotelsElement.textContent = hotels.length;
            }
            
            if (avgRatingElement) {
                if (hotels.length > 0) {
                    const totalRating = hotels.reduce((sum, hotel) => sum + hotel.rating, 0);
                    const averageRating = (totalRating / hotels.length).toFixed(1);
                    avgRatingElement.textContent = averageRating;
                } else {
                    avgRatingElement.textContent = '0.0';
                }
            }
            
            if (totalLocationsElement) {
                const uniqueLocations = new Set(hotels.map(hotel => hotel.location));
                totalLocationsElement.textContent = uniqueLocations.size;
            }
            
            if (priceRangeElement) {
                if (hotels.length > 0) {
                    const prices = hotels.filter(hotel => hotel.price > 0).map(hotel => hotel.price);
                    if (prices.length > 0) {
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        priceRangeElement.textContent = `$${minPrice.toLocaleString()}-$${maxPrice.toLocaleString()}`;
                    } else {
                        priceRangeElement.textContent = '$0-$0';
                    }
                } else {
                    priceRangeElement.textContent = '$0-$0';
                }
            }
            
            console.log(`✅ Estadísticas actualizadas: ${hotels.length} hoteles`);
            
            // Actualizar estadísticas del dashboard si está visible
            if (currentSection === 'dashboard' && typeof updateStats === 'function') {
                updateStats();
            }
        }

        // Función para ver detalles del hotel
        function viewHotel(hotelId) {
            console.log('👁️ Viendo detalles del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                console.error('❌ Hotel no encontrado:', hotelId);
                alert('❌ Hotel no encontrado');
                return;
            }
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">🏨 ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>📍 Ubicación:</strong> ${hotel.location}</p>
                        <p><strong>⭐ Calificación:</strong> ${hotel.rating}</p>
                        <p><strong>💰 Precio:</strong> ${hotel.price || 'No especificado'}</p>
                        <p><strong>📋 Estado:</strong> ${hotel.status}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>📝 Descripción:</strong></p>
                        <p>${hotel.description || 'Sin descripción'}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>🎯 Amenities:</strong></p>
                        <p>${Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : 'No especificadas'}</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ✏️ Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Función para editar hotel
        async function editHotel(hotelId) {
            console.log('Editando hotel:', hotelId);
            
            // PRIMERO: Limpiar el formulario completamente
            clearHotelForm();
            
            // Obtener hotel desde Supabase primero, luego localStorage como fallback
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                    console.log('📦 Hotel cargado desde Supabase:', hotel);
                } catch (error) {
                    console.warn('⚠️ Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback a localStorage si no se encontró en Supabase
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                console.log('📦 Hotel cargado desde localStorage:', hotel);
            }
            
            if (!hotel) {
                console.error('❌ Hotel no encontrado:', hotelId);
                alert('❌ Hotel no encontrado');
                return;
            }
            
            // Llenar el formulario con los datos del hotel
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const websiteInput = document.getElementById('editHotelWebsite');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            
            if (nameInput) nameInput.value = hotel.name || '';
            if (locationInput) locationInput.value = hotel.location || '';
            if (websiteInput) websiteInput.value = hotel.website || '';
            
            // IMPORTANTE: Supabase usa snake_case (google_maps), localStorage usa camelCase (googleMaps)
            if (googleMapsInput) {
                const googleMapsUrl = hotel.google_maps || hotel.googleMaps || '';
                googleMapsInput.value = googleMapsUrl;
                console.log('🗺️ Google Maps URL cargada:', googleMapsUrl);
            }
            
            if (ratingSelect) ratingSelect.value = hotel.rating || '0';
            if (priceInput) priceInput.value = hotel.price || '';
            if (descriptionTextarea) descriptionTextarea.value = hotel.description || '';
            if (amenitiesInput) amenitiesInput.value = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : '';
            if (statusSelect) statusSelect.value = hotel.status || 'Activo';
            
            // CARGAR CAMPOS DE FLOR IA
            const florInfo = hotel.flor_info || hotel.florInfo || {};
            console.log('🤖 Cargando información de Flor IA:', florInfo);
            
            const florDescriptionInput = document.getElementById('editHotelFlorDescription');
            const florServicesInput = document.getElementById('editHotelFlorServices');
            const florExcursionsInput = document.getElementById('editHotelFlorExcursions');
            const florPricesInput = document.getElementById('editHotelFlorPrices');
            const florPoliciesInput = document.getElementById('editHotelFlorPolicies');
            const florTransportInput = document.getElementById('editHotelFlorTransport');
            const florContactInput = document.getElementById('editHotelFlorContact');
            
            if (florDescriptionInput) florDescriptionInput.value = florInfo.description || '';
            if (florServicesInput) florServicesInput.value = florInfo.services || '';
            if (florExcursionsInput) florExcursionsInput.value = florInfo.excursions || '';
            if (florPricesInput) florPricesInput.value = florInfo.prices || '';
            if (florPoliciesInput) florPoliciesInput.value = florInfo.policies || '';
            if (florTransportInput) florTransportInput.value = florInfo.transport || '';
            if (florContactInput) florContactInput.value = florInfo.contact || '';
            
            // Cargar imágenes
            const imageInput = document.getElementById('editHotelImage');
            const photosInput = document.getElementById('editHotelPhotos');
            
            // En Supabase, las imágenes están en el campo 'images' (JSONB)
            // La primera imagen es la principal, el resto es la galería
            let mainImage = '';
            let galleryImages = [];
            
            if (hotel.mainImage) {
                // Si existe mainImage (localStorage antiguo)
                mainImage = hotel.mainImage;
                if (hotel.galleryImages && Array.isArray(hotel.galleryImages)) {
                    galleryImages = hotel.galleryImages;
                } else if (hotel.images && Array.isArray(hotel.images)) {
                    galleryImages = hotel.images.slice(1); // Excluir la primera que es mainImage
                }
            } else if (hotel.images && Array.isArray(hotel.images) && hotel.images.length > 0) {
                // Formato Supabase: todas las imágenes en el array 'images'
                mainImage = hotel.images[0];
                galleryImages = hotel.images.slice(1); // El resto es la galería
            } else if (hotel.images && typeof hotel.images === 'string') {
                // Formato antiguo: string separado por comas
                const imagesList = hotel.images.split(',').map(img => img.trim()).filter(img => img);
                if (imagesList.length > 0) {
                    mainImage = imagesList[0];
                    galleryImages = imagesList.slice(1);
                }
            }
            
            if (imageInput) {
                imageInput.value = mainImage;
                updateImagePreview();
            }
            if (photosInput) {
                photosInput.value = galleryImages.join('|||');
                updatePhotosPreview();
            }
            
            // Cambiar el título del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = '🏨 Editar Hotel';
            }
            
            // Guardar hotelId globalmente para acceso desde el gestor de imágenes
            globalEditingHotelId = hotelId;
            console.log('✅ HotelId guardado globalmente:', globalEditingHotelId);
            
            // Mostrar el modal
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'block';
                
                // Configurar el formulario para modo "editar"
                const form = document.getElementById('editHotelForm');
                if (form) {
                    form.dataset.mode = 'edit';
                    form.dataset.hotelId = hotelId;
                    console.log('✅ Formulario configurado - modo: edit, hotelId:', hotelId);
                    console.log('✅ Dataset del formulario:', {
                        mode: form.dataset.mode,
                        hotelId: form.dataset.hotelId,
                        hotel: {
                            id: hotel.id,
                            name: hotel.name
                        }
                    });
                } else {
                    console.error('❌ Formulario editHotelForm no encontrado');
                }
                
                // NOTA: Código de configuración de botones de imágenes eliminado - los campos fueron removidos
            }
        }

        // Función para exportar hoteles
        function exportHotels() {
            // Implementar exportación
            console.log('Exportando hoteles...');
        }

        // Función para refrescar hoteles
        function refreshHotels() {
            // Implementar refresco
            console.log('Refrescando hoteles...');
        }

        // Función para abrir modal de edición de hotel
        function openEditHotelModal(hotel) {
            // Implementar apertura de modal
            console.log('Abriendo modal de edición:', hotel);
        }

        // Función para cerrar modal de edición de hotel
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para obtener coordenadas por defecto según el nombre del hotel
        function getDefaultCoordinatesForHotel(hotelName) {
            const coordinatesMap = {
                'Hotel Termas Chillán': { lat: -36.6064, lng: -71.2167 },
                'Hotel Terma de Puyehue': { lat: -40.6500, lng: -72.6167 },
                'Hotel Huilo-Huilo': { lat: -39.8500, lng: -71.9000 },
                'Hotel Corralco Resort': { lat: -38.6500, lng: -71.6500 },
                'Hotel Futangue': { lat: -40.3500, lng: -72.4500 },
                'Cabañas Termas de Aguas Calientes': { lat: -40.735366, lng: -72.307616 }
            };
            
            return coordinatesMap[hotelName] || null;
        }
        
        // Función para extraer coordenadas de URL de Google Maps
        function extractCoordinatesFromGoogleMaps(url) {
            if (!url) return null;
            
            try {
                // Patrón 1: URL con coordenadas directas
                // https://maps.google.com/?q=-36.6064,-71.2167
                const coordPattern1 = /q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match1 = url.match(coordPattern1);
                if (match1) {
                    return {
                        lat: parseFloat(match1[1]),
                        lng: parseFloat(match1[2])
                    };
                }
                
                // Patrón 2: URL con coordenadas en formato @lat,lng
                // https://maps.google.com/?q=Hotel+Termas+Chillán@-36.6064,-71.2167
                const coordPattern2 = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match2 = url.match(coordPattern2);
                if (match2) {
                    return {
                        lat: parseFloat(match2[1]),
                        lng: parseFloat(match2[2])
                    };
                }
                
                // Patrón 3: URL con coordenadas en formato ll=lat,lng
                // https://maps.google.com/?ll=-36.6064,-71.2167
                const coordPattern3 = /ll=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match3 = url.match(coordPattern3);
                if (match3) {
                    return {
                        lat: parseFloat(match3[1]),
                        lng: parseFloat(match3[2])
                    };
                }
                
                // Patrón 4: URLs modernas de Google Maps (maps.app.goo.gl)
                // https://maps.app.goo.gl/cxC7gREKNFuoiuj4A
                if (url.includes('maps.app.goo.gl') || url.includes('goo.gl/maps')) {
                    console.log('🌐 URL moderna de Google Maps detectada, intentando obtener coordenadas...');
                    
                    // Para URLs modernas, necesitamos hacer una petición HTTP para obtener las coordenadas
                    // Por ahora, mostraremos un mensaje informativo
                    return {
                        lat: null,
                        lng: null,
                        modernUrl: true,
                        message: 'URL moderna de Google Maps detectada. Las coordenadas se extraerán automáticamente cuando se guarde el hotel.'
                    };
                }
                
                // Patrón 5: URLs con coordenadas en formato decimal
                // https://maps.google.com/?q=-36.6064,-71.2167&z=15
                const coordPattern5 = /[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match5 = url.match(coordPattern5);
                if (match5) {
                    return {
                        lat: parseFloat(match5[1]),
                        lng: parseFloat(match5[2])
                    };
                }
                
                console.log('⚠️ No se pudieron extraer coordenadas de la URL:', url);
                return null;
            } catch (error) {
                console.error('❌ Error al extraer coordenadas:', error);
                return null;
            }
        }
        
        // Función para mostrar ayuda de Google Maps
        function openGoogleMapsHelp() {
            const helpText = `
🌍 <strong>¿Cómo obtener el enlace de Google Maps?</strong>

1. <strong>Busca el hotel</strong> en Google Maps
2. <strong>Haz clic en "Compartir"</strong> (botón azul)
3. <strong>Selecciona "Copiar enlace"</strong>
4. <strong>Pega el enlace</strong> en el campo de arriba

<strong>Formatos de URL soportados:</strong>

✅ <strong>URL con coordenadas directas:</strong>
https://maps.google.com/?q=-36.6064,-71.2167

✅ <strong>URL con nombre del hotel:</strong>
https://maps.google.com/?q=Hotel+Termas+Chillán

✅ <strong>URL moderna (maps.app.goo.gl):</strong>
https://maps.app.goo.gl/cxC7gREKNFuoiuj4A

<strong>💡 Coordenadas se extraerán automáticamente para el mapa interactivo!</strong>

<strong>⚠️ Nota:</strong> Las URLs modernas se procesarán automáticamente al guardar el hotel.
            `;
            
            alert(helpText);
        }
        
        // Función para probar extracción de coordenadas
        function testCoordinatesExtraction() {
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            if (!googleMapsInput || !googleMapsInput.value) {
                alert('⚠️ Por favor ingresa una URL de Google Maps primero');
                return;
            }
            
            const url = googleMapsInput.value.trim();
            const extractedCoords = extractCoordinatesFromGoogleMaps(url);
            
            if (extractedCoords && extractedCoords.modernUrl) {
                alert(`🌐 URL moderna de Google Maps detectada:\n\n${url}\n\n✅ Esta URL será guardada y las coordenadas se extraerán automáticamente cuando se guarde el hotel.\n\n💡 Tip: Para obtener coordenadas inmediatas, usa el formato:\nhttps://maps.google.com/?q=-36.6064,-71.2167`);
            } else if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                alert(`✅ Coordenadas extraídas exitosamente:\n\nLatitud: ${extractedCoords.lat}\nLongitud: ${extractedCoords.lng}\n\nEstas coordenadas se usarán automáticamente en el mapa interactivo.`);
            } else {
                alert(`❌ No se pudieron extraer coordenadas de la URL:\n\n${url}\n\n💡 Sugerencias:\n1. Usa el formato: https://maps.google.com/?q=-36.6064,-71.2167\n2. O busca el hotel en Google Maps y copia el enlace completo\n3. Para URLs modernas, las coordenadas se extraerán automáticamente al guardar.`);
            }
        }

        // Función para guardar cambios del hotel
        async function saveHotelChanges() {
            console.log('💾 Guardando cambios del hotel...');
            
            const form = document.getElementById('editHotelForm');
            if (!form) {
                console.error('❌ Formulario no encontrado');
                return;
            }
            
            // Obtener datos del formulario
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const websiteInput = document.getElementById('editHotelWebsite');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            if (!nameInput || !locationInput) {
                console.error('❌ Campos requeridos no encontrados');
                return;
            }
            
            // Obtener imágenes del formulario (pueden ser base64 o URLs)
            const imageInput = document.getElementById('editHotelImage');
            const photosInput = document.getElementById('editHotelPhotos');
            let mainImage = imageInput?.value?.trim() || '';
            let galleryImages = getGalleryImagesFromInput();
            
            // Validar tamaño de imágenes base64 (localStorage tiene límite de ~5-10MB por item)
            const maxImageSize = 2 * 1024 * 1024; // 2MB por imagen base64
            if (mainImage && mainImage.startsWith('data:') && mainImage.length > maxImageSize) {
                console.warn('⚠️ Imagen principal muy grande, truncando...');
                alert('⚠️ La imagen principal es muy grande. Considera usar una URL externa o comprimir la imagen.');
            }
            
            // Filtrar imágenes de galería que sean demasiado grandes
            galleryImages = galleryImages.filter(img => {
                if (img.startsWith('data:') && img.length > maxImageSize) {
                    console.warn('⚠️ Imagen de galería muy grande, omitiendo...');
                    return false;
                }
                return true;
            });
            
            // Obtener campos de Flor IA
            const florDescription = document.getElementById('editHotelFlorDescription')?.value?.trim() || '';
            const florServices = document.getElementById('editHotelFlorServices')?.value?.trim() || '';
            const florExcursions = document.getElementById('editHotelFlorExcursions')?.value?.trim() || '';
            const florPrices = document.getElementById('editHotelFlorPrices')?.value?.trim() || '';
            const florPolicies = document.getElementById('editHotelFlorPolicies')?.value?.trim() || '';
            const florTransport = document.getElementById('editHotelFlorTransport')?.value?.trim() || '';
            const florContact = document.getElementById('editHotelFlorContact')?.value?.trim() || '';
            
            // Obtener campos de conocimiento adicional
            const knowledgeDescription = document.getElementById('editHotelKnowledgeDescription')?.value?.trim() || '';
            const knowledgeServicesDetail = document.getElementById('editHotelKnowledgeServicesDetail')?.value?.trim() || '';
            const knowledgePricing = document.getElementById('editHotelKnowledgePricing')?.value?.trim() || '';
            const knowledgeTransport = document.getElementById('editHotelKnowledgeTransport')?.value?.trim() || '';
            const knowledgeNotes = document.getElementById('editHotelKnowledgeNotes')?.value?.trim() || '';
            const knowledgeWebsiteInfo = document.getElementById('editHotelKnowledgeWebsiteInfo')?.value?.trim() || '';
            
            const hotelData = {
                name: nameInput.value.trim(),
                location: locationInput.value.trim(),
                googleMaps: googleMapsInput?.value?.trim() || '',
                website: websiteInput?.value?.trim() || '', // URL del sitio web del hotel
                rating: parseInt(ratingSelect?.value || '0'),
                price: priceInput?.value ? parseInt(priceInput.value) : 0,
                description: descriptionTextarea?.value || '',
                amenities: amenitiesInput?.value ? amenitiesInput.value.split(',').map(a => a.trim()) : [],
                status: statusSelect?.value || 'Activo',
                mainImage: mainImage, // Imagen principal (base64 o URL)
                galleryImages: galleryImages, // Galería de fotos (array de base64 o URLs)
                images: mainImage ? [mainImage, ...galleryImages] : galleryImages, // Compatibilidad con versiones anteriores
                // Campos de información para Flor IA
                florInfo: {
                    description: florDescription,
                    services: florServices,
                    excursions: florExcursions,
                    prices: florPrices,
                    policies: florPolicies,
                    transport: florTransport,
                    contact: florContact
                }
            };
            
            // Extraer coordenadas de Google Maps si está disponible
            if (hotelData.googleMaps) {
                const extractedCoords = extractCoordinatesFromGoogleMaps(hotelData.googleMaps);
                if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                    hotelData.coordinates = extractedCoords;
                    console.log(`✅ Coordenadas extraídas de Google Maps para ${hotelData.name}:`, extractedCoords);
                } else if (extractedCoords && extractedCoords.modernUrl) {
                    console.log(`🌐 URL moderna de Google Maps guardada para ${hotelData.name}. Las coordenadas se extraerán automáticamente.`);
                    // Para URLs modernas, usamos coordenadas por defecto temporalmente
                    const defaultCoords = getDefaultCoordinatesForHotel(hotelData.name);
                    if (defaultCoords) {
                        hotelData.coordinates = defaultCoords;
                        console.log(`📍 Usando coordenadas por defecto para ${hotelData.name}:`, defaultCoords);
                    }
                }
            }
            
            // Validar campos requeridos
            if (!hotelData.name || !hotelData.location) {
                alert('❌ Por favor completa los campos requeridos (Nombre y Ubicación)');
                return;
            }
            
            const mode = form.dataset.mode;
            const hotelId = form.dataset.hotelId;
            
            console.log('📋 Modo del formulario:', mode);
            console.log('📋 ID del hotel:', hotelId);
            
            if (!mode) {
                console.error('❌ Modo del formulario no definido');
                alert('❌ Error: Modo del formulario no definido. Por favor, cierra y vuelve a abrir el formulario.');
                return;
            }
            
            if (mode === 'add') {
                // Agregar nuevo hotel
                try {
                    // Preparar datos para Supabase
                    // NOTA: La tabla hotels solo tiene 'images' (JSONB), no 'mainImage' ni 'galleryImages'
                    // Combinamos mainImage y galleryImages en el campo images
                    const imagesArray = [];
                    if (hotelData.mainImage) {
                        imagesArray.push(hotelData.mainImage);
                    }
                    if (hotelData.galleryImages && Array.isArray(hotelData.galleryImages)) {
                        imagesArray.push(...hotelData.galleryImages);
                    }
                    
                    // Preparar coordenadas (debe ser JSONB o null)
                    let coordinatesData = null;
                    if (hotelData.coordinates) {
                        if (typeof hotelData.coordinates === 'object' && hotelData.coordinates.lat && hotelData.coordinates.lng) {
                            coordinatesData = hotelData.coordinates;
                        } else {
                            coordinatesData = hotelData.coordinates;
                        }
                    }
                    
                    // Preparar amenities (debe ser JSONB array o null)
                    let amenitiesData = null;
                    if (hotelData.amenities && Array.isArray(hotelData.amenities) && hotelData.amenities.length > 0) {
                        amenitiesData = hotelData.amenities;
                    } else if (hotelData.amenities && typeof hotelData.amenities === 'string') {
                        amenitiesData = hotelData.amenities.split(',').map(a => a.trim()).filter(a => a);
                    }
                    
                    const hotelForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description || null,
                        rating: hotelData.rating || 0,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status || 'Activo',
                        amenities: amenitiesData,
                        images: imagesArray.length > 0 ? imagesArray : null,
                        coordinates: coordinatesData,
                        google_maps: hotelData.googleMaps || null,
                        website: hotelData.website || null,
                        flor_info: hotelData.florInfo || null // Información para Flor IA
                    };
                    
                    console.log('📤 Datos preparados para Supabase (nuevo hotel):', {
                        ...hotelForSupabase,
                        images: imagesArray.length > 0 ? `${imagesArray.length} imagen(es)` : 'vacío',
                        imagesSize: JSON.stringify(imagesArray).length
                    });

                    // Intentar guardar en Supabase primero
                    let savedHotelId = null;
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            const savedHotel = await window.supabaseClient.createHotel(hotelForSupabase);
                            console.log('✅ Hotel guardado en Supabase:', savedHotel);
                            savedHotelId = savedHotel.id || savedHotel.id;
                            // Guardar conocimiento adicional
                            saveHotelKnowledgeAdditional(savedHotelId);
                            // Sincronizar con Flor IA
                            if (savedHotelId && typeof window.syncHotelToFlorKnowledge === 'function') {
                                window.syncHotelToFlorKnowledge(savedHotelId, savedHotel);
                            }
                            // Actualizar selector de hoteles en pestaña de conocimiento
                            if (typeof loadHotelsForFlor === 'function') {
                                await loadHotelsForFlor();
                            }
                            alert('✅ Hotel agregado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('⚠️ Error guardando en Supabase, guardando en localStorage:', error);
                            // Fallback a localStorage
                            const newHotel = {
                                id: Date.now().toString(),
                                ...hotelData,
                                createdAt: new Date().toISOString()
                            };
                            const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            existingHotels.push(newHotel);
                            localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                            savedHotelId = newHotel.id;
                            // Guardar conocimiento adicional
                            saveHotelKnowledgeAdditional(savedHotelId);
                            // Sincronizar con Flor IA
                            if (typeof window.syncHotelToFlorKnowledge === 'function') {
                                window.syncHotelToFlorKnowledge(savedHotelId, newHotel);
                            }
                            // Actualizar selector de hoteles en pestaña de conocimiento
                            if (typeof loadHotelsForFlor === 'function') {
                                await loadHotelsForFlor();
                            }
                            alert('✅ Hotel agregado correctamente (guardado localmente)');
                        }
                    } else {
                        // Solo localStorage si Supabase no está disponible
                        const newHotel = {
                            id: Date.now().toString(),
                            ...hotelData,
                            createdAt: new Date().toISOString()
                        };
                        const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        existingHotels.push(newHotel);
                        localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                        savedHotelId = newHotel.id;
                        // Guardar conocimiento adicional
                        saveHotelKnowledgeAdditional(savedHotelId);
                        // Sincronizar con Flor IA
                        if (typeof window.syncHotelToFlorKnowledge === 'function') {
                            window.syncHotelToFlorKnowledge(savedHotelId, newHotel);
                        }
                        alert('✅ Hotel agregado correctamente (guardado localmente)');
                    }
                } catch (error) {
                    console.error('❌ Error guardando hotel:', error);
                    alert('❌ Error al guardar el hotel');
                }
                
            } else if (mode === 'edit') {
                // Editar hotel existente
                if (!hotelId) {
                    console.error('❌ ID de hotel no encontrado para edición');
                    console.error('📋 Form dataset:', {
                        mode: form.dataset.mode,
                        hotelId: form.dataset.hotelId,
                        formId: form.id
                    });
                    alert('❌ Error: ID de hotel no encontrado. Por favor, cierra y vuelve a abrir el formulario.');
                    return;
                }
                
                try {
                    // Preparar datos para Supabase
                    // NOTA: La tabla hotels solo tiene 'images' (JSONB), no 'mainImage' ni 'galleryImages'
                    // Combinamos mainImage y galleryImages en el campo images
                    const imagesArray = [];
                    if (hotelData.mainImage) {
                        imagesArray.push(hotelData.mainImage);
                    }
                    if (hotelData.galleryImages && Array.isArray(hotelData.galleryImages)) {
                        imagesArray.push(...hotelData.galleryImages);
                    }
                    
                    // Preparar coordenadas (debe ser JSONB o null)
                    let coordinatesData = null;
                    if (hotelData.coordinates) {
                        if (typeof hotelData.coordinates === 'object' && hotelData.coordinates.lat && hotelData.coordinates.lng) {
                            coordinatesData = hotelData.coordinates;
                        } else {
                            coordinatesData = hotelData.coordinates;
                        }
                    }
                    
                    // Preparar amenities (debe ser JSONB array o null)
                    let amenitiesData = null;
                    if (hotelData.amenities && Array.isArray(hotelData.amenities) && hotelData.amenities.length > 0) {
                        amenitiesData = hotelData.amenities;
                    } else if (hotelData.amenities && typeof hotelData.amenities === 'string') {
                        amenitiesData = hotelData.amenities.split(',').map(a => a.trim()).filter(a => a);
                    }
                    
                    const updatesForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description || null,
                        rating: hotelData.rating || 0,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status || 'Activo',
                        amenities: amenitiesData,
                        images: imagesArray.length > 0 ? imagesArray : null,
                        coordinates: coordinatesData,
                        google_maps: hotelData.googleMaps || null,
                        website: hotelData.website || null,
                        flor_info: hotelData.florInfo || null // Información para Flor IA
                    };
                    
                    console.log('📤 Datos preparados para Supabase:', {
                        ...updatesForSupabase,
                        images: imagesArray.length > 0 ? `${imagesArray.length} imagen(es)` : 'vacío',
                        imagesSize: JSON.stringify(imagesArray).length
                    });

                    // Intentar actualizar en Supabase primero
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            // Convertir hotelId a número si es necesario (Supabase usa IDs numéricos)
                            const numericHotelId = isNaN(parseInt(hotelId)) ? hotelId : parseInt(hotelId);
                            console.log('🔄 Actualizando hotel en Supabase, ID:', numericHotelId, 'Tipo:', typeof numericHotelId);
                            
                            await window.supabaseClient.updateHotel(numericHotelId, updatesForSupabase);
                            console.log('Hotel actualizado en Supabase');
                            
                            // También actualizar localStorage para que Flor pueda usar los datos
                            const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotelIndex = existingHotels.findIndex(h => h.id == hotelId || h.id === numericHotelId);
                            let updatedHotel = null;
                            if (hotelIndex !== -1) {
                                existingHotels[hotelIndex] = {
                                    ...existingHotels[hotelIndex],
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                };
                                updatedHotel = existingHotels[hotelIndex];
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                console.log('✅ localStorage también actualizado');
                            } else {
                                // Si no existe en localStorage, agregarlo
                                updatedHotel = {
                                    id: numericHotelId,
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                };
                                existingHotels.push(updatedHotel);
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                console.log('✅ Hotel agregado a localStorage');
                            }
                            
                            // Guardar conocimiento adicional
                            saveHotelKnowledgeAdditional(numericHotelId);
                            
                            // Sincronizar con Flor IA
                            if (updatedHotel && typeof window.syncHotelToFlorKnowledge === 'function') {
                                window.syncHotelToFlorKnowledge(numericHotelId, updatedHotel);
                            }
                            
                            alert('✅ Hotel actualizado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('⚠️ Error actualizando en Supabase, actualizando en localStorage:', error);
                            // Fallback a localStorage
                            try {
                                const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                                const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                                if (hotelIndex !== -1) {
                                    const updatedHotel = {
                                        ...existingHotels[hotelIndex],
                                        ...hotelData,
                                        updatedAt: new Date().toISOString()
                                    };
                                    existingHotels[hotelIndex] = updatedHotel;
                                    localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                    // Guardar conocimiento adicional
                                    saveHotelKnowledgeAdditional(hotelId);
                                    
                                    // Sincronizar con Flor IA
                                    if (typeof window.syncHotelToFlorKnowledge === 'function') {
                                        window.syncHotelToFlorKnowledge(hotelId, updatedHotel);
                                    }
                                    
                                    // Actualizar selector de hoteles en pestaña de conocimiento
                                    if (typeof loadHotelsForFlor === 'function') {
                                        await loadHotelsForFlor();
                                    }
                                    
                                    alert('✅ Hotel actualizado correctamente (guardado localmente)');
                                } else {
                                    console.error('❌ Hotel no encontrado para editar en localStorage');
                                    alert('❌ Error: Hotel no encontrado');
                                }
                            } catch (localError) {
                                console.error('❌ Error guardando en localStorage:', localError);
                                throw new Error(`Error guardando en localStorage: ${localError.message}`);
                            }
                        }
                    } else {
                        // Solo localStorage si Supabase no está disponible
                        try {
                            const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                            if (hotelIndex !== -1) {
                                const updatedHotel = {
                                    ...existingHotels[hotelIndex],
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                };
                                existingHotels[hotelIndex] = updatedHotel;
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                // Guardar conocimiento adicional
                                saveHotelKnowledgeAdditional(hotelId);
                                // Sincronizar con Flor IA
                                if (typeof window.syncHotelToFlorKnowledge === 'function') {
                                    window.syncHotelToFlorKnowledge(hotelId, updatedHotel);
                                }
                                alert('✅ Hotel actualizado correctamente (guardado localmente)');
                            } else {
                                console.error('❌ Hotel no encontrado para editar');
                                alert('❌ Error: Hotel no encontrado');
                            }
                        } catch (localError) {
                            console.error('❌ Error guardando en localStorage:', localError);
                            throw new Error(`Error guardando en localStorage: ${localError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('❌ Error actualizando hotel:', error);
                    const errorMessage = error?.message || error?.toString() || 'Error desconocido';
                    console.error('📋 Detalles del error:', {
                        error,
                        hotelId,
                        hotelData: {
                            ...hotelData,
                            mainImage: hotelData.mainImage ? `${hotelData.mainImage.substring(0, 50)}...` : 'vacío',
                            galleryImages: hotelData.galleryImages?.length || 0
                        }
                    });
                    alert(`❌ Error al actualizar el hotel\n\n${errorMessage}\n\nRevisa la consola para más detalles.`);
                }
            } else {
                console.error('❌ Modo de formulario desconocido:', mode);
                alert(`❌ Error: Modo de formulario desconocido (${mode}). Por favor, cierra y vuelve a abrir el formulario.`);
            }
            
            // Cerrar modal
            closeEditHotelModal();
            
            // Actualizar tabla y estadísticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            
            // Notificar actualización del mapa interactivo
            console.log('🗺️ Notificando actualización del mapa interactivo...');
            window.dispatchEvent(new CustomEvent('hotelsMapUpdated', {
                detail: { 
                    hotelId: hotelId || newHotel?.id, 
                    coordinates: hotelData.coordinates,
                    hotelName: hotelData.name 
                }
            }));
            
            // Actualizar la tabla y estadísticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
        }

        // Función para abrir modal de vista previa de imágenes
        function openImagePreviewModal() {
            // Implementar apertura de modal
            console.log('Abriendo modal de vista previa...');
        }

        // Función para cerrar modal de vista previa de imágenes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para inicializar base de datos de clientes
        function initClientesDB() {
            // Implementar inicialización
            console.log('Inicializando base de datos de clientes...');
        }

        // Función para inicializar base de datos de hoteles (duplicada - eliminada)

        // Función para buscar cliente por email
        function buscarClientePorEmail(email) {
            // Implementar búsqueda
            console.log('Buscando cliente por email:', email);
            return null;
        }

        // Función para validar email
        function validarEmail(email) {
            // Implementar validación
            console.log('Validando email:', email);
            return true;
        }

        // Función de logout (reemplazada por la nueva implementación arriba)

        // Función para actualizar dashboard para usuario logueado
        function updateDashboardForLoggedInUser() {
            // Implementar actualización
            console.log('Actualizando dashboard para usuario logueado...');
        }

        // Función para cargar contenido del dashboard
        function loadDashboardContent() {
            // Implementar carga de contenido
            console.log('Cargando contenido del dashboard...');
        }

        // Función para restaurar secciones del dashboard
        function restoreDashboardSections() {
            // Implementar restauración
            console.log('Restaurando secciones del dashboard...');
        }

        // Función para actualizar dashboard para usuario deslogueado
        function updateDashboardForLoggedOutUser() {
            // Implementar actualización
            console.log('Actualizando dashboard para usuario deslogueado...');
        }

        // Función para actualizar estadísticas personales
        function updatePersonalStats() {
            // Implementar estadísticas personales
            console.log('Actualizando estadísticas personales...');
        }

        // Función para mostrar pantalla de login
        function showLoginScreen() {
            // Implementar pantalla de login
            console.log('Mostrando pantalla de login...');
        }

        // Función para mostrar formulario de registro
        function showRegisterForm() {
            // Implementar formulario de registro
            console.log('Mostrando formulario de registro...');
        }

        // ============================================
        // SOBRESCRIBIR BOTONES DE IMAGENES - EVITA CACHE
        // ============================================
        function sobrescribirBotonesImagenes() {
            // Buscar todos los botones que abren el gestor de imágenes
            const buttons = document.querySelectorAll('button[onclick*="imageManager"], button[onclick*="abrirModal"], button[onclick*="openImage"]');
            
            buttons.forEach(function(btn) {
                // Verificar si el botón tiene el texto "Seleccionar" y un ícono folder_open
                const icon = btn.querySelector('.material-icons');
                if (icon && icon.textContent === 'folder_open') {
                    btn.onclick = function() {
                        console.log('🚀 Botón clickeado - Abriendo modal directamente');
                        var modal = document.getElementById('imageManagerModal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.style.zIndex = '99999';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                            console.log('✅ Modal abierto - Display:', modal.style.display);
                            
                            // Configurar nombre del hotel
                            var hotelNameSpan = document.getElementById('currentHotelName');
                            if (hotelNameSpan) {
                                var nameInput = document.getElementById('editHotelName');
                                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                            }
                        } else {
                            alert('ERROR: Modal no encontrado. Por favor, recarga la página.');
                        }
                    };
                    console.log('✅ Botón sobrescrito:', btn);
                }
            });
        }

        // ===== SISTEMA DE SINCRONIZACIÓN EN TIEMPO REAL =====
        
        // Mostrar notificación de actualización
        function showRealtimeNotification(message, type = 'info') {
            // Crear notificación
            const notification = document.createElement('div');
            notification.className = 'realtime-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'info' ? '#2196f3' : type === 'success' ? '#4caf50' : '#ff9800'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <span class="material-icons" style="font-size: 24px;">sync</span>
                <div>
                    <strong style="display: block; margin-bottom: 4px;">Actualización en tiempo real</strong>
                    <span style="font-size: 0.9rem;">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Agregar animación CSS si no existe
            if (!document.getElementById('realtime-notification-styles')) {
                const style = document.createElement('style');
                style.id = 'realtime-notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remover después de 4 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        // Inicializar suscripciones en tiempo real
        function initRealtimeSubscriptions() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.warn('⚠️ Supabase no está listo para tiempo real');
                return;
            }
            
            console.log('🔄 Iniciando sincronización en tiempo real...');
            
            // Variable para evitar recargas múltiples
            let reloadTimeout = null;
            
            function scheduleReload(sectionId, message) {
                if (reloadTimeout) clearTimeout(reloadTimeout);
                reloadTimeout = setTimeout(() => {
                    // Recargar la sección correspondiente
                    switch(sectionId) {
                        case 'hotels':
                            if (typeof loadHotelsTable === 'function') loadHotelsTable();
                            break;
                        case 'reservations':
                            if (typeof loadReservations === 'function') loadReservations();
                            break;
                        case 'quotes':
                            if (typeof loadQuotes === 'function') loadQuotes();
                            break;
                        case 'users':
                            if (typeof loadUsersData === 'function') loadUsersData();
                            break;
                        case 'expenses':
                            if (typeof loadExpenses === 'function') loadExpenses();
                            break;
                    }
                    showRealtimeNotification(message, 'info');
                }, 500);
            }
            
            // Suscribirse a cambios en hoteles
            window.supabaseClient.subscribeToHotels((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                scheduleReload('hotels', `Se ${action} un hotel`);
            });
            
            // Suscribirse a cambios en reservaciones
            window.supabaseClient.subscribeToReservations((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                scheduleReload('reservations', `Se ${action} una reserva`);
            });
            
            // Suscribirse a cambios en cotizaciones
            window.supabaseClient.subscribeToQuotes((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                scheduleReload('quotes', `Se ${action} una cotización`);
            });
            
            // Suscribirse a cambios en usuarios
            window.supabaseClient.subscribeToUsers((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                scheduleReload('users', `Se ${action} un usuario`);
            });
            
            // Suscribirse a cambios en gastos
            window.supabaseClient.subscribeToExpenses((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                scheduleReload('expenses', `Se ${action} un gasto`);
            });
            
            // Suscribirse a cambios en agentes
            window.supabaseClient.subscribeToAgents((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agregó' : 
                               payload.eventType === 'UPDATE' ? 'actualizó' : 'eliminó';
                // Recargar reservaciones ya que los agentes se usan ahí
                scheduleReload('reservations', `Se ${action} un agente`);
            });
            
            console.log('✅ Sincronización en tiempo real activa');
            
            // Mostrar indicador de conexión en tiempo real
            showRealtimeIndicator();
        }
        
        // Mostrar indicador de conexión en tiempo real en la UI
        function showRealtimeIndicator() {
            // Agregar indicador al header si no existe
            if (!document.getElementById('realtime-indicator')) {
                const header = document.querySelector('.dashboard-header') || document.querySelector('.main-header');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.id = 'realtime-indicator';
                    indicator.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        background: rgba(76, 175, 80, 0.2);
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 0.85rem;
                        color: #4caf50;
                        margin-left: auto;
                    `;
                    indicator.innerHTML = `
                        <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>Tiempo real</span>
                    `;
                    
                    // Agregar animación de pulso
                    if (!document.getElementById('pulse-animation')) {
                        const style = document.createElement('style');
                        style.id = 'pulse-animation';
                        style.textContent = `
                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.5; }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    header.appendChild(indicator);
                }
            }
        }
        
        // Hacer funciones globales
        window.initRealtimeSubscriptions = initRealtimeSubscriptions;
        window.showRealtimeNotification = showRealtimeNotification;
        
        // ===== FUNCIONES DE FECHA/HORA ARGENTINA =====
        
        // Obtener fecha actual de Argentina en formato YYYY-MM-DD
        function getArgentinaDateString() {
            return new Date().toLocaleDateString('en-CA', { 
                timeZone: 'America/Argentina/Buenos_Aires' 
            });
        }
        
        // Obtener fecha y hora de Argentina formateada
        function getArgentinaDateTime() {
            return new Date().toLocaleString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Formatear fecha para mostrar (de string a formato legible)
        function formatDateArgentina(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Formatear fecha y hora para mostrar
        function formatDateTimeArgentina(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Hacer funciones globales
        window.getArgentinaDateString = getArgentinaDateString;
        window.getArgentinaDateTime = getArgentinaDateTime;
        window.formatDateArgentina = formatDateArgentina;
        window.formatDateTimeArgentina = formatDateTimeArgentina;

        // Event listener para cuando el DOM esté listo
        // IMPORTANTE: Este código se ejecuta DESPUÉS de la verificación de autenticación
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard DOMContentLoaded ejecutado');
            
            // Verificar que las funciones de los nuevos modales estén disponibles
            console.log('🔍 Verificando funciones de modales nuevos...');
            console.log('  - addNewExpenseNew:', typeof window.addNewExpenseNew);
            console.log('  - openQuoteModalNew:', typeof window.openQuoteModalNew);
            console.log('  - expenseModalNew:', document.getElementById('expenseModalNew') ? '✅ encontrado' : '❌ NO encontrado');
            console.log('  - quoteModalNew:', document.getElementById('quoteModalNew') ? '✅ encontrado' : '❌ NO encontrado');
            
            // Sobrescribir botones inmediatamente
            sobrescribirBotonesImagenes();
            
            // También sobrescribir después de un pequeño delay por si el HTML se carga después
            setTimeout(sobrescribirBotonesImagenes, 500);
            setTimeout(sobrescribirBotonesImagenes, 1000);
            setTimeout(sobrescribirBotonesImagenes, 2000);
            
            // CONFIGURAR EVENT LISTENERS DEL MODAL DE IMÁGENES
            setTimeout(function() {
                // Botón cerrar modal
                const btnClose = document.getElementById('btnCloseImageManager');
                if (btnClose) {
                    btnClose.onclick = closeImageManagerSimple;
                }
                
                // Botón cancelar
                const btnCancel = document.getElementById('btnCancelImageManager');
                if (btnCancel) {
                    btnCancel.onclick = closeImageManagerSimple;
                }
                
                // Botón subir imágenes
                const btnUpload = document.getElementById('btnUploadImages');
                if (btnUpload) {
                    btnUpload.onclick = uploadImagesSimple;
                }
                
                // Botón aplicar selección
                const btnApply = document.getElementById('btnApplyImageSelection');
                if (btnApply) {
                    btnApply.onclick = applyImageSelectionSimple;
                }
                
                // NOTA: Código de botones de imágenes eliminado - los campos fueron removidos
                
                console.log('✅ Event listeners del modal de imágenes configurados');
            }, 500);
            
            // Verificar si hay sesión válida
            const authSession = localStorage.getItem('dashboard_auth_session');
            let isAuthenticated = false;
            
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        isAuthenticated = true;
                    } else {
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    localStorage.removeItem('dashboard_auth_session');
                }
            }
            
            // Solo inicializar el dashboard si el usuario está autenticado
            if (isAuthenticated) {
                console.log('✅ Usuario autenticado, inicializando dashboard...');
            // Inicializar dashboard
                if (typeof initializeDashboard === 'function') {
            initializeDashboard();
                }
            
            // Configurar sincronización automática
                if (typeof setupAutoSync === 'function') {
            setupAutoSync();
                }
            
            console.log('✅ Dashboard inicializado correctamente');
            } else {
                console.log('🔒 Usuario no autenticado, NO inicializando dashboard');
                // Asegurar que el dashboard esté oculto
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                if (dashboardContent) dashboardContent.classList.remove('authenticated');
                if (loginContainer) loginContainer.classList.remove('hidden');
            }
        });

        // Función para cargar configuración de IA desde Supabase
        window.loadAIConfigFromSupabase = async function loadAIConfigFromSupabase() {
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    const { data, error } = await window.supabaseClient.client
                        .from('system_config')
                        .select('value')
                        .eq('key', 'flor_ai_config')
                        .single();
                    
                    if (!error && data && data.value) {
                        const cloudConfig = JSON.parse(data.value);
                        // Guardar en localStorage
                        localStorage.setItem('flor_ai_config', JSON.stringify(cloudConfig));
                        console.log('☁️ Configuración de IA cargada desde Supabase');
                        
                        // Actualizar campos del formulario si están visibles
                        if (document.getElementById('ai-enabled')) {
                            document.getElementById('ai-enabled').checked = cloudConfig.enabled || false;
                            toggleAIConfig();
                        }
                        if (document.getElementById('ai-provider')) {
                            document.getElementById('ai-provider').value = cloudConfig.provider || 'gemini';
                        }
                        if (document.getElementById('ai-api-key')) {
                            document.getElementById('ai-api-key').value = cloudConfig.apiKey || '';
                        }
                        if (document.getElementById('ai-model')) {
                            document.getElementById('ai-model').value = cloudConfig.model || 'gemini-2.5-flash';
                        }
                        if (document.getElementById('ai-temperature')) {
                            document.getElementById('ai-temperature').value = cloudConfig.temperature || 0.7;
                        }
                        if (document.getElementById('ai-max-tokens')) {
                            document.getElementById('ai-max-tokens').value = cloudConfig.maxTokens || 500;
                        }
                    }
                }
            } catch (e) {
                console.log('ℹ️ Usando configuración de IA local');
            }
            
            // Verificar si hay configuración en localStorage y aplicar toggle
            try {
                const localConfig = localStorage.getItem('flor_ai_config');
                if (localConfig) {
                    const config = JSON.parse(localConfig);
                    const aiEnabled = document.getElementById('ai-enabled');
                    if (aiEnabled && config.enabled) {
                        aiEnabled.checked = true;
                        // Ejecutar toggle solo si estamos en la pestaña de IA
                        const aiTab = document.getElementById('flor-tab-ai');
                        if (aiTab && aiTab.style.display !== 'none') {
                            toggleAIConfig();
                        }
                    }
                }
            } catch (e) {
                // Ignorar errores de localStorage
            }
        }

        // Función para configurar sincronización automática
        function setupAutoSync() {
            console.log('🔄 Configurando sincronización automática...');
            
            // Cargar configuración de IA desde Supabase
            loadAIConfigFromSupabase();
            
            // Cargar datos iniciales
            loadUsersData();
            
            // Configurar listener para cambios en localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'checkin24hs_users') {
                    console.log('🔄 Cambio detectado en usuarios, actualizando dashboard...');
                    loadUsersData();
                }
                if (e.key === 'agentsDB') {
                    console.log('🔄 Cambio detectado en agentes, actualizando dashboard...');
                    if (typeof loadAgentsTable === 'function' && document.getElementById('agents-section')?.style.display !== 'none') {
                        loadAgentsTable();
                    }
                    if (typeof loadAgentsForNewReservation === 'function') {
                        loadAgentsForNewReservation();
                    }
                }
            });
            
            // Sincronización automática cada 30 segundos
            setInterval(() => {
                console.log('🔄 Sincronización automática...');
                loadUsersData();
            }, 30000);
            
            // Configurar suscripciones en tiempo real de Supabase
            setupRealtimeSubscriptions();
            
            console.log('✅ Sincronización automática configurada');
        }
        
        // Configurar suscripciones en tiempo real de Supabase
        function setupRealtimeSubscriptions() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.log('⚠️ Supabase no inicializado, no se pueden configurar suscripciones en tiempo real');
                return;
            }
            
            console.log('🔄 Configurando suscripciones en tiempo real...');
            
            // Suscripción a cambios en agentes
            window.supabaseClient.subscribeToAgents((payload) => {
                console.log('🔄 Cambio en agentes detectado:', payload.eventType);
                
                // Recargar tabla de agentes si está visible
                if (document.getElementById('agents-section')?.style.display !== 'none') {
                    if (typeof loadAgentsTable === 'function') {
                        loadAgentsTable();
                    }
                }
                
                // Actualizar select de agentes
                if (typeof loadAgentsForNewReservation === 'function') {
                    loadAgentsForNewReservation();
                }
            });
            
            // Suscripción a cambios en reservas
            window.supabaseClient.subscribeToReservations((payload) => {
                console.log('🔄 Cambio en reservas detectado:', payload.eventType);
                
                // Recargar tabla de reservas si está visible
                if (document.getElementById('reservations-section')?.style.display !== 'none') {
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                }
                
                // También actualizar el dashboard
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            });
            
            // Suscripción a cambios en hoteles
            window.supabaseClient.subscribeToHotels((payload) => {
                console.log('🔄 Cambio en hoteles detectado:', payload.eventType);
                
                // Recargar tabla de hoteles si está visible
                if (document.getElementById('hotels-section')?.style.display !== 'none') {
                    if (typeof loadHotelsTable === 'function') {
                        loadHotelsTable();
                    }
                }
            });
            
            // Suscripción a cambios en gastos
            window.supabaseClient.subscribeToExpenses((payload) => {
                console.log('🔄 Cambio en gastos detectado:', payload.eventType);
                
                // Recargar datos de gastos si la sección está visible
                if (document.getElementById('expenses-section')?.style.display !== 'none') {
                    if (typeof loadExpensesData === 'function') {
                        loadExpensesData();
                    }
                }
            });
            
            console.log('✅ Suscripciones en tiempo real configuradas');
        }

        // Función para abrir base de datos de usuarios
        function openUserDatabase() {
            // Implementar apertura de base de datos
            console.log('Abriendo base de datos de usuarios...');
        }

        // Función para exportar usuarios
        // Función para exportar usuarios
        function exportUsers() {
            console.log('📤 Exportando usuarios...');
            
            try {
                // Cargar usuarios
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                
                if (users.length === 0) {
                    alert('❌ No hay usuarios para exportar');
                    return;
                }
                
                // Preparar datos para exportar
                const exportData = users.map(user => ({
                    nombre: user.name || '',
                    apellido: user.lastName || '',
                    email: user.email || '',
                    telefono: user.phone || '',
                    estado: user.status || 'active',
                    fecha_registro: user.createdAt || user.fechaRegistro || '',
                    tipo_cuenta: user.tipoCuenta || 'registrado'
                }));
                
                // Crear CSV
                const headers = ['nombre', 'apellido', 'email', 'telefono', 'estado', 'fecha_registro', 'tipo_cuenta'];
                let csv = headers.join(',') + '\n';
                
                exportData.forEach(user => {
                    const row = headers.map(header => {
                        const value = user[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    });
                    csv += row.join(',') + '\n';
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `usuarios_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`✅ ${users.length} usuarios exportados exitosamente`);
                
            } catch (error) {
                console.error('Error exportando usuarios:', error);
                alert('❌ Error al exportar usuarios: ' + error.message);
            }
        }

        // Función para refrescar usuarios
        function refreshUsers() {
            loadUsersData();
            alert('✅ Usuarios actualizados');
        }
        
        // Función para restaurar usuarios desde Supabase
        async function restoreUsersFromSupabase() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                alert('❌ Supabase no está inicializado');
                return;
            }
            
            try {
                console.log('🔄 Restaurando usuarios desde Supabase...');
                
                let allUsers = [];
                
                // Intentar cargar de la tabla 'users'
                try {
                    const { data: usersData, error: usersError } = await window.supabaseClient.client
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!usersError && usersData && usersData.length > 0) {
                        console.log(`☁️ Tabla 'users': ${usersData.length} registros`);
                        allUsers = [...allUsers, ...usersData];
                    }
                } catch (e) {
                    console.warn('⚠️ Error en tabla users:', e);
                }
                
                // Intentar cargar de la tabla 'system_users'
                try {
                    const { data: systemUsersData, error: systemUsersError } = await window.supabaseClient.client
                        .from('system_users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!systemUsersError && systemUsersData && systemUsersData.length > 0) {
                        console.log(`☁️ Tabla 'system_users': ${systemUsersData.length} registros`);
                        // Solo agregar usuarios que no estén ya en la lista
                        systemUsersData.forEach(sysUser => {
                            const exists = allUsers.find(u => u.email === sysUser.email);
                            if (!exists) {
                                allUsers.push(sysUser);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('⚠️ Error en tabla system_users:', e);
                }
                
                if (allUsers.length === 0) {
                    alert('⚠️ No se encontraron usuarios en Supabase.\n\nPuede que los usuarios solo estén en localStorage local.');
                    return;
                }
                
                // Convertir a formato consistente
                const normalizedUsers = allUsers.map(u => ({
                    id: u.id,
                    name: u.name || u.nombre || '',
                    email: u.email,
                    phone: u.phone || u.telefono || '',
                    status: u.is_active !== false ? 'active' : 'inactive',
                    is_active: u.is_active !== false,
                    createdAt: u.created_at || new Date().toISOString(),
                    last_activity: u.last_activity || u.updated_at,
                    tipoCuenta: u.tipo_cuenta || 'registrado',
                    birthDay: u.birth_day,
                    birthMonth: u.birth_month,
                    totalQuotes: u.total_quotes || 0
                }));
                
                // Guardar en localStorage
                localStorage.setItem('checkin24hs_users', JSON.stringify(normalizedUsers));
                
                // Actualizar variable global
                allUsersData = normalizedUsers;
                
                // Recargar tabla
                loadUsersTable(normalizedUsers.slice(0, 20));
                updateDashboardStats(normalizedUsers);
                
                alert(`✅ ${normalizedUsers.length} usuarios restaurados desde Supabase`);
                console.log('✅ Usuarios restaurados:', normalizedUsers.length);
                
            } catch (error) {
                console.error('❌ Error restaurando usuarios:', error);
                alert('❌ Error al restaurar usuarios: ' + error.message);
            }
        }
        
        // Función para mostrar modal de importar usuarios
        function showImportUsersModal() {
            console.log('📥 Abriendo modal de importar usuarios...');
            
            const modal = document.getElementById('importUsersModal');
            if (!modal) {
                alert('❌ Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('importUsersForm').reset();
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileFormat').value = 'auto';
            
            // Agregar evento para vista previa
            const fileInput = document.getElementById('usersFile');
            fileInput.removeEventListener('change', previewImportFile);
            fileInput.addEventListener('change', previewImportFile);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Función para cerrar modal de importar usuarios
        function closeImportUsersModal() {
            const modal = document.getElementById('importUsersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para previsualizar archivo antes de importar
        function previewImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const format = document.getElementById('fileFormat').value;
                
                try {
                    let preview = '';
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        const data = JSON.parse(content);
                        const previewData = Array.isArray(data) ? data.slice(0, 3) : [data];
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${JSON.stringify(previewData, null, 2)}</pre>`;
                        if ((Array.isArray(data) ? data.length : 1) > 3) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y ${(Array.isArray(data) ? data.length : 1) - 3} más</p>`;
                        }
                    } else {
                        const lines = content.split('\n').slice(0, 5);
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${lines.join('\n')}</pre>`;
                        if (content.split('\n').length > 5) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y más líneas</p>`;
                        }
                    }
                    
                    document.getElementById('previewContent').innerHTML = preview;
                    document.getElementById('importPreview').style.display = 'block';
                } catch (error) {
                    console.error('Error en vista previa:', error);
                    document.getElementById('previewContent').innerHTML = `<p style="color: #dc3545;">Error al leer el archivo: ${error.message}</p>`;
                    document.getElementById('importPreview').style.display = 'block';
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Función para importar usuarios
        function importUsers(event) {
            event.preventDefault();
            console.log('📥 Importando usuarios...');
            
            const fileInput = document.getElementById('usersFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('❌ Por favor selecciona un archivo');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedUsers = [];
                    const content = e.target.result;
                    
                    // Parsear según el formato
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        importedUsers = JSON.parse(content);
                        if (!Array.isArray(importedUsers)) {
                            importedUsers = [importedUsers];
                        }
                    } else {
                        // Parsear CSV
                        importedUsers = parseCSV(content);
                    }
                    
                    if (importedUsers.length === 0) {
                        alert('❌ El archivo no contiene usuarios válidos');
                        return;
                    }
                    
                    // Procesar e importar usuarios
                    processImportedUsers(importedUsers);
                    
                } catch (error) {
                    console.error('Error importando usuarios:', error);
                    alert('❌ Error al procesar el archivo: ' + error.message);
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Función para parsear CSV
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            // Detectar delimitador
            const delimiter = csvContent.includes(';') ? ';' : ',';
            
            // Obtener headers
            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            
            // Parsear datos
            const users = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                if (values.length === 0 || values.every(v => !v)) continue;
                
                const user = {};
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    // Mapear headers comunes
                    if (header.includes('nombre') || header.includes('name')) {
                        user.name = value;
                    } else if (header.includes('email') || header.includes('correo')) {
                        user.email = value;
                    } else if (header.includes('telefono') || header.includes('phone') || header.includes('tel')) {
                        user.phone = value;
                    } else if (header.includes('apellido') || header.includes('lastname') || header.includes('surname')) {
                        user.lastName = value;
                    } else {
                        user[header] = value;
                    }
                });
                
                if (user.name || user.email || user.phone) {
                    users.push(user);
                }
            }
            
            return users;
        }
        
        // Función para procesar usuarios importados con validación de duplicados
        function processImportedUsers(importedUsers) {
            console.log('🔄 Procesando usuarios importados:', importedUsers.length);
            
            // Cargar usuarios existentes
            const existingUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            
            let added = 0;
            let skipped = 0;
            const errors = [];
            
            importedUsers.forEach((importedUser, index) => {
                try {
                    // Validar que tenga nombre y (email o teléfono)
                    if (!importedUser.name && !importedUser.nombre) {
                        errors.push(`Fila ${index + 1}: Falta el nombre`);
                        skipped++;
                        return;
                    }
                    
                    const name = importedUser.name || importedUser.nombre || '';
                    const email = (importedUser.email || importedUser.correo || '').toLowerCase().trim();
                    const phone = (importedUser.phone || importedUser.telefono || importedUser.tel || '').trim();
                    
                    if (!email && !phone) {
                        errors.push(`Fila ${index + 1}: Falta email y teléfono`);
                        skipped++;
                        return;
                    }
                    
                    // Buscar duplicados
                    let duplicate = null;
                    
                    if (email) {
                        // Buscar por email
                        duplicate = existingUsers.find(u => u.email && u.email.toLowerCase().trim() === email);
                        if (duplicate) {
                            console.log(`⚠️ Usuario con email ${email} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    if (!email && phone) {
                        // Si no hay email, buscar por teléfono
                        const cleanPhone = phone.replace(/\D/g, '');
                        duplicate = existingUsers.find(u => {
                            if (!u.phone) return false;
                            const existingPhone = u.phone.replace(/\D/g, '');
                            return existingPhone === cleanPhone;
                        });
                        
                        if (duplicate) {
                            console.log(`⚠️ Usuario con teléfono ${phone} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    // Crear nuevo usuario
                    const newUser = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: name,
                        email: email || null,
                        phone: phone || null,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        tipoCuenta: 'importado',
                        source: 'import'
                    };
                    
                    // Agregar apellido si existe
                    if (importedUser.lastName || importedUser.apellido) {
                        newUser.lastName = importedUser.lastName || importedUser.apellido;
                        newUser.name = `${name} ${newUser.lastName}`.trim();
                    }
                    
                    existingUsers.push(newUser);
                    added++;
                    
                } catch (error) {
                    console.error(`Error procesando usuario ${index + 1}:`, error);
                    errors.push(`Fila ${index + 1}: ${error.message}`);
                    skipped++;
                }
            });
            
            // Guardar usuarios actualizados
            localStorage.setItem('checkin24hs_users', JSON.stringify(existingUsers));
            
            // Mostrar resumen
            let message = `✅ Importación completada:\n\n`;
            message += `• Agregados: ${added}\n`;
            message += `• Omitidos (duplicados): ${skipped}\n`;
            if (errors.length > 0) {
                message += `• Errores: ${errors.length}\n\n`;
                message += `Errores:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) message += `\n... y ${errors.length - 5} más`;
            }
            
            alert(message);
            
            // Cerrar modal
            closeImportUsersModal();
            
            // Actualizar tabla
            loadUsersData();
            
            console.log(`✅ Importación: ${added} agregados, ${skipped} omitidos`);
        }

        // Función para crear usuario de prueba
        function createTestUser() {
            // Implementar creación de usuario de prueba
            console.log('Creando usuario de prueba...');
        }

        // Función para crear usuarios de prueba
        function crearUsuariosPrueba() {
            // Implementar creación de usuarios de prueba
            console.log('Creando usuarios de prueba...');
        }

        // Función para mostrar promociones de hoteles
        function showHotelPromotions() {
            console.log('🏨 Mostrando promociones de hoteles...');
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            if (hotels.length === 0) {
                alert('No hay hoteles registrados. Primero agregue al menos un hotel.');
                return;
            }
            
            // Mostrar modal de promociones
            showHotelPromotionsModal(hotels);
        }
        
        // Función para cambiar entre pestañas de Hoteles
        function showHotelsTab(tab) {
            console.log('🔄 Cambiando a pestaña:', tab);
            
            // Ocultar todos los contenidos de pestañas
            const hotelsContent = document.getElementById('hotels-tab-content');
            const promotionsContent = document.getElementById('promotions-tab-content');
            
            // Ocultar todos los botones activos
            const hotelsBtn = document.getElementById('hotels-tab-btn');
            const promotionsBtn = document.getElementById('promotions-tab-btn');
            
            if (tab === 'hotels') {
                if (hotelsContent) hotelsContent.style.display = 'block';
                if (promotionsContent) promotionsContent.style.display = 'none';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#1976d2';
                    hotelsBtn.style.color = 'white';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#f0f0f0';
                    promotionsBtn.style.color = '#333';
                }
            } else if (tab === 'promotions') {
                if (hotelsContent) hotelsContent.style.display = 'none';
                if (promotionsContent) promotionsContent.style.display = 'block';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#f0f0f0';
                    hotelsBtn.style.color = '#333';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#1976d2';
                    promotionsBtn.style.color = 'white';
                }
                
                // Cargar contenido de promociones
                loadHotelPromotionsContent();
            }
        }
        
        // Función para cargar el contenido de promociones dentro de la sección
        function loadHotelPromotionsContent() {
            const contentDiv = document.getElementById('hotel-promotions-content');
            if (!contentDiv) return;
            
            // Cargar datos de hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Generar el contenido de promociones (similar al modal pero sin el modal)
            contentDiv.innerHTML = `
                    <!-- Pestañas de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                    <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">🔥 Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">➕ Crear Promoción</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📈 Analytics</button>
                    </div>
                    
                    <!-- Contenido de pestañas -->
                    <div id="promotion-content">
                    <!-- Pestaña de Promociones Activas -->
                    <div id="active-tab" class="promotion-tab-content" style="display: block;">
                        <h3 style="margin-bottom: 16px; color: #333;">🔥 Promociones Activas</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${hotels.map(hotel => `
                                <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                        <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                    </div>
                                    <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                        <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ⭐</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">✏️ Editar</button>
                                        <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">👁️ Ver</button>
                                        <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">⏸️ Pausar</button>
                                    </div>
                                </div>
                            `).join('')}
                                </div>
                            </div>
                            
                    <!-- Pestaña de Crear Promoción -->
                    <div id="create-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">➕ Crear Nueva Promoción</h3>
                        
                        <form id="createPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                    <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Seleccionar hotel</option>
                                        ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                    </select>
                                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                    <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                    </select>
                                                </div>
                                                </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                    </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Estado</label>
                                    <select id="promotionStatus" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="active">Activa</option>
                                        <option value="paused">Pausada</option>
                                    </select>
                                        </div>
                                        </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción</label>
                                <textarea id="promotionDescription" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="showHotelsTab('hotels')" style="background: #f0f0f0; color: #333; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoción</button>
                                        </div>
                        </form>
                                        </div>
                                        
                    <!-- Pestaña de Historial -->
                    <div id="history-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">📊 Historial de Promociones</h3>
                        <p style="color: #666;">No hay historial de promociones disponibles.</p>
                                        </div>
                                        
                    <!-- Pestaña de Analytics -->
                    <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">📈 Analytics de Promociones</h3>
                        <p style="color: #666;">No hay datos de analytics disponibles.</p>
                                        </div>
                </div>
            `;
            
            // Agregar event listener al formulario
            const form = document.getElementById('createPromotionForm');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    savePromotion();
                };
            }
        }
        
        // Función para mostrar modal de promociones de hoteles
        function showHotelPromotionsModal(hotels) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">🏨 Promociones de Hoteles</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                            </div>
                            
                    <!-- Pestañas de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">🔥 Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">➕ Crear Promoción</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📈 Analytics</button>
                        </div>
                        
                    <!-- Contenido de pestañas -->
                    <div id="promotion-content">
                        <!-- Pestaña de Promociones Activas -->
                        <div id="active-tab" class="promotion-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">🔥 Promociones Activas</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                                ${hotels.map(hotel => `
                                    <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                            <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                        </div>
                                        <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                            <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ⭐</span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">✏️ Editar</button>
                                            <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">👁️ Ver</button>
                                            <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">⏸️ Pausar</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Pestaña de Crear Promoción -->
                        <div id="create-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">➕ Crear Nueva Promoción</h3>
                            
                            <form id="createPromotionForm" style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                        <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Seleccionar hotel</option>
                                            ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoción</label>
                                        <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="discount">Descuento</option>
                                            <option value="package">Paquete</option>
                                            <option value="early-bird">Early Bird</option>
                                            <option value="last-minute">Last Minute</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                        <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Precio Promocional</label>
                                        <input type="text" id="promotionPrice" placeholder="Ej: $150 USD" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción de la Promoción</label>
                                    <textarea id="promotionDescription" rows="4" placeholder="Describe los beneficios de esta promoción..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Inicio</label>
                                        <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Fin</label>
                                        <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                    <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoción</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Pestaña de Historial -->
                        <div id="history-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📊 Historial de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">📊</span>
                                <p style="margin: 16px 0 0 0; color: #666;">El historial de promociones estará disponible próximamente</p>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Analytics -->
                        <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📈 Analytics de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">📈</span>
                                <p style="margin: 16px 0 0 0; color: #666;">Los analytics de promociones estará disponible próximamente</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners para pestañas
            const tabs = modal.querySelectorAll('.promotion-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todas las pestañas
                    tabs.forEach(t => t.classList.remove('active'));
                    t.style.background = '#f0f0f0';
                    t.style.color = '#333';
                    
                    // Agregar clase active a la pestaña clickeada
                    this.classList.add('active');
                    this.style.background = '#ff9800';
                    this.style.color = 'white';
                    
                    // Mostrar contenido correspondiente
                    const tabName = this.getAttribute('data-tab');
                    showPromotionTab(tabName);
                });
            });
            
            // Event listener para el formulario
            const form = modal.querySelector('#createPromotionForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createHotelPromotion();
                });
            }
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Función para mostrar herramientas de marketing
        function showMarketingTools() {
            console.log('📢 Mostrando herramientas de marketing...');
            
            // Cargar datos de usuarios
            const users = loadUsersData();
            
            // Crear y mostrar modal de herramientas de marketing
            showMarketingModal(users);
        }
        
        // Función para mostrar modal de herramientas de marketing
        function showMarketingModal(users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">📢 Herramientas de Marketing</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Pestañas de herramientas -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showMarketingTab('segments')" class="marketing-tab active" data-tab="segments" style="padding: 12px 20px; border: none; background: #4caf50; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">👥 Segmentación</button>
                        <button onclick="showMarketingTab('campaigns')" class="marketing-tab" data-tab="campaigns" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📧 Campañas</button>
                        <button onclick="showMarketingTab('templates')" class="marketing-tab" data-tab="templates" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📝 Plantillas</button>
                        <button onclick="showMarketingTab('analytics')" class="marketing-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">📊 Analytics</button>
                    </div>
                    
                    <!-- Contenido de pestañas -->
                    <div id="marketing-content">
                        <!-- Pestaña de Segmentación -->
                        <div id="segments-tab" class="marketing-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">👥 Segmentación de Usuarios</h3>
                            
                            <!-- Segmentos predefinidos -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">✅ Usuarios Activos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han tenido actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'active' || u.status === 'Activo').length} usuarios</span>
                                        <button onclick="exportSegment('active')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">📊 Con Cotizaciones</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han solicitado cotizaciones</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length} usuarios</span>
                                        <button onclick="exportSegment('withQuotes')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">🆕 Nuevos este Mes</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios registrados en el mes actual</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => {
                                            const userDate = new Date(u.createdAt);
                                            const currentDate = new Date();
                                            return userDate.getMonth() === currentDate.getMonth() && 
                                                   userDate.getFullYear() === currentDate.getFullYear();
                                        }).length} usuarios</span>
                                        <button onclick="exportSegment('newThisMonth')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">❌ Inactivos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios sin actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'inactive' || u.status === 'Inactivo').length} usuarios</span>
                                        <button onclick="exportSegment('inactive')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Segmento personalizado -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">🔧 Crear Segmento Personalizado</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Criterio:</label>
                                        <select id="customSegmentCriteria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="status">Estado</option>
                                            <option value="cotizaciones">Cotizaciones</option>
                                            <option value="fechaRegistro">Fecha de Registro</option>
                                            <option value="tipoCuenta">Tipo de Cuenta</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Valor:</label>
                                        <input type="text" id="customSegmentValue" placeholder="Ej: Activo, >0, etc." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div style="display: flex; align-items: end;">
                                        <button onclick="createCustomSegment()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Crear Segmento</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Campañas -->
                        <div id="campaigns-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📧 Gestión de Campañas</h3>
                            
                            <!-- Crear nueva campaña -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">🆕 Nueva Campaña</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre de la Campaña:</label>
                                        <input type="text" id="campaignName" placeholder="Ej: Promoción Verano 2025" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Segmento Objetivo:</label>
                                        <select id="campaignSegment" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="all">Todos los usuarios</option>
                                            <option value="active">Usuarios activos</option>
                                            <option value="withQuotes">Con cotizaciones</option>
                                            <option value="newThisMonth">Nuevos este mes</option>
                                            <option value="inactive">Inactivos</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tipo de Campaña:</label>
                                        <select id="campaignType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="email">Email Marketing</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="sms">SMS</option>
                                            <option value="push">Push Notification</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Mensaje:</label>
                                    <textarea id="campaignMessage" placeholder="Escribe tu mensaje aquí..." rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                <button onclick="createCampaign()" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">🚀 Crear Campaña</button>
                            </div>
                            
                            <!-- Campañas existentes -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: #333;">📋 Campañas Existentes</h4>
                                <div id="campaignsList" style="display: grid; gap: 12px;">
                                    <!-- Las campañas se cargarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Plantillas -->
                        <div id="templates-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📝 Plantillas de Mensajes</h3>
                            
                            <!-- Plantillas predefinidas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">🎉 Bienvenida</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Bienvenido a Checkin24hs! Descubre nuestras mejores ofertas de hoteles.</p>
                                    <button onclick="useTemplate('welcome')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">🔥 Oferta Especial</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Oferta especial por tiempo limitado! Descuentos exclusivos en hoteles premium.</p>
                                    <button onclick="useTemplate('specialOffer')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">📅 Recordatorio</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">No olvides revisar nuestras nuevas ofertas. ¡Tu próxima aventura te espera!</p>
                                    <button onclick="useTemplate('reminder')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">🎯 Reactivación</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¡Te extrañamos! Vuelve a descubrir las mejores ofertas en Checkin24hs.</p>
                                    <button onclick="useTemplate('reactivation')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Analytics -->
                        <div id="analytics-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">📊 Analytics de Marketing</h3>
                            
                            <!-- Métricas de engagement -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #2e7d32; font-size: 24px;">${users.length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Audiencia Total</p>
                                </div>
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #f57c00; font-size: 24px;">${Math.round((users.filter(u => u.status === 'active' || u.status === 'Activo').length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Engagement</p>
                                </div>
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #1976d2; font-size: 24px;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Conversiones</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((users.filter(u => u.cotizaciones && u.cotizaciones > 0).length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Conversión</p>
                                </div>
                            </div>
                            
                            <!-- Gráfico de engagement por mes -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">📈 Engagement por Mes</h4>
                                <div style="height: 200px; display: flex; align-items: end; gap: 8px; padding: 16px;">
                                    ${generateEngagementChart(users)}
                                </div>
                            </div>
                            
                            <!-- Recomendaciones -->
                            <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #f57c00;">💡 Recomendaciones de Marketing</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li style="margin-bottom: 8px;">Enfócate en reactivar usuarios inactivos con ofertas especiales</li>
                                    <li style="margin-bottom: 8px;">Crea campañas personalizadas para usuarios con cotizaciones</li>
                                    <li style="margin-bottom: 8px;">Implementa un programa de fidelización para usuarios activos</li>
                                    <li style="margin-bottom: 8px;">Optimiza el timing de las campañas basado en el engagement</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Función para cambiar pestañas de marketing
        function showMarketingTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.marketing-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.marketing-tab').forEach(btn => {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Activar botón seleccionado
            event.target.style.background = '#4caf50';
            event.target.style.color = 'white';
        }
        
        // Función para exportar segmentos
        function exportSegment(segmentType) {
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(segmentType) {
                case 'active':
                    segmentUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    segmentUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    segmentUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Estado,Fecha Registro\n' +
                segmentUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `segmento_${segmentType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Segmento "${segmentType}" exportado correctamente (${segmentUsers.length} usuarios)`);
        }
        
        // Función para crear segmento personalizado
        function createCustomSegment() {
            const criteria = document.getElementById('customSegmentCriteria').value;
            const value = document.getElementById('customSegmentValue').value;
            
            if (!value) {
                alert('❌ Por favor ingresa un valor para el segmento');
                return;
            }
            
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(criteria) {
                case 'status':
                    segmentUsers = users.filter(u => u.status === value);
                    break;
                case 'cotizaciones':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > parseInt(value));
                    break;
                case 'tipoCuenta':
                    segmentUsers = users.filter(u => u.tipoCuenta === value);
                    break;
            }
            
            if (segmentUsers.length === 0) {
                alert('❌ No se encontraron usuarios con los criterios especificados');
                return;
            }
            
            alert(`✅ Segmento personalizado creado: ${segmentUsers.length} usuarios encontrados`);
            exportSegment('custom');
        }
        
        // Función para crear campaña
        function createCampaign() {
            const name = document.getElementById('campaignName').value;
            const segment = document.getElementById('campaignSegment').value;
            const type = document.getElementById('campaignType').value;
            const message = document.getElementById('campaignMessage').value;
            
            if (!name || !message) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            const campaign = {
                id: 'camp-' + Date.now(),
                name: name,
                segment: segment,
                type: type,
                message: message,
                createdAt: new Date().toISOString(),
                status: 'draft'
            };
            
            // Guardar campaña en localStorage
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            campaigns.push(campaign);
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert('✅ Campaña creada correctamente');
            
            // Limpiar formulario
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignMessage').value = '';
            
            // Actualizar lista de campañas
            loadCampaigns();
        }
        
        // Función para cargar campañas
        function loadCampaigns() {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaignsList = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                campaignsList.innerHTML = '<p style="color: #666; text-align: center;">No hay campañas creadas</p>';
                return;
            }
            
            campaignsList.innerHTML = campaigns.map(campaign => `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: #333;">${campaign.name}</h5>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${campaign.message.substring(0, 100)}${campaign.message.length > 100 ? '...' : ''}</p>
                            <div style="display: flex; gap: 12px; font-size: 12px; color: #666;">
                                <span>Segmento: ${campaign.segment}</span>
                                <span>Tipo: ${campaign.type}</span>
                                <span>Estado: ${campaign.status}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="sendCampaign('${campaign.id}')" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Enviar</button>
                            <button onclick="deleteCampaign('${campaign.id}')" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Función para usar plantilla
        function useTemplate(templateType) {
            const templates = {
                welcome: '¡Bienvenido a Checkin24hs! 🏨 Descubre nuestras mejores ofertas de hoteles y disfruta de descuentos exclusivos. ¡Tu próxima aventura te espera!',
                specialOffer: '🔥 ¡OFERTA ESPECIAL POR TIEMPO LIMITADO! 🔥 Descuentos exclusivos en hoteles premium. ¡No te pierdas esta oportunidad única!',
                reminder: '📅 ¿Ya planificaste tu próxima escapada? No olvides revisar nuestras nuevas ofertas. ¡Tu próxima aventura te espera en Checkin24hs!',
                reactivation: '👋 ¡Te extrañamos! Vuelve a descubrir las mejores ofertas en Checkin24hs. Tenemos descuentos especiales esperándote.'
            };
            
            const message = templates[templateType];
            if (message) {
                // Cambiar a la pestaña de campañas
                showMarketingTab('campaigns');
                
                // Llenar el formulario con la plantilla
                setTimeout(() => {
                    document.getElementById('campaignMessage').value = message;
                }, 100);
            }
        }
        
        // Función para generar gráfico de engagement
        function generateEngagementChart(users) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
            const engagement = months.map((month, index) => {
                const monthUsers = users.filter(user => {
                    const userDate = new Date(user.createdAt);
                    return userDate.getMonth() === index;
                });
                return monthUsers.length;
            });
            
            const maxEngagement = Math.max(...engagement);
            
            return engagement.map((value, index) => `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="width: 100%; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div style="height: ${(value / maxEngagement) * 150}px; background: #2196f3; transition: height 0.3s;"></div>
                    </div>
                    <span style="font-size: 12px; color: #666;">${months[index]}</span>
                    <span style="font-size: 10px; color: #999;">${value}</span>
                </div>
            `).join('');
        }
        
        // Función para enviar campaña
        function sendCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (!campaign) {
                alert('❌ Campaña no encontrada');
                return;
            }
            
            // Simular envío de campaña
            const users = loadUsersData();
            let targetUsers = [];
            
            switch(campaign.segment) {
                case 'all':
                    targetUsers = users;
                    break;
                case 'active':
                    targetUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    targetUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    targetUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    targetUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            // Actualizar estado de la campaña
            campaign.status = 'sent';
            campaign.sentAt = new Date().toISOString();
            campaign.recipients = targetUsers.length;
            
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert(`✅ Campaña "${campaign.name}" enviada a ${targetUsers.length} usuarios`);
            
            // Actualizar lista de campañas
            loadCampaigns();
        }
        
        // Función para eliminar campaña
        function deleteCampaign(campaignId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar esta campaña?')) {
                const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
                const updatedCampaigns = campaigns.filter(c => c.id !== campaignId);
                localStorage.setItem('marketing_campaigns', JSON.stringify(updatedCampaigns));
                
                alert('✅ Campaña eliminada correctamente');
                loadCampaigns();
            }
        }

        // Función para mostrar analytics de usuarios
        function showUserAnalytics() {
            console.log('📊 Mostrando analytics de usuarios...');
            
            // Cargar datos de usuarios
            const users = loadUsersData();
            
            // Calcular estadísticas
            const stats = calculateUserStats(users);
            
            // Crear y mostrar modal de analytics
            showAnalyticsModal(stats, users);
        }
        
        // Función para calcular estadísticas de usuarios
        function calculateUserStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo').length;
            const inactiveUsers = users.filter(user => user.status === 'inactive' || user.status === 'Inactivo').length;
            
            // Usuarios por mes (últimos 6 meses)
            const monthlyStats = {};
            const currentDate = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                monthlyStats[monthKey] = 0;
            }
            
            users.forEach(user => {
                const userDate = new Date(user.createdAt);
                const monthKey = userDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                if (monthlyStats[monthKey] !== undefined) {
                    monthlyStats[monthKey]++;
                }
            });
            
            // Usuarios por tipo de cuenta
            const accountTypes = {};
            users.forEach(user => {
                const type = user.tipoCuenta || 'registrado';
                accountTypes[type] = (accountTypes[type] || 0) + 1;
            });
            
            // Usuarios con cotizaciones
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0).length;
            
            return {
                totalUsers,
                activeUsers,
                inactiveUsers,
                monthlyStats,
                accountTypes,
                usersWithQuotes,
                usersWithoutQuotes: totalUsers - usersWithQuotes
            };
        }
        
        // Función para mostrar modal de analytics
        function showAnalyticsModal(stats, users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">📊 Análisis de Usuarios</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Estadísticas principales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #1976d2; font-size: 24px;">${stats.totalUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Total Usuarios</p>
                        </div>
                        <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #2e7d32; font-size: 24px;">${stats.activeUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Usuarios Activos</p>
                        </div>
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #f57c00; font-size: 24px;">${stats.usersWithQuotes}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Con Cotizaciones</p>
                        </div>
                        <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Tasa de Actividad</p>
                        </div>
                    </div>
                    
                    <!-- Gráfico de usuarios por mes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">📈 Registros por Mes</h3>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            ${Object.entries(stats.monthlyStats).map(([month, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500;">${month}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 200px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${(count / Math.max(...Object.values(stats.monthlyStats))) * 100}%; height: 100%; background: #2196f3;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 30px; text-align: right;">${count}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Tipos de cuenta -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">👥 Distribución por Tipo de Cuenta</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${Object.entries(stats.accountTypes).map(([type, count]) => `
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                                    <h4 style="margin: 0; color: #333; font-size: 18px;">${count}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">${type}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Acciones rápidas -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">⚡ Acciones Rápidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button onclick="exportActiveUsers()" style="background: #4caf50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📧 Exportar Usuarios Activos
                            </button>
                            <button onclick="exportUsersWithQuotes()" style="background: #ff9800; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📊 Exportar Con Cotizaciones
                            </button>
                            <button onclick="generateUserReport()" style="background: #2196f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                📋 Generar Reporte Completo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabla de usuarios recientes -->
                    <div>
                        <h3 style="margin-bottom: 16px; color: #333;">🆕 Usuarios Recientes</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Usuario</th>
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Email</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Estado</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.slice(0, 5).map(user => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-size: 14px;">${user.name}</td>
                                            <td style="padding: 8px; font-size: 14px;">${user.email}</td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">
                                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; ${user.status === 'active' || user.status === 'Activo' ? 'background: #e8f5e8; color: #2e7d32;' : 'background: #ffebee; color: #c62828;'}">
                                                    ${user.status === 'active' || user.status === 'Activo' ? 'Activo' : 'Inactivo'}
                                                </span>
                                            </td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">${new Date(user.createdAt).toLocaleDateString('es-ES')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funciones auxiliares para las acciones rápidas
        function exportActiveUsers() {
            const users = loadUsersData();
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo');
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Estado,Fecha Registro\n' +
                activeUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_activos.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Usuarios activos exportados correctamente');
        }
        
        function exportUsersWithQuotes() {
            const users = loadUsersData();
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0);
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Teléfono,Cotizaciones,Estado\n' +
                usersWithQuotes.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.cotizaciones || 0}","${user.status}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_con_cotizaciones.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Usuarios con cotizaciones exportados correctamente');
        }
        
        function generateUserReport() {
            const users = loadUsersData();
            const stats = calculateUserStats(users);
            
            const report = `
REPORTE DE USUARIOS - CHECKIN24HS
Fecha: ${new Date().toLocaleDateString('es-ES')}

ESTADÍSTICAS GENERALES:
- Total de usuarios: ${stats.totalUsers}
- Usuarios activos: ${stats.activeUsers}
- Usuarios inactivos: ${stats.inactiveUsers}
- Tasa de actividad: ${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%
- Usuarios con cotizaciones: ${stats.usersWithQuotes}
- Usuarios sin cotizaciones: ${stats.usersWithoutQuotes}

DISTRIBUCIÓN POR TIPO DE CUENTA:
${Object.entries(stats.accountTypes).map(([type, count]) => `- ${type}: ${count}`).join('\n')}

REGISTROS POR MES:
${Object.entries(stats.monthlyStats).map(([month, count]) => `- ${month}: ${count} usuarios`).join('\n')}

USUARIOS RECIENTES (últimos 10):
${users.slice(0, 10).map(user => `- ${user.name} (${user.email}) - ${new Date(user.createdAt).toLocaleDateString('es-ES')}`).join('\n')}
            `;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_usuarios_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            alert('✅ Reporte completo generado correctamente');
        }

        // Función para exportar emails para campaña
        function exportEmailsForCampaign() {
            // Implementar exportación de emails
            console.log('Exportando emails para campaña...');
        }

        // Función para exportar teléfonos para WhatsApp
        function exportPhonesForWhatsApp() {
            // Implementar exportación de teléfonos
            console.log('Exportando teléfonos para WhatsApp...');
        }

        // Función para generar reporte de usuarios activos
        function generateActiveUsersReport() {
            // Implementar reporte
            console.log('Generando reporte de usuarios activos...');
        }

        // Función para crear segmento de usuarios de cotizaciones
        function createQuoteUsersSegment() {
            // Implementar segmento
            console.log('Creando segmento de usuarios de cotizaciones...');
        }

        // Función para cargar datos de usuarios
        async function loadUsersData() {
            try {
                // Primero, sincronizar usuarios desde reservas
                syncUsersFromReservations();
                
                let allUsers = [];
                
                // 1. Intentar cargar desde Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const supabaseUsers = await window.supabaseClient.getUsers();
                        if (supabaseUsers && supabaseUsers.length > 0) {
                            console.log(`☁️ ${supabaseUsers.length} usuarios cargados desde Supabase`);
                            allUsers = supabaseUsers.map(u => ({
                                id: u.id,
                                name: u.name || u.nombre || '',
                                email: u.email,
                                phone: u.phone || u.telefono || '',
                                status: u.status || u.is_active ? 'active' : 'inactive',
                                is_active: u.is_active !== false,
                                createdAt: u.created_at || u.createdAt || new Date().toISOString(),
                                last_activity: u.last_activity || u.updated_at,
                                tipoCuenta: u.tipo_cuenta || u.tipoCuenta || 'registrado',
                                birthDay: u.birth_day || u.birthDay,
                                birthMonth: u.birth_month || u.birthMonth,
                                totalQuotes: u.total_quotes || u.totalQuotes || 0
                            }));
                            
                            // Guardar también en localStorage como backup
                            localStorage.setItem('checkin24hs_users', JSON.stringify(allUsers));
                        }
                    } catch (supabaseError) {
                        console.warn('⚠️ Error cargando de Supabase, usando localStorage:', supabaseError);
                    }
                }
                
                // 2. Si no hay usuarios de Supabase, cargar de localStorage
                if (allUsers.length === 0) {
                    // Cargar usuarios desde checkin24hs_users (dashboard)
                    const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Cargar usuarios desde clientesDB (index.html)
                    const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                    
                    console.log('🔍 Datos encontrados en localStorage:', {
                        checkin24hs_users: dashboardUsers.length,
                        clientesDB: mobileUsers.length
                    });
                    
                    // Combinar usuarios únicos
                    allUsers = [...dashboardUsers];
                    
                    // Agregar usuarios móviles que no estén en dashboard
                    mobileUsers.forEach(mobileUser => {
                        const exists = allUsers.find(user => user.email === mobileUser.email);
                        if (!exists) {
                            // Convertir formato de usuario móvil a formato dashboard
                            const convertedUser = {
                                id: mobileUser.id,
                                name: mobileUser.name,
                                email: mobileUser.email,
                                phone: mobileUser.phone,
                                status: mobileUser.status || 'active',
                                createdAt: mobileUser.fechaRegistro || new Date().toISOString(),
                                tipoCuenta: mobileUser.tipoCuenta || 'registrado',
                                birthDay: mobileUser.birthDay,
                                birthMonth: mobileUser.birthMonth
                            };
                            allUsers.push(convertedUser);
                        }
                    });
                }
                
                console.log(`📊 Total usuarios cargados: ${allUsers.length}`);
                
                // Guardar todos los usuarios en variable global
                allUsersData = allUsers;
                
                // Actualizar tabla de usuarios (solo primeros 20)
                loadUsersTable(allUsers.slice(0, 20));
                
                // Actualizar estadísticas
                updateDashboardStats(allUsers);
                
                return allUsers;
            } catch (error) {
                console.error('❌ Error al cargar usuarios:', error);
                return [];
            }
        }

        // Función para sincronizar usuarios desde reservas (versión silenciosa)
        function syncUsersFromReservations() {
            try {
                // Obtener todas las reservas
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                if (reservations.length === 0) {
                    return;
                }
                
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const existingEmails = new Set(users.map(user => 
                    user.email ? user.email.toLowerCase() : ''
                ));
                
                let newUsersCount = 0;
                const processedEmails = new Set();
                
                // Procesar cada reserva
                reservations.forEach(reservation => {
                    if (!reservation.clientEmail) {
                        return;
                    }
                    
                    const email = reservation.clientEmail.toLowerCase();
                    
                    // Si ya procesamos este email, saltar
                    if (processedEmails.has(email)) {
                        return;
                    }
                    
                    processedEmails.add(email);
                    
                    if (!existingEmails.has(email)) {
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
                        }
                        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: reservation.clientName || '',
                            email: reservation.clientEmail,
                            phone: reservation.clientPhone || '',
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            last_activity: reservation.updatedAt || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(email);
                        newUsersCount++;
                        console.log('✅ Usuario sincronizado desde reserva:', newUser.email);
                    }
                });
                
                // Guardar usuarios actualizados si hay nuevos
                if (newUsersCount > 0) {
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log(`🔄 Sincronización automática: ${newUsersCount} nuevos usuarios agregados desde reservas`);
                }
                
            } catch (error) {
                console.error('❌ Error al sincronizar usuarios desde reservas:', error);
            }
        }

        // Función para actualizar estadísticas del dashboard
        function updateDashboardStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const newUsersThisMonth = users.filter(user => {
                const userDate = new Date(user.createdAt);
                const currentDate = new Date();
                return userDate.getMonth() === currentDate.getMonth() && 
                       userDate.getFullYear() === currentDate.getFullYear();
            }).length;
            
            // Actualizar contadores en el dashboard
            const totalUsersElement = document.querySelector('#totalUsers');
            const activeUsersElement = document.querySelector('#activeUsers');
            const newUsersElement = document.querySelector('#newUsers');
            
            if (totalUsersElement) totalUsersElement.textContent = totalUsers;
            if (activeUsersElement) activeUsersElement.textContent = activeUsers;
            if (newUsersElement) newUsersElement.textContent = newUsersThisMonth;
            
            console.log('📊 Estadísticas actualizadas:', {
                total: totalUsers,
                active: activeUsers,
                newThisMonth: newUsersThisMonth
            });
        }

        // Función para sincronizar con index.html
        function syncWithIndexHTML() {
            console.log('🔄 Sincronizando datos de usuarios...');
            
            // Cargar datos actualizados
            const users = loadUsersData();
            
            // Guardar todos los usuarios en variable global
            allUsersData = users;
            
            // Actualizar interfaz
            updateDashboardStats(users);
            loadUsersTable(users.slice(0, 20));
            
            console.log('✅ Sincronización completada');
        }
        
        // Función para iniciar sincronización automática
        function startAutoSync() {
            // Sincronizar cada 30 segundos
            setInterval(() => {
                syncWithIndexHTML();
            }, 30000);
            
            console.log('🔄 Sincronización automática iniciada (cada 30 segundos)');
        }

        // Variable global para almacenar todos los usuarios
        let allUsersData = [];
        
        // Función para buscar usuarios
        function searchUsers() {
            const searchInput = document.getElementById('usersSearchInput');
            const searchInfo = document.getElementById('usersSearchInfo');
            const searchCount = document.getElementById('usersSearchCount');
            
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm === '') {
                // Si no hay búsqueda, mostrar los primeros 20
                loadUsersTable(allUsersData.slice(0, 20));
                if (searchInfo) searchInfo.style.display = 'none';
                return;
            }
            
            // Filtrar usuarios por término de búsqueda
            const filteredUsers = allUsersData.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                const phone = (user.phone || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       phone.includes(searchTerm);
            });
            
            // Mostrar resultados
            loadUsersTable(filteredUsers);
            
            // Mostrar información de búsqueda
            if (searchInfo && searchCount) {
                searchInfo.style.display = 'block';
                searchCount.textContent = filteredUsers.length;
            }
            
            console.log(`🔍 Búsqueda: "${searchTerm}" - ${filteredUsers.length} resultados`);
        }
        
        // Función para cargar tabla de usuarios
        function loadUsersTable(users) {
            console.log('🔄 Cargando tabla de usuarios con:', users.length, 'usuarios');
            
            const tableBody = document.querySelector('#usersTableBody');
            if (!tableBody) {
                console.error('❌ No se encontró la tabla de usuarios');
                return;
            }
            
            console.log('✅ Tabla encontrada, limpiando contenido...');
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                console.log('📝 No hay usuarios, mostrando mensaje vacío');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-users"></i> No hay usuarios registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agregar usuarios a la tabla
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const userType = user.tipoCuenta || 'registrado';
                const userSource = user.fechaRegistro ? 'Móvil' : (user.tipoCuenta === 'cliente_reserva' ? 'Reserva' : 'Dashboard');
                const cotizaciones = user.cotizaciones ? user.cotizaciones.length : 0;
                const ultimaActividad = user.last_activity || user.ultimaActividad || user.updatedAt || user.createdAt || user.created_at;
                
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <div class="user-info">
                            <div class="user-name">${user.name || 'Sin nombre'}</div>
                            <div class="user-type">${userType} - ${userSource}</div>
                        </div>
                    </td>
                    <td style="padding: 12px;">${user.email || 'Sin email'}</td>
                    <td style="padding: 12px; text-align: center;">${user.phone || 'Sin teléfono'}</td>
                    <td style="padding: 12px; text-align: center;">${cotizaciones}</td>
                    <td style="padding: 12px; text-align: center;">${formatDate(ultimaActividad)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span class="status-badge ${user.status === 'active' || user.status === 'activo' ? 'active' : 'inactive'}">
                            ${user.status === 'active' || user.status === 'activo' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="action-btn marketing" onclick="showMarketingTools('${user.id}')" title="Marketing">
                            <i class="fas fa-bullhorn"></i>
                        </button>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editUser('${user.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteUser('${user.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log('✅ Tabla de usuarios actualizada:', users.length, 'usuarios');
            console.log('📋 Filas agregadas a la tabla');
            
            // Mostrar información si hay más usuarios disponibles (solo si no hay búsqueda activa)
            const searchInput = document.getElementById('usersSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allUsersData.length > users.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'users-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando ${users.length} de ${allUsersData.length} usuarios. Usa el buscador para encontrar más usuarios.`;
                
                const tableContainer = tableBody.closest('.activity-card');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay búsqueda activa
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Función para editar usuario
        async function editUser(userId) {
            console.log('✏️ Editando usuario:', userId);
            
            // Primero buscar en allUsersData (datos que se muestran en la tabla)
            let user = null;
            if (typeof allUsersData !== 'undefined' && allUsersData.length > 0) {
                user = allUsersData.find(u => u.id === userId || u.id == userId);
            }
            
            // Si no se encuentra, buscar en Supabase
            if (!user && window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const users = await window.supabaseClient.getUsers();
                    user = users.find(u => u.id === userId || u.id == userId);
                } catch (error) {
                    console.error('Error cargando usuario de Supabase:', error);
                }
            }
            
            // Fallback a localStorage (checkin24hs_users y clientesDB)
            if (!user) {
                const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const clientesUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                const allLocalUsers = [...dashboardUsers, ...clientesUsers];
                user = allLocalUsers.find(u => u.id === userId || u.id == userId);
            }
            
            if (!user) {
                alert('❌ Usuario no encontrado');
                return;
            }
            
            // Obtener valores soportando ambos formatos
            const userName = user.name || user.nombre || '';
            const userEmail = user.email || '';
            const userPhone = user.phone || user.telefono || '';
            const userStatus = user.status || user.estado || 'Activo';
            const userType = user.type || user.tipo || 'cliente_reserva';
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editUserModalDynamic';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 500px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">✏️ Editar Usuario</h2>
                        <button onclick="document.getElementById('editUserModalDynamic').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <form id="editUserForm" onsubmit="saveUserChanges(event, '${userId}')">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre *</label>
                            <input type="text" id="editUserName" value="${userName}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email *</label>
                            <input type="email" id="editUserEmail" value="${userEmail}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Teléfono</label>
                            <input type="tel" id="editUserPhone" value="${userPhone}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tipo de Usuario</label>
                            <select id="editUserType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="cliente_reserva" ${userType === 'cliente_reserva' ? 'selected' : ''}>Cliente - Reserva</option>
                                <option value="cliente_cotizacion" ${userType === 'cliente_cotizacion' ? 'selected' : ''}>Cliente - Cotización</option>
                                <option value="agente" ${userType === 'agente' ? 'selected' : ''}>Agente</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado</label>
                            <select id="editUserStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Activo" ${userStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                <option value="Inactivo" ${userStatus === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="document.getElementById('editUserModalDynamic').remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            <button type="submit" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }
        
        async function saveUserChanges(event, userId) {
            event.preventDefault();
            
            const updates = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                phone: document.getElementById('editUserPhone').value,
                type: document.getElementById('editUserType').value,
                status: document.getElementById('editUserStatus').value,
                updated_at: new Date().toISOString()
            };
            
            console.log('💾 Guardando cambios del usuario:', userId, updates);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateUser(userId, updates);
                    console.log('✅ Usuario actualizado en Supabase');
                    alert('✅ Usuario actualizado correctamente');
                    document.getElementById('editUserModalDynamic').remove();
                    loadUsersTable();
                    return;
                }
            } catch (error) {
                console.error('Error actualizando usuario:', error);
            }
            
            // Fallback localStorage - buscar en ambos storages
            let updated = false;
            
            // Intentar en checkin24hs_users
            const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            const dashIndex = dashboardUsers.findIndex(u => u.id === userId || u.id == userId);
            if (dashIndex !== -1) {
                dashboardUsers[dashIndex] = { ...dashboardUsers[dashIndex], ...updates };
                localStorage.setItem('checkin24hs_users', JSON.stringify(dashboardUsers));
                updated = true;
            }
            
            // Intentar también en clientesDB
            const clientesUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
            const clientIndex = clientesUsers.findIndex(u => u.id === userId || u.id == userId);
            if (clientIndex !== -1) {
                clientesUsers[clientIndex] = { ...clientesUsers[clientIndex], ...updates };
                localStorage.setItem('clientesDB', JSON.stringify(clientesUsers));
                updated = true;
            }
            
            if (updated) {
                alert('✅ Usuario actualizado correctamente');
                document.getElementById('editUserModalDynamic').remove();
                // Recargar datos
                if (typeof loadUsersData === 'function') {
                    loadUsersData();
                }
            } else {
                alert('❌ No se pudo actualizar el usuario');
            }
        }

        // Función para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Fecha inválida';
            }
        }
        
        // Función para eliminar usuario
        async function deleteUser(userId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                try {
                    // Eliminar de Supabase si está inicializado
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            await window.supabaseClient.deleteUser(userId);
                            console.log('✅ Usuario eliminado de Supabase:', userId);
                        } catch (supabaseError) {
                            console.warn('⚠️ Error al eliminar de Supabase (continuando con localStorage):', supabaseError);
                        }
                    }
                    
                    // Cargar usuarios actuales
                    const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Filtrar el usuario a eliminar
                    const updatedUsers = users.filter(user => user.id !== userId);
                    
                    // Guardar usuarios actualizados
                    localStorage.setItem('checkin24hs_users', JSON.stringify(updatedUsers));
                    
                    // También eliminar de clientesDB si existe
                    const clientesDB = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                    const updatedClientesDB = clientesDB.filter(c => c.id !== userId);
                    localStorage.setItem('clientesDB', JSON.stringify(updatedClientesDB));
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('✅ Usuario eliminado:', userId);
                    alert('✅ Usuario eliminado correctamente');
                } catch (error) {
                    console.error('❌ Error al eliminar usuario:', error);
                    alert('❌ Error al eliminar usuario');
                }
            }
        }
        
        // Función para eliminar todos los usuarios
        async function deleteAllUsers() {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (confirm('⚠️ ¿Estás seguro de que quieres eliminar TODOS los usuarios registrados?\n\nEsta acción eliminará todos los usuarios de la aplicación móvil (index.html) y no se puede deshacer.')) {
                try {
                    // Obtener usuarios antes de eliminar para intentar eliminarlos de Supabase
                    const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Intentar eliminar de Supabase si está inicializado
                    if (window.supabaseClient && window.supabaseClient.isInitialized() && users.length > 0) {
                        console.log('🗑️ Eliminando usuarios de Supabase...');
                        let deletedFromSupabase = 0;
                        let errorsFromSupabase = 0;
                        
                        for (const user of users) {
                            try {
                                await window.supabaseClient.deleteUser(user.id);
                                deletedFromSupabase++;
                            } catch (error) {
                                // Ignorar errores si el usuario no existe en Supabase
                                errorsFromSupabase++;
                                console.log(`ℹ️ Usuario ${user.id} no existe en Supabase o ya fue eliminado`);
                            }
                        }
                        
                        console.log(`✅ ${deletedFromSupabase} usuarios eliminados de Supabase`);
                        if (errorsFromSupabase > 0) {
                            console.log(`ℹ️ ${errorsFromSupabase} usuarios no encontrados en Supabase (probablemente solo en localStorage)`);
                        }
                    }
                    
                    // Eliminar usuarios de checkin24hs_users (dashboard)
                    localStorage.removeItem('checkin24hs_users');
                    
                    // Eliminar usuarios de clientesDB (index.html)
                    localStorage.removeItem('clientesDB');
                    
                    // Eliminar usuario actual si existe
                    localStorage.removeItem('currentUser');
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('🗑️ Todos los usuarios eliminados');
                    alert('✅ Todos los usuarios han sido eliminados correctamente\n\n- Usuarios del dashboard eliminados\n- Usuarios de la app móvil eliminados\n- Sesiones activas cerradas');
                    
                    // Actualizar estadísticas
                    updateDashboardStats([]);
                    
                } catch (error) {
                    console.error('❌ Error al eliminar usuarios:', error);
                    alert('❌ Error al eliminar usuarios');
                }
            }
        }

        // Función para eliminar usuarios duplicados
        async function removeDuplicateUsers() {
            try {
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const originalCount = users.length;
                
                if (users.length === 0) {
                    alert('ℹ️ No hay usuarios para procesar');
                    return;
                }
                
                // Crear mapa para detectar duplicados por nombre (case insensitive)
                const uniqueUsers = [];
                const seenNames = new Set();
                
                users.forEach(user => {
                    const name = (user.name || '').toLowerCase().trim();
                    if (name && !seenNames.has(name)) {
                        seenNames.add(name);
                        uniqueUsers.push(user);
                    }
                });
                
                const duplicatesRemoved = originalCount - uniqueUsers.length;
                
                if (duplicatesRemoved === 0) {
                    alert('✅ No se encontraron usuarios duplicados');
                    return;
                }
                
                // Guardar usuarios únicos
                localStorage.setItem('checkin24hs_users', JSON.stringify(uniqueUsers));
                
                // Actualizar en Supabase - eliminar todos y reinsertar únicos
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Actualizando usuarios únicos en Supabase...');
                    // Primero eliminar todos los usuarios de la tabla
                    await window.supabaseClient.client.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    
                    // Insertar usuarios únicos
                    for (const user of uniqueUsers) {
                        try {
                            await window.supabaseClient.client.from('users').insert({
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                tipo_cuenta: 'cliente_reserva'
                            });
                        } catch (e) {
                            // Ignorar errores de inserción
                        }
                    }
                }
                
                // Recargar tabla
                loadUsersData();
                
                alert(`✅ Duplicados eliminados:\n- Usuarios originales: ${originalCount}\n- Duplicados removidos: ${duplicatesRemoved}\n- Usuarios únicos: ${uniqueUsers.length}`);
                
            } catch (error) {
                console.error('❌ Error al eliminar duplicados:', error);
                alert('❌ Error al eliminar duplicados: ' + error.message);
            }
        }

        // Función para fusionar usuarios duplicados por email o teléfono
        async function mergeDuplicateUsers() {
            try {
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const originalCount = users.length;
                
                if (users.length === 0) {
                    alert('ℹ️ No hay usuarios para procesar');
                    return;
                }
                
                // Mapas para detectar duplicados
                const emailMap = new Map(); // email -> array de usuarios
                const phoneMap = new Map(); // phone -> array de usuarios
                
                // Agrupar usuarios por email y teléfono
                users.forEach(user => {
                    const email = (user.email || '').toLowerCase().trim();
                    const phone = (user.phone || '').replace(/\D/g, ''); // Solo dígitos
                    
                    if (email) {
                        if (!emailMap.has(email)) emailMap.set(email, []);
                        emailMap.get(email).push(user);
                    }
                    
                    if (phone && phone.length >= 8) { // Solo teléfonos válidos
                        if (!phoneMap.has(phone)) phoneMap.set(phone, []);
                        phoneMap.get(phone).push(user);
                    }
                });
                
                // Función para fusionar dos usuarios
                const mergeUsers = (user1, user2) => {
                    return {
                        id: user1.id,
                        name: user1.name || user2.name,
                        email: user1.email || user2.email,
                        phone: user1.phone || user2.phone,
                        status: user1.status || user2.status || 'active',
                        is_active: user1.is_active !== false && user2.is_active !== false,
                        createdAt: user1.createdAt || user2.createdAt || new Date().toISOString(),
                        created_at: user1.created_at || user2.created_at || new Date().toISOString(),
                        last_activity: user1.last_activity > user2.last_activity ? user1.last_activity : user2.last_activity,
                        rewards_points: Math.max(user1.rewards_points || 0, user2.rewards_points || 0),
                        tipoCuenta: user1.tipoCuenta || user2.tipoCuenta || 'cliente_reserva',
                        totalQuotes: (user1.totalQuotes || 0) + (user2.totalQuotes || 0),
                        birthDay: user1.birthDay || user2.birthDay,
                        birthMonth: user1.birthMonth || user2.birthMonth
                    };
                };
                
                // Rastrear usuarios ya fusionados
                const mergedIds = new Set();
                const mergedUsers = [];
                let mergeCount = 0;
                
                // Fusionar por email
                emailMap.forEach((usersWithEmail, email) => {
                    if (usersWithEmail.length > 1) {
                        let merged = usersWithEmail[0];
                        for (let i = 1; i < usersWithEmail.length; i++) {
                            merged = mergeUsers(merged, usersWithEmail[i]);
                            mergedIds.add(usersWithEmail[i].id);
                            mergeCount++;
                        }
                        mergedIds.add(usersWithEmail[0].id);
                        mergedUsers.push(merged);
                        console.log(`🔗 Fusionados ${usersWithEmail.length} usuarios con email: ${email}`);
                    }
                });
                
                // Fusionar por teléfono (solo si no fueron fusionados por email)
                phoneMap.forEach((usersWithPhone, phone) => {
                    const unfusedUsers = usersWithPhone.filter(u => !mergedIds.has(u.id));
                    if (unfusedUsers.length > 1) {
                        let merged = unfusedUsers[0];
                        for (let i = 1; i < unfusedUsers.length; i++) {
                            merged = mergeUsers(merged, unfusedUsers[i]);
                            mergedIds.add(unfusedUsers[i].id);
                            mergeCount++;
                        }
                        mergedIds.add(unfusedUsers[0].id);
                        mergedUsers.push(merged);
                        console.log(`🔗 Fusionados ${unfusedUsers.length} usuarios con teléfono: ${phone}`);
                    }
                });
                
                // Agregar usuarios que no fueron fusionados
                users.forEach(user => {
                    if (!mergedIds.has(user.id)) {
                        mergedUsers.push(user);
                    }
                });
                
                if (mergeCount === 0) {
                    alert('✅ No se encontraron usuarios para fusionar\n\nNo hay usuarios con el mismo email o teléfono.');
                    return;
                }
                
                // Guardar usuarios fusionados
                localStorage.setItem('checkin24hs_users', JSON.stringify(mergedUsers));
                
                // Actualizar en Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Actualizando usuarios fusionados en Supabase...');
                    await window.supabaseClient.client.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    
                    for (const user of mergedUsers) {
                        try {
                            await window.supabaseClient.client.from('users').insert({
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                tipo_cuenta: user.tipoCuenta || 'cliente_reserva'
                            });
                        } catch (e) {
                            // Ignorar errores
                        }
                    }
                }
                
                // Recargar tabla
                loadUsersData();
                
                alert(`✅ Usuarios fusionados:\n- Usuarios originales: ${originalCount}\n- Fusiones realizadas: ${mergeCount}\n- Usuarios resultantes: ${mergedUsers.length}\n\nLos datos complementarios fueron combinados.`);
                
            } catch (error) {
                console.error('❌ Error al fusionar usuarios:', error);
                alert('❌ Error al fusionar usuarios: ' + error.message);
            }
        }

        // ===== FUNCIONES DE RESERVAS =====

        // Función para inicializar base de datos de reservas
        async function initReservationsDB() {
            console.log('Inicializando base de datos de reservas...');
            
            // SIEMPRE intentar cargar desde Supabase primero cuando está disponible
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Supabase disponible, cargando reservas desde la nube...');
                    const supabaseReservations = await window.supabaseClient.getReservations();
                    if (supabaseReservations && supabaseReservations.length > 0) {
                        localStorage.setItem('reservationsDB', JSON.stringify(supabaseReservations));
                        console.log(`✅ ${supabaseReservations.length} reservas cargadas desde Supabase`);
                        
                        // IMPORTANTE: Actualizar estadísticas después de cargar reservas
                        console.log('🔄 Actualizando estadísticas con las reservas cargadas...');
                        if (typeof updateStats === 'function') {
                            updateStats();
                        }
                        if (typeof loadMonthlySales === 'function') {
                            loadMonthlySales();
                        }
                        return;
                    } else {
                        console.log('ℹ️ No hay reservas en Supabase. El sistema está listo para agregar reservas reales.');
                        localStorage.setItem('reservationsDB', JSON.stringify([]));
                        return;
                    }
                }
            } catch (error) {
                console.error('❌ Error al cargar reservas desde Supabase:', error);
            }
            
            // Solo usar localStorage como fallback si Supabase no está disponible
            const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            if (existingReservations.length > 0) {
                console.log(`💾 Usando ${existingReservations.length} reservas de localStorage (modo offline)`);
            } else {
                console.log('ℹ️ No hay reservas disponibles');
                localStorage.setItem('reservationsDB', JSON.stringify([]));
            }
        }

        // Variable global para almacenar todas las reservas
        let allReservationsData = [];
        
        // Función para cargar tabla de reservas
        async function loadReservationsTable(searchFilter = '') {
            console.log('🔄 Cargando tabla de reservas...');
            
            const tbody = document.getElementById('reservationsTableBody');
            if (!tbody) {
                console.error('❌ Tbody de reservas no encontrado');
                return;
            }
            
            // Intentar cargar desde Supabase primero
            let reservations = [];
            let loadedFromSupabase = false;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('☁️ Cargando reservas desde Supabase...');
                    reservations = await window.supabaseClient.getReservations();
                    console.log(`✅ ${reservations.length} reservas cargadas desde Supabase`);
                    loadedFromSupabase = true;
                    
                    // IMPORTANTE: Guardar en localStorage para que otras funciones tengan acceso
                    localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                    console.log('💾 Reservas guardadas en localStorage');
                } catch (error) {
                    console.warn('Error cargando desde Supabase, usando localStorage:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                console.log('💾 Cargando reservas desde localStorage...');
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            console.log(`📋 Encontradas ${reservations.length} reservas`);
            
            // Guardar todas las reservas en variables globales (para filtros)
            allReservationsData = reservations;
            allReservationsForFilter = reservations;
            
            // Cargar hoteles en el filtro
            loadHotelsForReservationFilter();
            
            // Si se cargaron datos frescos de Supabase, actualizar las estadísticas
            if (loadedFromSupabase) {
                console.log('🔄 Actualizando estadísticas con datos frescos de Supabase...');
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            }
            
            // Ordenar reservas por fecha de check-in (más recientes primero)
            reservations.sort((a, b) => {
                const dateA = new Date(a.check_in || a.checkIn || a.createdAt || 0);
                const dateB = new Date(b.check_in || b.checkIn || b.createdAt || 0);
                return dateB - dateA; // Más reciente primero
            });
            
            // Filtrar por múltiples campos si hay un filtro
            if (searchFilter && searchFilter.trim() !== '') {
                const filter = searchFilter.trim().toLowerCase();
                reservations = reservations.filter(reservation => {
                    // Buscar en código de reserva (snake_case y camelCase)
                    const code = (reservation.reservation_code || reservation.reservationCode || reservation.code || '').toLowerCase();
                    
                    // Buscar en email del cliente
                    const email = (reservation.client_email || reservation.clientEmail || reservation.email || '').toLowerCase();
                    
                    // Buscar en nombre del cliente
                    const clientName = (reservation.client_name || reservation.clientName || reservation.name || '').toLowerCase();
                    
                    // Buscar en nombre del hotel
                    const hotelName = (reservation.hotel_name || reservation.hotelName || reservation.hotel || '').toLowerCase();
                    
                    // Buscar en teléfono
                    const phone = (reservation.client_phone || reservation.clientPhone || reservation.phone || '').toLowerCase();
                    
                    // Buscar en ID de reserva
                    const id = (reservation.id || '').toString().toLowerCase();
                    
                    // Buscar en estado
                    const status = (reservation.status || '').toLowerCase();
                    
                    // Buscar en agente
                    const agentName = (reservation.agent_name || reservation.agentName || '').toLowerCase();
                    
                    // Buscar en total (como string)
                    const total = (reservation.total_amount || reservation.totalAmount || '').toString();
                    
                    // Buscar en fechas
                    const checkIn = (reservation.check_in || reservation.checkIn || '').toLowerCase();
                    const checkOut = (reservation.check_out || reservation.checkOut || '').toLowerCase();
                    
                    // Verificar búsqueda parcial o exacta en cualquier campo
                    return code.includes(filter) ||
                           email.includes(filter) ||
                           clientName.includes(filter) ||
                           hotelName.includes(filter) ||
                           phone.includes(filter) ||
                           id.includes(filter) ||
                           status.includes(filter) ||
                           agentName.includes(filter) ||
                           total.includes(filter) ||
                           checkIn.includes(filter) ||
                           checkOut.includes(filter);
                });
                console.log(`🔍 Filtradas ${reservations.length} reservas que contienen "${searchFilter}"`);
            } else {
                // Si no hay búsqueda, mostrar solo las últimas 20
                reservations = reservations.slice(0, 20);
                console.log(`📋 Mostrando las últimas 20 reservas de ${allReservationsData.length} totales`);
            }
            
            tbody.innerHTML = '';

            if (reservations.length === 0) {
                // Mostrar mensaje si no hay reservas
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-calendar" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">${searchFilter ? 'No se encontraron reservas' : 'No hay reservas registradas'}</h3>
                        <p style="margin-bottom: 20px; color: #666;">${searchFilter ? `No hay reservas con código que contenga "${searchFilter}"` : 'Comienza agregando tu primera reserva'}</p>
                        ${!searchFilter ? `<button onclick="addNewReservation()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nueva Reserva
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            reservations.forEach(reservation => {
                // Normalizar campos (soportar snake_case de Supabase y camelCase de localStorage)
                const clientName = reservation.client_name || reservation.clientName || 'Sin nombre';
                const clientEmail = reservation.client_email || reservation.clientEmail || '';
                const hotelName = reservation.hotel_name || reservation.hotelName || 'Sin hotel';
                const checkIn = reservation.check_in || reservation.checkIn || '';
                const checkOut = reservation.check_out || reservation.checkOut || '';
                const reservationCode = reservation.reservation_code || reservation.reservationCode || 'N/A';
                const totalAmount = reservation.total_amount || reservation.totalAmount || 0;
                const status = reservation.status || 'Pendiente';
                const paymentStatus = reservation.payment_status || reservation.paymentStatus || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500; color: #1976d2;">
                        <strong>${reservationCode}</strong>
                    </td>
                    <td>
                        <div>
                            <div class="hotel-name">${clientName}</div>
                            <div class="hotel-location">${clientEmail}</div>
                        </div>
                    </td>
                    <td>${hotelName}</td>
                    <td style="text-align: center;">
                        <div>
                            <div><strong>Entrada:</strong> ${formatDate(checkIn)}</div>
                            <div><strong>Salida:</strong> ${formatDate(checkOut)}</div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <span class="status-${status.toLowerCase()}">${status}</span>
                    </td>
                    <td style="text-align: center;">
                        <strong>$${Number(totalAmount).toLocaleString()}</strong>
                        ${paymentStatus ? `<div style="font-size: 0.8em; color: #666;">${paymentStatus}</div>` : ''}
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewReservation('${reservation.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button onclick="editReservation('${reservation.id}')" class="action-btn edit" title="Modificar">
                            <span class="material-icons">edit</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`✅ Tabla de reservas cargada con ${reservations.length} reservas`);
            
            // Mostrar información si hay más reservas disponibles (solo si no hay búsqueda activa)
            const searchInput = document.getElementById('reservationSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allReservationsData.length > reservations.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'reservations-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando las últimas ${reservations.length} reservas de ${allReservationsData.length} totales. Usa el buscador para encontrar más reservas.`;
                
                const tableContainer = tbody.closest('.activity-card') || tbody.closest('div');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay búsqueda activa
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Función para filtrar reservas por código
        function filterReservationsByCode(searchValue) {
            console.log('🔍 Filtrando reservas por código:', searchValue);
            loadReservationsTable(searchValue);
        }

        // Función para actualizar estadísticas de reservas
        function updateReservationsStats() {
            console.log('📊 Actualizando estadísticas de reservas...');
            
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Actualizar contadores
            const totalReservationsElement = document.getElementById('totalReservations');
            const confirmedReservationsElement = document.getElementById('confirmedReservations');
            const modifiedReservationsElement = document.getElementById('modifiedReservations');
            const canceledReservationsElement = document.getElementById('canceledReservations');
            // Actualizar cantidad de Reservas Futuras
            const futureReservationsCountElement = document.getElementById('futureReservationsCount');
            
            if (totalReservationsElement) {
                totalReservationsElement.textContent = reservations.length;
            }
            
            if (confirmedReservationsElement) {
                const confirmed = reservations.filter(r => r.status === 'Confirmada').length;
                confirmedReservationsElement.textContent = confirmed;
            }
            
            if (modifiedReservationsElement) {
                const modified = reservations.filter(r => r.status === 'Modificada').length;
                modifiedReservationsElement.textContent = modified;
            }
            
            if (canceledReservationsElement) {
                const canceled = reservations.filter(r => r.status === 'Cancelada').length;
                canceledReservationsElement.textContent = canceled;
            }
            
            if (futureReservationsCountElement) {
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Función auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Verificar si tiene checkIn
                    if (!reservation.checkIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(reservation.checkIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                const count = futureReservations.length;
                futureReservationsCountElement.textContent = count;
                
                console.log(`✅ Cantidad de Reservas Futuras actualizada: ${count} reservas`);
            }
            
            console.log(`✅ Estadísticas de reservas actualizadas: ${reservations.length} reservas`);
            
            // Actualizar ventas mensuales si el dashboard está visible
            if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                loadMonthlySales();
            }
        }

        // Función para mostrar modal de Cantidad de Reservas Futuras
        function showTotalRevenueModal() {
            console.log('📊 Abriendo modal de Cantidad de Reservas Futuras...');
            
            // Obtener todas las reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Obtener fecha de hoy en formato YYYY-MM-DD (fecha local)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Función auxiliar para normalizar fechas
            function normalizeDate(dateStr) {
                if (!dateStr) return null;
                if (dateStr.includes('T')) {
                    return dateStr.split('T')[0];
                }
                return dateStr;
            }
            
            // Filtrar reservas futuras (checkIn >= hoy) que no estén canceladas
            const futureReservations = reservations.filter(reservation => {
                // Excluir canceladas
                const status = reservation.status || '';
                if (status === 'Cancelada' || status === 'cancelada') {
                    return false;
                }
                
                // Verificar si tiene checkIn
                if (!reservation.checkIn) {
                    return false;
                }
                
                // Normalizar fecha de checkIn
                const checkInDate = normalizeDate(reservation.checkIn);
                if (!checkInDate) {
                    return false;
                }
                
                // Comparar con fecha de hoy (checkIn >= hoy)
                return checkInDate >= todayStr;
            });
            
            // Calcular cantidad de reservas futuras
            const futureReservationsCount = futureReservations.length;
            
            console.log('📊 Reservas futuras:', {
                cantidad: futureReservationsCount,
                fechaHoy: todayStr
            });
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333; font-size: 1.5rem;">📅 Cantidad de Reservas Futuras</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 8px; padding: 30px; text-align: center;">
                        <div style="width: 80px; height: 80px; background-color: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <span class="material-icons" style="color: white; font-size: 40px;">event</span>
                        </div>
                        <h3 style="margin: 0; font-size: 3rem; color: #333; font-weight: 700;">${futureReservationsCount}</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 1.1rem; font-weight: 500;">Reservas Futuras</p>
                        <p style="margin: 12px 0 0 0; color: #999; font-size: 0.9rem;">Reservas desde hoy (${todayStr}) hacia adelante</p>
                    </div>
                    
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="margin: 0; color: #666; font-size: 0.9rem; text-align: center;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</span>
                            Solo se incluyen reservas confirmadas o modificadas (no canceladas)
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Función para cargar ventas mensuales con filtros
        function loadMonthlySales(filterFrom = null, filterTo = null, filterHotelId = 'all') {
            console.log('📊 Cargando ventas mensuales...', { filterFrom, filterTo, filterHotelId });
            
            const monthlySalesContent = document.getElementById('monthlySalesContent');
            if (!monthlySalesContent) {
                console.error('❌ Contenedor de ventas mensuales no encontrado');
                return;
            }
            
            // Obtener todas las reservas
            let reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // DEBUG: Mostrar estructura de la primera reserva
            if (reservations.length > 0) {
                console.log('🔍 DEBUG - Primera reserva:', JSON.stringify(reservations[0], null, 2));
                console.log('🔍 DEBUG - Campos de monto disponibles:', {
                    totalAmount: reservations[0].totalAmount,
                    total_amount: reservations[0].total_amount,
                    amount: reservations[0].amount,
                    price: reservations[0].price
                });
                console.log('🔍 DEBUG - Campos de fecha disponibles:', {
                    checkIn: reservations[0].checkIn,
                    check_in: reservations[0].check_in
                });
            }
            
            if (!reservations || reservations.length === 0) {
                // Restaurar estilos por defecto
                monthlySalesContent.style.display = 'flex';
                monthlySalesContent.style.alignItems = 'center';
                monthlySalesContent.style.justifyContent = 'center';
                monthlySalesContent.style.background = '#f5f5f5';
                monthlySalesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtro de hotel (buscar en camelCase y snake_case)
            if (filterHotelId && filterHotelId !== 'all') {
                reservations = reservations.filter(reservation => {
                    const hotelId = reservation.hotelId || reservation.hotel_id;
                    return hotelId === filterHotelId || 
                           hotelId === parseInt(filterHotelId) ||
                           (hotelId && hotelId.toString() === filterHotelId.toString());
                });
                console.log(`🏨 Filtrado por hotel ${filterHotelId}: ${reservations.length} reservas`);
            }
            
            // Objeto para agrupar ventas por mes/año
            const monthlySales = {};
            
            // Procesar cada reserva
            reservations.forEach(reservation => {
                // Obtener fecha de check-in (buscar en camelCase y snake_case)
                const checkInDate = reservation.checkIn || reservation.check_in;
                // Buscar monto en diferentes campos posibles (camelCase y snake_case)
                const totalAmount = parseFloat(reservation.totalAmount) || 
                                   parseFloat(reservation.total_amount) || 
                                   parseFloat(reservation.amount) || 
                                   parseFloat(reservation.price) || 0;
                
                if (!checkInDate || totalAmount <= 0) {
                    console.log('⚠️ Reserva saltada:', { checkInDate, totalAmount, reservation: reservation.reservation_code || reservation.reservationCode });
                    return; // Saltar reservas sin fecha de check-in o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = checkInDate;
                if (checkInDate.includes('T')) {
                    dateStr = checkInDate.split('T')[0];
                }
                
                // Extraer año y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inválido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inválida
                }
                
                // Crear clave única para mes/año (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToYear = parseInt(filterTo.split('-')[0]);
                    const filterToMonth = parseInt(filterTo.split('-')[1]);
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (después del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlySales[monthKey]) {
                    monthlySales[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        count: 0
                    };
                }
                
                // Sumar venta (solo si no está cancelada)
                if (reservation.status !== 'Cancelada') {
                    monthlySales[monthKey].total += totalAmount;
                    monthlySales[monthKey].count += 1;
                }
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                // Ajustar si el mes es negativo (año anterior)
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                // Ajustar si el mes es mayor a 12 (año siguiente)
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalSalesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlySales[monthKey]) {
                    // Si hay datos para este mes, usar los datos reales
                    return monthlySales[monthKey];
                } else {
                    // Si no hay datos, crear entrada con valores en 0
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por año y mes (más reciente primero para mostrar: futuro -> presente -> pasado)
            finalSalesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year; // Año más reciente primero
                }
                return b.month - a.month; // Mes más reciente primero
            });
            
            // Nombres de meses en español
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/Año</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Reservas</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalSalesArray.forEach(sale => {
                const monthName = monthNames[sale.month - 1];
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${sale.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${sale.count}</td>
                        <td style="padding: 10px; text-align: right; color: #1976d2; font-weight: 600;">$${sale.total.toLocaleString('es-AR')}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor para que no use flex cuando hay tabla
            monthlySalesContent.style.display = 'block';
            monthlySalesContent.style.alignItems = 'stretch';
            monthlySalesContent.style.justifyContent = 'flex-start';
            monthlySalesContent.style.background = 'transparent';
            monthlySalesContent.innerHTML = html;
            
            console.log(`✅ Ventas mensuales cargadas: ${finalSalesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Función para cargar hoteles en el selector de filtro
        function loadHotelsForMonthlySalesFilter() {
            const hotelFilter = document.getElementById('hotelFilter');
            if (!hotelFilter) {
                return;
            }
            
            // Obtener hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Limpiar opciones excepto "Todos los hoteles"
            hotelFilter.innerHTML = '<option value="all">Todos los hoteles</option>';
            
            // Agregar hoteles
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name || `Hotel ${hotel.id}`;
                hotelFilter.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el filtro`);
        }
        
        // Función para aplicar filtros de ventas mensuales
        function applyMonthlySalesFilters() {
            const monthFrom = document.getElementById('monthFilterFrom').value;
            const monthTo = document.getElementById('monthFilterTo').value;
            const hotelId = document.getElementById('hotelFilter').value;
            
            // Validar que si hay "desde", también debe haber "hasta" o viceversa (opcional, pero mejor si ambos están)
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('⚠️ El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlySales(monthFrom || null, monthTo || null, hotelId || 'all');
        }
        
        // Función para limpiar filtros de ventas mensuales
        function clearMonthlySalesFilters() {
            document.getElementById('monthFilterFrom').value = '';
            document.getElementById('monthFilterTo').value = '';
            document.getElementById('hotelFilter').value = 'all';
            loadMonthlySales(null, null, 'all');
        }
        
        // Función para cargar gastos mensuales con filtros
        function loadMonthlyExpenses(filterFrom = null, filterTo = null, filterCategory = 'all', filterType = 'all') {
            console.log('💰 Cargando gastos mensuales...', { filterFrom, filterTo, filterCategory, filterType });
            
            const monthlyExpensesContent = document.getElementById('monthlyExpensesContent');
            if (!monthlyExpensesContent) {
                console.error('❌ Contenedor de gastos mensuales no encontrado');
                return;
            }
            
            // Obtener todos los gastos
            let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            if (!expenses || expenses.length === 0) {
                monthlyExpensesContent.style.display = 'flex';
                monthlyExpensesContent.style.alignItems = 'center';
                monthlyExpensesContent.style.justifyContent = 'center';
                monthlyExpensesContent.style.background = '#f5f5f5';
                monthlyExpensesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtros
            if (filterCategory && filterCategory !== 'all') {
                expenses = expenses.filter(expense => expense.category === filterCategory);
                console.log(`📂 Filtrado por categoría ${filterCategory}: ${expenses.length} gastos`);
            }
            
            if (filterType && filterType !== 'all') {
                expenses = expenses.filter(expense => expense.type === filterType);
                console.log(`📋 Filtrado por tipo ${filterType}: ${expenses.length} gastos`);
            }
            
            // Objeto para agrupar gastos por mes/año
            const monthlyExpenses = {};
            
            // Procesar cada gasto
            expenses.forEach(expense => {
                const expenseDate = expense.date;
                const totalAmount = parseFloat(expense.amount) || 0;
                
                if (!expenseDate || totalAmount <= 0) {
                    return; // Saltar gastos sin fecha o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = expenseDate;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                // Extraer año y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inválido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inválida
                }
                
                // Crear clave única para mes/año (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToDate = new Date(filterTo + '-01');
                    const filterToYear = filterToDate.getFullYear();
                    const filterToMonth = filterToDate.getMonth() + 1;
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (después del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlyExpenses[monthKey]) {
                    monthlyExpenses[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        totalUSD: 0,
                        count: 0
                    };
                }
                
                // Sumar gasto en pesos
                monthlyExpenses[monthKey].total += totalAmount;
                monthlyExpenses[monthKey].count += 1;
                
                // Sumar gasto en USD usando el tipo de cambio del momento del gasto
                const expenseExchangeRate = parseFloat(expense.exchangeRate || expense.exchange_rate) || 0;
                const expenseUSD = parseFloat(expense.usd || expense.usd_amount) || 0;
                
                if (expenseUSD > 0) {
                    // Si ya tiene USD calculado, usarlo directamente
                    monthlyExpenses[monthKey].totalUSD += expenseUSD;
                } else if (expenseExchangeRate > 0) {
                    // Si tiene tipo de cambio, calcular USD
                    monthlyExpenses[monthKey].totalUSD += totalAmount / expenseExchangeRate;
                }
                // Si no tiene tipo de cambio ni USD, no sumar (quedará en 0)
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalExpensesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlyExpenses[monthKey]) {
                    return monthlyExpenses[monthKey];
                } else {
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        totalUSD: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por año y mes (más reciente primero)
            finalExpensesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year;
                }
                return b.month - a.month;
            });
            
            // Nombres de meses en español
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/Año</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Gastos</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total ARS</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #2e7d32;">Total USD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalExpensesArray.forEach(expense => {
                const monthName = monthNames[expense.month - 1];
                const totalUSD = expense.totalUSD || 0;
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${expense.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${expense.count}</td>
                        <td style="padding: 10px; text-align: right; color: #d32f2f; font-weight: 600;">$${expense.total.toLocaleString('es-AR')}</td>
                        <td style="padding: 10px; text-align: right; color: #2e7d32; font-weight: 600;">$${totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor
            monthlyExpensesContent.style.display = 'block';
            monthlyExpensesContent.style.alignItems = 'stretch';
            monthlyExpensesContent.style.justifyContent = 'flex-start';
            monthlyExpensesContent.style.background = 'transparent';
            monthlyExpensesContent.innerHTML = html;
            
            console.log(`✅ Gastos mensuales cargados: ${finalExpensesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Función para cargar categorías en el filtro de gastos
        function loadExpenseCategoriesForFilter() {
            const categoryFilter = document.getElementById('expenseCategoryFilter');
            if (!categoryFilter) {
                return;
            }
            
            // Limpiar opciones excepto "Todas las categorías"
            categoryFilter.innerHTML = '<option value="all">Todas las categorías</option>';
            
            // Agregar categorías
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categoryFilter.appendChild(option);
            });
            
            console.log(`✅ ${Object.keys(expenseCategories).length} categorías cargadas en el filtro`);
        }
        
        // Función para aplicar filtros de gastos mensuales
        function applyMonthlyExpensesFilters() {
            const monthFrom = document.getElementById('expenseMonthFilterFrom').value;
            const monthTo = document.getElementById('expenseMonthFilterTo').value;
            const category = document.getElementById('expenseCategoryFilter').value;
            const type = document.getElementById('expenseTypeFilter').value;
            
            // Validar que si hay "desde", también debe haber "hasta" o viceversa
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('⚠️ El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlyExpenses(monthFrom || null, monthTo || null, category || 'all', type || 'all');
        }
        
        // Función para limpiar filtros de gastos mensuales
        function clearMonthlyExpensesFilters() {
            document.getElementById('expenseMonthFilterFrom').value = '';
            document.getElementById('expenseMonthFilterTo').value = '';
            document.getElementById('expenseCategoryFilter').value = 'all';
            document.getElementById('expenseTypeFilter').value = 'all';
            loadMonthlyExpenses(null, null, 'all', 'all');
        }

        // Función para agregar nueva reserva
        function addNewReservation() {
            console.log('🆕 Abriendo formulario para nueva reserva...');
            
            // Limpiar el formulario
            const form = document.getElementById('newReservationForm');
            if (form) {
                form.reset();
            }
            
            // Generar código de reserva automático
            const reservationCodeInput = document.getElementById('newReservationCode');
            if (reservationCodeInput) {
                reservationCodeInput.value = generateReservationCode();
            }
            
            // Establecer fecha mínima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newCheckIn').min = today;
            document.getElementById('newCheckOut').min = today;
            
            // Establecer fecha de registro como hoy
            const reservationDateInput = document.getElementById('newReservationDate');
            if (reservationDateInput) {
                reservationDateInput.value = today;
            }
            
            // Cargar hoteles en el select
            loadHotelsForNewReservation();
            
            // Cargar agentes en el select
            loadAgentsForNewReservation();
            
            // Mostrar el modal
            document.getElementById('newReservationModal').style.display = 'block';
            
            console.log('✅ Modal de nueva reserva abierto');
        }

        // Función para editar reserva
        async function editReservation(reservationId) {
            console.log('✏️ Editando reserva:', reservationId);
            
            // Buscar primero en Supabase, luego en localStorage
            let reservations = [];
            let reservation = null;
            
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    reservations = await window.supabaseClient.getReservations();
                } catch (error) {
                    console.error('Error cargando reservas de Supabase:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            // Buscar la reserva por ID (puede ser UUID string)
            reservation = reservations.find(r => r.id === reservationId || r.id == reservationId);
            
            if (!reservation) {
                console.error('❌ Reserva no encontrada:', reservationId);
                alert('❌ Reserva no encontrada');
                return;
            }
            
            console.log('📋 Datos de reserva encontrada:', reservation);
            
            // Función auxiliar para normalizar fechas al formato YYYY-MM-DD
            // Evita problemas de zona horaria parseando manualmente
            const normalizeDate = (dateString) => {
                if (!dateString) return '';
                
                // Si ya está en formato YYYY-MM-DD, devolverlo tal cual
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                // Si está en formato ISO (YYYY-MM-DDTHH:mm:ss), extraer solo la fecha
                const isoMatch = dateString.match(/^(\d{4}-\d{2}-\d{2})/);
                if (isoMatch) {
                    return isoMatch[1];
                }
                
                // Si está en formato DD/MM/YYYY o DD-MM-YYYY, convertir manualmente
                const ddmmyyyyMatch = dateString.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
                if (ddmmyyyyMatch) {
                    const day = ddmmyyyyMatch[1];
                    const month = ddmmyyyyMatch[2];
                    const year = ddmmyyyyMatch[3];
                    return `${year}-${month}-${day}`;
                }
                
                // Si está en formato YYYY/MM/DD, convertir manualmente
                const yyyymmddMatch = dateString.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
                if (yyyymmddMatch) {
                    return dateString.replace(/[\/\-]/g, '-');
                }
                
                // Como último recurso, intentar con Date pero usando UTC para evitar problemas de zona horaria
                try {
                    // Si la fecha incluye hora, extraer solo la parte de fecha
                    const dateOnly = dateString.split('T')[0];
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) {
                        return dateOnly;
                    }
                    
                    // Parsear manualmente para evitar problemas de zona horaria
                    const date = new Date(dateString + 'T12:00:00'); // Usar mediodía para evitar cambios de día
                    if (isNaN(date.getTime())) return '';
                    
                    // Usar UTC para evitar problemas de zona horaria
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error('Error normalizando fecha:', dateString, e);
                    return '';
                }
            };
            
            // Llenar el formulario con los datos de la reserva (soportar camelCase y snake_case)
            document.getElementById('editClientName').value = reservation.client_name || reservation.clientName || '';
            document.getElementById('editClientEmail').value = reservation.client_email || reservation.clientEmail || '';
            document.getElementById('editClientPhone').value = reservation.client_phone || reservation.clientPhone || '';
            document.getElementById('editReservationCode').value = reservation.reservation_code || reservation.reservationCode || '';
            document.getElementById('editCheckIn').value = normalizeDate(reservation.check_in || reservation.checkIn);
            document.getElementById('editCheckOut').value = normalizeDate(reservation.check_out || reservation.checkOut);
            document.getElementById('editReservationDate').value = normalizeDate(reservation.reservation_date || reservation.reservationDate);
            document.getElementById('editTotalAmount').value = reservation.total_amount || reservation.totalAmount || 0;
            
            // Cargar hoteles en el select y seleccionar el correcto
            loadHotelsForEdit(reservation.hotel_id || reservation.hotelId);
            
            // Cargar agentes en el select y seleccionar el correcto
            loadAgentsForEdit(reservation.agent_name || reservation.agentName);
            
            // Actualizar el título del modal
            document.getElementById('editReservationTitle').textContent = `Editar Reserva - ${reservation.reservation_code || reservation.reservationCode || reservation.id}`;
            
            // Guardar el ID de la reserva en el formulario
            document.getElementById('editReservationForm').dataset.reservationId = reservationId;
            
            // Mostrar el modal
            document.getElementById('editReservationModal').style.display = 'block';
            
            console.log('✅ Modal de edición abierto para reserva:', reservation.reservationCode);
        }

        // Función para eliminar reserva
        function deleteReservation(reservationId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar esta reserva?')) {
                console.log('🗑️ Eliminando reserva:', reservationId);
                
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const updatedReservations = reservations.filter(r => r.id !== reservationId);
                
                localStorage.setItem('reservationsDB', JSON.stringify(updatedReservations));
                
                console.log('✅ Reserva eliminada correctamente');
                alert('✅ Reserva eliminada correctamente');
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            }
        }

        // Función para ver detalles de reserva
        async function viewReservation(reservationId) {
            console.log('👁️ Viendo detalles de reserva:', reservationId);
            
            // Buscar en Supabase primero, luego en localStorage
            let reservations = [];
            let reservation = null;
            
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    reservations = await window.supabaseClient.getReservations();
                } catch (error) {
                    console.error('Error cargando reservas de Supabase:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            reservation = reservations.find(r => r.id === reservationId || r.id == reservationId);
            
            if (!reservation) {
                console.error('❌ Reserva no encontrada:', reservationId);
                alert('❌ Reserva no encontrada');
                return;
            }
            
            // Obtener valores soportando ambos formatos (snake_case y camelCase)
            const clientName = reservation.client_name || reservation.clientName || 'N/A';
            const clientEmail = reservation.client_email || reservation.clientEmail || 'N/A';
            const clientPhone = reservation.client_phone || reservation.clientPhone || 'N/A';
            const hotelName = reservation.hotel_name || reservation.hotelName || 'N/A';
            const checkIn = reservation.check_in || reservation.checkIn || 'N/A';
            const checkOut = reservation.check_out || reservation.checkOut || 'N/A';
            const status = reservation.status || 'N/A';
            const totalAmount = reservation.total_amount || reservation.totalAmount || 0;
            const reservationCode = reservation.reservation_code || reservation.reservationCode || reservation.id;
            const agentName = reservation.agent_name || reservation.agentName || 'Sin asignar';
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">📅 ${reservationCode}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>👤 Información del Cliente</h3>
                        <p><strong>Nombre:</strong> ${clientName}</p>
                        <p><strong>Email:</strong> ${clientEmail}</p>
                        <p><strong>Teléfono:</strong> ${clientPhone}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>🏨 Información de la Reserva</h3>
                        <p><strong>Hotel:</strong> ${hotelName}</p>
                        <p><strong>Entrada:</strong> ${formatDate(checkIn)}</p>
                        <p><strong>Salida:</strong> ${formatDate(checkOut)}</p>
                        <p><strong>Agente:</strong> ${agentName}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>💰 Información de Pago</h3>
                        <p><strong>Estado:</strong> <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${status === 'Confirmada' ? '#e8f5e9' : status === 'Cancelada' ? '#ffebee' : status === 'Modificada' ? '#e3f2fd' : '#fff3e0'}; color: ${status === 'Confirmada' ? '#2e7d32' : status === 'Cancelada' ? '#c62828' : status === 'Modificada' ? '#1565c0' : '#e65100'};">${status}</span></p>
                        <p><strong>Total:</strong> $${totalAmount.toLocaleString()} USD</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editReservation('${reservation.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ✏️ Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Variable global para almacenar todas las reservas (para filtros)
        let allReservationsForFilter = [];
        
        // Función auxiliar para normalizar fechas a formato comparable (YYYY-MM-DD)
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            // Si ya es Date object
            if (dateStr instanceof Date) {
                return dateStr.toISOString().split('T')[0];
            }
            
            // Si es string, intentar parsear
            const dateString = String(dateStr).trim();
            
            // Formato ISO: 2025-12-14 o 2025-12-14T...
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                return dateString.substring(0, 10);
            }
            
            // Formato DD/MM/YYYY
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Formato DD-MM-YYYY
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('-');
                return `${year}-${month}-${day}`;
            }
            
            // Intentar parsear con Date
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {}
            
            return dateString;
        }
        
        // Función para aplicar filtros avanzados de reservas
        function applyReservationFilters() {
            const codeFilter = document.getElementById('filterReservationCode')?.value?.toLowerCase() || '';
            const nameFilter = document.getElementById('filterClientName')?.value?.toLowerCase() || '';
            const checkInFrom = document.getElementById('filterCheckInFrom')?.value || '';
            const checkInTo = document.getElementById('filterCheckInTo')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const hotelFilter = document.getElementById('filterHotel')?.value || '';
            
            console.log('🔍 Aplicando filtros:', { codeFilter, nameFilter, checkInFrom, checkInTo, statusFilter, hotelFilter });
            
            let filtered = allReservationsForFilter.filter(r => {
                // Filtro por código
                const code = (r.reservation_code || r.reservationCode || '').toLowerCase();
                if (codeFilter && !code.includes(codeFilter)) return false;
                
                // Filtro por nombre
                const clientName = (r.client_name || r.clientName || '').toLowerCase();
                if (nameFilter && !clientName.includes(nameFilter)) return false;
                
                // Filtro por fecha de entrada (desde) - usando normalización
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                const filterFrom = normalizeDate(checkInFrom);
                const filterTo = normalizeDate(checkInTo);
                
                if (filterFrom && checkIn && checkIn < filterFrom) return false;
                
                // Filtro por fecha de entrada (hasta)
                if (filterTo && checkIn && checkIn > filterTo) return false;
                
                // Filtro por estado
                const status = (r.status || '').toUpperCase();
                if (statusFilter && !status.includes(statusFilter.toUpperCase())) return false;
                
                // Filtro por hotel
                const hotelName = (r.hotel_name || r.hotelName || '').toLowerCase();
                if (hotelFilter && !hotelName.toLowerCase().includes(hotelFilter.toLowerCase())) return false;
                
                return true;
            });
            
            console.log(`📊 Filtro aplicado: ${filtered.length} de ${allReservationsForFilter.length} reservas`);
            
            // Actualizar tabla con resultados filtrados
            renderReservationsTable(filtered);
            
            // Mostrar contador de resultados
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `📊 ${filtered.length} de ${allReservationsForFilter.length} reservas`;
            }
        }
        
        // Función para limpiar filtros
        function clearReservationFilters() {
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = '';
            document.getElementById('filterCheckInTo').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            document.getElementById('reservationSearchInput').value = '';
            
            renderReservationsTable(allReservationsForFilter);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = '';
            }
        }
        
        // Función para filtrar reservas con check-in de hoy
        function filterTodayReservations() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log(`📅 Filtrando reservas con check-in de hoy: ${todayStr}`);
            
            const todayReservations = allReservationsForFilter.filter(r => {
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                
                const isToday = checkIn === todayStr;
                if (isToday) {
                    console.log(`✅ Check-in hoy: ${r.reservation_code || r.reservationCode} - ${r.client_name || r.clientName} - $${r.total_amount || r.totalAmount}`);
                }
                return isToday;
            });
            
            console.log(`📊 Reservas con check-in hoy: ${todayReservations.length}`);
            
            // Limpiar otros filtros y establecer fecha de hoy
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = todayStr;
            document.getElementById('filterCheckInTo').value = todayStr;
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            
            renderReservationsTable(todayReservations);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `📅 ${todayReservations.length} reserva(s) con check-in hoy (${todayStr})`;
            }
            
            if (todayReservations.length === 0) {
                alert(`ℹ️ No hay reservas con check-in para hoy (${todayStr})`);
            }
        }
        
        // Función para filtrar reservas futuras
        function filterFutureReservations() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log(`🔮 Filtrando reservas futuras desde: ${todayStr}`);
            
            const futureReservations = allReservationsForFilter.filter(r => {
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                return checkIn && checkIn >= todayStr;
            });
            
            // Ordenar por fecha de check-in
            futureReservations.sort((a, b) => {
                const dateA = normalizeDate(a.check_in || a.checkIn || '');
                const dateB = normalizeDate(b.check_in || b.checkIn || '');
                return dateA.localeCompare(dateB);
            });
            
            console.log(`📊 Reservas futuras: ${futureReservations.length}`);
            
            // Limpiar otros filtros
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = todayStr;
            document.getElementById('filterCheckInTo').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            
            renderReservationsTable(futureReservations);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `🔮 ${futureReservations.length} reserva(s) futuras desde ${todayStr}`;
            }
        }
        
        // Función para cargar hoteles en el filtro
        function loadHotelsForReservationFilter() {
            const filterHotel = document.getElementById('filterHotel');
            if (!filterHotel) return;
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            filterHotel.innerHTML = '<option value="">Todos los hoteles</option>';
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.name;
                option.textContent = hotel.name;
                filterHotel.appendChild(option);
            });
        }
        
        // Función para renderizar tabla de reservas
        function renderReservationsTable(reservations) {
            const tbody = document.getElementById('reservationsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (reservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No se encontraron reservas con los filtros aplicados</td></tr>';
                return;
            }
            
            reservations.forEach(reservation => {
                const code = reservation.reservation_code || reservation.reservationCode || '';
                const clientName = reservation.client_name || reservation.clientName || '';
                const hotelName = reservation.hotel_name || reservation.hotelName || '';
                const checkIn = reservation.check_in || reservation.checkIn || '';
                const checkOut = reservation.check_out || reservation.checkOut || '';
                const status = reservation.status || '';
                const total = reservation.total_amount || reservation.totalAmount || 0;
                const id = reservation.id || '';
                
                // Formatear fechas
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                };
                
                // Color del estado
                let statusColor = '#4caf50';
                let statusBg = '#e8f5e9';
                if (status.toUpperCase().includes('CANCEL')) {
                    statusColor = '#f44336';
                    statusBg = '#ffebee';
                } else if (status.toUpperCase().includes('MODIF')) {
                    statusColor = '#ff9800';
                    statusBg = '#fff3e0';
                } else if (status.toUpperCase().includes('PEND')) {
                    statusColor = '#2196f3';
                    statusBg = '#e3f2fd';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; font-family: monospace; font-size: 12px;">${code}</td>
                    <td style="padding: 12px;">${clientName}</td>
                    <td style="padding: 12px;">${hotelName}</td>
                    <td style="padding: 12px; text-align: center;">
                        <strong>Entrada:</strong> ${formatDate(checkIn)}<br>
                        <strong>Salida:</strong> ${formatDate(checkOut)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${statusBg}; color: ${statusColor}; font-weight: 500;">
                            ${status}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">$${total.toLocaleString()}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewReservation('${id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button onclick="editReservation('${id}')" class="action-btn edit" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Función para exportar reservas a Excel
        async function exportReservations() {
            console.log('📤 Exportando reservas a Excel...');
            
            try {
                // Intentar obtener reservas de Supabase primero
                let reservations = [];
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        reservations = await window.supabaseClient.getReservations();
                        console.log(`✅ ${reservations.length} reservas cargadas de Supabase para exportar`);
                    } catch (error) {
                        console.warn('⚠️ Error cargando de Supabase, usando localStorage:', error);
                        reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    }
                } else {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                if (reservations.length === 0) {
                    alert('⚠️ No hay reservas para exportar');
                    return;
                }
                
                // Preparar datos para Excel (soportar ambos formatos de campos)
                const excelData = reservations.map(reservation => {
                    return {
                        'Código': reservation.reservation_code || reservation.reservationCode || '',
                        'Cliente': reservation.client_name || reservation.clientName || '',
                        'Email': reservation.client_email || reservation.clientEmail || '',
                        'Teléfono': reservation.client_phone || reservation.clientPhone || '',
                        'Hotel': reservation.hotel_name || reservation.hotelName || '',
                        'Fecha Entrada': reservation.check_in || reservation.checkIn || '',
                        'Fecha Salida': reservation.check_out || reservation.checkOut || '',
                        'Fecha Registro': reservation.reservation_date || reservation.reservationDate || '',
                        'Agente': reservation.agent_name || reservation.agentName || '',
                        'Estado': reservation.status || '',
                        'Total': reservation.total_amount || reservation.totalAmount || 0,
                        'Adultos': reservation.adults || '',
                        'Niños': reservation.children || '',
                        'Notas': reservation.notes || ''
                    };
                });
                
                // Crear workbook y worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // Código
                    { wch: 25 }, // Cliente
                    { wch: 30 }, // Email
                    { wch: 15 }, // Teléfono
                    { wch: 30 }, // Hotel
                    { wch: 15 }, // Fecha Entrada
                    { wch: 15 }, // Fecha Salida
                    { wch: 15 }, // Fecha Registro
                    { wch: 20 }, // Agente
                    { wch: 12 }, // Estado
                    { wch: 12 }  // Total
                ];
                ws['!cols'] = colWidths;
                
                // Agregar worksheet al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Reservas');
                
                // Generar nombre de archivo con fecha
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0];
                const fileName = `Reservas_${dateStr}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, fileName);
                
                console.log(`✅ ${reservations.length} reservas exportadas correctamente`);
                alert(`✅ ${reservations.length} reservas exportadas correctamente a ${fileName}`);
                
            } catch (error) {
                console.error('❌ Error al exportar reservas:', error);
                alert('❌ Error al exportar reservas: ' + error.message);
            }
        }
        
        // Función para abrir modal de importación
        function importReservations() {
            console.log('📥 Abriendo modal de importación...');
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'flex';
                // Limpiar input de archivo
                const fileInput = document.getElementById('importFileInput');
                if (fileInput) {
                    fileInput.value = '';
                }
            }
        }
        
        // Función para cerrar modal de importación
        function closeImportReservationsModal() {
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Función para procesar archivo Excel importado
        function processImportFile() {
            const fileInput = document.getElementById('importFileInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('⚠️ Por favor selecciona un archivo Excel');
                return;
            }
            
            const file = fileInput.files[0];
            console.log('📥 Procesando archivo:', file.name);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Leer el archivo Excel
                    // Usar cellDates: true para que SheetJS intente parsear fechas automáticamente cuando sea posible
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // Obtener la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON con raw: true para obtener valores originales
                    // Esto nos permite detectar números seriales de Excel y convertirlos correctamente
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
                    
                    if (jsonData.length === 0) {
                        alert('⚠️ El archivo Excel está vacío o no tiene datos válidos');
                        return;
                    }
                    
                    console.log(`📋 ${jsonData.length} filas encontradas en el archivo`);
                    
                    // Obtener reservas existentes
                    const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    const reservationsMap = new Map();
                    
                    // Crear mapa de reservas existentes por código
                    existingReservations.forEach(res => {
                        if (res.reservationCode) {
                            reservationsMap.set(res.reservationCode, res);
                        }
                    });
                    
                    let added = 0;
                    let updated = 0;
                    let errors = 0;
                    const errorMessages = [];
                    
                    // Procesar cada fila del Excel
                    jsonData.forEach((row, index) => {
                        try {
                            // Mapear columnas del Excel a campos de reserva
                            const reservationCode = (row['Código'] || row['Codigo'] || '').toString().trim();
                            const clientName = (row['Cliente'] || '').toString().trim();
                            const clientEmail = (row['Email'] || '').toString().trim();
                            const clientPhone = (row['Teléfono'] || row['Telefono'] || '').toString().trim();
                            const hotelName = (row['Hotel'] || '').toString().trim();
                            const checkIn = (row['Fecha Entrada'] || row['FechaEntrada'] || '').toString().trim();
                            const checkOut = (row['Fecha Salida'] || row['FechaSalida'] || '').toString().trim();
                            const reservationDate = (row['Fecha Registro'] || row['FechaRegistro'] || '').toString().trim();
                            const agentName = (row['Agente'] || '').toString().trim();
                            const status = (row['Estado'] || 'Confirmada').toString().trim();
                            const totalAmount = parseFloat(row['Total'] || 0);
                            
                            // Validar campos requeridos (Email y Teléfono son opcionales)
                            if (!reservationCode || !clientName || !checkIn || !checkOut) {
                                errors++;
                                errorMessages.push(`Fila ${index + 2}: Faltan campos requeridos (Código, Cliente, Fechas)`);
                                return;
                            }
                            
                            // Buscar hotel por nombre
                            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotel = hotels.find(h => h.name === hotelName);
                            const hotelId = hotel ? hotel.id : '';
                            
                            // Normalizar fechas (formato YYYY-MM-DD)
                            const normalizeDate = (dateStr) => {
                                if (!dateStr) return '';
                                
                                // Convertir a string si es necesario
                                const dateValue = dateStr.toString().trim();
                                
                                // Detectar si es un número serial de Excel (puede venir como número o string)
                                // Los números seriales de Excel suelen ser > 1 (desde 1900) y < 1000000 (hasta ~2174)
                                const numericValue = typeof dateStr === 'number' ? dateStr : parseFloat(dateValue);
                                
                                if (!isNaN(numericValue) && numericValue > 1 && numericValue < 1000000) {
                                    // Es probablemente un número serial de Excel
                                    // Excel cuenta días desde el 1 de enero de 1900 como día 1
                                    // Hay un bug conocido: Excel trata 1900 como año bisiesto (aunque no lo es)
                                    // La fórmula más precisa para convertir números seriales de Excel:
                                    // Usamos 1899-12-30 como base y sumamos el número serial
                                    // Esto compensa el bug del año bisiesto 1900
                                    const excelEpoch = new Date(1899, 11, 30); // 30 de diciembre de 1899
                                    const date = new Date(excelEpoch.getTime() + numericValue * 24 * 60 * 60 * 1000);
                                    
                                    if (!isNaN(date.getTime())) {
                                        // Verificar que la fecha sea razonable (entre 1900 y 2100)
                                        const year = date.getFullYear();
                                        if (year >= 1900 && year <= 2100) {
                                            const yearStr = String(date.getFullYear());
                                            const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                            const dayStr = String(date.getDate()).padStart(2, '0');
                                            return `${yearStr}-${monthStr}-${dayStr}`;
                                        }
                                    }
                                }
                                
                                // Si es un objeto Date (cuando SheetJS parsea fechas con cellDates: true)
                                if (dateStr instanceof Date) {
                                    const yearStr = String(dateStr.getFullYear());
                                    const monthStr = String(dateStr.getMonth() + 1).padStart(2, '0');
                                    const dayStr = String(dateStr.getDate()).padStart(2, '0');
                                    return `${yearStr}-${monthStr}-${dayStr}`;
                                }
                                
                                // Si ya está en formato YYYY-MM-DD, devolverlo tal cual
                                if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                                    return dateValue;
                                }
                                
                                // Intentar parsear diferentes formatos de fecha
                                let date = null;
                                
                                // Formato con barras DD/MM/YYYY o MM/DD/YYYY
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('/');
                                    // Si el primer número es > 12, es DD/MM/YYYY, sino intentar MM/DD/YYYY
                                    if (parseInt(parts[0]) > 12) {
                                        // DD/MM/YYYY
                                        date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    } else {
                                        // Intentar MM/DD/YYYY primero
                                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                        // Si la fecha no es válida, intentar DD/MM/YYYY
                                        if (isNaN(date.getTime())) {
                                            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                        }
                                    }
                                }
                                // Formato con guiones DD-MM-YYYY
                                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('-');
                                    date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                }
                                // Otros formatos (intentar parseo directo)
                                else {
                                    date = new Date(dateValue);
                                }
                                
                                if (date && !isNaN(date.getTime())) {
                                    // Verificar que la fecha sea razonable
                                    const year = date.getFullYear();
                                    if (year >= 1900 && year <= 2100) {
                                        const yearStr = String(year);
                                        const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                        const dayStr = String(date.getDate()).padStart(2, '0');
                                        return `${yearStr}-${monthStr}-${dayStr}`;
                                    }
                                }
                                
                                // Si no se pudo parsear, devolver string vacío o el valor original
                                console.warn('⚠️ No se pudo normalizar la fecha:', dateStr);
                                return '';
                            };
                            
                            const normalizedCheckIn = normalizeDate(checkIn);
                            const normalizedCheckOut = normalizeDate(checkOut);
                            const normalizedReservationDate = normalizeDate(reservationDate) || new Date().toISOString().split('T')[0];
                            
                            // Verificar si la reserva ya existe
                            const existingReservation = reservationsMap.get(reservationCode);
                            
                            if (existingReservation) {
                                // Actualizar reserva existente
                                existingReservation.clientName = clientName;
                                existingReservation.clientEmail = clientEmail;
                                existingReservation.clientPhone = clientPhone;
                                existingReservation.hotelId = hotelId;
                                existingReservation.hotelName = hotelName;
                                existingReservation.checkIn = normalizedCheckIn;
                                existingReservation.checkOut = normalizedCheckOut;
                                existingReservation.reservationDate = normalizedReservationDate;
                                existingReservation.agentName = agentName;
                                existingReservation.status = status;
                                existingReservation.totalAmount = totalAmount;
                                existingReservation.updatedAt = new Date().toISOString();
                                updated++;
                            } else {
                                // Crear nueva reserva
                                const newReservation = {
                                    id: 'res-' + Date.now() + '-' + index,
                                    reservationCode: reservationCode,
                                    clientName: clientName,
                                    clientEmail: clientEmail,
                                    clientPhone: clientPhone,
                                    hotelId: hotelId,
                                    hotelName: hotelName,
                                    checkIn: normalizedCheckIn,
                                    checkOut: normalizedCheckOut,
                                    reservationDate: normalizedReservationDate,
                                    agentName: agentName,
                                    status: status,
                                    totalAmount: totalAmount,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                existingReservations.push(newReservation);
                                reservationsMap.set(reservationCode, newReservation);
                                added++;
                                
                                // Guardar o actualizar usuario
                                if (typeof saveUserFromReservation === 'function') {
                                    saveUserFromReservation(newReservation);
                                }
                            }
                        } catch (error) {
                            errors++;
                            errorMessages.push(`Fila ${index + 2}: ${error.message}`);
                            console.error(`Error procesando fila ${index + 2}:`, error);
                        }
                    });
                    
                    // Guardar en localStorage como backup
                    localStorage.setItem('reservationsDB', JSON.stringify(existingReservations));
                    
                    // Subir SOLO las reservas nuevas/actualizadas a Supabase (no todas)
                    let syncSuccess = false;
                    const totalToSync = added + updated;
                    
                    if (window.supabaseClient && window.supabaseClient.isInitialized() && totalToSync > 0) {
                        console.log(`☁️ Subiendo ${totalToSync} reservas importadas a Supabase...`);
                        
                        let syncErrors = 0;
                        let syncCount = 0;
                        
                        // Preparar SOLO las reservas que se procesaron en esta importación
                        const reservationsToSync = [];
                        jsonData.forEach((row, index) => {
                            const reservationCode = (row['Código'] || row['Codigo'] || '').toString().trim();
                            const clientName = (row['Cliente'] || '').toString().trim();
                            const checkIn = (row['Fecha Entrada'] || row['FechaEntrada'] || '').toString().trim();
                            const checkOut = (row['Fecha Salida'] || row['FechaSalida'] || '').toString().trim();
                            
                            // Solo incluir si tiene datos válidos
                            if (reservationCode && clientName && checkIn && checkOut) {
                                const reservation = reservationsMap.get(reservationCode);
                                if (reservation) {
                                    reservationsToSync.push(reservation);
                                }
                            }
                        });
                        
                        console.log(`📋 ${reservationsToSync.length} reservas válidas para sincronizar`);
                        
                        // Subir en lotes de 10 para mayor velocidad
                        const batchSize = 10;
                        for (let i = 0; i < reservationsToSync.length; i += batchSize) {
                            const batch = reservationsToSync.slice(i, i + batchSize);
                            
                            // Procesar el lote en paralelo
                            const promises = batch.map(async (reservation) => {
                                try {
                                    // Validar que tenga datos requeridos
                                    if (!reservation.reservationCode || !reservation.clientName) {
                                        console.warn('⚠️ Reserva sin datos requeridos, saltando:', reservation);
                                        return { success: false, skipped: true };
                                    }
                                    
                                    // Convertir a formato snake_case para Supabase
                                    const supabaseReservation = {
                                        reservation_code: reservation.reservationCode,
                                        client_name: reservation.clientName,
                                        client_email: reservation.clientEmail || '',
                                        client_phone: reservation.clientPhone || '',
                                        hotel_id: reservation.hotelId || null,
                                        hotel_name: reservation.hotelName || '',
                                        check_in: reservation.checkIn,
                                        check_out: reservation.checkOut,
                                        reservation_date: reservation.reservationDate || reservation.checkIn,
                                        agent_name: reservation.agentName || '',
                                        status: reservation.status || 'Confirmada',
                                        total_amount: parseFloat(reservation.totalAmount) || 0
                                    };
                                    
                                    await window.supabaseClient.createReservation(supabaseReservation);
                                    return { success: true };
                                } catch (error) {
                                    console.error('Error sincronizando reserva:', reservation.reservationCode, error.message);
                                    return { success: false, error: error.message };
                                }
                            });
                            
                            const results = await Promise.all(promises);
                            const successCount = results.filter(r => r.success).length;
                            syncCount += successCount;
                            syncErrors += results.filter(r => !r.success && !r.skipped).length;
                            
                            // Log progreso
                            console.log(`📤 Progreso: ${Math.min(i + batchSize, reservationsToSync.length)}/${reservationsToSync.length} procesadas (${syncCount} OK)`);
                        }
                        
                        if (syncErrors > 0) {
                            console.warn(`⚠️ ${syncErrors} reservas no se pudieron sincronizar con Supabase`);
                        } else {
                            console.log(`✅ ${syncCount} reservas sincronizadas con Supabase exitosamente`);
                            syncSuccess = true;
                        }
                    } else if (totalToSync === 0) {
                        console.log('ℹ️ No hay reservas nuevas para sincronizar');
                    }
                    
                    // Mostrar resumen
                    let message = `✅ Importación completada:\n`;
                    message += `• ${added} reservas agregadas\n`;
                    message += `• ${updated} reservas actualizadas\n`;
                    if (syncSuccess) {
                        message += `• ☁️ Sincronizadas con la nube\n`;
                    }
                    if (errors > 0) {
                        message += `• ${errors} errores encontrados\n\n`;
                        message += `Errores:\n${errorMessages.slice(0, 5).join('\n')}`;
                        if (errorMessages.length > 5) {
                            message += `\n... y ${errorMessages.length - 5} más`;
                        }
                    }
                    
                    alert(message);
                    
                    // Cerrar modal
                    closeImportReservationsModal();
                    
                    // Esperar un momento antes de recargar para que Supabase procese
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Actualizar tabla y estadísticas
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                    
                    console.log(`✅ Importación completada: ${added} agregadas, ${updated} actualizadas, ${errors} errores`);
                    
                } catch (error) {
                    console.error('❌ Error al procesar archivo:', error);
                    alert('❌ Error al procesar el archivo Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('❌ Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Función para refrescar reservas
        function refreshReservations() {
            console.log('🔄 Refrescando reservas...');
            loadReservationsTable();
            updateReservationsStats();
        }

        // Función para eliminar todas las reservas
        function deleteAllReservations() {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            console.log('🗑️ Eliminando todas las reservas...');
            
            // Obtener cantidad de reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const count = reservations.length;
            
            if (count === 0) {
                alert('ℹ️ No hay reservas para eliminar');
                return;
            }
            
            // Primera confirmación
            const confirmMessage = `⚠️ ¿Estás seguro de que quieres eliminar TODAS las reservas?\n\n` +
                                 `Se eliminarán ${count} reserva(s).\n\n` +
                                 `Esta acción NO se puede deshacer.\n\n` +
                                 `Escribe "ELIMINAR" para confirmar:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === null) {
                // Usuario canceló
                console.log('❌ Eliminación cancelada por el usuario');
                return;
            }
            
            if (userInput.trim().toUpperCase() !== 'ELIMINAR') {
                alert('❌ Confirmación incorrecta. La eliminación fue cancelada.');
                console.log('❌ Confirmación incorrecta');
                return;
            }
            
            // Segunda confirmación
            if (!confirm(`⚠️ ÚLTIMA CONFIRMACIÓN\n\n¿Realmente quieres eliminar las ${count} reserva(s)?\n\nEsta acción es IRREVERSIBLE.`)) {
                console.log('❌ Eliminación cancelada en segunda confirmación');
                return;
            }
            
            try {
                // Eliminar todas las reservas
                localStorage.setItem('reservationsDB', JSON.stringify([]));
                
                console.log(`✅ ${count} reserva(s) eliminada(s) correctamente`);
                alert(`✅ ${count} reserva(s) eliminada(s) correctamente`);
                
                // Actualizar tabla y estadísticas
                if (typeof loadReservationsTable === 'function') {
                    loadReservationsTable();
                }
                if (typeof updateReservationsStats === 'function') {
                    updateReservationsStats();
                }
                
                // Actualizar ventas mensuales si el dashboard está visible
                if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                    loadMonthlySales();
                }
                
                // Actualizar gastos mensuales si el dashboard está visible
                if (currentSection === 'dashboard' && typeof loadMonthlyExpenses === 'function') {
                    loadMonthlyExpenses();
                }
                
            } catch (error) {
                console.error('❌ Error al eliminar reservas:', error);
                alert('❌ Error al eliminar reservas: ' + error.message);
            }
        }

        // Función auxiliar para formatear fechas
        // Evita problemas de zona horaria parseando manualmente fechas YYYY-MM-DD
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            // Si la fecha está en formato YYYY-MM-DD, parsearla manualmente para evitar problemas de zona horaria
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                const [year, month, day] = dateString.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                return date.toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // Para otros formatos, usar el método estándar
            try {
            const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Fecha inválida';
            return date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            } catch (e) {
                console.error('Error formateando fecha:', dateString, e);
                return 'Fecha inválida';
            }
        }

        // Función para generar código de reserva automático
        function generateReservationCode() {
            const year = new Date().getFullYear();
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const nextNumber = reservations.length + 1;
            return `RES-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Función para cargar hoteles en el select de edición
        function loadHotelsForEdit(selectedHotelId = '') {
            const hotelSelect = document.getElementById('editHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                option.selected = hotel.id === selectedHotelId;
                hotelSelect.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el select de edición`);
        }

        // Función para cargar agentes en el select de edición
        async function loadAgentsForEdit(selectedAgentName = '') {
            const agentSelect = document.getElementById('editAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes de Supabase primero, luego localStorage
            let agents = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    agents = await window.supabaseClient.getAgents();
                } catch (error) {
                    console.error('Error cargando agentes de Supabase:', error);
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
            } else {
                agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            }
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.status !== 'Inactivo' && agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('⚠️ No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                // Soportar ambas estructuras de tabla (code/agency o role)
                const agentCode = agent.code || '';
                const agentAgency = agent.agency || agent.role || '';
                option.textContent = agentCode ? `${agentCode} - ${agent.name} (${agentAgency})` : `${agent.name} (${agentAgency})`;
                option.selected = agent.name === selectedAgentName;
                agentSelect.appendChild(option);
            });
            
            console.log(`✅ ${activeAgents.length} agentes cargados en el select de edición`);
        }

        // Función para cerrar modal de edición de reservas
        function closeEditReservationModal() {
            const modal = document.getElementById('editReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para cancelar una reserva
        async function cancelReservation() {
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('❌ ID de reserva no encontrado');
                alert('❌ Error: ID de reserva no encontrado');
                return;
            }
            
            // Confirmar cancelación
            if (!confirm('¿Estás seguro de que quieres cancelar esta reserva?')) {
                return;
            }
            
            console.log('🚫 Cancelando reserva:', reservationId);
            
            // Datos a actualizar
            const updates = {
                status: 'Cancelada',
                updated_at: new Date().toISOString()
            };
            
            try {
                // Intentar actualizar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateReservation(reservationId, updates);
                    console.log('✅ Reserva cancelada en Supabase');
                    alert('✅ Reserva cancelada correctamente');
                    
                    // Cerrar modal y recargar tabla
                    closeEditReservationModal();
                    loadReservationsTable();
                    updateReservationsStats();
                    return;
                }
            } catch (error) {
                console.error('❌ Error cancelando en Supabase:', error);
            }
            
            // Fallback a localStorage
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId || r.id == reservationId);
            
            if (reservationIndex !== -1) {
                // Cambiar el estado a "Cancelada"
                reservations[reservationIndex].status = 'Cancelada';
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar última actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('✅ Reserva cancelada correctamente');
                alert('✅ Reserva cancelada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('❌ Reserva no encontrada para cancelar');
                alert('❌ Error: Reserva no encontrada');
            }
        }

        // Función para guardar cambios de la reserva
        async function saveReservationChanges(event) {
            event.preventDefault();
            
            console.log('💾 Guardando cambios de la reserva...');
            
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('❌ ID de reserva no encontrado');
                alert('❌ Error: ID de reserva no encontrado');
                return;
            }
            
            // Obtener datos del formulario - Solo tarifa y fechas son editables
            const formData = new FormData(form);
            let checkIn = formData.get('checkIn');
            let checkOut = formData.get('checkOut');
            const totalAmount = parseInt(formData.get('totalAmount'));
            
            // Validar campos requeridos
            if (!checkIn || !checkOut || !totalAmount || totalAmount <= 0) {
                alert('❌ Por favor completa todos los campos requeridos (fechas y tarifa)');
                return;
            }
            
            // Asegurar que las fechas estén en formato YYYY-MM-DD
            if (!/^\d{4}-\d{2}-\d{2}$/.test(checkIn) || !/^\d{4}-\d{2}-\d{2}$/.test(checkOut)) {
                console.error('Formato de fecha inválido:', { checkIn, checkOut });
                alert('❌ Error: Formato de fecha inválido. Por favor, selecciona las fechas nuevamente.');
                return;
            }
            
            // Validar fechas
            if (checkOut <= checkIn) {
                alert('❌ La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            // Datos a actualizar (usando snake_case para Supabase)
            const updates = {
                check_in: checkIn,
                check_out: checkOut,
                total_amount: totalAmount,
                status: 'Modificada',
                updated_at: new Date().toISOString()
            };
            
            console.log('📦 Actualizando reserva:', reservationId, updates);
            
            try {
                // Intentar actualizar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateReservation(reservationId, updates);
                    console.log('✅ Reserva actualizada en Supabase');
                    alert('✅ Reserva actualizada correctamente');
                    
                    // Cerrar modal y recargar tabla
                    closeEditReservationModal();
                    loadReservationsTable();
                    updateReservationsStats();
                    return;
                }
            } catch (error) {
                console.error('❌ Error actualizando en Supabase:', error);
            }
            
            // Fallback a localStorage
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId || r.id == reservationId);
            
            if (reservationIndex !== -1) {
                // Obtener la reserva actual para mantener datos no editables
                const currentReservation = reservations[reservationIndex];
                
                // Obtener reservationDate del formulario si existe
                const reservationDate = formData.get('reservationDate');
                
                // Actualizar solo tarifa y fechas (campos editables)
                // Asegurar que las fechas se guarden en formato correcto (YYYY-MM-DD)
                reservations[reservationIndex].checkIn = checkIn;
                reservations[reservationIndex].checkOut = checkOut;
                reservations[reservationIndex].totalAmount = totalAmount;
                if (reservationDate) {
                    reservations[reservationIndex].reservationDate = reservationDate;
                }
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                // Cambiar el estado a "Modificada" cuando se modifica una reserva
                // Si estaba cancelada, cambiar a "Modificada" (celeste)
                // Si estaba confirmada, cambiar a "Modificada" (celeste)
                if (currentReservation.status === 'Cancelada' || currentReservation.status === 'Confirmada' || currentReservation.status === 'Modificada') {
                    reservations[reservationIndex].status = 'Modificada';
                }
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar última actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('✅ Reserva modificada correctamente');
                console.log('📅 Fechas actualizadas:', { checkIn, checkOut });
                alert('✅ Reserva modificada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('❌ Reserva no encontrada para actualizar');
                alert('❌ Error: Reserva no encontrada');
            }
        }

        // Función auxiliar para obtener nombre del hotel por ID
        async function getHotelNameById(hotelId) {
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    hotels = await window.supabaseClient.getHotels();
                } catch (error) {
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            const hotel = hotels.find(h => h.id === hotelId);
            return hotel ? hotel.name : 'Hotel no encontrado';
        }

        // Función para cargar hoteles en el select de nueva reserva
        async function loadHotelsForNewReservation() {
            const hotelSelect = document.getElementById('newHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles de Supabase (tienen UUIDs válidos)
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    hotels = await window.supabaseClient.getHotels();
                } catch (error) {
                    console.error('Error cargando hoteles de Supabase:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                hotelSelect.appendChild(option);
            });
            
            console.log(`✅ ${hotels.length} hoteles cargados en el select de nueva reserva`);
        }

        // Función para cargar agentes en el select de nueva reserva
        async function loadAgentsForNewReservation() {
            const agentSelect = document.getElementById('newAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes de Supabase
            let agents = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    agents = await window.supabaseClient.getAgents();
                } catch (error) {
                    console.error('Error cargando agentes de Supabase:', error);
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
            } else {
                agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            }
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.status !== 'Inactivo' && agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('⚠️ No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                // Soportar ambas estructuras de tabla (code/agency o role)
                const agentCode = agent.code || '';
                const agentAgency = agent.agency || agent.role || '';
                option.textContent = agentCode ? `${agentCode} - ${agent.name} (${agentAgency})` : `${agent.name} (${agentAgency})`;
                agentSelect.appendChild(option);
            });
            
            console.log(`✅ ${activeAgents.length} agentes cargados en el select de nueva reserva`);
        }

        // Función para cerrar modal de nueva reserva
        function closeNewReservationModal() {
            const modal = document.getElementById('newReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para generar código de agente automático
        function generateAgentCode() {
            const year = new Date().getFullYear();
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            const nextNumber = agents.length + 1;
            return `AGT-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Función para abrir modal de nuevo agente
        function addNewAgent() {
            console.log('👤 Abriendo formulario para nuevo agente...');
            
            // Limpiar el formulario
            const form = document.getElementById('newAgentForm');
            if (form) {
                form.reset();
            }
            
            // Generar código de agente automático
            const agentCodeInput = document.getElementById('newAgentCode');
            if (agentCodeInput) {
                agentCodeInput.value = generateAgentCode();
            }
            
            // Mostrar el modal
            document.getElementById('newAgentModal').style.display = 'block';
            
            console.log('✅ Modal de nuevo agente abierto');
        }

        // Función para cerrar modal de nuevo agente
        function closeNewAgentModal() {
            const modal = document.getElementById('newAgentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para guardar nuevo agente
        async function saveNewAgent(event) {
            event.preventDefault();
            
            console.log('💾 Guardando nuevo agente...');
            
            const form = document.getElementById('newAgentForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const agentData = {
                code: formData.get('agentCode'),
                name: formData.get('agentName'),
                agency: formData.get('agentAgency'),
                status: 'Activo',
                commission_rate: 0
            };
            
            // Validar campos requeridos
            if (!agentData.code || !agentData.name || !agentData.agency) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            try {
                let newAgent;
                
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Guardando agente en Supabase...');
                    newAgent = await window.supabaseClient.createAgent(agentData);
                    console.log('✅ Agente guardado en Supabase:', newAgent);
                } else {
                    // Fallback a localStorage
                    console.log('💾 Guardando agente en localStorage...');
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    
                    // Verificar si el código ya existe
                    const existingAgent = agents.find(a => a.code === agentData.code);
                    if (existingAgent) {
                        alert('❌ Ya existe un agente con este código. Se generará un nuevo código.');
                        agentData.code = generateAgentCode();
                        document.getElementById('newAgentCode').value = agentData.code;
                    }
                    
                    newAgent = {
                        id: 'agent-' + Date.now(),
                        ...agentData,
                        active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    agents.push(newAgent);
                    localStorage.setItem('agentsDB', JSON.stringify(agents));
                }
                
                console.log('✅ Nuevo agente guardado:', newAgent);
                
                // Cerrar modal
                closeNewAgentModal();
                
                // Mostrar mensaje de éxito
                alert('✅ Agente creado exitosamente');
                
            } catch (error) {
                console.error('❌ Error guardando agente:', error);
                alert('❌ Error al guardar el agente: ' + error.message);
            }
            
            // Recargar agentes en el select de reservas si está abierto
            const agentSelect = document.getElementById('newAgentSelect');
            if (agentSelect) {
                loadAgentsForNewReservation();
            }
            
            // Recargar tabla de agentes si está visible
            if (document.getElementById('agents-section')?.style.display !== 'none') {
                loadAgentsTable();
            }
        }

        // ============================================
        // GESTIÓN DE AGENTES
        // ============================================

        // Función para cargar tabla de agentes
        async function loadAgentsTable() {
            console.log('📋 Cargando tabla de agentes...');
            
            const tbody = document.getElementById('agentsTableBody');
            if (!tbody) {
                console.log('⚠️ Tabla de agentes no encontrada');
                return;
            }
            
            // Mostrar loading
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span> Cargando agentes...</td></tr>';
            
            try {
                // Obtener agentes de Supabase
                let agents = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Cargando agentes desde Supabase...');
                    agents = await window.supabaseClient.getAgents();
                    console.log(`✅ ${agents.length} agentes cargados de Supabase`);
                } else {
                    console.log('💾 Cargando agentes desde localStorage...');
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
                
                // Actualizar estadísticas
                updateAgentsStats(agents);
                
                if (agents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No hay agentes registrados. Haz clic en "Nuevo Agente" para crear uno.</td></tr>';
                    return;
                }
                
                // Obtener reservas para contar por agente
                let reservations = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        reservations = await window.supabaseClient.getReservations();
                    } catch (e) {
                        reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    }
                } else {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                // Ordenar por fecha de creación (más recientes primero)
                const sortedAgents = agents.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                
                tbody.innerHTML = sortedAgents.map(agent => {
                    const createdDate = agent.created_at ? new Date(agent.created_at).toLocaleDateString('es-ES') : 'N/A';
                    const isActive = agent.status !== 'Inactivo' && agent.active !== false;
                    
                    // Contar reservas del agente
                    const agentReservations = reservations.filter(r => 
                        r.agent_name === agent.name || 
                        r.agentName === agent.name || 
                        r.agent === agent.name
                    ).length;
                    
                    // Soportar ambas estructuras de tabla
                    const agentCode = agent.code || 'N/A';
                    const agentAgency = agent.agency || agent.role || 'Sin agencia';
                    
                    return `
                        <tr>
                            <td style="padding: 12px;"><strong>${agentCode}</strong></td>
                            <td style="padding: 12px;">${agent.name || 'Sin nombre'}</td>
                            <td style="padding: 12px;">${agentAgency}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="
                                    display: inline-block;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    background: ${isActive ? '#e8f5e9' : '#ffebee'};
                                    color: ${isActive ? '#2e7d32' : '#c62828'};
                                ">${isActive ? 'Activo' : 'Inactivo'}</span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="
                                    display: inline-block;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    background: #e3f2fd;
                                    color: #1565c0;
                                ">${agentReservations}</span>
                            </td>
                            <td style="padding: 12px;">${createdDate}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="editAgent('${agent.id}')" style="
                                    background: #2196f3;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    margin-right: 4px;
                                " title="Editar agente">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                                </button>
                                <button onclick="deleteAgent('${agent.id}', '${agent.name}')" style="
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                " title="Eliminar agente">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log(`✅ ${agents.length} agentes mostrados en la tabla`);
                
            } catch (error) {
                console.error('❌ Error cargando agentes:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">Error al cargar agentes. Intenta actualizar la página.</td></tr>';
            }
        }

        // Función para actualizar estadísticas de agentes
        function updateAgentsStats(agents) {
            const totalAgents = agents.length;
            const activeAgents = agents.filter(a => a.status !== 'Inactivo' && a.active !== false).length;
            const inactiveAgents = totalAgents - activeAgents;
            
            const totalEl = document.getElementById('totalAgents');
            const activeEl = document.getElementById('activeAgents');
            const inactiveEl = document.getElementById('inactiveAgents');
            
            if (totalEl) totalEl.textContent = totalAgents;
            if (activeEl) activeEl.textContent = activeAgents;
            if (inactiveEl) inactiveEl.textContent = inactiveAgents;
        }

        // Función para editar agente
        async function editAgent(agentId) {
            console.log('✏️ Editando agente:', agentId);
            
            try {
                // Obtener agentes
                let agents = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    agents = await window.supabaseClient.getAgents();
                } else {
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
                
                const agent = agents.find(a => a.id === agentId || a.id == agentId);
                
                if (!agent) {
                    console.error('❌ Agente no encontrado:', agentId);
                    alert('❌ Agente no encontrado');
                    return;
                }
                
                // Rellenar formulario de edición (soportar ambas estructuras)
                document.getElementById('editAgentId').value = agent.id;
                document.getElementById('editAgentCode').value = agent.code || '';
                document.getElementById('editAgentName').value = agent.name || '';
                document.getElementById('editAgentAgency').value = agent.agency || agent.role || '';
                document.getElementById('editAgentStatus').value = (agent.status === 'Inactivo' || agent.active === false) ? 'Inactivo' : 'Activo';
                
                // Mostrar modal
                document.getElementById('editAgentModal').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Error al cargar agente para edición:', error);
                alert('❌ Error al cargar los datos del agente');
            }
        }

        // Función para cerrar modal de edición de agente
        function closeEditAgentModal() {
            const modal = document.getElementById('editAgentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Función para guardar agente editado
        async function saveEditedAgent(event) {
            event.preventDefault();
            
            const agentId = document.getElementById('editAgentId').value;
            const updates = {
                name: document.getElementById('editAgentName').value,
                agency: document.getElementById('editAgentAgency').value,
                status: document.getElementById('editAgentStatus').value,
                active: document.getElementById('editAgentStatus').value === 'Activo'
            };
            
            console.log('💾 Guardando cambios del agente:', agentId, updates);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateAgent(agentId, updates);
                    console.log('✅ Agente actualizado en Supabase');
                } else {
                    // Fallback a localStorage
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    const index = agents.findIndex(a => a.id === agentId || a.id == agentId);
                    if (index !== -1) {
                        agents[index] = { ...agents[index], ...updates, updated_at: new Date().toISOString() };
                        localStorage.setItem('agentsDB', JSON.stringify(agents));
                    }
                }
                
                // Cerrar modal
                closeEditAgentModal();
                
                // Mostrar mensaje de éxito
                alert('✅ Agente actualizado correctamente');
                
                // Recargar tabla
                loadAgentsTable();
                
                // También actualizar el select de agentes si está abierto
                if (document.getElementById('newAgentSelect')) {
                    loadAgentsForNewReservation();
                }
                
            } catch (error) {
                console.error('❌ Error actualizando agente:', error);
                alert('❌ Error al actualizar el agente: ' + error.message);
            }
        }

        // Función para eliminar agente
        async function deleteAgent(agentId, agentName) {
            if (!confirm(`¿Estás seguro de que deseas eliminar al agente "${agentName}"?\n\nEsta acción no se puede deshacer.`)) {
                return;
            }
            
            console.log('🗑️ Eliminando agente:', agentId);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.deleteAgent(agentId);
                    console.log('✅ Agente eliminado de Supabase');
                } else {
                    // Fallback a localStorage
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    const filtered = agents.filter(a => a.id !== agentId && a.id != agentId);
                    localStorage.setItem('agentsDB', JSON.stringify(filtered));
                }
                
                // Mostrar mensaje de éxito
                alert('✅ Agente eliminado correctamente');
                
                // Recargar tabla
                loadAgentsTable();
                
                // También actualizar el select de agentes si está abierto
                if (document.getElementById('newAgentSelect')) {
                    loadAgentsForNewReservation();
                }
                
            } catch (error) {
                console.error('❌ Error eliminando agente:', error);
                alert('❌ Error al eliminar el agente: ' + error.message);
            }
        }

        // Función para refrescar agentes
        async function refreshAgents() {
            console.log('🔄 Actualizando lista de agentes...');
            await loadAgentsTable();
            alert('✅ Lista de agentes actualizada');
        }

        // Función para guardar nueva reserva
        async function saveNewReservation(event) {
            event.preventDefault();
            
            console.log('💾 Guardando nueva reserva...');
            
            const form = document.getElementById('newReservationForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const reservationCode = formData.get('reservationCode') || generateReservationCode();
            const hotelId = formData.get('hotelId');
            const hotelName = await getHotelNameById(hotelId);
            
            // Datos para Supabase (snake_case)
            const reservationData = {
                reservation_code: reservationCode,
                client_name: formData.get('clientName'),
                client_email: formData.get('clientEmail'),
                client_phone: formData.get('clientPhone'),
                hotel_id: hotelId,
                hotel_name: hotelName,
                check_in: formData.get('checkIn'),
                check_out: formData.get('checkOut'),
                reservation_date: formData.get('reservationDate') || new Date().toISOString().split('T')[0],
                agent_name: formData.get('agentName') || '',
                status: 'Confirmada',
                total_amount: parseInt(formData.get('totalAmount')) || 0
            };
            
            // Validar campos requeridos
            if (!reservationData.client_name || !reservationData.client_email || !reservationData.client_phone || !reservationData.hotel_id || 
                !reservationData.check_in || !reservationData.check_out) {
                alert('❌ Por favor completa todos los campos requeridos');
                return;
            }
            
            // Validar fechas
            if (reservationData.check_out <= reservationData.check_in) {
                alert('❌ La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            try {
                let newReservation;
                
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Guardando reserva en Supabase...');
                    newReservation = await window.supabaseClient.createReservation(reservationData);
                    console.log('✅ Reserva guardada en Supabase:', newReservation);
                } else {
                    // Fallback a localStorage (con formato camelCase para compatibilidad)
                    console.log('💾 Guardando reserva en localStorage...');
                    newReservation = {
                        id: 'res-' + Date.now(),
                        reservationCode: reservationCode,
                        clientName: reservationData.client_name,
                        clientEmail: reservationData.client_email,
                        clientPhone: reservationData.client_phone,
                        hotelId: reservationData.hotel_id,
                        hotelName: reservationData.hotel_name,
                        checkIn: reservationData.check_in,
                        checkOut: reservationData.check_out,
                        reservationDate: reservationData.reservation_date,
                        agentName: reservationData.agent_name,
                        status: reservationData.status,
                        totalAmount: reservationData.total_amount,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    reservations.push(newReservation);
                    localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                }
                
                // Guardar o actualizar usuario en Gestión de Usuarios
                saveUserFromReservation({
                    clientName: reservationData.client_name,
                    clientEmail: reservationData.client_email,
                    clientPhone: reservationData.client_phone
                });
                
                console.log('✅ Nueva reserva creada:', newReservation);
                alert(`✅ Reserva ${reservationCode} creada correctamente`);
                
                // Cerrar modal
                closeNewReservationModal();
                
                // Actualizar tabla y estadísticas
                loadReservationsTable();
                updateReservationsStats();
                
            } catch (error) {
                console.error('❌ Error guardando reserva:', error);
                alert('❌ Error al guardar la reserva: ' + error.message);
            }
        }

        // Función para guardar usuario desde una reserva (con deduplicación por email Y teléfono)
        async function saveUserFromReservation(reservationData) {
            try {
                const email = (reservationData.clientEmail || reservationData.client_email || '').trim();
                const phone = (reservationData.clientPhone || reservationData.client_phone || '').trim();
                const name = (reservationData.clientName || reservationData.client_name || '').trim();
                
                // Si no hay email ni teléfono, no guardar
                if (!email && !phone) {
                    console.log('⚠️ Usuario sin email ni teléfono, no se guarda');
                    return null;
                }
                
                console.log('💾 Guardando usuario desde reserva:', { name, email, phone });
                
                // Usar Supabase si está disponible
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    const result = await window.supabaseClient.upsertUser({ name, email, phone });
                    return result;
                }
                
                // Fallback a localStorage con deduplicación mejorada
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`👥 Usuarios existentes: ${users.length}`);
                
                // Buscar usuario existente por email O teléfono
                const existingIndex = users.findIndex(user => {
                    const emailMatch = email && user.email && user.email.toLowerCase() === email.toLowerCase();
                    const phoneMatch = phone && user.phone && user.phone === phone;
                    return emailMatch || phoneMatch;
                });
            
                if (existingIndex !== -1) {
                    // Actualizar usuario existente - agregar campos faltantes
                    const existingUser = users[existingIndex];
                    let updated = false;
                    
                    if (!existingUser.email && email) {
                        existingUser.email = email;
                        updated = true;
                    }
                    if (!existingUser.phone && phone) {
                        existingUser.phone = phone;
                        updated = true;
                    }
                    if (!existingUser.name && name) {
                        existingUser.name = name;
                        updated = true;
                    }
                    
                    existingUser.last_activity = new Date().toISOString();
                    existingUser.updatedAt = new Date().toISOString();
                    users[existingIndex] = existingUser;
                    
                    if (updated) {
                        console.log('🔄 Usuario actualizado con campos faltantes:', existingUser.email || existingUser.phone);
            } else {
                        console.log('ℹ️ Usuario ya existe, sin cambios:', existingUser.email || existingUser.phone);
                    }
                    
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    return existingUser;
                } else {
                    // Crear nuevo usuario
                    const maxId = users.reduce((max, u) => Math.max(max, parseInt(u.id) || 0), 0);
                    const newUser = {
                        id: maxId + 1,
                        name: name,
                        email: email || null,
                        phone: phone || null,
                        status: 'active',
                        is_active: true,
                        createdAt: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        last_activity: new Date().toISOString(),
                        rewards_points: 0,
                        tipoCuenta: 'cliente_reserva',
                        avatar_url: null
                    };
                    
                    users.push(newUser);
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log('✅ Nuevo usuario creado:', newUser.email || newUser.phone);
                    return newUser;
            }
                
            } catch (error) {
                console.error('❌ Error al guardar usuario desde reserva:', error);
                return null;
            }
        }
        
        // Función para actualizar la última actividad de un usuario
        function updateUserActivity(userEmail) {
            try {
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const userIndex = users.findIndex(user => 
                    user.email && user.email.toLowerCase() === userEmail.toLowerCase()
                );
                
                if (userIndex !== -1) {
                    users[userIndex].last_activity = new Date().toISOString();
                    users[userIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log('🔄 Última actividad actualizada para:', userEmail);
                }
            } catch (error) {
                console.error('❌ Error al actualizar actividad del usuario:', error);
            }
        }
        
        // Función para actualizar usuarios desde reservas existentes
        async function updateUsersFromReservations() {
            try {
                console.log('🔄 Actualizando usuarios desde reservas...');
                
                // Obtener todas las reservas - primero de Supabase, luego de localStorage
                let reservations = [];
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const supabaseReservations = await window.supabaseClient.getReservations();
                        if (supabaseReservations && supabaseReservations.length > 0) {
                            console.log(`☁️ ${supabaseReservations.length} reservas cargadas de Supabase`);
                            reservations = supabaseReservations;
                        }
                    } catch (e) {
                        console.warn('⚠️ Error cargando de Supabase:', e);
                    }
                }
                
                // Si no hay de Supabase, usar localStorage
                if (reservations.length === 0) {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                console.log(`📋 Encontradas ${reservations.length} reservas`);
            
                if (reservations.length === 0) {
                    alert('ℹ️ No hay reservas para procesar');
                return;
            }
            
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`👥 Usuarios existentes: ${users.length}`);
                
                // Crear set de identificadores existentes (emails y nombres)
                const existingEmails = new Set();
                users.forEach(user => {
                    if (user.email) existingEmails.add(user.email.toLowerCase());
                    if (user.name) existingEmails.add(user.name.toLowerCase().trim());
                });
                
                let newUsersCount = 0;
                let updatedUsersCount = 0;
                const processedEmails = new Set(); // Para evitar procesar el mismo email múltiples veces
                
                // Procesar cada reserva
                console.log('📋 Procesando reservas...');
                reservations.forEach((reservation, index) => {
                    // Normalizar campos (Supabase usa snake_case, localStorage usa camelCase)
                    const clientEmail = reservation.clientEmail || reservation.client_email || reservation.customer_email || '';
                    const clientName = reservation.clientName || reservation.client_name || reservation.customer_name || '';
                    const clientPhone = reservation.clientPhone || reservation.client_phone || reservation.customer_phone || '';
                    const reservationCode = reservation.reservationCode || reservation.reservation_code || reservation.code || '';
                    
                    console.log(`📝 Procesando reserva ${index + 1}/${reservations.length}:`, {
                        code: reservationCode,
                        name: clientName,
                        email: clientEmail,
                        phone: clientPhone
                    });
                    
                    // Usar nombre como identificador si no hay email
                    const identifier = clientEmail ? clientEmail.toLowerCase() : (clientName ? clientName.toLowerCase().trim() : '');
                    
                    if (!identifier) {
                        console.warn('⚠️ Reserva sin email ni nombre:', reservationCode);
                return;
            }
            
                    console.log(`📧 Identificador procesado: ${identifier}`);
            
                    // Si ya procesamos este identificador en esta ejecución, saltar
                    if (processedEmails.has(identifier)) {
                        console.log(`🔄 Identificador ${identifier} ya procesado`);
                return;
            }
            
                    processedEmails.add(identifier);
                    console.log(`✅ Identificador ${identifier} agregado a procesados`);
                    
                    if (!existingEmails.has(identifier)) {
                        console.log(`🆕 Identificador ${identifier} no existe, creando nuevo usuario...`);
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
        }
        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: clientName,
                            email: clientEmail,
                            phone: clientPhone,
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.created_at || reservation.reservationDate || reservation.reservation_date || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.created_at || reservation.reservationDate || reservation.reservation_date || new Date().toISOString(),
                            last_activity: reservation.updatedAt || reservation.updated_at || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(identifier);
                        newUsersCount++;
                        console.log('✅ Nuevo usuario creado desde reserva:', newUser.name || newUser.email, newUser);
                        } else {
                        // Actualizar última actividad si el usuario ya existe
                        const userIndex = users.findIndex(user => {
                            if (clientEmail && user.email) {
                                return user.email.toLowerCase() === identifier;
                            }
                            // Si no hay email, buscar por nombre
                            return user.name && user.name.toLowerCase().trim() === identifier;
                        });
                        if (userIndex !== -1) {
                            users[userIndex].last_activity = reservation.updatedAt || reservation.updated_at || new Date().toISOString();
                            users[userIndex].updatedAt = new Date().toISOString();
                            // Actualizar datos si están disponibles y faltan
                            if (clientName && !users[userIndex].name) {
                                users[userIndex].name = clientName;
                            }
                            if (clientPhone && !users[userIndex].phone) {
                                users[userIndex].phone = clientPhone;
                            }
                            console.log('🔄 Usuario actualizado:', users[userIndex].email);
                        }
                        updatedUsersCount++;
                    }
                });
                
                // Guardar todos los usuarios actualizados en localStorage
                localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                console.log('💾 Usuarios guardados en localStorage:', users.length);
                
                // Sincronizar a Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized() && newUsersCount > 0) {
                    console.log('☁️ Sincronizando usuarios a Supabase...');
                    for (const user of users) {
                        try {
                            // Usar insert (upsert puede fallar con email vacío)
                            const userData = {
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                last_activity: user.last_activity,
                                tipo_cuenta: user.tipoCuenta || 'cliente_reserva'
                            };
                            
                            // Solo hacer upsert si tiene email, sino insert normal
                            let error;
                            if (user.email) {
                                const result = await window.supabaseClient.client
                                    .from('users')
                                    .upsert(userData, { onConflict: 'email' });
                                error = result.error;
                            } else {
                                const result = await window.supabaseClient.client
                                    .from('users')
                                    .insert(userData);
                                error = result.error;
                            }
                            
                            if (error && !error.message?.includes('duplicate')) {
                                console.warn('⚠️ Error sincronizando usuario:', user.name, error);
                            }
                        } catch (e) {
                            console.warn('⚠️ Error sincronizando usuario:', user.email, e);
                        }
                    }
                    console.log('✅ Usuarios sincronizados a Supabase');
                }
                
                console.log(`✅ Proceso completado: ${newUsersCount} nuevos usuarios, ${updatedUsersCount} usuarios actualizados`);
            
                // Mostrar mensaje de éxito
                alert(`✅ Actualización completada:\n- ${newUsersCount} nuevos usuarios agregados\n- ${updatedUsersCount} usuarios actualizados\n\n☁️ Datos sincronizados con Supabase`);
                
                // Recargar datos de usuarios si estamos en la sección de usuarios
                if (typeof loadUsersData === 'function') {
                    console.log('🔄 Recargando datos de usuarios...');
                    loadUsersData();
            } else {
                    console.warn('⚠️ Función loadUsersData no encontrada');
                    }
                
                } catch (error) {
                console.error('❌ Error al actualizar usuarios desde reservas:', error);
                alert('❌ Error al actualizar usuarios: ' + error.message);
            }
        }

        // ===== FUNCIONES PARA GESTIÓN DE GASTOS =====
        
        // Categorías de gastos
        const expenseCategories = {
            'sueldos': 'Sueldos',
            'servicios': 'Servicios',
            'alquiler': 'Alquiler',
            'telefonia': 'Telefonía',
            'publicidad_meta': 'Publicidad Meta',
            'gastos_bancario': 'Gastos Bancario',
            'tecnologia_oficina': 'Tecnología de Oficina',
            'varios': 'Varios'
        };

        // Inicializar base de datos de gastos
        function initExpensesDB() {
            console.log('💰 Inicializando base de datos de gastos...');
            const existingExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            console.log(`📊 Estado inicial: ${existingExpenses.length} gastos en localStorage`);
            
            // Inicializar presupuestos si no existen
            if (!localStorage.getItem('expensesBudget')) {
                const defaultBudget = {
                    monthly: 50000,
                    quarterly: 150000,
                    yearly: 600000
                };
                localStorage.setItem('expensesBudget', JSON.stringify(defaultBudget));
            }
        }

        // Cargar todos los datos de gastos - VERSIÓN ACTUALIZADA CON FORZADO DE DIMENSIONES
        window.loadExpensesData = function loadExpensesData() {
            console.log('🔍 ============================================');
            console.log('🔍 VERSIÓN ACTUALIZADA de loadExpensesData ejecutándose...');
            console.log('🔍 Timestamp:', new Date().toISOString());
            console.log('🔍 ============================================');
            console.log('💰 Cargando datos de gastos...');
            
            // FORZAR DIMENSIONES PRIMERO (antes de cargar datos)
            console.log('🔧 FORZANDO DIMENSIONES desde loadExpensesData...');
            if (typeof window.forceExpensesSectionDimensions === 'function') {
                console.log('✅ forceExpensesSectionDimensions disponible, ejecutando...');
                window.forceExpensesSectionDimensions();
                // Ejecutar múltiples veces para asegurar
                requestAnimationFrame(() => {
                    window.forceExpensesSectionDimensions();
                });
                setTimeout(() => {
                    window.forceExpensesSectionDimensions();
                }, 100);
            } else {
                console.warn('⚠️ forceExpensesSectionDimensions NO disponible, usando fallback manual...');
                // Fallback manual
                const mainContent = document.querySelector('.main-content');
                const expensesSection = document.getElementById('expenses-section');
                if (mainContent && expensesSection) {
                    const viewportWidth = window.innerWidth;
                    const sidebarWidth = 220;
                    const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                    const availableWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                    
                    mainContent.style.cssText = `display: block !important; width: ${mainWidth}px !important; min-width: ${mainWidth}px !important; margin-left: ${sidebarWidth}px !important; flex: 1 !important; position: relative !important; visibility: visible !important; overflow: visible !important;`;
                    expensesSection.style.cssText = `display: block !important; width: ${availableWidth}px !important; min-width: ${availableWidth}px !important; max-width: ${availableWidth}px !important; visibility: visible !important; position: relative !important; padding: 20px !important; box-sizing: border-box !important; overflow: visible !important;`;
                    void mainContent.offsetHeight;
                    void expensesSection.offsetHeight;
                }
            }
            
            console.log('🔍 Verificando si loadExpensesTable existe:', typeof loadExpensesTable);
            try {
                if (typeof loadExpensesTable === 'function') {
                    console.log('✅ Llamando a loadExpensesTable...');
                    loadExpensesTable().catch(err => {
                        console.error('❌ Error en loadExpensesTable:', err);
                    });
                } else {
                    console.error('❌ loadExpensesTable no es una función');
                }
            } catch (error) {
                console.error('❌ Error al llamar loadExpensesTable:', error);
            }
            if (typeof updateExpensesKPIs === 'function') {
                updateExpensesKPIs();
            }
            if (typeof updateExpensesCharts === 'function') {
                updateExpensesCharts();
            }
        };

        // Actualizar categorías según tipo de gasto
        function updateExpenseCategories() {
            const categorySelect = document.getElementById('expenseCategory');
            categorySelect.innerHTML = '<option value="">Seleccionar categoría</option>';
            
            // Mostrar todas las categorías sin importar el tipo de gasto
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categorySelect.appendChild(option);
            });
        }

        // Abrir modal para agregar gasto
        function addNewExpense() {
            document.getElementById('expenseModalTitle').textContent = 'Agregar Gasto';
            document.getElementById('expenseForm').reset();
            // IMPORTANTE: Limpiar el expenseId para evitar sobrescribir gastos existentes
            delete document.getElementById('expenseForm').dataset.expenseId;
            
            // Usar fecha de Argentina
            const argentinaDate = new Date().toLocaleDateString('en-CA', { 
                timeZone: 'America/Argentina/Buenos_Aires' 
            });
            document.getElementById('expenseDate').value = argentinaDate;
            
            // Limpiar campos de tipo de cambio y USD
            document.getElementById('expenseExchangeRate').value = '';
            document.getElementById('expenseUSD').value = '';
            
            // Limpiar campos de imagen
            removeExpenseImage();
            pendingImageFile = null;
            
            // Cargar categorías al abrir el modal
            updateExpenseCategories();
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Cerrar modal de gasto
        function closeExpenseModal() {
            const expenseModal = document.getElementById('expenseModal');
            const expenseForm = document.getElementById('expenseForm');
            if (expenseModal) {
                expenseModal.style.display = 'none';
            }
            if (expenseForm) {
                expenseForm.reset();
                // Limpiar el expenseId al cerrar
                delete expenseForm.dataset.expenseId;
            }
            // Limpiar campos de imagen
            if (typeof removeExpenseImage === 'function') {
                removeExpenseImage();
            }
            pendingImageFile = null;
        }

        // Función para calcular USD automáticamente
        function calculateUSD() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('expenseExchangeRate').value) || 0;
            const usdField = document.getElementById('expenseUSD');
            
            if (exchangeRate > 0) {
                const usd = amount / exchangeRate;
                usdField.value = usd.toFixed(2);
            } else {
                usdField.value = '0.00';
            }
        }
        
        // ============================================
        // FUNCIONES DE IMAGEN PARA GASTOS
        // ============================================
        
        let cameraStream = null;
        let pendingImageFile = null;
        
        // Preview de imagen desde archivo
        function previewExpenseImage(input) {
            const file = input.files[0];
            if (file) {
                pendingImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('expenseImagePreviewImg').src = e.target.result;
                    document.getElementById('expenseImagePreview').style.display = 'block';
                    document.getElementById('expenseImageName').value = file.name;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Eliminar imagen
        function removeExpenseImage() {
            document.getElementById('expenseImagePreview').style.display = 'none';
            document.getElementById('expenseImagePreviewImg').src = '';
            document.getElementById('expenseImageFile').value = '';
            document.getElementById('expenseImageUrl').value = '';
            document.getElementById('expenseImageName').value = '';
            pendingImageFile = null;
        }
        
        // Abrir cámara
        async function openCameraCapture() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraModal').style.display = 'flex';
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                alert('❌ No se pudo acceder a la cámara. Verifica los permisos.');
            }
        }
        
        // Cerrar cámara
        function closeCameraModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').style.display = 'none';
        }
        
        // ============================================
        // FUNCIONES PARA NUEVO MODAL DE GASTOS
        // ============================================
        
        let cameraStreamNew = null;
        let pendingImageFileNew = null;
        
        // Abrir modal para agregar gasto - NUEVO
        function addNewExpenseNew() {
            console.log('🚀 addNewExpenseNew() llamado');
            try {
                // Verificar que estamos en la sección de expenses
                const expensesSection = document.getElementById('expenses-section');
                if (!expensesSection || expensesSection.style.display === 'none') {
                    console.warn('⚠️ No estás en la sección de Gastos. Cambiando a Gastos...');
                    if (typeof window.showSection === 'function') {
                        window.showSection('expenses');
                        // Esperar a que la sección se muestre antes de abrir el modal
                        setTimeout(() => {
                            addNewExpenseNew();
                        }, 300);
                        return;
                    }
                }
                
                const modal = document.getElementById('expenseModalNew');
                if (!modal) {
                    console.error('❌ Modal expenseModalNew no encontrado');
                    alert('❌ Error: Modal no encontrado. Verifica que el código se haya actualizado.');
                    return;
                }
                console.log('✅ Modal encontrado:', modal);
                
                const titleEl = document.getElementById('expenseModalNewTitle');
                const formEl = document.getElementById('expenseFormNew');
                const idEl = document.getElementById('expenseIdNew');
                
                if (!titleEl || !formEl || !idEl) {
                    console.error('❌ Elementos del formulario no encontrados');
                    alert('❌ Error: Elementos del formulario no encontrados');
                    return;
                }
                
                titleEl.textContent = 'Agregar Gasto';
                formEl.reset();
                idEl.value = '';
                
                // Usar fecha de Argentina
                const now = new Date();
                const argentinaDate = new Date(now.toLocaleString('en-US', {timeZone: 'America/Argentina/Buenos_Aires'}));
                const dateStr = argentinaDate.toISOString().split('T')[0];
                const dateEl = document.getElementById('expenseDateNew');
                if (dateEl) dateEl.value = dateStr;
                
                // Limpiar imagen
                if (typeof removeExpenseImageNew === 'function') {
                    removeExpenseImageNew();
                }
                
                // Actualizar categorías
                if (typeof updateExpenseCategoriesNew === 'function') {
                    updateExpenseCategoriesNew();
                }
                
                // Mostrar modal con múltiples métodos
                modal.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; z-index: 10000 !important;';
                
                console.log('✅ Modal mostrado, display:', modal.style.display);
                console.log('✅ Modal computed style:', window.getComputedStyle(modal).display);
            } catch (error) {
                console.error('❌ Error en addNewExpenseNew:', error);
                alert('❌ Error al abrir el modal: ' + error.message);
            }
        }
        
        // Hacer función global
        window.addNewExpenseNew = addNewExpenseNew;
        window.editExpenseNew = editExpenseNew;
        window.closeExpenseModalNew = closeExpenseModalNew;
        window.saveExpenseNew = saveExpenseNew;
        
        // Abrir modal para editar gasto - NUEVO
        async function editExpenseNew(expenseId) {
            let expenses = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    expenses = await window.supabaseClient.getExpenses();
                } catch (error) {
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
            } else {
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            }
            
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) {
                alert('❌ Gasto no encontrado');
                return;
            }
            
            document.getElementById('expenseModalNewTitle').textContent = 'Editar Gasto';
            document.getElementById('expenseIdNew').value = expenseId;
            document.getElementById('expenseDateNew').value = expense.date;
            document.getElementById('expenseTypeNew').value = expense.type;
            updateExpenseCategoriesNew();
            setTimeout(() => {
                document.getElementById('expenseCategoryNew').value = expense.category;
            }, 100);
            document.getElementById('expenseSubcategoryNew').value = expense.subcategory || '';
            document.getElementById('expenseDescriptionNew').value = expense.description || '';
            document.getElementById('expenseAmountNew').value = expense.amount || '';
            document.getElementById('expenseExchangeRateNew').value = expense.exchange_rate || expense.exchangeRate || '';
            calculateUSDNew();
            
            // Cargar imagen si existe
            if (expense.image_url || expense.imageUrl) {
                document.getElementById('expenseImageUrlNew').value = expense.image_url || expense.imageUrl;
                document.getElementById('expenseImagePreviewImgNew').src = expense.image_url || expense.imageUrl;
                document.getElementById('expenseImagePreviewNew').style.display = 'block';
            } else {
                removeExpenseImageNew();
            }
            
            document.getElementById('expenseModalNew').style.display = 'flex';
        }
        
        // Cerrar modal de gasto - NUEVO
        function closeExpenseModalNew() {
            document.getElementById('expenseModalNew').style.display = 'none';
            document.getElementById('expenseFormNew').reset();
            document.getElementById('expenseIdNew').value = '';
            removeExpenseImageNew();
        }
        
        // Actualizar categorías - NUEVO
        function updateExpenseCategoriesNew() {
            const categorySelect = document.getElementById('expenseCategoryNew');
            categorySelect.innerHTML = '<option value="">Seleccionar categoría</option>';
            
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categorySelect.appendChild(option);
            });
        }
        
        // Calcular USD - NUEVO
        function calculateUSDNew() {
            const amount = parseFloat(document.getElementById('expenseAmountNew').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('expenseExchangeRateNew').value) || 0;
            const usdField = document.getElementById('expenseUSDNew');
            
            if (exchangeRate > 0) {
                const usd = amount / exchangeRate;
                usdField.value = usd.toFixed(2);
            } else {
                usdField.value = '0.00';
            }
        }
        
        // Preview de imagen - NUEVO
        function previewExpenseImageNew(input) {
            const file = input.files[0];
            if (file) {
                pendingImageFileNew = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('expenseImagePreviewImgNew').src = e.target.result;
                    document.getElementById('expenseImagePreviewNew').style.display = 'block';
                    document.getElementById('expenseImageNameNew').value = file.name;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Eliminar imagen - NUEVO
        function removeExpenseImageNew() {
            document.getElementById('expenseImagePreviewNew').style.display = 'none';
            document.getElementById('expenseImagePreviewImgNew').src = '';
            document.getElementById('expenseImageFileNew').value = '';
            document.getElementById('expenseImageUrlNew').value = '';
            document.getElementById('expenseImageNameNew').value = '';
            pendingImageFileNew = null;
        }
        
        // Abrir cámara - NUEVO
        async function openCameraCaptureNew() {
            try {
                cameraStreamNew = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('cameraVideoNew').srcObject = cameraStreamNew;
                document.getElementById('cameraModalNew').style.display = 'flex';
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                alert('❌ No se pudo acceder a la cámara. Verifica los permisos.');
            }
        }
        
        // Cerrar cámara - NUEVO
        function closeCameraModalNew() {
            if (cameraStreamNew) {
                cameraStreamNew.getTracks().forEach(track => track.stop());
                cameraStreamNew = null;
            }
            document.getElementById('cameraModalNew').style.display = 'none';
        }
        
        // Capturar foto - NUEVO
        function capturePhotoNew() {
            const video = document.getElementById('cameraVideoNew');
            const canvas = document.getElementById('cameraCanvasNew');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(function(blob) {
                const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                pendingImageFileNew = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('expenseImagePreviewImgNew').src = e.target.result;
                    document.getElementById('expenseImagePreviewNew').style.display = 'block';
                    document.getElementById('expenseImageNameNew').value = 'camera-capture.jpg';
                };
                reader.readAsDataURL(file);
                closeCameraModalNew();
            }, 'image/jpeg', 0.9);
        }
        
        // Guardar gasto - NUEVO
        async function saveExpenseNew(event) {
            event.preventDefault();
            try {
                const expenseId = document.getElementById('expenseIdNew').value;
                const expenseData = {
                    date: document.getElementById('expenseDateNew').value,
                    type: document.getElementById('expenseTypeNew').value,
                    category: document.getElementById('expenseCategoryNew').value,
                    subcategory: document.getElementById('expenseSubcategoryNew').value,
                    description: document.getElementById('expenseDescriptionNew').value,
                    amount: parseFloat(document.getElementById('expenseAmountNew').value),
                    exchange_rate: parseFloat(document.getElementById('expenseExchangeRateNew').value),
                    usd_amount: parseFloat(document.getElementById('expenseUSDNew').value)
                };
                
                // Subir imagen si hay una
                if (pendingImageFileNew) {
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            const imageUrl = await window.supabaseClient.uploadFile(pendingImageFileNew, `expenses/${expenseId || Date.now()}`);
                            expenseData.image_url = imageUrl;
                            expenseData.imageUrl = imageUrl;
                        } catch (error) {
                            console.error('Error subiendo imagen:', error);
                        }
                    }
                } else if (document.getElementById('expenseImageUrlNew').value) {
                    expenseData.image_url = document.getElementById('expenseImageUrlNew').value;
                    expenseData.imageUrl = document.getElementById('expenseImageUrlNew').value;
                }
                
                // Guardar en Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    if (expenseId) {
                        await window.supabaseClient.updateExpense(expenseId, expenseData);
                    } else {
                        await window.supabaseClient.createExpense(expenseData);
                    }
                    alert('✅ Gasto guardado correctamente');
                } else {
                    // Fallback a localStorage
                    let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const expense = {
                        id: expenseId || Date.now().toString(),
                        ...expenseData,
                        exchangeRate: expenseData.exchange_rate,
                        usd: expenseData.usd_amount,
                        createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (expenseId) {
                        const index = expenses.findIndex(e => e.id === expenseId);
                        if (index !== -1) {
                            expenses[index] = expense;
                        }
                    } else {
                        expenses.push(expense);
                    }
                    localStorage.setItem('expensesDB', JSON.stringify(expenses));
                    alert('✅ Gasto guardado correctamente (guardado localmente)');
                }
                
                closeExpenseModalNew();
                loadExpensesData();
            } catch (error) {
                console.error('❌ Error guardando gasto:', error);
                alert('❌ Error al guardar el gasto');
            }
        }
        
        // ============================================
        // FUNCIONES PARA NUEVO MODAL DE COTIZACIONES
        // ============================================
        
        // Abrir modal de cotización - NUEVO
        function openQuoteModalNew() {
            console.log('🚀 openQuoteModalNew() llamado');
            try {
                const modal = document.getElementById('quoteModalNew');
                if (!modal) {
                    console.error('❌ Modal quoteModalNew no encontrado');
                    alert('❌ Error: Modal no encontrado. Verifica que el código se haya actualizado.');
                    return;
                }
                console.log('✅ Modal encontrado:', modal);
                
                if (typeof loadHotelsForQuoteNew === 'function') {
                    loadHotelsForQuoteNew();
                }
                
                const formEl = document.getElementById('quoteFormNew');
                if (formEl) formEl.reset();
                
                const adultsEl = document.getElementById('quoteAdultsNew');
                if (adultsEl) adultsEl.value = '1';
                
                const childrenEl = document.getElementById('quoteChildrenNew');
                if (childrenEl) childrenEl.value = '0';
                
                const infantsEl = document.getElementById('quoteInfantsNew');
                if (infantsEl) infantsEl.value = '0';
                
                const discountEl = document.getElementById('quoteDiscountNew');
                if (discountEl) discountEl.value = '0';
                
                const finalTariffEl = document.getElementById('quoteFinalTariffNew');
                if (finalTariffEl) finalTariffEl.value = '0.00';
                
                const nightsDisplayEl = document.getElementById('nightsDisplayNew');
                if (nightsDisplayEl) nightsDisplayEl.style.display = 'none';
                
                const childrenAgesEl = document.getElementById('childrenAgesContainerNew');
                if (childrenAgesEl) childrenAgesEl.style.display = 'none';
                
                // Mostrar modal con múltiples métodos
                modal.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; z-index: 10000 !important;';
                
                console.log('✅ Modal mostrado, display:', modal.style.display);
                console.log('✅ Modal computed style:', window.getComputedStyle(modal).display);
            } catch (error) {
                console.error('❌ Error en openQuoteModalNew:', error);
                alert('❌ Error al abrir el modal: ' + error.message);
            }
        }
        
        // Hacer función global
        window.openQuoteModalNew = openQuoteModalNew;
        window.closeQuoteModalNew = closeQuoteModalNew;
        window.createAndSendQuoteNew = createAndSendQuoteNew;
        
        // Cerrar modal de cotización - NUEVO
        function closeQuoteModalNew() {
            document.getElementById('quoteModalNew').style.display = 'none';
            document.getElementById('quoteFormNew').reset();
        }
        
        // Cargar hoteles - NUEVO
        async function loadHotelsForQuoteNew() {
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    hotels = await window.supabaseClient.getHotels();
                } catch (error) {
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            const select = document.getElementById('quoteHotelNew');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar hotel</option>';
            
            if (hotels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay hoteles disponibles';
                select.appendChild(option);
                return;
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.name;
                option.textContent = hotel.name || 'Hotel sin nombre';
                select.appendChild(option);
            });
        }
        
        // Calcular noches - NUEVO
        function calculateNightsNew() {
            const checkIn = document.getElementById('quoteCheckInNew').value;
            const checkOut = document.getElementById('quoteCheckOutNew').value;
            const display = document.getElementById('nightsDisplayNew');
            const count = document.getElementById('nightsCountNew');
            
            if (!checkIn || !checkOut) {
                display.style.display = 'none';
                return;
            }
            
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            if (checkOutDate <= checkInDate) {
                display.style.display = 'none';
                alert('⚠️ La fecha de check-out debe ser posterior al check-in');
                return;
            }
            
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            count.textContent = diffDays;
            display.style.display = 'block';
        }
        
        // Calcular tarifa final - NUEVO
        function calculateFinalTariffNew() {
            const tariff = parseFloat(document.getElementById('quoteTariffNew').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscountNew').value) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            document.getElementById('quoteFinalTariffNew').value = finalTariff.toFixed(2);
        }
        
        // Toggle edades de niños - NUEVO
        function toggleChildrenAgesNew() {
            const childrenCount = parseInt(document.getElementById('quoteChildrenNew').value) || 0;
            const container = document.getElementById('childrenAgesContainerNew');
            const inputsContainer = document.getElementById('childrenAgesInputsNew');
            
            if (childrenCount > 0) {
                container.style.display = 'block';
                inputsContainer.innerHTML = '';
                
                for (let i = 0; i < childrenCount; i++) {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">
                            Edad del niño ${i + 1}:
                        </label>
                        <input type="number" class="form-input" min="0" max="17" 
                               id="childAgeNew${i}" placeholder="Edad" required 
                               style="width: 100%;">
                    `;
                    inputsContainer.appendChild(div);
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Crear y enviar cotización - NUEVO
        async function createAndSendQuoteNew(event) {
            event.preventDefault();
            console.log('📋 Creando y enviando cotización (nuevo modal)...');
            
            try {
                const hotelId = document.getElementById('quoteHotelNew').value;
                const hotelName = document.getElementById('quoteHotelNew').selectedOptions[0].text;
                const checkIn = document.getElementById('quoteCheckInNew').value;
                const checkOut = document.getElementById('quoteCheckOutNew').value;
                const adults = parseInt(document.getElementById('quoteAdultsNew').value) || 1;
                const children = parseInt(document.getElementById('quoteChildrenNew').value) || 0;
                const infants = parseInt(document.getElementById('quoteInfantsNew').value) || 0;
                const module = document.getElementById('quoteModuleNew').value;
                const tariff = parseFloat(document.getElementById('quoteTariffNew').value) || 0;
                const discount = parseFloat(document.getElementById('quoteDiscountNew').value) || 0;
                const finalTariff = parseFloat(document.getElementById('quoteFinalTariffNew').value) || 0;
                const notes = document.getElementById('quoteNotesNew').value;
                const phoneNumber = document.getElementById('quotePhoneNumberNew').value;
                
                // Validaciones
                if (!hotelId || !checkIn || !checkOut || !module || tariff <= 0 || !phoneNumber) {
                    alert('❌ Por favor completa todos los campos obligatorios');
                    return;
                }
                
                // Obtener edades de niños
                const childrenAges = [];
                if (children > 0) {
                    for (let i = 0; i < children; i++) {
                        const ageInput = document.getElementById(`childAgeNew${i}`);
                        if (ageInput) {
                            const age = parseInt(ageInput.value);
                            if (age) childrenAges.push(age);
                        }
                    }
                }
                
                // Calcular noches
                const checkInDate = new Date(checkIn);
                const checkOutDate = new Date(checkOut);
                const diffTime = Math.abs(checkOutDate - checkInDate);
                const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Crear objeto de cotización
                const quoteData = {
                    hotel_id: hotelId,
                    hotel_name: hotelName,
                    check_in: checkIn,
                    check_out: checkOut,
                    nights: nights,
                    adults: adults,
                    children: children,
                    children_ages: childrenAges,
                    infants: infants,
                    module: module,
                    tariff: tariff,
                    discount: discount,
                    final_tariff: finalTariff,
                    notes: notes,
                    phone_number: phoneNumber,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                // Guardar en Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        await window.supabaseClient.createQuote(quoteData);
                        alert('✅ Cotización creada y enviada correctamente');
                        closeQuoteModalNew();
                        if (typeof loadQuotesTable === 'function') {
                            loadQuotesTable();
                        }
                    } catch (error) {
                        console.error('Error guardando cotización:', error);
                        alert('❌ Error al guardar la cotización');
                    }
                } else {
                    // Fallback a localStorage
                    let quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                    quoteData.id = Date.now().toString();
                    quotes.push(quoteData);
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    alert('✅ Cotización creada (guardada localmente)');
                    closeQuoteModalNew();
                    if (typeof loadQuotesTable === 'function') {
                        loadQuotesTable();
                    }
                }
            } catch (error) {
                console.error('❌ Error creando cotización:', error);
                alert('❌ Error al crear la cotización');
            }
        }
        
        // Capturar foto
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Convertir a blob
            canvas.toBlob(function(blob) {
                const timestamp = Date.now();
                const file = new File([blob], `comprobante_${timestamp}.jpg`, { type: 'image/jpeg' });
                pendingImageFile = file;
                
                // Mostrar preview
                document.getElementById('expenseImagePreviewImg').src = canvas.toDataURL('image/jpeg');
                document.getElementById('expenseImagePreview').style.display = 'block';
                document.getElementById('expenseImageName').value = file.name;
                
                closeCameraModal();
            }, 'image/jpeg', 0.8);
        }
        
        // Subir imagen a Supabase Storage
        async function uploadExpenseImage(file) {
            if (!file) return null;
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.warn('⚠️ Supabase no disponible, guardando imagen como base64');
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ url: reader.result, name: file.name });
                    reader.readAsDataURL(file);
                });
            }
            
            try {
                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                
                const { data, error } = await window.supabaseClient.client.storage
                    .from('expense-images')
                    .upload(fileName, file);
                
                if (error) throw error;
                
                // Obtener URL pública
                const { data: urlData } = window.supabaseClient.client.storage
                    .from('expense-images')
                    .getPublicUrl(fileName);
                
                return { url: urlData.publicUrl, name: fileName };
            } catch (error) {
                console.error('❌ Error subiendo imagen:', error);
                // Fallback a base64
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ url: reader.result, name: file.name });
                    reader.readAsDataURL(file);
                });
            }
        }
        
        // Guardar gasto
        async function saveExpense(event) {
            event.preventDefault();
            
            const expenseId = document.getElementById('expenseForm').dataset.expenseId;
            
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const exchangeRateValue = document.getElementById('expenseExchangeRate').value;
            const exchangeRate = exchangeRateValue ? parseFloat(exchangeRateValue) : null;
            const usd = (exchangeRate && exchangeRate > 0) ? amount / exchangeRate : null;
            
            console.log('💾 Guardando gasto:', { amount, exchangeRate, usd });
            
            // Subir imagen si existe
            let imageUrl = document.getElementById('expenseImageUrl').value || null;
            let imageName = document.getElementById('expenseImageName').value || null;
            
            if (pendingImageFile) {
                try {
                    console.log('📤 Subiendo imagen...');
                    const imageResult = await uploadExpenseImage(pendingImageFile);
                    if (imageResult) {
                        imageUrl = imageResult.url;
                        imageName = imageResult.name;
                        console.log('✅ Imagen subida:', imageUrl);
                    }
                } catch (error) {
                    console.error('❌ Error subiendo imagen:', error);
                    alert('⚠️ Error al subir la imagen, pero se guardará el gasto sin imagen');
                }
            }
            
            const expenseData = {
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                category: document.getElementById('expenseCategory').value,
                subcategory: document.getElementById('expenseSubcategory').value || '',
                description: document.getElementById('expenseDescription').value,
                amount: amount,
                exchange_rate: exchangeRate,
                usd_amount: usd ? parseFloat(usd.toFixed(2)) : null,
                image_url: imageUrl,
                image_name: imageName,
                // También guardar con nombres alternativos para compatibilidad
                exchangeRate: exchangeRate,
                usd: usd ? parseFloat(usd.toFixed(2)) : null
            };
            
            console.log('📦 Datos del gasto:', expenseData);
            
            try {
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        if (expenseId) {
                            // Usar el ID tal como está (puede ser UUID o número)
                            console.log('🔄 Actualizando gasto con ID:', expenseId);
                            
                            const result = await window.supabaseClient.updateExpense(expenseId, expenseData);
                            
                            if (result) {
                                console.log('✅ Gasto actualizado en Supabase:', result);
                                alert('✅ Gasto actualizado correctamente');
                            } else {
                                throw new Error('No se recibió respuesta de Supabase');
                            }
                        } else {
                            console.log('➕ Creando nuevo gasto...');
                            await window.supabaseClient.createExpense(expenseData);
                            console.log('✅ Gasto guardado en Supabase');
                            alert('✅ Gasto guardado correctamente');
                        }
                    } catch (error) {
                        console.error('❌ Error guardando en Supabase:', error);
                        alert('❌ Error: ' + error.message);
                        // Fallback a localStorage
                        const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                        const expense = {
                            id: expenseId || Date.now().toString(),
                            ...expenseData,
                            exchangeRate: expenseData.exchange_rate,
                            usd: expenseData.usd_amount,
                createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (expenseId) {
                const index = expenses.findIndex(e => e.id === expenseId);
                if (index !== -1) {
                    expenses[index] = expense;
                }
            } else {
                expenses.push(expense);
            }
                        localStorage.setItem('expensesDB', JSON.stringify(expenses));
                        alert('✅ Gasto guardado correctamente (guardado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no está disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const expense = {
                        id: expenseId || Date.now().toString(),
                        ...expenseData,
                        exchangeRate: expenseData.exchange_rate,
                        usd: expenseData.usd_amount,
                        createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (expenseId) {
                        const index = expenses.findIndex(e => e.id === expenseId);
                        if (index !== -1) {
                            expenses[index] = expense;
                        }
                    } else {
                        expenses.push(expense);
                    }
            localStorage.setItem('expensesDB', JSON.stringify(expenses));
                    alert('✅ Gasto guardado correctamente (guardado localmente)');
                }
            
            closeExpenseModal();
            loadExpensesData();
            } catch (error) {
                console.error('❌ Error guardando gasto:', error);
                alert('❌ Error al guardar el gasto');
            }
        }

        // Cargar tabla de gastos - VERSIÓN SIMPLIFICADA
        async function loadExpensesTable() {
            console.log('🚀 loadExpensesTable INICIADO - Versión simplificada');
            console.log('🔍 DEBUG: Verificando funciones disponibles...');
            console.log('  - forceExpensesSectionDimensions:', typeof forceExpensesSectionDimensions);
            console.log('  - forceMainContentDimensions:', typeof forceMainContentDimensions);
            
            // FORZAR DIMENSIONES PRIMERO (antes de cargar datos) - MÚLTIPLES INTENTOS
            if (typeof forceExpensesSectionDimensions === 'function') {
                console.log('🔧 Llamando a forceExpensesSectionDimensions desde loadExpensesTable...');
                // Ejecutar inmediatamente
                forceExpensesSectionDimensions();
                // Ejecutar después de un frame
                requestAnimationFrame(() => {
                    forceExpensesSectionDimensions();
                });
                // Ejecutar después de un pequeño delay
                setTimeout(() => {
                    forceExpensesSectionDimensions();
                }, 100);
            } else {
                console.error('❌ forceExpensesSectionDimensions NO está definida - el código nuevo no se cargó');
                // Intentar forzar dimensiones manualmente como fallback
                console.log('🔧 Fallback: Forzando dimensiones manualmente...');
                const mainContentFallback = document.querySelector('.main-content');
                const expensesSectionFallback = document.getElementById('expenses-section');
                if (mainContentFallback && expensesSectionFallback) {
                    const viewportWidth = window.innerWidth;
                    const sidebarWidth = 220;
                    const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                    const availableWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                    
                    mainContentFallback.style.cssText = `
                        display: block !important;
                        width: ${mainWidth}px !important;
                        min-width: ${mainWidth}px !important;
                        margin-left: ${sidebarWidth}px !important;
                    `;
                    expensesSectionFallback.style.cssText = `
                        display: block !important;
                        width: ${availableWidth}px !important;
                        min-width: ${availableWidth}px !important;
                        padding: 20px !important;
                    `;
                    void mainContentFallback.offsetWidth;
                    void expensesSectionFallback.offsetWidth;
                }
            }
            
            try {
                // Cargar datos desde Supabase o localStorage
                let expenses = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        expenses = await window.supabaseClient.getExpenses();
                    } catch (error) {
                        expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    }
                } else {
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
                
                console.log(`📊 Datos cargados: ${expenses.length} gastos`);
                
                const tbody = document.getElementById('expensesTableBody');
                const noExpensesMessage = document.getElementById('noExpensesMessage');
                const tableContainer = document.querySelector('#expenses-section .table-container');
                
                console.log('🔍 Buscando elementos del DOM...');
                console.log('  - tbody:', tbody ? '✅ encontrado' : '❌ NO encontrado');
                console.log('  - tableContainer:', tableContainer ? '✅ encontrado' : '❌ NO encontrado');
                
                if (!tbody) {
                    console.error('❌ No se encontró expensesTableBody');
                    return;
                }
                
                // Ocultar mensaje de "no hay gastos" si hay datos
                if (noExpensesMessage) {
                    noExpensesMessage.style.display = expenses.length === 0 ? 'block' : 'none';
                }
                
                if (expenses.length === 0) {
                    tbody.innerHTML = '';
                    return;
                }
                
                // Ordenar por fecha descendente
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Limpiar y renderizar tabla
                tbody.innerHTML = '';
                expenses.forEach((expense) => {
                    if (!expense) return;
                    
                    const row = document.createElement('tr');
                    const categoryName = expenseCategories[expense.category] || expense.category || 'Sin categoría';
                    const typeLabel = expense.type === 'fixed' ? 'Fijo' : 'Variable';
                    const typeColor = expense.type === 'fixed' ? '#1976d2' : '#f57c00';
                    const exchangeRate = expense.exchange_rate || expense.exchangeRate || null;
                    const usdAmount = expense.usd_amount || expense.usd || null;
                    const amount = parseFloat(expense.amount) || 0;
                    
                    // Formatear fecha
                    let formattedDate = '-';
                    if (expense.date) {
                        try {
                            const expenseDate = new Date(expense.date + 'T12:00:00');
                            formattedDate = expenseDate.toLocaleDateString('es-AR', { 
                                timeZone: 'America/Argentina/Buenos_Aires',
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        } catch (e) {
                            formattedDate = expense.date;
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${categoryName}</td>
                        <td>${expense.subcategory || '-'}</td>
                        <td><span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">${typeLabel}</span></td>
                        <td>${expense.description || '-'}</td>
                        <td style="font-weight: 600; color: #d32f2f;">$${amount.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${exchangeRate ? exchangeRate.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                        <td style="font-weight: 600; color: #1976d2;">${usdAmount ? '$' + usdAmount.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                        <td>
                            <button onclick="editExpenseNew('${expense.id}')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                            </button>
                            <button onclick="deleteExpense('${expense.id}')" style="background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // SOLUCIÓN AGRESIVA: Forzar dimensiones en TODOS los contenedores padres
                console.log('🔧 SOLUCIÓN AGRESIVA: Forzando dimensiones en todos los contenedores...');
                
                // Aplicar dimensiones en ORDEN CORRECTO - SOLUCIÓN ULTRA DIRECTA
                // Calcular dimensiones desde viewport directamente (no depender del padre)
                const viewportWidth = window.innerWidth;
                const sidebarWidth = 220;
                const mainWidth = Math.max(800, viewportWidth - sidebarWidth);
                const sectionWidth = Math.max(800, viewportWidth - sidebarWidth - 40);
                const containerWidth = Math.max(800, viewportWidth - sidebarWidth - 80);
                const rowCount = expenses.length;
                const minHeight = Math.max(400, rowCount * 50);
                
                console.log(`📐 Calculando dimensiones desde viewport: main=${mainWidth}px, section=${sectionWidth}px, container=${containerWidth}px`);
                
                // Paso 1: Asegurar main-content PRIMERO
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.cssText = `
                        display: flex !important;
                        flex-direction: column !important;
                        width: ${mainWidth}px !important;
                        min-width: ${mainWidth}px !important;
                        max-width: ${mainWidth}px !important;
                        margin-left: ${sidebarWidth}px !important;
                        flex: 1 1 auto !important;
                        position: relative !important;
                        visibility: visible !important;
                        overflow: visible !important;
                    `;
                    void mainContent.offsetWidth;
                }
                
                // Paso 2: Asegurar expenses-section con dimensiones ABSOLUTAS (no depender del padre)
                const expensesSection = document.getElementById('expenses-section');
                if (expensesSection) {
                    // CRÍTICO: Asegurar que esté visible ANTES de aplicar dimensiones
                    expensesSection.style.setProperty('display', 'block', 'important');
                    void expensesSection.offsetWidth; // Forzar reflow después de display: block
                    
                    // Aplicar dimensiones absolutas directamente
                    expensesSection.style.cssText = `
                        display: block !important;
                        width: ${sectionWidth}px !important;
                        min-width: ${sectionWidth}px !important;
                        max-width: ${sectionWidth}px !important;
                        visibility: visible !important;
                        position: relative !important;
                        padding: 20px !important;
                        box-sizing: border-box !important;
                        overflow: visible !important;
                    `;
                    
                    // Forzar múltiples reflows
                    void expensesSection.offsetWidth;
                    void expensesSection.offsetHeight;
                }
                
                // Paso 3: Aplicar dimensiones al table-container con valores ABSOLUTOS del viewport
                // CRÍTICO: Asegurar que expenses-section tenga dimensiones ANTES de aplicar al table-container
                if (tableContainer) {
                    // Función para aplicar estilos de forma agresiva
                    const applyStylesAggressively = () => {
                        console.log(`📏 Aplicando dimensiones finales: ${containerWidth}px x ${minHeight}px (calculado desde viewport: ${viewportWidth}px)`);
                        
                        // CRÍTICO: Asegurar que expenses-section esté visible Y tenga dimensiones
                        if (expensesSection) {
                            const computedDisplay = window.getComputedStyle(expensesSection).display;
                            if (computedDisplay === 'none') {
                                console.log('⚠️ expenses-section está oculto, forzando display: block...');
                                expensesSection.style.setProperty('display', 'block', 'important');
                                void expensesSection.offsetWidth;
                            }
                            
                            // Verificar que expenses-section tenga dimensiones, si no, forzarlas de nuevo
                            const currentSectionWidth = expensesSection.offsetWidth || expensesSection.getBoundingClientRect().width;
                            if (currentSectionWidth === 0) {
                                console.log('⚠️ expenses-section tiene 0px, forzando dimensiones de nuevo...');
                                // Usar sectionWidth calculado desde viewport, no el offsetWidth que es 0
                                expensesSection.style.setProperty('display', 'block', 'important');
                                expensesSection.style.setProperty('width', `${sectionWidth}px`, 'important');
                                expensesSection.style.setProperty('min-width', `${sectionWidth}px`, 'important');
                                expensesSection.style.setProperty('max-width', `${sectionWidth}px`, 'important');
                                expensesSection.style.setProperty('visibility', 'visible', 'important');
                                expensesSection.style.setProperty('position', 'relative', 'important');
                                expensesSection.style.setProperty('padding', '20px', 'important');
                                expensesSection.style.setProperty('box-sizing', 'border-box', 'important');
                                expensesSection.style.setProperty('overflow', 'visible', 'important');
                                
                                // Forzar múltiples reflows
                                void expensesSection.offsetWidth;
                                void expensesSection.offsetHeight;
                                requestAnimationFrame(() => {
                                    void expensesSection.offsetWidth;
                                });
                            }
                        }
                        
                        // Aplicar estilos usando setProperty individual (más confiable que cssText)
                        tableContainer.style.setProperty('display', 'block', 'important');
                        tableContainer.style.setProperty('visibility', 'visible', 'important');
                        tableContainer.style.setProperty('width', `${containerWidth}px`, 'important');
                        tableContainer.style.setProperty('min-width', `${containerWidth}px`, 'important');
                        tableContainer.style.setProperty('max-width', `${containerWidth}px`, 'important');
                        tableContainer.style.setProperty('min-height', `${minHeight}px`, 'important');
                        tableContainer.style.setProperty('height', 'auto', 'important');
                        tableContainer.style.setProperty('overflow-x', 'auto', 'important');
                        tableContainer.style.setProperty('overflow-y', 'visible', 'important');
                        tableContainer.style.setProperty('background-color', 'white', 'important');
                        tableContainer.style.setProperty('position', 'relative', 'important');
                        tableContainer.style.setProperty('z-index', '1', 'important');
                        tableContainer.style.setProperty('box-sizing', 'border-box', 'important');
                        
                        // Forzar reflow
                        void tableContainer.offsetWidth;
                        void tableContainer.offsetHeight;
                        
                        // Aplicar también a la tabla interna
                        const table = tableContainer.querySelector('table');
                        if (table) {
                            table.style.setProperty('width', `${containerWidth}px`, 'important');
                            table.style.setProperty('min-width', `${containerWidth}px`, 'important');
                            table.style.setProperty('display', 'table', 'important');
                            table.style.setProperty('visibility', 'visible', 'important');
                            table.style.setProperty('border-collapse', 'collapse', 'important');
                            table.style.setProperty('table-layout', 'auto', 'important');
                            void table.offsetWidth;
                            void table.offsetHeight;
                        }
                        
                        // Verificar después de aplicar
                        setTimeout(() => {
                            const finalWidth = tableContainer.offsetWidth;
                            const finalHeight = tableContainer.offsetHeight;
                            const sectionWidth = expensesSection ? expensesSection.offsetWidth : 0;
                            const sectionHeight = expensesSection ? expensesSection.offsetHeight : 0;
                            const computedWidth = window.getComputedStyle(tableContainer).width;
                            
                            // DIAGNÓSTICO COMPLETO: Verificar toda la cadena de contenedores
                            const mainContent = document.querySelector('.main-content');
                            const mainContentWidth = mainContent ? mainContent.offsetWidth : 0;
                            const mainContentHeight = mainContent ? mainContent.offsetHeight : 0;
                            const bodyWidth = document.body.offsetWidth;
                            const bodyHeight = document.body.offsetHeight;
                            const bodyHasAuthenticated = document.body.classList.contains('authenticated');
                            
                            console.log(`🔍 DIAGNÓSTICO COMPLETO:`);
                            console.log(`   - body: ${bodyWidth}x${bodyHeight}, authenticated=${bodyHasAuthenticated}`);
                            console.log(`   - main-content: ${mainContentWidth}x${mainContentHeight}`);
                            console.log(`   - expenses-section: ${sectionWidth}x${sectionHeight}`);
                            console.log(`   - table-container: ${finalWidth}x${finalHeight}, computed=${computedWidth}`);
                            
                            if (finalWidth > 0 && finalHeight > 0) {
                                console.log(`✅ Tabla tiene dimensiones: ${finalWidth}x${finalHeight} (expenses-section: ${sectionWidth}px)`);
                            } else {
                                console.log(`❌ Tabla aún sin dimensiones: ${finalWidth}x${finalHeight}, expenses-section: ${sectionWidth}px`);
                                
                                // Si main-content tiene dimensiones pero expenses-section no, el problema está en expenses-section
                                if (mainContentWidth > 0 && sectionWidth === 0) {
                                    console.log(`⚠️ PROBLEMA IDENTIFICADO: main-content tiene ${mainContentWidth}px pero expenses-section tiene 0px`);
                                    console.log(`🔧 Intentando solución: mover table-container directamente a main-content...`);
                                    
                                    // ÚLTIMA SOLUCIÓN: Mover table-container directamente a main-content
                                    if (mainContent && tableContainer) {
                                        // Clonar el table-container
                                        const clonedContainer = tableContainer.cloneNode(true);
                                        clonedContainer.id = 'expenses-table-container-emergency';
                                        clonedContainer.style.cssText = `
                                            display: block !important;
                                            visibility: visible !important;
                                            width: ${containerWidth}px !important;
                                            min-width: ${containerWidth}px !important;
                                            max-width: ${containerWidth}px !important;
                                            min-height: ${minHeight}px !important;
                                            height: auto !important;
                                            margin: 20px !important;
                                            padding: 20px !important;
                                            background-color: white !important;
                                            position: relative !important;
                                            z-index: 1000 !important;
                                            box-sizing: border-box !important;
                                        `;
                                        
                                        // Agregar al main-content
                                        mainContent.appendChild(clonedContainer);
                                        
                                        void clonedContainer.offsetWidth;
                                        
                                        setTimeout(() => {
                                            const emergencyWidth = clonedContainer.offsetWidth;
                                            const emergencyHeight = clonedContainer.offsetHeight;
                                            console.log(`🔧 Tabla de emergencia: ${emergencyWidth}x${emergencyHeight}`);
                                            if (emergencyWidth > 0) {
                                                console.log(`✅ SOLUCIÓN DE EMERGENCIA FUNCIONÓ: Tabla visible en ${emergencyWidth}x${emergencyHeight}`);
                                            }
                                        }, 100);
                                    }
                                } else if (mainContentWidth === 0) {
                                    console.log(`⚠️ PROBLEMA IDENTIFICADO: main-content también tiene 0px - el problema está en el contenedor padre`);
                                }
                                
                                // Último intento: usar position absolute
                                if (finalWidth === 0) {
                                    console.log('🔧 Último intento de emergencia: usando position fixed (no absolute)...');
                                    
                                    tableContainer.style.setProperty('position', 'fixed', 'important');
                                    tableContainer.style.setProperty('left', '240px', 'important');
                                    tableContainer.style.setProperty('top', '100px', 'important');
                                    tableContainer.style.setProperty('width', `${containerWidth}px`, 'important');
                                    tableContainer.style.setProperty('min-width', `${containerWidth}px`, 'important');
                                    tableContainer.style.setProperty('max-width', `${containerWidth}px`, 'important');
                                    tableContainer.style.setProperty('z-index', '10000', 'important');
                                    tableContainer.style.setProperty('background-color', 'white', 'important');
                                    tableContainer.style.setProperty('padding', '20px', 'important');
                                    tableContainer.style.setProperty('box-shadow', '0 4px 6px rgba(0,0,0,0.1)', 'important');
                                    
                                    void tableContainer.offsetWidth;
                                    
                                    setTimeout(() => {
                                        const emergencyWidth = tableContainer.offsetWidth;
                                        const emergencyHeight = tableContainer.offsetHeight;
                                        console.log(`🔧 Después de position fixed: ${emergencyWidth}x${emergencyHeight}`);
                                    }, 100);
                                }
                            }
                        }, 500);
                    };
                    
                    // Aplicar inmediatamente y también después de múltiples frames
                    applyStylesAggressively();
                    
                    requestAnimationFrame(() => {
                        applyStylesAggressively();
                        requestAnimationFrame(() => {
                            applyStylesAggressively();
                            requestAnimationFrame(() => {
                                applyStylesAggressively();
                            });
                        });
                    });
                }
                
                console.log(`✅ ${expenses.length} gastos cargados en la tabla`);
            } catch (error) {
                console.error('❌ Error en loadExpensesTable:', error);
            }
        }

        // Editar gasto
        async function editExpense(expenseId) {
            // Intentar obtener de Supabase primero, luego localStorage
            let expenses = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    expenses = await window.supabaseClient.getExpenses();
                } catch (error) {
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
            } else {
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            }
            
            const expense = expenses.find(e => e.id === expenseId || e.id === parseInt(expenseId));
            
            if (!expense) {
                alert('❌ Gasto no encontrado');
                return;
            }
            
            // Limpiar imagen pendiente
            pendingImageFile = null;
            
            document.getElementById('expenseModalTitle').textContent = 'Editar Gasto';
            document.getElementById('expenseForm').dataset.expenseId = expenseId;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseType').value = expense.type;
            updateExpenseCategories();
            setTimeout(() => {
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseSubcategory').value = expense.subcategory || '';
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                // Normalizar nombres de campos (Supabase usa snake_case)
                const exchangeRate = expense.exchange_rate || expense.exchangeRate || '';
                document.getElementById('expenseExchangeRate').value = exchangeRate;
                // Calcular USD automáticamente al cargar
                calculateUSD();
                
                // Cargar imagen existente si hay
                const imageUrl = expense.image_url || expense.imageUrl || '';
                const imageName = expense.image_name || expense.imageName || '';
                if (imageUrl) {
                    document.getElementById('expenseImageUrl').value = imageUrl;
                    document.getElementById('expenseImageName').value = imageName;
                    document.getElementById('expenseImagePreviewImg').src = imageUrl;
                    document.getElementById('expenseImagePreview').style.display = 'block';
                } else {
                    removeExpenseImage();
                }
            }, 100);
            
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Eliminar gasto
        async function deleteExpense(expenseId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('⛔ No tienes permisos para eliminar. Solo los administradores pueden realizar esta acción.');
                return;
            }
            
            if (!confirm('¿Estás seguro de que quieres eliminar este gasto?')) return;
            
            try {
                // Intentar eliminar de Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        await window.supabaseClient.deleteExpense(expenseId);
                        console.log('✅ Gasto eliminado de Supabase');
                        alert('✅ Gasto eliminado correctamente (eliminado de la nube)');
                    } catch (error) {
                        console.warn('⚠️ Error eliminando de Supabase, eliminando de localStorage:', error);
                        // Fallback a localStorage
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const filtered = expenses.filter(e => e.id !== expenseId);
            localStorage.setItem('expensesDB', JSON.stringify(filtered));
                        alert('✅ Gasto eliminado correctamente (eliminado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no está disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const filtered = expenses.filter(e => e.id !== expenseId);
                    localStorage.setItem('expensesDB', JSON.stringify(filtered));
                    alert('✅ Gasto eliminado correctamente (eliminado localmente)');
                }
            
            loadExpensesData();
            } catch (error) {
                console.error('❌ Error eliminando gasto:', error);
                alert('❌ Error al eliminar el gasto');
            }
        }

        // Actualizar KPIs de gastos
        function updateExpensesKPIs() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Calcular gastos totales
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Calcular CPA (Costo por Adquisición)
            const marketingExpenses = expenses
                .filter(e => e.category === 'publicidad_meta')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalReservations = reservations.length;
            const cpa = totalReservations > 0 ? marketingExpenses / totalReservations : 0;
            document.getElementById('cpaValue').textContent = `$${cpa.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpaSubtitle').textContent = `Publicidad Meta: $${marketingExpenses.toLocaleString('es-ES')} / ${totalReservations} reservas`;
            
            // Calcular CPC (Costo por Llamada) - Simulado
            const telecomExpenses = expenses
                .filter(e => e.category === 'telefonia')
                .reduce((sum, e) => sum + e.amount, 0);
            const salesPersonnelExpenses = expenses
                .filter(e => e.category === 'sueldos')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalCalls = totalReservations * 3; // Estimación: 3 llamadas por reserva
            const cpc = totalCalls > 0 ? (telecomExpenses + salesPersonnelExpenses) / totalCalls : 0;
            document.getElementById('cpcValue').textContent = `$${cpc.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpcSubtitle').textContent = `Telecom + Agentes: $${(telecomExpenses + salesPersonnelExpenses).toLocaleString('es-ES')} / ${totalCalls} llamadas`;
            
            // Calcular variación de presupuesto
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000}');
            const currentMonth = new Date().getMonth();
            const monthlyBudget = budget.monthly || 50000;
            const monthlyExpenses = expenses
                .filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === new Date().getFullYear();
                })
                .reduce((sum, e) => sum + e.amount, 0);
            const variance = monthlyBudget > 0 ? ((monthlyExpenses - monthlyBudget) / monthlyBudget) * 100 : 0;
            document.getElementById('budgetVariance').textContent = `${variance >= 0 ? '+' : ''}${variance.toFixed(1)}%`;
            document.getElementById('budgetVarianceSubtitle').textContent = `Real: $${monthlyExpenses.toLocaleString('es-ES')} vs Presupuesto: $${monthlyBudget.toLocaleString('es-ES')}`;
            
            // Calcular acumulado en dólares (USD)
            // Los gastos en USD se identifican por currency = 'USD' o se convierten con tipo de cambio
            const exchangeRate = parseFloat(localStorage.getItem('exchangeRateUSD') || '1050'); // Tipo de cambio ARS/USD
            
            // Gastos directamente en USD
            const expensesInUSD = expenses
                .filter(e => e.currency === 'USD')
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Gastos en pesos convertidos a USD
            const expensesInARS = expenses
                .filter(e => e.currency !== 'USD')
                .reduce((sum, e) => sum + e.amount, 0);
            const convertedToUSD = expensesInARS / exchangeRate;
            
            // Total acumulado en USD
            const totalUSD = expensesInUSD + convertedToUSD;
            
            const totalExpensesUSDEl = document.getElementById('totalExpensesUSD');
            const totalExpensesUSDSubtitleEl = document.getElementById('totalExpensesUSDSubtitle');
            
            if (totalExpensesUSDEl) {
                totalExpensesUSDEl.textContent = `$${totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} USD`;
            }
            if (totalExpensesUSDSubtitleEl) {
                totalExpensesUSDSubtitleEl.textContent = `TC: $${exchangeRate.toLocaleString('es-AR')} | USD directo: $${expensesInUSD.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
            }
        }

        // Actualizar gráficos de gastos
        function updateExpensesCharts() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            updateCompositionChart(expenses);
            updateVariableExpensesChart(expenses);
            updateBudgetChart(expenses);
        }

        // Gráfico de composición (Pie Chart)
        function updateCompositionChart(expenses) {
            const fixedExpenses = expenses
                .filter(e => e.type === 'fixed')
                .reduce((sum, e) => sum + e.amount, 0);
            const variableExpenses = expenses
                .filter(e => e.type === 'variable')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const ctx = document.getElementById('expensesCompositionChart');
            if (!ctx) return;
            
            if (expensesCharts.composition) {
                expensesCharts.composition.destroy();
            }
            
            expensesCharts.composition = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Gastos Fijos', 'Gastos Variables'],
                    datasets: [{
                        data: [fixedExpenses, variableExpenses],
                        backgroundColor: ['#1976d2', '#f57c00'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = fixedExpenses + variableExpenses;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: $${value.toLocaleString('es-ES', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de gastos variables (Bar Chart)
        function updateVariableExpensesChart(expenses) {
            const variableExpenses = expenses.filter(e => e.type === 'variable');
            
            const categories = {
                'sales_personnel': 'Personal Ventas',
                'marketing': 'Marketing',
                'telecom': 'Telecomunicaciones',
                'acquisition': 'Adquisición'
            };
            
            const data = {};
            Object.keys(categories).forEach(key => {
                data[key] = variableExpenses
                    .filter(e => e.category === key)
                    .reduce((sum, e) => sum + e.amount, 0);
            });
            
            const ctx = document.getElementById('variableExpensesChart');
            if (!ctx) return;
            
            if (expensesCharts.variable) {
                expensesCharts.variable.destroy();
            }
            
            expensesCharts.variable = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(categories),
                    datasets: [{
                        label: 'Monto ($)',
                        data: Object.values(data),
                        backgroundColor: ['#1976d2', '#f57c00', '#388e3c', '#9c27b0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Gasto vs Presupuesto (Line Chart)
        function updateBudgetChart(expenses) {
            const period = document.getElementById('budgetPeriodFilter')?.value || 'monthly';
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000, "quarterly": 150000, "yearly": 600000}');
            
            // Agrupar gastos por período
            const groupedExpenses = {};
            const now = new Date();
            
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                let key;
                
                if (period === 'monthly') {
                    key = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
                } else if (period === 'quarterly') {
                    const quarter = Math.floor(expenseDate.getMonth() / 3) + 1;
                    key = `${expenseDate.getFullYear()}-Q${quarter}`;
                } else {
                    key = expenseDate.getFullYear().toString();
                }
                
                if (!groupedExpenses[key]) {
                    groupedExpenses[key] = 0;
                }
                groupedExpenses[key] += expense.amount;
            });
            
            const labels = Object.keys(groupedExpenses).sort();
            const actualData = labels.map(label => groupedExpenses[label] || 0);
            const budgetValue = budget[period] || budget.monthly;
            const budgetData = labels.map(() => budgetValue);
            
            const ctx = document.getElementById('budgetComparisonChart');
            if (!ctx) return;
            
            if (expensesCharts.budget) {
                expensesCharts.budget.destroy();
            }
            
            expensesCharts.budget = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gasto Real',
                            data: actualData,
                            borderColor: '#d32f2f',
                            backgroundColor: 'rgba(211, 47, 47, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Presupuesto',
                            data: budgetData,
                            borderColor: '#388e3c',
                            backgroundColor: 'rgba(56, 142, 60, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filtrar gastos
        function filterExpenses() {
            const searchTerm = document.getElementById('expensesSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#expensesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Exportar gastos
        async function exportExpenses() {
            let expenses = [];
            
            // Intentar obtener de Supabase primero
            try {
                if (window.supabaseClient && typeof window.supabaseClient.getExpenses === 'function') {
                    expenses = await window.supabaseClient.getExpenses();
                    console.log('📊 Gastos obtenidos de Supabase:', expenses.length);
                }
            } catch (error) {
                console.error('Error obteniendo gastos de Supabase:', error);
            }
            
            // Fallback a localStorage
            if (!expenses || expenses.length === 0) {
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                console.log('📊 Gastos obtenidos de localStorage:', expenses.length);
            }
            
            if (expenses.length === 0) {
                alert('❌ No hay gastos para exportar');
                return;
            }
            
            let csv = 'Fecha,Tipo,Categoría,Subcategoría,Descripción,Monto,Tipo de Cambio,USD\n';
            expenses.forEach(expense => {
                const categoryName = expenseCategories[expense.category] || expense.category;
                const exchangeRate = expense.exchangeRate || expense.exchange_rate || '';
                const usdAmount = expense.usd || expense.usd_amount || '';
                csv += `"${expense.date}","${expense.type === 'fixed' ? 'Fijo' : 'Variable'}","${categoryName}","${expense.subcategory || ''}","${expense.description}","${expense.amount}","${exchangeRate}","${usdAmount}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `gastos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ Gastos exportados correctamente (' + expenses.length + ' registros)');
        }

        // Actualizar gastos
        function refreshExpenses() {
            loadExpensesData();
            alert('✅ Gastos actualizados');
        }

        // Limpiar gastos duplicados
        async function cleanDuplicateExpenses() {
            if (!confirm('¿Estás seguro de que deseas eliminar los gastos duplicados?\n\nEsto eliminará gastos que tengan la misma fecha, monto, descripción y categoría.')) {
                return;
            }
            
            try {
                let result;
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    // Limpiar en Supabase
                    result = await window.supabaseClient.cleanDuplicateExpenses();
                } else {
                    // Limpiar en localStorage
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const uniqueMap = new Map();
                    
                    expenses.forEach(expense => {
                        const key = `${expense.date}|${expense.amount}|${expense.description}|${expense.category}|${expense.subcategory || ''}`;
                        if (!uniqueMap.has(key)) {
                            uniqueMap.set(key, expense);
                        }
                    });
                    
                    const uniqueExpenses = Array.from(uniqueMap.values());
                    const duplicatesRemoved = expenses.length - uniqueExpenses.length;
                    localStorage.setItem('expensesDB', JSON.stringify(uniqueExpenses));
                    result = { deleted: duplicatesRemoved, kept: uniqueExpenses.length };
                }
                
                // Recargar la tabla
                loadExpensesData();
                
                if (result.deleted > 0) {
                    alert(`✅ Limpieza completada:\n\n• ${result.deleted} duplicados eliminados\n• ${result.kept} gastos únicos conservados`);
                } else {
                    alert('✅ No se encontraron gastos duplicados');
                }
            } catch (error) {
                console.error('❌ Error limpiando duplicados:', error);
                alert('❌ Error al limpiar duplicados: ' + error.message);
            }
        }

        // Abrir modal para actualizar tipo de cambio masivamente
        function openMassUpdateExchangeRate() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const withoutTC = expenses.filter(e => !e.exchangeRate && !e.exchange_rate);
            
            const html = `
                <div id="massUpdateTCModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin: 0 0 20px 0; color: #333;">💱 Actualizar Tipo de Cambio Masivo</h2>
                        
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #e65100;">
                                <strong>📊 Resumen:</strong><br>
                                • Total de gastos: <strong>${expenses.length}</strong><br>
                                • Sin tipo de cambio: <strong style="color: #d32f2f;">${withoutTC.length}</strong>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tipo de Cambio a aplicar:</label>
                            <input type="number" id="massExchangeRate" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem;" placeholder="Ej: 1050" step="0.01">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="updateOnlyEmpty" checked style="width: 18px; height: 18px;">
                                <span>Solo actualizar gastos <strong>SIN</strong> tipo de cambio (${withoutTC.length} gastos)</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeMassUpdateTCModal()" style="padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: #e0e0e0; font-weight: 600;">
                                Cancelar
                            </button>
                            <button onclick="applyMassExchangeRate()" style="padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: #ff9800; color: white; font-weight: 600;">
                                Aplicar a ${withoutTC.length} gastos
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeMassUpdateTCModal() {
            const modal = document.getElementById('massUpdateTCModal');
            if (modal) modal.remove();
        }
        
        async function applyMassExchangeRate() {
            const exchangeRate = parseFloat(document.getElementById('massExchangeRate').value);
            const onlyEmpty = document.getElementById('updateOnlyEmpty').checked;
            
            if (!exchangeRate || exchangeRate <= 0) {
                alert('❌ Por favor ingresa un tipo de cambio válido');
                return;
            }
            
            let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            let updated = 0;
            
            expenses = expenses.map(expense => {
                const hasTC = expense.exchangeRate || expense.exchange_rate;
                
                if (onlyEmpty && hasTC) {
                    return expense; // No modificar si ya tiene TC y la opción está activa
                }
                
                const amount = parseFloat(expense.amount) || 0;
                const usd = amount / exchangeRate;
                
                updated++;
                return {
                    ...expense,
                    exchangeRate: exchangeRate,
                    exchange_rate: exchangeRate,
                    usd: usd,
                    usd_amount: usd
                };
            });
            
            // Guardar en localStorage
            localStorage.setItem('expensesDB', JSON.stringify(expenses));
            
            // Actualizar en Supabase
            if (window.supabaseClient) {
                try {
                    for (const expense of expenses) {
                        if (typeof window.supabaseClient.updateExpense === 'function') {
                            await window.supabaseClient.updateExpense(expense.id, {
                                exchange_rate: expense.exchangeRate,
                                usd_amount: expense.usd
                            });
                        }
                    }
                    console.log('✅ Gastos actualizados en Supabase');
                } catch (error) {
                    console.error('Error actualizando en Supabase:', error);
                }
            }
            
            closeMassUpdateTCModal();
            loadExpensesData();
            loadMonthlyExpenses();
            
            alert(`✅ ${updated} gastos actualizados con TC: $${exchangeRate}`);
        }

        // IMPORTANTE: NO inicializar nada hasta verificar autenticación
        // Solo inicializar gastos si el usuario está autenticado
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
        initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesión para gastos:', e);
                }
            }
        }
        
        // Verificar autenticación cuando el DOM esté listo (esto se ejecuta ANTES del DOMContentLoaded del dashboard)
        (function() {
            function verifyAuth() {
                console.log('🔐 Verificando autenticación...');
                checkAuthStatus();
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', verifyAuth);
            } else {
                setTimeout(verifyAuth, 10);
            }
        })();
        
        // Inicializar gastos solo si está autenticado (después de verificar)
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
                            initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesión para gastos:', e);
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExpensesIfAuthenticated);
        } else {
            setTimeout(initExpensesIfAuthenticated, 200);
        }

        // ============================================
        // GESTIÓN DE ADMINISTRADORES
        // ============================================

        // Cargar administradores en la tabla
        async function loadAdminsTable() {
            const tableBody = document.getElementById('adminsTableBody');
            if (!tableBody) return;

            // Mostrar loading
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Cargando administradores...</td></tr>';

            // Obtener administradores (de Supabase si está disponible)
            let admins = [];
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Cargando administradores desde Supabase...');
                    admins = await window.supabaseClient.getAdmins();
                    // Sincronizar con localStorage como backup
                    if (admins && admins.length > 0) {
                        localStorage.setItem('dashboard_admin_users', JSON.stringify(admins));
                    }
                    console.log(`✅ ${admins.length} administradores cargados de Supabase`);
                } else {
                    admins = getAdminUsers();
                }
            } catch (error) {
                console.error('❌ Error cargando administradores:', error);
                admins = getAdminUsers();
            }

            tableBody.innerHTML = '';

            admins.forEach(admin => {
                const row = document.createElement('tr');
                const roleText = admin.role === 'admin_total' ? 'Administrador Total' : 'Usuario';
                const roleBadge = admin.role === 'admin_total' ? 
                    '<span style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Admin Total</span>' :
                    '<span style="background: #666; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Usuario</span>';
                
                const statusBadge = admin.status === 'active' ?
                    '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Activo</span>' :
                    '<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Inactivo</span>';

                // Soportar ambas estructuras de campo (camelCase y snake_case)
                const lastLoginValue = admin.lastLogin || admin.last_login;
                const lastLogin = lastLoginValue ? new Date(lastLoginValue).toLocaleString('es-ES') : 'Nunca';

                row.innerHTML = `
                    <td style="padding: 12px;">${admin.username}</td>
                    <td style="padding: 12px;">${admin.name}</td>
                    <td style="padding: 12px;">${admin.email || '-'}</td>
                    <td style="padding: 12px; text-align: center;">${roleBadge}</td>
                    <td style="padding: 12px; text-align: center;">${lastLogin}</td>
                    <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button class="btn-edit" onclick="editAdmin('${admin.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-edit" onclick="showResetPasswordModal('${admin.id}')" title="Resetear Contraseña" style="background: #ff9800;">
                                <i class="fas fa-key"></i>
                            </button>
                            ${admin.status === 'active' ? 
                                `<button class="btn-delete" onclick="deactivateAdmin('${admin.id}')" title="Dar de Baja">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button class="btn-edit" onclick="activateAdmin('${admin.id}')" title="Activar" style="background: #4caf50;">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Actualizar estadísticas
            updateAdminStats(admins);
        }

        // Actualizar estadísticas de administradores
        function updateAdminStats(admins = null) {
            if (!admins) {
                admins = getAdminUsers();
            }
            const total = admins.length;
            const totalAdmins = admins.filter(a => a.role === 'admin_total').length;
            const totalUsers = admins.filter(a => a.role === 'usuario').length;
            const active = admins.filter(a => a.status === 'active').length;

            document.getElementById('totalAdmins').textContent = total;
            document.getElementById('totalAdminsTotal').textContent = totalAdmins;
            document.getElementById('totalAdminsUser').textContent = totalUsers;
            document.getElementById('activeAdmins').textContent = active;
        }

        // Mostrar modal para nuevo administrador
        function showNewAdminModal() {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden crear nuevos administradores');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Nuevo Administrador';
            document.getElementById('adminId').value = '';
            document.getElementById('adminForm').reset();
            document.getElementById('adminPassword').required = true;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Editar administrador
        function editAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden editar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Editar Administrador';
            document.getElementById('adminId').value = admin.id;
            document.getElementById('adminUsername').value = admin.username;
            document.getElementById('adminName').value = admin.name;
            document.getElementById('adminEmail').value = admin.email || '';
            document.getElementById('adminRole').value = admin.role;
            document.getElementById('adminStatus').value = admin.status;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').required = false;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Guardar administrador
        async function saveAdmin(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden guardar administradores');
                return;
            }

            const adminId = document.getElementById('adminId').value;
            const username = document.getElementById('adminUsername').value.trim();
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const role = document.getElementById('adminRole').value;
            const status = document.getElementById('adminStatus').value;
            const password = document.getElementById('adminPassword').value;

            try {
                // Obtener administradores (de Supabase si está disponible)
                let admins = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    admins = await window.supabaseClient.getAdmins();
                } else {
                    admins = getAdminUsers();
                }

            if (adminId) {
                // Editar
                const adminIndex = admins.findIndex(a => a.id === adminId);
                if (adminIndex === -1) {
                    alert('❌ Administrador no encontrado');
                    return;
                }

                // Verificar que el username no esté en uso por otro admin
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase() && a.id !== adminId);
                if (usernameExists) {
                    alert('❌ El nombre de usuario ya está en uso');
                    return;
                }

                    const updates = {
                        username: username,
                        name: name,
                        email: email,
                        role: role,
                        status: status,
                        updated_at: new Date().toISOString()
                    };
                
                if (password && password.length >= 6) {
                        updates.password_hash = password;
                } else if (password && password.length > 0) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }

                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        console.log('☁️ Actualizando administrador en Supabase...');
                        await window.supabaseClient.updateAdmin(adminId, updates);
                        console.log('✅ Administrador actualizado en Supabase');
                    } else {
                        // Fallback a localStorage
                        admins[adminIndex] = { ...admins[adminIndex], ...updates };
                saveAdminUsers(admins);
                    }
                    
                alert('✅ Administrador actualizado correctamente');
            } else {
                // Nuevo
                if (!password || password.length < 6) {
                    alert('❌ La contraseña debe tener al menos 6 caracteres');
                    return;
                }

                // Verificar que el username no esté en uso
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase());
                if (usernameExists) {
                    alert('❌ El nombre de usuario ya está en uso');
                    return;
                }

                const newAdmin = {
                    username: username,
                        password_hash: password,
                    name: name,
                    email: email,
                    role: role,
                    status: status,
                        created_at: new Date().toISOString(),
                        last_login: null
                };

                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        console.log('☁️ Creando administrador en Supabase...');
                        await window.supabaseClient.createAdmin(newAdmin);
                        console.log('✅ Administrador creado en Supabase');
                    } else {
                        // Fallback a localStorage
                        newAdmin.id = 'admin-' + Date.now();
                admins.push(newAdmin);
                saveAdminUsers(admins);
                    }
                    
                alert('✅ Administrador creado correctamente');
            }

            closeAdminModal();
            loadAdminsTable();
                
            } catch (error) {
                console.error('❌ Error guardando administrador:', error);
                alert('Error al guardar el administrador: ' + error.message);
            }
        }

        // Dar de baja administrador
        function deactivateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden dar de baja administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            if (confirm(`¿Estás seguro de que quieres dar de baja a ${admin.name}?`)) {
                admin.status = 'inactive';
                saveAdminUsers(admins);
                loadAdminsTable();
                alert('✅ Administrador dado de baja correctamente');
            }
        }

        // Activar administrador
        function activateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden activar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }

            admin.status = 'active';
            saveAdminUsers(admins);
            loadAdminsTable();
            alert('✅ Administrador activado correctamente');
        }

        // Mostrar modal para resetear contraseña
        function showResetPasswordModal(adminId) {
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden resetear contraseñas');
                return;
            }

            document.getElementById('resetAdminId').value = adminId;
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Resetear contraseña
        async function resetAdminPassword(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('❌ Solo los administradores totales pueden resetear contraseñas');
                return;
            }

            const adminId = document.getElementById('resetAdminId').value;
            const password = document.getElementById('resetPassword').value;
            const passwordConfirm = document.getElementById('resetPasswordConfirm').value;

            if (password !== passwordConfirm) {
                alert('❌ Las contraseñas no coinciden');
                return;
            }

            if (password.length < 6) {
                alert('❌ La contraseña debe tener al menos 6 caracteres');
                return;
            }

            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Actualizando contraseña en Supabase...');
                    await window.supabaseClient.updateAdmin(adminId, { password_hash: password });
                    console.log('✅ Contraseña actualizada en Supabase');
                } else {
                    // Fallback a localStorage
            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('❌ Administrador no encontrado');
                return;
            }
            admin.password = password;
                    admin.password_hash = password;
            saveAdminUsers(admins);
                }

            closeResetPasswordModal();
            alert('✅ Contraseña reseteada correctamente');
            } catch (error) {
                console.error('❌ Error al resetear contraseña:', error);
                alert('Error al resetear contraseña: ' + error.message);
            }
        }

        // Cerrar modales
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        // Refrescar administradores
        function refreshAdmins() {
            loadAdminsTable();
        }

        // ============================================
        // FUNCIONES DE BACKUP Y RESTAURACIÓN
        // ============================================
        
        async function createFullBackup() {
            try {
                showLoading();
                console.log('💾 Creando backup completo...');
                
                // Recopilar todos los datos
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    createdBy: getCurrentUserName() || 'Sistema',
                    data: {}
                };
                
                // Obtener datos de Supabase si está disponible
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        backupData.data.hotels = await window.supabaseClient.getHotels();
                        backupData.data.reservations = await window.supabaseClient.getReservations();
                        backupData.data.quotes = await window.supabaseClient.getQuotes();
                        backupData.data.expenses = await window.supabaseClient.getExpenses();
                        backupData.data.agents = await window.supabaseClient.getAgents();
                        backupData.source = 'supabase';
                    } catch (e) {
                        console.warn('⚠️ Error obteniendo datos de Supabase, usando localStorage');
                    }
                }
                
                // Fallback a localStorage
                if (!backupData.data.hotels) {
                    backupData.data.hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                    backupData.data.reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    backupData.data.quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                    backupData.data.expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    backupData.data.agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    backupData.data.users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    backupData.data.admins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                    backupData.source = 'localStorage';
                }
                
                // Crear y descargar archivo
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                const time = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                a.href = url;
                a.download = `backup_checkin24hs_${date}_${time}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideLoading();
                
                // Resumen del backup
                const summary = `
✅ BACKUP CREADO EXITOSAMENTE

📊 Resumen:
• Hoteles: ${backupData.data.hotels?.length || 0}
• Reservas: ${backupData.data.reservations?.length || 0}
• Cotizaciones: ${backupData.data.quotes?.length || 0}
• Gastos: ${backupData.data.expenses?.length || 0}
• Agentes: ${backupData.data.agents?.length || 0}

📁 Archivo: backup_checkin24hs_${date}_${time}.json
🔄 Fuente: ${backupData.source === 'supabase' ? 'Supabase (nube)' : 'LocalStorage (local)'}
                `;
                alert(summary);
                
            } catch (error) {
                hideLoading();
                console.error('❌ Error creando backup:', error);
                alert('❌ Error al crear el backup: ' + error.message);
            }
        }
        
        function showRestoreBackupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'restoreBackupModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>🔄 Restaurar Backup</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <p style="color: #e65100; font-weight: 500;">
                                <span class="material-icons" style="vertical-align: middle;">warning</span>
                                ATENCIÓN: Esta acción reemplazará todos los datos actuales con los del backup.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seleccionar archivo de backup (.json)</label>
                            <input type="file" id="backupFileInput" accept=".json" class="form-control" style="padding: 12px;">
                        </div>
                        <div id="backupPreview" style="display: none; margin-top: 16px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
                            <h4 style="margin-bottom: 8px;">📋 Contenido del backup:</h4>
                            <div id="backupPreviewContent"></div>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="form-button secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                        <button class="form-button" id="restoreBackupBtn" style="background: #f44336; color: white;" onclick="executeRestoreBackup()" disabled>
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">restore</span>
                            Restaurar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Manejar selección de archivo
            document.getElementById('backupFileInput').addEventListener('change', previewBackupFile);
        }
        
        let pendingBackupData = null;
        
        function previewBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    pendingBackupData = data;
                    
                    // Mostrar preview
                    const preview = document.getElementById('backupPreview');
                    const content = document.getElementById('backupPreviewContent');
                    
                    content.innerHTML = `
                        <p><strong>📅 Fecha:</strong> ${new Date(data.timestamp).toLocaleString('es-AR')}</p>
                        <p><strong>👤 Creado por:</strong> ${data.createdBy || 'Desconocido'}</p>
                        <p><strong>🔄 Versión:</strong> ${data.version || '1.0'}</p>
                        <hr style="margin: 12px 0;">
                        <p>🏨 Hoteles: <strong>${data.data?.hotels?.length || 0}</strong></p>
                        <p>📋 Reservas: <strong>${data.data?.reservations?.length || 0}</strong></p>
                        <p>💰 Cotizaciones: <strong>${data.data?.quotes?.length || 0}</strong></p>
                        <p>💵 Gastos: <strong>${data.data?.expenses?.length || 0}</strong></p>
                        <p>👥 Agentes: <strong>${data.data?.agents?.length || 0}</strong></p>
                    `;
                    
                    preview.style.display = 'block';
                    document.getElementById('restoreBackupBtn').disabled = false;
                    
                } catch (error) {
                    alert('❌ El archivo no es un backup válido');
                    pendingBackupData = null;
                }
            };
            reader.readAsText(file);
        }
        
        async function executeRestoreBackup() {
            if (!pendingBackupData) {
                alert('❌ No hay backup seleccionado');
                return;
            }
            
            if (!confirm('⚠️ ¿Estás SEGURO de que deseas restaurar este backup?\n\nTodos los datos actuales serán reemplazados.')) {
                return;
            }
            
            try {
                showLoading();
                console.log('🔄 Restaurando backup...');
                
                const data = pendingBackupData.data;
                
                // Guardar en localStorage como fallback
                if (data.hotels) localStorage.setItem('hotelsDB', JSON.stringify(data.hotels));
                if (data.reservations) localStorage.setItem('reservationsDB', JSON.stringify(data.reservations));
                if (data.quotes) localStorage.setItem('quotesDB', JSON.stringify(data.quotes));
                if (data.expenses) localStorage.setItem('expensesDB', JSON.stringify(data.expenses));
                if (data.agents) localStorage.setItem('agentsDB', JSON.stringify(data.agents));
                if (data.users) localStorage.setItem('checkin24hs_users', JSON.stringify(data.users));
                if (data.admins) localStorage.setItem('dashboard_admin_users', JSON.stringify(data.admins));
                
                // Si Supabase está disponible, sincronizar con la nube
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('☁️ Sincronizando con Supabase...');
                    // Nota: La sincronización completa con Supabase requiere borrar y recrear registros
                    // Por ahora solo actualizamos localStorage
                }
                
                hideLoading();
                
                // Cerrar modal
                const modal = document.getElementById('restoreBackupModal');
                if (modal) modal.remove();
                
                alert('✅ Backup restaurado exitosamente.\n\nLa página se recargará para aplicar los cambios.');
                
                // Recargar página
                window.location.reload();
                
            } catch (error) {
                hideLoading();
                console.error('❌ Error restaurando backup:', error);
                alert('❌ Error al restaurar: ' + error.message);
            }
        }
        
        async function checkSyncStatus() {
            const indicator = document.getElementById('syncStatusIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            indicator.style.display = 'block';
            statusText.innerHTML = '⏳ Verificando estado de sincronización...';
            
            try {
                let status = [];
                
                // Verificar Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    status.push('✅ Supabase: Conectado');
                    
                    // Verificar datos de todas las tablas
                    const hotels = await window.supabaseClient.getHotels();
                    const reservations = await window.supabaseClient.getReservations();
                    const agents = await window.supabaseClient.getAgents();
                    
                    let users = [], quotes = [], expenses = [], admins = [];
                    try { users = await window.supabaseClient.getUsers() || []; } catch(e) {}
                    try { quotes = await window.supabaseClient.getQuotes() || []; } catch(e) {}
                    try { expenses = await window.supabaseClient.getExpenses() || []; } catch(e) {}
                    try { admins = await window.supabaseClient.getAdmins() || []; } catch(e) {}
                    
                    status.push(`<strong>📊 DATOS EN SUPABASE:</strong>`);
                    status.push(`&nbsp;&nbsp;🏨 Hoteles: ${hotels.length}`);
                    status.push(`&nbsp;&nbsp;📅 Reservas: ${reservations.length}`);
                    status.push(`&nbsp;&nbsp;👥 Agentes: ${agents.length}`);
                    status.push(`&nbsp;&nbsp;👤 Usuarios: ${users.length}`);
                    status.push(`&nbsp;&nbsp;📋 Cotizaciones: ${quotes.length}`);
                    status.push(`&nbsp;&nbsp;💰 Gastos: ${expenses.length}`);
                    status.push(`&nbsp;&nbsp;🔐 Administradores: ${admins.length}`);
                    
                    // Verificar Realtime
                    if (window.supabaseClient.client.realtime) {
                        status.push('✅ Realtime: Activo (sincronización en tiempo real)');
                    } else {
                        status.push('⚠️ Realtime: No disponible');
                    }
                } else {
                    status.push('⚠️ Supabase: No conectado (usando localStorage)');
                }
                
                // Verificar localStorage
                const localHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const localReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const localAgents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                const localUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const localQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const localExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                const localAdmins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                
                status.push(`<strong>💾 DATOS LOCALES:</strong>`);
                status.push(`&nbsp;&nbsp;🏨 Hoteles: ${localHotels.length}`);
                status.push(`&nbsp;&nbsp;📅 Reservas: ${localReservations.length}`);
                status.push(`&nbsp;&nbsp;👥 Agentes: ${localAgents.length}`);
                status.push(`&nbsp;&nbsp;👤 Usuarios: ${localUsers.length}`);
                status.push(`&nbsp;&nbsp;📋 Cotizaciones: ${localQuotes.length}`);
                status.push(`&nbsp;&nbsp;💰 Gastos: ${localExpenses.length}`);
                status.push(`&nbsp;&nbsp;🔐 Administradores: ${localAdmins.length}`);
                
                statusText.innerHTML = status.join('<br>');
                
            } catch (error) {
                statusText.innerHTML = '❌ Error verificando sincronización: ' + error.message;
            }
        }
        
        // Función para sincronizar TODAS las tablas a Supabase
        async function syncAllTablesToSupabase() {
            const indicator = document.getElementById('syncStatusIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            indicator.style.display = 'block';
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                statusText.innerHTML = '❌ Error: Supabase no está conectado';
                return;
            }
            
            const results = {
                hotels: { synced: 0, errors: 0 },
                reservations: { synced: 0, errors: 0 },
                agents: { synced: 0, errors: 0 },
                users: { synced: 0, errors: 0 },
                quotes: { synced: 0, errors: 0 },
                expenses: { synced: 0, errors: 0 },
                admins: { synced: 0, errors: 0 }
            };
            
            try {
                // 1. SINCRONIZAR HOTELES
                statusText.innerHTML = '🏨 Sincronizando hoteles...';
                const localHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                for (const hotel of localHotels) {
                    try {
                        await window.supabaseClient.upsertHotel(hotel);
                        results.hotels.synced++;
                    } catch (e) {
                        console.error('Error sync hotel:', e);
                        results.hotels.errors++;
                    }
                }
                
                // 2. SINCRONIZAR RESERVAS
                statusText.innerHTML = '📅 Sincronizando reservas...';
                const localReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                for (const reservation of localReservations) {
                    try {
                        await window.supabaseClient.createReservation(reservation);
                        results.reservations.synced++;
                    } catch (e) {
                        results.reservations.errors++;
                    }
                }
                
                // 3. SINCRONIZAR AGENTES
                statusText.innerHTML = '👥 Sincronizando agentes...';
                const localAgents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                for (const agent of localAgents) {
                    try {
                        if (agent.id) {
                            await window.supabaseClient.updateAgent(agent.id, agent);
                        } else {
                            await window.supabaseClient.createAgent(agent);
                        }
                        results.agents.synced++;
                    } catch (e) {
                        results.agents.errors++;
                    }
                }
                
                // 4. SINCRONIZAR USUARIOS
                statusText.innerHTML = '👤 Sincronizando usuarios...';
                const localUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                for (const user of localUsers) {
                    try {
                        if (typeof window.supabaseClient.upsertUser === 'function') {
                            await window.supabaseClient.upsertUser(user);
                        } else if (typeof window.supabaseClient.createUser === 'function') {
                            await window.supabaseClient.createUser(user);
                        }
                        results.users.synced++;
                    } catch (e) {
                        results.users.errors++;
                    }
                }
                
                // 5. SINCRONIZAR COTIZACIONES
                statusText.innerHTML = '📋 Sincronizando cotizaciones...';
                const localQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                for (const quote of localQuotes) {
                    try {
                        if (typeof window.supabaseClient.createQuote === 'function') {
                            await window.supabaseClient.createQuote(quote);
                        }
                        results.quotes.synced++;
                    } catch (e) {
                        results.quotes.errors++;
                    }
                }
                
                // 6. SINCRONIZAR GASTOS (con verificación de duplicados)
                statusText.innerHTML = '💰 Sincronizando gastos...';
                const localExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                for (const expense of localExpenses) {
                    try {
                        // Verificar si el gasto ya existe antes de crearlo
                        if (typeof window.supabaseClient.expenseExists === 'function') {
                            const exists = await window.supabaseClient.expenseExists(expense);
                            if (exists) {
                                console.log('⏭️ Gasto ya existe, saltando:', expense.description);
                                results.expenses.synced++; // Contamos como sincronizado
                                continue;
                            }
                        }
                        if (typeof window.supabaseClient.createExpense === 'function') {
                            await window.supabaseClient.createExpense(expense);
                        }
                        results.expenses.synced++;
                    } catch (e) {
                        results.expenses.errors++;
                    }
                }
                
                // 7. SINCRONIZAR ADMINISTRADORES
                statusText.innerHTML = '🔐 Sincronizando administradores...';
                const localAdmins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                for (const admin of localAdmins) {
                    try {
                        if (typeof window.supabaseClient.createAdmin === 'function') {
                            await window.supabaseClient.createAdmin(admin);
                        }
                        results.admins.synced++;
                    } catch (e) {
                        results.admins.errors++;
                    }
                }
                
                // Mostrar resumen
                let summary = ['<strong>✅ SINCRONIZACIÓN COMPLETADA</strong>', ''];
                summary.push(`🏨 Hoteles: ${results.hotels.synced} sincronizados${results.hotels.errors > 0 ? `, ${results.hotels.errors} errores` : ''}`);
                summary.push(`📅 Reservas: ${results.reservations.synced} sincronizadas${results.reservations.errors > 0 ? `, ${results.reservations.errors} errores` : ''}`);
                summary.push(`👥 Agentes: ${results.agents.synced} sincronizados${results.agents.errors > 0 ? `, ${results.agents.errors} errores` : ''}`);
                summary.push(`👤 Usuarios: ${results.users.synced} sincronizados${results.users.errors > 0 ? `, ${results.users.errors} errores` : ''}`);
                summary.push(`📋 Cotizaciones: ${results.quotes.synced} sincronizadas${results.quotes.errors > 0 ? `, ${results.quotes.errors} errores` : ''}`);
                summary.push(`💰 Gastos: ${results.expenses.synced} sincronizados${results.expenses.errors > 0 ? `, ${results.expenses.errors} errores` : ''}`);
                summary.push(`🔐 Administradores: ${results.admins.synced} sincronizados${results.admins.errors > 0 ? `, ${results.admins.errors} errores` : ''}`);
                
                statusText.innerHTML = summary.join('<br>');
                
                // Refrescar datos
                setTimeout(() => {
                    loadAdminsTable();
                }, 1000);
                
            } catch (error) {
                statusText.innerHTML = '❌ Error en sincronización: ' + error.message;
                console.error('Error sync:', error);
            }
        }

        // Mostrar/ocultar menú de administradores según el rol
        function updateAdminMenuVisibility() {
            const adminMenuLink = document.getElementById('adminMenuLink');
            if (adminMenuLink) {
                if (isAdminTotal()) {
                    adminMenuLink.style.display = 'block';
                } else {
                    adminMenuLink.style.display = 'none';
                }
            }
        }

        // Cargar administradores cuando se muestra la sección
        if (typeof window.showSection === 'function') {
            const originalShowSectionForAdmins = window.showSection;
            window.showSection = function(section, event) {
                originalShowSectionForAdmins(section, event);
                if (section === 'administrators') {
                    setTimeout(() => {
                        loadAdminsTable();
                        updateAdminMenuVisibility();
                    }, 100);
                }
            };
        }

        // Actualizar visibilidad del menú al iniciar sesión
        // Esto se ejecuta después de que showDashboard se define
        setTimeout(() => {
            if (typeof updateAdminMenuVisibility === 'function') {
                // Verificar si ya hay sesión activa
                const authSession = localStorage.getItem('dashboard_auth_session');
                if (authSession) {
                    updateAdminMenuVisibility();
                }
            }
        }, 500);
    </script>
    
    <!-- Modales para Administradores -->
    <!-- Modal Nuevo/Editar Administrador -->
    <div id="adminModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h2 class="modal-title" id="adminModalTitle">Nuevo Administrador</h2>
            <form id="adminForm" onsubmit="saveAdmin(event)">
                <input type="hidden" id="adminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Usuario *</label>
                    <input type="text" id="adminUsername" class="form-input" required placeholder="Nombre de usuario">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="adminName" class="form-input" required placeholder="Nombre completo">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="adminEmail" class="form-input" required placeholder="email@ejemplo.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rol *</label>
                    <select id="adminRole" class="form-input" required>
                        <option value="admin_total">Administrador Total</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
                
                <div class="form-group" id="adminPasswordGroup">
                    <label class="form-label">Contraseña *</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="Mínimo 6 caracteres">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Dejar en blanco para mantener la contraseña actual (solo al editar)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select id="adminStatus" class="form-input">
                        <option value="active">Activo</option>
                        <option value="inactive">Inactivo</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAdminModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Resetear Contraseña -->
    <div id="resetPasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeResetPasswordModal()">&times;</span>
            <h2 class="modal-title">Resetear Contraseña</h2>
            <form id="resetPasswordForm" onsubmit="resetAdminPassword(event)">
                <input type="hidden" id="resetAdminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Nueva Contraseña *</label>
                    <input type="password" id="resetPassword" class="form-input" required placeholder="Mínimo 6 caracteres" minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirmar Contraseña *</label>
                    <input type="password" id="resetPasswordConfirm" class="form-input" required placeholder="Confirma la contraseña" minlength="6">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Resetear Contraseña</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== MODALES PROGRAMA FLEXI ==================== -->
    
    <!-- Modal Nuevo Programa Flexi -->
    <div id="newFlexiProgramModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">add_circle</span>
                    Nuevo Programa Flexi
                </h2>
                <button onclick="closeNewFlexiProgramModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="newFlexiProgramForm" onsubmit="saveFlexiProgram(event)" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel *</label>
                    <select id="flexiProgramHotel" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="">Seleccionar hotel...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Cupos por Voucher *</label>
                        <input type="number" id="flexiProgramCupos" min="1" required placeholder="Ej: 8" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <small style="color: #666; font-size: 12px;">Noches × Personas (ej: 4 noches × 2 personas = 8 cupos)</small>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Precio USD *</label>
                        <input type="number" id="flexiProgramPrecio" min="0" step="0.01" required placeholder="Ej: 1500" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Inicio Periodo de Uso *</label>
                        <input type="date" id="flexiProgramFechaInicio" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fin Periodo de Uso *</label>
                        <input type="date" id="flexiProgramFechaFin" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripción</label>
                    <textarea id="flexiProgramDescripcion" rows="3" placeholder="Descripción del programa (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeNewFlexiProgramModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #9c27b0; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                        Guardar Programa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Emitir Voucher -->
    <div id="emitVoucherModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">card_giftcard</span>
                    Emitir Voucher Flexi
                </h2>
                <button onclick="closeEmitVoucherModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="emitVoucherForm" onsubmit="saveFlexiVoucher(event)" style="padding: 24px;">
                <div class="form-section" style="margin-bottom: 20px;">
                    <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">person</span>
                        Información del Cliente
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre Completo *</label>
                            <input type="text" id="voucherClienteNombre" required placeholder="Nombre del cliente" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email *</label>
                            <input type="email" id="voucherClienteEmail" required placeholder="email@ejemplo.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Teléfono *</label>
                        <input type="tel" id="voucherClienteTelefono" required placeholder="+56 9 1234 5678" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">confirmation_number</span>
                        Información del Voucher
                    </h3>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Programa Flexi *</label>
                        <select id="voucherPrograma" required onchange="onProgramaChange()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Seleccionar programa...</option>
                        </select>
                    </div>
                    <div id="voucherProgramaInfo" style="display: none; background: #e8f5e9; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div>
                                <strong style="color: #2e7d32;">Hotel</strong>
                                <p id="voucherInfoHotel" style="margin: 4px 0 0 0;">-</p>
                            </div>
                            <div>
                                <strong style="color: #2e7d32;">Cupos</strong>
                                <p id="voucherInfoCupos" style="margin: 4px 0 0 0;">-</p>
                            </div>
                            <div>
                                <strong style="color: #2e7d32;">Periodo</strong>
                                <p id="voucherInfoPeriodo" style="margin: 4px 0 0 0;">-</p>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Código de Voucher</label>
                            <input type="text" id="voucherCodigo" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f5f5f5; font-weight: bold; letter-spacing: 1px;">
                            <small style="color: #666; font-size: 12px;">Se genera automáticamente</small>
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Venta *</label>
                            <input type="date" id="voucherFechaVenta" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Notas</label>
                        <textarea id="voucherNotas" rows="2" placeholder="Notas adicionales (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeEmitVoucherModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        Emitir Voucher
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Canje -->
    <div id="registerCanjeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">swap_horiz</span>
                    Registrar Canje de Cupos
                </h2>
                <button onclick="closeRegisterCanjeModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="registerCanjeForm" onsubmit="saveFlexiCanje(event)" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Código de Voucher *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="canjeVoucherCodigo" required placeholder="Ej: FLEXI-LLAO-2024-001" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; text-transform: uppercase;">
                        <button type="button" onclick="buscarVoucherParaCanje()" class="form-button" style="background: #ff9800; color: white;">
                            <span class="material-icons">search</span>
                        </button>
                    </div>
                </div>
                
                <div id="canjeVoucherInfo" style="display: none; background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; color: #e65100;">📋 Información del Voucher</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div>
                            <strong>Cliente:</strong>
                            <span id="canjeInfoCliente">-</span>
                        </div>
                        <div>
                            <strong>Hotel:</strong>
                            <span id="canjeInfoHotel">-</span>
                        </div>
                        <div>
                            <strong>Cupos Disponibles:</strong>
                            <span id="canjeInfoCuposDisponibles" style="font-weight: bold; color: #4caf50;">-</span>
                        </div>
                        <div>
                            <strong>Periodo de Uso:</strong>
                            <span id="canjeInfoPeriodo">-</span>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="margin-bottom: 20px;">
                    <h3 style="color: #ff9800; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">event</span>
                        Datos del Canje (Reserva)
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Check-in *</label>
                            <input type="date" id="canjeCheckIn" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Check-out *</label>
                            <input type="date" id="canjeCheckOut" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Número de Personas *</label>
                            <input type="number" id="canjePersonas" min="1" required placeholder="Ej: 2" onchange="calcularCuposCanje()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Cupos a Usar</label>
                            <input type="number" id="canjeCuposUsar" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #fff3e0; font-weight: bold; color: #e65100;">
                            <small style="color: #666; font-size: 12px;">Noches × Personas = Cupos</small>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Notas del Canje</label>
                        <textarea id="canjeNotas" rows="2" placeholder="Observaciones adicionales (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>

                <div id="canjeWarning" style="display: none; background: #ffebee; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f44336;">
                    <span class="material-icons" style="vertical-align: middle; color: #f44336; margin-right: 8px;">warning</span>
                    <span id="canjeWarningText" style="color: #c62828;"></span>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeRegisterCanjeModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" id="btnRegistrarCanje" class="form-button" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">check_circle</span>
                        Registrar Canje
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalles Voucher -->
    <div id="voucherDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">visibility</span>
                    Detalles del Voucher
                </h2>
                <button onclick="closeVoucherDetailModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <div id="voucherDetailContent" style="padding: 24px;">
                <!-- Contenido se carga dinámicamente -->
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #e0e0e0;">
                <button type="button" onclick="closeVoucherDetailModal()" class="form-button secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Anular Canje -->
    <div id="anularCanjeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">undo</span>
                    Anular Canje
                </h2>
                <button onclick="closeAnularCanjeModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <input type="hidden" id="anularCanjeId">
                <div style="background: #ffebee; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; color: #c62828;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">warning</span>
                        <strong>¿Estás seguro de anular este canje?</strong>
                    </p>
                    <p style="margin: 12px 0 0 0; color: #666;" id="anularCanjeInfo"></p>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Motivo de Anulación *</label>
                    <select id="anularCanjeMotivo" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="">Seleccionar motivo...</option>
                        <option value="cancelacion_cliente">Cancelación solicitada por cliente (>7 días)</option>
                        <option value="cambio_fechas">Cambio de fechas (permitido 1 vez)</option>
                        <option value="error_registro">Error en registro</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="anularCanjeReintegrar" checked style="width: 18px; height: 18px;">
                        <span>Reintegrar cupos al voucher</span>
                    </label>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                        Si se anula con menos de 7 días de antelación, los cupos se pierden según política.
                    </small>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeAnularCanjeModal()" class="form-button secondary">Cancelar</button>
                    <button type="button" onclick="confirmarAnularCanje()" class="form-button" style="background: #f44336; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete</span>
                        Confirmar Anulación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FIN MODALES PROGRAMA FLEXI ==================== -->

    <!-- ==================== SCRIPT PROGRAMA FLEXI ==================== -->
    <script>
    // =====================================================
    // PROGRAMA FLEXI - Sistema de Gestión de Vouchers
    // =====================================================

    // Almacenamiento de datos
    let flexiPrograms = [];
    let flexiVouchers = [];
    let flexiCanjes = [];
    let currentVoucherForCanje = null;

    // =====================================================
    // INICIALIZACIÓN Y CARGA DE DATOS
    // =====================================================

    function initFlexiData() {
        console.log('🎫 Inicializando Programa Flexi...');
        loadFlexiDataFromStorage();
        updateFlexiStats();
        renderFlexiProgramsTable();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        checkExpiredVouchers();
    }

    function loadFlexiDataFromStorage() {
        try {
            const storedPrograms = localStorage.getItem('flexi_programs');
            const storedVouchers = localStorage.getItem('flexi_vouchers');
            const storedCanjes = localStorage.getItem('flexi_canjes');
            
            flexiPrograms = storedPrograms ? JSON.parse(storedPrograms) : [];
            flexiVouchers = storedVouchers ? JSON.parse(storedVouchers) : [];
            flexiCanjes = storedCanjes ? JSON.parse(storedCanjes) : [];
            
            console.log(`✅ Datos Flexi cargados: ${flexiPrograms.length} programas, ${flexiVouchers.length} vouchers, ${flexiCanjes.length} canjes`);
        } catch (error) {
            console.error('❌ Error cargando datos Flexi:', error);
            flexiPrograms = [];
            flexiVouchers = [];
            flexiCanjes = [];
        }
    }

    function saveFlexiDataToStorage() {
        try {
            localStorage.setItem('flexi_programs', JSON.stringify(flexiPrograms));
            localStorage.setItem('flexi_vouchers', JSON.stringify(flexiVouchers));
            localStorage.setItem('flexi_canjes', JSON.stringify(flexiCanjes));
            console.log('💾 Datos Flexi guardados');
        } catch (error) {
            console.error('❌ Error guardando datos Flexi:', error);
        }
    }

    function refreshFlexiData() {
        loadFlexiDataFromStorage();
        updateFlexiStats();
        renderFlexiProgramsTable();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        checkExpiredVouchers();
        showNotification('✅ Datos actualizados correctamente', 'success');
    }

    // =====================================================
    // ESTADÍSTICAS
    // =====================================================

    function updateFlexiStats() {
        const today = new Date().toISOString().split('T')[0];
        
        // Contar vouchers por estado
        let active = 0, partial = 0, used = 0, expired = 0;
        let totalCuposDisponibles = 0;
        
        flexiVouchers.forEach(v => {
            if (v.estado === 'Vencido' || v.fechaFinUso < today) {
                expired++;
            } else if (v.cuposDisponibles === 0) {
                used++;
            } else if (v.cuposDisponibles < v.cuposIniciales) {
                partial++;
                totalCuposDisponibles += v.cuposDisponibles;
            } else {
                active++;
                totalCuposDisponibles += v.cuposDisponibles;
            }
        });
        
        document.getElementById('totalFlexiVouchers').textContent = flexiVouchers.length;
        document.getElementById('activeFlexiVouchers').textContent = active;
        document.getElementById('partialFlexiVouchers').textContent = partial;
        document.getElementById('usedFlexiVouchers').textContent = used;
        document.getElementById('expiredFlexiVouchers').textContent = expired;
        document.getElementById('totalCuposDisponibles').textContent = totalCuposDisponibles;
    }

    // =====================================================
    // VERIFICACIÓN DE VENCIMIENTO (RF-ADM-008)
    // =====================================================

    function checkExpiredVouchers() {
        const today = new Date().toISOString().split('T')[0];
        let updated = false;
        
        flexiVouchers.forEach(voucher => {
            if (voucher.estado !== 'Vencido' && voucher.fechaFinUso < today) {
                voucher.estado = 'Vencido';
                updated = true;
                console.log(`⏰ Voucher ${voucher.codigo} marcado como vencido`);
            }
        });
        
        if (updated) {
            saveFlexiDataToStorage();
            updateFlexiStats();
            renderFlexiVouchersTable();
        }
    }

    // =====================================================
    // PROGRAMAS FLEXI (RF-ADM-001)
    // =====================================================

    function openNewFlexiProgramModal() {
        document.getElementById('newFlexiProgramForm').reset();
        loadHotelsForFlexiProgram();
        document.getElementById('newFlexiProgramModal').style.display = 'flex';
    }

    function closeNewFlexiProgramModal() {
        document.getElementById('newFlexiProgramModal').style.display = 'none';
    }

    function loadHotelsForFlexiProgram() {
        const select = document.getElementById('flexiProgramHotel');
        select.innerHTML = '<option value="">Seleccionar hotel...</option>';
        
        // Cargar hoteles desde el almacenamiento
        const hoteles = JSON.parse(localStorage.getItem('hotels') || '[]');
        hoteles.forEach(hotel => {
            if (hotel.status === 'active' || hotel.estado === 'Activo') {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.nombre;
                option.textContent = hotel.nombre || hotel.name;
                select.appendChild(option);
            }
        });
    }

    function saveFlexiProgram(event) {
        event.preventDefault();
        
        const hotelSelect = document.getElementById('flexiProgramHotel');
        const hotelId = hotelSelect.value;
        const hotelName = hotelSelect.options[hotelSelect.selectedIndex].text;
        
        const program = {
            id: 'PROG-' + Date.now(),
            hotelId: hotelId,
            hotelName: hotelName,
            cuposPorVoucher: parseInt(document.getElementById('flexiProgramCupos').value),
            precioUSD: parseFloat(document.getElementById('flexiProgramPrecio').value),
            fechaInicio: document.getElementById('flexiProgramFechaInicio').value,
            fechaFin: document.getElementById('flexiProgramFechaFin').value,
            descripcion: document.getElementById('flexiProgramDescripcion').value,
            estado: 'Activo',
            fechaCreacion: new Date().toISOString()
        };
        
        flexiPrograms.push(program);
        saveFlexiDataToStorage();
        renderFlexiProgramsTable();
        closeNewFlexiProgramModal();
        showNotification('✅ Programa Flexi creado exitosamente', 'success');
    }

    function renderFlexiProgramsTable() {
        const tbody = document.getElementById('flexiProgramsTableBody');
        if (!tbody) return;
        
        if (flexiPrograms.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">inventory_2</span>
                        <p style="margin-top: 16px;">No hay programas Flexi configurados</p>
                        <button onclick="openNewFlexiProgramModal()" class="form-button" style="background: #9c27b0; color: white; margin-top: 12px;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                            Crear Primer Programa
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiPrograms.map(program => {
            const estadoBadge = program.estado === 'Activo' 
                ? '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Activo</span>'
                : '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Inactivo</span>';
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; font-weight: 500;">${program.hotelName}</td>
                    <td style="padding: 12px; text-align: center;">${program.cuposPorVoucher} cupos</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #4caf50;">$${program.precioUSD.toLocaleString()}</td>
                    <td style="padding: 12px; text-align: center;">${formatDateRange(program.fechaInicio, program.fechaFin)}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editFlexiProgram('${program.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;">
                            <span class="material-icons" style="font-size: 16px;">edit</span>
                        </button>
                        <button onclick="deleteFlexiProgram('${program.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #f44336; color: white;">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function editFlexiProgram(programId) {
        // TODO: Implementar edición de programa
        showNotification('⚠️ Función de edición en desarrollo', 'warning');
    }

    function deleteFlexiProgram(programId) {
        if (confirm('¿Estás seguro de eliminar este programa? Esta acción no se puede deshacer.')) {
            flexiPrograms = flexiPrograms.filter(p => p.id !== programId);
            saveFlexiDataToStorage();
            renderFlexiProgramsTable();
            showNotification('✅ Programa eliminado', 'success');
        }
    }

    // =====================================================
    // EMISIÓN DE VOUCHERS (RF-ADM-002/003)
    // =====================================================

    function openEmitVoucherModal() {
        document.getElementById('emitVoucherForm').reset();
        document.getElementById('voucherProgramaInfo').style.display = 'none';
        loadProgramsForVoucher();
        generateVoucherCode();
        document.getElementById('voucherFechaVenta').value = new Date().toISOString().split('T')[0];
        document.getElementById('emitVoucherModal').style.display = 'flex';
    }

    function closeEmitVoucherModal() {
        document.getElementById('emitVoucherModal').style.display = 'none';
    }

    function loadProgramsForVoucher() {
        const select = document.getElementById('voucherPrograma');
        select.innerHTML = '<option value="">Seleccionar programa...</option>';
        
        flexiPrograms.filter(p => p.estado === 'Activo').forEach(program => {
            const option = document.createElement('option');
            option.value = program.id;
            option.textContent = `${program.hotelName} - ${program.cuposPorVoucher} cupos - $${program.precioUSD}`;
            option.dataset.program = JSON.stringify(program);
            select.appendChild(option);
        });
    }

    function onProgramaChange() {
        const select = document.getElementById('voucherPrograma');
        const infoDiv = document.getElementById('voucherProgramaInfo');
        
        if (select.value && select.selectedOptions[0].dataset.program) {
            const program = JSON.parse(select.selectedOptions[0].dataset.program);
            document.getElementById('voucherInfoHotel').textContent = program.hotelName;
            document.getElementById('voucherInfoCupos').textContent = program.cuposPorVoucher + ' cupos';
            document.getElementById('voucherInfoPeriodo').textContent = formatDateRange(program.fechaInicio, program.fechaFin);
            infoDiv.style.display = 'block';
            
            // Regenerar código con prefijo del hotel
            const hotelPrefix = program.hotelName.substring(0, 4).toUpperCase().replace(/\s/g, '');
            const year = new Date().getFullYear();
            const sequence = String(flexiVouchers.filter(v => v.hotelName === program.hotelName).length + 1).padStart(3, '0');
            document.getElementById('voucherCodigo').value = `FLEXI-${hotelPrefix}-${year}-${sequence}`;
        } else {
            infoDiv.style.display = 'none';
        }
    }

    function generateVoucherCode() {
        const timestamp = Date.now().toString(36).toUpperCase();
        document.getElementById('voucherCodigo').value = `FLEXI-${timestamp}`;
    }

    function saveFlexiVoucher(event) {
        event.preventDefault();
        
        const select = document.getElementById('voucherPrograma');
        if (!select.value) {
            showNotification('⚠️ Debes seleccionar un programa', 'warning');
            return;
        }
        
        const program = JSON.parse(select.selectedOptions[0].dataset.program);
        
        const voucher = {
            id: 'VCH-' + Date.now(),
            codigo: document.getElementById('voucherCodigo').value,
            programaId: program.id,
            hotelId: program.hotelId,
            hotelName: program.hotelName,
            clienteNombre: document.getElementById('voucherClienteNombre').value,
            clienteEmail: document.getElementById('voucherClienteEmail').value,
            clienteTelefono: document.getElementById('voucherClienteTelefono').value,
            cuposIniciales: program.cuposPorVoucher,
            cuposDisponibles: program.cuposPorVoucher,
            precioUSD: program.precioUSD,
            fechaVenta: document.getElementById('voucherFechaVenta').value,
            fechaInicioUso: program.fechaInicio,
            fechaFinUso: program.fechaFin,
            estado: 'Activo',
            notas: document.getElementById('voucherNotas').value,
            fechaCreacion: new Date().toISOString()
        };
        
        flexiVouchers.push(voucher);
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        closeEmitVoucherModal();
        showNotification(`✅ Voucher ${voucher.codigo} emitido exitosamente`, 'success');
    }

    function renderFlexiVouchersTable() {
        const tbody = document.getElementById('flexiVouchersTableBody');
        if (!tbody) return;
        
        if (flexiVouchers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">card_giftcard</span>
                        <p style="margin-top: 16px;">No hay vouchers emitidos</p>
                        <button onclick="openEmitVoucherModal()" class="form-button" style="background: #4caf50; color: white; margin-top: 12px;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                            Emitir Primer Voucher
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiVouchers.map(voucher => {
            const estadoBadge = getEstadoBadge(voucher);
            const cuposDisplay = `<span style="font-weight: bold; color: ${voucher.cuposDisponibles > 0 ? '#4caf50' : '#f44336'};">${voucher.cuposDisponibles}</span>/${voucher.cuposIniciales}`;
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; font-family: monospace; font-weight: bold; color: #9c27b0;">${voucher.codigo}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${voucher.clienteNombre}</div>
                        <div style="font-size: 12px; color: #666;">${voucher.clienteEmail}</div>
                    </td>
                    <td style="padding: 12px;">${voucher.hotelName}</td>
                    <td style="padding: 12px; text-align: center;">${cuposDisplay}</td>
                    <td style="padding: 12px; text-align: center; font-size: 12px;">${formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso)}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewVoucherDetail('${voucher.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;" title="Ver detalles">
                            <span class="material-icons" style="font-size: 16px;">visibility</span>
                        </button>
                        ${voucher.cuposDisponibles > 0 && voucher.estado !== 'Vencido' ? `
                        <button onclick="quickCanje('${voucher.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #ff9800; color: white;" title="Registrar canje">
                            <span class="material-icons" style="font-size: 16px;">swap_horiz</span>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getEstadoBadge(voucher) {
        const today = new Date().toISOString().split('T')[0];
        
        if (voucher.estado === 'Vencido' || voucher.fechaFinUso < today) {
            return '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Vencido</span>';
        } else if (voucher.cuposDisponibles === 0) {
            return '<span style="background: #e3f2fd; color: #1565c0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Usado</span>';
        } else if (voucher.cuposDisponibles < voucher.cuposIniciales) {
            return '<span style="background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Parcial</span>';
        }
        return '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Activo</span>';
    }

    function filterFlexiVouchers(searchTerm) {
        const tbody = document.getElementById('flexiVouchersTableBody');
        const rows = tbody.querySelectorAll('tr');
        const term = searchTerm.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    }

    // =====================================================
    // CANJE DE CUPOS (RF-ADM-004, RF-ADM-005)
    // =====================================================

    function openRegisterCanjeModal() {
        document.getElementById('registerCanjeForm').reset();
        document.getElementById('canjeVoucherInfo').style.display = 'none';
        document.getElementById('canjeWarning').style.display = 'none';
        currentVoucherForCanje = null;
        document.getElementById('registerCanjeModal').style.display = 'flex';
    }

    function closeRegisterCanjeModal() {
        document.getElementById('registerCanjeModal').style.display = 'none';
        currentVoucherForCanje = null;
    }

    function quickCanje(voucherId) {
        const voucher = flexiVouchers.find(v => v.id === voucherId);
        if (voucher) {
            openRegisterCanjeModal();
            document.getElementById('canjeVoucherCodigo').value = voucher.codigo;
            buscarVoucherParaCanje();
        }
    }

    function buscarVoucherParaCanje() {
        const codigo = document.getElementById('canjeVoucherCodigo').value.toUpperCase().trim();
        const voucher = flexiVouchers.find(v => v.codigo.toUpperCase() === codigo);
        const infoDiv = document.getElementById('canjeVoucherInfo');
        const warningDiv = document.getElementById('canjeWarning');
        
        if (!voucher) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Voucher no encontrado. Verifica el código.';
            currentVoucherForCanje = null;
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        // Verificar estado
        if (voucher.estado === 'Vencido' || voucher.fechaFinUso < today) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Este voucher está vencido y no puede ser canjeado.';
            currentVoucherForCanje = null;
            return;
        }
        
        if (voucher.cuposDisponibles <= 0) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Este voucher no tiene cupos disponibles.';
            currentVoucherForCanje = null;
            return;
        }
        
        // Mostrar información del voucher
        currentVoucherForCanje = voucher;
        document.getElementById('canjeInfoCliente').textContent = voucher.clienteNombre;
        document.getElementById('canjeInfoHotel').textContent = voucher.hotelName;
        document.getElementById('canjeInfoCuposDisponibles').textContent = voucher.cuposDisponibles + ' cupos';
        document.getElementById('canjeInfoPeriodo').textContent = formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso);
        
        // Establecer fechas mínimas y máximas
        document.getElementById('canjeCheckIn').min = voucher.fechaInicioUso;
        document.getElementById('canjeCheckIn').max = voucher.fechaFinUso;
        document.getElementById('canjeCheckOut').min = voucher.fechaInicioUso;
        document.getElementById('canjeCheckOut').max = voucher.fechaFinUso;
        
        infoDiv.style.display = 'block';
        warningDiv.style.display = 'none';
    }

    function calcularCuposCanje() {
        const checkIn = document.getElementById('canjeCheckIn').value;
        const checkOut = document.getElementById('canjeCheckOut').value;
        const personas = parseInt(document.getElementById('canjePersonas').value) || 0;
        
        if (checkIn && checkOut && personas > 0) {
            const noches = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
            const cupos = noches * personas;
            document.getElementById('canjeCuposUsar').value = cupos;
            
            // Validar contra cupos disponibles
            const warningDiv = document.getElementById('canjeWarning');
            if (currentVoucherForCanje && cupos > currentVoucherForCanje.cuposDisponibles) {
                warningDiv.style.display = 'block';
                document.getElementById('canjeWarningText').textContent = `Los cupos necesarios (${cupos}) exceden los disponibles (${currentVoucherForCanje.cuposDisponibles}).`;
            } else if (noches <= 0) {
                warningDiv.style.display = 'block';
                document.getElementById('canjeWarningText').textContent = 'La fecha de check-out debe ser posterior a la de check-in.';
            } else {
                warningDiv.style.display = 'none';
            }
        }
    }

    // Calcular cupos cuando cambian las fechas
    document.addEventListener('DOMContentLoaded', function() {
        const checkInInput = document.getElementById('canjeCheckIn');
        const checkOutInput = document.getElementById('canjeCheckOut');
        
        if (checkInInput) checkInInput.addEventListener('change', calcularCuposCanje);
        if (checkOutInput) checkOutInput.addEventListener('change', calcularCuposCanje);
    });

    function saveFlexiCanje(event) {
        event.preventDefault();
        
        if (!currentVoucherForCanje) {
            showNotification('⚠️ Debes buscar y seleccionar un voucher válido', 'warning');
            return;
        }
        
        const cuposUsar = parseInt(document.getElementById('canjeCuposUsar').value);
        
        if (cuposUsar > currentVoucherForCanje.cuposDisponibles) {
            showNotification('⚠️ Los cupos necesarios exceden los disponibles', 'error');
            return;
        }
        
        const checkIn = document.getElementById('canjeCheckIn').value;
        const checkOut = document.getElementById('canjeCheckOut').value;
        
        // Validar fechas dentro del periodo de uso
        if (checkIn < currentVoucherForCanje.fechaInicioUso || checkOut > currentVoucherForCanje.fechaFinUso) {
            showNotification('⚠️ Las fechas deben estar dentro del periodo de uso del voucher', 'error');
            return;
        }
        
        const canje = {
            id: 'CANJE-' + Date.now(),
            voucherId: currentVoucherForCanje.id,
            voucherCodigo: currentVoucherForCanje.codigo,
            clienteNombre: currentVoucherForCanje.clienteNombre,
            hotelName: currentVoucherForCanje.hotelName,
            checkIn: checkIn,
            checkOut: checkOut,
            personas: parseInt(document.getElementById('canjePersonas').value),
            cuposUsados: cuposUsar,
            notas: document.getElementById('canjeNotas').value,
            estado: 'Confirmado',
            fechaRegistro: new Date().toISOString()
        };
        
        // Actualizar cupos disponibles del voucher (RF-ADM-005)
        const voucherIndex = flexiVouchers.findIndex(v => v.id === currentVoucherForCanje.id);
        if (voucherIndex !== -1) {
            flexiVouchers[voucherIndex].cuposDisponibles -= cuposUsar;
            
            // Actualizar estado del voucher
            if (flexiVouchers[voucherIndex].cuposDisponibles === 0) {
                flexiVouchers[voucherIndex].estado = 'Usado';
            } else {
                flexiVouchers[voucherIndex].estado = 'Parcial';
            }
        }
        
        flexiCanjes.push(canje);
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        closeRegisterCanjeModal();
        showNotification(`✅ Canje registrado: ${cuposUsar} cupos usados`, 'success');
    }

    function renderFlexiCanjesTable() {
        const tbody = document.getElementById('flexiCanjesTableBody');
        if (!tbody) return;
        
        if (flexiCanjes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">history</span>
                        <p style="margin-top: 16px;">No hay canjes registrados</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiCanjes.map(canje => {
            const estadoBadge = canje.estado === 'Confirmado'
                ? '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Confirmado</span>'
                : canje.estado === 'Anulado'
                ? '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Anulado</span>'
                : '<span style="background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 20px; font-size: 12px;">No-Show</span>';
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0; ${canje.estado === 'Anulado' ? 'opacity: 0.6;' : ''}">
                    <td style="padding: 12px; font-family: monospace; color: #9c27b0;">${canje.voucherCodigo}</td>
                    <td style="padding: 12px;">${canje.clienteNombre}</td>
                    <td style="padding: 12px; text-align: center;">${formatDateRange(canje.checkIn, canje.checkOut)}</td>
                    <td style="padding: 12px; text-align: center;">${canje.personas}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #ff9800;">${canje.cuposUsados}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        ${canje.estado === 'Confirmado' ? `
                        <button onclick="openAnularCanjeModal('${canje.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #f44336; color: white;" title="Anular canje">
                            <span class="material-icons" style="font-size: 16px;">undo</span>
                        </button>
                        <button onclick="marcarNoShow('${canje.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;" title="Marcar No-Show">
                            <span class="material-icons" style="font-size: 16px;">person_off</span>
                        </button>
                        ` : '-'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // =====================================================
    // ANULACIÓN DE CANJES (RF-ADM-006)
    // =====================================================

    function openAnularCanjeModal(canjeId) {
        const canje = flexiCanjes.find(c => c.id === canjeId);
        if (!canje) return;
        
        document.getElementById('anularCanjeId').value = canjeId;
        document.getElementById('anularCanjeInfo').textContent = 
            `Voucher: ${canje.voucherCodigo} | Fechas: ${formatDateRange(canje.checkIn, canje.checkOut)} | Cupos: ${canje.cuposUsados}`;
        document.getElementById('anularCanjeMotivo').value = '';
        document.getElementById('anularCanjeReintegrar').checked = true;
        document.getElementById('anularCanjeModal').style.display = 'flex';
    }

    function closeAnularCanjeModal() {
        document.getElementById('anularCanjeModal').style.display = 'none';
    }

    function confirmarAnularCanje() {
        const canjeId = document.getElementById('anularCanjeId').value;
        const motivo = document.getElementById('anularCanjeMotivo').value;
        const reintegrar = document.getElementById('anularCanjeReintegrar').checked;
        
        if (!motivo) {
            showNotification('⚠️ Debes seleccionar un motivo de anulación', 'warning');
            return;
        }
        
        const canjeIndex = flexiCanjes.findIndex(c => c.id === canjeId);
        if (canjeIndex === -1) return;
        
        const canje = flexiCanjes[canjeIndex];
        
        // Anular el canje
        flexiCanjes[canjeIndex].estado = 'Anulado';
        flexiCanjes[canjeIndex].motivoAnulacion = motivo;
        flexiCanjes[canjeIndex].fechaAnulacion = new Date().toISOString();
        
        // Reintegrar cupos si corresponde
        if (reintegrar) {
            const voucherIndex = flexiVouchers.findIndex(v => v.id === canje.voucherId);
            if (voucherIndex !== -1) {
                flexiVouchers[voucherIndex].cuposDisponibles += canje.cuposUsados;
                
                // Actualizar estado del voucher
                if (flexiVouchers[voucherIndex].cuposDisponibles === flexiVouchers[voucherIndex].cuposIniciales) {
                    flexiVouchers[voucherIndex].estado = 'Activo';
                } else {
                    flexiVouchers[voucherIndex].estado = 'Parcial';
                }
            }
        }
        
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        closeAnularCanjeModal();
        
        const msg = reintegrar 
            ? `✅ Canje anulado y ${canje.cuposUsados} cupos reintegrados`
            : `✅ Canje anulado (cupos no reintegrados)`;
        showNotification(msg, 'success');
    }

    function marcarNoShow(canjeId) {
        if (!confirm('¿Marcar este canje como No-Show? Los cupos NO se reintegrarán según la política.')) {
            return;
        }
        
        const canjeIndex = flexiCanjes.findIndex(c => c.id === canjeId);
        if (canjeIndex === -1) return;
        
        flexiCanjes[canjeIndex].estado = 'No-Show';
        flexiCanjes[canjeIndex].fechaNoShow = new Date().toISOString();
        
        saveFlexiDataToStorage();
        renderFlexiCanjesTable();
        showNotification('⚠️ Canje marcado como No-Show. Los cupos se perdieron.', 'warning');
    }

    // =====================================================
    // VER DETALLES DEL VOUCHER
    // =====================================================

    function viewVoucherDetail(voucherId) {
        const voucher = flexiVouchers.find(v => v.id === voucherId);
        if (!voucher) return;
        
        const canjesDelVoucher = flexiCanjes.filter(c => c.voucherId === voucherId);
        
        const content = document.getElementById('voucherDetailContent');
        content.innerHTML = `
            <div style="display: grid; gap: 20px;">
                <!-- Información del Voucher -->
                <div style="background: #f3e5f5; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #7b1fa2;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        ${voucher.codigo}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div><strong>Hotel:</strong> ${voucher.hotelName}</div>
                        <div><strong>Estado:</strong> ${getEstadoBadge(voucher)}</div>
                        <div><strong>Cupos:</strong> <span style="font-weight: bold; color: ${voucher.cuposDisponibles > 0 ? '#4caf50' : '#f44336'};">${voucher.cuposDisponibles}/${voucher.cuposIniciales}</span></div>
                        <div><strong>Precio:</strong> $${voucher.precioUSD.toLocaleString()} USD</div>
                        <div><strong>Periodo de Uso:</strong> ${formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso)}</div>
                        <div><strong>Fecha de Venta:</strong> ${formatDate(voucher.fechaVenta)}</div>
                    </div>
                </div>
                
                <!-- Información del Cliente -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #2e7d32;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person</span>
                        Cliente
                    </h3>
                    <div style="display: grid; gap: 8px;">
                        <div><strong>Nombre:</strong> ${voucher.clienteNombre}</div>
                        <div><strong>Email:</strong> ${voucher.clienteEmail}</div>
                        <div><strong>Teléfono:</strong> ${voucher.clienteTelefono}</div>
                    </div>
                </div>
                
                <!-- Historial de Canjes -->
                <div style="background: #fff3e0; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #e65100;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">history</span>
                        Historial de Canjes (${canjesDelVoucher.length})
                    </h3>
                    ${canjesDelVoucher.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ffcc80;">
                                    <th style="padding: 8px; text-align: left;">Fechas</th>
                                    <th style="padding: 8px; text-align: center;">Personas</th>
                                    <th style="padding: 8px; text-align: center;">Cupos</th>
                                    <th style="padding: 8px; text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${canjesDelVoucher.map(c => `
                                    <tr style="border-bottom: 1px solid #ffe0b2;">
                                        <td style="padding: 8px;">${formatDateRange(c.checkIn, c.checkOut)}</td>
                                        <td style="padding: 8px; text-align: center;">${c.personas}</td>
                                        <td style="padding: 8px; text-align: center;">${c.cuposUsados}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            ${c.estado === 'Confirmado' ? '✅' : c.estado === 'Anulado' ? '❌' : '🚫'}
                                            ${c.estado}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #666; margin: 0;">No hay canjes registrados para este voucher.</p>'}
                </div>
                
                ${voucher.notas ? `
                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
                    <strong>Notas:</strong> ${voucher.notas}
                </div>
                ` : ''}
            </div>
        `;
        
        document.getElementById('voucherDetailModal').style.display = 'flex';
    }

    function closeVoucherDetailModal() {
        document.getElementById('voucherDetailModal').style.display = 'none';
    }

    // =====================================================
    // EXPORTAR DATOS
    // =====================================================

    function exportFlexiVouchers() {
        if (flexiVouchers.length === 0) {
            showNotification('⚠️ No hay vouchers para exportar', 'warning');
            return;
        }
        
        const data = flexiVouchers.map(v => ({
            'Código': v.codigo,
            'Hotel': v.hotelName,
            'Cliente': v.clienteNombre,
            'Email': v.clienteEmail,
            'Teléfono': v.clienteTelefono,
            'Cupos Iniciales': v.cuposIniciales,
            'Cupos Disponibles': v.cuposDisponibles,
            'Precio USD': v.precioUSD,
            'Fecha Venta': v.fechaVenta,
            'Inicio Uso': v.fechaInicioUso,
            'Fin Uso': v.fechaFinUso,
            'Estado': v.estado
        }));
        
        // Crear CSV
        const headers = Object.keys(data[0]);
        const csv = [
            headers.join(','),
            ...data.map(row => headers.map(h => `"${row[h]}"`).join(','))
        ].join('\n');
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Vouchers_Flexi_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('✅ Vouchers exportados correctamente', 'success');
    }

    // =====================================================
    // UTILIDADES
    // =====================================================

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatDateRange(start, end) {
        return `${formatDate(start)} - ${formatDate(end)}`;
    }

    function showNotification(message, type = 'info') {
        // Usar la función de notificación existente del dashboard o crear una simple
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3'};
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    }

    // =====================================================
    // INICIALIZACIÓN AL CARGAR
    // =====================================================

    // Inicializar cuando se muestre la sección Flexi
    const originalShowSectionForFlexi = window.showSection;
    if (originalShowSectionForFlexi) {
        window.showSection = function(section, event) {
            if (originalShowSectionForFlexi) {
                originalShowSectionForFlexi(section, event);
            }
            if (section === 'flexi') {
                setTimeout(() => {
                    initFlexiData();
                }, 100);
            }
        };
    }

    // También inicializar al cargar la página por si ya estamos en la sección
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (document.getElementById('flexi-section') && 
                document.getElementById('flexi-section').style.display !== 'none') {
                initFlexiData();
            }
        }, 500);
    });

    // Agregar estilos de animación
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    console.log('Modulo Programa Flexi cargado correctamente');
    </script>
    <!-- ==================== FIN SCRIPT PROGRAMA FLEXI ==================== -->

    <!-- ==================== SCRIPT FLOR IA / INTERACCIONES / CHATS ==================== -->
    <script>
    // =====================================================
    // MÓDULO FLOR IA - INTERACCIONES Y CHATS
    // =====================================================

    // Función para mostrar tabs de Flor
    window.showFlorTab = function(tabName) {
        console.log('📑 Cambiando a tab Flor:', tabName);
        console.log('🔍 DEBUG: showFlorTab ejecutándose, tabName =', tabName);
        
        try {
            // Ocultar todos los tabs
            document.querySelectorAll('.flor-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones de tab
            document.querySelectorAll('.flor-tab').forEach(btn => {
                btn.classList.remove('active');
                // Reset color for tabs
                btn.style.background = '#f5f5f5';
                btn.style.color = '#333';
            });
            
            // Mostrar tab seleccionado
            const tabContent = document.getElementById('flor-tab-' + tabName);
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            // Activar botón
            const tabBtn = document.querySelector(`.flor-tab[data-tab="${tabName}"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
                
                // Si es la pestaña de IA, verificar y mostrar campos si el checkbox está marcado
                if (tabName === 'ai') {
                    // Esperar un momento para que el DOM se actualice
                    setTimeout(() => {
                        const aiEnabled = document.getElementById('ai-enabled');
                        if (aiEnabled && aiEnabled.checked) {
                            toggleAIConfig();
                        }
                    }, 100);
                }
                
                if (tabName === 'whatsapp') {
                    tabBtn.style.background = '#25D366';
                    tabBtn.style.color = 'white';
                } else {
                    tabBtn.style.background = '#1976d2';
                    tabBtn.style.color = 'white';
                }
            }
            
            // Cargar datos específicos del tab
            console.log('🔍 Verificando tab:', tabName, 'Es knowledge o policies?', tabName === 'knowledge' || tabName === 'policies');
            if (tabName === 'knowledge' || tabName === 'policies') {
                console.log('🔄 Cargando hoteles para selector (knowledge/policies)...');
                console.log('🔍 loadHotelsForFlor disponible?', typeof loadHotelsForFlor, typeof window.loadHotelsForFlor);
                if (typeof loadHotelsForFlor === 'function') {
                    console.log('✅ Llamando a loadHotelsForFlor...');
                    loadHotelsForFlor().catch(error => {
                        console.error('❌ Error cargando hoteles para selector:', error);
                    });
                } else if (typeof window.loadHotelsForFlor === 'function') {
                    console.log('✅ Llamando a window.loadHotelsForFlor...');
                    window.loadHotelsForFlor().catch(error => {
                        console.error('❌ Error cargando hoteles para selector:', error);
                    });
                } else {
                    console.warn('⚠️ loadHotelsForFlor no está disponible aún, esperando...');
                    setTimeout(() => {
                        if (typeof loadHotelsForFlor === 'function') {
                            loadHotelsForFlor().catch(error => {
                                console.error('❌ Error cargando hoteles para selector (retry):', error);
                            });
                        } else if (typeof window.loadHotelsForFlor === 'function') {
                            window.loadHotelsForFlor().catch(error => {
                                console.error('❌ Error cargando hoteles para selector (retry):', error);
                            });
                        }
                    }, 500);
                }
            }
            if (tabName === 'whatsapp') {
                loadWhatsAppCards();
            }
        } catch (error) {
            console.error('❌ Error en showFlorTab:', error);
        }
    };

    // Función para cargar las tarjetas de WhatsApp
    window.loadWhatsAppCards = function() {
        console.log('📱 Cargando tarjetas de WhatsApp...');
        const container = document.getElementById('whatsapp-cards-container');
        if (!container) {
            console.warn('⚠️ Contenedor de tarjetas WhatsApp no encontrado');
            return;
        }

        // Cargar URL del servidor guardada y normalizarla
        let serverUrl = localStorage.getItem('whatsapp_server_url') || '';
        const urlInput = document.getElementById('whatsapp-server-url');
        if (urlInput) {
            // Normalizar URL antes de mostrarla
            if (serverUrl) {
                serverUrl = normalizeServerUrl(serverUrl);
                // Actualizar localStorage con URL normalizada
                if (serverUrl) {
                    localStorage.setItem('whatsapp_server_url', serverUrl);
                }
            }
            urlInput.value = serverUrl;
        }

        // Crear 4 tarjetas para WhatsApp 1, 2, 3, 4
        const instances = [1, 2, 3, 4];
        container.innerHTML = '';

        instances.forEach(instance => {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.style.cssText = 'padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;';
            card.innerHTML = `
                <h4 style="margin: 0 0 16px 0; color: #25D366;">📱 WhatsApp ${instance}</h4>
                <div style="margin-bottom: 12px;">
                    <strong>Estado:</strong> <span id="whatsapp-${instance}-status" style="color: #666;">No conectado</span>
                </div>
                <div style="margin-bottom: 12px;">
                    <strong>Número:</strong> <span id="whatsapp-${instance}-number" style="color: #666;">-</span>
                </div>
                <div style="margin-bottom: 16px;">
                    <strong>Nombre:</strong> <span id="whatsapp-${instance}-name" style="color: #666;">-</span>
                </div>
                <div id="whatsapp-${instance}-qr-container" style="margin-bottom: 16px; display: none;">
                    <img id="whatsapp-${instance}-qr-image" src="" alt="QR Code" style="max-width: 200px; border-radius: 8px;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" onclick="connectWhatsApp(${instance})" style="flex: 1;" id="whatsapp-${instance}-connect-btn">
                        Conectar
                    </button>
                    <button class="btn btn-secondary" onclick="updateWhatsAppStatus(${instance})" style="flex: 1;">
                        Actualizar
                    </button>
                </div>
            `;
            container.appendChild(card);
        });

        // Cargar estados iniciales
        instances.forEach(instance => {
            updateWhatsAppStatus(instance);
        });

        console.log('✅ Tarjetas de WhatsApp cargadas');
    };

    // Función auxiliar para normalizar URL del servidor (disponible globalmente)
    window.normalizeServerUrl = function(url) {
        if (!url) return '';
        
        url = url.trim();
        if (!url) return '';
        
        // Si no tiene protocolo, determinar qué protocolo usar
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            // Si el dashboard está en HTTPS, intentar HTTPS primero
            const isDashboardHTTPS = window.location.protocol === 'https:';
            const protocol = isDashboardHTTPS ? 'https://' : 'http://';
            console.log(`🔧 Normalizando URL: agregando ${protocol} a "${url}" (dashboard en ${window.location.protocol})`);
            url = protocol + url;
        }
        
        // Limpiar: remover puerto, rutas y parámetros - solo dejar dominio base
        // Ejemplo: https://api1.checkin24hs.com:3001/api/qr -> https://api1.checkin24hs.com
        try {
            const urlObj = new URL(url);
            // Solo usar protocolo y hostname (sin puerto, sin path, sin query)
            // urlObj.hostname ya no incluye el puerto, pero por si acaso lo removemos
            const hostname = urlObj.hostname.split(':')[0]; // Remover puerto si existe
            const normalized = `${urlObj.protocol}//${hostname}`;
            console.log(`✅ URL normalizada: "${normalized}" (dominio base sin puerto ni rutas)`);
            return normalized;
        } catch (e) {
            // Si falla el parsing, intentar limpiar manualmente
            console.warn(`⚠️ Error parseando URL "${url}", limpiando manualmente:`, e);
            let cleanUrl = url;
            // Remover protocolo temporalmente para limpiar
            const hasProtocol = cleanUrl.startsWith('http://') || cleanUrl.startsWith('https://');
            const protocol = hasProtocol ? (cleanUrl.startsWith('https') ? 'https://' : 'http://') : '';
            let withoutProtocol = hasProtocol ? cleanUrl.replace(/^https?:\/\//, '') : cleanUrl;
            
            // Remover puerto, rutas y parámetros
            withoutProtocol = withoutProtocol.split(':')[0]; // Remover puerto
            withoutProtocol = withoutProtocol.split('/')[0]; // Remover rutas
            withoutProtocol = withoutProtocol.split('?')[0]; // Remover query params
            
            const normalized = protocol + withoutProtocol;
            console.log(`✅ URL normalizada (fallback): "${normalized}"`);
            return normalized;
        }
    };
    
    // Alias local para compatibilidad
    const normalizeServerUrl = window.normalizeServerUrl;

    // Guardar URL del servidor
    window.saveWhatsAppServerUrl = function() {
        const urlInput = document.getElementById('whatsapp-server-url');
        if (!urlInput) return;
        
        let url = urlInput.value.trim();
        if (!url) {
            alert('❌ Por favor ingresa la URL del servidor');
            return;
        }
        
        const cleanUrl = normalizeServerUrl(url);
        localStorage.setItem('whatsapp_server_url', cleanUrl);
        urlInput.value = cleanUrl; // Actualizar el input con la URL normalizada
        alert('✅ URL del servidor guardada correctamente');
        console.log('✅ URL del servidor guardada:', cleanUrl);
    };

    // Variables para polling
    const whatsappPollingIntervals = {};

    // Funciones auxiliares para WhatsApp
    window.connectWhatsApp = async function(instance) {
        console.log(`📱 Conectando WhatsApp ${instance}...`);
        
        let serverUrl = localStorage.getItem('whatsapp_server_url') || '';
        if (!serverUrl) {
            alert('❌ Por favor configura la URL del servidor WhatsApp primero');
            const urlInput = document.getElementById('whatsapp-server-url');
            if (urlInput) urlInput.focus();
            return;
        }
        
        // Normalizar URL (limpiar puerto, rutas, parámetros - solo dominio base)
        serverUrl = normalizeServerUrl(serverUrl);
        // Guardar la URL normalizada de vuelta a localStorage
        if (serverUrl) {
            localStorage.setItem('whatsapp_server_url', serverUrl);
        }
        if (!serverUrl) {
            alert('❌ URL del servidor inválida. Por favor configúrala nuevamente.');
            return;
        }

        // Determinar cómo construir la URL según el tipo de servidor
        // Si es un dominio (no IP), no usar puerto directamente (el proxy maneja el enrutamiento)
        const isDomain = /^https?:\/\/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(serverUrl) && 
                        !/^\d+\.\d+\.\d+\.\d+/.test(serverUrl.replace(/^https?:\/\//, '').split(':')[0]);
        
        const port = 3000 + instance; // 3001, 3002, 3003, 3004 (para referencia)
        
        const statusEl = document.getElementById(`whatsapp-${instance}-status`);
        const connectBtn = document.getElementById(`whatsapp-${instance}-connect-btn`);
        
        if (statusEl) {
            statusEl.textContent = 'Conectando...';
            statusEl.style.color = '#856404';
        }
        if (connectBtn) {
            connectBtn.disabled = true;
            connectBtn.textContent = 'Conectando...';
        }

        // Función auxiliar para construir URL según el tipo (compartida)
        const buildApiUrl = (baseUrl, instanceNum, endpoint = 'qr') => {
            const instPort = 3000 + instanceNum;
            
            console.log(`🔧 buildApiUrl - URL recibida: ${baseUrl}, instancia: ${instanceNum}, endpoint: ${endpoint}`);
            
            // Limpiar la URL: remover puerto si existe y obtener solo el dominio/IP base
            let cleanUrl = baseUrl.replace(/:\d+$/, ''); // Remover puerto al final
            const protocol = cleanUrl.startsWith('https') ? 'https' : 'http';
            const urlWithoutProtocol = cleanUrl.replace(/^https?:\/\//, '');
            
            console.log(`🔧 buildApiUrl - URL limpia: ${cleanUrl}, sin protocolo: ${urlWithoutProtocol}`);
            
            // Detectar si es dominio o IP
            const isDomainUrl = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(urlWithoutProtocol) && 
                               !/^\d+\.\d+\.\d+\.\d+/.test(urlWithoutProtocol.split(':')[0]);
            
            console.log(`🔧 buildApiUrl - ¿Es dominio?: ${isDomainUrl}`);
            
            // Si es un dominio, intentar diferentes estrategias
            if (isDomainUrl) {
                // Estrategia 1: Subdominios (ej: api1.checkin24hs.com, api2.checkin24hs.com)
                // Extraer el dominio base (sin subdominio inicial si existe)
                // Si viene api1.checkin24hs.com, extraer checkin24hs.com como dominio base
                const domainParts = urlWithoutProtocol.split('.');
                let baseDomain;
                
                // Si tiene al menos 2 partes (ej: checkin24hs.com), usar las últimas 2 como dominio base
                if (domainParts.length >= 2) {
                    baseDomain = domainParts.slice(-2).join('.'); // Últimas 2 partes
                } else {
                    baseDomain = urlWithoutProtocol; // Fallback
                }
                
                // Construir subdominio para la instancia
                const subdomain = `api${instanceNum}`;
                const subdomainUrl = `${protocol}://${subdomain}.${baseDomain}/api/${endpoint}`;
                console.log(`🔗 Intentando con subdominio: ${subdomainUrl}`);
                return subdomainUrl;
            } else {
                // Para IPs, usar puerto directamente
                const ipUrl = `${cleanUrl}:${instPort}/api/${endpoint}`;
                console.log(`🔗 Intentando con IP y puerto: ${ipUrl}`);
                return ipUrl;
            }
        };
        
        // Función auxiliar para intentar conexión con timeout
        const tryConnect = async (url, instanceNum) => {
            // Asegurar que la URL esté normalizada antes de usarla
            url = normalizeServerUrl(url);
            if (!url) {
                throw new Error('URL inválida después de normalización');
            }
            const apiUrl = buildApiUrl(url, instanceNum);
            console.log(`🔗 Intentando conectar a: ${apiUrl}`);
            
            // Crear AbortController para timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Timeout: El servidor no respondió en 10 segundos');
                }
                throw error;
            }
        };

        try {
            let data;
            let finalUrl = serverUrl;
            
            // Si el dashboard está en HTTPS y la URL es HTTP, intentar HTTPS primero
            const isDashboardHTTPS = window.location.protocol === 'https:';
            let tryHttpsFirst = false;
            
            if (isDashboardHTTPS && serverUrl.startsWith('http://')) {
                // Dashboard en HTTPS pero URL es HTTP - intentar HTTPS primero para evitar Mixed Content
                const httpsUrl = serverUrl.replace('http://', 'https://');
                console.log(`🔄 Dashboard en HTTPS, intentando HTTPS primero: ${httpsUrl}`);
                try {
                    data = await tryConnect(httpsUrl);
                    finalUrl = httpsUrl;
                    // Actualizar URL guardada si HTTPS funciona
                    localStorage.setItem('whatsapp_server_url', httpsUrl);
                    const urlInput = document.getElementById('whatsapp-server-url');
                    if (urlInput) urlInput.value = httpsUrl;
                    console.log('✅ URL actualizada a HTTPS');
                } catch (httpsError) {
                    console.warn(`⚠️ HTTPS falló, intentando HTTP: ${httpsError.message}`);
                    tryHttpsFirst = true;
                }
            }
            
            // Si HTTPS falló o no se intentó, usar la URL original
            if (!data) {
                try {
                    data = await tryConnect(serverUrl, instance);
                } catch (error) {
                    console.warn(`⚠️ Error con URL original (${serverUrl}):`, error);
                    
                    // Si la URL es HTTPS y falló, intentar con HTTP (solo si dashboard no está en HTTPS)
                    if (serverUrl.startsWith('https://') && !isDashboardHTTPS) {
                        const httpUrl = serverUrl.replace('https://', 'http://');
                    console.log(`🔄 Intentando con HTTP: ${httpUrl}`);
                    try {
                        data = await tryConnect(httpUrl, instance);
                        finalUrl = httpUrl;
                            // Actualizar URL guardada si HTTP funciona
                            localStorage.setItem('whatsapp_server_url', httpUrl);
                            const urlInput = document.getElementById('whatsapp-server-url');
                            if (urlInput) urlInput.value = httpUrl;
                            console.log('✅ URL actualizada a HTTP');
                        } catch (httpError) {
                            console.error('❌ Error también con HTTP:', httpError);
                            throw new Error(`No se pudo conectar al servidor. HTTPS falló: ${error.message}. HTTP falló: ${httpError.message}`);
                        }
                    } else if (tryHttpsFirst) {
                        // Si intentamos HTTPS primero y falló, ahora intentar HTTP
                        const httpUrl = serverUrl.replace('https://', 'http://').replace('http://', 'http://');
                        console.log(`🔄 Intentando con HTTP después de fallo HTTPS: ${httpUrl}`);
                        try {
                            data = await tryConnect(httpUrl, instance);
                            finalUrl = httpUrl;
                            console.log('✅ HTTP funciona después de fallo HTTPS');
                        } catch (httpError) {
                            throw new Error(`No se pudo conectar. HTTPS falló y HTTP también: ${httpError.message}`);
                        }
                    } else {
                        throw error;
                    }
                }
            }
            
            console.log(`📱 Respuesta del servidor WhatsApp ${instance}:`, data);
            
            if (data.status === 'connected') {
                // Ya está conectado
                if (statusEl) {
                    statusEl.textContent = 'Conectado ✅';
                    statusEl.style.color = '#155724';
                }
                if (data.phone) {
                    const numberEl = document.getElementById(`whatsapp-${instance}-number`);
                    const nameEl = document.getElementById(`whatsapp-${instance}-name`);
                    if (numberEl) numberEl.textContent = data.phone;
                    if (nameEl) nameEl.textContent = data.name || data.phone;
                }
                alert('✅ WhatsApp ya está conectado');
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Conectar';
                }
                return;
            }
            
            if (data.qr) {
                // Mostrar QR en modal
                showWhatsAppQRModal(instance, data.qr, data.qrImage);
                
                // Iniciar polling para verificar estado (usar la URL que funcionó)
                startWhatsAppPolling(instance, finalUrl, port);
            } else if (data.status === 'initializing') {
                alert('⏳ El servidor está inicializando. Intenta de nuevo en unos segundos.');
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Conectar';
                }
            } else {
                throw new Error('No se recibió código QR del servidor');
            }
        } catch (error) {
            console.error(`❌ Error conectando WhatsApp ${instance}:`, error);
            
            let errorMessage = `Error conectando WhatsApp ${instance}`;
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                errorMessage += ': Timeout - El servidor no respondió en 10 segundos';
            } else if (error.message.includes('Mixed Content') || (error.message.includes('blocked') && window.location.protocol === 'https:')) {
                errorMessage += ': Mixed Content bloqueado\n\n';
                errorMessage += 'El dashboard está en HTTPS pero el servidor WhatsApp está en HTTP.\n';
                errorMessage += 'Soluciones:\n';
                errorMessage += '1. Configurar HTTPS en los servicios WhatsApp (recomendado)\n';
                errorMessage += '2. Acceder al dashboard por HTTP (http://dashboard.checkin24hs.com)\n';
                errorMessage += '3. Configurar un proxy HTTPS para los servicios WhatsApp';
            } else if (error.message.includes('ERR_CONNECTION_RESET') || error.message.includes('Failed to fetch')) {
                errorMessage += ': No se pudo conectar al servidor. Verifica:\n';
                errorMessage += '1. Que la URL sea correcta\n';
                errorMessage += `2. Que el servicio WhatsApp ${instance} esté corriendo en el puerto ${port}\n`;
                errorMessage += '3. Que el puerto esté abierto y accesible\n';
                if (window.location.protocol === 'https:') {
                    errorMessage += '4. Si el dashboard está en HTTPS, el servidor también debe estar en HTTPS';
                }
            } else {
                errorMessage += `: ${error.message}`;
            }
            
            alert(`❌ ${errorMessage}`);
            
            if (statusEl) {
                statusEl.textContent = 'Error de conexión';
                statusEl.style.color = '#721c24';
            }
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Conectar';
            }
        }
    };

    // Mostrar modal con QR
    window.showWhatsAppQRModal = function(instance, qrCode, qrImageUrl) {
        const modal = document.getElementById('whatsapp-qr-modal');
        const instanceSpan = document.getElementById('qr-modal-instance');
        const qrContainer = document.getElementById('qr-code-container');
        const statusDiv = document.getElementById('qr-status');
        
        if (!modal) return;
        
        if (instanceSpan) instanceSpan.textContent = instance;
        
        // Generar QR visualmente
        if (qrImageUrl) {
            qrContainer.innerHTML = `<img src="${qrImageUrl}" alt="QR Code" style="max-width: 300px; border-radius: 8px; border: 4px solid #25D366;">`;
        } else if (typeof QRCode !== 'undefined') {
            // Usar librería QRCode si está disponible
            qrContainer.innerHTML = '';
            QRCode.toCanvas(qrContainer, qrCode, { width: 300, margin: 2 }, (error) => {
                if (error) {
                    // Fallback a API externa
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrCode)}`;
                    qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 300px; border-radius: 8px; border: 4px solid #25D366;">`;
                }
            });
        } else {
            // Usar API externa
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrCode)}`;
            qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 300px; border-radius: 8px; border: 4px solid #25D366;">`;
        }
        
        if (statusDiv) {
            statusDiv.textContent = '📱 Escanea el código QR con WhatsApp';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        }
        
        modal.style.display = 'flex';
    };

    // Cerrar modal QR
    window.closeWhatsAppQRModal = function() {
        const modal = document.getElementById('whatsapp-qr-modal');
        if (modal) modal.style.display = 'none';
    };

    // Cerrar modal al hacer clic fuera
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('whatsapp-qr-modal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeWhatsAppQRModal();
                }
            });
        }
    });

    // Iniciar polling para verificar estado
    function startWhatsAppPolling(instance, serverUrl, port) {
        // Detener polling anterior si existe
        if (whatsappPollingIntervals[instance]) {
            clearInterval(whatsappPollingIntervals[instance]);
        }
        
        // Normalizar URL antes de usarla
        serverUrl = normalizeServerUrl(serverUrl);
        if (!serverUrl) {
            console.error(`❌ URL inválida para polling WhatsApp ${instance}`);
            return;
        }
        
        // Detectar si es dominio o IP
        const isDomain = /^https?:\/\/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(serverUrl) && 
                        !/^\d+\.\d+\.\d+\.\d+/.test(serverUrl.replace(/^https?:\/\//, '').split(':')[0]);
        
        // Función auxiliar para construir URL según el tipo
        const buildApiUrl = (baseUrl, instanceNum, endpoint = 'status') => {
            const instPort = 3000 + instanceNum;
            
            // Limpiar la URL: remover puerto si existe y obtener solo el dominio/IP base
            let cleanUrl = baseUrl.replace(/:\d+$/, ''); // Remover puerto al final
            const protocol = cleanUrl.startsWith('https') ? 'https' : 'http';
            const urlWithoutProtocol = cleanUrl.replace(/^https?:\/\//, '');
            
            // Detectar si es dominio o IP
            const isDomainUrl = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(urlWithoutProtocol) && 
                               !/^\d+\.\d+\.\d+\.\d+/.test(urlWithoutProtocol.split(':')[0]);
            
            if (isDomainUrl) {
                // Estrategia 1: Subdominios
                // Extraer el dominio base (sin subdominio inicial si existe)
                const domainParts = urlWithoutProtocol.split('.');
                let baseDomain;
                
                // Si tiene al menos 2 partes (ej: checkin24hs.com), usar las últimas 2 como dominio base
                if (domainParts.length >= 2) {
                    baseDomain = domainParts.slice(-2).join('.'); // Últimas 2 partes
                } else {
                    baseDomain = urlWithoutProtocol; // Fallback
                }
                
                // Construir subdominio para la instancia
                const subdomain = `api${instanceNum}`;
                return `${protocol}://${subdomain}.${baseDomain}/api/${endpoint}`;
            } else {
                // Para IPs, usar puerto directamente
                return `${cleanUrl}:${instPort}/api/${endpoint}`;
            }
        };
        
        const checkStatus = async () => {
            try {
                const apiUrl = buildApiUrl(serverUrl, instance, 'status');
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log(`🔄 Estado WhatsApp ${instance}:`, data);
                
                const statusEl = document.getElementById(`whatsapp-${instance}-status`);
                const numberEl = document.getElementById(`whatsapp-${instance}-number`);
                const nameEl = document.getElementById(`whatsapp-${instance}-name`);
                const connectBtn = document.getElementById(`whatsapp-${instance}-connect-btn`);
                const statusDiv = document.getElementById('qr-status');
                
                if (data.whatsapp === 'connected' || data.status === 'open') {
                    // Conectado exitosamente
                    if (statusEl) {
                        statusEl.textContent = 'Conectado ✅';
                        statusEl.style.color = '#155724';
                    }
                    if (numberEl && data.phone) numberEl.textContent = data.phone;
                    if (nameEl && data.name) nameEl.textContent = data.name;
                    if (connectBtn) {
                        connectBtn.disabled = false;
                        connectBtn.textContent = 'Conectar';
                    }
                    if (statusDiv) {
                        statusDiv.textContent = '✅ WhatsApp conectado exitosamente';
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                    }
                    
                    // Cerrar modal después de 2 segundos
                    setTimeout(() => {
                        closeWhatsAppQRModal();
                    }, 2000);
                    
                    // Detener polling
                    clearInterval(whatsappPollingIntervals[instance]);
                    delete whatsappPollingIntervals[instance];
                } else if (data.whatsapp === 'disconnected' || data.status === 'close') {
                    if (statusEl) {
                        statusEl.textContent = 'Desconectado';
                        statusEl.style.color = '#721c24';
                    }
                    if (connectBtn) {
                        connectBtn.disabled = false;
                        connectBtn.textContent = 'Conectar';
                    }
                    clearInterval(whatsappPollingIntervals[instance]);
                    delete whatsappPollingIntervals[instance];
                }
            } catch (error) {
                console.error(`❌ Error verificando estado WhatsApp ${instance}:`, error);
            }
        };
        
        // Verificar cada 3 segundos
        whatsappPollingIntervals[instance] = setInterval(checkStatus, 3000);
        checkStatus(); // Verificar inmediatamente
    }

    window.updateWhatsAppStatus = async function(instance) {
        console.log(`🔄 Actualizando estado de WhatsApp ${instance}...`);
        const statusEl = document.getElementById(`whatsapp-${instance}-status`);
        const numberEl = document.getElementById(`whatsapp-${instance}-number`);
        const nameEl = document.getElementById(`whatsapp-${instance}-name`);
        
        if (statusEl) {
            statusEl.textContent = 'Verificando...';
            statusEl.style.color = '#856404';
        }
        
        let serverUrl = localStorage.getItem('whatsapp_server_url') || '';
        if (!serverUrl) {
            if (statusEl) {
                statusEl.textContent = 'No configurado';
                statusEl.style.color = '#666';
            }
            if (numberEl) numberEl.textContent = '-';
            if (nameEl) nameEl.textContent = '-';
            return;
        }
        
        // Normalizar URL (limpiar puerto, rutas, parámetros - solo dominio base)
        serverUrl = normalizeServerUrl(serverUrl);
        // Guardar la URL normalizada de vuelta a localStorage
        if (serverUrl) {
            localStorage.setItem('whatsapp_server_url', serverUrl);
        }
        if (!serverUrl) {
            if (statusEl) {
                statusEl.textContent = 'URL inválida';
                statusEl.style.color = '#721c24';
            }
            if (numberEl) numberEl.textContent = '-';
            if (nameEl) nameEl.textContent = '-';
            return;
        }
        
        // Detectar si es dominio o IP
        const isDomain = /^https?:\/\/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(serverUrl) && 
                        !/^\d+\.\d+\.\d+\.\d+/.test(serverUrl.replace(/^https?:\/\//, '').split(':')[0]);
        
        // Función auxiliar para construir URL según el tipo
        const buildApiUrl = (baseUrl, instanceNum, endpoint = 'status') => {
            const instPort = 3000 + instanceNum;
            
            console.log(`🔧 buildApiUrl (updateStatus) - URL recibida: ${baseUrl}, instancia: ${instanceNum}, endpoint: ${endpoint}`);
            
            // Limpiar la URL: remover puerto si existe y obtener solo el dominio/IP base
            let cleanUrl = baseUrl.replace(/:\d+$/, ''); // Remover puerto al final
            const protocol = cleanUrl.startsWith('https') ? 'https' : 'http';
            const urlWithoutProtocol = cleanUrl.replace(/^https?:\/\//, '');
            
            console.log(`🔧 buildApiUrl (updateStatus) - URL limpia: ${cleanUrl}, sin protocolo: ${urlWithoutProtocol}`);
            
            // Detectar si es dominio o IP
            const isDomainUrl = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(urlWithoutProtocol) && 
                               !/^\d+\.\d+\.\d+\.\d+/.test(urlWithoutProtocol.split(':')[0]);
            
            console.log(`🔧 buildApiUrl (updateStatus) - ¿Es dominio?: ${isDomainUrl}`);
            
            if (isDomainUrl) {
                // Estrategia 1: Subdominios
                // Extraer el dominio base (sin subdominio inicial si existe)
                const domainParts = urlWithoutProtocol.split('.');
                let baseDomain;
                
                // Si tiene al menos 2 partes (ej: checkin24hs.com), usar las últimas 2 como dominio base
                if (domainParts.length >= 2) {
                    baseDomain = domainParts.slice(-2).join('.'); // Últimas 2 partes
                } else {
                    baseDomain = urlWithoutProtocol; // Fallback
                }
                
                console.log(`🔧 buildApiUrl (updateStatus) - Dominio base extraído: ${baseDomain}`);
                
                // Construir subdominio para la instancia
                const subdomain = `api${instanceNum}`;
                const finalUrl = `${protocol}://${subdomain}.${baseDomain}/api/${endpoint}`;
                console.log(`🔗 Intentando con subdominio: ${finalUrl}`);
                return finalUrl;
            } else {
                // Para IPs, usar puerto directamente
                const finalUrl = `${cleanUrl}:${instPort}/api/${endpoint}`;
                console.log(`🔗 Intentando con IP y puerto: ${finalUrl}`);
                return finalUrl;
            }
        };
        
        try {
            const apiUrl = buildApiUrl(serverUrl, instance, 'status');
            console.log(`🔗 Consultando estado en: ${apiUrl}`);
            const response = await fetch(apiUrl);
            const data = await response.json();
            
            console.log(`📊 Estado WhatsApp ${instance}:`, data);
            
            if (data.whatsapp === 'connected' || data.status === 'open') {
                if (statusEl) {
                    statusEl.textContent = 'Conectado ✅';
                    statusEl.style.color = '#155724';
                }
                if (numberEl && data.phone) numberEl.textContent = data.phone;
                if (nameEl && data.name) nameEl.textContent = data.name;
            } else {
                if (statusEl) {
                    statusEl.textContent = 'No conectado';
                    statusEl.style.color = '#666';
                }
                if (numberEl) numberEl.textContent = '-';
                if (nameEl) nameEl.textContent = '-';
            }
        } catch (error) {
            console.error(`❌ Error obteniendo estado WhatsApp ${instance}:`, error);
            if (statusEl) {
                statusEl.textContent = 'Error';
                statusEl.style.color = '#721c24';
            }
            if (numberEl) numberEl.textContent = '-';
            if (nameEl) nameEl.textContent = '-';
        }
    };

    // Cargar hoteles para selectores de Flor
    // Función para sincronizar automáticamente la información del hotel con Flor IA
    window.syncHotelToFlorKnowledge = function(hotelId, hotelData) {
        try {
            console.log('🔄 Sincronizando hotel con Flor IA:', hotelId);
            
            // Obtener el hotel completo desde localStorage o usar los datos proporcionados
            let hotel = hotelData;
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
            }
            
            if (!hotel) {
                console.warn('⚠️ Hotel no encontrado para sincronizar:', hotelId);
                return;
            }
            
            // Obtener conocimiento existente de Flor
            const knowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
            const existingKnowledge = knowledge[hotelId] || {};
            
            // Preparar información sincronizada del hotel
            const syncedInfo = {
                name: hotel.name,
                location: hotel.location,
                rating: hotel.rating || 0,
                priceRange: hotel.priceRange || hotel.price_range || hotel.price || null,
                amenities: hotel.amenities || [],
                mainImage: hotel.mainImage || (hotel.images && Array.isArray(hotel.images) ? hotel.images[0] : null),
                galleryImages: hotel.galleryImages || (hotel.images && Array.isArray(hotel.images) ? hotel.images.slice(1) : []),
                googleMaps: hotel.googleMaps || hotel.google_maps || null,
                website: hotel.website || null,
                description: hotel.description || null
            };
            
            // Actualizar conocimiento manteniendo información adicional existente
            knowledge[hotelId] = {
                ...existingKnowledge,
                syncedInfo: syncedInfo,
                lastSynced: new Date().toISOString()
            };
            
            // Guardar en localStorage
            localStorage.setItem('flor_hotel_knowledge', JSON.stringify(knowledge));
            
            // También actualizar FlorKnowledgeBase si está disponible
            if (typeof FlorKnowledgeBase !== 'undefined' && typeof FlorKnowledgeBase.saveHotelKnowledge === 'function') {
                FlorKnowledgeBase.saveHotelKnowledge(hotelId, knowledge[hotelId]);
            }
            
            console.log('✅ Hotel sincronizado con Flor IA:', hotel.name);
            
            // Actualizar selector de hoteles en la pestaña de conocimiento si está visible
            if (typeof loadHotelsForFlor === 'function') {
                loadHotelsForFlor();
            }
            
            // Si la pestaña de conocimiento está abierta y este hotel está seleccionado, recargar
            const knowledgeTab = document.getElementById('flor-tab-knowledge');
            if (knowledgeTab && knowledgeTab.style.display !== 'none') {
                const selector = document.getElementById('knowledge-hotel-selector');
                if (selector && selector.value === String(hotelId)) {
                    if (typeof loadSelectedHotelKnowledge === 'function') {
                        loadSelectedHotelKnowledge();
                    }
                }
            }
            
        } catch (error) {
            console.error('❌ Error sincronizando hotel con Flor IA:', error);
        }
    };

    async function loadHotelsForFlor() {
        console.log('🏨 Cargando hoteles para selector de Flor...');
        
        let hotels = [];
        
        // Intentar cargar desde Supabase primero
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                hotels = await window.supabaseClient.getHotels();
                console.log(`✅ ${hotels.length} hoteles cargados desde Supabase para selector`);
                if (hotels.length > 0) {
                    console.log('📋 Primeros hoteles:', hotels.slice(0, 3).map(h => ({ id: h.id, name: h.name })));
                }
            } catch (error) {
                console.warn('⚠️ Error cargando hoteles desde Supabase, usando localStorage:', error);
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
        } else {
            // Fallback a localStorage
            hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            console.log(`📦 ${hotels.length} hoteles cargados desde localStorage para selector`);
        }
        
        const selectors = ['knowledge-hotel-selector', 'policy-hotel-select'];
        
        selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                selector.innerHTML = '<option value="">-- Seleccione un hotel --</option>';
                hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    // Asegurar que el ID sea string para comparaciones
                    option.value = String(hotel.id);
                    option.textContent = hotel.name || hotel.nombre || 'Hotel sin nombre';
                    selector.appendChild(option);
                });
                console.log(`✅ Selector ${selectorId} actualizado con ${hotels.length} hoteles`);
            } else {
                console.warn(`⚠️ Selector ${selectorId} no encontrado en el DOM`);
            }
        });
    }
    
    // Hacer la función disponible globalmente
    window.loadHotelsForFlor = loadHotelsForFlor;

    // Guardar configuración general de Flor (incluye multimodal)
    window.saveFlorGeneral = function() {
        const config = {
            // Configuración básica
            name: document.getElementById('flor-name')?.value || 'Flor',
            role: document.getElementById('flor-role')?.value || 'Agente Multimodal de Conversación',
            greeting: document.getElementById('flor-greeting')?.value || '',
            personality: document.getElementById('flor-personality')?.value || '',
            // Configuración multimodal
            multimodal: {
                audio: {
                    enabled: document.getElementById('audio-enabled')?.checked ?? true,
                    maxDuration: parseInt(document.getElementById('audio-max-duration')?.value) || 45
                },
                imageInput: {
                    enabled: document.getElementById('image-input-enabled')?.checked ?? true
                },
                imageOutput: {
                    enabled: document.getElementById('image-output-enabled')?.checked ?? true,
                    apiEndpoint: document.getElementById('image-api-endpoint')?.value || '/api/hoteles/imagen/{nombre_hotel}'
                }
            }
        };
        localStorage.setItem('flor_general_config', JSON.stringify(config));
        
        // También actualizar el servicio multimodal si existe
        if (typeof florMultimodalService !== 'undefined') {
            florMultimodalService.config.audio.enabled = config.multimodal.audio.enabled;
            florMultimodalService.config.audio.maxDuration = config.multimodal.audio.maxDuration;
            florMultimodalService.config.image.enabled = config.multimodal.imageInput.enabled;
        }
        
        alert('✅ Configuración general y multimodal guardada');
        console.log('💾 Configuración Flor guardada:', config);
    };

    // Cargar configuración general (incluye multimodal)
    function loadFlorGeneral() {
        const config = JSON.parse(localStorage.getItem('flor_general_config') || '{}');
        
        // Configuración básica
        if (config.name) document.getElementById('flor-name').value = config.name;
        if (config.role) document.getElementById('flor-role').value = config.role;
        if (config.greeting) document.getElementById('flor-greeting').value = config.greeting;
        if (config.personality) document.getElementById('flor-personality').value = config.personality;
        
        // Configuración multimodal
        if (config.multimodal) {
            const audioEnabled = document.getElementById('audio-enabled');
            const audioMaxDuration = document.getElementById('audio-max-duration');
            const imageInputEnabled = document.getElementById('image-input-enabled');
            const imageOutputEnabled = document.getElementById('image-output-enabled');
            const imageApiEndpoint = document.getElementById('image-api-endpoint');
            
            if (audioEnabled) audioEnabled.checked = config.multimodal.audio?.enabled ?? true;
            if (audioMaxDuration) audioMaxDuration.value = config.multimodal.audio?.maxDuration || 45;
            if (imageInputEnabled) imageInputEnabled.checked = config.multimodal.imageInput?.enabled ?? true;
            if (imageOutputEnabled) imageOutputEnabled.checked = config.multimodal.imageOutput?.enabled ?? true;
            if (imageApiEndpoint) imageApiEndpoint.value = config.multimodal.imageOutput?.apiEndpoint || '/api/hoteles/imagen/{nombre_hotel}';
        }
    }

    // Guardar respuestas predefinidas (incluye multimodales)
    window.saveFlorResponses = function() {
        const responses = {
            // Respuestas generales
            noEntendido: document.getElementById('response-no-entendido')?.value || '',
            transferir: document.getElementById('response-transferir')?.value || '',
            despedida: document.getElementById('response-despedida')?.value || '',
            // Respuestas multimodales - Audio
            audioFallback: document.getElementById('response-audio-fallback')?.value || 'Disculpa, el audio no fue del todo claro. Para atenderte con la rapidez que mereces, ¿podrías enviarme tu consulta por escrito, o prefieres que te conecte con un agente ahora mismo?',
            audioProcessing: document.getElementById('response-audio-processing')?.value || 'Un momento, estoy escuchando tu mensaje de voz... 🎧',
            // Respuestas multimodales - Imágenes entrada
            imageFallback: document.getElementById('response-image-fallback')?.value || 'No pude identificar claramente la imagen. ¿Podrías describirme qué estás buscando o enviar otra foto con mejor iluminación?',
            imageProcessing: document.getElementById('response-image-processing')?.value || 'Un momento, estoy analizando la imagen... 🔍',
            imageHotelFound: document.getElementById('response-image-hotel-found')?.value || '¡Reconozco esa imagen! Se trata de {nombre_hotel}. Te cuento más sobre este hotel:',
            // Respuestas multimodales - Imágenes salida
            imageSending: document.getElementById('response-image-sending')?.value || 'Aquí te muestro una foto de {nombre_hotel}:',
            imageNotAvailable: document.getElementById('response-image-not-available')?.value || 'Lo siento, no tengo imágenes disponibles de este hotel en este momento. ¿Te gustaría que te conecte con un agente que pueda mostrarte fotos?'
        };
        localStorage.setItem('flor_responses', JSON.stringify(responses));
        
        // Actualizar servicio multimodal si existe
        if (typeof florMultimodalService !== 'undefined') {
            florMultimodalService.config.audio.fallbackMessage = responses.audioFallback;
            florMultimodalService.config.audio.processingMessage = responses.audioProcessing;
            florMultimodalService.config.image.fallbackMessage = responses.imageFallback;
            florMultimodalService.config.image.processingMessage = responses.imageProcessing;
        }
        
        alert('✅ Respuestas guardadas (generales y multimodales)');
        console.log('💾 Respuestas Flor guardadas:', responses);
    };
    
    // Cargar respuestas predefinidas
    function loadFlorResponses() {
        const responses = JSON.parse(localStorage.getItem('flor_responses') || '{}');
        
        // Generales
        if (responses.noEntendido) document.getElementById('response-no-entendido').value = responses.noEntendido;
        if (responses.transferir) document.getElementById('response-transferir').value = responses.transferir;
        if (responses.despedida) document.getElementById('response-despedida').value = responses.despedida;
        
        // Multimodales - Audio
        if (responses.audioFallback) document.getElementById('response-audio-fallback').value = responses.audioFallback;
        if (responses.audioProcessing) document.getElementById('response-audio-processing').value = responses.audioProcessing;
        
        // Multimodales - Imágenes entrada
        if (responses.imageFallback) document.getElementById('response-image-fallback').value = responses.imageFallback;
        if (responses.imageProcessing) document.getElementById('response-image-processing').value = responses.imageProcessing;
        if (responses.imageHotelFound) document.getElementById('response-image-hotel-found').value = responses.imageHotelFound;
        
        // Multimodales - Imágenes salida
        if (responses.imageSending) document.getElementById('response-image-sending').value = responses.imageSending;
        if (responses.imageNotAvailable) document.getElementById('response-image-not-available').value = responses.imageNotAvailable;
    }

    // Guardar políticas de hotel
    window.saveFlorPolicies = function() {
        const hotelId = document.getElementById('policy-hotel-select')?.value;
        if (!hotelId) {
            alert('⚠️ Selecciona un hotel primero');
            return;
        }
        
        const policies = JSON.parse(localStorage.getItem('flor_policies') || '{}');
        policies[hotelId] = {
            condicionesReserva: document.getElementById('policy-condiciones-reserva')?.value || '',
            cancelacionModificacion: document.getElementById('policy-cancelacion-modificacion')?.value || ''
        };
        localStorage.setItem('flor_policies', JSON.stringify(policies));
        alert('✅ Políticas guardadas para el hotel');
    };

    // Cargar políticas de hotel
    window.loadHotelPolicies = function() {
        const hotelId = document.getElementById('policy-hotel-select')?.value;
        const form = document.getElementById('hotel-policies-form');
        
        if (!hotelId) {
            if (form) form.style.display = 'none';
            return;
        }
        
        if (form) form.style.display = 'block';
        
        const policies = JSON.parse(localStorage.getItem('flor_policies') || '{}');
        const hotelPolicies = policies[hotelId] || {};
        
        document.getElementById('policy-condiciones-reserva').value = hotelPolicies.condicionesReserva || '';
        document.getElementById('policy-cancelacion-modificacion').value = hotelPolicies.cancelacionModificacion || '';
    };

    // Toggle AI Config
    window.toggleAIConfig = function() {
        const enabled = document.getElementById('ai-enabled')?.checked;
        const fields = document.getElementById('ai-config-fields');
        if (fields) {
            fields.style.display = enabled ? 'block' : 'none';
        }
    };

    // Actualizar modelo según proveedor seleccionado
    window.updateAIModel = function() {
        const provider = document.getElementById('ai-provider')?.value;
        const modelInput = document.getElementById('ai-model');
        const modelHelp = document.getElementById('ai-model-help');
        
        const models = {
            gemini: { default: 'gemini-2.5-flash', help: 'Modelos: gemini-2.5-flash (recomendado), gemini-2.0-flash, gemini-2.5-pro' },
            openai: { default: 'gpt-4o-mini', help: 'Modelos OpenAI: gpt-4o-mini (económico), gpt-4o (potente), gpt-4-turbo' },
            claude: { default: 'claude-3-haiku-20240307', help: 'Modelos Claude: claude-3-haiku (rápido), claude-3-sonnet, claude-3-opus (potente)' }
        };
        
        if (models[provider]) {
            if (modelInput) modelInput.value = models[provider].default;
            if (modelHelp) modelHelp.textContent = models[provider].help;
        }
    };

    // Guardar configuración de IA
    window.saveAIConfig = async function() {
        const config = {
            enabled: document.getElementById('ai-enabled')?.checked || false,
            provider: document.getElementById('ai-provider')?.value || 'gemini',
            apiKey: document.getElementById('ai-api-key')?.value || '',
            model: document.getElementById('ai-model')?.value || 'gemini-2.5-flash',
            temperature: parseFloat(document.getElementById('ai-temperature')?.value) || 0.7,
            maxTokens: parseInt(document.getElementById('ai-max-tokens')?.value) || 500
        };
        
        // Guardar en localStorage
        localStorage.setItem('flor_ai_config', JSON.stringify(config));
        
        // Guardar en Supabase para persistencia en la nube
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                await window.supabaseClient.client
                    .from('system_config')
                    .upsert({
                        key: 'flor_ai_config',
                        value: JSON.stringify(config),
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'key' });
                console.log('☁️ Configuración de IA guardada en Supabase');
            } catch (e) {
                console.warn('⚠️ No se pudo guardar en Supabase:', e);
            }
        }
        
        // Recargar el servicio de IA si está disponible
        if (typeof florAIService !== 'undefined') {
            florAIService.loadConfig();
            console.log('🔄 Servicio de IA recargado');
        }
        
        alert('✅ Configuración de IA guardada y sincronizada');
    };

    // Probar conexión IA
    window.testAIConfig = async function() {
        const provider = document.getElementById('ai-provider')?.value || 'gemini';
        const apiKey = document.getElementById('ai-api-key')?.value || '';
        const model = document.getElementById('ai-model')?.value || 'gemini-1.5-flash';
        
        if (!apiKey) {
            alert('⚠️ Por favor ingresa tu API Key primero');
            return;
        }
        
        alert('🔄 Probando conexión con ' + provider.toUpperCase() + '...');
        
        try {
            let response;
            const testMessage = 'Responde solo con: OK';
            
            if (provider === 'gemini') {
                // Primero listar modelos disponibles
                console.log('📋 Listando modelos disponibles...');
                console.log('🔑 API Key (primeros 10 chars):', apiKey.substring(0, 10) + '...');
                
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                console.log('🔗 URL Lista:', listUrl);
                
                try {
                    const listResponse = await fetch(listUrl);
                    const listData = await listResponse.json();
                    
                    console.log('📦 Respuesta completa:', JSON.stringify(listData, null, 2));
                    
                    if (listData.error) {
                        alert('❌ Error con API Key:\n\n' + listData.error.message + '\n\n💡 Asegúrate de copiar la API Key COMPLETA desde Google AI Studio.');
                        return;
                    }
                    
                    if (!listData.models || listData.models.length === 0) {
                        alert('❌ La API no devolvió modelos.\n\nRevisa la consola del navegador (F12) para más detalles.');
                        console.log('⚠️ Respuesta sin modelos:', listData);
                        return;
                    }
                    
                    // Buscar modelos que soporten generateContent
                    const availableModels = listData.models.filter(m => 
                        m.supportedGenerationMethods?.includes('generateContent')
                    ).map(m => m.name.replace('models/', ''));
                    
                    console.log('✅ Modelos con generateContent:', availableModels);
                    
                    if (availableModels.length === 0) {
                        // Mostrar todos los modelos disponibles
                        const allModels = listData.models.map(m => m.name);
                        alert('⚠️ Modelos encontrados pero ninguno soporta generateContent:\n\n' + allModels.join('\n'));
                        return;
                    }
                    
                    // Preferir modelos flash
                    let modelToUse = availableModels.find(m => m.includes('flash')) || 
                                     availableModels.find(m => m.includes('pro')) || 
                                     availableModels[0];
                    console.log('🎯 Usando modelo:', modelToUse);
                    
                    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKey}`;
                    
                    response = await fetch(geminiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: testMessage }] }],
                            generationConfig: { maxOutputTokens: 100 }
                        })
                    });
                    
                    const responseData = await response.json();
                    console.log('📨 Respuesta generateContent:', responseData);
                    
                    if (responseData.error) {
                        alert('❌ Error al generar:\n\n' + responseData.error.message);
                        return;
                    }
                    
                    if (responseData.candidates && responseData.candidates[0]) {
                        const aiResponse = responseData.candidates[0].content?.parts?.[0]?.text || 'Respuesta vacía';
                        alert('✅ ¡Conexión exitosa!\n\nModelo: ' + modelToUse + '\n\nRespuesta: ' + aiResponse.substring(0, 200));
                        
                        // Actualizar el campo del modelo
                        if (document.getElementById('ai-model')) {
                            document.getElementById('ai-model').value = modelToUse;
                        }
                        return; // Éxito, salir
                    }
                    
                } catch (e) {
                    console.error('❌ Error:', e);
                    alert('❌ Error de conexión: ' + e.message);
                    return;
                }
                return; // Evitar continuar con el código de abajo
            } else if (provider === 'openai') {
                // OpenAI API
                response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model || 'gpt-4o-mini',
                        messages: [{ role: 'user', content: testMessage }],
                        max_tokens: 10
                    })
                });
            } else if (provider === 'claude') {
                // Claude API (Anthropic)
                response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: model || 'claude-3-haiku-20240307',
                        max_tokens: 10,
                        messages: [{ role: 'user', content: testMessage }]
                    })
                });
            }
            
            if (response && response.ok) {
                const data = await response.json();
                console.log('✅ Respuesta de IA:', data);
                alert('✅ ¡Conexión exitosa con ' + provider.toUpperCase() + '!\n\nLa API está funcionando correctamente.');
            } else {
                const errorData = await response?.json().catch(() => ({}));
                console.error('❌ Error de API:', errorData);
                alert('❌ Error de conexión:\n\n' + (errorData.error?.message || response?.statusText || 'Error desconocido'));
            }
        } catch (error) {
            console.error('❌ Error de conexión:', error);
            alert('❌ Error de conexión:\n\n' + error.message);
        }
    };

    // Verificar conexión WhatsApp
    window.checkWhatsAppConnection = function() {
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://localhost:3001';
        const statusIndicator = document.getElementById('whatsapp-status-indicator');
        const statusText = document.getElementById('whatsapp-status-text');
        const statusDetail = document.getElementById('whatsapp-status-detail');
        
        if (statusText) statusText.textContent = 'Verificando conexión...';
        if (statusDetail) statusDetail.textContent = 'Conectando con ' + serverUrl;
        
        fetch(serverUrl + '/status')
            .then(response => response.json())
            .then(data => {
                if (data.connected || data.status === 'connected') {
                    if (statusIndicator) statusIndicator.style.background = '#4caf50';
                    if (statusText) statusText.textContent = '✅ Conectado';
                    if (statusDetail) statusDetail.textContent = 'WhatsApp está funcionando correctamente';
                    
                    document.getElementById('whatsapp-qr-section').style.display = 'none';
                    document.getElementById('whatsapp-info-section').style.display = 'block';
                    
                    if (data.phone) document.getElementById('whatsapp-phone-number').textContent = data.phone;
                    if (data.name) document.getElementById('whatsapp-user-name').textContent = data.name;
                } else if (data.qr) {
                    if (statusIndicator) statusIndicator.style.background = '#ff9800';
                    if (statusText) statusText.textContent = '📲 Esperando escaneo QR';
                    if (statusDetail) statusDetail.textContent = 'Escanea el código QR con tu teléfono';
                    
                    document.getElementById('whatsapp-qr-section').style.display = 'block';
                    document.getElementById('whatsapp-info-section').style.display = 'none';
                    document.getElementById('whatsapp-qr-code').textContent = data.qr;
                } else {
                    if (statusIndicator) statusIndicator.style.background = '#9e9e9e';
                    if (statusText) statusText.textContent = '⚠️ Desconectado';
                    if (statusDetail) statusDetail.textContent = 'Servidor disponible pero WhatsApp no conectado';
                }
            })
            .catch(error => {
                console.error('Error verificando WhatsApp:', error);
                if (statusIndicator) statusIndicator.style.background = '#f44336';
                if (statusText) statusText.textContent = '❌ Error de conexión';
                if (statusDetail) statusDetail.textContent = 'No se pudo conectar con el servidor';
            });
    };

    // Guardar config WhatsApp
    window.saveWhatsAppConfig = async function() {
        const config = {
            serverUrl: document.getElementById('whatsapp-server-url')?.value || '',
            autoReply: document.getElementById('whatsapp-auto-reply')?.checked || false
        };
        
        // Guardar en localStorage
        localStorage.setItem('flor_whatsapp_config', JSON.stringify(config));
        
        // Guardar en Supabase para persistencia en la nube (usando clave específica)
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                await window.supabaseClient.client
                    .from('system_config')
                    .upsert({
                        key: 'whatsapp_server_config',
                        value: JSON.stringify(config),
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'key' });
                console.log('☁️ Configuración de WhatsApp guardada en Supabase');
            } catch (e) {
                console.warn('⚠️ No se pudo guardar configuración de WhatsApp en Supabase:', e);
            }
        }
        
        alert('✅ Configuración de WhatsApp guardada y sincronizada');
    };

    // Desconectar WhatsApp
    window.disconnectWhatsApp = function() {
        if (!confirm('¿Estás seguro de desconectar WhatsApp?')) return;
        
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://localhost:3001';
        fetch(serverUrl + '/disconnect', { method: 'POST' })
            .then(() => {
                alert('WhatsApp desconectado');
                checkWhatsAppConnection();
            })
            .catch(error => {
                console.error('Error desconectando:', error);
                alert('Error al desconectar');
            });
    };

    // Cargar interacciones
    window.loadInteractions = async function() {
        console.log('📋 Cargando interacciones... [VERSIÓN CORREGIDA - ' + new Date().toISOString() + ']');
        console.log('🔍 DEBUG: Verificando elementos del DOM...');
        const tbody = document.getElementById('interactionsTableBody');
        console.log('🔍 DEBUG: interactionsTableBody encontrado:', !!tbody);
        
        if (!tbody) {
            console.warn('⚠️ interactionsTableBody no encontrado, saliendo...');
            return;
        }
        
        // Mostrar cargando
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                    <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px; animation: spin 1s linear infinite;">sync</span>
                    Cargando interacciones...
                </td>
            </tr>
        `;
        
        try {
            let interactions = [];
            
            // Verificar si Supabase está disponible
            if (!window.supabaseClient) {
                console.warn('⚠️ window.supabaseClient no está disponible');
            } else if (!window.supabaseClient.isInitialized()) {
                console.warn('⚠️ Supabase no está inicializado');
            } else {
                console.log('✅ Supabase disponible, cargando interacciones...');
            }
            
            // Intentar cargar desde Supabase
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                interactions = await window.supabaseClient.getFlorInteractions(100);
                console.log(`🌸 ${interactions.length} interacciones cargadas desde Supabase`);
            } else {
                console.log('⚠️ Usando fallback a localStorage');
            }
            
            // Fallback a localStorage si no hay en Supabase
            if (interactions.length === 0) {
                const localInteractions = JSON.parse(localStorage.getItem('flor_interactions') || '[]');
                console.log(`📦 ${localInteractions.length} interacciones encontradas en localStorage`);
                interactions = localInteractions.map(inter => ({
                    id: inter.id,
                    created_at: inter.date || new Date().toISOString(),
                    phone: inter.client || 'web',
                    user_message: inter.userMessage || '',
                    bot_response: inter.botResponse || '',
                    intent: inter.intent || 'consulta_general',
                    success: inter.status === 'resolved',
                    used_ai: inter.usedAI || false
                }));
            }
            
            if (interactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">chat</span>
                            No hay interacciones registradas aún
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar interacciones por fecha (más recientes primero)
            const sortedInteractions = interactions.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            // Actualizar estadísticas
            updateInteractionsStats(sortedInteractions);
            
            // Mostrar interacciones individuales (no agrupadas)
            tbody.innerHTML = sortedInteractions.slice(0, 100).map(inter => {
                const userMessage = (inter.user_message || '').substring(0, 80) + ((inter.user_message || '').length > 80 ? '...' : '');
                const intent = inter.intent || 'consulta_general';
                const status = inter.success !== false ? 'resolved' : 'pending';
                const statusColor = status === 'resolved' ? '#4caf50' : '#ff9800';
                const statusText = status === 'resolved' ? 'Resuelto' : 'Pendiente';
                
                return `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; font-size: 0.9rem;">${new Date(inter.created_at).toLocaleString('es-ES')}</td>
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${inter.phone ? `<span class="material-icons" style="font-size: 18px; color: #25D366;">phone</span>` : ''}
                            ${inter.email ? `<span class="material-icons" style="font-size: 18px; color: #1976d2;">email</span>` : ''}
                            <span>${inter.phone || inter.email || 'Web'}</span>
                        </div>
                    </td>
                    <td style="padding: 12px; max-width: 300px;">
                        <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${inter.user_message || ''}">
                            ${userMessage || '-'}
                        </div>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                            ${intent.replace(/_/g, ' ')}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                            ${statusText}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewInteractionDetails('${inter.id}')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            Ver Detalles
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            
            console.log(`✅ ${sortedInteractions.length} interacciones mostradas`);
        } catch (error) {
            console.error('❌ Error cargando interacciones:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #d32f2f;">
                        <span class="material-icons" style="font-size: 48px; color: #d32f2f; display: block; margin-bottom: 16px;">error</span>
                        Error al cargar interacciones
                    </td>
                </tr>
            `;
        }
    };
    
    // Actualizar estadísticas de interacciones
    function updateInteractionsStats(interactions) {
        const total = interactions.length;
        const successful = interactions.filter(i => i.success !== false).length;
        const successRate = total > 0 ? Math.round((successful / total) * 100) : 0;
        const intents = new Set(interactions.map(i => i.intent || 'consulta_general'));
        const aiResponses = interactions.filter(i => i.used_ai || i.usedAI).length;
        
        const totalEl = document.getElementById('stat-total-interactions');
        const successEl = document.getElementById('stat-success-rate');
        const intentsEl = document.getElementById('stat-common-intents');
        const aiEl = document.getElementById('stat-ai-responses');
        
        if (totalEl) totalEl.textContent = total;
        if (successEl) successEl.textContent = successRate + '%';
        if (intentsEl) intentsEl.textContent = intents.size;
        if (aiEl) aiEl.textContent = aiResponses;
    }
    
    // Analizar aprendizaje de Flor
    window.analyzeFlorLearning = async function() {
        const analysisDiv = document.getElementById('learning-analysis');
        if (!analysisDiv) return;
        
        analysisDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <span class="material-icons" style="font-size: 48px; color: #ccc; animation: spin 1s linear infinite;">sync</span>
                <p style="margin-top: 12px; color: #666;">Analizando interacciones...</p>
            </div>
        `;
        
        try {
            let analysis = {};
            
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                analysis = await window.supabaseClient.analyzeFlorInteractions(200);
            } else {
                const interactions = JSON.parse(localStorage.getItem('flor_interactions') || '[]');
                if (window.supabaseClient && typeof window.supabaseClient.analyzeInteractionsLocal === 'function') {
                    analysis = window.supabaseClient.analyzeInteractionsLocal(interactions);
                } else {
                    analysis = {
                        total: interactions.length,
                        successful: interactions.filter(i => i.success !== false).length,
                        failed: interactions.filter(i => i.success === false).length,
                        intents: {},
                        commonWords: {},
                        mostCommonQuestions: []
                    };
                }
            }
            
            // Mostrar análisis
            analysisDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <!-- Intents más comunes -->
                    <div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">🎯 Intents más Comunes</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${Object.entries(analysis.intents || {})
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 5)
                                .map(([intent, count]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px;">
                                        <span style="color: #555; font-size: 0.9rem;">${intent.replace(/_/g, ' ')}</span>
                                        <span style="background: #1976d2; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${count}</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                    
                    <!-- Palabras clave -->
                    <div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">🔑 Palabras Clave Más Usadas</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${Object.entries(analysis.commonWords || {})
                                .slice(0, 10)
                                .map(([word, count]) => `
                                    <span style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem;">
                                        ${word} (${count})
                                    </span>
                                `).join('')}
                        </div>
                    </div>
                    
                    <!-- Preguntas más comunes -->
                    <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">❓ Preguntas Más Frecuentes</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${(analysis.mostCommonQuestions || []).slice(0, 5).map(q => `
                                <div style="padding: 12px; background: white; border-radius: 4px; border-left: 3px solid #2196f3;">
                                    <div style="color: #333; font-size: 0.9rem;">${q.question || q}</div>
                                    ${q.count ? `<div style="color: #666; font-size: 0.8rem; margin-top: 4px;">Aparece ${q.count} veces</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Sugerencias de mejora -->
                    ${(analysis.improvementSuggestions || []).length > 0 ? `
                    <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800; grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">💡 Sugerencias de Mejora</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #555;">
                            ${analysis.improvementSuggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            console.error('Error analizando:', error);
            analysisDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #d32f2f;">
                    <span class="material-icons" style="font-size: 48px; color: #d32f2f;">error</span>
                    <p style="margin-top: 12px;">Error al analizar interacciones</p>
                </div>
            `;
        }
    };
    
    // Ver detalles de una interacción
    window.viewInteractionDetails = function(interactionId) {
        // Cargar todas las interacciones
        let interactions = [];
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            window.supabaseClient.getFlorInteractions(1000).then(data => {
                interactions = data;
                showInteractionModal(interactionId, interactions);
            });
        } else {
            interactions = JSON.parse(localStorage.getItem('flor_interactions') || '[]');
            showInteractionModal(interactionId, interactions);
        }
    };
    
    // Mostrar modal con detalles de interacción
    function showInteractionModal(interactionId, interactions) {
        const interaction = interactions.find(i => i.id === interactionId);
        if (!interaction) {
            alert('Interacción no encontrada');
            return;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                    <h2 style="margin: 0; color: #333;">Detalles de la Interacción</h2>
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Fecha:</strong>
                        <span>${new Date(interaction.created_at).toLocaleString('es-ES')}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Cliente:</strong>
                        <span>${interaction.phone || interaction.email || 'Web'}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Intent:</strong>
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem;">
                            ${(interaction.intent || 'consulta_general').replace(/_/g, ' ')}
                        </span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Mensaje del Usuario:</strong>
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; border-left: 3px solid #1976d2;">
                            ${interaction.user_message || interaction.userMessage || '-'}
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Respuesta de Flor:</strong>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            ${interaction.bot_response || interaction.botResponse || '-'}
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Estado:</strong>
                        <span style="background: ${interaction.success !== false ? '#4caf50' : '#ff9800'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem;">
                            ${interaction.success !== false ? '✅ Resuelto' : '⏳ Pendiente'}
                        </span>
                    </div>
                    ${interaction.metadata && Object.keys(interaction.metadata).length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <strong style="color: #666; display: block; margin-bottom: 8px;">Información Adicional:</strong>
                        <pre style="background: #f5f5f5; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 0.85rem;">${JSON.stringify(interaction.metadata, null, 2)}</pre>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Exportar interacciones
    window.exportInteractions = async function() {
        let interactions = [];
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            interactions = await window.supabaseClient.getFlorInteractions(1000);
        } else {
            interactions = JSON.parse(localStorage.getItem('flor_interactions') || '[]');
        }
        
        if (interactions.length === 0) {
            alert('No hay interacciones para exportar');
            return;
        }
        
        // Convertir a CSV
        const headers = ['Fecha', 'Cliente', 'Mensaje Usuario', 'Respuesta Flor', 'Intent', 'Estado'];
        const csv = [
            headers.join(','),
            ...interactions.map(i => [
                new Date(i.created_at).toLocaleString('es-ES'),
                i.phone || i.email || 'Web',
                `"${(i.user_message || i.userMessage || '').replace(/"/g, '""')}"`,
                `"${(i.bot_response || i.botResponse || '').replace(/"/g, '""')}"`,
                i.intent || 'consulta_general',
                i.success !== false ? 'Resuelto' : 'Pendiente'
            ].join(','))
        ].join('\n');
        
        // Descargar
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `flor_interacciones_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`✅ ${interactions.length} interacciones exportadas`);
    };
    
    // Función global para que Flor guarde interacciones automáticamente
    window.saveFlorInteraction = async function(interactionData) {
        if (!window.supabaseClient) {
            console.warn('⚠️ Supabase client no disponible');
            return;
        }
        
        try {
            const saved = await window.supabaseClient.saveFlorInteraction(interactionData);
            console.log('✅ Interacción guardada:', saved.id);
            
            // Si estamos en la pestaña de interacciones, actualizar
            const interactionsSection = document.getElementById('interactions-section');
            if (interactionsSection && interactionsSection.style.display !== 'none') {
                loadInteractions();
            }
            
            return saved;
        } catch (error) {
            console.error('❌ Error guardando interacción:', error);
        }
    };
    
    // Función helper para que Flor guarde interacciones fácilmente
    // Uso: saveFlorInteractionHelper('¿Tienen habitaciones disponibles?', 'Sí, tenemos habitaciones disponibles...', 'consulta_disponibilidad', true)
    window.saveFlorInteractionHelper = async function(userMessage, botResponse, intent = 'consulta_general', success = true, metadata = {}) {
        const interactionData = {
            userMessage: userMessage,
            botResponse: botResponse,
            intent: intent,
            success: success,
            usedAI: true,
            metadata: {
                ...metadata,
                source: 'flor_ia',
                timestamp: new Date().toISOString()
            }
        };
        
        // Intentar obtener información del usuario si está disponible
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get('phone') || metadata.phone || null;
        const email = urlParams.get('email') || metadata.email || null;
        
        if (phone) interactionData.phone = phone;
        if (email) interactionData.email = email;
        
        return await window.saveFlorInteraction(interactionData);
    };
    
    // Ejemplo de uso cuando Flor responde a un mensaje:
    // 
    // async function florRespondToMessage(userMessage, context) {
    //     // Generar respuesta usando IA
    //     const response = await generateAIResponse(userMessage, context);
    //     
    //     // Guardar la interacción para aprendizaje
    //     await window.saveFlorInteractionHelper(
    //         userMessage,
    //         response.text,
    //         response.intent || 'consulta_general',
    //         true, // success
    //         {
    //             hotelId: context.hotelId,
    //             confidence: response.confidence,
    //             model: response.model
    //         }
    //     );
    //     
    //     return response;
    // }

    // Cargar chats activos desde Supabase
    window.loadChats = async function() {
        console.log('💬 Cargando chats activos... [VERSIÓN CORREGIDA - ' + new Date().toISOString() + ']');
        console.log('🔍 DEBUG: Verificando elementos del DOM...');
        const chatsList = document.getElementById('chatsList');
        console.log('🔍 DEBUG: chatsList encontrado:', !!chatsList);
        
        if (!chatsList) {
            console.warn('⚠️ chatsList no encontrado, saliendo...');
            return;
        }
        
        // Mostrar cargando
        chatsList.innerHTML = `
            <div style="text-align: center; padding: 40px 16px; color: #666;">
                <span class="material-icons" style="font-size: 36px; color: #ccc; animation: spin 1s linear infinite;">sync</span>
                <p style="margin-top: 12px;">Cargando chats...</p>
            </div>
        `;
        
        try {
            let chats = [];
            
            // Verificar si Supabase está disponible
            if (!window.supabaseClient) {
                console.warn('⚠️ window.supabaseClient no está disponible');
            } else if (!window.supabaseClient.isInitialized()) {
                console.warn('⚠️ Supabase no está inicializado');
            } else {
                console.log('✅ Supabase disponible, cargando chats...');
            }
            
            // Intentar cargar desde Supabase
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                chats = await window.supabaseClient.getWhatsAppChats(50);
                console.log(`📱 ${chats.length} chats cargados desde Supabase`);
            } else {
                console.log('⚠️ Usando fallback a localStorage');
            }
            
            // Fallback a localStorage si no hay en Supabase
            if (chats.length === 0) {
                const localChats = JSON.parse(localStorage.getItem('flor_active_chats') || '[]');
                console.log(`📦 ${localChats.length} chats encontrados en localStorage`);
                chats = localChats.map(chat => ({
                    id: chat.id,
                    phone: chat.phone,
                    name: chat.clientName || chat.phone || 'Cliente',
                    last_message: chat.lastText || null,
                    last_message_time: chat.lastMessage || new Date().toISOString(),
                    unread_count: 0,
                    users: { name: chat.clientName || null }
                }));
            }
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 16px; color: #666;">
                        <span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span>
                        <p style="margin-top: 12px;">No hay chats activos</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar chats
            chatsList.innerHTML = chats.map(chat => {
                const userName = chat.users?.name || chat.name || chat.phone || 'Cliente';
                const lastMessage = chat.last_message || 'Sin mensajes';
                const lastMessageTime = chat.last_message_time ? new Date(chat.last_message_time).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                const unreadBadge = chat.unread_count > 0 
                    ? `<span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">${chat.unread_count}</span>` 
                    : '';
                
                return `
                    <div onclick="selectChat('${chat.id}')" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; ${chat.unread_count > 0 ? 'background: #f0fff4;' : ''}" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${chat.unread_count > 0 ? '#f0fff4' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${userName}${unreadBadge}</strong>
                            <span style="font-size: 0.75rem; color: #999;">${lastMessageTime}</span>
                        </div>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}</p>
                    </div>
                `;
            }).join('');
            
            // Suscribirse a cambios en tiempo real
            if (window.supabaseClient && window.supabaseClient.isInitialized() && !window.whatsappChatsSubscription) {
                window.whatsappChatsSubscription = window.supabaseClient.subscribeToWhatsAppChats((payload) => {
                    console.log('📱 Cambio en chat detectado, recargando...');
                    window.loadChats();
                });
                
                window.whatsappMessagesSubscription = window.supabaseClient.subscribeToWhatsAppMessages((message) => {
                    console.log('📱 Nuevo mensaje recibido, recargando chats...');
                    window.loadChats();
                });
                
                console.log('✅ Suscripciones en tiempo real activas para chats');
            }
        } catch (error) {
            console.error('❌ Error cargando chats:', error);
            chatsList.innerHTML = `
                <div style="text-align: center; padding: 40px 16px; color: #d32f2f;">
                    <span class="material-icons" style="font-size: 36px; color: #d32f2f;">error</span>
                    <p style="margin-top: 12px;">Error al cargar chats</p>
                </div>
            `;
        }
    };

    // Seleccionar chat
    window.selectChat = function(chatId) {
        console.log('💬 Chat seleccionado:', chatId);
        const chats = JSON.parse(localStorage.getItem('flor_active_chats') || '[]');
        const chat = chats.find(c => c.id === chatId);
        
        if (!chat) return;
        
        const header = document.getElementById('chatHeader');
        const messages = document.getElementById('chatMessages');
        const inputContainer = document.getElementById('chatInputContainer');
        
        if (header) {
            header.innerHTML = `<h3 style="margin: 0; font-size: 1.1rem;">${chat.clientName || chat.phone || 'Cliente'}</h3>`;
        }
        
        if (messages && chat.messages) {
            messages.innerHTML = chat.messages.map(msg => `
                <div style="margin-bottom: 12px; display: flex; justify-content: ${msg.fromClient ? 'flex-start' : 'flex-end'};">
                    <div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${msg.fromClient ? '#e3f2fd' : '#1976d2'}; color: ${msg.fromClient ? '#333' : 'white'};">
                        ${msg.text}
                        <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.7;">${new Date(msg.time).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
            messages.scrollTop = messages.scrollHeight;
        }
        
        if (inputContainer) {
            inputContainer.style.display = 'block';
            inputContainer.dataset.chatId = chatId;
        }
    };

    // Enviar mensaje en chat
    window.sendChatMessage = function() {
        const input = document.getElementById('chatMessageInput');
        const container = document.getElementById('chatInputContainer');
        
        if (!input || !input.value.trim()) return;
        
        const chatId = container?.dataset.chatId;
        const message = input.value.trim();
        
        console.log('📤 Enviando mensaje a chat:', chatId, message);
        
        // Aquí iría la lógica para enviar el mensaje vía WhatsApp API
        alert('Mensaje enviado: ' + message + '\n\n(Requiere integración con servidor WhatsApp)');
        
        input.value = '';
    };

    // Cargar conocimiento del hotel seleccionado (sincronizado con sección Hoteles)
    window.loadSelectedHotelKnowledge = async function() {
        console.log('🔍 loadSelectedHotelKnowledge ejecutándose...');
        const hotelId = document.getElementById('knowledge-hotel-selector')?.value;
        const container = document.getElementById('hotels-knowledge-list');
        
        console.log('📋 Hotel ID seleccionado:', hotelId);
        console.log('📦 Contenedor encontrado:', !!container);
        
        if (!hotelId || !container) {
            if (container) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Seleccione un hotel para ver/editar su base de conocimiento</p>';
            }
            return;
        }
        
        // Mostrar mensaje de carga
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">⏳ Cargando información del hotel...</p>';
        
        let hotels = [];
        let hotel = null;
        
        // Intentar cargar desde Supabase primero
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                hotels = await window.supabaseClient.getHotels();
                console.log(`📊 Total hoteles cargados: ${hotels.length}`);
                // Buscar hotel con comparación flexible (string vs número)
                hotel = hotels.find(h => String(h.id) === String(hotelId) || h.id === hotelId || h.id == hotelId);
                if (hotel) {
                    console.log('✅ Hotel encontrado desde Supabase:', hotel.name, 'ID:', hotel.id);
                } else {
                    console.warn('⚠️ Hotel no encontrado. IDs disponibles:', hotels.slice(0, 3).map(h => ({ id: h.id, type: typeof h.id, name: h.name })));
                }
            } catch (error) {
                console.error('❌ Error cargando hotel desde Supabase:', error);
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => String(h.id) === String(hotelId) || h.id === hotelId || h.id == hotelId);
            }
        } else {
            // Fallback a localStorage
            hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            hotel = hotels.find(h => String(h.id) === String(hotelId) || h.id === hotelId || h.id == hotelId);
            console.log('📦 Hotel cargado desde localStorage para base de conocimiento');
        }
        
        if (!hotel) {
            console.error('❌ Hotel no encontrado con ID:', hotelId);
            container.innerHTML = '<p style="color: #e53935; text-align: center; padding: 40px;">❌ Hotel no encontrado. Por favor, seleccione otro hotel.</p>';
            return;
        }
        
        console.log('✅ Hotel encontrado, mostrando información...');
        
        // Cargar conocimiento extra de Flor
        const florKnowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
        const extraKnowledge = florKnowledge[hotelId] || {};
        
        // Obtener imágenes del hotel
        const mainImage = hotel.mainImage || (hotel.images && hotel.images[0]) || '';
        const galleryImages = hotel.galleryImages || (hotel.images && hotel.images.slice(1)) || [];
        const amenitiesList = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : (hotel.amenities || '');
        
        // Construir HTML con información sincronizada + campos extra
        container.innerHTML = `
            <div style="display: grid; gap: 24px;">
                <!-- Información Sincronizada (Solo Lectura) -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span>🔄</span> Información Sincronizada desde Hoteles
                        <span style="font-size: 0.8rem; color: #2e7d32; font-weight: normal;">(Solo lectura - Editar en sección Hoteles)</span>
                    </h4>
                    
                    <div style="display: grid; gap: 16px;">
                        <!-- Nombre y Ubicación -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">🏨 Nombre del Hotel</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.name || 'No especificado'}</div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">📍 Ubicación</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.location || 'No especificada'}</div>
                            </div>
                        </div>
                        
                        <!-- Rating y Precio -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">⭐ Calificación</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.rating || '0'}/5</div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">💰 Rango de Precio</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.priceRange || hotel.price_range || 'No especificado'}</div>
                            </div>
                        </div>
                        
                        <!-- Amenidades -->
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">🎯 Servicios/Amenidades</label>
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${amenitiesList || 'No especificados'}</div>
                        </div>
                        
                        <!-- Imágenes del Hotel -->
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">🖼️ Imágenes Disponibles</label>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                ${mainImage ? `
                                    <div style="text-align: center;">
                                        <img src="${mainImage}" alt="Principal" style="width: 100px; height: 70px; object-fit: cover; border-radius: 6px; border: 2px solid #4caf50;">
                                        <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">Principal</div>
                                    </div>
                                ` : '<span style="color: #999;">Sin imagen principal</span>'}
                                ${galleryImages.length > 0 ? galleryImages.slice(0, 4).map((img, i) => `
                                    <div style="text-align: center;">
                                        <img src="${img}" alt="Galería ${i+1}" style="width: 100px; height: 70px; object-fit: cover; border-radius: 6px;">
                                        <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">Galería ${i+1}</div>
                                    </div>
                                `).join('') : ''}
                                ${galleryImages.length > 4 ? `<div style="display: flex; align-items: center; color: #666;">+${galleryImages.length - 4} más</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Google Maps y Sitio Web -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            ${hotel.googleMaps ? `
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">🗺️ Google Maps</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                    <a href="${hotel.googleMaps}" target="_blank" style="color: #1976d2; text-decoration: none;">📍 Ver en Google Maps</a>
                                </div>
                            </div>
                            ` : '<div></div>'}
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">🌐 Sitio Web del Hotel</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                    ${hotel.website ? `<a href="${hotel.website}" target="_blank" style="color: #1976d2; text-decoration: none;">🔗 Visitar sitio web</a>` : '<span style="color: #999;">No configurado</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Acceso Automático a Sitio Web -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span>🤖</span> Acceso Automático al Sitio Web
                        <span style="font-size: 0.8rem; color: #2e7d32; font-weight: normal;">(Flor buscará información automáticamente)</span>
                    </h4>
                    ${hotel.website ? `
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #a5d6a7;">
                        <p style="margin: 0 0 12px 0; color: #1b5e20;">
                            ✅ <strong>Sitio web configurado:</strong> <a href="${hotel.website}" target="_blank" style="color: #1976d2;">${hotel.website}</a>
                        </p>
                        <p style="margin: 0; font-size: 0.9rem; color: #2e7d32;">
                            🔄 Cuando un cliente pregunte sobre este hotel, Flor utilizará la información del sitio web oficial para dar respuestas precisas y actualizadas.
                        </p>
                    </div>
                    ` : `
                    <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border: 1px solid #ffcc80;">
                        <p style="margin: 0; color: #e65100;">
                            ⚠️ <strong>Sin sitio web configurado.</strong> Ve a <strong>Hoteles → Editar</strong> y agrega la URL del sitio web del hotel para que Flor pueda buscar información automáticamente.
                        </p>
                    </div>
                    `}
                </div>
                
                <!-- Información Adicional (Opcional) -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span>📝</span> Información Adicional del Sitio Web
                        <span style="font-size: 0.8rem; color: #e65100; font-weight: normal;">(Opcional - Solo si quieres agregar info específica)</span>
                    </h4>
                    <p style="font-size: 0.85rem; color: #bf360c; margin-bottom: 12px;">
                        💡 Si hay información específica que Flor no puede encontrar en el sitio web, puedes agregarla aquí manualmente.
                    </p>
                    <div>
                        <textarea id="knowledge-website-info" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ffcc80; border-radius: 8px; background: white;" placeholder="Información adicional opcional:&#10;- Promociones especiales no publicadas&#10;- Políticas internas&#10;- Datos de contacto directos&#10;- Cualquier información que no esté en la web...">${extraKnowledge.websiteInfo || ''}</textarea>
                    </div>
                </div>
                
                <!-- Información Extra para Flor (Editable) -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                    <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span>✏️</span> Información Adicional para Flor
                        <span style="font-size: 0.8rem; color: #1565c0; font-weight: normal;">(Editable)</span>
                    </h4>
                    
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">📝 Descripción Detallada para Flor</label>
                            <textarea id="knowledge-description" rows="4" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Descripción ampliada que Flor usará para responder consultas. Ejemplo: características únicas, ambiente, qué hace especial a este hotel...">${extraKnowledge.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">🎯 Detalle de Servicios para Flor</label>
                            <textarea id="knowledge-services-detail" rows="4" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Información detallada de servicios. Ejemplo: horarios de spa, tipo de comida en restaurante, actividades disponibles...">${extraKnowledge.servicesDetail || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">💰 Información de Precios para Flor</label>
                            <textarea id="knowledge-pricing" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Información de tarifas. Ejemplo: temporada alta/baja, promociones, qué incluye el precio...">${extraKnowledge.pricing || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">🚗 Cómo Llegar / Transporte</label>
                            <textarea id="knowledge-transport" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Información de transporte. Ejemplo: distancia desde aeropuerto, transfers disponibles, acceso en auto...">${extraKnowledge.transport || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">📋 Notas Adicionales</label>
                            <textarea id="knowledge-notes" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Cualquier otra información relevante que Flor deba saber...">${extraKnowledge.notes || ''}</textarea>
                        </div>
                        
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveHotelKnowledge('${hotelId}')">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Información Adicional
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Guardar ID del hotel seleccionado
        window.currentHotelIdForKnowledge = hotelId;
    };

    // Guardar conocimiento del hotel
    window.saveHotelKnowledge = async function(hotelId) {
        // Obtener información sincronizada del hotel (desde Supabase o localStorage)
        let hotels = [];
        let hotel = null;
        
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                hotels = await window.supabaseClient.getHotels();
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
            } catch (error) {
                console.warn('⚠️ Error cargando hotel desde Supabase, usando localStorage:', error);
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
            }
        } else {
            hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
        }
        
        // Guardar conocimiento extra de Flor
        const knowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
        knowledge[hotelId] = {
            // Información extra editable
            description: document.getElementById('knowledge-description')?.value || '',
            servicesDetail: document.getElementById('knowledge-services-detail')?.value || '',
            pricing: document.getElementById('knowledge-pricing')?.value || '',
            transport: document.getElementById('knowledge-transport')?.value || '',
            notes: document.getElementById('knowledge-notes')?.value || '',
            // Información extraída del sitio web
            websiteInfo: document.getElementById('knowledge-website-info')?.value || '',
            // Referencia a información sincronizada (para acceso rápido)
            syncedInfo: hotel ? {
                name: hotel.name,
                location: hotel.location,
                rating: hotel.rating,
                priceRange: hotel.priceRange || hotel.price_range,
                amenities: hotel.amenities,
                mainImage: hotel.mainImage || (hotel.images && Array.isArray(hotel.images) ? hotel.images[0] : null),
                galleryImages: hotel.galleryImages || (hotel.images && Array.isArray(hotel.images) ? hotel.images.slice(1) : []),
                googleMaps: hotel.googleMaps || hotel.google_maps,
                website: hotel.website
            } : null,
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem('flor_hotel_knowledge', JSON.stringify(knowledge));
        
        // También actualizar la base de conocimiento de Flor (FlorKnowledgeBase) si está disponible
        if (typeof FlorKnowledgeBase !== 'undefined') {
            FlorKnowledgeBase.saveHotelKnowledge(hotelId, knowledge[hotelId]);
        }
        
        alert('✅ Información adicional para Flor guardada');
        console.log('💾 Conocimiento guardado para hotel:', hotelId, knowledge[hotelId]);
    };

    // Inicializar cuando se carga la sección
    const florOriginalShowSection = window.showSection;
    if (florOriginalShowSection) {
        window.showSection = function(section, event) {
            if (florOriginalShowSection) {
                florOriginalShowSection(section, event);
            }
            
            // IMPORTANTE: Ejecutar forceExpensesSectionDimensions si es expenses
            // Esto asegura que se ejecute incluso si otras versiones de showSection no lo hacen
            if (section === 'expenses' && typeof forceExpensesSectionDimensions === 'function') {
                requestAnimationFrame(() => {
                    forceExpensesSectionDimensions();
                });
            }
            
            if (section === 'flor-config') {
                loadFlorGeneral();
                loadFlorResponses();
                loadHotelsForFlor();
                // Cargar configuración de IA desde Supabase
                loadAIConfigFromSupabase();
            }
            if (section === 'interactions') {
                loadInteractions();
            }
            if (section === 'chats') {
                loadChats();
            }
        };
    }

    console.log('Modulo Flor IA / Interacciones / Chats cargado correctamente');
    </script>
    <!-- ==================== FIN SCRIPT FLOR IA ==================== -->
    
    <!-- Sistema Flor - Chatbot con aprendizaje (deshabilitado - integrado en WhatsApp server) -->
    <!-- <script src="flor-knowledge-base.js"></script> -->
    <!-- <script src="flor-ai-service.js"></script> -->
    <!-- <script src="flor-learning-system.js"></script> -->
    <!-- <script src="flor-agent.js"></script> -->
    
    <!-- Widget Chatbot Flor (deshabilitado) -->
    <!-- <script src="flor-widget.js"></script> -->
    
    <!-- Script de Migración (no necesario - ya migrado) -->
    <!-- <script src="migrate-to-supabase.js"></script> -->
    
    <!-- Verificar conexión con Supabase al cargar -->
    <script>
        // Verificar conexión cuando el dashboard esté listo
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const testResult = await window.supabaseClient.testConnection();
                        if (testResult.success) {
                            console.log('Conexion con Supabase verificada correctamente');
                            console.log('Los datos se guardaran en la nube automaticamente');
                        } else {
                            console.warn('No se pudo conectar con Supabase:', testResult.error);
                            console.warn('Se usara localStorage como respaldo');
                        }
                    } catch (error) {
                        console.warn('⚠️ Error verificando conexión con Supabase:', error);
                            console.warn('Se usara localStorage como respaldo');
                    }
                } else {
                    console.warn('Supabase no esta configurado. Los datos se guardaran solo en localStorage.');
                    console.warn('Para activar el guardado en la nube, configura tus credenciales en supabase-config.js');
                }
            }, 1000);
        });
    </script>
    </div>
    <!-- Fin del contenido del Dashboard -->
</body>
</html> 