<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkin24hs - Panel de Administraci√≥n</title>
    <script>
    console.log('üéØüéØüéØ SCRIPT INICIAL CARGADO - ' + new Date().toISOString());
    
    // Declarar showFlorTab INMEDIATAMENTE para que est√© disponible antes de que se cargue el HTML
    window.showFlorTab = function(tabName) {
        console.log('üìë Cambiando a tab Flor:', tabName);
        
        // Ocultar todos los tabs
        document.querySelectorAll('.flor-tab-content').forEach(tab => {
            tab.style.display = 'none';
            tab.classList.remove('active');
        });
        
        // Desactivar todos los botones de tab
        document.querySelectorAll('.flor-tab').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#f5f5f5';
            btn.style.color = '#333';
        });
        
        // Mostrar tab seleccionado
        const tabContent = document.getElementById('flor-tab-' + tabName);
        if (tabContent) {
            tabContent.style.display = 'block';
            tabContent.style.visibility = 'visible';
            tabContent.style.opacity = '1';
            tabContent.classList.add('active');
            console.log('‚úÖ Tab mostrado:', tabName, tabContent);
        } else {
            console.error('‚ùå Tab no encontrado:', 'flor-tab-' + tabName);
        }
        
        // Activar bot√≥n
        const tabBtn = document.querySelector(`.flor-tab[data-tab="${tabName}"]`);
        if (tabBtn) {
            tabBtn.classList.add('active');
            if (tabName === 'whatsapp') {
                tabBtn.style.background = '#25D366';
                tabBtn.style.color = 'white';
            } else {
                tabBtn.style.background = '#1976d2';
                tabBtn.style.color = 'white';
            }
        }
        
        // Cargar datos espec√≠ficos del tab (se ejecutar√° cuando el script completo est√© cargado)
        if (typeof loadHotelsForFlor === 'function' && (tabName === 'knowledge' || tabName === 'policies')) {
            loadHotelsForFlor();
        }
        if (tabName === 'whatsapp') {
            if (typeof checkWhatsAppConnection === 'function') {
                checkWhatsAppConnection();
            }
            // Cargar configuraci√≥n guardada
            const savedConfig = localStorage.getItem('whatsappConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    const serverUrlInput = document.getElementById('whatsapp-server-url');
                    const autoReplyCheck = document.getElementById('whatsapp-auto-reply');
                    const businessHoursCheck = document.getElementById('whatsapp-business-hours-only');
                    const outOfHoursMsg = document.getElementById('whatsapp-out-of-hours-message');
                    
                    if (serverUrlInput && config.serverUrl) serverUrlInput.value = config.serverUrl;
                    if (autoReplyCheck) autoReplyCheck.checked = config.autoReply !== false;
                    if (businessHoursCheck) businessHoursCheck.checked = config.businessHoursOnly || false;
                    if (outOfHoursMsg && config.outOfHoursMessage) outOfHoursMsg.value = config.outOfHoursMessage;
                } catch (e) {
                    console.error('Error cargando configuraci√≥n de WhatsApp:', e);
                }
            }
        }
    };
    // Tambi√©n hacer disponible sin window. para compatibilidad
    // Asignar directamente al scope global
    this.showFlorTab = window.showFlorTab;
    console.log('‚úÖ showFlorTab definida tempranamente');
    
    // ===== FUNCIONES DE MODALES - DEFINIDAS TEMPRANAMENTE =====
    // Estas funciones se redefinir√°n m√°s adelante, pero aqu√≠ est√°n como fallback
    
    // Funci√≥n gen√©rica para abrir modales
    window.openModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            modal.style.zIndex = '99999';
        } else {
            console.error('Modal no encontrado:', modalId);
        }
    };
    
    // Funci√≥n gen√©rica para cerrar modales
    window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    };
    
    // Wrapper para funciones de modales que pueden no estar definidas
    window.safeCall = function(functionName, ...args) {
        if (typeof window[functionName] === 'function') {
            return window[functionName](...args);
        } else {
            console.error('Funci√≥n no definida:', functionName);
            return false;
        }
    };
    
    console.log('‚úÖ Funciones de modales definidas tempranamente');
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        body.authenticated {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background-color: #1976d2;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
            position: relative;
            flex-wrap: nowrap;
            font-size: 0.85rem;
            gap: 10px;
        }

        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }

        .menu-item.active {
            background-color: rgba(255,255,255,0.2);
        }

        .menu-item .material-icons {
            font-size: 18px;
            min-width: 28px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
            box-shadow: 
                2px 2px 4px rgba(0,0,0,0.3),
                -1px -1px 2px rgba(255,255,255,0.1),
                inset 1px 1px 2px rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .menu-item .menu-text,
        .menu-item span:not(.material-icons):not(.menu-text) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
            flex: 1;
        }

        .menu-item:hover .material-icons {
            transform: scale(1.1) rotateY(10deg);
            box-shadow: 
                4px 4px 8px rgba(0,0,0,0.4),
                -2px -2px 4px rgba(255,255,255,0.15),
                inset 1px 1px 3px rgba(255,255,255,0.3);
            background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.1));
        }

        .menu-item.active .material-icons {
            background: linear-gradient(145deg, #4fc3f7, #0288d1);
            box-shadow: 
                4px 4px 10px rgba(0,0,0,0.4),
                -2px -2px 6px rgba(255,255,255,0.1),
                inset 2px 2px 4px rgba(255,255,255,0.3),
                0 0 15px rgba(79, 195, 247, 0.5);
            transform: scale(1.05);
        }

        /* Flor Tabs */
        .flor-tab {
            padding: 10px 20px;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .flor-tab:hover {
            background: #e0e0e0;
        }
        .flor-tab.active {
            background: #1976d2;
            color: white;
        }
        .flor-tab-content {
            display: none;
        }
        .flor-tab-content.active {
            display: block;
        }

        /* Main Content */
        .main-content {
            margin-left: 220px;
            flex: 1;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            background-color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            color: #333;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .user-button:hover {
            background-color: #f5f5f5;
        }

        .user-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item .material-icons {
            margin-right: 8px;
            font-size: 18px;
        }

        /* Content Area */
        .content {
            padding: 24px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 24px;
            color: #333;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: white;
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .trend-up {
            color: #2e7d32;
        }

        .trend-down {
            color: #d32f2f;
        }

        /* Activity and Chart Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .activity-card, .chart-card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #333;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #1976d2;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }

        .chart-placeholder {
            min-height: 200px;
            background-color: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        #monthlySalesContent:has(table) {
            background-color: transparent;
            padding: 0;
            min-height: auto;
        }

        /* Form Buttons */
        .form-button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
        }

        .form-button:hover {
            background-color: #1565c0;
        }

        .form-button.secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .form-button.secondary:hover {
            background-color: #e0e0e0;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #f5f5f5;
            font-weight: 500;
            color: #333;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .hotel-name {
            font-weight: 500;
            color: #1976d2;
        }

        .hotel-location {
            color: #666;
            font-size: 0.9rem;
        }

        .rating-stars {
            color: #ffc107;
        }

        .status-active {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .action-btn.edit {
            color: #1976d2;
        }

        .action-btn.delete {
            color: #d32f2f;
        }

        .action-btn.view {
            color: #2e7d32;
        }
        
        /* Estilos para tabla de usuarios */
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-weight: 500;
            color: #333;
        }
        
        .user-email {
            font-size: 0.85rem;
            color: #666;
        }
        
        .user-type {
            font-size: 0.75rem;
            color: #999;
            font-style: italic;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-badge.inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .btn-edit, .btn-delete {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #1976d2;
        }
        
        .btn-delete {
            background-color: #f44336;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        /* Estilos para la secci√≥n de cotizaciones */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Secciones del dashboard */
        [id$="-section"] {
            position: relative;
            z-index: 1;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            z-index: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
            z-index: 1;
        }
        
        .search-box input {
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 250px;
            position: relative;
            z-index: 1;
        }
        
        .search-box .material-icons {
            position: absolute;
            right: 12px;
            color: #666;
            font-size: 18px;
            z-index: 2;
            pointer-events: none;
        }
        
        .quote-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .quote-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .quote-status.enviado {
            background: #cfe2ff;
            color: #084298;
        }
        
        .quote-status.processed {
            background: #d4edda;
            color: #155724;
        }
        
        .quote-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btn.primary {
            background: #2196f3;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #1976d2;
        }
        
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-btn.secondary:hover {
            background: #5a6268;
        }
        
        .action-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .action-btn.danger:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        /* MOSTRAR CAMPOS DE IMAGEN - AHORA VISIBLES */
        #editHotelModal .form-group {
            position: relative;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-title {
            margin-bottom: 16px;
            color: #333;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        /* CAMPOS DE IMAGEN AHORA VISIBLES - CSS eliminado */

        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .form-input[type="number"] {
            width: 100%;
        }

        .form-input[type="url"] {
            width: 100%;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-top: 8px;
        }

        .photos-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .photo-preview {
            width: 80px;
            height: 60px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            object-fit: cover;
        }

        /* Image Manager Styles */
        .image-item {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            width: 120px;
            height: 140px;
            display: inline-block;
            margin: 5px;
        }

        .image-item:hover {
            border-color: #1976d2;
            transform: scale(1.05);
        }

        .image-item.selected {
            border-color: #2e7d32;
            background-color: #e8f5e8;
        }

        .image-preview {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            position: relative;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .photo-placeholder {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            position: relative;
        }

        .photo-placeholder.selected {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .photo-placeholder .material-icons {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .photo-number {
            font-weight: bold;
            font-size: 0.6rem;
        }

        .image-item .image-name {
            padding: 5px;
            font-size: 0.7rem;
            color: #333;
            background-color: white;
            text-align: center;
            word-break: break-word;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .select-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #2e7d32;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-item.selected .select-overlay {
            opacity: 1;
        }

        .image-actions {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 2px;
        }

        .btn-view, .btn-delete {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: #2196f3;
            color: white;
        }

        .btn-view:hover {
            background: #1976d2;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .photo-counter {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #388e3c;
        }

        .upload-progress {
            background-color: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            margin-top: 10px;
            overflow: hidden;
        }

        .upload-progress-bar {
            background-color: #1976d2;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 4px;
            }
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        /* Estilos para el carrusel de fotos */
        #photoCarouselModal .modal-content {
            background: transparent;
            box-shadow: none;
        }

        #carouselImage {
            transition: all 0.3s ease;
        }

        #carouselImage:hover {
            transform: scale(1.02);
        }

        #prevButton:hover, #nextButton:hover {
            background: rgba(0,0,0,0.9) !important;
            transform: translateY(-50%) scale(1.1);
        }

        #carouselThumbnails::-webkit-scrollbar {
            height: 6px;
        }

        #carouselThumbnails::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }

        #carouselThumbnails::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.7);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            #prevButton, #nextButton {
                width: 40px !important;
                height: 40px !important;
                font-size: 18px !important;
            }
            
            #carouselThumbnails {
                bottom: 60px !important;
                max-width: 90% !important;
            }
            
            #photoCounter {
                bottom: 15px !important;
                font-size: 12px !important;
            }
            
            /* ===== MODALES RESPONSIVOS ===== */
            .modal {
                padding: 10px !important;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: 100% !important;
                margin: 10px auto !important;
                padding: 15px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                border-radius: 12px !important;
            }
            
            .modal-content h2,
            .modal-content .modal-title {
                font-size: 1.2rem !important;
                margin-bottom: 15px !important;
            }
            
            .modal-content form {
                padding: 0 !important;
            }
            
            .modal-content .form-group {
                margin-bottom: 12px !important;
            }
            
            .modal-content input,
            .modal-content select,
            .modal-content textarea {
                width: 100% !important;
                padding: 12px !important;
                font-size: 16px !important; /* Evita zoom en iOS */
                box-sizing: border-box !important;
            }
            
            .modal-content label {
                font-size: 0.9rem !important;
                margin-bottom: 5px !important;
                display: block !important;
            }
            
            .modal-content button[type="submit"],
            .modal-content .btn-primary,
            .modal-content .form-button {
                width: 100% !important;
                padding: 14px !important;
                font-size: 1rem !important;
                margin-top: 10px !important;
            }
            
            .modal-content .form-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .modal-content .form-section {
                margin-bottom: 15px !important;
                padding: 10px !important;
            }
            
            .modal-content .close,
            .modal-content .close-btn {
                font-size: 28px !important;
                padding: 5px 10px !important;
            }
            
            /* Botones de acci√≥n en modales */
            .modal-content .modal-actions,
            .modal-content .form-actions {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .modal-content .modal-actions button,
            .modal-content .form-actions button {
                width: 100% !important;
            }
        }
        
        /* Extra peque√±o (tel√©fonos muy peque√±os) */
        @media (max-width: 480px) {
            .modal-content {
                width: 98% !important;
                padding: 12px !important;
                margin: 5px auto !important;
            }
            
            .modal-content h2,
            .modal-content .modal-title {
                font-size: 1.1rem !important;
            }
            
            .modal-content input,
            .modal-content select,
            .modal-content textarea {
                padding: 10px !important;
            }
        }
        
        /* Estilos para botones de acci√≥n */
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            margin: 0 2px;
            transition: background-color 0.3s;
        }
        
        .action-btn.edit {
            color: #1976d2;
        }
        
        .action-btn.edit:hover {
            background-color: rgba(25, 118, 210, 0.1);
        }
        
        .action-btn.delete {
            color: #d32f2f;
        }
        
        .action-btn.delete:hover {
            background-color: rgba(211, 47, 47, 0.1);
        }
        
        .action-btn.view {
            color: #388e3c;
        }
        
        .action-btn.view:hover {
            background-color: rgba(56, 142, 60, 0.1);
        }
        
        /* Estilos para estados de hoteles */
        .status-activo {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-inactivo {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-en-mantenimiento {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Estilos para estados de reservas */
        .status-confirmada {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pendiente {
            background-color: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-cancelada {
            background-color: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-modificada {
            background-color: #03a9f4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Estilos para el modal de edici√≥n de reservas */
        .form-grid {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 12px;
        }

        .form-section h3 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Estilos para la tabla de hoteles */
        .hotel-name {
            font-weight: 500;
            color: #333;
        }
        
        .hotel-location {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Estilos para estrellas de calificaci√≥n */
        .rating-stars {
            color: #ffc107;
            font-size: 16px;
        }

        /* Estilos para pantalla de login */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.85) 0%, rgba(118, 75, 162, 0.85) 100%),
                        url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=2073&q=80') center center / cover no-repeat;
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .login-container.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-input-group {
            position: relative;
        }

        .form-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-input-group input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-input-group .input-icon {
            position: absolute;
            right: 16px;
            top: 42px;
            color: #666;
            cursor: pointer;
        }

        .login-error {
            background-color: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            border: 1px solid #fcc;
        }

        .login-error.show {
            display: block;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .btn-login:hover {
            background-color: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .btn-login:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-logo img {
            max-width: 120px;
            height: auto;
        }

        .dashboard-content {
            display: none;
        }

        .dashboard-content.authenticated {
            display: flex;
            width: 100%;
        }

        body.authenticated .dashboard-content {
            display: flex;
        }
        
        /* Animaci√≥n de spin para carga */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    <!-- Supabase Client -->
    <script src="supabase-client.js?v=3.1.0"></script>
    <!-- Migration Script (opcional - descomentar si quieres migrar autom√°ticamente) -->
    <!-- <script src="migrate-to-supabase.js"></script> -->
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-logo">
                <img src="logo.png" alt="Checkin24hs" style="height: 40px; width: auto;" onerror="this.style.display='none'">
            </div>
            <div class="login-header">
                <h1>Panel de Administraci√≥n</h1>
                <p>Ingresa tus credenciales para continuar</p>
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-input-group">
                    <label for="loginUsername">Usuario</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        name="username" 
                        placeholder="Ingresa tu usuario" 
                        required 
                        autocomplete="username"
                    >
                </div>
                
                <div class="form-input-group">
                    <label for="loginPassword">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        name="password" 
                        placeholder="Ingresa tu contrase√±a" 
                        required 
                        autocomplete="current-password"
                    >
                    <span class="material-icons input-icon" onclick="togglePasswordVisibility()" style="pointer-events: all;">visibility</span>
                </div>
                
                <button type="submit" class="btn-login" id="loginButton">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido del Dashboard (oculto hasta autenticaci√≥n) -->
    <div class="dashboard-content" id="dashboardContent">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Checkin24hs Admin</h2>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="window.showSection('dashboard', event)">
                <span class="material-icons">dashboard</span>
                Dashboard
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('hotels', event)">
                <span class="material-icons">hotel</span>
                Hoteles
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('reservations', event)">
                <span class="material-icons">event</span>
                Reservas
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('flexi', event)">
                <span class="material-icons">card_giftcard</span>
                Programa Flexi
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('users', event)">
                <span class="material-icons">people</span>
                Usuarios
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('quotes', event)">
                <span class="material-icons">receipt</span>
                Cotizaciones
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('expenses', event)">
                <span class="material-icons">account_balance_wallet</span>
                Gastos
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('agents', event)">
                <span class="material-icons">support_agent</span>
                Agentes
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('interactions', event)">
                <span class="material-icons">chat</span>
                Interacciones
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('chats', event)">
                <span class="material-icons">forum</span>
                Chats
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('flor-config', event)">
                <span class="material-icons">smart_toy</span>
                Flor IA
            </a>
            <a href="#" class="menu-item" onclick="window.showSection('administrators', event)" id="adminMenuLink" style="display: none;">
                <span class="material-icons">admin_panel_settings</span>
                <span class="menu-text">Administradores</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <span class="material-icons">menu</span>
            </button>
            <img src="logo.png" alt="Checkin24hs" style="height: 40px; margin-right: 12px;" onerror="this.style.display='none'">
            <h1>Panel de Administraci√≥n</h1>
            <div class="user-menu">
                <button class="user-button" onclick="toggleUserMenu()">
                    <span class="material-icons">account_circle</span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item">
                        <span class="material-icons">person</span>
                        Administrador
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <span class="material-icons">logout</span>
                        Cerrar Sesi√≥n
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <h2 class="page-title">Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardTotalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsTotal">$0</h3>
                                <p>Sumatoria Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">event</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span style="font-size: 2rem; font-weight: bold; color: white;">$</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="dashboardMonthlySales">$0</h3>
                                <p>Ingresos del Mes Vigente</p>
                            </div>
                        </div>
                        <div class="stat-trend" id="dashboardMonthlyReservations">
                            <span class="material-icons">info</span>
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                </div>

                <!-- Activity and Chart Grid -->
                <div class="dashboard-grid">
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Ventas Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlySalesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="monthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="monthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Hotel:</label>
                                <select id="hotelFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="all">Todos los hoteles</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#1565c0'" onmouseout="this.style.backgroundColor='#1976d2'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlySalesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlySalesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>

                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Gastos Mensuales</h3>
                        </div>
                        
                        <!-- Filtros -->
                        <div id="monthlyExpensesFilters" style="margin-bottom: 20px; padding: 16px; background-color: #f8f9fa; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Desde:</label>
                                    <input type="month" id="expenseMonthFilterFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Mes Hasta:</label>
                                    <input type="month" id="expenseMonthFilterTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Categor√≠a:</label>
                                    <select id="expenseCategoryFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todas las categor√≠as</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 0.9rem;">Tipo de Gasto:</label>
                                    <select id="expenseTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="all">Todos los tipos</option>
                                        <option value="fixed">Fijo</option>
                                        <option value="variable">Variable</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="applyMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#c62828'" onmouseout="this.style.backgroundColor='#d32f2f'">
                                    Aplicar Filtros
                                </button>
                                <button onclick="clearMonthlyExpensesFilters()" style="flex: 1; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        
                        <div id="monthlyExpensesContent" class="chart-placeholder">
                            Sin datos disponibles
                        </div>
                    </div>
                </div>

                <!-- Test Buttons for Debugging -->
                <div style="margin-top: 24px; margin-bottom: 24px; padding: 16px; background: #f0f8ff; border-radius: 8px; border: 1px solid #1976d2;">
                    <h4 style="margin-bottom: 12px; color: #1976d2;">üîß Botones de Prueba</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="crearUsuariosPrueba()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add_circle</span>
                            Crear Usuarios Prueba
                        </button>
                                                    <button class="form-button" style="background: #2196f3; color: white;" onclick="window.showSection('users', event)">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">people</span>
                            Ir a Usuarios
                        </button>
                        <button class="form-button" style="background: #4caf50; color: white;" onclick="loadUsersData()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                            Cargar Datos
                        </button>
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="updateUsersFromReservations()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                            Actualizar Usuarios desde Reservas
                        </button>
                        <button class="form-button" style="background: #f44336; color: white;" onclick="deleteAllUsers()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete_forever</span>
                            Eliminar Todos los Usuarios
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hotels Section - NUEVO M√ìDULO LIMPIO -->
            <div id="hotels-section" style="display: none;">
                <h2 class="page-title">üè® Gesti√≥n de Hoteles</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewHotel()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Agregar Hotel
                    </button>
                    <button class="form-button secondary" onclick="exportHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Datos
                    </button>
                    <button class="form-button secondary" onclick="refreshHotels()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" style="background: #ff9800; color: white;" onclick="if(typeof showHotelPromotions === 'function') { showHotelPromotions(); } else { console.error('showHotelPromotions no est√° definida'); }">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">local_offer</span>
                        Promociones
                    </button>
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="if(typeof showMarketingTools === 'function') { showMarketingTools(); } else { console.error('showMarketingTools no est√° definida'); }">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">campaign</span>
                        Marketing
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">hotel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalHotels">0</h3>
                                <p>Total Hoteles</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="todayReservationsTotal">$0</h3>
                                <p>Ingresos de Hoy</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">today</span>
                            Reservas ingresadas hoy
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">location_on</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalLocations">0</h3>
                                <p>Ubicaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="priceRange">$0-$0</h3>
                                <p>Rango de Precios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hotels Table -->
                <div class="activity-card">
                    <h3 class="card-title">Hoteles Vigentes</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Ubicaci√≥n</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Calificaci√≥n</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Precio</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="hotelsTableBody">
                                <!-- Los hoteles se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reservations Section -->
            <div id="reservations-section" style="display: none;">
                <h2 class="page-title">Gesti√≥n de Reservas</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="addNewReservation()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                        Nueva Reserva
                    </button>
                    <button class="form-button" onclick="addNewAgent()" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Agente
                    </button>
                    <button class="form-button secondary" onclick="exportReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Reservas
                    </button>
                    <button class="form-button secondary" onclick="importReservations()" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Reservas
                    </button>
                    <button class="form-button secondary" onclick="refreshReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <!-- Bot√≥n de eliminar reservas removido por seguridad -->
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalReservations">0</h3>
                                <p>Total Reservas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="confirmedReservations">0</h3>
                                <p>Confirmadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #03a9f4;">
                                <span class="material-icons">edit</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="modifiedReservations">0</h3>
                                <p>Modificadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">cancel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="canceledReservations">0</h3>
                                <p>Canceladas</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="if(typeof showTotalRevenueModal === 'function') { showTotalRevenueModal(); } else { console.error('showTotalRevenueModal no est√° definida'); }">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">event</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="futureReservationsCount">0</h3>
                                <p>Reservas Futuras</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            Reservas desde hoy hacia adelante
                        </div>
                    </div>
                </div>

                <!-- Filtros Avanzados de Reservas -->
                <div class="activity-card" style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #e3f2fd, #f5f5f5);">
                    <h4 style="margin: 0 0 12px 0; color: #1976d2;">üîç Filtros de B√∫squeda</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">C√≥digo de Reserva</label>
                            <input type="text" id="filterReservationCode" placeholder="Ej: 589704504" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onkeyup="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Nombre Cliente</label>
                            <input type="text" id="filterClientName" placeholder="Nombre o apellido" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onkeyup="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Fecha Entrada (desde)</label>
                            <input type="date" id="filterCheckInFrom" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Fecha Entrada (hasta)</label>
                            <input type="date" id="filterCheckInTo" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Estado</label>
                            <select id="filterStatus" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                                <option value="">Todos</option>
                                <option value="CONFIRMADA">Confirmada</option>
                                <option value="Modificada">Modificada</option>
                                <option value="CANCELADA">Cancelada</option>
                                <option value="PENDIENTE">Pendiente</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Hotel</label>
                            <select id="filterHotel" 
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                onchange="applyReservationFilters()">
                                <option value="">Todos los hoteles</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button type="button" onclick="clearReservationFilters()" 
                            style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üóëÔ∏è Limpiar Filtros
                        </button>
                        <button type="button" onclick="filterTodayReservations()" 
                            style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üìÖ Ver Check-in de Hoy
                        </button>
                        <button type="button" onclick="filterFutureReservations()" 
                            style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                            üîÆ Ver Reservas Futuras
                        </button>
                        <span id="filterResultsCount" style="padding: 8px; color: #666; font-size: 13px;"></span>
                    </div>
                </div>

                <!-- Reservations Table -->
                <div class="activity-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">Reservas Activas</h3>
                        <div style="position: relative; width: 300px;">
                            <input 
                                type="text" 
                                id="reservationSearchInput" 
                                placeholder="B√∫squeda r√°pida..." 
                                style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                onkeyup="filterReservationsByCode(this.value)"
                                oninput="filterReservationsByCode(this.value)"
                            >
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">üîç</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">C√≥digo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Fechas</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Total</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reservationsTableBody">
                                <!-- Las reservas se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                                </div>
        </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div id="editReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="editReservationTitle">Modificar Reserva</h2>
            </div>
            <form id="editReservationForm" onsubmit="saveReservationChanges(event)">
                <div class="form-grid">
                    <!-- Informaci√≥n del Cliente -->
                    <div class="form-section">
                        <h3>üë§ Informaci√≥n del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientName">Nombre Completo</label>
                                <input type="text" id="editClientName" name="clientName" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editClientEmail">Email</label>
                                <input type="email" id="editClientEmail" name="clientEmail" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editClientPhone">Tel√©fono</label>
                                <input type="tel" id="editClientPhone" name="clientPhone" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de la Reserva -->
                    <div class="form-section">
                        <h3>üè® Informaci√≥n de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editHotelSelect">Hotel</label>
                                <select id="editHotelSelect" name="hotelId" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editReservationCode">C√≥digo de Reserva</label>
                                <input type="text" id="editReservationCode" name="reservationCode" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="editCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="editCheckOut">Fecha de Salida *</label>
                                <input type="date" id="editCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editReservationDate">Fecha de Registro</label>
                                <input type="date" id="editReservationDate" name="reservationDate" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="editAgentSelect">Agente Responsable</label>
                                <select id="editAgentSelect" name="agentName" disabled style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de Pago -->
                    <div class="form-section">
                        <h3>üí∞ Informaci√≥n de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTotalAmount">Tarifa (USD) *</label>
                                <input type="number" id="editTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="if(typeof closeEditReservationModal === 'function') { closeEditReservationModal(); } else { document.getElementById('editReservationModal').style.display = 'none'; }" class="btn btn-secondary">Salir</button>
                    <button type="button" onclick="cancelReservation()" class="btn btn-secondary" style="background: #dc3545; color: white;">Cancelar Reserva</button>
                    <button type="submit" class="btn btn-primary">Modificar Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Reservation Modal -->
    <div id="newReservationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üÜï Nueva Reserva</h2>
            </div>
            <form id="newReservationForm" onsubmit="saveNewReservation(event)">
                <div class="form-grid">
                    <!-- Informaci√≥n del Cliente -->
                    <div class="form-section">
                        <h3>üë§ Informaci√≥n del Cliente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientName">Nombre Completo *</label>
                                <input type="text" id="newClientName" name="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="newClientEmail">Email *</label>
                                <input type="email" id="newClientEmail" name="clientEmail" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newClientPhone">Tel√©fono *</label>
                                <input type="tel" id="newClientPhone" name="clientPhone" required>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de la Reserva -->
                    <div class="form-section">
                        <h3>üè® Informaci√≥n de la Reserva</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newHotelSelect">Hotel *</label>
                                <select id="newHotelSelect" name="hotelId" required>
                                    <option value="">Seleccionar hotel...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newReservationCode">C√≥digo de Reserva *</label>
                                <input type="text" id="newReservationCode" name="reservationCode" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newCheckIn">Fecha de Entrada *</label>
                                <input type="date" id="newCheckIn" name="checkIn" required>
                            </div>
                            <div class="form-group">
                                <label for="newCheckOut">Fecha de Salida *</label>
                                <input type="date" id="newCheckOut" name="checkOut" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newReservationDate">Fecha de Registro *</label>
                                <input type="date" id="newReservationDate" name="reservationDate" required>
                            </div>
                            <div class="form-group">
                                <label for="newAgentSelect">Agente Responsable *</label>
                                <select id="newAgentSelect" name="agentName" required>
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- Informaci√≥n de Pago -->
                    <div class="form-section">
                        <h3>üí∞ Informaci√≥n de Pago</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newStatus">Estado de la Reserva *</label>
                                <select id="newStatus" name="status" required>
                                    <option value="Confirmada" selected>Confirmada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTotalAmount">Total (USD) *</label>
                                <input type="number" id="newTotalAmount" name="totalAmount" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="if(typeof closeNewReservationModal === 'function') { closeNewReservationModal(); } else { document.getElementById('newReservationModal').style.display = 'none'; }" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Agent Modal -->
    <div id="newAgentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 505px; width: 85%;">
            <div class="modal-header">
                <h2>üë§ Nuevo Agente</h2>
                <button onclick="if(typeof closeNewAgentModal === 'function') { closeNewAgentModal(); } else { document.getElementById('newAgentModal').style.display = 'none'; }" class="close-btn">&times;</button>
            </div>
            <form id="newAgentForm" onsubmit="saveNewAgent(event)">
                <div class="form-grid">
                    <div class="form-section">
                        <h3>üìã Informaci√≥n del Agente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentCode">C√≥digo de Agente *</label>
                                <input type="text" id="newAgentCode" name="agentCode" readonly required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentName">Nombre *</label>
                                <input type="text" id="newAgentName" name="agentName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newAgentAgency">Agencia *</label>
                                <input type="text" id="newAgentAgency" name="agentAgency" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="if(typeof closeNewAgentModal === 'function') { closeNewAgentModal(); } else { document.getElementById('newAgentModal').style.display = 'none'; }" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Agente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div id="editAgentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 505px; width: 85%;">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Agente</h2>
                <button onclick="closeEditAgentModal()" class="close-btn">&times;</button>
            </div>
            <form id="editAgentForm" onsubmit="saveEditedAgent(event)">
                <input type="hidden" id="editAgentId" name="agentId">
                <div class="form-grid">
                    <div class="form-section">
                        <h3>üìã Informaci√≥n del Agente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentCode">C√≥digo de Agente</label>
                                <input type="text" id="editAgentCode" name="agentCode" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentName">Nombre *</label>
                                <input type="text" id="editAgentName" name="agentName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentAgency">Agencia *</label>
                                <input type="text" id="editAgentAgency" name="agentAgency" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAgentStatus">Estado *</label>
                                <select id="editAgentStatus" name="agentStatus" required>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeEditAgentModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Reservations Modal -->
    <div id="importReservationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header">
                <h2>üì• Importar Reservas desde Excel</h2>
                <button onclick="closeImportReservationsModal()" class="close-btn">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">
                    Selecciona un archivo Excel (.xlsx) con las reservas a importar. 
                    El archivo debe tener las columnas: <strong>C√≥digo, Cliente, Hotel, Fecha Entrada, Fecha Salida, Total</strong> (requeridos) y opcionalmente: Email, Tel√©fono, Fecha Registro, Agente, Estado.
                </p>
                <div style="margin-bottom: 20px;">
                    <label for="importFileInput" style="display: block; margin-bottom: 8px; font-weight: 500;">
                        Seleccionar archivo Excel:
                    </label>
                    <input type="file" id="importFileInput" accept=".xlsx,.xls" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>‚ö†Ô∏è Nota:</strong> Las reservas con c√≥digos duplicados ser√°n actualizadas. Las nuevas se agregar√°n.
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="closeImportReservationsModal()" class="form-button secondary">Cancelar</button>
                    <button type="button" onclick="processImportFile()" class="form-button" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flexi Program Section -->
            <div id="flexi-section" style="display: none;">
                <h2 class="page-title">üé´ Programa Flexi - Gesti√≥n de Vouchers</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" onclick="if(typeof openNewFlexiProgramModal === 'function') { openNewFlexiProgramModal(); } else { console.error('openNewFlexiProgramModal no est√° definida'); }" style="background: #9c27b0; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add_circle</span>
                        Nuevo Programa
                    </button>
                    <button class="form-button" onclick="if(typeof openEmitVoucherModal === 'function') { openEmitVoucherModal(); } else { console.error('openEmitVoucherModal no est√° definida'); }" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        Emitir Voucher
                    </button>
                    <button class="form-button" onclick="if(typeof openRegisterCanjeModal === 'function') { openRegisterCanjeModal(); } else { console.error('openRegisterCanjeModal no est√° definida'); }" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">swap_horiz</span>
                        Registrar Canje
                    </button>
                    <button class="form-button secondary" onclick="exportFlexiVouchers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar
                    </button>
                    <button class="form-button secondary" onclick="refreshFlexiData()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">card_giftcard</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalFlexiVouchers">0</h3>
                                <p>Vouchers Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeFlexiVouchers">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ff9800;">
                                <span class="material-icons">hourglass_empty</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="partialFlexiVouchers">0</h3>
                                <p>Parcialmente Usados</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2196f3;">
                                <span class="material-icons">done_all</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="usedFlexiVouchers">0</h3>
                                <p>Completamente Usados</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">event_busy</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="expiredFlexiVouchers">0</h3>
                                <p>Vencidos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #607d8b;">
                                <span class="material-icons">confirmation_number</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalCuposDisponibles">0</h3>
                                <p>Cupos Disponibles</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Card: C√≥mo funciona el Programa Flexi -->
                <div class="activity-card" style="margin-bottom: 24px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #9c27b0;">
                    <h3 class="card-title" style="color: #7b1fa2; margin-bottom: 12px;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">info</span>
                        ¬øC√≥mo funciona el Programa Flexi?
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">üóìÔ∏è Paso 1: Elegir Fechas</h4>
                            <p style="color: #666; font-size: 14px;">El cliente selecciona fechas de Check-in y Check-out dentro del Periodo de Uso del voucher.</p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">üìû Paso 2: Solicitar Canje</h4>
                            <p style="color: #666; font-size: 14px;">El cliente contacta al equipo con: C√≥digo de Voucher, Hotel, Fechas y N√∫mero de Personas.</p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #9c27b0; margin-bottom: 8px;">‚úÖ Paso 3: Confirmaci√≥n</h4>
                            <p style="color: #666; font-size: 14px;">El equipo verifica disponibilidad, registra el canje y env√≠a confirmaci√≥n al cliente.</p>
                        </div>
                    </div>
                </div>

                <!-- Programs Table -->
                <div class="activity-card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">üìã Programas Flexi Disponibles</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f3e5f5; border-bottom: 2px solid #ce93d8;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos/Voucher</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Precio USD</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Periodo de Uso</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiProgramsTableBody">
                                <!-- Los programas se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vouchers Table -->
                <div class="activity-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">üé´ Vouchers Emitidos</h3>
                        <div style="position: relative; width: 300px;">
                            <input 
                                type="text" 
                                id="flexiVoucherSearchInput" 
                                placeholder="Buscar por c√≥digo, cliente, hotel..." 
                                style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                onkeyup="filterFlexiVouchers(this.value)"
                            >
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">üîç</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">C√≥digo Voucher</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Hotel</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Periodo de Uso</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiVouchersTableBody">
                                <!-- Los vouchers se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Canjes History Table -->
                <div class="activity-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="card-title" style="margin: 0;">üìú Historial de Canjes</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #fff3e0; border-bottom: 2px solid #ffcc80;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Voucher</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Cliente</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Fechas Estad√≠a</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Personas</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cupos Usados</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="flexiCanjesTableBody">
                                <!-- Los canjes se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

    <!-- Users Section -->
            <div id="users-section" style="display: none;">
                <h2 class="page-title">Gesti√≥n de Usuarios</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="if(typeof showImportUsersModal === 'function') { showImportUsersModal(); } else { console.error('showImportUsersModal no est√° definida'); }">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">upload</span>
                        Importar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="exportUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">download</span>
                        Exportar Usuarios
                    </button>
                    <button class="form-button secondary" onclick="refreshUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                    <button class="form-button" style="background: #9c27b0; color: white;" onclick="restoreUsersFromSupabase()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_download</span>
                        Restaurar de Supabase
                    </button>
                    <button class="form-button" style="background: #ff9800; color: white;" onclick="updateUsersFromReservations()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                        Desde Reservas
                    </button>
                    <button class="form-button" style="background: #e91e63; color: white;" onclick="removeDuplicateUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">filter_alt</span>
                        Quitar Duplicados
                    </button>
                    <button class="form-button" style="background: #673ab7; color: white;" onclick="mergeDuplicateUsers()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">merge</span>
                        Fusionar Duplicados
                    </button>
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showMarketingTools()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">campaign</span>
                        Herramientas Marketing
                    </button>
                    <button class="form-button" style="background: #2196f3; color: white;" onclick="showUserAnalytics()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">analytics</span>
                        An√°lisis Usuarios
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">people</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">person_add</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="newUsers">0</h3>
                                <p>Nuevos este mes</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                            <span class="material-icons">receipt</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalQuotes">0</h3>
                                <p>Total Cotizaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">star</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="avgUserRating">0.0</h3>
                                <p>Calificaci√≥n Promedio</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="activity-card">
                    <h3 class="card-title">Usuarios Registrados - Panel de Administraci√≥n</h3>
                    
                    <!-- Buscador de usuarios -->
                    <div style="margin-bottom: 16px; margin-top: 16px; position: relative; z-index: 1;">
                        <div style="position: relative; z-index: 1; max-width: 100%;">
                            <input type="text" id="usersSearchInput" placeholder="Buscar usuarios por nombre, email o tel√©fono..." 
                                   style="width: 100%; max-width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; position: relative; z-index: 1; box-sizing: border-box;"
                                   onkeyup="searchUsers()" oninput="searchUsers()">
                            <span class="material-icons" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; z-index: 2;">search</span>
                        </div>
                        <div id="usersSearchInfo" style="margin-top: 8px; font-size: 0.85rem; color: #666; display: none;">
                            <span id="usersSearchCount">0</span> resultados encontrados
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Tel√©fono</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Cotizaciones</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">√öltima Actividad</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Marketing</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Los usuarios se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Agents Section -->
            <div id="agents-section" style="display: none;">
                <h2 class="page-title">üë• Gesti√≥n de Agentes</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="addNewAgent()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Agente
                    </button>
                    <button class="form-button secondary" onclick="refreshAgents()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #4caf50;">
                                <span class="material-icons">support_agent</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAgents">0</h3>
                                <p>Total Agentes</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2196f3;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeAgents">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f44336;">
                                <span class="material-icons">cancel</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="inactiveAgents">0</h3>
                                <p>Inactivos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agents Table -->
                <div class="activity-card">
                    <h3 class="card-title">Lista de Agentes</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">C√≥digo</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Agencia</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Reservas</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Fecha Creaci√≥n</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody">
                                <!-- Los agentes se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Interactions Section -->
            <div id="interactions-section" style="display: none;">
                <h2 class="page-title">Interacciones con Flor</h2>
                
                <div class="stat-card" style="margin-bottom: 24px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">Historial de Conversaciones</h3>
                        <button class="form-button secondary" onclick="if(window.loadInteractions) window.loadInteractions(); else if(typeof loadInteractions === 'function') loadInteractions();">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                            Actualizar
                        </button>
                    </div>
                    <div style="padding: 16px; background: #e3f2fd; border-left: 4px solid #1976d2; margin: 16px; border-radius: 4px;">
                        <strong>‚ÑπÔ∏è C√≥mo funciona el aprendizaje de Flor:</strong>
                        <ul style="margin: 8px 0 0 20px; color: #666;">
                            <li>Flor guarda autom√°ticamente cada interacci√≥n con los usuarios</li>
                            <li>Analiza patrones en las conversaciones para mejorar sus respuestas</li>
                            <li>Identifica palabras clave comunes y respuestas exitosas</li>
                            <li>Actualiza su base de conocimiento autom√°ticamente</li>
                        </ul>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 12px; text-align: left;">Fecha</th>
                                    <th style="padding: 12px; text-align: left;">Cliente</th>
                                    <th style="padding: 12px; text-align: center;">Mensajes</th>
                                    <th style="padding: 12px; text-align: left;">Resuelto por</th>
                                    <th style="padding: 12px; text-align: center;">Estado</th>
                                    <th style="padding: 12px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="interactionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                        <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">chat</span>
                                        No hay interacciones registradas a√∫n
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Chats Section -->
            <div id="chats-section" style="display: none;">
                <h2 class="page-title">Chats Activos</h2>
                
                <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: calc(100vh - 200px);">
                    <!-- Lista de Chats -->
                    <div class="stat-card" style="overflow-y: auto;">
                        <div style="padding: 16px; border-bottom: 1px solid #e0e0e0;">
                            <h3 style="margin: 0 0 12px 0; font-size: 1.1rem;">Conversaciones</h3>
                            <button class="form-button secondary" onclick="if(window.cargarChatsAhora){window.cargarChatsAhora();}else{alert('Funci√≥n no disponible. Recarga la p√°gina.');}" style="width: 100%;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                                Actualizar
                            </button>
                        </div>
                        <div id="chatsList" style="padding: 8px;">
                            <div style="text-align: center; padding: 40px 16px; color: #666;">
                                <span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span>
                                <p style="margin-top: 12px;">No hay chats activos</p>
                            </div>
                        </div>
                    </div>

                    <!-- √Årea de Chat -->
                    <div class="stat-card" style="display: flex; flex-direction: column;">
                        <div id="chatHeader" style="padding: 16px; border-bottom: 1px solid #e0e0e0; background: #f5f5f5;">
                            <h3 style="margin: 0; font-size: 1.1rem;">Selecciona un chat para ver la conversaci√≥n</h3>
                        </div>
                        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; background: #fafafa;">
                            <p style="text-align: center; color: #666; margin-top: 60px;">
                                <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">question_answer</span>
                                Selecciona un chat de la lista para comenzar
                            </p>
                        </div>
                        <div id="chatInputContainer" style="padding: 16px; border-top: 1px solid #e0e0e0; display: none;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="chatMessageInput" placeholder="Escribe tu respuesta..." 
                                       style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem;"
                                       onkeypress="if(event.key === 'Enter') {if(window.enviarMensajeAhora){window.enviarMensajeAhora();}else{alert('Funci√≥n no disponible');}}">
                                <button class="form-button" style="background: #1976d2; color: white; padding: 12px 24px;" onclick="if(window.enviarMensajeAhora){window.enviarMensajeAhora();}else{alert('Funci√≥n no disponible');}">
                                    <span class="material-icons" style="vertical-align: middle;">send</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flor Configuration Section -->
            <div id="flor-config-section" style="display: none;">
                <h2 class="page-title">Configuraci√≥n de Flor IA</h2>
                
                <!-- Tabs -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px;">
                    <button class="flor-tab active" onclick="window.showFlorTab('general')" data-tab="general">‚öôÔ∏è General</button>
                    <button class="flor-tab" onclick="window.showFlorTab('knowledge')" data-tab="knowledge">üìö Conocimiento</button>
                    <button class="flor-tab" onclick="window.showFlorTab('responses')" data-tab="responses">üí¨ Respuestas</button>
                    <button class="flor-tab" onclick="window.showFlorTab('policies')" data-tab="policies">üìã Pol√≠ticas</button>
                    <button class="flor-tab" onclick="window.showFlorTab('ai')" data-tab="ai">ü§ñ IA</button>
                    <button class="flor-tab" onclick="window.showFlorTab('whatsapp')" data-tab="whatsapp" style="background: #25D366; color: white;">üì± WhatsApp</button>
                </div>

                <!-- General Tab -->
                <div id="flor-tab-general" class="flor-tab-content active">
                    <!-- Configuraci√≥n B√°sica -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">‚öôÔ∏è Configuraci√≥n General</h3>
                        <div style="display: grid; gap: 16px; max-width: 600px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Nombre del Agente</label>
                                <input type="text" id="flor-name" value="Flor" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Rol</label>
                                <input type="text" id="flor-role" value="Agente Multimodal de Conversaci√≥n" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Mensaje de Bienvenida</label>
                                <textarea id="flor-greeting" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¬°Hola! Soy Flor, tu asistente virtual de Checkin24hs. Puedo ayudarte con texto, audio o im√°genes. ¬øEn qu√© puedo ayudarte hoy?</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Personalidad</label>
                                <input type="text" id="flor-personality" value="Amable, eficiente y profesional" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Capacidades Multimodales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">üñºÔ∏è Capacidades Multimodales</h3>
                        <p style="color: #666; margin-bottom: 20px;">Flor puede procesar texto, audio e im√°genes para responder consultas de forma m√°s completa.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Protocolo de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üé§</span> Protocolo de Audio
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="audio-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Habilitar recepci√≥n de audios</span>
                                    </label>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Duraci√≥n m√°xima de audio (segundos)</label>
                                        <input type="number" id="audio-max-duration" value="45" min="10" max="120" style="width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                        <span style="font-size: 0.85rem; color: #666; margin-left: 8px;">Recomendado: 45 seg</span>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0;">
                                        üìã <strong>Comportamiento:</strong> El audio se transcribe a texto y se procesa como una consulta normal. Si excede el l√≠mite o es de mala calidad, se muestra el mensaje de fallback.
                                    </p>
                                </div>
                            </div>

                            <!-- Protocolo de Im√°genes (Entrada) -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üì∏</span> Protocolo de Im√°genes (Entrada)
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="image-input-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Habilitar an√°lisis de im√°genes enviadas por clientes</span>
                                    </label>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0;">
                                        üìã <strong>Uso principal:</strong> Identificaci√≥n de productos, tipos de habitaciones o problemas. La imagen se compara con la Base de Conocimiento para dar una respuesta relevante.
                                    </p>
                                    <div style="background: #fff3e0; padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                                        üîí <strong>Seguridad:</strong> Las im√°genes de clientes nunca se almacenan. Solo se usan para la respuesta inmediata.
                                    </div>
                                </div>
                            </div>

                            <!-- Protocolo de Env√≠o de Im√°genes (Salida) -->
                            <div style="background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #e91e63;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.3rem;">üì§</span> Protocolo de Env√≠o de Im√°genes (Salida)
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="image-output-enabled" checked style="width: 18px; height: 18px;">
                                        <span>Permitir que Flor env√≠e im√°genes proactivamente</span>
                                    </label>
                                    <p style="font-size: 0.85rem; color: #555; margin: 0 0 8px 0;">
                                        üìã <strong>Condiciones de env√≠o:</strong>
                                    </p>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: #555;">
                                        <li><strong>Solicitud visual:</strong> Cliente pregunta por apariencia de hotel/habitaci√≥n</li>
                                        <li><strong>Documentaci√≥n:</strong> Mapas de ubicaci√≥n, infograf√≠as de servicios</li>
                                    </ul>
                                    <div style="margin-top: 8px;">
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Endpoint de im√°genes (API)</label>
                                        <input type="text" id="image-api-endpoint" value="/api/hoteles/imagen/{nombre_hotel}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√≥n Guardar -->
                    <div class="stat-card" style="padding: 24px;">
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveFlorGeneral()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Configuraci√≥n General
                        </button>
                    </div>
                </div>

                <!-- Knowledge Tab -->
                <div id="flor-tab-knowledge" class="flor-tab-content" style="display: none;">
                    <!-- Info Banner -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px 20px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">üîÑ</span>
                        <div>
                            <strong>Conocimiento Sincronizado</strong>
                            <p style="margin: 4px 0 0 0; font-size: 0.9rem; color: #1565c0;">La informaci√≥n b√°sica se sincroniza autom√°ticamente desde la secci√≥n <strong>Hoteles</strong>. Aqu√≠ puedes agregar informaci√≥n adicional espec√≠fica para Flor.</p>
                        </div>
                    </div>

                    <!-- Selector de Hotel -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">üìö Base de Conocimiento por Hotel</h3>
                        <div style="margin-bottom: 24px;">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">üè® Seleccionar Hotel:</label>
                            <select id="knowledge-hotel-selector" style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="loadSelectedHotelKnowledge()">
                                <option value="">-- Seleccione un hotel --</option>
                            </select>
                        </div>
                        
                        <!-- Contenedor principal de conocimiento -->
                        <div id="hotels-knowledge-list">
                            <p style="color: #666; text-align: center; padding: 40px;">Seleccione un hotel para ver/editar su base de conocimiento</p>
                        </div>
                    </div>
                </div>

                <!-- Responses Tab -->
                <div id="flor-tab-responses" class="flor-tab-content" style="display: none;">
                    <!-- Respuestas Generales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">üí¨ Respuestas Generales</h3>
                        <div style="display: grid; gap: 16px; max-width: 700px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Cuando no entiende</label>
                                <textarea id="response-no-entendido" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Lo siento, no he podido entender tu consulta. ¬øPodr√≠as reformularla o prefieres que te conecte con un agente humano?</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Transferir a humano</label>
                                <textarea id="response-transferir" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Entendido, voy a transferirte con uno de nuestros agentes. Por favor espera un momento.</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Despedida</label>
                                <textarea id="response-despedida" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¬°Gracias por contactarnos! Si tienes m√°s preguntas, estar√© aqu√≠ para ayudarte. ¬°Hasta pronto!</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Respuestas Multimodales -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">üñºÔ∏è Respuestas Multimodales</h3>
                        <p style="color: #666; margin-bottom: 20px;">Mensajes que Flor usar√° cuando reciba audio o im√°genes con problemas.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Fallback de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üé§</span> Fallback de Audio
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Audio muy largo o de mala calidad</label>
                                        <textarea id="response-audio-fallback" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Disculpa, el audio no fue del todo claro. Para atenderte con la rapidez que mereces, ¬øpodr√≠as enviarme tu consulta por escrito, o prefieres que te conecte con un agente ahora mismo?</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Audio proces√°ndose</label>
                                        <textarea id="response-audio-processing" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Un momento, estoy escuchando tu mensaje de voz... üéß</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Fallback de Im√°genes -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üì∏</span> Fallback de Im√°genes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen no reconocida</label>
                                        <textarea id="response-image-fallback" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">No pude identificar claramente la imagen. ¬øPodr√≠as describirme qu√© est√°s buscando o enviar otra foto con mejor iluminaci√≥n?</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen proces√°ndose</label>
                                        <textarea id="response-image-processing" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Un momento, estoy analizando la imagen... üîç</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen de hotel identificada</label>
                                        <textarea id="response-image-hotel-found" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">¬°Reconozco esa imagen! Se trata de {nombre_hotel}. Te cuento m√°s sobre este hotel:</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Respuestas de Env√≠o de Im√°genes -->
                            <div style="background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üì§</span> Env√≠o de Im√°genes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Antes de enviar imagen de hotel</label>
                                        <textarea id="response-image-sending" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Aqu√≠ te muestro una foto de {nombre_hotel}:</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.9rem;">Imagen no disponible</label>
                                        <textarea id="response-image-not-available" rows="2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">Lo siento, no tengo im√°genes disponibles de este hotel en este momento. ¬øTe gustar√≠a que te conecte con un agente que pueda mostrarte fotos?</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√≥n Guardar -->
                    <div class="stat-card" style="padding: 24px;">
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveFlorResponses()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Todas las Respuestas
                        </button>
                    </div>
                </div>

                <!-- Policies Tab -->
                <div id="flor-tab-policies" class="flor-tab-content" style="display: none;">
                    <!-- Pol√≠ticas por Hotel -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 20px 0;">üè® Pol√≠ticas por Hotel</h3>
                        <div style="margin-bottom: 24px;">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Seleccionar Hotel:</label>
                            <select id="policy-hotel-select" style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="loadHotelPolicies()">
                                <option value="">-- Seleccione un hotel --</option>
                            </select>
                        </div>
                        <div id="hotel-policies-form" style="display: none; max-width: 700px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Condiciones para la Reserva</label>
                                <textarea id="policy-condiciones-reserva" rows="5" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Ej: Se requiere un dep√≥sito del 30% para confirmar..."></textarea>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Pol√≠ticas de Cancelaci√≥n</label>
                                <textarea id="policy-cancelacion-modificacion" rows="5" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Ej: Cancelaci√≥n gratuita hasta 72 horas antes..."></textarea>
                            </div>
                            <button class="form-button" style="background: #4caf50; color: white;" onclick="saveFlorPolicies()">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                                Guardar Pol√≠ticas del Hotel
                            </button>
                        </div>
                    </div>

                    <!-- Pol√≠ticas de Privacidad Multimedia -->
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">üîí Pol√≠ticas de Privacidad Multimedia</h3>
                        <p style="color: #666; margin-bottom: 20px;">Reglas de seguridad para el manejo de archivos multimedia de clientes.</p>
                        
                        <div style="display: grid; gap: 20px; max-width: 700px;">
                            <!-- Pol√≠tica de Im√°genes -->
                            <div style="background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #f44336;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üì∏</span> Pol√≠tica de Im√°genes de Clientes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-store-images" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No almacenar im√°genes de clientes</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Las im√°genes enviadas por clientes (personas, documentos) solo se usan para la respuesta inmediata y nunca se guardan.</p>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-share-images" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No compartir im√°genes con terceros</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Las im√°genes de clientes nunca se comparten con servicios externos excepto para su an√°lisis inmediato.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Pol√≠tica de Audio -->
                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üé§</span> Pol√≠tica de Audios de Clientes
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-no-store-audio" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">No almacenar grabaciones de voz</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">Los audios se transcriben a texto y se eliminan inmediatamente. Solo se guarda la transcripci√≥n para la conversaci√≥n.</p>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="policy-audio-privacy" checked disabled style="width: 18px; height: 18px; margin-top: 2px;">
                                        <div>
                                            <span style="font-weight: 500;">Transcripci√≥n privada</span>
                                            <p style="font-size: 0.85rem; color: #666; margin: 4px 0 0 0;">La transcripci√≥n de audio se procesa de forma segura y no se usa para entrenamiento de modelos.</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Reglas de Env√≠o de Im√°genes -->
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                                <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üì§</span> Reglas de Env√≠o de Im√°genes
                                </h4>
                                <p style="font-size: 0.9rem; color: #555; margin-bottom: 12px;">
                                    Flor solo enviar√° im√°genes bajo estas condiciones:
                                </p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 0.9rem; color: #555;">
                                    <li style="margin-bottom: 8px;"><strong>Solicitud expl√≠cita:</strong> El cliente pregunta por la apariencia de un hotel o habitaci√≥n</li>
                                    <li style="margin-bottom: 8px;"><strong>Documentaci√≥n est√°ndar:</strong> Mapas de ubicaci√≥n, infograf√≠as de servicios pre-aprobadas</li>
                                    <li><strong>Contenido funcional:</strong> Las im√°genes deben ser √∫tiles, no decorativas</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje de Conformidad -->
                    <div class="stat-card" style="padding: 24px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 2rem;">‚úÖ</span>
                            <div>
                                <h4 style="margin: 0 0 4px 0;">Pol√≠ticas de Privacidad Activas</h4>
                                <p style="margin: 0; color: #2e7d32; font-size: 0.9rem;">Las pol√≠ticas de seguridad multimedia est√°n habilitadas y no pueden ser desactivadas para proteger la privacidad de los clientes.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Tab -->
                <div id="flor-tab-ai" class="flor-tab-content" style="display: none;">
                    <div class="stat-card" style="padding: 24px;">
                        <h3 style="margin: 0 0 8px 0;">ü§ñ Configuraci√≥n de Inteligencia Artificial</h3>
                        <p style="color: #666; margin-bottom: 24px;">Conecta Flor con una API de IA para respuestas m√°s naturales e inteligentes.</p>
                        
                        <div style="max-width: 600px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="ai-enabled" onchange="toggleAIConfig()">
                                    <span style="font-weight: 500;">Habilitar respuestas con IA</span>
                                </label>
                            </div>

                            <div id="ai-config-fields" style="display: none;">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Proveedor</label>
                                    <select id="ai-provider" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" onchange="updateAIModel()">
                                        <option value="gemini">Google Gemini - GRATIS</option>
                                        <option value="openai">OpenAI (GPT-4) - Pago</option>
                                        <option value="claude">Claude (Anthropic) - Pago</option>
                                    </select>
                                    <p style="font-size: 0.8rem; color: #666; margin-top: 4px;">üí° Gemini es gratis con l√≠mites generosos</p>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">API Key</label>
                                    <input type="password" id="ai-api-key" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;" placeholder="Tu API key...">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Modelo</label>
                                    <input type="text" id="ai-model" value="gemini-2.5-flash" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                    <p id="ai-model-help" style="font-size: 0.8rem; color: #666; margin-top: 4px;">Modelos: gemini-2.5-flash (recomendado), gemini-2.0-flash, gemini-2.5-pro</p>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button class="form-button" style="background: #4caf50; color: white;" onclick="saveAIConfig()">
                                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                                        Guardar
                                    </button>
                                    <button class="form-button secondary" onclick="testAIConfig()">
                                        Probar Conexi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administrators Section -->
            <div id="administrators-section" style="display: none;">
                <h2 class="page-title">Gesti√≥n de Administradores</h2>
                
                <!-- Action Buttons -->
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="form-button" style="background: #4caf50; color: white;" onclick="showNewAdminModal()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person_add</span>
                        Nuevo Administrador
                    </button>
                    <button class="form-button secondary" onclick="refreshAdmins()">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">refresh</span>
                        Actualizar
                    </button>
                </div>

                <!-- Backup & Sync Section -->
                <div class="activity-card" style="margin-bottom: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 class="card-title" style="color: white; margin-bottom: 16px;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">backup</span>
                        Backup y Sincronizaci√≥n
                    </h3>
                    <p style="margin-bottom: 16px; opacity: 0.9;">Crea un punto de restauraci√≥n de todos los datos del sistema o restaura desde un backup anterior.</p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="form-button" style="background: #4caf50; color: white;" onclick="createFullBackup()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_download</span>
                            Crear Backup Completo
                        </button>
                        <button class="form-button" style="background: #ff9800; color: white;" onclick="showRestoreBackupModal()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_upload</span>
                            Restaurar Backup
                        </button>
                        <button class="form-button" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="checkSyncStatus()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">sync</span>
                            Estado de Sincronizaci√≥n
                        </button>
                        <button class="form-button" style="background: linear-gradient(135deg, #4caf50, #2e7d32); color: white;" onclick="syncAllTablesToSupabase()">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_sync</span>
                            Sincronizar TODO
                        </button>
                    </div>
                    <div id="syncStatusIndicator" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                        <span id="syncStatusText"></span>
                    </div>
                </div>

                <!-- WhatsApp Tab -->
                <div id="flor-tab-whatsapp" class="flor-tab-content" style="display: none;">
                    <div class="stat-card" style="padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0;">üì± Integraci√≥n con WhatsApp</h3>
                        <p style="color: #666; margin-bottom: 24px;">
                            Conecta Flor con WhatsApp para responder autom√°ticamente a tus clientes. Puedes conectar hasta 4 n√∫meros de WhatsApp, cada uno con su propio QR y usando Flor IA para las respuestas.
                        </p>
                        
                        <!-- Bot√≥n para abrir modal de conexi√≥n m√∫ltiple -->
                        <div style="margin-bottom: 24px;">
                            <button onclick="if(typeof openWhatsAppMultiConnectModal === 'function') { openWhatsAppMultiConnectModal(); } else { console.error('openWhatsAppMultiConnectModal no est√° definida'); alert('Error: La funci√≥n no est√° disponible. Recarga la p√°gina.'); }" style="background: #25D366; color: white; border: none; padding: 14px 24px; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s;" onmouseover="this.style.background='#1da851'" onmouseout="this.style.background='#25D366'">
                                <span style="font-size: 1.2rem;">üì±</span>
                                <span>Conectar M√∫ltiples WhatsApp (hasta 4)</span>
                            </button>
                        </div>

                        <!-- Configuraci√≥n del Servidor -->
                        <div style="margin-bottom: 24px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                            <h4 style="margin: 0 0 16px 0;">üñ•Ô∏è Configuraci√≥n del Servidor</h4>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">URL del Servidor WhatsApp</label>
                                <input type="text" id="whatsapp-server-url" value="http://72.61.58.240:3001" placeholder="http://tu-servidor:3001" style="width: 100%; max-width: 500px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                                <p style="color: #666; font-size: 0.85rem; margin-top: 4px;">
                                    La URL del servidor donde est√° corriendo el servicio de WhatsApp.
                                </p>
                            </div>
                        </div>

                        <!-- Respuestas Autom√°ticas -->
                        <div style="margin-bottom: 24px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                            <h4 style="margin: 0 0 16px 0;">ü§ñ Respuestas Autom√°ticas con Flor IA</h4>
                            <div style="margin-bottom: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="whatsapp-auto-reply" style="width: 18px; height: 18px;">
                                    <span style="font-weight: 500;">Habilitar respuestas autom√°ticas de Flor IA</span>
                                </label>
                                <p style="color: #666; font-size: 0.85rem; margin-top: 4px; margin-left: 26px;">
                                    Cuando est√° activado, Flor IA responder√° autom√°ticamente los mensajes de WhatsApp usando la configuraci√≥n de IA.
                                </p>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="whatsapp-business-hours-only" style="width: 18px; height: 18px;">
                                    <span style="font-weight: 500;">Solo responder en horario laboral</span>
                                </label>
                                <p style="color: #666; font-size: 0.85rem; margin-top: 4px; margin-left: 26px;">
                                    Flor IA solo responder√° durante el horario configurado (9:00 - 18:00 por defecto).
                                </p>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Mensaje fuera de horario</label>
                                <textarea id="whatsapp-out-of-hours-message" rows="3" placeholder="Gracias por contactarnos. Nuestro horario de atenci√≥n es de Lunes a Viernes de 9:00 a 18:00. Te responderemos a la brevedad." style="width: 100%; max-width: 600px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;"></textarea>
                            </div>
                            <button onclick="saveWhatsAppConfig()" style="margin-top: 16px; background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">admin_panel_settings</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdmins">0</h3>
                                <p>Total Administradores</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #2e7d32;">
                                <span class="material-icons">verified_user</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsTotal">0</h3>
                                <p>Administradores Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #ed6c02;">
                                <span class="material-icons">person</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalAdminsUser">0</h3>
                                <p>Usuarios</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #9c27b0;">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="activeAdmins">0</h3>
                                <p>Activos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Administrators Table -->
                <div class="activity-card">
                    <h3 class="card-title">Lista de Administradores</h3>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Usuario</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Nombre</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 500;">Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Rol</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">√öltimo Login</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Estado</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 500;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="adminsTableBody">
                                <!-- Los administradores se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quotes Section -->
            <div id="quotes-section" style="display: none;">
                <h2 class="page-title">Gesti√≥n de Cotizaciones</h2>
                
                <!-- Estad√≠sticas de Cotizaciones -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalQuotes">0</div>
                            <div class="stat-label">Total Cotizaciones</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="pendingQuotes">0</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="processedQuotes">0</div>
                            <div class="stat-label">Procesadas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <div class="stat-number" id="avgQuotesPerDay">0</div>
                            <div class="stat-label">Promedio/D√≠a</div>
                        </div>
                    </div>
                </div>

                <!-- Controles de Cotizaciones -->
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="showNewQuoteModal()" style="background: #28a745;">
                            <span class="material-icons">add</span>
                            Nueva Cotizaci√≥n
                        </button>
                        <button class="action-btn primary" onclick="showSendCotizadorLinkModal()" style="background: #25d366;">
                            <span class="material-icons">link</span>
                            Enviar Link Cotizador
                        </button>
                        <button class="action-btn primary" onclick="refreshQuotes()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                        <button class="action-btn secondary" onclick="exportQuotes()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn danger" onclick="clearAllQuotes()">
                            <span class="material-icons">delete_sweep</span>
                            Limpiar Todo
                        </button>
                        <button class="action-btn primary" onclick="testQuotesSync()">
                            <span class="material-icons">bug_report</span>
                            Probar Sincronizaci√≥n
                        </button>
                        <input type="file" id="quoteImageUpload" accept="image/*" style="display: none;" onchange="handleQuoteImageUpload(event)">
                        <button class="action-btn primary" onclick="document.getElementById('quoteImageUpload').click()" style="background: #9c27b0;">
                            <span class="material-icons">image</span>
                            Subir Imagen
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="quotesSearch" placeholder="Buscar cotizaciones..." onkeyup="filterQuotes()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Tabla de Cotizaciones -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hotel</th>
                                <th>Cliente</th>
                                <th>Fechas</th>
                                <th>Hu√©spedes</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="quotesTableBody">
                            <!-- Las cotizaciones se cargar√°n din√°micamente aqu√≠ -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay cotizaciones -->
                <div id="noQuotesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">üìã</div>
                    <h3>No hay cotizaciones</h3>
                    <p>Las cotizaciones enviadas desde el sitio web aparecer√°n aqu√≠ autom√°ticamente.</p>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses-section" style="display: none;">
                <h2 class="page-title">Gesti√≥n de Gastos</h2>
                
                <!-- KPIs de Eficiencia de Costos -->
                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #d32f2f;">
                                <span class="material-icons">trending_down</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpaValue">$0</h3>
                                <p>Costo por Adquisici√≥n (CPA)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpaSubtitle">Gasto Marketing / Reservas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #f57c00;">
                                <span class="material-icons">phone</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="cpcValue">$0</h3>
                                <p>Costo por Llamada (CPC)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="cpcSubtitle">Costos Telecom + Agentes / Llamadas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #1976d2;">
                                <span class="material-icons">account_balance</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalExpenses">$0</h3>
                                <p>Gastos Totales</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="totalExpensesSubtitle">Fijos + Variables</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background-color: #388e3c;">
                                <span class="material-icons">compare_arrows</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="budgetVariance">0%</h3>
                                <p>Variaci√≥n Presupuesto</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">info</span>
                            <span id="budgetVarianceSubtitle">Real vs Presupuestado</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                                <span class="material-icons">attach_money</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalExpensesUSD" style="color: #2e7d32;">$0</h3>
                                <p>Acumulado en D√≥lares (USD)</p>
                            </div>
                        </div>
                        <div class="stat-trend">
                            <span class="material-icons">currency_exchange</span>
                            <span id="totalExpensesUSDSubtitle">Tipo de cambio: $1 USD</span>
                        </div>
                    </div>
                </div>

                <!-- Controles de Gastos -->
                <div class="action-bar" style="margin-bottom: 24px;">
                    <div class="action-buttons" style="flex-wrap: wrap;">
                        <button class="action-btn primary" onclick="addNewExpense()">
                            <span class="material-icons">add</span>
                            Agregar Gasto
                        </button>
                        <button class="action-btn secondary" onclick="exportExpenses()">
                            <span class="material-icons">download</span>
                            Exportar
                        </button>
                        <button class="action-btn secondary" onclick="refreshExpenses()">
                            <span class="material-icons">refresh</span>
                            Actualizar
                        </button>
                        <button class="action-btn secondary" onclick="openMassUpdateExchangeRate()" style="background: #ff9800; color: white;">
                            <span class="material-icons">currency_exchange</span>
                            Actualizar TC Masivo
                        </button>
                        <button class="action-btn secondary" onclick="cleanDuplicateExpenses()" style="background: #d32f2f; color: white; border: 2px solid #b71c1c;">
                            <span class="material-icons">cleaning_services</span>
                            üßπ Limpiar Duplicados
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="expensesSearch" placeholder="Buscar gastos..." onkeyup="filterExpenses()">
                        <span class="material-icons">search</span>
                    </div>
                </div>

                <!-- Grid de Gr√°ficos y Tabla -->
                <div class="dashboard-grid">
                    <!-- Gr√°fico de Composici√≥n de Gastos (Pie Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Composici√≥n del Gasto</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="expensesCompositionChart"></canvas>
                        </div>
                        <div id="expensesCompositionLegend" style="margin-top: 16px; display: flex; justify-content: center; flex-wrap: wrap; gap: 16px;">
                            <!-- Leyenda se generar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Gr√°fico de Desglose de Gastos Variables (Bar Chart) -->
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="card-title" style="margin: 0;">Desglose de Gastos Variables</h3>
                        </div>
                        <div style="position: relative; height: 300px;">
                            <canvas id="variableExpensesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Gasto vs Presupuesto (Line Chart) -->
                <div class="chart-card" style="margin-top: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin: 0;">Gasto vs Presupuesto</h3>
                        <div style="display: flex; gap: 12px;">
                            <select id="budgetPeriodFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;" onchange="updateBudgetChart()">
                                <option value="monthly">Mensual</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                    </div>
                    <div style="position: relative; height: 350px;">
                        <canvas id="budgetComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Tabla de Gastos -->
                <div class="table-container" style="margin-top: 24px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Categor√≠a</th>
                                <th>Subcategor√≠a</th>
                                <th>Tipo</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Tipo de Cambio</th>
                                <th>USD</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Los gastos se cargar√°n din√°micamente aqu√≠ -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay gastos -->
                <div id="noExpensesMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">üí∞</div>
                    <h3>No hay gastos registrados</h3>
                    <p>Agrega gastos para comenzar a analizar los costos del call center.</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Agregar/Editar Hotel - NUEVO Y LIMPIO -->
    <div id="editHotelModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 85vh; overflow-y: auto;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 class="modal-title" id="editHotelModalTitle">üè® Agregar Nuevo Hotel</h2>
            
            <form id="editHotelForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Columna Izquierda -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Nombre del Hotel *</label>
                            <input type="text" class="form-input" id="editHotelName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ubicaci√≥n *</label>
                            <input type="text" class="form-input" id="editHotelLocation" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üìç Ubicaci√≥n Google Maps</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelGoogleMaps" placeholder="https://maps.google.com/?q=..." style="flex: 1;">
                                <button type="button" class="form-button secondary" onclick="openGoogleMapsHelp()" style="white-space: nowrap;" title="Ayuda">
                                    <span class="material-icons" style="font-size: 16px;">help</span>
                                </button>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                üí° <strong>Tip:</strong> Busca el hotel en Google Maps, haz clic en "Compartir" y copia el enlace
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üåê Sitio Web del Hotel</label>
                            <input type="url" class="form-input" id="editHotelWebsite" placeholder="https://www.nombrehotel.com">
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                ü§ñ <strong>Flor IA</strong> usar√° esta URL para obtener informaci√≥n adicional
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Calificaci√≥n (1-5)</label>
                            <input type="number" class="form-input" id="editHotelRating" min="1" max="5" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rango de Precio</label>
                            <input type="text" class="form-input" id="editHotelPrice" placeholder="$150-$300 USD">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Categor√≠a de Precio</label>
                            <select class="form-input" id="editHotelPriceRange">
                                <option value="low">Bajo</option>
                                <option value="medium">Medio</option>
                                <option value="high">Alto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-input" id="editHotelStatus">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Imagen Principal *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelImage" placeholder="Selecciona una imagen" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para imagen principal -->
                                <input type="file" id="mainImageFileInput" accept="image/*" style="display: none;" onchange="handleMainImageUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('mainImageFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('main')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editImagePreview" style="margin-top: 10px; min-height: 50px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Galer√≠a de Fotos</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" class="form-input" id="editHotelPhotos" placeholder="Selecciona im√°genes para la galer√≠a" readonly style="flex: 1; background: #f5f5f5;">
                                <!-- Input de archivo oculto para galer√≠a -->
                                <input type="file" id="galleryImagesFileInput" accept="image/*" multiple style="display: none;" onchange="handleGalleryImagesUpload(event)">
                                <button type="button" class="form-button" onclick="document.getElementById('galleryImagesFileInput').click()" style="white-space: nowrap;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">folder_open</span>
                                    Seleccionar desde Disco
                                </button>
                                <button type="button" class="form-button" onclick="openImageManagerSimple('gallery')" style="white-space: nowrap; background: #4caf50;">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px; font-size: 18px;">link</span>
                                    Desde URL
                                </button>
                            </div>
                            <div id="editPhotosPreview" style="margin-top: 10px; min-height: 50px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n Breve</label>
                            <textarea class="form-input" id="editHotelDescription" rows="2" placeholder="Descripci√≥n corta del hotel"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amenities (separadas por comas)</label>
                            <input type="text" class="form-input" id="editHotelAmenities" placeholder="Spa, Restaurante, WiFi, Parking">
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de Informaci√≥n para Flor IA -->
                <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e8f5e9, #f3e5f5); border-radius: 12px; border: 2px solid #9c27b0;">
                    <h3 style="margin: 0 0 15px 0; color: #7b1fa2; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">ü§ñ</span> Informaci√≥n para Flor IA
                        <span style="font-size: 12px; background: #9c27b0; color: white; padding: 3px 8px; border-radius: 10px;">Flor usar√° estos datos</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Columna Izquierda -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">üìù Descripci√≥n Detallada</label>
                                <textarea class="form-input" id="editHotelFlorDescription" rows="4" 
                                    placeholder="Descripci√≥n completa del hotel para que Flor pueda contarle a los clientes...
Ej: Hotel boutique de lujo con vistas al lago. Ideal para parejas y familias que buscan una experiencia √∫nica en la Patagonia."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üèä Servicios e Instalaciones</label>
                                <textarea class="form-input" id="editHotelFlorServices" rows="4" 
                                    placeholder="Lista detallada de servicios...
Ej:
‚Ä¢ Spa con piscina climatizada y jacuzzi
‚Ä¢ Restaurante gourmet con cocina local
‚Ä¢ Bar con vista panor√°mica
‚Ä¢ WiFi gratuito en todas las √°reas
‚Ä¢ Estacionamiento privado"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üéø Excursiones y Actividades</label>
                                <textarea class="form-input" id="editHotelFlorExcursions" rows="4" 
                                    placeholder="Actividades disponibles...
Ej:
‚Ä¢ Trekking por el bosque nativo ($45 USD)
‚Ä¢ Paseo en kayak por el lago ($60 USD)
‚Ä¢ Avistamiento de aves (incluido)
‚Ä¢ Esqu√≠ en temporada (traslado incluido)
‚Ä¢ Canopy y tirolesa ($80 USD)"></textarea>
                            </div>
                        </div>
                        
                        <!-- Columna Derecha -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">üí∞ Informaci√≥n de Precios</label>
                                <textarea class="form-input" id="editHotelFlorPrices" rows="4" 
                                    placeholder="Tarifas y precios...
Ej:
‚Ä¢ Habitaci√≥n Doble: $180-$250 USD/noche
‚Ä¢ Suite Familiar: $320-$400 USD/noche
‚Ä¢ Todo Incluido disponible: +$80 USD/persona
‚Ä¢ Ni√±os menores de 5 a√±os: Gratis
‚Ä¢ Temporada alta: +30%"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üìã Pol√≠ticas del Hotel</label>
                                <textarea class="form-input" id="editHotelFlorPolicies" rows="4" 
                                    placeholder="Pol√≠ticas importantes...
Ej:
‚Ä¢ Check-in: 15:00 hrs / Check-out: 11:00 hrs
‚Ä¢ Cancelaci√≥n gratuita hasta 48 hrs antes
‚Ä¢ Se aceptan mascotas peque√±as (+$30 USD)
‚Ä¢ Dep√≥sito de garant√≠a: $100 USD
‚Ä¢ All-inclusive: desayuno, almuerzo y cena"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">üöó C√≥mo Llegar</label>
                                <textarea class="form-input" id="editHotelFlorTransport" rows="4" 
                                    placeholder="Informaci√≥n de transporte...
Ej:
‚Ä¢ A 2 horas del aeropuerto de Temuco
‚Ä¢ Transfer desde aeropuerto: $80 USD (ida y vuelta)
‚Ä¢ Bus desde Santiago: 12 horas, terminal Panguipulli
‚Ä¢ Coordenadas GPS: -39.8500, -71.9000
‚Ä¢ Ruta pavimentada hasta el hotel"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">üìû Informaci√≥n de Contacto</label>
                        <textarea class="form-input" id="editHotelFlorContact" rows="2" 
                            placeholder="Tel√©fono: +56 9 1234 5678 | Email: reservas@hotel.com | WhatsApp: +56 9 1234 5678"></textarea>
                    </div>
                </div>
                
                <!-- Botones -->
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="form-button secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="form-button" onclick="saveHotelChanges()" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal del Carrusel de Fotos -->
    <div id="photoCarouselModal" class="modal">
                        <div class="modal-content" style="max-width: 85vw; max-height: 85vh; padding: 0; background: transparent; box-shadow: none;">
            <div style="position: relative; width: 100%; height: 100%;">
                <!-- Bot√≥n cerrar -->
                <button class="close" onclick="closePhotoCarousel()" style="position: absolute; top: 20px; right: 20px; z-index: 1001; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">&times;</button>
                
                <!-- Imagen principal -->
                <div id="carouselImageContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9);">
                    <img id="carouselImage" src="" alt="Foto" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
                </div>
                
                <!-- Controles de navegaci√≥n -->
                <button id="prevButton" onclick="previousPhoto()" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">‚Äπ</button>
                <button id="nextButton" onclick="nextPhoto()" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1001;">‚Ä∫</button>
                
                <!-- Indicador de posici√≥n -->
                <div id="photoCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1001;"></div>
                
                <!-- Miniaturas -->
                <div id="carouselThumbnails" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1001; max-width: 80%; overflow-x: auto; padding: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal del Gestor de Im√°genes -->
    <div id="imageManagerModal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #333;">üì∏ Gestor de Im√°genes - <span id="currentHotelName">Nuevo Hotel</span></h2>
                <button onclick="closeImageManagerSimple()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 35px; height: 35px; line-height: 35px;">&times;</button>
            </div>
            
            <!-- Secci√≥n de Subir Im√°genes -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">üì§ Subir Im√°genes desde tu Disco Duro</h3>
                
                <!-- Input de archivo oculto -->
                <input 
                    type="file" 
                    id="imageUploadInput" 
                    multiple 
                    accept="image/*" 
                    style="display: none;"
                    onchange="handleFileSelection(event)">
                
                <!-- Bot√≥n grande y visible para seleccionar archivos -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <button 
                        type="button" 
                        id="selectFilesButton"
                        onclick="
                            console.log('üîµ Bot√≥n de seleccionar archivos clickeado');
                            const input = document.getElementById('imageUploadInput');
                            if (input) {
                                console.log('‚úÖ Input encontrado, abriendo explorador...');
                                input.click();
                            } else {
                                console.error('‚ùå Input imageUploadInput no encontrado');
                                alert('Error: No se puede abrir el explorador. Recarga la p√°gina.');
                            }
                        "
                        style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 20px 40px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 1.1rem;
                            font-weight: 600;
                            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            min-width: 300px;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                        <span class="material-icons" style="font-size: 28px;">folder_open</span>
                        <span>üìÅ Seleccionar Im√°genes desde tu Disco Duro</span>
                    </button>
                </div>
                
                <!-- Informaci√≥n de archivos seleccionados -->
                <div id="selectedFilesInfo" style="display: none; margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                    <strong>üìÅ Archivos seleccionados:</strong> <span id="fileCount">0</span> imagen(es)
                </div>
                
                <!-- Bot√≥n para subir -->
                <div style="text-align: center;">
                    <button 
                        type="button" 
                        id="uploadButton"
                        onclick="uploadImagesSimple()"
                        disabled
                        style="
                            background: #4caf50;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 600;
                            opacity: 0.5;
                            transition: all 0.3s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                        ">
                        <span class="material-icons" style="font-size: 20px;">cloud_upload</span>
                        <span>Subir Im√°genes</span>
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 0.9rem; color: #1565c0;">
                    <strong>üí° Informaci√≥n:</strong> Haz clic en el bot√≥n de arriba para abrir el explorador de archivos. Puedes seleccionar m√∫ltiples im√°genes a la vez. Las im√°genes se comprimir√°n autom√°ticamente (m√°ximo 10MB por imagen antes de comprimir).
                </div>
            </div>
            
            <!-- Vista Previa de Im√°genes Subidas -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.1rem;">üñºÔ∏è Im√°genes Disponibles</h3>
                <div id="uploadedImagesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; min-height: 100px;">
                    <p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                        No hay im√°genes subidas a√∫n. Selecciona im√°genes desde tu disco duro arriba.
                    </p>
                </div>
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="form-button secondary" onclick="closeImageManagerSimple()">
                    Cancelar
                </button>
                <button type="button" class="form-button" onclick="applyImageSelectionSimple()" style="background: #4caf50; color: white;">
                    Aplicar Selecci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar/Editar Gasto -->
    <div id="expenseModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeExpenseModal()">&times;</span>
            <h2 class="modal-title" id="expenseModalTitle">Agregar Gasto</h2>
            <form id="expenseForm" onsubmit="saveExpense(event)">
                <div class="form-group">
                    <label class="form-label">Fecha *</label>
                    <input type="date" id="expenseDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Gasto *</label>
                    <select id="expenseType" class="form-input" required onchange="updateExpenseCategories()">
                        <option value="">Seleccionar tipo</option>
                        <option value="fixed">Fijo</option>
                        <option value="variable">Variable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <select id="expenseCategory" class="form-input" required>
                        <option value="">Seleccionar categor√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Subcategor√≠a</label>
                    <input type="text" id="expenseSubcategory" class="form-input" placeholder="Ej: Meta Ads, Google Ads, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n *</label>
                    <textarea id="expenseDescription" class="form-input" rows="3" required placeholder="Descripci√≥n detallada del gasto"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto *</label>
                    <input type="number" id="expenseAmount" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Cambio *</label>
                    <input type="number" id="expenseExchangeRate" class="form-input" step="0.01" min="0" required placeholder="0.00" oninput="calculateUSD()">
                </div>
                <div class="form-group">
                    <label class="form-label">USD</label>
                    <input type="number" id="expenseUSD" class="form-input" step="0.01" min="0" placeholder="0.00" readonly style="background-color: #f5f5f5;">
                </div>
                
                <!-- Campo de Imagen/Comprobante -->
                <div class="form-group">
                    <label class="form-label">üì∑ Comprobante (opcional)</label>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <button type="button" class="form-button secondary" onclick="document.getElementById('expenseImageFile').click()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">upload_file</span>
                            Subir Archivo
                        </button>
                        <button type="button" class="form-button secondary" onclick="openCameraCapture()" style="flex: 1;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">photo_camera</span>
                            Tomar Foto
                        </button>
                    </div>
                    <input type="file" id="expenseImageFile" accept="image/*" style="display: none;" onchange="previewExpenseImage(this)">
                    <div id="expenseImagePreview" style="display: none; margin-top: 12px; position: relative;">
                        <img id="expenseImagePreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeExpenseImage()" style="position: absolute; top: -8px; right: -8px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                    </div>
                    <input type="hidden" id="expenseImageUrl">
                    <input type="hidden" id="expenseImageName">
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeExpenseModal()">Cancelar</button>
                    <button type="submit" class="form-button">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Captura de C√°mara -->
    <div id="cameraModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeCameraModal()">&times;</span>
            <h2 class="modal-title">üì∑ Capturar Comprobante</h2>
            <div style="text-align: center;">
                <video id="cameraVideo" autoplay playsinline style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button type="button" class="form-button secondary" onclick="closeCameraModal()">Cancelar</button>
                <button type="button" class="form-button" onclick="capturePhoto()" style="background: #4caf50;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">camera</span>
                    Capturar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nueva Cotizaci√≥n -->
    <div id="newQuoteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeNewQuoteModal()">&times;</span>
            <h2 class="modal-title">üìã Nueva Cotizaci√≥n</h2>
            <form id="quoteForm" onsubmit="createAndSendQuote(event)">
                <div class="form-group">
                    <label class="form-label">Hotel *</label>
                    <select id="quoteHotel" class="form-input" required>
                        <option value="">Seleccionar hotel</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Check-in *</label>
                        <input type="date" id="quoteCheckIn" class="form-input" required onchange="calculateNights()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Check-out *</label>
                        <input type="date" id="quoteCheckOut" class="form-input" required onchange="calculateNights()">
                    </div>
                </div>
                
                <div id="nightsDisplay" style="padding: 10px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px; display: none;">
                    <strong>Noches: <span id="nightsCount">0</span></strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Adultos *</label>
                        <input type="number" id="quoteAdults" class="form-input" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ni√±os</label>
                        <input type="number" id="quoteChildren" class="form-input" min="0" value="0" onchange="toggleChildrenAges()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Infantes</label>
                        <input type="number" id="quoteInfants" class="form-input" min="0" value="0">
                    </div>
                </div>
                
                <div id="childrenAgesContainer" style="display: none; margin-bottom: 15px;">
                    <label class="form-label">Edades de los ni√±os</label>
                    <div id="childrenAgesInputs"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">M√≥dulo *</label>
                    <select id="quoteModule" class="form-input" required>
                        <option value="">Seleccionar m√≥dulo</option>
                        <option value="Nothofagus">Nothofagus</option>
                        <option value="Reino Fungi">Reino Fungi</option>
                        <option value="Monta√±a Magica">Monta√±a Magica</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Tarifa *</label>
                        <input type="number" id="quoteTariff" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descuento</label>
                        <input type="number" id="quoteDiscount" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateFinalTariff()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tarifa Final</label>
                    <input type="number" id="quoteFinalTariff" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" value="0.00">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Se calcula autom√°ticamente: Tarifa - Descuento
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas adicionales (opcional)</label>
                    <textarea id="quoteNotes" class="form-input" rows="3" placeholder="Agregar notas o comentarios adicionales para la cotizaci√≥n"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">N√∫mero de WhatsApp del destinatario *</label>
                    <input type="tel" id="quotePhoneNumber" class="form-input" required 
                           placeholder="Ej: +56912345678 o 56912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el n√∫mero de tel√©fono con c√≥digo de pa√≠s (ej: +56912345678). El mensaje se enviar√° directamente por WhatsApp Business API.
                    </small>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>üì± Env√≠o directo por WhatsApp:</strong> La cotizaci√≥n se enviar√° autom√°ticamente al n√∫mero ingresado usando WhatsApp Business API. Aseg√∫rate de tener configuradas las credenciales de WhatsApp Business.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: space-between; margin-top: 24px; align-items: center;">
                    <button type="button" class="form-button secondary" onclick="showWhatsAppConfig()" style="background: #6c757d; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">settings</span>
                        Configurar WhatsApp
                    </button>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="form-button secondary" onclick="closeNewQuoteModal()">Cancelar</button>
                        <button type="submit" class="form-button" style="background: #25d366; color: white;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                            Crear y Enviar por WhatsApp
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Enviar Link del Cotizador -->
    <div id="sendCotizadorLinkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeSendCotizadorLinkModal()">&times;</span>
            <h2 class="modal-title">üì± Enviar Link del Cotizador</h2>
            <form id="sendLinkForm" onsubmit="sendCotizadorLink(event)">
                <div class="form-group">
                    <label class="form-label">N√∫mero de WhatsApp del Cliente *</label>
                    <input type="tel" id="linkPhoneNumber" class="form-input" required 
                           placeholder="Ej: +54912345678 o 54912345678" 
                           pattern="[+]?[0-9]{10,15}">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Ingresa el n√∫mero de tel√©fono con c√≥digo de pa√≠s
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mensaje Personalizado (Opcional)</label>
                    <textarea id="linkMessage" class="form-input" rows="3" 
                              placeholder="Hola! Te env√≠o el link para que puedas solicitar tu cotizaci√≥n personalizada..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Imagen (Opcional)</label>
                    <input type="file" id="linkImageInput" class="form-input" accept="image/*" onchange="previewLinkImage(event)">
                    <div id="linkImagePreview" style="margin-top: 10px; display: none;">
                        <img id="linkImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        <button type="button" onclick="removeLinkImage()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                    </div>
                </div>
                
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #1976d2; font-size: 0.9rem;">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Se enviar√° un link √∫nico del cotizador. Cuando el cliente complete el formulario, la cotizaci√≥n aparecer√° autom√°ticamente como "Pendiente" en tu dashboard.
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeSendCotizadorLinkModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #25d366; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                        Enviar Link por WhatsApp
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importar Usuarios -->
    <div id="importUsersModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeImportUsersModal()">&times;</span>
            <h2 class="modal-title">üì• Importar Usuarios</h2>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">
                    Importa usuarios desde un archivo CSV o JSON. Los campos requeridos son: <strong>nombre</strong> y <strong>tel√©fono</strong> (o <strong>email</strong>).
                </p>
                
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <strong>‚ö†Ô∏è Validaci√≥n de duplicados:</strong><br>
                        ‚Ä¢ Si el usuario tiene email: se mantiene el que se cre√≥ primero<br>
                        ‚Ä¢ Si el usuario no tiene email: se valida por tel√©fono y se mantiene el que ya estaba
                    </p>
                </div>
            </div>
            
            <form id="importUsersForm" onsubmit="importUsers(event)">
                <div class="form-group">
                    <label class="form-label">Seleccionar archivo *</label>
                    <input type="file" id="usersFile" class="form-input" accept=".csv,.json" required>
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Formatos soportados: CSV, JSON
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Formato del archivo</label>
                    <select id="fileFormat" class="form-input" required>
                        <option value="auto">Detectar autom√°ticamente</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                
                <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem;">Vista previa:</h3>
                    <div id="previewContent" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem;"></div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeImportUsersModal()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #2196f3; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">upload</span>
                        Importar Usuarios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de WhatsApp -->
    <div id="whatsappConfigModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeWhatsAppConfig()">&times;</span>
            <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n de WhatsApp Business API</h2>
            <form id="whatsappConfigForm" onsubmit="saveWhatsAppConfig(event)">
                <div class="form-group">
                    <label class="form-label">Access Token *</label>
                    <input type="text" id="whatsappAccessToken" class="form-input" required 
                           placeholder="Tu Access Token de WhatsApp Business API">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Obt√©n tu Access Token desde el panel de Facebook Developers
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number ID *</label>
                    <input type="text" id="whatsappPhoneNumberId" class="form-input" required 
                           placeholder="Tu Phone Number ID">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        ID del n√∫mero de tel√©fono verificado en WhatsApp Business
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Version</label>
                    <input type="text" id="whatsappApiVersion" class="form-input" 
                           value="v18.0" placeholder="v18.0">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Versi√≥n de la API de Facebook (por defecto: v18.0)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL del Servidor (Opcional)</label>
                    <input type="text" id="whatsappServerURL" class="form-input" 
                           placeholder="https://api.checkin24hs.com">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Si tienes un servidor con endpoint de WhatsApp, ingresa su URL aqu√≠
                    </small>
                </div>
                
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Para obtener tus credenciales de WhatsApp Business API, visita 
                        <a href="https://developers.facebook.com/docs/whatsapp/cloud-api/get-started" target="_blank" style="color: #1976d2;">Facebook Developers</a>
                    </p>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="form-button secondary" onclick="closeWhatsAppConfig()">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #25d366; color: white;">
                        Guardar Configuraci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div>
    <!-- Fin del contenido del Dashboard -->

    <script>
        // ============================================
        // CAMPOS DE IMAGEN - AHORA SON NECESARIOS, NO ELIMINAR
        // ============================================
        // NOTA: Este script anteriormente eliminaba los campos de imagen cada 100ms
        // Ahora los campos son necesarios para subir fotos reales desde el disco duro
        // Por lo tanto, este script est√° COMPLETAMENTE DESACTIVADO
        console.log('‚úÖ Script de eliminaci√≥n de campos de imagen DESACTIVADO');
        console.log('‚úÖ Los campos de imagen ahora son necesarios y se preservar√°n');
        
        // Funci√≥n vac√≠a para evitar errores si algo intenta llamarla
        (function preservarCamposImagen() {
            // Esta funci√≥n ya no hace nada - los campos se preservan
            // No hay setInterval, no hay MutationObserver, no hay eliminaci√≥n
            console.log('‚úÖ Campos de imagen preservados - script desactivado');
        })();
        
        // ============================================
        // SOLUCI√ìN INMEDIATA PARA MODAL DE IM√ÅGENES
        // ============================================
        // Esta funci√≥n se ejecuta inmediatamente y sobrescribe cualquier funci√≥n en cach√©
        (function() {
            window.abrirModalImagenesDirecto = function(mode) {
                console.log('üöÄ ABRIENDO MODAL DIRECTO - Modo:', mode);
                const modal = document.getElementById('imageManagerModal');
                if (!modal) {
                    console.error('‚ùå Modal no encontrado');
                    alert('Error: Modal no encontrado. Recarga la p√°gina.');
                    return;
                }
                modal.style.display = 'block';
                modal.style.zIndex = '10000';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                console.log('‚úÖ Modal abierto directamente');
                
                // Configurar nombre del hotel
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    if (nameInput && nameInput.value) {
                        hotelNameSpan.textContent = nameInput.value;
                    } else {
                        hotelNameSpan.textContent = 'Nuevo Hotel';
                    }
                }
            };
            console.log('‚úÖ Funci√≥n abrirModalImagenesDirecto disponible globalmente');
        })();

        // ============================================
        // SISTEMA DE AUTENTICACI√ìN - EJECUTAR PRIMERO
        // ============================================
        console.log('üîê Script de autenticaci√≥n cargado');
        
        // IMPORTANTE: Ocultar dashboard y mostrar login por defecto INMEDIATAMENTE
        (function() {
            function hideDashboardAndShowLogin() {
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                const body = document.body;
                
                if (dashboardContent) {
                    dashboardContent.classList.remove('authenticated');
                }
                if (loginContainer) {
                    loginContainer.classList.remove('hidden');
                }
                if (body) {
                    body.classList.remove('authenticated');
                }
            }
            
            // Ejecutar inmediatamente si el DOM est√° listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideDashboardAndShowLogin);
            } else {
                hideDashboardAndShowLogin();
            }
        })();
        
        // Sistema de gesti√≥n de usuarios administradores
        // Inicializar usuarios administradores en localStorage si no existen
        function initAdminUsers() {
            const storedUsers = localStorage.getItem('dashboard_admin_users');
            if (!storedUsers) {
                const defaultUsers = [
                    {
                        id: 'admin-001',
                        username: 'admin',
                        password: 'admin123',
                        password_hash: 'admin123',
                        name: 'Administrador',
                        role: 'admin_total', // admin_total o usuario
                        email: 'admin@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    },
                    {
                        id: 'admin-002',
                        username: 'German',
                        password: '123456',
                        password_hash: '123456',
                        name: 'German Perez',
                        role: 'admin_total',
                        email: 'german@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    },
                    {
                        id: 'admin-003',
                        username: 'Axel',
                        password: '123456',
                        password_hash: '123456',
                        name: 'Axel',
                        role: 'admin_total',
                        email: 'axel@checkin24hs.com',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    }
                ];
                localStorage.setItem('dashboard_admin_users', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return JSON.parse(storedUsers);
        }

        // Obtener todos los usuarios administradores
        function getAdminUsers() {
            return JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
        }

        // Guardar usuarios administradores
        function saveAdminUsers(users) {
            localStorage.setItem('dashboard_admin_users', JSON.stringify(users));
        }

        // Inicializar usuarios al cargar
        initAdminUsers();

        // Verificar si hay sesi√≥n activa al cargar la p√°gina
        function checkAuthStatus() {
            console.log('üîê Verificando autenticaci√≥n...');
            
            // Primero, asegurar que el dashboard est√© oculto y el login visible
            const dashboardContent = document.getElementById('dashboardContent');
            const loginContainer = document.getElementById('loginContainer');
            
            if (!dashboardContent || !loginContainer) {
                console.error('‚ùå Elementos de autenticaci√≥n no encontrados');
                return false;
            }
            
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    // Verificar si la sesi√≥n no ha expirado (24 horas)
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        console.log('‚úÖ Sesi√≥n v√°lida encontrada para:', session.username);
                        showDashboard();
                        return true;
                    } else {
                        // Sesi√≥n expirada
                        console.log('‚è∞ Sesi√≥n expirada, eliminando...');
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    console.error('‚ùå Error al verificar sesi√≥n:', e);
                    localStorage.removeItem('dashboard_auth_session');
                }
            } else {
                console.log('üîì No hay sesi√≥n activa');
            }
            
            // No hay sesi√≥n v√°lida, mostrar login
            showLogin();
            return false;
        }

        // Mostrar pantalla de login
        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.remove('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.remove('authenticated');
            }
            if (body) {
                body.classList.remove('authenticated');
            }
        }

        // Mostrar dashboard
        function showDashboard() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContent = document.getElementById('dashboardContent');
            const body = document.body;
            
            if (loginContainer) {
                loginContainer.classList.add('hidden');
            }
            if (dashboardContent) {
                dashboardContent.classList.add('authenticated');
            }
            if (body) {
                body.classList.add('authenticated');
            }
            
            // Inicializar sincronizaci√≥n en tiempo real despu√©s de un peque√±o delay
            setTimeout(() => {
                if (typeof initRealtimeSubscriptions === 'function') {
                    initRealtimeSubscriptions();
                }
            }, 1000);
        }

        // Manejar el login
        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            console.log('üîê Intentando iniciar sesi√≥n...');
            
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            if (!usernameInput || !passwordInput || !errorDiv || !loginButton) {
                console.error('‚ùå Elementos del formulario no encontrados');
                return;
            }
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            // Limpiar error anterior
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
            
            // Validar que los campos no est√©n vac√≠os
            if (!username || !password) {
                showError('Por favor, completa todos los campos');
                return;
            }
            
            // Deshabilitar bot√≥n mientras se procesa
            loginButton.disabled = true;
            loginButton.textContent = 'Iniciando sesi√≥n...';
            
            // Autenticaci√≥n - buscar en localStorage y Supabase
            setTimeout(async () => {
                let user = null;
                
                // Primero buscar en localStorage
                const adminUsers = getAdminUsers();
                user = adminUsers.find(u => 
                    u.username.toLowerCase() === username.toLowerCase() && 
                    (u.password === password || u.password_hash === password) &&
                    u.status === 'active'
                );
                
                // Si no se encontr√≥ en localStorage, buscar en Supabase
                if (!user && window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        console.log('üîç Buscando usuario en Supabase...');
                        const admins = await window.supabaseClient.getAdmins();
                        user = admins.find(u => 
                            u.username.toLowerCase() === username.toLowerCase() && 
                            (u.password === password || u.password_hash === password) &&
                            u.status === 'active'
                        );
                        if (user) {
                            console.log('‚úÖ Usuario encontrado en Supabase');
                            // Sincronizar con localStorage
                            localStorage.setItem('dashboard_admin_users', JSON.stringify(admins));
                        }
                    } catch (error) {
                        console.error('Error consultando Supabase:', error);
                    }
                }
                
                if (user) {
                    // Actualizar √∫ltimo login
                    user.lastLogin = new Date().toISOString();
                    saveAdminUsers(adminUsers);
                    
                    // Login exitoso
                    const session = {
                        username: user.username,
                        name: user.name,
                        role: user.role,
                        userId: user.id,
                        loginTime: Date.now(),
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
                    };
                    
                    localStorage.setItem('dashboard_auth_session', JSON.stringify(session));
                    
                    // Limpiar formulario
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.reset();
                    }
                    
                    // Mostrar dashboard
                    showDashboard();
                    
                    // Actualizar nombre de usuario en el dropdown
                    updateUserMenu(user.name, user.role);
                    
                    // Actualizar visibilidad del men√∫ de administradores
                    setTimeout(() => {
                        if (typeof updateAdminMenuVisibility === 'function') {
                            updateAdminMenuVisibility();
                        }
                    }, 100);
                    
                    // Inicializar dashboard si no est√° inicializado
                    if (typeof initializeDashboard === 'function') {
                        initializeDashboard();
                    }
                    if (typeof setupAutoSync === 'function') {
                        setupAutoSync();
                    }
                    
                    console.log('‚úÖ Login exitoso:', user.username, 'Rol:', user.role);
                } else {
                    // Credenciales incorrectas
                    console.log('‚ùå Credenciales incorrectas');
                    showError('Usuario o contrase√±a incorrectos');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
                
                // Rehabilitar bot√≥n
                loginButton.disabled = false;
                loginButton.textContent = 'Iniciar Sesi√≥n';
            }, 500);
        }

        // Mostrar error de login
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Toggle visibilidad de contrase√±a
        function togglePasswordVisibility(event) {
            const passwordInput = document.getElementById('loginPassword');
            if (!passwordInput) return;
            
            const icon = event ? event.target : document.querySelector('#loginPassword + .input-icon');
            if (!icon) return;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.textContent = 'visibility_off';
            } else {
                passwordInput.type = 'password';
                icon.textContent = 'visibility';
            }
        }

        // Actualizar men√∫ de usuario
        function updateUserMenu(userName, userRole) {
            const userNameElement = document.querySelector('.user-dropdown .dropdown-item:first-child');
            if (userNameElement) {
                const roleText = userRole === 'admin_total' ? 'Administrador Total' : 'Usuario';
                userNameElement.innerHTML = `<span class="material-icons">person</span>${userName} (${roleText})`;
            }
        }

        // Verificar si el usuario actual es admin_total
        function isAdminTotal() {
            const session = localStorage.getItem('dashboard_auth_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    return sessionData.role === 'admin_total';
                } catch (e) {
                    return false;
                }
            }
            return false;
        }

        // Funci√≥n de logout mejorada
        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('dashboard_auth_session');
                
                // Limpiar formulario
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.reset();
                }
                
                // Ocultar dropdown de usuario
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                // Mostrar login y ocultar dashboard
                showLogin();
                
                console.log('üëã Sesi√≥n cerrada');
            }
        }

        // ============================================
        // FIN SISTEMA DE AUTENTICACI√ìN
        // ============================================

        // Variables globales
        let currentSection = 'dashboard';
        let expensesCharts = {
            composition: null,
            variable: null,
            budget: null
        };
        
        // Funci√≥n global para evitar errores de referencia
        window.showSection = function(section, event) {
            console.log('üîÑ Cambiando a secci√≥n:', section);
            
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });

            // Mostrar la secci√≥n seleccionada
            const targetSection = document.getElementById(section + '-section');
            
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log('‚úÖ Secci√≥n mostrada:', section);
            } else {
                console.error('‚ùå Secci√≥n no encontrada:', section + '-section');
            }

            // Actualizar men√∫ activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Solo actualizar el men√∫ activo si se proporciona el evento
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si no hay evento, buscar el elemento del men√∫ correspondiente
                const menuItem = document.querySelector(`[onclick*="window.showSection('${section}')"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            }

            currentSection = section;
            
            // Cargar datos espec√≠ficos seg√∫n la secci√≥n
            if (section === 'users') {
                setTimeout(() => {
                    if (typeof loadUsersData === 'function') {
                        loadUsersData();
                    }
                }, 100);
            }
            
            if (section === 'administrators') {
                setTimeout(() => {
                    if (typeof loadAdminsTable === 'function') {
                        loadAdminsTable();
                    }
                    if (typeof updateAdminMenuVisibility === 'function') {
                        updateAdminMenuVisibility();
                    }
                }, 100);
            }
            
            if (section === 'hotels') {
                setTimeout(() => {
                    if (typeof loadHotelsTable === 'function') {
                        loadHotelsTable();
                    }
                }, 100);
            }
            
            if (section === 'expenses') {
                setTimeout(() => {
                    if (typeof loadExpensesData === 'function') {
                        loadExpensesData();
                    }
                }, 100);
            }
            
            if (section === 'agents') {
                setTimeout(() => {
                    if (typeof loadAgentsTable === 'function') {
                        loadAgentsTable();
                    }
                }, 100);
            }
            
            if (section === 'reservations') {
                setTimeout(() => {
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                }, 100);
            }
            
            if (section === 'dashboard') {
                setTimeout(() => {
                    if (typeof loadHotelsForMonthlySalesFilter === 'function') {
                        loadHotelsForMonthlySalesFilter();
                    }
                    if (typeof loadMonthlySales === 'function') {
                        loadMonthlySales();
                    }
                    if (typeof loadExpenseCategoriesForFilter === 'function') {
                        loadExpenseCategoriesForFilter();
                    }
                    if (typeof loadMonthlyExpenses === 'function') {
                        loadMonthlyExpenses();
                    }
                    if (typeof updateStats === 'function') {
                        updateStats();
                    }
                }, 100);
            }
        };

        // Funci√≥n para cerrar modal de edici√≥n de hoteles
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para cerrar modal de vista previa de im√°genes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para toggle del men√∫ de usuario
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Funci√≥n para toggle del sidebar en m√≥vil
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        // Funci√≥n de logout (reemplazada por la nueva implementaci√≥n arriba)

        // Cerrar dropdown cuando se hace clic fuera
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            
            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Cerrar sidebar en m√≥vil cuando se hace clic en un enlace
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('open');
                    }
                }
            });
        });

        // Datos de hoteles (sistema limpio)
        const hotels = [];

        // Funci√≥n para generar estrellas
        function getStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="material-icons rating-stars">star</span>';
                } else if (i - 0.5 <= rating) {
                    stars += '<span class="material-icons rating-stars">star_half</span>';
                } else {
                    stars += '<span class="material-icons" style="color: #e0e0e0;">star</span>';
                }
            }
            return stars;
        }

        // Funci√≥n para cargar hoteles en la tabla
        async function loadHotelsTable() {
            console.log('üîÑ Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('‚ùå Tbody de hoteles no encontrado');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`‚úÖ ${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('üíæ Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            console.log(`üìã Encontrados ${hotels.length} hoteles:`, hotels.map(h => h.name));
            
            tbody.innerHTML = '';

            if (hotels.length === 0) {
                // Mostrar mensaje si no hay hoteles
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-hotel" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">No hay hoteles registrados</h3>
                        <p style="margin-bottom: 20px; color: #666;">Comienza agregando tu primer hotel</p>
                        <button onclick="addNewHotel()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Agregar Primer Hotel
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price || 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status?.toLowerCase() || 'activo'}">${hotel.status || 'Activo'}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="viewHotel('${hotel.id}')" class="action-btn view" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Tabla de hoteles cargada con ${hotels.length} hoteles`);
        }

        // Funci√≥n para actualizar estad√≠sticas del dashboard
        function updateStats() {
            console.log('üìä Actualizando estad√≠sticas del dashboard...');
            
            // Actualizar Total Hoteles (solo activos)
            const dashboardTotalHotelsElement = document.getElementById('dashboardTotalHotels');
            if (dashboardTotalHotelsElement) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                // Contar solo hoteles activos (considera tanto is_active como status)
                const activeHotels = hotels.filter(hotel => {
                    // Un hotel est√° activo si:
                    // - is_active es true (o undefined/null, se considera activo por defecto)
                    // - O status es 'Activo' (o undefined/null, se considera activo por defecto)
                    const isActiveBool = hotel.is_active !== false; // true, undefined, null = activo
                    const isActiveStatus = hotel.status !== 'Inactivo'; // 'Activo', undefined, null = activo
                    return isActiveBool && isActiveStatus;
                });
                dashboardTotalHotelsElement.textContent = activeHotels.length;
                
                // Actualizar el mensaje de tendencia
                const trendElement = dashboardTotalHotelsElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (activeHotels.length > 0) {
                        trendElement.innerHTML = '<span class="material-icons">trending_up</span> Hoteles activos';
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">info</span> Sin datos disponibles';
                    }
                }
                
                console.log(`‚úÖ Total Hoteles actualizado: ${activeHotels.length} hoteles activos`);
            }
            
            // Actualizar tarjeta de Ingresos del Mes Vigente
            const dashboardMonthlySalesElement = document.getElementById('dashboardMonthlySales');
            const dashboardMonthlyReservationsElement = document.getElementById('dashboardMonthlyReservations');
            if (dashboardMonthlySalesElement && dashboardMonthlyReservationsElement) {
                // Calcular acumulado de ventas del mes vigente
                const monthlyAccumulated = calculateMonthlySalesAccumulated();
                const formattedAmount = monthlyAccumulated.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Mostrar el acumulado de ventas como n√∫mero principal
                dashboardMonthlySalesElement.textContent = `$${formattedAmount}`;
                
                // Calcular cantidad de reservas acumuladas en el mes vigente
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                const monthlyReservations = reservations.filter(reservation => {
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const checkInDate = reservation.checkIn || reservation.check_in;
                    
                    if (!checkInDate || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                        return false;
                    }
                    
                    let dateStr = checkInDate;
                    if (dateStr.includes('T')) {
                        dateStr = dateStr.split('T')[0];
                    }
                    
                    const dateParts = dateStr.split('-');
                    if (dateParts.length !== 3) {
                        return false;
                    }
                    
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]);
                    
                    return year === currentYear && month === currentMonth;
                });
                
                const reservationsCount = monthlyReservations.length;
                const reservationsTotal = monthlyReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                const formattedReservationsTotal = reservationsTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                if (reservationsCount > 0) {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">trending_up</span> Cantidad de reservas Acumuladas en el mes: ${reservationsCount}`;
                } else {
                    dashboardMonthlyReservationsElement.innerHTML = `<span class="material-icons">info</span> Sin reservas este mes`;
                }
                
                console.log(`‚úÖ Tarjeta de Ingresos del Mes Vigente actualizada: Acumulado: $${formattedAmount}, Reservas: ${reservationsCount}, Sumatoria: $${formattedReservationsTotal}`);
            }
            
            // Actualizar Sumatoria de Reservas Futuras
            const futureReservationsTotalElement = document.getElementById('futureReservationsTotal');
            if (futureReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Funci√≥n auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no est√©n canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const rawCheckIn = reservation.checkIn || reservation.check_in;
                    if (!rawCheckIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(rawCheckIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                // Calcular sumatoria de reservas futuras
                const futureTotal = futureReservations.reduce((sum, res) => {
                    const amount = parseFloat(res.totalAmount) || 
                                 parseFloat(res.total_amount) || 
                                 parseFloat(res.amount) || 
                                 parseFloat(res.price) || 0;
                    return sum + amount;
                }, 0);
                
                // Formatear el total
                futureReservationsTotalElement.textContent = `$${futureTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                console.log(`‚úÖ Sumatoria de Reservas Futuras actualizada: $${futureTotal.toLocaleString('es-AR')} (${futureReservations.length} reservas)`);
            }
            
            // Actualizar Ingresos de Hoy
            const todayReservationsTotalElement = document.getElementById('todayReservationsTotal');
            if (todayReservationsTotalElement) {
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                console.log('üîç Calculando Ingresos de Hoy...');
                console.log(`üìä Total de reservas en BD: ${reservations.length}`);
                
                // Mostrar muestra de las primeras 3 reservas para entender la estructura
                if (reservations.length > 0) {
                    console.log('üìã Muestra de estructura de reservas (primeras 3):');
                    reservations.slice(0, 3).forEach((r, index) => {
                        console.log(`  Reserva ${index + 1} (${r.reservationCode || r.id}):`);
                        console.log(`    - id: ${r.id}`);
                        console.log(`    - code: ${r.reservationCode}`);
                        console.log(`    - createdAt: ${r.createdAt || 'NO EXISTE'}`);
                        console.log(`    - created_at: ${r.created_at || 'NO EXISTE'}`);
                        console.log(`    - updatedAt: ${r.updatedAt || 'NO EXISTE'}`);
                        console.log(`    - updated_at: ${r.updated_at || 'NO EXISTE'}`);
                        console.log(`    - reservationDate: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`    - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`    - status: ${r.status || 'NO EXISTE'}`);
                        console.log('');
                    });
                }
                
                // Obtener la fecha de hoy en formato YYYY-MM-DD usando fecha LOCAL (no UTC)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                console.log(`üìÖ Fecha de hoy (LOCAL): ${todayStr}`);
                console.log(`üìÖ Fecha de hoy (UTC): ${today.toISOString().split('T')[0]}`);
                
                // Funci√≥n auxiliar para normalizar fecha a YYYY-MM-DD usando fecha LOCAL
                const normalizeDate = (dateValue) => {
                    if (!dateValue) return null;
                    
                    let dateStr = dateValue;
                    let date;
                    
                    // Si es un objeto Date, usar directamente
                    if (dateStr instanceof Date) {
                        date = dateStr;
                    }
                    // Si es un string, intentar parsearlo
                    else if (typeof dateStr === 'string') {
                        // Si ya est√° en formato YYYY-MM-DD, retornarlo directamente
                        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            return dateStr;
                        }
                        // Si incluye hora (formato ISO), parsearlo
                        else if (dateStr.includes('T')) {
                            date = new Date(dateStr);
                        }
                        // Intentar parsear cualquier otro formato
                        else {
                            date = new Date(dateStr);
                        }
                    } else {
                        return null;
                    }
                    
                    // Si no se pudo parsear, retornar null
                    if (!date || isNaN(date.getTime())) {
                        return null;
                    }
                    
                    // Convertir a fecha LOCAL (no UTC) en formato YYYY-MM-DD
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Mostrar muestra de las primeras 5 reservas para depuraci√≥n
                console.log('üîç Muestra de reservas (primeras 5):', reservations.slice(0, 5).map(r => ({
                    id: r.id,
                    code: r.reservationCode,
                    createdAt: r.createdAt || r.created_at,
                    updatedAt: r.updatedAt || r.updated_at,
                    reservationDate: r.reservationDate,
                    totalAmount: r.totalAmount,
                    status: r.status
                })));
                
                // Filtrar reservas que tienen checkIn de HOY (fecha de entrada)
                const todayReservations = reservations.filter(reservation => {
                    // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                    const rawCheckIn = reservation.checkIn || reservation.check_in;
                    const checkIn = normalizeDate(rawCheckIn);
                    const checkInToday = checkIn !== null && checkIn === todayStr;
                    
                    // Incluir solo si tiene checkIn de HOY
                    const isToday = checkInToday;
                    
                    if (isToday) {
                        console.log(`‚úÖ Reserva de hoy encontrada (checkIn hoy):`, {
                            id: reservation.id,
                            code: reservation.reservationCode || reservation.reservation_code,
                            checkIn: rawCheckIn,
                            checkInNormalizado: checkIn,
                            totalAmount: reservation.totalAmount || reservation.total_amount,
                            status: reservation.status
                        });
                    }
                    
                    return isToday;
                });
                
                console.log(`üìä Reservas encontradas para hoy: ${todayReservations.length}`);
                
                // Buscar espec√≠ficamente la reserva VRETNG si existe
                const vretngReservation = reservations.find(r => r.reservationCode === 'VRETNG');
                if (vretngReservation) {
                    console.log('üîç RESERVA VRETNG ENCONTRADA:');
                    const vretngCheckIn = normalizeDate(vretngReservation.checkIn);
                    console.log(`  - checkIn original: ${vretngReservation.checkIn || 'NO EXISTE'}`);
                    console.log(`  - checkIn normalizado: ${vretngCheckIn || 'null'}`);
                    console.log(`  - Fecha de hoy: ${todayStr}`);
                    console.log(`  - totalAmount: ${vretngReservation.totalAmount || 'NO EXISTE'}`);
                    console.log(`  - status: ${vretngReservation.status || 'NO EXISTE'}`);
                    console.log(`  - ¬øcheckIn coincide con hoy?: ${vretngCheckIn === todayStr ? 'S√ç' : 'NO'}`);
                    console.log(`  - ¬øEst√° en todayReservations?: ${todayReservations.some(r => r.reservationCode === 'VRETNG') ? 'S√ç' : 'NO'}`);
                } else {
                    console.log('‚ö†Ô∏è Reserva VRETNG NO ENCONTRADA en la base de datos');
                }
                
                // Si no se encontraron reservas, mostrar algunas fechas cercanas para depuraci√≥n
                if (todayReservations.length === 0 && reservations.length > 0) {
                    console.log('‚ö†Ô∏è No se encontraron reservas para hoy. Mostrando fechas de las √∫ltimas 10 reservas:');
                    const recentReservations = reservations.slice(-10).reverse();
                    recentReservations.forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt original: ${r.createdAt || r.created_at || 'NO EXISTE'}`);
                        console.log(`     - createdAt normalizado: ${createdAt || 'null'}`);
                        console.log(`     - updatedAt original: ${r.updatedAt || r.updated_at || 'NO EXISTE'}`);
                        console.log(`     - updatedAt normalizado: ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate original: ${r.reservationDate || 'NO EXISTE'}`);
                        console.log(`     - reservationDate normalizado: ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log(`     - totalAmount: ${r.totalAmount || 'NO EXISTE'}`);
                        console.log(`     - status: ${r.status || 'NO EXISTE'}`);
                        console.log(`     - ¬øCoincide con hoy?: ${createdAt === todayStr || updatedAt === todayStr || reservationDate === todayStr ? 'S√ç' : 'NO'}`);
                        console.log('');
                    });
                    
                    // Tambi√©n mostrar las primeras 5 reservas
                    console.log('üìã Muestra de las primeras 5 reservas:');
                    reservations.slice(0, 5).forEach((r, index) => {
                        const createdAt = normalizeDate(r.createdAt || r.created_at);
                        const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                        const reservationDate = normalizeDate(r.reservationDate);
                        console.log(`  ${index + 1}. Reserva ${r.reservationCode || r.id}:`);
                        console.log(`     - createdAt: ${r.createdAt || r.created_at || 'NO EXISTE'} ‚Üí ${createdAt || 'null'}`);
                        console.log(`     - updatedAt: ${r.updatedAt || r.updated_at || 'NO EXISTE'} ‚Üí ${updatedAt || 'null'}`);
                        console.log(`     - reservationDate: ${r.reservationDate || 'NO EXISTE'} ‚Üí ${reservationDate || 'null'}`);
                        console.log(`     - Fecha de hoy: ${todayStr}`);
                        console.log('');
                    });
                }
                
                // Calcular el total de ingresos de hoy
                // Solo contar reservas que no est√©n canceladas (Confirmadas o Modificadas)
                const todayTotal = todayReservations
                    .filter(res => {
                        const status = res.status || '';
                        const isNotCanceled = status !== 'Cancelada' && status !== 'cancelada';
                        if (!isNotCanceled) {
                            console.log(`‚ö†Ô∏è Reserva cancelada excluida: ${res.reservationCode} - $${res.totalAmount}`);
                        }
                        return isNotCanceled;
                    })
                    .reduce((sum, res) => {
                        // Intentar obtener el monto de diferentes campos posibles
                        const amount = parseFloat(res.totalAmount) || 
                                     parseFloat(res.total_amount) || 
                                     parseFloat(res.amount) || 
                                     parseFloat(res.price) || 0;
                        
                        if (amount > 0) {
                            console.log(`üí∞ Sumando: $${amount} de reserva ${res.reservationCode || res.id}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Reserva sin monto: ${res.reservationCode || res.id}`, res);
                        }
                        
                        return sum + amount;
                    }, 0);
                
                // Contar reservas con checkIn de hoy
                const checkInToday = todayReservations.length;
                
                // Formatear el total con separador de miles
                todayReservationsTotalElement.textContent = `$${todayTotal.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                // Actualizar el mensaje de tendencia
                const trendElement = todayReservationsTotalElement.closest('.stat-card')?.querySelector('.stat-trend');
                if (trendElement) {
                    if (todayReservations.length > 0) {
                        trendElement.innerHTML = `<span class="material-icons">today</span> ${todayReservations.length} reserva(s) con check-in hoy`;
                    } else {
                        trendElement.innerHTML = '<span class="material-icons">today</span> Sin reservas con check-in hoy';
                    }
                }
                
                console.log(`‚úÖ Ingresos de Hoy actualizado: $${todayTotal.toLocaleString('es-AR')} (${checkInToday} reserva(s) con check-in hoy)`);
                console.log('üìä Detalle completo de reservas de hoy:', todayReservations.map(r => {
                    const createdAt = normalizeDate(r.createdAt || r.created_at);
                    const updatedAt = normalizeDate(r.updatedAt || r.updated_at);
                    const reservationDate = normalizeDate(r.reservationDate);
                    return {
                        id: r.id,
                        code: r.reservationCode,
                        createdAt: r.createdAt || r.created_at,
                        updatedAt: r.updatedAt || r.updated_at,
                        reservationDate: r.reservationDate,
                        totalAmount: r.totalAmount,
                        status: r.status,
                        normalizedDates: { createdAt, updatedAt, reservationDate }
                    };
                }));
            } else {
                console.warn('‚ö†Ô∏è No se encontr√≥ el elemento todayReservationsTotal');
            }
        }



        // Funci√≥n para editar hotel
        async function editHotel(hotelId) {
            console.log('‚úèÔ∏è Editando hotel:', hotelId);
            
            // Buscar hotel en Supabase primero
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                } catch (error) {
                    console.error('Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback a localStorage
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
            }
            
            if (!hotel) {
                alert('‚ùå Hotel no encontrado');
                return;
            }
            
            // Usar el modal principal en lugar del din√°mico
            const mainModal = document.getElementById('editHotelModal');
            if (mainModal) {
                // Cargar datos en el modal principal
                document.getElementById('editHotelModalTitle').textContent = '‚úèÔ∏è Editar Hotel';
                document.getElementById('editHotelName').value = hotel.name || '';
                document.getElementById('editHotelLocation').value = hotel.location || '';
                document.getElementById('editHotelGoogleMaps').value = hotel.googleMaps || hotel.google_maps || '';
                document.getElementById('editHotelWebsite').value = hotel.website || '';
                document.getElementById('editHotelRating').value = hotel.rating || '';
                document.getElementById('editHotelPrice').value = hotel.price || '';
                document.getElementById('editHotelDescription').value = hotel.description || '';
                document.getElementById('editHotelAmenities').value = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : (hotel.amenities || '');
                document.getElementById('editHotelStatus').value = hotel.status || 'Activo';
                document.getElementById('editHotelImage').value = hotel.mainImage || hotel.images?.[0] || '';
                
                // Cargar campos de Flor IA (soportar ambos formatos: camelCase y snake_case)
                const florInfo = hotel.florInfo || hotel.flor_info || {};
                document.getElementById('editHotelFlorDescription').value = florInfo.description || '';
                document.getElementById('editHotelFlorServices').value = florInfo.services || '';
                document.getElementById('editHotelFlorExcursions').value = florInfo.excursions || '';
                document.getElementById('editHotelFlorPrices').value = florInfo.prices || '';
                document.getElementById('editHotelFlorPolicies').value = florInfo.policies || '';
                document.getElementById('editHotelFlorTransport').value = florInfo.transport || '';
                document.getElementById('editHotelFlorContact').value = florInfo.contact || '';
                
                console.log('üìã Datos cargados del hotel:', {
                    name: hotel.name,
                    florInfo: florInfo,
                    hotelId: hotelId
                });
                
                // Configurar el modo de edici√≥n
                const form = document.getElementById('editHotelForm');
                form.dataset.mode = 'edit';
                form.dataset.hotelId = hotelId;
                
                // Actualizar vista previa de imagen
                const previewContainer = document.getElementById('editImagePreview');
                if (previewContainer && (hotel.mainImage || hotel.images?.[0])) {
                    previewContainer.innerHTML = `<img src="${hotel.mainImage || hotel.images?.[0]}" style="max-width: 150px; max-height: 100px; border-radius: 8px;">`;
                }
                
                // Mostrar modal
                mainModal.style.display = 'block';
                console.log('‚úÖ Modal de edici√≥n abierto para:', hotel.name);
                return;
            }
            
            // Fallback: Crear modal din√°mico si no existe el principal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editHotelModalDynamic';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            const hotelName = hotel.name || hotel.hotel_name || '';
            const hotelLocation = hotel.location || hotel.address || '';
            const hotelPrice = hotel.price || hotel.base_price || '';
            const hotelRating = hotel.rating || hotel.stars || 0;
            const hotelStatus = hotel.status || 'Activo';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 500px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">‚úèÔ∏è Editar Hotel</h2>
                        <button onclick="document.getElementById('editHotelModalDynamic').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <form id="editHotelForm" onsubmit="saveHotelChanges(event, '${hotelId}')">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del Hotel *</label>
                            <input type="text" id="editHotelName" value="${hotelName}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Ubicaci√≥n</label>
                            <input type="text" id="editHotelLocation" value="${hotelLocation}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Precio Base (USD)</label>
                            <input type="number" id="editHotelPrice" value="${hotelPrice}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Calificaci√≥n (1-5)</label>
                            <input type="number" id="editHotelRating" value="${hotelRating}" min="0" max="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado</label>
                            <select id="editHotelStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Activo" ${hotelStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                <option value="Inactivo" ${hotelStatus === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="document.getElementById('editHotelModalDynamic').remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            <button type="submit" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }
        
        async function saveHotelChanges(event, hotelId) {
            event.preventDefault();
            
            const updates = {
                name: document.getElementById('editHotelName').value,
                location: document.getElementById('editHotelLocation').value,
                price: parseFloat(document.getElementById('editHotelPrice').value) || 0,
                rating: parseInt(document.getElementById('editHotelRating').value) || 0,
                status: document.getElementById('editHotelStatus').value,
                updated_at: new Date().toISOString()
            };
            
            console.log('üíæ Guardando cambios del hotel:', hotelId, updates);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateHotel(hotelId, updates);
                    console.log('‚úÖ Hotel actualizado en Supabase');
                    alert('‚úÖ Hotel actualizado correctamente');
                    document.getElementById('editHotelModalDynamic').remove();
                    loadHotelsTable();
                    return;
                }
            } catch (error) {
                console.error('Error actualizando hotel:', error);
            }
            
            // Fallback localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const index = hotels.findIndex(h => h.id === hotelId || h.id == hotelId);
            if (index !== -1) {
                hotels[index] = { ...hotels[index], ...updates };
                localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                alert('‚úÖ Hotel actualizado correctamente');
                document.getElementById('editHotelModalDynamic').remove();
                loadHotelsTable();
            }
        }

        // Funci√≥n para cerrar modal de edici√≥n
        function closeEditModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para eliminar imagen principal
        function deleteMainImage() {
            const imageInput = document.getElementById('editHotelImage');
            if (imageInput) imageInput.value = '';
            
            const mainImageFileInput = document.getElementById('mainImageFileInput');
            if (mainImageFileInput) mainImageFileInput.value = '';
            
            updateImagePreview();
            console.log('üóëÔ∏è Imagen principal eliminada');
        }
        
        // Funci√≥n para actualizar vista previa de imagen
        function updateImagePreview() {
            const imageInput = document.getElementById('editHotelImage');
            const previewContainer = document.getElementById('editImagePreview');
            
            if (!imageInput || !previewContainer) {
                return;
            }
            
            const imagePath = imageInput.value.trim();
            
            if (imagePath) {
                const isUrl = !imagePath.startsWith('data:');
                previewContainer.innerHTML = `
                    <div style="border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: #f9f9f9; position: relative;">
                        <button type="button" onclick="deleteMainImage()" 
                                style="position: absolute; top: 5px; right: 5px; background: #d32f2f; color: white; border: none; 
                                       border-radius: 50%; width: 30px; height: 30px; cursor: pointer; z-index: 10; 
                                       display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"
                                title="Eliminar imagen principal">
                            <span class="material-icons" style="font-size: 18px;">close</span>
                        </button>
                        <img src="${imagePath}" alt="Vista previa" 
                             style="max-width: 100%; max-height: 300px; border-radius: 4px; display: block; margin: 0 auto;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; text-align: center; color: #999; padding: 20px;">
                            <span class="material-icons" style="font-size: 48px;">broken_image</span>
                            <p>No se pudo cargar la imagen</p>
                        </div>
                        ${isUrl ? '<div style="text-align: center; margin-top: 8px; font-size: 12px; color: #4caf50;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">link</span> URL Externa</div>' : ''}
                    </div>
                `;
            } else {
                previewContainer.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">Sin imagen principal - Selecciona una imagen</p>';
            }
        }

        // Funci√≥n para actualizar vista previa de fotos (ELIMINADA - campo de galer√≠a removido)
        // Funci√≥n auxiliar para leer im√°genes del campo (compatible con ||| y comas)
        function getGalleryImagesFromInput() {
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput || !photosInput.value) {
                return [];
            }
            
            const photosValue = photosInput.value.trim();
            // Intentar primero con ||| (nuevo formato), luego con comas (formato antiguo)
            if (photosValue.includes('|||')) {
                return photosValue.split('|||').map(p => p.trim()).filter(p => p);
            } else {
                // Para formato antiguo con comas, ser m√°s inteligente con base64
                if (photosValue.includes('data:image')) {
                    const dataImageRegex = /data:image\/[^;]+;base64,[^,]+(?:,|$)/g;
                    const matches = photosValue.match(dataImageRegex);
                    if (matches) {
                        return matches.map(m => m.replace(/,$/, '').trim()).filter(p => p);
                    }
                }
                return photosValue.split(',').map(p => p.trim()).filter(p => p);
            }
        }
        
        // Funci√≥n para eliminar una foto de la galer√≠a por √≠ndice
        function deleteGalleryPhoto(index) {
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput) return;
            
            const photoPaths = getGalleryImagesFromInput();
            photoPaths.splice(index, 1); // Eliminar la foto en el √≠ndice indicado
            
            // Actualizar el input con las fotos restantes
            photosInput.value = photoPaths.join('|||');
            
            // Refrescar la vista previa
            updatePhotosPreview();
            console.log(`üóëÔ∏è Foto ${index + 1} eliminada de la galer√≠a. Quedan ${photoPaths.length} fotos.`);
        }
        
        // Funci√≥n para limpiar toda la galer√≠a
        function clearAllGalleryPhotos() {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar TODAS las fotos de la galer√≠a?')) {
                return;
            }
            
            const photosInput = document.getElementById('editHotelPhotos');
            if (photosInput) photosInput.value = '';
            
            const galleryFileInput = document.getElementById('galleryImagesFileInput');
            if (galleryFileInput) galleryFileInput.value = '';
            
            updatePhotosPreview();
            console.log('üóëÔ∏è Galer√≠a de fotos vaciada completamente');
        }
        
        function updatePhotosPreview() {
            console.log('üñºÔ∏è updatePhotosPreview llamada');
            const photosInput = document.getElementById('editHotelPhotos');
            const previewContainer = document.getElementById('editPhotosPreview');
            
            if (!photosInput) {
                console.error('‚ùå Campo editHotelPhotos no encontrado');
                return;
            }
            
            if (!previewContainer) {
                console.error('‚ùå Contenedor editPhotosPreview no encontrado');
                return;
            }
            
            const photoPaths = getGalleryImagesFromInput();
            console.log(`üñºÔ∏è ${photoPaths.length} imagen(es) encontrada(s) para previsualizar`);
            
            previewContainer.innerHTML = '';
            
            if (photoPaths.length > 0) {
                // Agregar bot√≥n para limpiar toda la galer√≠a
                const clearAllBtn = document.createElement('button');
                clearAllBtn.type = 'button';
                clearAllBtn.onclick = clearAllGalleryPhotos;
                clearAllBtn.style.cssText = 'background: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 5px;';
                clearAllBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete_sweep</span> Eliminar todas las fotos';
                previewContainer.appendChild(clearAllBtn);
                
                // Contenedor para las fotos
                const photosWrapper = document.createElement('div');
                photosWrapper.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px;';
                
                photoPaths.forEach((photoPath, index) => {
                    const photoDiv = document.createElement('div');
                    photoDiv.style.cssText = 'position: relative; width: 150px; height: 150px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: #f0f0f0;';
                    
                    const isUrl = !photoPath.startsWith('data:');
                    const imgSrc = photoPath.trim();
                    
                    console.log(`üñºÔ∏è Creando preview ${index + 1}: ${isUrl ? 'URL' : 'Base64'} (${imgSrc.substring(0, 50)}...)`);
                    
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.alt = `Foto ${index + 1}`;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; display: block;';
                    img.onload = function() {
                        console.log(`‚úÖ Imagen ${index + 1} cargada correctamente`);
                    };
                    img.onerror = function() {
                        console.error(`‚ùå Error cargando imagen ${index + 1}`);
                        this.style.display = 'none';
                        const errorDiv = photoDiv.querySelector('.error-message');
                        if (errorDiv) errorDiv.style.display = 'flex';
                    };
                    
                    // Bot√≥n de eliminar para cada foto
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.onclick = () => deleteGalleryPhoto(index);
                    deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #d32f2f; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; z-index: 15; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);';
                    deleteBtn.title = 'Eliminar esta foto';
                    deleteBtn.innerHTML = '<span class="material-icons" style="font-size: 16px;">close</span>';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = 'display: none; width: 100%; height: 100%; background: #f0f0f0; align-items: center; justify-content: center; flex-direction: column; position: absolute; top: 0; left: 0;';
                    errorDiv.innerHTML = `
                        <span class="material-icons" style="font-size: 32px; color: #999;">broken_image</span>
                        <span style="font-size: 12px; color: #999;">Error</span>
                    `;
                    
                    const numberBadge = document.createElement('div');
                    numberBadge.style.cssText = 'position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; z-index: 10;';
                    numberBadge.textContent = index + 1;
                    
                    photoDiv.appendChild(img);
                    photoDiv.appendChild(errorDiv);
                    photoDiv.appendChild(numberBadge);
                    photoDiv.appendChild(deleteBtn);
                    
                    if (isUrl) {
                        const urlBadge = document.createElement('div');
                        urlBadge.style.cssText = 'position: absolute; bottom: 5px; right: 5px; background: rgba(33,150,243,0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 10;';
                        urlBadge.innerHTML = '<span class="material-icons" style="font-size: 12px; vertical-align: middle;">link</span>';
                        photoDiv.appendChild(urlBadge);
                    }
                    
                    photosWrapper.appendChild(photoDiv);
                });
                
                previewContainer.appendChild(photosWrapper);
            } else {
                previewContainer.innerHTML = '<p style="color: #999; text-align: center; font-size: 14px;">Sin fotos en la galer√≠a - Agrega fotos</p>';
            }
        }

        // Funci√≥n para guardar cambios del hotel
        function saveHotelChanges() {
            // Implementar l√≥gica para guardar cambios
            console.log('Guardando cambios del hotel...');
            closeEditHotelModal();
        }

        // Funci√≥n para sincronizar con index.html
        function syncWithIndexHtml() {
            // Implementar sincronizaci√≥n
            console.log('Sincronizando con index.html...');
        }

        // Funci√≥n simple para abrir modal directamente (sin cach√©)
        function abrirModalImagenesDirecto(mode) {
            console.log('üöÄ ABRIENDO MODAL DIRECTO - Modo:', mode);
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('‚ùå Modal no encontrado');
                alert('Error: Modal no encontrado. Recarga la p√°gina.');
                return;
            }
            
            // Abrir modal inmediatamente
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            console.log('‚úÖ Modal abierto directamente - Display:', modal.style.display);
            
            // Llamar a la funci√≥n completa despu√©s de abrir el modal
            if (typeof openImageManager === 'function') {
                setTimeout(() => openImageManager(mode), 100);
            } else {
                console.warn('‚ö†Ô∏è openImageManager no est√° disponible, configurando modal b√°sico...');
                // Configuraci√≥n b√°sica del modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    const nameInput = document.getElementById('editHotelName');
                    hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                }
            }
        }

        // Funci√≥n para abrir gestor de im√°genes
        function openImageManager(mode) {
            // Prevenir aperturas m√∫ltiples
            if (isImageManagerOpening) {
                console.log('‚ö†Ô∏è El gestor de im√°genes ya se est√° abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            
            if (!modal) {
                console.error('‚ùå ERROR: Modal no encontrado');
                alert('‚ùå Error: Modal no encontrado. Recarga la p√°gina.');
                return;
            }
            
            // Verificar si el modal ya est√° abierto
            if (modal.style.display === 'block' || window.getComputedStyle(modal).display === 'block') {
                console.log('‚ö†Ô∏è El gestor de im√°genes ya est√° abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('üìÅ ABRIENDO GESTOR DE IM√ÅGENES - MODO:', mode);
            
            console.log('‚úÖ Modal encontrado, abriendo...');
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            console.log('‚úÖ Modal abierto - Display:', modal.style.display);
            
            // Permitir nueva apertura despu√©s de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
            
            // AHORA configurar el resto
            try {
                
                // Intentar obtener hotelId de varias fuentes
                let hotelId = null;
                
                // 1. Intentar desde variable global
                if (typeof globalEditingHotelId !== 'undefined' && globalEditingHotelId) {
                    hotelId = globalEditingHotelId;
                    console.log('‚úÖ HotelId obtenido de variable global:', hotelId);
                }
                
                // 2. Intentar desde el formulario
                if (!hotelId) {
                    const form = document.getElementById('editHotelForm');
                    if (form && form.dataset && form.dataset.hotelId) {
                        hotelId = form.dataset.hotelId;
                        if (hotelId && hotelId !== 'null' && hotelId !== 'undefined') {
                            console.log('‚úÖ HotelId obtenido del formulario:', hotelId);
                        }
                    }
                }
                
                // 3. Si a√∫n no tenemos hotelId, intentar obtenerlo del nombre del hotel
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    try {
                        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            const hotel = hotels.find(h => h.name === nameInput.value);
                            if (hotel && hotel.id) {
                                hotelId = hotel.id;
                                console.log('‚úÖ HotelId obtenido por nombre del hotel:', hotelId);
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error buscando hotel por nombre:', error);
                    }
                }
                
                // 4. Si es un nuevo hotel, crear ID temporal
                if (!hotelId || hotelId === 'null' || hotelId === 'undefined') {
                    hotelId = 'new-hotel-' + Date.now();
                    console.log('‚ö†Ô∏è Usando ID temporal para nuevo hotel:', hotelId);
                }
                
                currentEditingHotelId = hotelId;
                currentImageManagerMode = mode || 'main';
                
                // Obtener datos del hotel (si existe)
                let hotelName = 'Nuevo Hotel';
                try {
                    const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                    const hotel = hotels.find(h => h.id === hotelId);
                    
                    if (hotel && hotel.name) {
                        hotelName = hotel.name;
                    } else {
                        const nameInput = document.getElementById('editHotelName');
                        if (nameInput && nameInput.value) {
                            hotelName = nameInput.value;
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error obteniendo nombre del hotel:', error);
                }
                
                // Mostrar nombre del hotel en el modal
                const hotelNameSpan = document.getElementById('currentHotelName');
                if (hotelNameSpan) {
                    hotelNameSpan.textContent = hotelName;
                }
                
                // Mostrar carpeta del hotel
                const hotelFolderPath = document.getElementById('hotelFolderPath');
                if (hotelFolderPath) {
                    try {
                        const slug = getHotelSlug(hotelName);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}-${slug}/`;
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error generando slug:', error);
                        hotelFolderPath.textContent = `hotel-images/hotel-${hotelId}/`;
                    }
                }
                
                // Limpiar im√°genes subidas si es una nueva sesi√≥n
                uploadedImages = [];
                
                // Renderizar gestor
                try {
                    renderImageManager();
                } catch (error) {
                    console.error('‚ùå Error renderizando gestor:', error);
                }
                
                console.log('‚úÖ Gestor de im√°genes completamente inicializado');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en openImageManager:', error);
                alert('‚ùå Error al abrir el gestor de im√°genes: ' + error.message);
            }
        }

        // Funci√≥n para cerrar gestor de im√°genes (compatibilidad)
        function closeImageManager() {
            closeImageManagerSimple();
        }

        // Funci√≥n para obtener slug del hotel
        function getHotelSlug(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        }

        // Funci√≥n para cargar im√°genes disponibles
        function loadAvailableImages(hotelId) {
            // Implementar carga de im√°genes
            console.log('Cargando im√°genes para hotel:', hotelId);
        }

        // Funci√≥n para cargar fotos del hotel
        function loadHotelPhotos(hotel) {
            // Implementar carga de fotos
            console.log('Cargando fotos del hotel:', hotel);
        }

        // Funci√≥n para renderizar gestor de im√°genes
        function renderImageManager() {
            console.log('üé® Renderizando gestor de im√°genes...');
            
            const availableContainer = document.getElementById('availableImages');
            const selectedContainer = document.getElementById('selectedImages');
            
            if (!availableContainer || !selectedContainer) {
                console.error('‚ùå Contenedores de im√°genes no encontrados');
                return;
            }
            
            // Limpiar contenedores
            availableContainer.innerHTML = '';
            selectedContainer.innerHTML = '';
            
            // Obtener im√°genes ya seleccionadas del formulario
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = getGalleryImagesFromInput();
                }
            }
            
            // Agregar im√°genes subidas (nuevas)
            uploadedImages.forEach((img, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item';
                imgDiv.dataset.imagePath = img.data;
                imgDiv.dataset.imageName = img.name;
                
                if (selectedImages.includes(img.data)) {
                    imgDiv.classList.add('selected');
                }
                
                imgDiv.innerHTML = `
                    <img src="${img.data}" alt="${img.name}" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                    <div class="image-name">${img.name}</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                imgDiv.onclick = () => toggleImageSelection(img.data);
                availableContainer.appendChild(imgDiv);
            });
            
            // Mostrar im√°genes seleccionadas
            selectedImages.forEach(imagePath => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'image-item selected';
                
                imgDiv.innerHTML = `
                    <img src="${imagePath}" alt="Seleccionada" 
                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="photo-placeholder" style="display: none;">
                        <span class="material-icons">photo</span>
                    </div>
                    <div class="image-name">Imagen seleccionada</div>
                    <div class="select-overlay">
                        <span class="material-icons">check_circle</span>
                    </div>
                `;
                
                selectedContainer.appendChild(imgDiv);
            });
            
            // Actualizar contador
            updatePhotoCounter();
        }

        // Funci√≥n para alternar selecci√≥n de imagen
        function toggleImageSelection(imagePath) {
            console.log('üîÑ Alternando selecci√≥n de imagen:', imagePath);
            
            // Obtener im√°genes seleccionadas actuales
            let selectedImages = [];
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedImages = [imageInput.value];
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    selectedImages = getGalleryImagesFromInput();
                }
            }
            
            // Si es modo 'main', solo puede haber una imagen seleccionada
            if (currentImageManagerMode === 'main') {
                selectedImages = [imagePath];
            } else {
                // Modo 'gallery', puede haber m√∫ltiples
                const index = selectedImages.indexOf(imagePath);
                if (index > -1) {
                    selectedImages.splice(index, 1); // Deseleccionar
                } else {
                    if (selectedImages.length < 10) {
                        selectedImages.push(imagePath); // Seleccionar
                    } else {
                        alert('‚ö†Ô∏è M√°ximo 10 im√°genes en la galer√≠a');
                        return;
                    }
                }
            }
            
            // Actualizar formulario
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = selectedImages[0] || '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = selectedImages.join(', ');
                }
            }
            
            // Re-renderizar
            renderImageManager();
        }

        // Funci√≥n para ver foto
        function viewPhoto(imagePath) {
            // Implementar vista de foto
            console.log('Viendo foto:', imagePath);
        }

        // Funci√≥n para eliminar foto
        function deletePhoto(imagePath) {
            // Implementar eliminaci√≥n de foto
            console.log('Eliminando foto:', imagePath);
        }

        // Funci√≥n para actualizar contador de fotos
        function updatePhotoCounter() {
            let selectedCount = 0;
            
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput && imageInput.value) {
                    selectedCount = 1;
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput && photosInput.value) {
                    const images = getGalleryImagesFromInput();
                    selectedCount = images.length;
                }
            }
            
            const counter = document.getElementById('photoCounter');
            if (counter) {
                const maxCount = currentImageManagerMode === 'main' ? 1 : 10;
                counter.textContent = `${selectedCount}/${maxCount} ${currentImageManagerMode === 'main' ? 'imagen' : 'fotos'} seleccionada(s)`;
                counter.style.color = selectedCount > 0 ? '#388e3c' : '#666';
            }
        }

        // Funci√≥n para aplicar selecci√≥n de imagen
        function applyImageSelection() {
            console.log('‚úÖ Aplicando selecci√≥n de imagen...');
            
            // Los valores ya est√°n actualizados en el formulario por toggleImageSelection
            // Solo necesitamos cerrar el modal y actualizar previews
            
            // Actualizar previews
            if (currentImageManagerMode === 'main') {
                updateImagePreview();
            } else {
                updatePhotosPreview();
            }
            
            // Cerrar modal
            closeImageManager();
            
            alert('‚úÖ Im√°genes aplicadas correctamente');
        }

        // ============================================
        // GESTOR DE IM√ÅGENES - VERSI√ìN NUEVA Y SIMPLE
        // ============================================
        
        // Variables globales
        let imageManagerMode = 'main'; // 'main' o 'gallery'
        let uploadedImagesBase64 = []; // Array de im√°genes en base64
        let globalEditingHotelId = null; // ID del hotel que se est√° editando actualmente

        // Variable para prevenir aperturas m√∫ltiples del modal
        let isImageManagerOpening = false;
        
        // Funci√≥n para abrir el modal de im√°genes - VERSI√ìN NUEVA Y SIMPLE
        function openImageManagerSimple(mode) {
            console.log('üîµ openImageManagerSimple llamada con modo:', mode);
            
            // Prevenir aperturas m√∫ltiples
            if (isImageManagerOpening) {
                console.log('‚ö†Ô∏è El gestor de im√°genes ya se est√° abriendo, ignorando...');
                return;
            }
            
            const modal = document.getElementById('imageManagerModal');
            if (!modal) {
                console.error('‚ùå Modal imageManagerModal no encontrado en el DOM');
                alert('‚ùå Error: Modal no encontrado. Recarga la p√°gina (F5).');
                return;
            }
            
            console.log('‚úÖ Modal encontrado:', modal);
            
            // Verificar si el modal ya est√° abierto
            const currentDisplay = window.getComputedStyle(modal).display;
            if (modal.style.display === 'block' || currentDisplay === 'block') {
                console.log('‚ö†Ô∏è El gestor de im√°genes ya est√° abierto');
                return;
            }
            
            isImageManagerOpening = true;
            console.log('üöÄ Abriendo modal de im√°genes - Modo:', mode);
            
            // Guardar el modo
            imageManagerMode = mode || 'main';
            
            // Configurar nombre del hotel
            const hotelNameSpan = document.getElementById('currentHotelName');
            if (hotelNameSpan) {
                const nameInput = document.getElementById('editHotelName');
                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
            }
            
            // Limpiar im√°genes subidas
            uploadedImagesBase64 = [];
            updateUploadedImagesPreview();
            
            // Abrir modal con estilos forzados
            modal.style.setProperty('display', 'block', 'important');
            modal.style.setProperty('z-index', '10000', 'important');
            modal.style.setProperty('position', 'fixed', 'important');
            modal.style.setProperty('top', '0', 'important');
            modal.style.setProperty('left', '0', 'important');
            modal.style.setProperty('width', '100%', 'important');
            modal.style.setProperty('height', '100%', 'important');
            modal.style.setProperty('background-color', 'rgba(0,0,0,0.5)', 'important');
            
            console.log('‚úÖ Modal abierto - Display:', window.getComputedStyle(modal).display);
            console.log('‚úÖ Modal z-index:', window.getComputedStyle(modal).zIndex);
            
            // Verificar que el input de archivo existe
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput) {
                console.error('‚ùå Input imageUploadInput no encontrado');
            } else {
                console.log('‚úÖ Input de archivo encontrado:', fileInput);
            }
            
            // Permitir nueva apertura despu√©s de un breve delay
            setTimeout(() => {
                isImageManagerOpening = false;
            }, 500);
        }
        
        // Funci√≥n para cerrar el modal
        function closeImageManagerSimple() {
            const modal = document.getElementById('imageManagerModal');
            if (modal) {
                modal.style.display = 'none';
                isImageManagerOpening = false; // Resetear el flag
                console.log('‚úÖ Modal cerrado');
            }
        }

        // Funci√≥n para comprimir imagen antes de convertir a base64
        function compressImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo proporci√≥n
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresi√≥n
                        const compressedBase64 = canvas.toDataURL(file.type, quality);
                        const originalSize = file.size;
                        const compressedSize = Math.round((compressedBase64.length - 22) * 3 / 4); // Aproximaci√≥n del tama√±o
                        const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                        
                        console.log(`üì¶ Imagen comprimida: ${file.name} - Original: ${(originalSize / 1024).toFixed(2)} KB, Comprimida: ${(compressedSize / 1024).toFixed(2)} KB (${compressionRatio}% reducci√≥n)`);
                        
                        resolve({
                            name: file.name,
                            data: compressedBase64,
                            type: file.type,
                            size: compressedSize,
                            originalSize: originalSize
                        });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Funci√≥n para agregar imagen desde URL
        async function addImageFromURL() {
            const helpText = `üîó Ingresa la URL de la imagen:

üìã Ejemplos de URLs que funcionan:
‚Ä¢ https://images.unsplash.com/photo-1566073771259-6a8506099945
‚Ä¢ https://images.pexels.com/photos/261102/pexels-photo-261102.jpeg
‚Ä¢ https://i.imgur.com/abc123.jpg
‚Ä¢ https://ejemplo.com/imagen.jpg

üí° C√≥mo obtener la URL:
1. Haz clic derecho en la imagen
2. Selecciona "Copiar direcci√≥n de imagen"
3. Pega aqu√≠

‚ö†Ô∏è La URL debe ser accesible p√∫blicamente.`;
            
            const url = prompt(helpText, 'https://');
            if (!url || !url.trim() || url === 'https://') {
                return;
            }
            
            const imageUrl = url.trim();
            
            // Validar que sea una URL v√°lida
            try {
                new URL(imageUrl);
            } catch (e) {
                alert('‚ùå Por favor, ingresa una URL v√°lida\n\nEjemplo: https://images.unsplash.com/photo-123.jpg');
                return;
            }
            
            // Verificar que sea una imagen
            const isImageExtension = imageUrl.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i);
            const hasImageKeyword = imageUrl.toLowerCase().includes('image') || 
                                   imageUrl.toLowerCase().includes('photo') || 
                                   imageUrl.toLowerCase().includes('picture') ||
                                   imageUrl.toLowerCase().includes('img');
            
            if (!isImageExtension && !hasImageKeyword) {
                const confirm = window.confirm('‚ö†Ô∏è La URL no parece ser una imagen.\n\n¬øDeseas continuar de todos modos?\n\n(Recomendado: URLs que terminen en .jpg, .png, etc.)');
                if (!confirm) return;
            }
            
            try {
                console.log('üì• Cargando imagen desde URL:', imageUrl);
                
                // Crear objeto de imagen
                const fileName = imageUrl.split('/').pop().split('?')[0] || 'imagen-desde-url.jpg';
                const imgObj = {
                    name: fileName.length > 50 ? fileName.substring(0, 50) + '...' : fileName,
                    data: imageUrl,
                    type: 'image/url',
                    size: 0,
                    isUrl: true,
                    originalUrl: imageUrl
                };
                
                uploadedImagesBase64.push(imgObj);
                updateUploadedImagesPreview();
                
                // Mostrar mensaje con informaci√≥n
                const serviceName = getImageServiceName(imageUrl);
                const message = serviceName 
                    ? `‚úÖ Imagen agregada desde ${serviceName}\n\nLa imagen se cargar√° desde:\n${imageUrl.substring(0, 60)}...`
                    : `‚úÖ Imagen agregada desde URL correctamente\n\nLa imagen se cargar√° desde la URL proporcionada.`;
                
                alert(message);
                
            } catch (error) {
                console.error('‚ùå Error agregando imagen desde URL:', error);
                alert('‚ùå Error al agregar la imagen.\n\nVerifica que:\n‚Ä¢ La URL sea accesible p√∫blicamente\n‚Ä¢ La URL sea correcta\n‚Ä¢ El servidor permita acceso desde otros sitios\n\nüí° Tip: Prueba abriendo la URL en una nueva pesta√±a primero.');
            }
        }
        
        // Funci√≥n auxiliar para identificar el servicio de imagen
        function getImageServiceName(url) {
            const urlLower = url.toLowerCase();
            if (urlLower.includes('unsplash.com')) return 'Unsplash';
            if (urlLower.includes('pexels.com')) return 'Pexels';
            if (urlLower.includes('pixabay.com')) return 'Pixabay';
            if (urlLower.includes('imgur.com')) return 'Imgur';
            if (urlLower.includes('imgbb.com')) return 'ImgBB';
            if (urlLower.includes('postimg.cc')) return 'Postimg';
            if (urlLower.includes('booking.com') || urlLower.includes('bstatic.com')) return 'Booking.com';
            if (urlLower.includes('tripadvisor.com')) return 'TripAdvisor';
            return null;
        }
        
        // Funci√≥n para manejar la subida de imagen principal directamente desde disco
        async function handleMainImageUpload(event) {
            console.log('üìÅ handleMainImageUpload llamada');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('‚ö†Ô∏è No se seleccion√≥ ning√∫n archivo');
                return;
            }
            
            console.log(`üì§ Procesando imagen principal: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            
            // Validar tama√±o
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert(`‚ö†Ô∏è La imagen "${file.name}" es demasiado grande (m√°ximo 10MB antes de comprimir)`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                alert(`‚ö†Ô∏è El archivo "${file.name}" no es una imagen v√°lida`);
                event.target.value = ''; // Limpiar input
                return;
            }
            
            try {
                // Comprimir y convertir a base64
                const compressed = await compressImage(file);
                console.log('‚úÖ Imagen principal comprimida y lista');
                
                // Guardar en el campo del formulario
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = compressed.data;
                    updateImagePreview();
                    alert(`‚úÖ Imagen principal "${file.name}" agregada correctamente`);
                }
                
                // Limpiar input para permitir seleccionar otra vez
                event.target.value = '';
                
            } catch (error) {
                console.error('‚ùå Error procesando imagen principal:', error);
                alert(`‚ùå Error procesando imagen "${file.name}"`);
                event.target.value = ''; // Limpiar input
            }
        }
        
        // Funci√≥n para manejar la subida de im√°genes de galer√≠a directamente desde disco
        async function handleGalleryImagesUpload(event) {
            console.log('üìÅ handleGalleryImagesUpload llamada');
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                console.log('‚ö†Ô∏è No se seleccionaron archivos');
                return;
            }
            
            console.log(`üì§ Procesando ${files.length} imagen(es) para galer√≠a...`);
            
            const photosInput = document.getElementById('editHotelPhotos');
            if (!photosInput) {
                console.error('‚ùå Campo editHotelPhotos no encontrado');
                return;
            }
            
            const currentImages = getGalleryImagesFromInput();
            const maxSize = 10 * 1024 * 1024; // 10MB
            let processedCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tama√±o
                if (file.size > maxSize) {
                    alert(`‚ö†Ô∏è La imagen "${file.name}" es demasiado grande (m√°ximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`‚ö†Ô∏è El archivo "${file.name}" no es una imagen v√°lida`);
                    errorCount++;
                    continue;
                }
                
                // Validar l√≠mite de galer√≠a
                if (currentImages.length + processedCount >= 10) {
                    alert(`‚ö†Ô∏è M√°ximo 10 im√°genes en la galer√≠a. Solo se procesar√°n las primeras ${10 - currentImages.length} im√°genes.`);
                    break;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    currentImages.push(compressed.data);
                    processedCount++;
                    console.log(`‚úÖ Imagen ${i + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`‚ùå Error procesando imagen "${file.name}":`, error);
                    errorCount++;
                }
            }
            
            // Actualizar campo del formulario
            // Usar separador ||| para evitar conflictos con comas en base64
            photosInput.value = currentImages.join('|||');
            console.log(`üíæ Guardando ${currentImages.length} imagen(es) en el campo`);
            updatePhotosPreview();
            
            // Mostrar resultado
            if (processedCount > 0) {
                const message = `‚úÖ ${processedCount} imagen(es) agregada(s) a la galer√≠a${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
            } else {
                alert('‚ö†Ô∏è No se pudo procesar ninguna imagen');
            }
            
            // Limpiar input para permitir seleccionar otra vez
            event.target.value = '';
        }
        
        // Funci√≥n para manejar la selecci√≥n de archivos (para el modal)
        function handleFileSelection(event) {
            console.log('üìÅ handleFileSelection llamada');
            const files = event.target.files;
            const fileCount = files ? files.length : 0;
            console.log(`üìÅ ${fileCount} archivo(s) seleccionado(s)`);
            
            const infoDiv = document.getElementById('selectedFilesInfo');
            const countSpan = document.getElementById('fileCount');
            const uploadButton = document.getElementById('uploadButton');
            
            if (!infoDiv || !countSpan || !uploadButton) {
                console.error('‚ùå Elementos del formulario no encontrados');
                return;
            }
            
            if (fileCount > 0) {
                infoDiv.style.display = 'block';
                countSpan.textContent = fileCount;
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';
                console.log(`‚úÖ ${fileCount} archivo(s) seleccionado(s) - Bot√≥n de subir habilitado`);
            } else {
                infoDiv.style.display = 'none';
                uploadButton.disabled = true;
                uploadButton.style.opacity = '0.5';
                uploadButton.style.cursor = 'not-allowed';
            }
        }
        
        // Funci√≥n para subir im√°genes (con compresi√≥n)
        async function uploadImagesSimple() {
            const fileInput = document.getElementById('imageUploadInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('‚ö†Ô∏è Por favor, selecciona al menos una imagen');
                return;
            }
            
            const files = Array.from(fileInput.files);
            const maxSize = 10 * 1024 * 1024; // 10MB (aumentado porque comprimiremos)
            
            console.log(`üì§ Procesando ${files.length} imagen(es) con compresi√≥n...`);
            
            uploadedImagesBase64 = [];
            let processedCount = 0;
            let errorCount = 0;
            
            for (let index = 0; index < files.length; index++) {
                const file = files[index];
                
                // Validar tama√±o original
                if (file.size > maxSize) {
                    alert(`‚ö†Ô∏è La imagen "${file.name}" es demasiado grande (m√°ximo 10MB antes de comprimir)`);
                    errorCount++;
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`‚ö†Ô∏è El archivo "${file.name}" no es una imagen v√°lida`);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Comprimir y convertir a base64
                    const compressed = await compressImage(file);
                    uploadedImagesBase64.push(compressed);
                    processedCount++;
                    
                    console.log(`‚úÖ Imagen ${index + 1}/${files.length} procesada: ${file.name}`);
                    
                } catch (error) {
                    console.error(`‚ùå Error procesando imagen "${file.name}":`, error);
                    alert(`‚ùå Error procesando imagen "${file.name}"`);
                    errorCount++;
                }
            }
            
            if (uploadedImagesBase64.length > 0) {
                updateUploadedImagesPreview();
                const message = `‚úÖ ${processedCount} imagen(es) procesada(s) correctamente${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
                alert(message);
                fileInput.value = '';
            } else {
                alert('‚ö†Ô∏è No se pudo procesar ninguna imagen');
            }
        }
        
        // Funci√≥n para actualizar preview de im√°genes subidas
        function updateUploadedImagesPreview() {
            const container = document.getElementById('uploadedImagesPreview');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (uploadedImagesBase64.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">No hay im√°genes subidas a√∫n</p>';
                return;
            }
            
            uploadedImagesBase64.forEach((img, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; cursor: pointer;';
                
                // Determinar si es URL o base64
                const isUrl = img.isUrl || (!img.data.startsWith('data:'));
                const imageSrc = isUrl ? img.data : img.data;
                const badgeText = isUrl ? 'URL' : (img.originalSize ? `${Math.round((1 - img.size / img.originalSize) * 100)}%` : '');
                
                div.innerHTML = `
                    <img src="${imageSrc}" alt="${img.name}" 
                         style="width: 100%; height: 150px; object-fit: cover;"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'150\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'200\\' height=\\'150\\'/%3E%3Ctext fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'14\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3EError cargando imagen%3C/text%3E%3C/svg%3E';">
                    <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                        ${index + 1}
                    </div>
                    ${badgeText ? `<div style="position: absolute; top: 5px; left: 5px; background: rgba(76,175,80,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                        ${badgeText}
                    </div>` : ''}
                    ${isUrl ? `<div style="position: absolute; bottom: 30px; left: 0; right: 0; background: rgba(33,150,243,0.9); color: white; padding: 4px; font-size: 10px; text-align: center;">
                        üîó URL Externa
                    </div>` : ''}
                    <div style="padding: 8px; font-size: 12px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${img.name}
                    </div>
                `;
                div.onclick = function() {
                    selectImage(img.data);
                };
                container.appendChild(div);
            });
        }
        
        // Funci√≥n para seleccionar una imagen (acepta base64 o URL)
        function selectImage(imageData) {
            // imageData puede ser base64 o URL
            if (imageManagerMode === 'main') {
                // Modo imagen principal - solo una imagen
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = imageData;
                    updateImagePreview();
                }
            } else {
                // Modo galer√≠a - m√∫ltiples im√°genes
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    const currentImages = getGalleryImagesFromInput();
                    if (!currentImages.includes(imageData)) {
                        currentImages.push(imageData);
                        photosInput.value = currentImages.join('|||');
                        updatePhotosPreview();
                    }
                }
            }
            
            alert('‚úÖ Imagen seleccionada correctamente');
        }
        
        // Funci√≥n para aplicar selecci√≥n
        function applyImageSelectionSimple() {
            closeImageManagerSimple();
            alert('‚úÖ Selecci√≥n aplicada correctamente');
        }

        // Funci√≥n antigua (mantener por compatibilidad)
        async function uploadImages() {
            const fileInput = document.getElementById('imageUpload');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('‚ö†Ô∏è Por favor, selecciona al menos una imagen');
                return;
            }

            const files = Array.from(fileInput.files);
            const maxSize = 5 * 1024 * 1024; // 5MB m√°ximo
            
            console.log(`üì§ Subiendo ${files.length} imagen(es)...`);
            
            uploadedImages = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tama√±o
                if (file.size > maxSize) {
                    alert(`‚ö†Ô∏è La imagen "${file.name}" es demasiado grande (m√°ximo 5MB)`);
                    continue;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    alert(`‚ö†Ô∏è El archivo "${file.name}" no es una imagen v√°lida`);
                    continue;
                }
                
                try {
                    // Convertir a base64
                    const base64 = await fileToBase64(file);
                    uploadedImages.push({
                        name: file.name,
                        data: base64,
                        type: file.type,
                        size: file.size
                    });
                    
                    console.log(`‚úÖ Imagen "${file.name}" convertida a base64 (${(file.size / 1024).toFixed(2)} KB)`);
                } catch (error) {
                    console.error(`‚ùå Error procesando imagen "${file.name}":`, error);
                    alert(`‚ùå Error procesando imagen "${file.name}"`);
                }
            }
            
            if (uploadedImages.length > 0) {
                // Agregar las im√°genes a las disponibles
                renderImageManager();
                alert(`‚úÖ ${uploadedImages.length} imagen(es) procesada(s) correctamente. Ahora puedes seleccionarlas.`);
                
                // Limpiar el input
                fileInput.value = '';
            } else {
                alert('‚ö†Ô∏è No se pudo procesar ninguna imagen');
            }
        }
        
        // Funci√≥n auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Funci√≥n para crear archivo de imagen
        function createImageFile(path, fileName, hotel, photoNumber) {
            // Implementar creaci√≥n de archivo
            console.log('Creando archivo de imagen:', fileName);
        }

        // Funci√≥n para verificar si existe imagen
        function checkImageExists(imagePath) {
            // Implementar verificaci√≥n de imagen
            console.log('Verificando imagen:', imagePath);
            return true;
        }

        // Funci√≥n para validar ruta de imagen
        function validateImagePath(imagePath) {
            // Implementar validaci√≥n de ruta
            console.log('Validando ruta:', imagePath);
            return true;
        }

        // Funci√≥n para mostrar ayuda de imagen
        function showImageHelp() {
            // Implementar ayuda de imagen
            console.log('Mostrando ayuda de imagen...');
        }

        // Funci√≥n para eliminar hotel
        async function deleteHotel(hotelId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este hotel? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            console.log('üóëÔ∏è Eliminando hotel:', hotelId);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.deleteHotel(hotelId);
                    console.log('‚úÖ Hotel eliminado de Supabase');
                    alert('‚úÖ Hotel eliminado correctamente');
                    loadHotelsTable();
                    updateHotelsStats();
                    return;
                }
            } catch (error) {
                console.error('Error eliminando hotel:', error);
            }
            
            // Fallback localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const index = hotels.findIndex(h => h.id === hotelId || h.id == hotelId);
            if (index !== -1) {
                hotels.splice(index, 1);
                localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                alert('‚úÖ Hotel eliminado correctamente');
                loadHotelsTable();
                updateHotelsStats();
            }
        }

        // Funci√≥n para ver hotel
        async function viewHotel(hotelId) {
            console.log('üëÅÔ∏è Viendo hotel:', hotelId);
            
            // Buscar hotel en Supabase primero
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                    console.log('üì° Hotel cargado de Supabase:', hotel?.name);
                } catch (error) {
                    console.error('Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback localStorage
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                console.log('üíæ Hotel cargado de localStorage:', hotel?.name);
            }
            
            if (!hotel) {
                alert('‚ùå Hotel no encontrado');
                console.error('Hotel no encontrado con ID:', hotelId);
                return;
            }
            
            // Obtener valores soportando ambos formatos
            const hotelName = hotel.name || hotel.hotel_name || 'Sin nombre';
            const hotelLocation = hotel.location || hotel.address || 'Sin ubicaci√≥n';
            const hotelPrice = hotel.price || hotel.base_price || 0;
            const hotelRating = hotel.rating || hotel.stars || 0;
            const hotelStatus = hotel.status || 'Activo';
            const hotelDescription = hotel.description || '';
            const hotelWebsite = hotel.website || '';
            const hotelGoogleMaps = hotel.googleMaps || hotel.google_maps || '';
            const florInfo = hotel.florInfo || hotel.flor_info || {};
            const amenities = hotel.amenities || [];
            
            // Crear modal de vista
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            // Generar estrellas
            let stars = '';
            for (let i = 0; i < 5; i++) {
                stars += i < hotelRating ? '‚≠ê' : '‚òÜ';
            }
            
            // Generar secci√≥n de amenities
            let amenitiesHtml = '';
            if (amenities && amenities.length > 0) {
                amenitiesHtml = `<p style="margin: 8px 0;"><strong>üèä Amenities:</strong> ${Array.isArray(amenities) ? amenities.join(', ') : amenities}</p>`;
            }
            
            // Generar secci√≥n de Flor IA
            let florInfoHtml = '';
            if (florInfo && Object.keys(florInfo).length > 0) {
                florInfoHtml = `
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9, #f3e5f5); border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #7b1fa2;">ü§ñ Informaci√≥n para Flor IA</h4>
                        ${florInfo.services ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Servicios:</strong> ${florInfo.services.substring(0, 100)}...</p>` : ''}
                        ${florInfo.excursions ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Excursiones:</strong> ${florInfo.excursions.substring(0, 100)}...</p>` : ''}
                        ${florInfo.prices ? `<p style="margin: 5px 0; font-size: 0.9rem;"><strong>Precios:</strong> ${florInfo.prices.substring(0, 100)}...</p>` : ''}
                        <p style="margin: 5px 0; font-size: 0.8rem; color: #666;">‚úÖ Flor puede responder sobre este hotel</p>
                    </div>
                `;
            } else {
                florInfoHtml = `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">‚ö†Ô∏è Sin informaci√≥n para Flor IA</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem;">Edita este hotel para agregar informaci√≥n que Flor pueda usar.</p>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">üè® ${hotelName}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 8px 0;"><strong>üìç Ubicaci√≥n:</strong> ${hotelLocation}</p>
                        <p style="margin: 8px 0;"><strong>üí∞ Precio:</strong> ${hotelPrice ? '$' + hotelPrice + ' USD' : 'No especificado'}</p>
                        <p style="margin: 8px 0;"><strong>‚≠ê Calificaci√≥n:</strong> ${stars} (${hotelRating}/5)</p>
                        <p style="margin: 8px 0;"><strong>üìä Estado:</strong> 
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${hotelStatus === 'Activo' ? '#e8f5e9' : '#ffebee'}; color: ${hotelStatus === 'Activo' ? '#2e7d32' : '#c62828'};">
                                ${hotelStatus}
                            </span>
                        </p>
                        ${hotelDescription ? `<p style="margin: 8px 0;"><strong>üìù Descripci√≥n:</strong> ${hotelDescription}</p>` : ''}
                        ${amenitiesHtml}
                        ${hotelWebsite ? `<p style="margin: 8px 0;"><strong>üåê Web:</strong> <a href="${hotelWebsite}" target="_blank">${hotelWebsite}</a></p>` : ''}
                        ${hotelGoogleMaps ? `<p style="margin: 8px 0;"><strong>üó∫Ô∏è Google Maps:</strong> <a href="${hotelGoogleMaps}" target="_blank">Ver ubicaci√≥n</a></p>` : ''}
                    </div>
                    
                    ${florInfoHtml}
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="this.closest('.modal').remove(); editHotel('${hotelId}')" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }

        // Funci√≥n para exportar hoteles
        function exportHotels() {
            // Implementar exportaci√≥n
            console.log('Exportando hoteles...');
        }

        // Funci√≥n para refrescar hoteles
        function refreshHotels() {
            loadHotelsTable();
            updateStats();
            alert('Datos actualizados correctamente');
        }

        // Funci√≥n para inicializar dashboard
        async function initializeDashboard() {
            // Inicializar bases de datos
            if (typeof initClientesDB === 'function') {
                initClientesDB();
            }
            if (typeof initHotelsDB === 'function') {
                initHotelsDB();
            }
            // IMPORTANTE: Esperar a que las reservas se carguen de Supabase antes de continuar
            if (typeof initReservationsDB === 'function') {
                await initReservationsDB();
            }
            if (typeof initQuotesDB === 'function') {
                initQuotesDB();
            }
            if (typeof syncQuotesFromIndex === 'function') {
                syncQuotesFromIndex();
            }
            
            window.showSection('dashboard', null);
            
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            // Actualizar estad√≠sticas del dashboard (incluye Ingresos de Hoy)
            // AHORA los datos de reservas ya est√°n cargados de Supabase
            if (typeof updateStats === 'function') {
                updateStats();
            }
            
            // Event listeners para el formulario de edici√≥n de hoteles
            const editHotelForm = document.getElementById('editHotelForm');
            if (editHotelForm) {
                editHotelForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveHotelChanges();
                });
            }
            
            // Event listeners para previews en tiempo real (ELIMINADOS - campos de imagen removidos)
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                const editModal = document.getElementById('editHotelModal');
                const imageModal = document.getElementById('imageManagerModal');
                const carouselModal = document.getElementById('photoCarouselModal');
                const newQuoteModal = document.getElementById('newQuoteModal');
                const whatsappConfigModal = document.getElementById('whatsappConfigModal');
                const sendCotizadorLinkModal = document.getElementById('sendCotizadorLinkModal');
                const importUsersModal = document.getElementById('importUsersModal');
                
                if (event.target === editModal) {
                    closeEditModal();
                }
                // NO cerrar el modal de im√°genes al hacer clic fuera - solo cerrar cuando se hace clic en el bot√≥n cerrar
                // if (event.target === imageModal) {
                //     closeImageManager();
                // }
                if (event.target === carouselModal) {
                    // Implementar cierre de carrusel
                }
                if (event.target === newQuoteModal) {
                    closeNewQuoteModal();
                }
                if (event.target === whatsappConfigModal) {
                    closeWhatsAppConfig();
                }
                if (event.target === sendCotizadorLinkModal) {
                    closeSendCotizadorLinkModal();
                }
                if (event.target === importUsersModal) {
                    closeImportUsersModal();
                }
            });
            
            // ============================================
            // SUSCRIPCIONES EN TIEMPO REAL
            // ============================================
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                console.log('üîÑ Activando suscripciones en tiempo real...');
                
                window.supabaseClient.subscribeToAllChanges({
                    onReservationChange: (payload) => {
                        console.log('üîî Cambio en reservas detectado:', payload.eventType);
                        // Recargar datos de reservas
                        if (typeof initReservationsDB === 'function') {
                            initReservationsDB().then(() => {
                                if (typeof updateStats === 'function') updateStats();
                                if (typeof loadReservationsTable === 'function') loadReservationsTable();
                            });
                        }
                    },
                    onHotelChange: (payload) => {
                        console.log('üîî Cambio en hoteles detectado:', payload.eventType);
                        if (typeof loadHotelsTable === 'function') loadHotelsTable();
                        if (typeof updateHotelsStats === 'function') updateHotelsStats();
                    },
                    onAgentChange: (payload) => {
                        console.log('üîî Cambio en agentes detectado:', payload.eventType);
                        if (typeof loadAgentsTable === 'function') loadAgentsTable();
                    },
                    onExpenseChange: (payload) => {
                        console.log('üîî Cambio en gastos detectado:', payload.eventType);
                        if (typeof loadExpensesTable === 'function') loadExpensesTable();
                        if (typeof updateExpensesStats === 'function') updateExpensesStats();
                    },
                    onQuoteChange: (payload) => {
                        console.log('üîî Cambio en cotizaciones detectado:', payload.eventType);
                        if (typeof loadQuotesTable === 'function') loadQuotesTable();
                    },
                    onUserChange: (payload) => {
                        console.log('üîî Cambio en usuarios detectado:', payload.eventType);
                        if (typeof loadUsersTable === 'function') loadUsersTable();
                    }
                });
                
                console.log('‚úÖ Suscripciones en tiempo real activas');
            } else {
                console.warn('‚ö†Ô∏è Supabase no disponible - no hay sincronizaci√≥n en tiempo real');
            }
        }

        // Funci√≥n para limpiar im√°genes duplicadas
        function cleanDuplicateImages() {
            // Implementar limpieza
            console.log('Limpiando im√°genes duplicadas...');
        }

        // Funci√≥n para resetear gestor de im√°genes
        function resetImageManager() {
            console.log('üîÑ Reseteando gestor de im√°genes...');
            
            // Limpiar im√°genes subidas
            uploadedImages = [];
            
            // Limpiar selecciones
            if (currentImageManagerMode === 'main') {
                const imageInput = document.getElementById('editHotelImage');
                if (imageInput) {
                    imageInput.value = '';
                }
            } else {
                const photosInput = document.getElementById('editHotelPhotos');
                if (photosInput) {
                    photosInput.value = '';
                }
            }
            
            // Limpiar input de archivos
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Re-renderizar
            renderImageManager();
            
            alert('‚úÖ Gestor de im√°genes reseteado');
        }

        // Funci√≥n para abrir carrusel de fotos
        function openPhotoCarousel() {
            // Implementar carrusel
            console.log('Abriendo carrusel de fotos...');
        }

        // Funci√≥n para cerrar carrusel de fotos
        function closePhotoCarousel() {
            // Implementar cierre de carrusel
            console.log('Cerrando carrusel de fotos...');
        }

        // Funci√≥n para actualizar imagen del carrusel
        function updateCarouselImage() {
            // Implementar actualizaci√≥n de imagen
            console.log('Actualizando imagen del carrusel...');
        }

        // Funci√≥n para actualizar miniaturas del carrusel
        function updateCarouselThumbnails() {
            // Implementar actualizaci√≥n de miniaturas
            console.log('Actualizando miniaturas del carrusel...');
        }

        // Funci√≥n para actualizar contador del carrusel
        function updateCarouselCounter() {
            // Implementar contador
            console.log('Actualizando contador del carrusel...');
        }

        // Funci√≥n para foto anterior
        function previousPhoto() {
            // Implementar foto anterior
            console.log('Foto anterior...');
        }

        // Funci√≥n para foto siguiente
        function nextPhoto() {
            // Implementar foto siguiente
            console.log('Foto siguiente...');
        }

        // Funci√≥n para manejar teclas del carrusel
        function handleCarouselKeydown(event) {
            // Implementar manejo de teclas
            console.log('Manejando tecla:', event.key);
        }

        // Funci√≥n para cargar fotos guardadas
        function loadSavedPhotos() {
            // Implementar carga de fotos
            console.log('Cargando fotos guardadas...');
        }

        // ===== FUNCIONES PARA GESTI√ìN DE COTIZACIONES =====
        
        // Funci√≥n para inicializar base de datos de cotizaciones
        function initQuotesDB() {
            console.log('üìã Inicializando base de datos de cotizaciones...');
            
            // Verificar si ya existen cotizaciones en localStorage
            let existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            console.log(`üìä Estado inicial: ${existingQuotes.length} cotizaciones en quotesDB`);
            
            // Verificar si hay cotizaciones en el sistema antiguo (checkin24hs_quotes)
            const oldQuotes = JSON.parse(localStorage.getItem('checkin24hs_quotes') || '[]');
            console.log(`üìä Cotizaciones en sistema antiguo: ${oldQuotes.length}`);
            
            // Migrar cotizaciones del sistema antiguo al nuevo si existen
            if (oldQuotes.length > 0) {
                console.log('üîÑ Migrando cotizaciones del sistema antiguo...');
                
                // Convertir formato antiguo al nuevo formato
                const migratedQuotes = oldQuotes.map(oldQuote => {
                    // Buscar si ya existe esta cotizaci√≥n en el nuevo sistema (por ID)
                    const exists = existingQuotes.some(q => 
                        q.id === oldQuote.id || 
                        (q.id && String(q.id) === String(oldQuote.id))
                    );
                    
                    if (exists) {
                        console.log(`‚è≠Ô∏è Cotizaci√≥n ${oldQuote.id} ya existe, omitiendo...`);
                        return null;
                    }
                    
                    // Convertir formato antiguo al nuevo
                    const newQuote = {
                        id: oldQuote.id ? `COT-${oldQuote.id}` : `COT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        hotel: oldQuote.hotel || `Hotel ${oldQuote.hotel_id || 'Desconocido'}`,
                        hotelId: oldQuote.hotel_id,
                        checkIn: oldQuote.check_in_date,
                        checkOut: oldQuote.check_out_date,
                        dateRange: oldQuote.check_in_date && oldQuote.check_out_date 
                            ? `${formatDateForDisplay(oldQuote.check_in_date)} - ${formatDateForDisplay(oldQuote.check_out_date)}`
                            : 'Fechas no especificadas',
                        travelers: oldQuote.guests ? `${oldQuote.guests} hu√©sped${oldQuote.guests > 1 ? 'es' : ''}` : 'No especificado',
                        adults: oldQuote.guests || 1,
                        children: 0,
                        tariff: oldQuote.total_price || 0,
                        finalTariff: oldQuote.total_price || 0,
                        clientName: oldQuote.clientName || 'An√≥nimo',
                        notes: oldQuote.special_requests || '',
                        status: oldQuote.status || 'pending',
                        timestamp: oldQuote.created_at || oldQuote.timestamp || new Date().toISOString(),
                        source: 'migrado'
                    };
                    
                    return newQuote;
                }).filter(q => q !== null); // Eliminar nulls (duplicados)
                
                if (migratedQuotes.length > 0) {
                    // Agregar cotizaciones migradas al array existente
                    existingQuotes = [...existingQuotes, ...migratedQuotes];
                    localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
                    console.log(`‚úÖ ${migratedQuotes.length} cotizaciones migradas exitosamente`);
                    
                    // Marcar como migrado (no eliminar por si acaso)
                    localStorage.setItem('checkin24hs_quotes_migrated', 'true');
                } else {
                    console.log('‚ÑπÔ∏è No hay cotizaciones nuevas para migrar');
                }
            }
            
            console.log(`üìä Total de cotizaciones despu√©s de migraci√≥n: ${existingQuotes.length}`);
            
            if (existingQuotes.length === 0) {
                console.log('üìã No hay cotizaciones, la base de datos se inicializar√° cuando lleguen las primeras cotizaciones');
            }
            
            // Cargar cotizaciones iniciales
            loadQuotesTable();
            updateQuotesStats();
        }
        
        // Funci√≥n auxiliar para formatear fechas
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }
        
        // Funci√≥n para obtener etiqueta de estado de cotizaci√≥n
        function getStatusLabel(status) {
            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'processed': 'Procesada',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada',
                'rejected': 'Rechazada',
                'sent': 'Enviada',
                'completed': 'Completada'
            };
            return statusLabels[status] || status || 'Pendiente';
        }
        
        // Funci√≥n para cargar tabla de cotizaciones
        async function loadQuotesTable() {
            console.log('üìã Cargando tabla de cotizaciones...');
            
            // Intentar cargar desde Supabase primero
            let quotes = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando cotizaciones desde Supabase...');
                    quotes = await window.supabaseClient.getQuotes();
                    console.log(`‚úÖ ${quotes.length} cotizaciones cargadas desde Supabase`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                }
            } else {
                console.log('üíæ Cargando cotizaciones desde localStorage...');
                quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            }
            const tbody = document.getElementById('quotesTableBody');
            const noQuotesMessage = document.getElementById('noQuotesMessage');
            
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el tbody de cotizaciones');
                return;
            }
            
            if (quotes.length === 0) {
                tbody.innerHTML = '';
                if (noQuotesMessage) noQuotesMessage.style.display = 'block';
                console.log('üìã No hay cotizaciones para mostrar');
                return;
            }
            
            if (noQuotesMessage) noQuotesMessage.style.display = 'none';
            
            tbody.innerHTML = '';
            
            quotes.forEach((quote, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${quote.id || `COT-${String(index + 1).padStart(3, '0')}`}</td>
                    <td>${quote.hotel}</td>
                    <td>${quote.clientName || 'An√≥nimo'}</td>
                    <td>${quote.dateRange}</td>
                    <td>${quote.travelers}</td>
                    <td><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></td>
                    <td>${formatDate(quote.timestamp || new Date())}</td>
                    <td>
                        <button onclick="viewQuote('${quote.id || index}')" class="action-btn view" title="Ver detalles">
                            <span class="material-icons">visibility</span>
                        </button>
                        ${(quote.status === 'pending' || !quote.status) ? `
                        <button onclick="editQuote('${quote.id || index}')" class="action-btn edit" title="Editar y Cotizar" style="background: #ff9800;">
                            <span class="material-icons">edit</span>
                        </button>
                        ` : ''}
                        <button onclick="processQuote('${quote.id || index}')" class="action-btn edit" title="Procesar">
                            <span class="material-icons">check_circle</span>
                        </button>
                        <button onclick="deleteQuote('${quote.id || index}')" class="action-btn delete" title="Eliminar">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Tabla de cotizaciones cargada: ${quotes.length} cotizaciones`);
        }
        
        // Funci√≥n para actualizar estad√≠sticas de cotizaciones
        function updateQuotesStats() {
            console.log('üìä Actualizando estad√≠sticas de cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            // Calcular estad√≠sticas
            const totalQuotes = quotes.length;
            const pendingQuotes = quotes.filter(q => !q.status || q.status === 'pending').length;
            const processedQuotes = quotes.filter(q => q.status === 'processed').length;
            
            // Calcular promedio por d√≠a (√∫ltimos 7 d√≠as)
            const last7Days = quotes.filter(q => {
                const quoteDate = new Date(q.timestamp);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return quoteDate >= weekAgo;
            });
            const avgQuotesPerDay = last7Days.length / 7;
            
            // Actualizar elementos en el DOM
            const totalElement = document.getElementById('totalQuotes');
            const pendingElement = document.getElementById('pendingQuotes');
            const processedElement = document.getElementById('processedQuotes');
            const avgElement = document.getElementById('avgQuotesPerDay');
            
            if (totalElement) totalElement.textContent = totalQuotes;
            if (pendingElement) pendingElement.textContent = pendingQuotes;
            if (processedElement) processedElement.textContent = processedQuotes;
            if (avgElement) avgElement.textContent = avgQuotesPerDay.toFixed(1);
            
            console.log(`üìä Estad√≠sticas actualizadas: Total=${totalQuotes}, Pendientes=${pendingQuotes}, Procesadas=${processedQuotes}, Promedio/D√≠a=${avgQuotesPerDay.toFixed(1)}`);
        }
        
        // Funci√≥n para calcular acumulado de ventas del mes vigente
        function calculateMonthlySalesAccumulated() {
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            console.log('üìÖ Calculando acumulado para:', currentYear, 'mes', currentMonth);
            console.log('üìä Total de reservas:', reservations.length);
            
            // Filtrar reservas del mes actual que no est√©n canceladas
            const monthlyReservations = reservations.filter(reservation => {
                // Soportar tanto checkIn (camelCase) como check_in (snake_case de Supabase)
                const checkInDate = reservation.checkIn || reservation.check_in;
                
                if (!checkInDate || reservation.status === 'Cancelada' || reservation.status === 'cancelada') {
                    return false;
                }
                
                // Normalizar fecha de check-in
                let dateStr = checkInDate;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return false;
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                // Verificar que sea del mes actual
                return year === currentYear && month === currentMonth;
            });
            
            console.log('üìã Reservas del mes actual:', monthlyReservations.length);
            
            // Calcular total acumulado
            const total = monthlyReservations.reduce((sum, res) => {
                const amount = parseFloat(res.totalAmount) || 
                             parseFloat(res.total_amount) || 
                             parseFloat(res.amount) || 
                             parseFloat(res.price) || 0;
                return sum + amount;
            }, 0);
            
            console.log('üí∞ Total acumulado:', total);
            return total;
        }
        
        // Funci√≥n para ver detalles de una cotizaci√≥n
        function viewQuote(quoteId) {
            console.log('üëÅÔ∏è Viendo detalles de cotizaci√≥n:', quoteId);
            
            try {
                const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
                
                if (!quote) {
                    alert('‚ùå Cotizaci√≥n no encontrada');
                    return;
                }
                
                // Crear modal con detalles de la cotizaci√≥n
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90%; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; margin: 2% auto;">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <h2>Detalles de Cotizaci√≥n</h2>
                        
                        <div style="display: grid; gap: 15px;">
                        ${quote.clientName ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #1976d2;">
                            <span style="font-size: 1.5rem;">üë§</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Cliente</div>
                                <div style="color: #1976d2; font-size: 1.1rem; font-weight: 500;">${quote.clientName}</div>
                                ${quote.clientFirstName && quote.clientLastName ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                    ${quote.clientFirstName} ${quote.clientLastName}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üè®</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Hotel</div>
                                <div style="color: #666;">${quote.hotel}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üìÖ</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fechas</div>
                                <div style="color: #666;">${quote.dateRange}</div>
                                <div style="font-size: 0.8rem; color: #888;">Check-in: ${quote.checkIn} | Check-out: ${quote.checkOut}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üë•</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Hu√©spedes</div>
                                <div style="color: #666;">${quote.travelers}</div>
                                ${quote.children > 0 ? `<div style="font-size: 0.8rem; color: #888;">Edades: ${quote.childrenAges.join(', ')} a√±os</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üìä</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Estado</div>
                                <div style="color: #666;"><span class="quote-status ${quote.status || 'pending'}">${getStatusLabel(quote.status || 'pending')}</span></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üïê</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Fecha de Solicitud</div>
                                <div style="color: #666;">${formatDate(quote.timestamp)}</div>
                            </div>
                        </div>
                        
                        ${quote.module ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üì¶</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">M√≥dulo</div>
                                <div style="color: #666;">${quote.module}</div>
                    </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientEmail ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üìß</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Email</div>
                                <div style="color: #666;">${quote.clientEmail}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.clientPhone ? `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 1.5rem;">üì±</span>
                            <div>
                                <div style="font-weight: 600; color: #333;">Tel√©fono</div>
                                <div style="color: #666;">${quote.clientPhone}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${quote.notes ? `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">üìù Notas</div>
                            <div style="color: #666;">${quote.notes}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${(quote.status === 'pending' || !quote.status) && (!quote.tariff || quote.tariff === 0) ? `
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="margin-bottom: 15px; color: #856404;">üí∞ Asignar Tarifa</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa *</label>
                                <input type="number" id="quoteTariffInput" class="form-input" min="0" step="0.01" required placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Descuento</label>
                                <input type="number" id="quoteDiscountInput" class="form-input" min="0" step="0.01" value="0" placeholder="0.00" oninput="calculateQuoteFinalTariff()" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tarifa Final</label>
                            <input type="number" id="quoteFinalTariffInput" class="form-input" step="0.01" readonly style="background: #e3f2fd; font-weight: bold; width: 100%;" value="0.00">
                        </div>
                        <button onclick="assignTariffToQuote('${quoteId}')" class="form-button" style="background: #ffc107; color: #333; width: 100%;">
                            üí∞ Asignar Tarifa y Enviar al Cliente
                        </button>
                    </div>
                    ` : quote.tariff > 0 ? `
                    <div style="margin-top: 20px; padding: 20px; background: #d4edda; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #155724;">üí∞ Tarifa Asignada</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa</div>
                                <div style="color: #666; font-size: 1.2rem;">$${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Descuento</div>
                                <div style="color: #666; font-size: 1.2rem;">$${(quote.discount || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #c3e6cb;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Tarifa Final</div>
                            <div style="color: #155724; font-size: 1.5rem; font-weight: bold;">$${(quote.finalTariff || quote.tariff).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${(quote.status === 'pending' || !quote.status) ? `
                        <button onclick="processQuote('${quoteId}')" class="form-button" style="background: #28a745; color: white;">
                            ‚úÖ Marcar como Procesada
                        </button>
                        ` : ''}
                        <button onclick="deleteQuote('${quoteId}')" class="form-button" style="background: #dc3545; color: white;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
            
                document.body.appendChild(modal);
                console.log('‚úÖ Modal creado y agregado al DOM');
                
                // Cerrar modal al hacer clic fuera
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('‚ùå Error al mostrar modal de cotizaci√≥n:', error);
                alert('‚ùå Error al mostrar los detalles de la cotizaci√≥n: ' + error.message);
            }
        }
        
        // Funci√≥n para editar y cotizar una cotizaci√≥n pendiente
        function editQuote(quoteId) {
            console.log('‚úèÔ∏è Editando cotizaci√≥n:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quote = quotes.find(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (!quote) {
                alert('‚ùå Cotizaci√≥n no encontrada');
                return;
            }
            
            // Crear modal de edici√≥n
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>‚úèÔ∏è Editar y Cotizar</h2>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">üë§ Informaci√≥n del Cliente</div>
                        <div style="color: #666;">
                            <div><strong>Nombre Completo:</strong> ${quote.clientName || 'No especificado'}</div>
                            ${quote.clientFirstName ? `<div><strong>Nombre:</strong> ${quote.clientFirstName}</div>` : ''}
                            ${quote.clientLastName ? `<div><strong>Apellido:</strong> ${quote.clientLastName}</div>` : ''}
                            ${quote.clientEmail ? `<div><strong>Email:</strong> ${quote.clientEmail}</div>` : ''}
                            ${quote.clientPhone ? `<div><strong>Tel√©fono:</strong> ${quote.clientPhone}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">üìã Detalles de la Cotizaci√≥n</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            <div><strong>Hotel:</strong> ${quote.hotel}</div>
                            <div><strong>M√≥dulo:</strong> ${quote.module || 'No especificado'}</div>
                            <div><strong>Fechas:</strong> ${quote.dateRange}</div>
                            <div><strong>Noches:</strong> ${quote.nights || 'N/A'}</div>
                            <div><strong>Hu√©spedes:</strong> ${quote.travelers}</div>
                        </div>
                    </div>
                    
                    <form id="editQuoteForm" onsubmit="saveEditedQuote(event, '${quoteId}')">
                        <h3 style="margin-bottom: 15px; color: #333;">üí∞ Asignar Tarifa</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label class="form-label">Tarifa *</label>
                                <input type="number" id="editQuoteTariff" class="form-input" min="0" step="0.01" required 
                                       placeholder="0.00" value="${quote.tariff || ''}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Descuento</label>
                                <input type="number" id="editQuoteDiscount" class="form-input" min="0" step="0.01" 
                                       placeholder="0.00" value="${quote.discount || 0}" oninput="calculateEditQuoteFinalTariff()">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Tarifa Final</label>
                            <input type="number" id="editQuoteFinalTariff" class="form-input" step="0.01" readonly 
                                   style="background: #e3f2fd; font-weight: bold; font-size: 1.1rem;" 
                                   value="${(quote.finalTariff || quote.tariff || 0).toFixed(2)}">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Notas adicionales (opcional)</label>
                            <textarea id="editQuoteNotes" class="form-input" rows="3" 
                                      placeholder="Agregar notas o comentarios adicionales">${quote.notes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button type="button" class="form-button secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="submit" class="form-button" style="background: #25d366; color: white;">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">send</span>
                                Guardar y Enviar al Cliente
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Calcular tarifa final inicial
            calculateEditQuoteFinalTariff();
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Funci√≥n para calcular tarifa final en el modal de edici√≥n
        function calculateEditQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('editQuoteTariff')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('editQuoteDiscount')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('editQuoteFinalTariff');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Funci√≥n para guardar cotizaci√≥n editada y enviar al cliente
        async function saveEditedQuote(event, quoteId) {
            event.preventDefault();
            console.log('üíæ Guardando cotizaci√≥n editada:', quoteId);
            
            const tariff = parseFloat(document.getElementById('editQuoteTariff').value);
            const discount = parseFloat(document.getElementById('editQuoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('editQuoteFinalTariff').value);
            const notes = document.getElementById('editQuoteNotes').value.trim();
            
            if (!tariff || tariff <= 0) {
                alert('‚ùå Por favor ingresa una tarifa v√°lida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('‚ùå Cotizaci√≥n no encontrada');
                return;
            }
            
            // Actualizar cotizaci√≥n
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            if (notes) {
                quotes[quoteIndex].notes = notes;
            }
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('‚úÖ Cotizaci√≥n actualizada:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Enviar al cliente por WhatsApp
            if (quotes[quoteIndex].clientPhone) {
                const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                
                try {
                    await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                    
                    // Cambiar estado a "enviado"
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('‚úÖ Cotizaci√≥n guardada y enviada exitosamente al cliente por WhatsApp!');
                } catch (error) {
                    console.error('Error enviando:', error);
                    const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                    window.open(whatsappUrl, '_blank');
                    
                    // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                    quotes[quoteIndex].status = 'enviado';
                    quotes[quoteIndex].sentAt = new Date().toISOString();
                    localStorage.setItem('quotesDB', JSON.stringify(quotes));
                    
                    // Actualizar tabla
                    loadQuotesTable();
                    updateQuotesStats();
                    
                    alert('‚úÖ Cotizaci√≥n guardada. Se abri√≥ WhatsApp Web/App. Por favor, env√≠a el mensaje manualmente.');
                }
            } else {
                alert('‚úÖ Cotizaci√≥n guardada exitosamente');
            }
        }
        
        // Funci√≥n para calcular tarifa final en el modal
        function calculateQuoteFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            const finalInput = document.getElementById('quoteFinalTariffInput');
            if (finalInput) {
                finalInput.value = finalTariff.toFixed(2);
            }
        }
        
        // Funci√≥n para asignar tarifa a una cotizaci√≥n
        async function assignTariffToQuote(quoteId) {
            const tariff = parseFloat(document.getElementById('quoteTariffInput')?.value || 0);
            const discount = parseFloat(document.getElementById('quoteDiscountInput')?.value || 0) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariffInput')?.value || 0);
            
            if (!tariff || tariff <= 0) {
                alert('‚ùå Por favor ingresa una tarifa v√°lida');
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('‚ùå Cotizaci√≥n no encontrada');
                return;
            }
            
            // Actualizar cotizaci√≥n con tarifa
            quotes[quoteIndex].tariff = tariff;
            quotes[quoteIndex].discount = discount;
            quotes[quoteIndex].finalTariff = finalTariff;
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('‚úÖ Tarifa asignada a cotizaci√≥n:', quotes[quoteIndex]);
            
            // Actualizar tabla
            loadQuotesTable();
            updateQuotesStats();
            
            // Cerrar modal actual
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            
            // Preguntar si desea enviar al cliente
            if (quotes[quoteIndex].clientPhone) {
                if (confirm('‚úÖ Tarifa asignada. ¬øDeseas enviar la cotizaci√≥n con la tarifa al cliente por WhatsApp?')) {
                    // Formatear mensaje con tarifa
                    const whatsappMessage = formatWhatsAppMessage(quotes[quoteIndex]);
                    
                    // Enviar por WhatsApp
                    try {
                        await sendWhatsAppMessage(quotes[quoteIndex].clientPhone.replace(/\D/g, ''), whatsappMessage);
                        
                        // Cambiar estado a "enviado"
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('‚úÖ Cotizaci√≥n con tarifa enviada exitosamente al cliente!');
                    } catch (error) {
                        console.error('Error enviando:', error);
                        const whatsappUrl = `https://wa.me/${quotes[quoteIndex].clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(whatsappMessage)}`;
                        window.open(whatsappUrl, '_blank');
                        
                        // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                        quotes[quoteIndex].status = 'enviado';
                        quotes[quoteIndex].sentAt = new Date().toISOString();
                        localStorage.setItem('quotesDB', JSON.stringify(quotes));
                        
                        // Actualizar tabla
                        loadQuotesTable();
                        updateQuotesStats();
                        
                        alert('‚ö†Ô∏è Se abri√≥ WhatsApp Web/App. Por favor, env√≠a el mensaje manualmente.');
                    }
                }
            } else {
                alert('‚úÖ Tarifa asignada exitosamente');
            }
        }
        
        // Funci√≥n para procesar una cotizaci√≥n
        function processQuote(quoteId) {
            console.log('‚úÖ Procesando cotizaci√≥n:', quoteId);
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('‚ùå Cotizaci√≥n no encontrada');
                return;
            }
            
            quotes[quoteIndex].status = 'processed';
            quotes[quoteIndex].processedAt = new Date().toISOString();
            
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estad√≠sticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('‚úÖ Cotizaci√≥n marcada como procesada');
            
            // Cerrar modal si est√° abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Funci√≥n para eliminar una cotizaci√≥n
        function deleteQuote(quoteId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            console.log('üóëÔ∏è Eliminando cotizaci√≥n:', quoteId);
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta cotizaci√≥n?')) {
                return;
            }
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotes.findIndex(q => q.id === quoteId || quotes.indexOf(q) === parseInt(quoteId));
            
            if (quoteIndex === -1) {
                alert('‚ùå Cotizaci√≥n no encontrada');
                return;
            }
            
            quotes.splice(quoteIndex, 1);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            // Actualizar tabla y estad√≠sticas
            loadQuotesTable();
            updateQuotesStats();
            
            alert('‚úÖ Cotizaci√≥n eliminada');
            
            // Cerrar modal si est√° abierto
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Funci√≥n para actualizar cotizaciones
        function refreshQuotes() {
            console.log('üîÑ Actualizando cotizaciones...');
            loadQuotesTable();
            updateQuotesStats();
            alert('‚úÖ Cotizaciones actualizadas');
        }
        
        // Funci√≥n para exportar cotizaciones
        function exportQuotes() {
            console.log('üì§ Exportando cotizaciones...');
            
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            
            if (quotes.length === 0) {
                alert('‚ùå No hay cotizaciones para exportar');
                return;
            }
            
            // Crear CSV
            let csv = 'ID,Hotel,Cliente,Fechas,Hu√©spedes,Estado,Fecha\n';
            
            quotes.forEach((quote, index) => {
                csv += `${quote.id || `COT-${String(index + 1).padStart(3, '0')}`},`;
                csv += `"${quote.hotel}",`;
                csv += `"${quote.clientName || 'An√≥nimo'}",`;
                csv += `"${quote.dateRange}",`;
                csv += `"${quote.travelers}",`;
                csv += `"${quote.status || 'Pendiente'}",`;
                csv += `"${formatDate(quote.timestamp)}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cotizaciones_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Cotizaciones exportadas correctamente');
        }
        
        // Funci√≥n para limpiar todas las cotizaciones
        function clearAllQuotes() {
            console.log('üóëÔ∏è Limpiando todas las cotizaciones...');
            
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODAS las cotizaciones? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            localStorage.removeItem('quotesDB');
            loadQuotesTable();
            updateQuotesStats();
            
            alert('‚úÖ Todas las cotizaciones han sido eliminadas');
        }
        
        // Funci√≥n para filtrar cotizaciones
        function filterQuotes() {
            console.log('üîç Filtrando cotizaciones...');
            
            const searchTerm = document.getElementById('quotesSearch').value.toLowerCase();
            const tbody = document.getElementById('quotesTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // ========== FUNCIONES DEL COTIZADOR ==========
        
        // Funci√≥n para mostrar modal de env√≠o de link del cotizador
        function showSendCotizadorLinkModal() {
            console.log('üì± Abriendo modal para enviar link del cotizador...');
            
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (!modal) {
                alert('‚ùå Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('sendLinkForm').reset();
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            // Formatear mensaje con el link en una l√≠nea separada para que sea m√°s visible
            document.getElementById('linkMessage').value = `Hola! üëã\n\nTe env√≠o el link para que puedas solicitar tu cotizaci√≥n personalizada:\n\n${cotizadorLink}\n\n‚úÖ Completa el formulario y te enviaremos tu cotizaci√≥n personalizada.\n\n¬°Gracias por confiar en nosotros! üôè`;
            // Limpiar imagen seleccionada
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
            
            // Si hay una imagen subida en la p√°gina de cotizaciones, usarla
            if (quoteImageFile) {
                // Crear un DataTransfer para asignar el archivo al input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(quoteImageFile);
                document.getElementById('linkImageInput').files = dataTransfer.files;
                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(quoteImageFile);
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para cerrar modal de env√≠o de link
        function closeSendCotizadorLinkModal() {
            const modal = document.getElementById('sendCotizadorLinkModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para previsualizar imagen en el modal
        function previewLinkImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('linkImagePreviewImg').src = e.target.result;
                    document.getElementById('linkImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Funci√≥n para eliminar imagen del modal
        function removeLinkImage() {
            document.getElementById('linkImageInput').value = '';
            document.getElementById('linkImagePreview').style.display = 'none';
        }
        
        // Variable global para almacenar la imagen subida en la p√°gina de cotizaciones
        let quoteImageFile = null;
        
        // Funci√≥n para manejar la subida de imagen en la p√°gina de cotizaciones
        function handleQuoteImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                quoteImageFile = file;
                alert(`‚úÖ Imagen seleccionada: ${file.name}\n\nLa imagen se incluir√° cuando env√≠es el link del cotizador.`);
            }
        }
        
        // Funci√≥n para generar link del cotizador
        function getCotizadorLink() {
            // Si estamos en un servidor web, usar la URL actual
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) || window.location.origin;
                return `${baseUrl}/cotizador-cliente.html`;
            }
            
            // Si estamos en file://, generar una URL relativa que funcione
            // Nota: Para que funcione completamente, el archivo debe estar en un servidor web
            return './cotizador-cliente.html';
        }
        
        // Funci√≥n para enviar link del cotizador por WhatsApp
        async function sendCotizadorLink(event) {
            event.preventDefault();
            console.log('üì± Enviando link del cotizador...');
            
            const phoneNumber = document.getElementById('linkPhoneNumber').value.trim();
            const customMessage = document.getElementById('linkMessage').value.trim();
            
            if (!phoneNumber) {
                alert('‚ùå Por favor ingresa el n√∫mero de WhatsApp del cliente');
                return;
            }
            
            // Limpiar n√∫mero de tel√©fono
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('‚ùå El n√∫mero de tel√©fono no es v√°lido. Debe incluir el c√≥digo de pa√≠s.');
                return;
            }
            
            // Obtener imagen si est√° seleccionada
            const imageInput = document.getElementById('linkImageInput');
            const imageFile = imageInput.files[0];
            
            // Formatear mensaje con link clickeable
            const cotizadorLink = 'file:///C:/Users/German/Downloads/Checkin24hs/cotizador-cliente.html';
            let message = customMessage;
            if (!message) {
                message = `Hola! üëã\n\nTe env√≠o el link para que puedas solicitar tu cotizaci√≥n personalizada:\n\n${cotizadorLink}\n\n‚úÖ Completa el formulario y te enviaremos tu cotizaci√≥n personalizada.\n\n¬°Gracias por confiar en nosotros! üôè`;
            }
            
            // Asegurar que el link est√© en una l√≠nea separada y bien formateado
            // Reemplazar cualquier variaci√≥n del link para asegurar formato consistente
            message = message.replace(/file:\/\/\/C:\/Users\/German\/Downloads\/Checkin24hs\/cotizador-cliente\.html/gi, cotizadorLink);
            
            // Nota: Los links file:// no son clickeables en WhatsApp Web, 
            // pero funcionan en algunas aplicaciones de escritorio de WhatsApp
            
            // Intentar enviar por WhatsApp Business API
            try {
                if (imageFile) {
                    // Si hay imagen, enviar primero la imagen con el mensaje como caption
                    await sendWhatsAppImage(cleanPhone, imageFile, message);
                } else {
                    // Si no hay imagen, enviar solo el mensaje
                    await sendWhatsAppMessage(cleanPhone, message);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
                
                alert(`‚úÖ Link del cotizador enviado exitosamente a ${phoneNumber} por WhatsApp!`);
                
            } catch (error) {
                console.error('‚ùå Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar m√©todo alternativo (wa.me)
                // Nota: wa.me no soporta env√≠o de im√°genes directamente
                // Abrir WhatsApp con el mensaje y notificar al usuario sobre la imagen
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Si hay imagen, mostrar instrucciones m√°s detalladas
                if (imageFile) {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE' 
                        ? '‚ö†Ô∏è No hay configuraci√≥n de WhatsApp Business API configurada y el servidor no est√° disponible.\n\nSe abri√≥ WhatsApp Web/App con el mensaje prellenado.\n\nüì∏ IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.\n\nüí° Para enviar im√°genes autom√°ticamente, configura las credenciales de WhatsApp Business API en la configuraci√≥n del sistema.'
                        : '‚ö†Ô∏è No se pudo enviar autom√°ticamente por la API. Se abri√≥ WhatsApp Web/App con el mensaje prellenado.\n\nüì∏ IMPORTANTE: Por favor, adjunta la imagen manualmente antes de enviar el mensaje.';
                    alert(errorMessage);
                } else {
                    const errorMessage = error.message === 'NO_CONFIG_AND_SERVER_UNAVAILABLE'
                        ? '‚ö†Ô∏è No hay configuraci√≥n de WhatsApp Business API configurada y el servidor no est√° disponible.\n\nSe abri√≥ WhatsApp Web/App con el mensaje prellenado. Por favor, env√≠a el mensaje manualmente.\n\nüí° Para enviar mensajes autom√°ticamente, configura las credenciales de WhatsApp Business API en la configuraci√≥n del sistema.'
                        : '‚ö†Ô∏è No se pudo enviar autom√°ticamente por la API. Se abri√≥ WhatsApp Web/App con el mensaje prellenado. Por favor, env√≠a el mensaje manualmente.';
                    alert(errorMessage);
                }
                
                // Cerrar modal
                closeSendCotizadorLinkModal();
            }
        }
        
        // Funci√≥n para mostrar el modal de nueva cotizaci√≥n
        function showNewQuoteModal() {
            console.log('üìã Abriendo modal de nueva cotizaci√≥n...');
            
            const modal = document.getElementById('newQuoteModal');
            if (!modal) {
                alert('‚ùå Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('quoteForm').reset();
            document.getElementById('quoteAdults').value = 1;
            document.getElementById('quoteChildren').value = 0;
            document.getElementById('quoteInfants').value = 0;
            document.getElementById('quoteTariff').value = '';
            document.getElementById('quoteDiscount').value = 0;
            document.getElementById('quoteFinalTariff').value = '0.00';
            document.getElementById('childrenAgesContainer').style.display = 'none';
            document.getElementById('nightsDisplay').style.display = 'none';
            
            // Cargar hoteles
            loadHotelsForQuote();
            
            // Establecer fecha m√≠nima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteCheckIn').setAttribute('min', today);
            document.getElementById('quoteCheckOut').setAttribute('min', today);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para cerrar el modal de nueva cotizaci√≥n
        function closeNewQuoteModal() {
            const modal = document.getElementById('newQuoteModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para mostrar modal de configuraci√≥n de WhatsApp
        function showWhatsAppConfig() {
            console.log('‚öôÔ∏è Abriendo configuraci√≥n de WhatsApp...');
            
            const modal = document.getElementById('whatsappConfigModal');
            if (!modal) {
                alert('‚ùå Error: Modal de configuraci√≥n no encontrado');
                return;
            }
            
            // Cargar configuraci√≥n existente
            const config = getWhatsAppConfig();
            const serverUrl = getServerURL();
            
            document.getElementById('whatsappAccessToken').value = config.accessToken || '';
            document.getElementById('whatsappPhoneNumberId').value = config.phoneNumberId || '';
            document.getElementById('whatsappApiVersion').value = config.apiVersion || 'v18.0';
            document.getElementById('whatsappServerURL').value = serverUrl || '';
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para cerrar modal de configuraci√≥n de WhatsApp
        function closeWhatsAppConfig() {
            const modal = document.getElementById('whatsappConfigModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ============================================
        
        // Abrir modal para agregar conexi√≥n
        function openAddWhatsAppModal() {
            const connections = JSON.parse(localStorage.getItem('whatsappConnections') || '[]');
            if (connections.length >= 4) {
                alert('‚ö†Ô∏è Ya tienes el m√°ximo de 4 conexiones permitidas.');
                return;
            }
            
            const modal = document.getElementById('add-whatsapp-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Resetear pasos
                document.getElementById('whatsapp-step-1').style.display = 'block';
                document.getElementById('whatsapp-step-2').style.display = 'none';
                document.getElementById('whatsapp-step-3').style.display = 'none';
                document.getElementById('new-whatsapp-tray-name').value = '';
            }
        }
        
        // Cerrar modal
        function closeAddWhatsAppModal() {
            const modal = document.getElementById('add-whatsapp-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Iniciar conexi√≥n de WhatsApp (VERSI√ìN CORREGIDA - usa checkWhatsAppConnection)
        async function startWhatsAppConnection() {
            const trayName = document.getElementById('new-whatsapp-tray-name').value.trim();
            if (!trayName) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre para la bandeja');
                return;
            }
            
            // Mostrar paso 2 (QR)
            document.getElementById('whatsapp-step-1').style.display = 'none';
            document.getElementById('whatsapp-step-2').style.display = 'block';
            
            // Simplemente llamar a checkWhatsAppConnection que obtendr√° el QR del servidor
            // El QR se mostrar√° autom√°ticamente cuando el servidor lo genere
            await window.checkWhatsAppConnection();
            
            // Verificar peri√≥dicamente hasta que se conecte
            const checkInterval = setInterval(async () => {
                await window.checkWhatsAppConnection();
                // Si se conect√≥, detener la verificaci√≥n
                const statusText = document.getElementById('whatsapp-status-text');
                if (statusText && statusText.textContent.includes('‚úÖ')) {
                    clearInterval(checkInterval);
                    // Esperar un momento y luego mostrar √©xito
                    setTimeout(() => {
                        const serverUrl = document.getElementById('whatsapp-server-url')?.value || localStorage.getItem('whatsappServerURL') || 'http://localhost:3001';
                        fetch(`${serverUrl}/api/status`)
                            .then(r => r.json())
                            .then(data => {
                                if (data.connected || data.whatsapp === 'connected') {
                                    showConnectionSuccess(trayName, data.phoneNumber || data.phone || 'N√∫mero no disponible');
                                }
                            });
                    }, 1000);
                }
            }, 3000);
            
            // Limpiar intervalo despu√©s de 5 minutos
            setTimeout(() => clearInterval(checkInterval), 300000);
        }
        
        // Esta funci√≥n ya no es necesaria - se usa checkWhatsAppConnection directamente
        
        // Simular conexi√≥n exitosa (para demo sin servidor)
        function simulateSuccessfulConnection(trayName) {
            const fakePhone = '+54929' + Math.floor(10000000 + Math.random() * 90000000);
            showConnectionSuccess(trayName, fakePhone);
        }
        
        // Mostrar conexi√≥n exitosa
        async function showConnectionSuccess(trayName, phone) {
            // Mostrar paso 3
            document.getElementById('whatsapp-step-2').style.display = 'none';
            document.getElementById('whatsapp-step-3').style.display = 'block';
            
            // Actualizar info
            document.getElementById('connected-tray-name').textContent = trayName;
            document.getElementById('connected-phone').textContent = phone;
            
            // Crear objeto de conexi√≥n
            const newConnection = {
                tray_name: trayName,
                phone: phone,
                status: 'connected',
                created_at: new Date().toISOString()
            };
            
            // Guardar en localStorage (no usar Supabase para conexiones)
            const connections = JSON.parse(localStorage.getItem('whatsappConnections') || '[]');
            connections.push(newConnection);
            localStorage.setItem('whatsappConnections', JSON.stringify(connections));
        }
        
        // Ver estado de conexi√≥n
        function viewWhatsAppStatus(index) {
            const connections = JSON.parse(localStorage.getItem('whatsappConnections') || '[]');
            const conn = connections[index];
            if (!conn) return;
            
            const phone = conn.phone || 'No disponible';
            const trayName = conn.tray_name || conn.trayName || 'Sin nombre';
            const status = conn.status === 'connected' ? '‚úÖ Conectado' : '‚ùå Desconectado';
            const connectedAt = conn.created_at || conn.connectedAt;
            const dateStr = connectedAt ? new Date(connectedAt).toLocaleString('es-AR') : 'No disponible';
            
            alert(`üì± Estado de la Conexi√≥n\n\nN√∫mero: ${phone}\nBandeja: ${trayName}\nEstado: ${status}\nConectado desde: ${dateStr}`);
        }
        
        // Desconectar WhatsApp (eliminar conexi√≥n)
        async function disconnectWhatsApp(index) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta conexi√≥n de WhatsApp?')) {
                return;
            }
            
            const connections = JSON.parse(localStorage.getItem('whatsappConnections') || '[]');
            const conn = connections[index];
            
            if (index !== undefined && index < connections.length) {
                // Eliminar del array local (no usar Supabase para conexiones)
                connections.splice(index, 1);
                localStorage.setItem('whatsappConnections', JSON.stringify(connections));
            }
            
            // loadWhatsAppConnections(); // Funci√≥n no implementada a√∫n
            alert('‚úÖ Conexi√≥n de WhatsApp eliminada');
        }
        
        // Limpiar todas las conexiones inv√°lidas o de prueba
        async function clearInvalidConnections() {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar TODAS las conexiones de WhatsApp?\n\nEsto eliminar√° todas las conexiones guardadas.')) {
                return;
            }
            
            // Limpiar localStorage (no usar Supabase para conexiones)
            localStorage.removeItem('whatsappConnections');
            
            // loadWhatsAppConnections(); // Funci√≥n no implementada a√∫n
            alert('‚úÖ Todas las conexiones de WhatsApp han sido eliminadas');
        }
        
        // Actualizar estad√≠sticas de WhatsApp
        function updateWhatsAppStats() {
            const stats = JSON.parse(localStorage.getItem('whatsappStats') || '{"received":0,"autoReplies":0,"contacts":0,"avgTime":0}');
            
            const receivedEl = document.getElementById('whatsapp-stat-received');
            const autoRepliesEl = document.getElementById('whatsapp-stat-auto-replies');
            const contactsEl = document.getElementById('whatsapp-stat-contacts');
            const avgTimeEl = document.getElementById('whatsapp-stat-avg-time');
            
            if (receivedEl) receivedEl.textContent = stats.received || 0;
            if (autoRepliesEl) autoRepliesEl.textContent = stats.autoReplies || 0;
            if (contactsEl) contactsEl.textContent = stats.contacts || 0;
            if (avgTimeEl) avgTimeEl.textContent = (stats.avgTime || 0) + 's';
        }
        
        // Verificar conexi√≥n del servidor
        async function checkWhatsAppConnection() {
            const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://localhost:3001';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${serverUrl}/api/health`, { 
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    alert('‚úÖ Conexi√≥n con el servidor WhatsApp establecida correctamente');
                } else {
                    throw new Error('Servidor no responde');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Servidor WhatsApp no disponible:', error.message);
                alert(`‚ö†Ô∏è No se pudo conectar con el servidor WhatsApp en:\n${serverUrl}\n\n` +
                      `Para usar WhatsApp con Flor IA necesitas:\n\n` +
                      `1. Un servidor WhatsApp corriendo (whatsapp-web.js o Baileys)\n` +
                      `2. La URL correcta del servidor\n` +
                      `3. El servidor debe estar accesible desde este navegador\n\n` +
                      `üìå Puedes configurar las conexiones manualmente sin servidor.`);
            }
        }
        
        // Guardar configuraci√≥n de WhatsApp
        function saveWhatsAppConfig() {
            console.log('üíæ Guardando configuraci√≥n de WhatsApp...');
            
            const autoReply = document.getElementById('whatsapp-auto-reply')?.checked || false;
            const businessHoursOnly = document.getElementById('whatsapp-business-hours-only')?.checked || false;
            const outOfHoursMessage = document.getElementById('whatsapp-out-of-hours-message')?.value || '';
            const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://localhost:3001';
            
            const config = {
                autoReply,
                businessHoursOnly,
                outOfHoursMessage,
                serverUrl
            };
            
            localStorage.setItem('whatsappConfig', JSON.stringify(config));
            console.log('‚úÖ Configuraci√≥n guardada:', config);
            alert('‚úÖ Configuraci√≥n de WhatsApp guardada correctamente');
        }
        
        // Cargar configuraci√≥n de WhatsApp
        function loadWhatsAppConfig() {
            const config = JSON.parse(localStorage.getItem('whatsappConfig') || '{}');
            
            const autoReplyEl = document.getElementById('whatsapp-auto-reply');
            const businessHoursEl = document.getElementById('whatsapp-business-hours-only');
            const outOfHoursEl = document.getElementById('whatsapp-out-of-hours-message');
            const serverUrlEl = document.getElementById('whatsapp-server-url');
            
            if (autoReplyEl) autoReplyEl.checked = config.autoReply || false;
            if (businessHoursEl) businessHoursEl.checked = config.businessHoursOnly || false;
            if (outOfHoursEl && config.outOfHoursMessage) outOfHoursEl.value = config.outOfHoursMessage;
            if (serverUrlEl && config.serverUrl) serverUrlEl.value = config.serverUrl;
        }
        
        // Inicializar WhatsApp al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // loadWhatsAppConnections(); // Funci√≥n no implementada a√∫n
                if (typeof loadWhatsAppConfig === 'function') {
                    loadWhatsAppConfig();
                }
            }, 1000);
        });
        
        // Funci√≥n para cargar hoteles en el selector
        function loadHotelsForQuote() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const select = document.getElementById('quoteHotel');
            
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar hotel</option>';
            
            if (hotels.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay hoteles disponibles';
                select.appendChild(option);
                return;
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.name;
                option.textContent = hotel.name || 'Hotel sin nombre';
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${hotels.length} hoteles cargados en el cotizador`);
        }
        
        // Funci√≥n para cargar contactos con tel√©fono en el selector
        function loadContactsForQuote() {
            // Cargar usuarios desde diferentes fuentes
            const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Combinar todos los usuarios
            const allContacts = [];
            
            // Agregar usuarios del dashboard
            dashboardUsers.forEach(user => {
                if (user.phone) {
                    allContacts.push({
                        name: user.name || 'Sin nombre',
                        phone: user.phone,
                        email: user.email || '',
                        source: 'Dashboard'
                    });
                }
            });
            
            // Agregar usuarios m√≥viles
            mobileUsers.forEach(user => {
                if (user.phone) {
                    const exists = allContacts.find(c => c.phone === user.phone);
                    if (!exists) {
                        allContacts.push({
                            name: user.name || 'Sin nombre',
                            phone: user.phone,
                            email: user.email || '',
                            source: 'M√≥vil'
                        });
                    }
                }
            });
            
            // Agregar contactos de reservas
            reservations.forEach(reservation => {
                if (reservation.guestPhone) {
                    const exists = allContacts.find(c => c.phone === reservation.guestPhone);
                    if (!exists) {
                        allContacts.push({
                            name: reservation.guestName || 'Sin nombre',
                            phone: reservation.guestPhone,
                            email: reservation.guestEmail || '',
                            source: 'Reserva'
                        });
                    }
                }
            });
            
            const select = document.getElementById('quoteContact');
            if (!select) return;
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar contacto</option>';
            
            if (allContacts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay contactos con tel√©fono disponibles';
                select.appendChild(option);
                return;
            }
            
            // Ordenar por nombre
            allContacts.sort((a, b) => a.name.localeCompare(b.name));
            
            allContacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.phone;
                option.textContent = `${contact.name} - ${contact.phone} (${contact.source})`;
                option.setAttribute('data-name', contact.name);
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${allContacts.length} contactos cargados en el cotizador`);
        }
        
        // Funci√≥n para calcular noches
        function calculateNights() {
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const display = document.getElementById('nightsDisplay');
            const count = document.getElementById('nightsCount');
            
            if (!checkIn || !checkOut) {
                display.style.display = 'none';
                return;
            }
            
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            if (checkOutDate <= checkInDate) {
                display.style.display = 'none';
                alert('‚ö†Ô∏è La fecha de check-out debe ser posterior al check-in');
                return;
            }
            
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            count.textContent = diffDays;
            display.style.display = 'block';
        }
        
        // Funci√≥n para calcular tarifa final
        function calculateFinalTariff() {
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = Math.max(0, tariff - discount);
            
            document.getElementById('quoteFinalTariff').value = finalTariff.toFixed(2);
        }
        
        // Funci√≥n para mostrar/ocultar campos de edades de ni√±os
        function toggleChildrenAges() {
            const childrenCount = parseInt(document.getElementById('quoteChildren').value) || 0;
            const container = document.getElementById('childrenAgesContainer');
            const inputsContainer = document.getElementById('childrenAgesInputs');
            
            if (childrenCount > 0) {
                container.style.display = 'block';
                inputsContainer.innerHTML = '';
                
                for (let i = 0; i < childrenCount; i++) {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">
                            Edad del ni√±o ${i + 1}:
                        </label>
                        <input type="number" class="form-input" min="0" max="17" 
                               id="childAge${i}" placeholder="Edad" required 
                               style="width: 100%;">
                    `;
                    inputsContainer.appendChild(div);
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Funci√≥n para crear y enviar cotizaci√≥n por WhatsApp
        function createAndSendQuote(event) {
            event.preventDefault();
            console.log('üìã Creando y enviando cotizaci√≥n...');
            
            // Obtener valores del formulario
            const hotelId = document.getElementById('quoteHotel').value;
            const hotelName = document.getElementById('quoteHotel').selectedOptions[0].text;
            const checkIn = document.getElementById('quoteCheckIn').value;
            const checkOut = document.getElementById('quoteCheckOut').value;
            const adults = parseInt(document.getElementById('quoteAdults').value) || 1;
            const children = parseInt(document.getElementById('quoteChildren').value) || 0;
            const infants = parseInt(document.getElementById('quoteInfants').value) || 0;
            const module = document.getElementById('quoteModule').value;
            const tariff = parseFloat(document.getElementById('quoteTariff').value) || 0;
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const finalTariff = parseFloat(document.getElementById('quoteFinalTariff').value) || 0;
            const notes = document.getElementById('quoteNotes').value;
            
            // Validaciones
            if (!hotelId || !checkIn || !checkOut || !module || tariff <= 0) {
                alert('‚ùå Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Obtener edades de ni√±os
            const childrenAges = [];
            if (children > 0) {
                for (let i = 0; i < children; i++) {
                    const age = parseInt(document.getElementById(`childAge${i}`).value);
                    if (age) childrenAges.push(age);
                }
            }
            
            // Calcular noches
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const diffTime = Math.abs(checkOutDate - checkInDate);
            const nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Formatear fechas para mostrar
            const checkInFormatted = new Date(checkIn).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const checkOutFormatted = new Date(checkOut).toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Formatear descripci√≥n de hu√©spedes
            let travelersDesc = `${adults} adulto${adults > 1 ? 's' : ''}`;
            if (children > 0) travelersDesc += `, ${children} ni√±o${children > 1 ? 's' : ''}`;
            if (infants > 0) travelersDesc += `, ${infants} infante${infants > 1 ? 's' : ''}`;
            
            // Crear objeto de cotizaci√≥n
            const quote = {
                id: 'COT-' + Date.now(),
                hotel: hotelName,
                hotelId: hotelId,
                checkIn: checkIn,
                checkOut: checkOut,
                dateRange: `${checkInFormatted} - ${checkOutFormatted}`,
                nights: nights,
                adults: adults,
                children: children,
                infants: infants,
                childrenAges: childrenAges,
                travelers: travelersDesc,
                module: module,
                tariff: tariff,
                discount: discount,
                finalTariff: finalTariff,
                notes: notes,
                status: 'pending',
                timestamp: new Date().toISOString(),
                source: 'dashboard'
            };
            
            // Guardar cotizaci√≥n en localStorage
            const quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            quotes.push(quote);
            localStorage.setItem('quotesDB', JSON.stringify(quotes));
            
            console.log('‚úÖ Cotizaci√≥n guardada:', quote);
            
            // Obtener n√∫mero de tel√©fono
            const phoneNumber = document.getElementById('quotePhoneNumber').value.trim();
            
            if (!phoneNumber) {
                alert('‚ùå Por favor ingresa el n√∫mero de WhatsApp del destinatario');
                return;
            }
            
            // Limpiar n√∫mero de tel√©fono (solo n√∫meros, con c√≥digo de pa√≠s)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            if (cleanPhone.length < 10) {
                alert('‚ùå El n√∫mero de tel√©fono no es v√°lido. Debe incluir el c√≥digo de pa√≠s.');
                return;
            }
            
            // Formatear mensaje para WhatsApp
            const whatsappMessage = formatWhatsAppMessage(quote);
            
            // Actualizar cotizaci√≥n con n√∫mero de tel√©fono
            quote.clientPhone = cleanPhone;
            const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
            if (quoteIndex !== -1) {
                quotesUpdated[quoteIndex] = quote;
                localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
            }
            
            // Intentar enviar por WhatsApp Business API
            sendWhatsAppMessage(cleanPhone, whatsappMessage).then(() => {
                // Cambiar estado a "enviado"
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotizaci√≥n en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estad√≠sticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert(`‚úÖ Cotizaci√≥n creada y enviada exitosamente a ${phoneNumber} por WhatsApp!`);
            }).catch(error => {
                console.error('‚ùå Error enviando por WhatsApp API:', error);
                
                // Si falla la API, usar m√©todo alternativo (wa.me)
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
                window.open(whatsappUrl, '_blank');
                
                // Cambiar estado a "enviado" aunque se abra WhatsApp manualmente
                quote.status = 'enviado';
                quote.sentAt = new Date().toISOString();
                
                // Actualizar cotizaci√≥n en localStorage
                const quotesUpdated = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const quoteIndex = quotesUpdated.findIndex(q => q.id === quote.id);
                if (quoteIndex !== -1) {
                    quotesUpdated[quoteIndex] = quote;
                    localStorage.setItem('quotesDB', JSON.stringify(quotesUpdated));
                }
                
                // Actualizar tabla y estad√≠sticas
                loadQuotesTable();
                updateQuotesStats();
                
                // Cerrar modal
                closeNewQuoteModal();
                
                alert('‚ö†Ô∏è No se pudo enviar autom√°ticamente por la API. Se abri√≥ WhatsApp Web/App con el mensaje prellenado. Por favor, env√≠a el mensaje manualmente.');
            });
        }
        
        // Funci√≥n para enviar mensaje por WhatsApp Business API
        async function sendWhatsAppMessage(phoneNumber, message) {
            console.log('üì± Enviando mensaje por WhatsApp API a:', phoneNumber);
            
            // Obtener configuraci√≥n de WhatsApp (puede estar en localStorage o variables globales)
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuraci√≥n, intentar usar endpoint del servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
            
            // Enviar usando WhatsApp Business API directamente
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'text',
                        text: {
                            body: message
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error al enviar mensaje');
                }
                
                const result = await response.json();
                console.log('‚úÖ Mensaje enviado exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error en API directa, intentando servidor:', error);
                // Si falla, intentar con el servidor
                return await sendViaServerAPI(phoneNumber, message);
            }
        }
        
        // Funci√≥n para enviar v√≠a endpoint del servidor
        async function sendViaServerAPI(phoneNumber, message) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuraci√≥n de WhatsApp ni servidor disponible');
            }
            
            try {
                const response = await fetch(`${serverUrl}/api/whatsapp/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('‚úÖ Mensaje enviado v√≠a servidor:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error en servidor:', error);
                throw new Error('No se pudo enviar el mensaje. Verifica la configuraci√≥n de WhatsApp.');
            }
        }
        
        // Funci√≥n para enviar imagen por WhatsApp Business API
        async function sendWhatsAppImage(phoneNumber, imageFile, caption = '') {
            console.log('üì± Enviando imagen por WhatsApp API a:', phoneNumber);
            
            // Obtener configuraci√≥n de WhatsApp
            const whatsappConfig = getWhatsAppConfig();
            
            if (!whatsappConfig.accessToken || !whatsappConfig.phoneNumberId) {
                // Si no hay configuraci√≥n, verificar si hay servidor disponible
                const serverUrl = getServerURL();
                if (serverUrl) {
                    console.log('‚ö†Ô∏è No hay configuraci√≥n de WhatsApp, intentando servidor...');
                    try {
                        return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                    } catch (serverError) {
                        console.error('‚ùå Servidor no disponible:', serverError);
                        // Lanzar error espec√≠fico para que se maneje en el catch principal
                        throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                    }
                } else {
                    // No hay configuraci√≥n ni servidor
                    console.error('‚ùå No hay configuraci√≥n de WhatsApp ni servidor disponible');
                    throw new Error('NO_CONFIG_AND_SERVER_UNAVAILABLE');
                }
            }
            
            try {
                const apiVersion = whatsappConfig.apiVersion || 'v18.0';
                
                // Paso 1: Subir la imagen primero para obtener el media ID
                console.log('üì§ Subiendo imagen a WhatsApp...');
                const mediaId = await uploadWhatsAppMedia(imageFile, whatsappConfig);
                console.log('‚úÖ Imagen subida, media ID:', mediaId);
                
                // Paso 2: Enviar mensaje con imagen usando el media ID
                const url = `https://graph.facebook.com/${apiVersion}/${whatsappConfig.phoneNumberId}/messages`;
                
                console.log('üì® Enviando mensaje con imagen...');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${whatsappConfig.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messaging_product: 'whatsapp',
                        to: phoneNumber,
                        type: 'image',
                        image: {
                            id: mediaId
                        },
                        caption: caption.substring(0, 1024) // WhatsApp limita el caption a 1024 caracteres
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Error en respuesta:', errorData);
                    throw new Error(errorData.error?.message || `Error al enviar imagen: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Imagen enviada exitosamente:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error en API directa:', error);
                // Si falla, intentar con el servidor
                try {
                    return await sendImageViaServerAPI(phoneNumber, imageFile, caption);
                } catch (serverError) {
                    console.error('‚ùå Error tambi√©n en servidor:', serverError);
                    throw error; // Lanzar el error original para que se maneje en el catch principal
                }
            }
        }
        
        // Funci√≥n para subir media a WhatsApp
        async function uploadWhatsAppMedia(file, config) {
            const apiVersion = config.apiVersion || 'v18.0';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('messaging_product', 'whatsapp');
            formData.append('type', 'image');
            
            console.log('üì§ Subiendo archivo:', file.name, 'Tama√±o:', file.size);
            
            const response = await fetch(`https://graph.facebook.com/${apiVersion}/${config.phoneNumberId}/media`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.accessToken}`
                    // No establecer Content-Type para FormData, el navegador lo hace autom√°ticamente
                },
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('‚ùå Error al subir imagen:', errorData);
                throw new Error(errorData.error?.message || `Error al subir imagen: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Media subido exitosamente:', result);
            return result.id;
        }
        
        // Funci√≥n auxiliar para convertir archivo a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Funci√≥n para enviar imagen v√≠a endpoint del servidor
        async function sendImageViaServerAPI(phoneNumber, imageFile, caption) {
            const serverUrl = getServerURL();
            
            if (!serverUrl) {
                throw new Error('No hay configuraci√≥n de WhatsApp ni servidor disponible');
            }
            
            try {
                const formData = new FormData();
                formData.append('phoneNumber', phoneNumber);
                formData.append('image', imageFile);
                formData.append('caption', caption);
                
                const response = await fetch(`${serverUrl}/api/whatsapp/send-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                
                const result = await response.json();
                console.log('‚úÖ Imagen enviada v√≠a servidor:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Error en servidor:', error);
                throw new Error('No se pudo enviar la imagen. Verifica la configuraci√≥n de WhatsApp.');
            }
        }
        
        // Funci√≥n para obtener configuraci√≥n de WhatsApp
        function getWhatsAppConfig() {
            // Intentar obtener desde localStorage
            const stored = localStorage.getItem('whatsappConfig');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error parseando configuraci√≥n:', e);
                }
            }
            
            // Valores por defecto (deben configurarse)
            return {
                accessToken: '',
                phoneNumberId: '',
                apiVersion: 'v18.0'
            };
        }
        
        // Funci√≥n para obtener URL del servidor
        function getServerURL() {
            // Intentar obtener desde localStorage
            const serverUrl = localStorage.getItem('whatsappServerURL');
            if (serverUrl && serverUrl.trim() !== '') {
                return serverUrl.trim();
            }
            
            // No devolver valor por defecto - el servidor debe estar expl√≠citamente configurado
            return null;
        }
        
        // Funci√≥n para formatear mensaje de WhatsApp
        function formatWhatsAppMessage(quote) {
            let message = `*üìã COTIZACI√ìN DE RESERVA*\n\n`;
            message += `Hola! üëã\n\n`;
            message += `Te env√≠o la cotizaci√≥n que solicitaste:\n\n`;
            message += `üè® *Hotel:* ${quote.hotel}\n`;
            message += `üì¶ *M√≥dulo:* ${quote.module}\n`;
            message += `üìÖ *Check-in:* ${quote.checkIn}\n`;
            message += `üìÖ *Check-out:* ${quote.checkOut}\n`;
            message += `üåô *Noches:* ${quote.nights}\n`;
            message += `üë• *Hu√©spedes:* ${quote.travelers}\n`;
            
            if (quote.children > 0 && quote.childrenAges && quote.childrenAges.length > 0) {
                message += `üë∂ *Edades de ni√±os:* ${quote.childrenAges.join(', ')} a√±os\n`;
            }
            
            message += `\nüí∞ *DETALLES DE PRECIO:*\n`;
            message += `üíµ *Tarifa:* $${quote.tariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.discount > 0) {
                message += `üéÅ *Descuento:* $${quote.discount.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            }
            
            message += `üí≥ *Tarifa Final:* $${quote.finalTariff.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n`;
            
            if (quote.notes) {
                message += `\nüìù *Notas:* ${quote.notes}\n`;
            }
            
            message += `\nüìÖ *Fecha de cotizaci√≥n:* ${new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}\n\n`;
            message += `¬øTe gustar√≠a realizar esta reserva? Estoy disponible para ayudarte. üòä\n\n`;
            message += `¬°Gracias por confiar en nosotros! üôè`;
            
            return message;
        }
        
        // Funciones auxiliares para promociones de hoteles
        function showPromotionTab(tabName) {
            console.log('üè® Cambiando a pesta√±a de promoci√≥n:', tabName);
            
            // Buscar el contenedor de promociones (puede estar en modal o en la secci√≥n)
            const promotionContent = document.getElementById('promotion-content');
            if (!promotionContent) return;
            
            // Ocultar todas las pesta√±as dentro del contenedor
            const tabContents = promotionContent.querySelectorAll('.promotion-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostrar la pesta√±a seleccionada
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Actualizar estilos de los botones de pesta√±a
            const tabButtons = promotionContent.parentElement.querySelectorAll('.promotion-tab');
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.style.background = '#ff9800';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#333';
                }
            });
        }
        
        function editHotelPromotion(hotelId) {
            console.log('‚úèÔ∏è Editando promoci√≥n del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            // Cargar promociones existentes del hotel
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            
            showEditPromotionModal(hotel, hotelPromotions);
        }
        
        function viewHotelPromotion(hotelId) {
            console.log('üëÅÔ∏è Viendo promoci√≥n del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                alert('Hotel no encontrado');
                return;
            }
            
            const hotelPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            showViewPromotionModal(hotel, hotelPromotions);
        }
        
        function deactivateHotelPromotion(hotelId) {
            console.log('‚è∏Ô∏è Pausando promoci√≥n del hotel:', hotelId);
            
            if (confirm('¬øEst√°s seguro de que quieres pausar esta promoci√≥n?')) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const hotelIndex = hotels.findIndex(h => h.id === hotelId);
                
                if (hotelIndex !== -1) {
                    hotels[hotelIndex].promotionStatus = 'paused';
                    localStorage.setItem('hotelsDB', JSON.stringify(hotels));
                    
                    // Actualizar la interfaz - recargar contenido de promociones si est√° visible
                    const promotionsContent = document.getElementById('promotions-tab-content');
                    if (promotionsContent && promotionsContent.style.display !== 'none') {
                        loadHotelPromotionsContent();
                    } else {
                    showHotelPromotions();
                    }
                    alert('Promoci√≥n pausada correctamente');
                }
            }
        }
        
        function createHotelPromotion() {
            console.log('‚ûï Creando nueva promoci√≥n de hotel...');
            
            const hotelId = document.getElementById('promotionHotel').value;
            const promotionType = document.getElementById('promotionType').value;
            const discount = document.getElementById('promotionDiscount').value;
            const price = document.getElementById('promotionPrice').value;
            const description = document.getElementById('promotionDescription').value;
            const startDate = document.getElementById('promotionStartDate').value;
            const endDate = document.getElementById('promotionEndDate').value;
            
            if (!hotelId || !promotionType || !description || !startDate || !endDate) {
                alert('‚ùå Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Aqu√≠ se guardar√≠a la promoci√≥n en localStorage
            const promotion = {
                id: `PROM-${Date.now()}`,
                hotelId: hotelId,
                type: promotionType,
                discount: discount,
                price: price,
                description: description,
                startDate: startDate,
                endDate: endDate,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Guardar en localStorage (implementaci√≥n futura)
            console.log('‚úÖ Promoci√≥n creada:', promotion);
            alert('‚úÖ Promoci√≥n creada correctamente');
            
            // Cerrar modal
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }
        
        // Funci√≥n para mostrar modal de edici√≥n de promociones
        function showEditPromotionModal(hotel, existingPromotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">‚úèÔ∏è Editar Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Promociones existentes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">Promociones Existentes</h3>
                        <div id="existing-promotions" style="display: grid; gap: 12px;">
                            ${existingPromotions.map((promo, index) => `
                                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; color: #333;">${promo.name}</h4>
                                        <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                    </div>
                                    <p style="margin: 0 0 8px 0; color: #666;">${promo.description}</p>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editSpecificPromotion('${hotel.id}', ${index})" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Editar</button>
                                        <button onclick="deletePromotion('${hotel.id}', ${index})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Eliminar</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Formulario para nueva promoci√≥n -->
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">‚ûï Agregar Nueva Promoci√≥n</h3>
                        
                        <form id="newPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre de la Promoci√≥n</label>
                                    <input type="text" id="promoName" placeholder="Ej: Descuento de Verano" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoci√≥n</label>
                                    <select id="promoType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                        <option value="seasonal">Temporada</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripci√≥n</label>
                                <textarea id="promoDescription" placeholder="Describe la promoci√≥n..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promoDiscount" min="0" max="100" placeholder="20" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promoStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promoEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Guardar Promoci√≥n</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para el formulario
            document.getElementById('newPromotionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewPromotion(hotel.id);
            });
        }
        
        // Funci√≥n para guardar nueva promoci√≥n
        function saveNewPromotion(hotelId) {
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promoName').value,
                type: document.getElementById('promoType').value,
                description: document.getElementById('promoDescription').value,
                discount: document.getElementById('promoDiscount').value,
                startDate: document.getElementById('promoStartDate').value,
                endDate: document.getElementById('promoEndDate').value,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.name || !promoData.description) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            // Guardar promoci√≥n
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoci√≥n guardada correctamente');
            
            // Cerrar modal si existe
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            
            // Actualizar la interfaz - recargar contenido de promociones si est√° visible
            const promotionsContent = document.getElementById('promotions-tab-content');
            if (promotionsContent && promotionsContent.style.display !== 'none') {
                loadHotelPromotionsContent();
            } else {
                showHotelPromotions();
            }
        }
        
        // Funci√≥n para guardar promoci√≥n desde el formulario en la secci√≥n
        function savePromotion() {
            const hotelId = document.getElementById('promotionHotel').value;
            if (!hotelId) {
                alert('Por favor selecciona un hotel');
                return;
            }
            
            const promoData = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: document.getElementById('promotionType').value,
                type: document.getElementById('promotionType').value,
                description: document.getElementById('promotionDescription').value,
                discount: document.getElementById('promotionDiscount').value,
                startDate: document.getElementById('promotionStartDate').value,
                endDate: document.getElementById('promotionEndDate').value,
                status: document.getElementById('promotionStatus').value,
                createdAt: new Date().toISOString()
            };
            
            // Validar datos
            if (!promoData.description) {
                alert('Por favor completa la descripci√≥n');
                return;
            }
            
            // Guardar promoci√≥n
            const existingPromotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
            existingPromotions.push(promoData);
            localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(existingPromotions));
            
            alert('Promoci√≥n guardada correctamente');
            
            // Recargar contenido de promociones
            loadHotelPromotionsContent();
            
            // Cambiar a pesta√±a de promociones activas
            showPromotionTab('active');
        }
        
        // Funci√≥n para mostrar modal de vista de promociones
        function showViewPromotionModal(hotel, promotions) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">üëÅÔ∏è Ver Promociones - ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        ${promotions.length > 0 ? promotions.map(promo => `
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <h3 style="margin: 0; color: #333;">${promo.name}</h3>
                                    <span style="background: ${promo.status === 'active' ? '#4caf50' : '#f44336'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${promo.status === 'active' ? 'Activo' : 'Pausado'}</span>
                                </div>
                                <p style="margin: 0 0 12px 0; color: #666;">${promo.description}</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <strong>Tipo:</strong> ${promo.type}
                                    </div>
                                    <div>
                                        <strong>Descuento:</strong> ${promo.discount}%
                                    </div>
                                    <div>
                                        <strong>Inicio:</strong> ${promo.startDate}
                                    </div>
                                    <div>
                                        <strong>Fin:</strong> ${promo.endDate}
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <strong>Creado:</strong> ${new Date(promo.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('') : `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <p>No hay promociones activas para este hotel</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci√≥n para editar promoci√≥n espec√≠fica
        function editSpecificPromotion(hotelId, promoIndex) {
            console.log('‚úèÔ∏è Editando promoci√≥n espec√≠fica:', hotelId, promoIndex);
            // Implementar edici√≥n de promoci√≥n espec√≠fica
            alert('Funci√≥n de edici√≥n espec√≠fica en desarrollo');
        }
        
        // Funci√≥n para eliminar promoci√≥n
        function deletePromotion(hotelId, promoIndex) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta promoci√≥n?')) {
                const promotions = JSON.parse(localStorage.getItem(`promotions_${hotelId}`) || '[]');
                promotions.splice(promoIndex, 1);
                localStorage.setItem(`promotions_${hotelId}`, JSON.stringify(promotions));
                
                alert('Promoci√≥n eliminada correctamente');
                
                // Actualizar la interfaz - recargar contenido de promociones si est√° visible
                const promotionsContent = document.getElementById('promotions-tab-content');
                if (promotionsContent && promotionsContent.style.display !== 'none') {
                    loadHotelPromotionsContent();
                } else {
                showHotelPromotions();
                }
            }
        }
        
        // Funci√≥n para probar la sincronizaci√≥n de cotizaciones
        function testQuotesSync() {
            console.log('üß™ Probando sincronizaci√≥n de cotizaciones...');
            
            // Crear una cotizaci√≥n de prueba
            const testQuote = {
                id: `TEST-${Date.now()}`,
                hotel: 'Hotel de Prueba',
                clientName: 'Usuario de Prueba',
                dateRange: '15/12/2025 - 18/12/2025',
                travelers: '2 adultos ‚Ä¢ 1 ni√±o',
                status: 'pending',
                timestamp: new Date().toLocaleString('es-ES'),
                checkIn: '2025-12-15',
                checkOut: '2025-12-18',
                adults: 2,
                children: 1,
                childrenAges: [8]
            };
            
            // Agregar a localStorage
            const existingQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
            existingQuotes.push(testQuote);
            localStorage.setItem('quotesDB', JSON.stringify(existingQuotes));
            
            // Disparar evento
            window.dispatchEvent(new CustomEvent('quotesDBChanged'));
            
            console.log('‚úÖ Cotizaci√≥n de prueba agregada');
            alert('‚úÖ Cotizaci√≥n de prueba agregada. Verifica que aparezca en la tabla.');
        }
        
        // Funci√≥n para sincronizar cotizaciones desde index.html
        function syncQuotesFromIndex() {
            console.log('üîÑ Sincronizando cotizaciones desde index.html...');
            
            // Escuchar cambios en localStorage de cotizaciones (desde otras pesta√±as)
            window.addEventListener('storage', function(e) {
                if (e.key === 'quotesDB') {
                    console.log('üìã Cambio detectado en quotesDB desde otra pesta√±a, actualizando...');
                    loadQuotesTable();
                    updateQuotesStats();
                }
            });
            
            // Escuchar eventos personalizados (desde la misma pesta√±a)
            window.addEventListener('quotesDBChanged', function() {
                console.log('üìã Evento local detectado, actualizando...');
                loadQuotesTable();
                updateQuotesStats();
            });
            
            // Tambi√©n verificar cambios peri√≥dicamente (como respaldo)
            setInterval(function() {
                const currentQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                if (window.lastQuotesCount === undefined) {
                    window.lastQuotesCount = currentQuotes.length;
                } else if (window.lastQuotesCount !== currentQuotes.length) {
                    console.log('üìã Cambio detectado en quotesDB (verificaci√≥n peri√≥dica), actualizando...');
                    window.lastQuotesCount = currentQuotes.length;
                    loadQuotesTable();
                    updateQuotesStats();
                }
            }, 2000); // Verificar cada 2 segundos
        }

        // Funci√≥n para inicializar base de datos de hoteles
        async function initHotelsDB() {
            console.log('üè® Inicializando base de datos de hoteles...');
            
            // Intentar cargar desde Supabase primero
            let existingHotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando hoteles desde Supabase...');
                    existingHotels = await window.supabaseClient.getHotels();
                    console.log(`üìä Estado inicial: ${existingHotels.length} hoteles en Supabase`);
                    console.log('‚úÖ Hoteles cargados desde Supabase - NO guardando en localStorage (versi√≥n corregida v2)');
                    
                    // NO sincronizar con localStorage si los datos vienen de Supabase
                    // localStorage tiene l√≠mites de quota y Supabase es la fuente de verdad
                    // Solo usar localStorage como fallback si Supabase no est√° disponible
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    // NO intentar guardar en localStorage si hay error de quota
                    if (error && error.name === 'QuotaExceededError') {
                        console.error('‚ùå localStorage est√° lleno. Usando solo Supabase.');
                        existingHotels = [];
                    } else {
                        try {
                            existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        } catch (localError) {
                            console.warn('‚ö†Ô∏è Error leyendo localStorage:', localError);
                            existingHotels = [];
                        }
                    }
                }
            } else {
                // Solo usar localStorage si Supabase no est√° disponible
                try {
                    existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                } catch (localError) {
                    console.warn('‚ö†Ô∏è Error leyendo localStorage:', localError);
                    existingHotels = [];
                }
            }
            
            console.log(`üìä Estado inicial: ${existingHotels.length} hoteles`);
            
            if (existingHotels.length > 0) {
                console.log('üìã Hoteles existentes:', existingHotels.map(h => h.name));
            }
            
            // DESACTIVADO: Ya no agregar hoteles por defecto autom√°ticamente
            // El usuario debe agregar sus propios hoteles manualmente
            if (false && existingHotels.length < 6) {
                console.log(`üÜï Solo hay ${existingHotels.length} hoteles, agregando hoteles por defecto...`);
                
                // Limpiar localStorage para asegurar una carga limpia
                localStorage.removeItem('hotelsDB');
                
                // Hoteles por defecto basados en index.html
                const defaultHotels = [
                    {
                        id: 'hotel-termas-chillan',
                        name: 'Hotel Termas Chill√°n',
                        location: 'Chill√°n, √ëuble, Chile',
                        description: 'Termas y Spa en la cordillera de Chill√°n',
                        rating: 4.3,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Termas', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Carriel Sur',
                            code: 'CCP',
                            distance: '85 km',
                            city: 'Concepci√≥n'
                        },
                        borderCrossing: {
                            name: 'Paso Pehuenche',
                            distance: '120 km',
                            route: 'Ruta CH-115'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -36.6064, lng: -71.2167 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Termas+Chill√°n,+Chill√°n,+√ëuble,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-puyehue',
                        name: 'Hotel Terma de Puyehue',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Termas y Spa de lujo en la Patagonia',
                        rating: 4.5,
                        price: '$200',
                        status: 'Activo',
                        amenities: ['Piscina', 'Spa', 'Restaurante', 'WiFi', 'Estacionamiento'],
                        badge: 'Termas',
                        airport: {
                            name: 'Aeropuerto Ca√±al Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '45 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samor√©',
                            distance: '45 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.683222, lng: -72.274986 },
                        googleMaps: 'https://maps.google.com/?q=Termas+de+Puyehue,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-huilo-huilo',
                        name: 'Hotel Huilo-Huilo',
                        location: 'Panguipulli, Los R√≠os, Chile',
                        description: 'Inmersi√≥n en el bosque nativo',
                        rating: 4.2,
                        price: '$160',
                        status: 'Activo',
                        amenities: ['Naturaleza', 'Trekking', 'Aves', 'Restaurante', 'WiFi'],
                        badge: 'Bosque',
                        airport: {
                            name: 'Aeropuerto Puc√≥n',
                            code: 'ZPC',
                            distance: '45 km',
                            city: 'Puc√≥n'
                        },
                        borderCrossing: {
                            name: 'Paso Mamuil Malal',
                            distance: '85 km',
                            route: 'Ruta CH-199'
                        },
                        image: 'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -39.8500, lng: -72.0000 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Huilo-Huilo,+Panguipulli,+Los+R√≠os,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-corralco',
                        name: 'Hotel Corralco Resort',
                        location: 'Lonquimay, La Araucan√≠a, Chile',
                        description: 'Esqu√≠ y aventura en la monta√±a',
                        rating: 4.7,
                        price: '$240',
                        status: 'Activo',
                        amenities: ['Esqu√≠', 'Monta√±a', 'Chimenea', 'Restaurante', 'WiFi'],
                        badge: 'Esqu√≠',
                        airport: {
                            name: 'Aeropuerto La Araucan√≠a',
                            code: 'ZCO',
                            distance: '65 km',
                            city: 'Temuco'
                        },
                        borderCrossing: {
                            name: 'Paso Icalma',
                            distance: '95 km',
                            route: 'Ruta CH-181'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -38.6500, lng: -71.6500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Corralco+Resort,+Lonquimay,+La+Araucan√≠a,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'hotel-futangue',
                        name: 'Hotel Futangue',
                        location: 'Lago Ranco, Los R√≠os, Chile',
                        description: 'Lujo y naturaleza en su m√°xima expresi√≥n',
                        rating: 5.0,
                        price: '$330',
                        status: 'Activo',
                        amenities: ['5 Estrellas', 'Vinos', 'Piscina', 'Spa', 'Restaurante'],
                        badge: 'Lujo',
                        airport: {
                            name: 'Aeropuerto Ca√±al Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '75 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samor√©',
                            distance: '110 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.3500, lng: -72.4500 },
                        googleMaps: 'https://maps.google.com/?q=Hotel+Futangue,+Lago+Ranco,+Los+R√≠os,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'cabanas-aguas-calientes',
                        name: 'Caba√±as Termas de Aguas Calientes',
                        location: 'Osorno, Los Lagos, Chile',
                        description: 'Aguas Calientes - Experiencia √∫nica',
                        rating: 4.0,
                        price: '$110',
                        status: 'Activo',
                        amenities: ['Caba√±as', 'Termas', 'Naturaleza', 'WiFi', 'Estacionamiento'],
                        badge: 'Caba√±as',
                        airport: {
                            name: 'Aeropuerto Ca√±al Bajo Carlos Hott Siebert',
                            code: 'ZOS',
                            distance: '25 km',
                            city: 'Osorno'
                        },
                        borderCrossing: {
                            name: 'Paso Cardenal Samor√©',
                            distance: '35 km',
                            route: 'Ruta CH-215'
                        },
                        image: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                        images: [
                            'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1551882547-ff40c63fe5fa?w=400&h=200&fit=crop',
                            'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=400&h=200&fit=crop'
                        ],
                        coordinates: { lat: -40.735366, lng: -72.307616 },
                        googleMaps: 'https://maps.google.com/?q=Termas+Aguas+Calientes,+Osorno,+Los+Lagos,+Chile',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // Guardar hoteles por defecto en localStorage
                localStorage.setItem('hotelsDB', JSON.stringify(defaultHotels));
                
                console.log(`‚úÖ ${defaultHotels.length} hoteles por defecto agregados a la base de datos`);
                console.log('üìã Hoteles agregados:', defaultHotels.map(h => h.name));
                
                // Verificar que se guardaron correctamente
                const savedHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                console.log(`üîç Verificaci√≥n: ${savedHotels.length} hoteles guardados en localStorage`);
                console.log('üîç Hoteles guardados:', savedHotels.map(h => h.name));
                
                // Notificar a index.html sobre el cambio
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'hotelsDB',
                    newValue: JSON.stringify(defaultHotels),
                    oldValue: '[]'
                }));
                
            } else {
                console.log(`‚ÑπÔ∏è Ya existen ${existingHotels.length} hoteles en la base de datos`);
            }
            
            // Mostrar estado final
            showHotelsStatus();
        }

        // Funci√≥n para mostrar estado actual de hoteles
        function showHotelsStatus() {
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            console.log('üè® ESTADO ACTUAL DE HOTELES EN DASHBOARD:');
            console.log(`üìä Total de hoteles: ${hotels.length}`);
            console.log('üìã Lista de hoteles:');
            hotels.forEach((hotel, index) => {
                console.log(`   ${index + 1}. ${hotel.name} (${hotel.location})`);
            });
            
            if (hotels.length === 0) {
                console.log('‚ö†Ô∏è No hay hoteles en localStorage');
            } else if (hotels.length < 6) {
                console.log(`‚ö†Ô∏è Solo hay ${hotels.length} hoteles, deber√≠an ser 6`);
            } else {
                console.log('‚úÖ Todos los hoteles est√°n cargados correctamente');
            }
        }
        
        // Funci√≥n para guardar base de datos de hoteles
        function saveHotelsDB() {
            // Implementar guardado
            console.log('Guardando base de datos de hoteles...');
        }

        // Funci√≥n para limpiar completamente el formulario de hotel
        function clearHotelForm() {
            console.log('üßπ Limpiando formulario de hotel...');
            
            // Resetear formulario
            const form = document.getElementById('editHotelForm');
            if (form) form.reset();
            
            // Limpiar TODOS los campos de texto
            const fieldsToClean = [
                'editHotelName', 'editHotelLocation', 'editHotelGoogleMaps', 
                'editHotelWebsite', 'editHotelPrice', 'editHotelDescription', 
                'editHotelAmenities'
            ];
            fieldsToClean.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Resetear selects
            const ratingSelect = document.getElementById('editHotelRating');
            const statusSelect = document.getElementById('editHotelStatus');
            if (ratingSelect) ratingSelect.value = '0';
            if (statusSelect) statusSelect.value = 'Activo';
            
            // Limpiar campos de Flor IA
            const florFields = [
                'editHotelFlorDescription', 'editHotelFlorServices', 'editHotelFlorExcursions',
                'editHotelFlorPrices', 'editHotelFlorPolicies', 'editHotelFlorTransport', 'editHotelFlorContact'
            ];
            florFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // LIMPIAR IMAGEN PRINCIPAL - Preview y input
            const mainImageInput = document.getElementById('editHotelImage');
            if (mainImageInput) mainImageInput.value = '';
            
            const mainImagePreview = document.getElementById('editImagePreview');
            if (mainImagePreview) {
                mainImagePreview.innerHTML = '';
            }
            
            // Limpiar el input de archivo
            const mainImageFileInput = document.getElementById('mainImageFileInput');
            if (mainImageFileInput) mainImageFileInput.value = '';
            
            // LIMPIAR GALER√çA DE FOTOS - Preview y input
            const galleryInput = document.getElementById('editHotelPhotos');
            if (galleryInput) galleryInput.value = '';
            
            const galleryPreview = document.getElementById('editPhotosPreview');
            if (galleryPreview) {
                galleryPreview.innerHTML = '';
            }
            
            // Limpiar el input de archivo de galer√≠a
            const galleryFileInput = document.getElementById('galleryImagesFileInput');
            if (galleryFileInput) galleryFileInput.value = '';
            
            // Limpiar elementos din√°micos de coordenadas (los mensajes verdes/naranjas)
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            if (googleMapsInput && googleMapsInput.parentNode) {
                const dynamicElements = googleMapsInput.parentNode.querySelectorAll('div[style*="color: #28a745"], div[style*="color: #ff9800"]');
                dynamicElements.forEach(el => el.remove());
            }
            
            console.log('‚úÖ Formulario limpiado completamente');
        }

        // Funci√≥n para agregar nuevo hotel
        function addNewHotel() {
            console.log('üÜï Abriendo formulario para agregar nuevo hotel...');
            
            const modal = document.getElementById('editHotelModal');
            if (!modal) {
                console.error('‚ùå Modal no encontrado');
                alert('‚ùå Error: Modal no encontrado');
                return;
            }
            
            // LIMPIAR TODO EL FORMULARIO
            clearHotelForm();
            
            // Cambiar el t√≠tulo del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = 'üè® Agregar Nuevo Hotel';
            }
            
            // Mostrar el modal
            modal.style.display = 'block';
            
            // Configurar el formulario para modo "agregar"
            const form = document.getElementById('editHotelForm');
            if (form) {
                form.dataset.mode = 'add';
                form.dataset.hotelId = '';
            }
            
            console.log('‚úÖ Formulario listo para agregar nuevo hotel');
        }

        // Nota: Las funciones editHotel, deleteHotel y viewHotel est√°n definidas arriba con soporte para Supabase

        // Funci√≥n para obtener hotel por ID
        function getHotelById(hotelId) {
            // Implementar obtenci√≥n
            console.log('Obteniendo hotel:', hotelId);
            return null;
        }

        // Funci√≥n para cargar tabla de hoteles (versi√≥n actualizada con Supabase)
        async function loadHotelsTable() {
            console.log('üìã Cargando tabla de hoteles...');
            
            const tbody = document.getElementById('hotelsTableBody');
            if (!tbody) {
                console.error('‚ùå Tabla de hoteles no encontrada');
                return;
            }
            
            // Intentar obtener hoteles de Supabase primero, luego localStorage como fallback
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando hoteles desde Supabase...');
                    hotels = await window.supabaseClient.getHotels();
                    console.log(`‚úÖ ${hotels.length} hoteles cargados desde Supabase`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                console.log('üíæ Cargando hoteles desde localStorage...');
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            tbody.innerHTML = '';
            
            if (hotels.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <span class="material-icons" style="font-size: 48px; color: #ddd;"></i>
                                <p>No hay hoteles registrados</p>
                                <button onclick="addNewHotel()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">add</span>
                                    Agregar Primer Hotel
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            hotels.forEach(hotel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            <div class="hotel-location">${hotel.location}</div>
                        </div>
                    </td>
                    <td>${hotel.location}</td>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                            ${getStars(hotel.rating)}
                            <span style="margin-left: 4px;">${hotel.rating}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">${hotel.price ? `$${hotel.price.toLocaleString()}` : 'No especificado'}</td>
                    <td style="text-align: center;">
                        <span class="status-${hotel.status.toLowerCase().replace(' ', '-')}">${hotel.status}</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}')" class="action-btn edit" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                        <button onclick="deleteHotel('${hotel.id}')" class="action-btn delete" title="Eliminar">
                            <span class="material-icons">delete</span>
                        </button>
                        <button onclick="viewHotel('${hotel.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Tabla actualizada con ${hotels.length} hoteles`);
        }

        // Funci√≥n para actualizar estad√≠sticas de hoteles
        function updateHotelsStats() {
            console.log('üìä Actualizando estad√≠sticas de hoteles...');
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Actualizar contadores
            const totalHotelsElement = document.getElementById('totalHotels');
            const avgRatingElement = document.getElementById('avgRating');
            const totalLocationsElement = document.getElementById('totalLocations');
            const priceRangeElement = document.getElementById('priceRange');
            
            if (totalHotelsElement) {
                totalHotelsElement.textContent = hotels.length;
            }
            
            if (avgRatingElement) {
                if (hotels.length > 0) {
                    const totalRating = hotels.reduce((sum, hotel) => sum + hotel.rating, 0);
                    const averageRating = (totalRating / hotels.length).toFixed(1);
                    avgRatingElement.textContent = averageRating;
                } else {
                    avgRatingElement.textContent = '0.0';
                }
            }
            
            if (totalLocationsElement) {
                const uniqueLocations = new Set(hotels.map(hotel => hotel.location));
                totalLocationsElement.textContent = uniqueLocations.size;
            }
            
            if (priceRangeElement) {
                if (hotels.length > 0) {
                    const prices = hotels.filter(hotel => hotel.price > 0).map(hotel => hotel.price);
                    if (prices.length > 0) {
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        priceRangeElement.textContent = `$${minPrice.toLocaleString()}-$${maxPrice.toLocaleString()}`;
                    } else {
                        priceRangeElement.textContent = '$0-$0';
                    }
                } else {
                    priceRangeElement.textContent = '$0-$0';
                }
            }
            
            console.log(`‚úÖ Estad√≠sticas actualizadas: ${hotels.length} hoteles`);
            
            // Actualizar estad√≠sticas del dashboard si est√° visible
            if (currentSection === 'dashboard' && typeof updateStats === 'function') {
                updateStats();
            }
        }

        // Funci√≥n para ver detalles del hotel
        function viewHotel(hotelId) {
            console.log('üëÅÔ∏è Viendo detalles del hotel:', hotelId);
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            const hotel = hotels.find(h => h.id === hotelId);
            
            if (!hotel) {
                console.error('‚ùå Hotel no encontrado:', hotelId);
                alert('‚ùå Hotel no encontrado');
                return;
            }
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">üè® ${hotel.name}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>üìç Ubicaci√≥n:</strong> ${hotel.location}</p>
                        <p><strong>‚≠ê Calificaci√≥n:</strong> ${hotel.rating}</p>
                        <p><strong>üí∞ Precio:</strong> ${hotel.price || 'No especificado'}</p>
                        <p><strong>üìã Estado:</strong> ${hotel.status}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>üìù Descripci√≥n:</strong></p>
                        <p>${hotel.description || 'Sin descripci√≥n'}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p><strong>üéØ Amenities:</strong></p>
                        <p>${Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : 'No especificadas'}</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editHotel('${hotel.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funci√≥n para editar hotel
        async function editHotel(hotelId) {
            console.log('‚úèÔ∏è Editando hotel:', hotelId);
            
            // PRIMERO: Limpiar el formulario completamente
            clearHotelForm();
            
            // Obtener hotel desde Supabase primero, luego localStorage como fallback
            let hotel = null;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const hotels = await window.supabaseClient.getHotels();
                    hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                    console.log('üì¶ Hotel cargado desde Supabase:', hotel);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando hotel de Supabase:', error);
                }
            }
            
            // Fallback a localStorage si no se encontr√≥ en Supabase
            if (!hotel) {
                const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                hotel = hotels.find(h => h.id === hotelId || h.id == hotelId);
                console.log('üì¶ Hotel cargado desde localStorage:', hotel);
            }
            
            if (!hotel) {
                console.error('‚ùå Hotel no encontrado:', hotelId);
                alert('‚ùå Hotel no encontrado');
                return;
            }
            
            // Llenar el formulario con los datos del hotel
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const websiteInput = document.getElementById('editHotelWebsite');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            
            if (nameInput) nameInput.value = hotel.name || '';
            if (locationInput) locationInput.value = hotel.location || '';
            if (websiteInput) websiteInput.value = hotel.website || '';
            
            // IMPORTANTE: Supabase usa snake_case (google_maps), localStorage usa camelCase (googleMaps)
            if (googleMapsInput) {
                const googleMapsUrl = hotel.google_maps || hotel.googleMaps || '';
                googleMapsInput.value = googleMapsUrl;
                console.log('üó∫Ô∏è Google Maps URL cargada:', googleMapsUrl);
            }
            
            if (ratingSelect) ratingSelect.value = hotel.rating || '0';
            if (priceInput) priceInput.value = hotel.price || '';
            if (descriptionTextarea) descriptionTextarea.value = hotel.description || '';
            if (amenitiesInput) amenitiesInput.value = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : '';
            if (statusSelect) statusSelect.value = hotel.status || 'Activo';
            
            // CARGAR CAMPOS DE FLOR IA
            const florInfo = hotel.flor_info || hotel.florInfo || {};
            console.log('ü§ñ Cargando informaci√≥n de Flor IA:', florInfo);
            
            const florDescriptionInput = document.getElementById('editHotelFlorDescription');
            const florServicesInput = document.getElementById('editHotelFlorServices');
            const florExcursionsInput = document.getElementById('editHotelFlorExcursions');
            const florPricesInput = document.getElementById('editHotelFlorPrices');
            const florPoliciesInput = document.getElementById('editHotelFlorPolicies');
            const florTransportInput = document.getElementById('editHotelFlorTransport');
            const florContactInput = document.getElementById('editHotelFlorContact');
            
            if (florDescriptionInput) florDescriptionInput.value = florInfo.description || '';
            if (florServicesInput) florServicesInput.value = florInfo.services || '';
            if (florExcursionsInput) florExcursionsInput.value = florInfo.excursions || '';
            if (florPricesInput) florPricesInput.value = florInfo.prices || '';
            if (florPoliciesInput) florPoliciesInput.value = florInfo.policies || '';
            if (florTransportInput) florTransportInput.value = florInfo.transport || '';
            if (florContactInput) florContactInput.value = florInfo.contact || '';
            
            // Cargar im√°genes
            const imageInput = document.getElementById('editHotelImage');
            const photosInput = document.getElementById('editHotelPhotos');
            
            // En Supabase, las im√°genes est√°n en el campo 'images' (JSONB)
            // La primera imagen es la principal, el resto es la galer√≠a
            let mainImage = '';
            let galleryImages = [];
            
            if (hotel.mainImage) {
                // Si existe mainImage (localStorage antiguo)
                mainImage = hotel.mainImage;
                if (hotel.galleryImages && Array.isArray(hotel.galleryImages)) {
                    galleryImages = hotel.galleryImages;
                } else if (hotel.images && Array.isArray(hotel.images)) {
                    galleryImages = hotel.images.slice(1); // Excluir la primera que es mainImage
                }
            } else if (hotel.images && Array.isArray(hotel.images) && hotel.images.length > 0) {
                // Formato Supabase: todas las im√°genes en el array 'images'
                mainImage = hotel.images[0];
                galleryImages = hotel.images.slice(1); // El resto es la galer√≠a
            } else if (hotel.images && typeof hotel.images === 'string') {
                // Formato antiguo: string separado por comas
                const imagesList = hotel.images.split(',').map(img => img.trim()).filter(img => img);
                if (imagesList.length > 0) {
                    mainImage = imagesList[0];
                    galleryImages = imagesList.slice(1);
                }
            }
            
            if (imageInput) {
                imageInput.value = mainImage;
                updateImagePreview();
            }
            if (photosInput) {
                photosInput.value = galleryImages.join('|||');
                updatePhotosPreview();
            }
            
            // Cambiar el t√≠tulo del modal
            const modalTitle = document.querySelector('#editHotelModal h2');
            if (modalTitle) {
                modalTitle.textContent = 'üè® Editar Hotel';
            }
            
            // Guardar hotelId globalmente para acceso desde el gestor de im√°genes
            globalEditingHotelId = hotelId;
            console.log('‚úÖ HotelId guardado globalmente:', globalEditingHotelId);
            
            // Mostrar el modal
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'block';
                
                // Configurar el formulario para modo "editar"
                const form = document.getElementById('editHotelForm');
                if (form) {
                    form.dataset.mode = 'edit';
                    form.dataset.hotelId = hotelId;
                    console.log('‚úÖ Formulario configurado - modo: edit, hotelId:', hotelId);
                    console.log('‚úÖ Dataset del formulario:', {
                        mode: form.dataset.mode,
                        hotelId: form.dataset.hotelId,
                        hotel: {
                            id: hotel.id,
                            name: hotel.name
                        }
                    });
                } else {
                    console.error('‚ùå Formulario editHotelForm no encontrado');
                }
                
                // NOTA: C√≥digo de configuraci√≥n de botones de im√°genes eliminado - los campos fueron removidos
            }
        }

        // Funci√≥n para exportar hoteles
        function exportHotels() {
            // Implementar exportaci√≥n
            console.log('Exportando hoteles...');
        }

        // Funci√≥n para refrescar hoteles
        function refreshHotels() {
            // Implementar refresco
            console.log('Refrescando hoteles...');
        }

        // Funci√≥n para abrir modal de edici√≥n de hotel
        function openEditHotelModal(hotel) {
            // Implementar apertura de modal
            console.log('Abriendo modal de edici√≥n:', hotel);
        }

        // Funci√≥n para cerrar modal de edici√≥n de hotel
        function closeEditHotelModal() {
            const modal = document.getElementById('editHotelModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para obtener coordenadas por defecto seg√∫n el nombre del hotel
        function getDefaultCoordinatesForHotel(hotelName) {
            const coordinatesMap = {
                'Hotel Termas Chill√°n': { lat: -36.6064, lng: -71.2167 },
                'Hotel Terma de Puyehue': { lat: -40.6500, lng: -72.6167 },
                'Hotel Huilo-Huilo': { lat: -39.8500, lng: -71.9000 },
                'Hotel Corralco Resort': { lat: -38.6500, lng: -71.6500 },
                'Hotel Futangue': { lat: -40.3500, lng: -72.4500 },
                'Caba√±as Termas de Aguas Calientes': { lat: -40.735366, lng: -72.307616 }
            };
            
            return coordinatesMap[hotelName] || null;
        }
        
        // Funci√≥n para extraer coordenadas de URL de Google Maps
        function extractCoordinatesFromGoogleMaps(url) {
            if (!url) return null;
            
            try {
                // Patr√≥n 1: URL con coordenadas directas
                // https://maps.google.com/?q=-36.6064,-71.2167
                const coordPattern1 = /q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match1 = url.match(coordPattern1);
                if (match1) {
                    return {
                        lat: parseFloat(match1[1]),
                        lng: parseFloat(match1[2])
                    };
                }
                
                // Patr√≥n 2: URL con coordenadas en formato @lat,lng
                // https://maps.google.com/?q=Hotel+Termas+Chill√°n@-36.6064,-71.2167
                const coordPattern2 = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match2 = url.match(coordPattern2);
                if (match2) {
                    return {
                        lat: parseFloat(match2[1]),
                        lng: parseFloat(match2[2])
                    };
                }
                
                // Patr√≥n 3: URL con coordenadas en formato ll=lat,lng
                // https://maps.google.com/?ll=-36.6064,-71.2167
                const coordPattern3 = /ll=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match3 = url.match(coordPattern3);
                if (match3) {
                    return {
                        lat: parseFloat(match3[1]),
                        lng: parseFloat(match3[2])
                    };
                }
                
                // Patr√≥n 4: URLs modernas de Google Maps (maps.app.goo.gl)
                // https://maps.app.goo.gl/cxC7gREKNFuoiuj4A
                if (url.includes('maps.app.goo.gl') || url.includes('goo.gl/maps')) {
                    console.log('üåê URL moderna de Google Maps detectada, intentando obtener coordenadas...');
                    
                    // Para URLs modernas, necesitamos hacer una petici√≥n HTTP para obtener las coordenadas
                    // Por ahora, mostraremos un mensaje informativo
                    return {
                        lat: null,
                        lng: null,
                        modernUrl: true,
                        message: 'URL moderna de Google Maps detectada. Las coordenadas se extraer√°n autom√°ticamente cuando se guarde el hotel.'
                    };
                }
                
                // Patr√≥n 5: URLs con coordenadas en formato decimal
                // https://maps.google.com/?q=-36.6064,-71.2167&z=15
                const coordPattern5 = /[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/;
                const match5 = url.match(coordPattern5);
                if (match5) {
                    return {
                        lat: parseFloat(match5[1]),
                        lng: parseFloat(match5[2])
                    };
                }
                
                console.log('‚ö†Ô∏è No se pudieron extraer coordenadas de la URL:', url);
                return null;
            } catch (error) {
                console.error('‚ùå Error al extraer coordenadas:', error);
                return null;
            }
        }
        
        // Funci√≥n para mostrar ayuda de Google Maps
        function openGoogleMapsHelp() {
            const helpText = `
üåç <strong>¬øC√≥mo obtener el enlace de Google Maps?</strong>

1. <strong>Busca el hotel</strong> en Google Maps
2. <strong>Haz clic en "Compartir"</strong> (bot√≥n azul)
3. <strong>Selecciona "Copiar enlace"</strong>
4. <strong>Pega el enlace</strong> en el campo de arriba

<strong>Formatos de URL soportados:</strong>

‚úÖ <strong>URL con coordenadas directas:</strong>
https://maps.google.com/?q=-36.6064,-71.2167

‚úÖ <strong>URL con nombre del hotel:</strong>
https://maps.google.com/?q=Hotel+Termas+Chill√°n

‚úÖ <strong>URL moderna (maps.app.goo.gl):</strong>
https://maps.app.goo.gl/cxC7gREKNFuoiuj4A

<strong>üí° Coordenadas se extraer√°n autom√°ticamente para el mapa interactivo!</strong>

<strong>‚ö†Ô∏è Nota:</strong> Las URLs modernas se procesar√°n autom√°ticamente al guardar el hotel.
            `;
            
            alert(helpText);
        }
        
        // Funci√≥n para probar extracci√≥n de coordenadas
        function testCoordinatesExtraction() {
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            if (!googleMapsInput || !googleMapsInput.value) {
                alert('‚ö†Ô∏è Por favor ingresa una URL de Google Maps primero');
                return;
            }
            
            const url = googleMapsInput.value.trim();
            const extractedCoords = extractCoordinatesFromGoogleMaps(url);
            
            if (extractedCoords && extractedCoords.modernUrl) {
                alert(`üåê URL moderna de Google Maps detectada:\n\n${url}\n\n‚úÖ Esta URL ser√° guardada y las coordenadas se extraer√°n autom√°ticamente cuando se guarde el hotel.\n\nüí° Tip: Para obtener coordenadas inmediatas, usa el formato:\nhttps://maps.google.com/?q=-36.6064,-71.2167`);
            } else if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                alert(`‚úÖ Coordenadas extra√≠das exitosamente:\n\nLatitud: ${extractedCoords.lat}\nLongitud: ${extractedCoords.lng}\n\nEstas coordenadas se usar√°n autom√°ticamente en el mapa interactivo.`);
            } else {
                alert(`‚ùå No se pudieron extraer coordenadas de la URL:\n\n${url}\n\nüí° Sugerencias:\n1. Usa el formato: https://maps.google.com/?q=-36.6064,-71.2167\n2. O busca el hotel en Google Maps y copia el enlace completo\n3. Para URLs modernas, las coordenadas se extraer√°n autom√°ticamente al guardar.`);
            }
        }

        // Funci√≥n para guardar cambios del hotel
        async function saveHotelChanges() {
            console.log('üíæ Guardando cambios del hotel...');
            
            const form = document.getElementById('editHotelForm');
            if (!form) {
                console.error('‚ùå Formulario no encontrado');
                return;
            }
            
            // Obtener datos del formulario
            const nameInput = document.getElementById('editHotelName');
            const locationInput = document.getElementById('editHotelLocation');
            const googleMapsInput = document.getElementById('editHotelGoogleMaps');
            const websiteInput = document.getElementById('editHotelWebsite');
            const ratingSelect = document.getElementById('editHotelRating');
            const priceInput = document.getElementById('editHotelPrice');
            const descriptionTextarea = document.getElementById('editHotelDescription');
            const amenitiesInput = document.getElementById('editHotelAmenities');
            const statusSelect = document.getElementById('editHotelStatus');
            if (!nameInput || !locationInput) {
                console.error('‚ùå Campos requeridos no encontrados');
                return;
            }
            
            // Obtener im√°genes del formulario (pueden ser base64 o URLs)
            const imageInput = document.getElementById('editHotelImage');
            const photosInput = document.getElementById('editHotelPhotos');
            let mainImage = imageInput?.value?.trim() || '';
            let galleryImages = getGalleryImagesFromInput();
            
            // Validar tama√±o de im√°genes base64 (localStorage tiene l√≠mite de ~5-10MB por item)
            const maxImageSize = 2 * 1024 * 1024; // 2MB por imagen base64
            if (mainImage && mainImage.startsWith('data:') && mainImage.length > maxImageSize) {
                console.warn('‚ö†Ô∏è Imagen principal muy grande, truncando...');
                alert('‚ö†Ô∏è La imagen principal es muy grande. Considera usar una URL externa o comprimir la imagen.');
            }
            
            // Filtrar im√°genes de galer√≠a que sean demasiado grandes
            galleryImages = galleryImages.filter(img => {
                if (img.startsWith('data:') && img.length > maxImageSize) {
                    console.warn('‚ö†Ô∏è Imagen de galer√≠a muy grande, omitiendo...');
                    return false;
                }
                return true;
            });
            
            // Obtener campos de Flor IA
            const florDescription = document.getElementById('editHotelFlorDescription')?.value?.trim() || '';
            const florServices = document.getElementById('editHotelFlorServices')?.value?.trim() || '';
            const florExcursions = document.getElementById('editHotelFlorExcursions')?.value?.trim() || '';
            const florPrices = document.getElementById('editHotelFlorPrices')?.value?.trim() || '';
            const florPolicies = document.getElementById('editHotelFlorPolicies')?.value?.trim() || '';
            const florTransport = document.getElementById('editHotelFlorTransport')?.value?.trim() || '';
            const florContact = document.getElementById('editHotelFlorContact')?.value?.trim() || '';
            
            const hotelData = {
                name: nameInput.value.trim(),
                location: locationInput.value.trim(),
                googleMaps: googleMapsInput?.value?.trim() || '',
                website: websiteInput?.value?.trim() || '', // URL del sitio web del hotel
                rating: parseInt(ratingSelect?.value || '0'),
                price: priceInput?.value ? parseInt(priceInput.value) : 0,
                description: descriptionTextarea?.value || '',
                amenities: amenitiesInput?.value ? amenitiesInput.value.split(',').map(a => a.trim()) : [],
                status: statusSelect?.value || 'Activo',
                mainImage: mainImage, // Imagen principal (base64 o URL)
                galleryImages: galleryImages, // Galer√≠a de fotos (array de base64 o URLs)
                images: mainImage ? [mainImage, ...galleryImages] : galleryImages, // Compatibilidad con versiones anteriores
                // Campos de informaci√≥n para Flor IA
                florInfo: {
                    description: florDescription,
                    services: florServices,
                    excursions: florExcursions,
                    prices: florPrices,
                    policies: florPolicies,
                    transport: florTransport,
                    contact: florContact
                }
            };
            
            // Extraer coordenadas de Google Maps si est√° disponible
            if (hotelData.googleMaps) {
                const extractedCoords = extractCoordinatesFromGoogleMaps(hotelData.googleMaps);
                if (extractedCoords && extractedCoords.lat && extractedCoords.lng) {
                    hotelData.coordinates = extractedCoords;
                    console.log(`‚úÖ Coordenadas extra√≠das de Google Maps para ${hotelData.name}:`, extractedCoords);
                } else if (extractedCoords && extractedCoords.modernUrl) {
                    console.log(`üåê URL moderna de Google Maps guardada para ${hotelData.name}. Las coordenadas se extraer√°n autom√°ticamente.`);
                    // Para URLs modernas, usamos coordenadas por defecto temporalmente
                    const defaultCoords = getDefaultCoordinatesForHotel(hotelData.name);
                    if (defaultCoords) {
                        hotelData.coordinates = defaultCoords;
                        console.log(`üìç Usando coordenadas por defecto para ${hotelData.name}:`, defaultCoords);
                    }
                }
            }
            
            // Validar campos requeridos
            if (!hotelData.name || !hotelData.location) {
                alert('‚ùå Por favor completa los campos requeridos (Nombre y Ubicaci√≥n)');
                return;
            }
            
            const mode = form.dataset.mode;
            const hotelId = form.dataset.hotelId;
            
            console.log('üìã Modo del formulario:', mode);
            console.log('üìã ID del hotel:', hotelId);
            
            if (!mode) {
                console.error('‚ùå Modo del formulario no definido');
                alert('‚ùå Error: Modo del formulario no definido. Por favor, cierra y vuelve a abrir el formulario.');
                return;
            }
            
            if (mode === 'add') {
                // Agregar nuevo hotel
                try {
                    // Preparar datos para Supabase
                    // NOTA: La tabla hotels solo tiene 'images' (JSONB), no 'mainImage' ni 'galleryImages'
                    // Combinamos mainImage y galleryImages en el campo images
                    const imagesArray = [];
                    if (hotelData.mainImage) {
                        imagesArray.push(hotelData.mainImage);
                    }
                    if (hotelData.galleryImages && Array.isArray(hotelData.galleryImages)) {
                        imagesArray.push(...hotelData.galleryImages);
                    }
                    
                    // Preparar coordenadas (debe ser JSONB o null)
                    let coordinatesData = null;
                    if (hotelData.coordinates) {
                        if (typeof hotelData.coordinates === 'object' && hotelData.coordinates.lat && hotelData.coordinates.lng) {
                            coordinatesData = hotelData.coordinates;
                        } else {
                            coordinatesData = hotelData.coordinates;
                        }
                    }
                    
                    // Preparar amenities (debe ser JSONB array o null)
                    let amenitiesData = null;
                    if (hotelData.amenities && Array.isArray(hotelData.amenities) && hotelData.amenities.length > 0) {
                        amenitiesData = hotelData.amenities;
                    } else if (hotelData.amenities && typeof hotelData.amenities === 'string') {
                        amenitiesData = hotelData.amenities.split(',').map(a => a.trim()).filter(a => a);
                    }
                    
                    const hotelForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description || null,
                        rating: hotelData.rating || 0,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status || 'Activo',
                        amenities: amenitiesData,
                        images: imagesArray.length > 0 ? imagesArray : null,
                        coordinates: coordinatesData,
                        google_maps: hotelData.googleMaps || null,
                        website: hotelData.website || null,
                        flor_info: hotelData.florInfo || null // Informaci√≥n para Flor IA
                    };
                    
                    console.log('üì§ Datos preparados para Supabase (nuevo hotel):', {
                        ...hotelForSupabase,
                        images: imagesArray.length > 0 ? `${imagesArray.length} imagen(es)` : 'vac√≠o',
                        imagesSize: JSON.stringify(imagesArray).length
                    });

                    // Intentar guardar en Supabase primero
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            const savedHotel = await window.supabaseClient.createHotel(hotelForSupabase);
                            console.log('‚úÖ Hotel guardado en Supabase:', savedHotel);
                            alert('‚úÖ Hotel agregado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error guardando en Supabase, guardando en localStorage:', error);
                            // Fallback a localStorage
                const newHotel = {
                                id: Date.now().toString(),
                    ...hotelData,
                    createdAt: new Date().toISOString()
                };
                const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                existingHotels.push(newHotel);
                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                            alert('‚úÖ Hotel agregado correctamente (guardado localmente)');
                        }
                    } else {
                        // Solo localStorage si Supabase no est√° disponible
                        const newHotel = {
                            id: Date.now().toString(),
                            ...hotelData,
                            createdAt: new Date().toISOString()
                        };
                        const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                        existingHotels.push(newHotel);
                        localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                        alert('‚úÖ Hotel agregado correctamente (guardado localmente)');
                    }
                } catch (error) {
                    console.error('‚ùå Error guardando hotel:', error);
                    alert('‚ùå Error al guardar el hotel');
                }
                
            } else if (mode === 'edit') {
                // Editar hotel existente
                if (!hotelId) {
                    console.error('‚ùå ID de hotel no encontrado para edici√≥n');
                    console.error('üìã Form dataset:', {
                        mode: form.dataset.mode,
                        hotelId: form.dataset.hotelId,
                        formId: form.id
                    });
                    alert('‚ùå Error: ID de hotel no encontrado. Por favor, cierra y vuelve a abrir el formulario.');
                    return;
                }
                
                try {
                    // Preparar datos para Supabase
                    // NOTA: La tabla hotels solo tiene 'images' (JSONB), no 'mainImage' ni 'galleryImages'
                    // Combinamos mainImage y galleryImages en el campo images
                    const imagesArray = [];
                    if (hotelData.mainImage) {
                        imagesArray.push(hotelData.mainImage);
                    }
                    if (hotelData.galleryImages && Array.isArray(hotelData.galleryImages)) {
                        imagesArray.push(...hotelData.galleryImages);
                    }
                    
                    // Preparar coordenadas (debe ser JSONB o null)
                    let coordinatesData = null;
                    if (hotelData.coordinates) {
                        if (typeof hotelData.coordinates === 'object' && hotelData.coordinates.lat && hotelData.coordinates.lng) {
                            coordinatesData = hotelData.coordinates;
                        } else {
                            coordinatesData = hotelData.coordinates;
                        }
                    }
                    
                    // Preparar amenities (debe ser JSONB array o null)
                    let amenitiesData = null;
                    if (hotelData.amenities && Array.isArray(hotelData.amenities) && hotelData.amenities.length > 0) {
                        amenitiesData = hotelData.amenities;
                    } else if (hotelData.amenities && typeof hotelData.amenities === 'string') {
                        amenitiesData = hotelData.amenities.split(',').map(a => a.trim()).filter(a => a);
                    }
                    
                    const updatesForSupabase = {
                        name: hotelData.name,
                        location: hotelData.location,
                        description: hotelData.description || null,
                        rating: hotelData.rating || 0,
                        price: parseFloat(String(hotelData.price).replace(/[^0-9.-]/g, '')) || 0,
                        status: hotelData.status || 'Activo',
                        amenities: amenitiesData,
                        images: imagesArray.length > 0 ? imagesArray : null,
                        coordinates: coordinatesData,
                        google_maps: hotelData.googleMaps || null,
                        website: hotelData.website || null,
                        flor_info: hotelData.florInfo || null // Informaci√≥n para Flor IA
                    };
                    
                    console.log('üì§ Datos preparados para Supabase:', {
                        ...updatesForSupabase,
                        images: imagesArray.length > 0 ? `${imagesArray.length} imagen(es)` : 'vac√≠o',
                        imagesSize: JSON.stringify(imagesArray).length
                    });

                    // Intentar actualizar en Supabase primero
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            // Convertir hotelId a n√∫mero si es necesario (Supabase usa IDs num√©ricos)
                            const numericHotelId = isNaN(parseInt(hotelId)) ? hotelId : parseInt(hotelId);
                            console.log('üîÑ Actualizando hotel en Supabase, ID:', numericHotelId, 'Tipo:', typeof numericHotelId);
                            
                            await window.supabaseClient.updateHotel(numericHotelId, updatesForSupabase);
                            console.log('‚úÖ Hotel actualizado en Supabase');
                            
                            // Tambi√©n actualizar localStorage para que Flor pueda usar los datos
                            const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotelIndex = existingHotels.findIndex(h => h.id == hotelId || h.id === numericHotelId);
                            if (hotelIndex !== -1) {
                                existingHotels[hotelIndex] = {
                                    ...existingHotels[hotelIndex],
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                };
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                console.log('‚úÖ localStorage tambi√©n actualizado');
                            } else {
                                // Si no existe en localStorage, agregarlo
                                existingHotels.push({
                                    id: numericHotelId,
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                });
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                console.log('‚úÖ Hotel agregado a localStorage');
                            }
                            
                            alert('‚úÖ Hotel actualizado correctamente (guardado en la nube)');
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error actualizando en Supabase, actualizando en localStorage:', error);
                            // Fallback a localStorage
                            try {
                                const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                                const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                                if (hotelIndex !== -1) {
                                    existingHotels[hotelIndex] = {
                                        ...existingHotels[hotelIndex],
                                        ...hotelData,
                                        updatedAt: new Date().toISOString()
                                    };
                                    localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                    alert('‚úÖ Hotel actualizado correctamente (guardado localmente)');
                                } else {
                                    console.error('‚ùå Hotel no encontrado para editar en localStorage');
                                    alert('‚ùå Error: Hotel no encontrado');
                                }
                            } catch (localError) {
                                console.error('‚ùå Error guardando en localStorage:', localError);
                                throw new Error(`Error guardando en localStorage: ${localError.message}`);
                            }
                        }
                    } else {
                        // Solo localStorage si Supabase no est√° disponible
                        try {
                            const existingHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotelIndex = existingHotels.findIndex(h => h.id === hotelId);
                            if (hotelIndex !== -1) {
                                existingHotels[hotelIndex] = {
                                    ...existingHotels[hotelIndex],
                                    ...hotelData,
                                    updatedAt: new Date().toISOString()
                                };
                                localStorage.setItem('hotelsDB', JSON.stringify(existingHotels));
                                alert('‚úÖ Hotel actualizado correctamente (guardado localmente)');
                            } else {
                                console.error('‚ùå Hotel no encontrado para editar');
                                alert('‚ùå Error: Hotel no encontrado');
                            }
                        } catch (localError) {
                            console.error('‚ùå Error guardando en localStorage:', localError);
                            throw new Error(`Error guardando en localStorage: ${localError.message}`);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error actualizando hotel:', error);
                    const errorMessage = error?.message || error?.toString() || 'Error desconocido';
                    console.error('üìã Detalles del error:', {
                        error,
                        hotelId,
                        hotelData: {
                            ...hotelData,
                            mainImage: hotelData.mainImage ? `${hotelData.mainImage.substring(0, 50)}...` : 'vac√≠o',
                            galleryImages: hotelData.galleryImages?.length || 0
                        }
                    });
                    alert(`‚ùå Error al actualizar el hotel\n\n${errorMessage}\n\nRevisa la consola para m√°s detalles.`);
                }
            } else {
                console.error('‚ùå Modo de formulario desconocido:', mode);
                alert(`‚ùå Error: Modo de formulario desconocido (${mode}). Por favor, cierra y vuelve a abrir el formulario.`);
            }
            
            // Cerrar modal
            closeEditHotelModal();
            
            // Actualizar tabla y estad√≠sticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
            
            // Notificar actualizaci√≥n del mapa interactivo
            console.log('üó∫Ô∏è Notificando actualizaci√≥n del mapa interactivo...');
            window.dispatchEvent(new CustomEvent('hotelsMapUpdated', {
                detail: { 
                    hotelId: hotelId || newHotel?.id, 
                    coordinates: hotelData.coordinates,
                    hotelName: hotelData.name 
                }
            }));
            
            // Actualizar la tabla y estad√≠sticas
            if (typeof loadHotelsTable === 'function') {
                loadHotelsTable();
            }
            if (typeof updateHotelsStats === 'function') {
                updateHotelsStats();
            }
        }

        // Funci√≥n para abrir modal de vista previa de im√°genes
        function openImagePreviewModal() {
            // Implementar apertura de modal
            console.log('Abriendo modal de vista previa...');
        }

        // Funci√≥n para cerrar modal de vista previa de im√°genes
        function closeImagePreviewModal() {
            const modal = document.getElementById('imagePreviewModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para inicializar base de datos de clientes
        function initClientesDB() {
            // Implementar inicializaci√≥n
            console.log('Inicializando base de datos de clientes...');
        }

        // Funci√≥n para inicializar base de datos de hoteles (duplicada - eliminada)

        // Funci√≥n para buscar cliente por email
        function buscarClientePorEmail(email) {
            // Implementar b√∫squeda
            console.log('Buscando cliente por email:', email);
            return null;
        }

        // Funci√≥n para validar email
        function validarEmail(email) {
            // Implementar validaci√≥n
            console.log('Validando email:', email);
            return true;
        }

        // Funci√≥n de logout (reemplazada por la nueva implementaci√≥n arriba)

        // Funci√≥n para actualizar dashboard para usuario logueado
        function updateDashboardForLoggedInUser() {
            // Implementar actualizaci√≥n
            console.log('Actualizando dashboard para usuario logueado...');
        }

        // Funci√≥n para cargar contenido del dashboard
        function loadDashboardContent() {
            // Implementar carga de contenido
            console.log('Cargando contenido del dashboard...');
        }

        // Funci√≥n para restaurar secciones del dashboard
        function restoreDashboardSections() {
            // Implementar restauraci√≥n
            console.log('Restaurando secciones del dashboard...');
        }

        // Funci√≥n para actualizar dashboard para usuario deslogueado
        function updateDashboardForLoggedOutUser() {
            // Implementar actualizaci√≥n
            console.log('Actualizando dashboard para usuario deslogueado...');
        }

        // Funci√≥n para actualizar estad√≠sticas personales
        function updatePersonalStats() {
            // Implementar estad√≠sticas personales
            console.log('Actualizando estad√≠sticas personales...');
        }

        // Funci√≥n para mostrar pantalla de login
        function showLoginScreen() {
            // Implementar pantalla de login
            console.log('Mostrando pantalla de login...');
        }

        // Funci√≥n para mostrar formulario de registro
        function showRegisterForm() {
            // Implementar formulario de registro
            console.log('Mostrando formulario de registro...');
        }

        // ============================================
        // SOBRESCRIBIR BOTONES DE IMAGENES - EVITA CACHE
        // ============================================
        function sobrescribirBotonesImagenes() {
            // Buscar todos los botones que abren el gestor de im√°genes
            const buttons = document.querySelectorAll('button[onclick*="imageManager"], button[onclick*="abrirModal"], button[onclick*="openImage"]');
            
            buttons.forEach(function(btn) {
                // Verificar si el bot√≥n tiene el texto "Seleccionar" y un √≠cono folder_open
                const icon = btn.querySelector('.material-icons');
                if (icon && icon.textContent === 'folder_open') {
                    btn.onclick = function() {
                        console.log('üöÄ Bot√≥n clickeado - Abriendo modal directamente');
                        var modal = document.getElementById('imageManagerModal');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.style.zIndex = '99999';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                            console.log('‚úÖ Modal abierto - Display:', modal.style.display);
                            
                            // Configurar nombre del hotel
                            var hotelNameSpan = document.getElementById('currentHotelName');
                            if (hotelNameSpan) {
                                var nameInput = document.getElementById('editHotelName');
                                hotelNameSpan.textContent = (nameInput && nameInput.value) || 'Nuevo Hotel';
                            }
                        } else {
                            alert('ERROR: Modal no encontrado. Por favor, recarga la p√°gina.');
                        }
                    };
                    console.log('‚úÖ Bot√≥n sobrescrito:', btn);
                }
            });
        }

        // ===== SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL =====
        
        // Mostrar notificaci√≥n de actualizaci√≥n
        function showRealtimeNotification(message, type = 'info') {
            // Crear notificaci√≥n
            const notification = document.createElement('div');
            notification.className = 'realtime-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'info' ? '#2196f3' : type === 'success' ? '#4caf50' : '#ff9800'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <span class="material-icons" style="font-size: 24px;">sync</span>
                <div>
                    <strong style="display: block; margin-bottom: 4px;">Actualizaci√≥n en tiempo real</strong>
                    <span style="font-size: 0.9rem;">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Agregar animaci√≥n CSS si no existe
            if (!document.getElementById('realtime-notification-styles')) {
                const style = document.createElement('style');
                style.id = 'realtime-notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        // Inicializar suscripciones en tiempo real
        function initRealtimeSubscriptions() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.warn('‚ö†Ô∏è Supabase no est√° listo para tiempo real');
                return;
            }
            
            console.log('üîÑ Iniciando sincronizaci√≥n en tiempo real...');
            
            // Variable para evitar recargas m√∫ltiples
            let reloadTimeout = null;
            
            function scheduleReload(sectionId, message) {
                if (reloadTimeout) clearTimeout(reloadTimeout);
                reloadTimeout = setTimeout(() => {
                    // Recargar la secci√≥n correspondiente
                    switch(sectionId) {
                        case 'hotels':
                            if (typeof loadHotelsTable === 'function') loadHotelsTable();
                            break;
                        case 'reservations':
                            if (typeof loadReservations === 'function') loadReservations();
                            break;
                        case 'quotes':
                            if (typeof loadQuotes === 'function') loadQuotes();
                            break;
                        case 'users':
                            if (typeof loadUsersData === 'function') loadUsersData();
                            break;
                        case 'expenses':
                            if (typeof loadExpenses === 'function') loadExpenses();
                            break;
                    }
                    showRealtimeNotification(message, 'info');
                }, 500);
            }
            
            // Suscribirse a cambios en hoteles
            window.supabaseClient.subscribeToHotels((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                scheduleReload('hotels', `Se ${action} un hotel`);
            });
            
            // Suscribirse a cambios en reservaciones
            window.supabaseClient.subscribeToReservations((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                scheduleReload('reservations', `Se ${action} una reserva`);
            });
            
            // Suscribirse a cambios en cotizaciones
            window.supabaseClient.subscribeToQuotes((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                scheduleReload('quotes', `Se ${action} una cotizaci√≥n`);
            });
            
            // Suscribirse a cambios en usuarios
            window.supabaseClient.subscribeToUsers((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                scheduleReload('users', `Se ${action} un usuario`);
            });
            
            // Suscribirse a cambios en gastos
            window.supabaseClient.subscribeToExpenses((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                scheduleReload('expenses', `Se ${action} un gasto`);
            });
            
            // Suscribirse a cambios en agentes
            window.supabaseClient.subscribeToAgents((payload) => {
                const action = payload.eventType === 'INSERT' ? 'agreg√≥' : 
                               payload.eventType === 'UPDATE' ? 'actualiz√≥' : 'elimin√≥';
                // Recargar reservaciones ya que los agentes se usan ah√≠
                scheduleReload('reservations', `Se ${action} un agente`);
            });
            
            console.log('‚úÖ Sincronizaci√≥n en tiempo real activa');
            
            // Mostrar indicador de conexi√≥n en tiempo real
            showRealtimeIndicator();
        }
        
        // Mostrar indicador de conexi√≥n en tiempo real en la UI
        function showRealtimeIndicator() {
            // Agregar indicador al header si no existe
            if (!document.getElementById('realtime-indicator')) {
                const header = document.querySelector('.dashboard-header') || document.querySelector('.main-header');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.id = 'realtime-indicator';
                    indicator.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        background: rgba(76, 175, 80, 0.2);
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 0.85rem;
                        color: #4caf50;
                        margin-left: auto;
                    `;
                    indicator.innerHTML = `
                        <span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
                        <span>Tiempo real</span>
                    `;
                    
                    // Agregar animaci√≥n de pulso
                    if (!document.getElementById('pulse-animation')) {
                        const style = document.createElement('style');
                        style.id = 'pulse-animation';
                        style.textContent = `
                            @keyframes pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.5; }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    header.appendChild(indicator);
                }
            }
        }
        
        // Hacer funciones globales
        window.initRealtimeSubscriptions = initRealtimeSubscriptions;
        window.showRealtimeNotification = showRealtimeNotification;
        
        // ===== FUNCIONES DE FECHA/HORA ARGENTINA =====
        
        // Obtener fecha actual de Argentina en formato YYYY-MM-DD
        function getArgentinaDateString() {
            return new Date().toLocaleDateString('en-CA', { 
                timeZone: 'America/Argentina/Buenos_Aires' 
            });
        }
        
        // Obtener fecha y hora de Argentina formateada
        function getArgentinaDateTime() {
            return new Date().toLocaleString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Formatear fecha para mostrar (de string a formato legible)
        function formatDateArgentina(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Formatear fecha y hora para mostrar
        function formatDateTimeArgentina(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('es-AR', { 
                timeZone: 'America/Argentina/Buenos_Aires',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Hacer funciones globales
        window.getArgentinaDateString = getArgentinaDateString;
        window.getArgentinaDateTime = getArgentinaDateTime;
        window.formatDateArgentina = formatDateArgentina;
        window.formatDateTimeArgentina = formatDateTimeArgentina;

        // Event listener para cuando el DOM est√© listo
        // IMPORTANTE: Este c√≥digo se ejecuta DESPU√âS de la verificaci√≥n de autenticaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard DOMContentLoaded ejecutado');
            
            // Sobrescribir botones inmediatamente
            sobrescribirBotonesImagenes();
            
            // Tambi√©n sobrescribir despu√©s de un peque√±o delay por si el HTML se carga despu√©s
            setTimeout(sobrescribirBotonesImagenes, 500);
            setTimeout(sobrescribirBotonesImagenes, 1000);
            setTimeout(sobrescribirBotonesImagenes, 2000);
            
            // CONFIGURAR EVENT LISTENERS DEL MODAL DE IM√ÅGENES
            setTimeout(function() {
                // Bot√≥n cerrar modal
                const btnClose = document.getElementById('btnCloseImageManager');
                if (btnClose) {
                    btnClose.onclick = closeImageManagerSimple;
                }
                
                // Bot√≥n cancelar
                const btnCancel = document.getElementById('btnCancelImageManager');
                if (btnCancel) {
                    btnCancel.onclick = closeImageManagerSimple;
                }
                
                // Bot√≥n subir im√°genes
                const btnUpload = document.getElementById('btnUploadImages');
                if (btnUpload) {
                    btnUpload.onclick = uploadImagesSimple;
                }
                
                // Bot√≥n aplicar selecci√≥n
                const btnApply = document.getElementById('btnApplyImageSelection');
                if (btnApply) {
                    btnApply.onclick = applyImageSelectionSimple;
                }
                
                // NOTA: C√≥digo de botones de im√°genes eliminado - los campos fueron removidos
                
                console.log('‚úÖ Event listeners del modal de im√°genes configurados');
            }, 500);
            
            // Verificar si hay sesi√≥n v√°lida
            const authSession = localStorage.getItem('dashboard_auth_session');
            let isAuthenticated = false;
            
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        isAuthenticated = true;
                    } else {
                        localStorage.removeItem('dashboard_auth_session');
                    }
                } catch (e) {
                    localStorage.removeItem('dashboard_auth_session');
                }
            }
            
            // Solo inicializar el dashboard si el usuario est√° autenticado
            if (isAuthenticated) {
                console.log('‚úÖ Usuario autenticado, inicializando dashboard...');
            // Inicializar dashboard
                if (typeof initializeDashboard === 'function') {
            initializeDashboard();
                }
            
            // Configurar sincronizaci√≥n autom√°tica
                if (typeof setupAutoSync === 'function') {
            setupAutoSync();
                }
            
            console.log('‚úÖ Dashboard inicializado correctamente');
            } else {
                console.log('üîí Usuario no autenticado, NO inicializando dashboard');
                // Asegurar que el dashboard est√© oculto
                const dashboardContent = document.getElementById('dashboardContent');
                const loginContainer = document.getElementById('loginContainer');
                if (dashboardContent) dashboardContent.classList.remove('authenticated');
                if (loginContainer) loginContainer.classList.remove('hidden');
            }
        });

        // Funci√≥n para cargar configuraci√≥n de IA desde Supabase
        async function loadAIConfigFromSupabase() {
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    const { data, error } = await window.supabaseClient.client
                        .from('system_config')
                        .select('value')
                        .eq('key', 'flor_ai_config')
                        .single();
                    
                    if (!error && data && data.value) {
                        const cloudConfig = JSON.parse(data.value);
                        // Guardar en localStorage
                        localStorage.setItem('flor_ai_config', JSON.stringify(cloudConfig));
                        console.log('‚òÅÔ∏è Configuraci√≥n de IA cargada desde Supabase');
                        
                        // Actualizar campos del formulario si est√°n visibles
                        if (document.getElementById('ai-enabled')) {
                            document.getElementById('ai-enabled').checked = cloudConfig.enabled || false;
                        }
                        if (document.getElementById('ai-provider')) {
                            document.getElementById('ai-provider').value = cloudConfig.provider || 'gemini';
                        }
                        if (document.getElementById('ai-api-key')) {
                            document.getElementById('ai-api-key').value = cloudConfig.apiKey || '';
                        }
                        if (document.getElementById('ai-model')) {
                            document.getElementById('ai-model').value = cloudConfig.model || 'gemini-2.5-flash';
                        }
                    }
                }
            } catch (e) {
                console.log('‚ÑπÔ∏è Usando configuraci√≥n de IA local');
            }
        }

        // Funci√≥n para configurar sincronizaci√≥n autom√°tica
        function setupAutoSync() {
            console.log('üîÑ Configurando sincronizaci√≥n autom√°tica...');
            
            // Cargar configuraci√≥n de IA desde Supabase
            loadAIConfigFromSupabase();
            
            // Cargar datos iniciales
            loadUsersData();
            
            // Configurar listener para cambios en localStorage
            window.addEventListener('storage', function(e) {
                if (e.key === 'checkin24hs_users') {
                    console.log('üîÑ Cambio detectado en usuarios, actualizando dashboard...');
                    loadUsersData();
                }
                if (e.key === 'agentsDB') {
                    console.log('üîÑ Cambio detectado en agentes, actualizando dashboard...');
                    if (typeof loadAgentsTable === 'function' && document.getElementById('agents-section')?.style.display !== 'none') {
                        loadAgentsTable();
                    }
                    if (typeof loadAgentsForNewReservation === 'function') {
                        loadAgentsForNewReservation();
                    }
                }
            });
            
            // Sincronizaci√≥n autom√°tica cada 30 segundos
            setInterval(() => {
                console.log('üîÑ Sincronizaci√≥n autom√°tica...');
                loadUsersData();
            }, 30000);
            
            // Configurar suscripciones en tiempo real de Supabase
            setupRealtimeSubscriptions();
            
            console.log('‚úÖ Sincronizaci√≥n autom√°tica configurada');
        }
        
        // Configurar suscripciones en tiempo real de Supabase
        function setupRealtimeSubscriptions() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.log('‚ö†Ô∏è Supabase no inicializado, no se pueden configurar suscripciones en tiempo real');
                return;
            }
            
            console.log('üîÑ Configurando suscripciones en tiempo real...');
            
            // Suscripci√≥n a cambios en agentes
            window.supabaseClient.subscribeToAgents((payload) => {
                console.log('üîÑ Cambio en agentes detectado:', payload.eventType);
                
                // Recargar tabla de agentes si est√° visible
                if (document.getElementById('agents-section')?.style.display !== 'none') {
                    if (typeof loadAgentsTable === 'function') {
                        loadAgentsTable();
                    }
                }
                
                // Actualizar select de agentes
                if (typeof loadAgentsForNewReservation === 'function') {
                    loadAgentsForNewReservation();
                }
            });
            
            // Suscripci√≥n a cambios en reservas
            window.supabaseClient.subscribeToReservations((payload) => {
                console.log('üîÑ Cambio en reservas detectado:', payload.eventType);
                
                // Recargar tabla de reservas si est√° visible
                if (document.getElementById('reservations-section')?.style.display !== 'none') {
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                }
                
                // Tambi√©n actualizar el dashboard
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            });
            
            // Suscripci√≥n a cambios en hoteles
            window.supabaseClient.subscribeToHotels((payload) => {
                console.log('üîÑ Cambio en hoteles detectado:', payload.eventType);
                
                // Recargar tabla de hoteles si est√° visible
                if (document.getElementById('hotels-section')?.style.display !== 'none') {
                    if (typeof loadHotelsTable === 'function') {
                        loadHotelsTable();
                    }
                }
            });
            
            // Suscripci√≥n a cambios en gastos
            window.supabaseClient.subscribeToExpenses((payload) => {
                console.log('üîÑ Cambio en gastos detectado:', payload.eventType);
                
                // Recargar datos de gastos si la secci√≥n est√° visible
                if (document.getElementById('expenses-section')?.style.display !== 'none') {
                    if (typeof loadExpensesData === 'function') {
                        loadExpensesData();
                    }
                }
            });
            
            console.log('‚úÖ Suscripciones en tiempo real configuradas');
        }

        // Funci√≥n para abrir base de datos de usuarios
        function openUserDatabase() {
            // Implementar apertura de base de datos
            console.log('Abriendo base de datos de usuarios...');
        }

        // Funci√≥n para exportar usuarios
        // Funci√≥n para exportar usuarios
        function exportUsers() {
            console.log('üì§ Exportando usuarios...');
            
            try {
                // Cargar usuarios
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                
                if (users.length === 0) {
                    alert('‚ùå No hay usuarios para exportar');
                    return;
                }
                
                // Preparar datos para exportar
                const exportData = users.map(user => ({
                    nombre: user.name || '',
                    apellido: user.lastName || '',
                    email: user.email || '',
                    telefono: user.phone || '',
                    estado: user.status || 'active',
                    fecha_registro: user.createdAt || user.fechaRegistro || '',
                    tipo_cuenta: user.tipoCuenta || 'registrado'
                }));
                
                // Crear CSV
                const headers = ['nombre', 'apellido', 'email', 'telefono', 'estado', 'fecha_registro', 'tipo_cuenta'];
                let csv = headers.join(',') + '\n';
                
                exportData.forEach(user => {
                    const row = headers.map(header => {
                        const value = user[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    });
                    csv += row.join(',') + '\n';
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `usuarios_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ ${users.length} usuarios exportados exitosamente`);
                
            } catch (error) {
                console.error('Error exportando usuarios:', error);
                alert('‚ùå Error al exportar usuarios: ' + error.message);
            }
        }

        // Funci√≥n para refrescar usuarios
        function refreshUsers() {
            loadUsersData();
            alert('‚úÖ Usuarios actualizados');
        }
        
        // Funci√≥n para restaurar usuarios desde Supabase
        async function restoreUsersFromSupabase() {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                alert('‚ùå Supabase no est√° inicializado');
                return;
            }
            
            try {
                console.log('üîÑ Restaurando usuarios desde Supabase...');
                
                let allUsers = [];
                
                // Intentar cargar de la tabla 'users'
                try {
                    const { data: usersData, error: usersError } = await window.supabaseClient.client
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!usersError && usersData && usersData.length > 0) {
                        console.log(`‚òÅÔ∏è Tabla 'users': ${usersData.length} registros`);
                        allUsers = [...allUsers, ...usersData];
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error en tabla users:', e);
                }
                
                // Intentar cargar de la tabla 'system_users'
                try {
                    const { data: systemUsersData, error: systemUsersError } = await window.supabaseClient.client
                        .from('system_users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!systemUsersError && systemUsersData && systemUsersData.length > 0) {
                        console.log(`‚òÅÔ∏è Tabla 'system_users': ${systemUsersData.length} registros`);
                        // Solo agregar usuarios que no est√©n ya en la lista
                        systemUsersData.forEach(sysUser => {
                            const exists = allUsers.find(u => u.email === sysUser.email);
                            if (!exists) {
                                allUsers.push(sysUser);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error en tabla system_users:', e);
                }
                
                if (allUsers.length === 0) {
                    alert('‚ö†Ô∏è No se encontraron usuarios en Supabase.\n\nPuede que los usuarios solo est√©n en localStorage local.');
                    return;
                }
                
                // Convertir a formato consistente
                const normalizedUsers = allUsers.map(u => ({
                    id: u.id,
                    name: u.name || u.nombre || '',
                    email: u.email,
                    phone: u.phone || u.telefono || '',
                    status: u.is_active !== false ? 'active' : 'inactive',
                    is_active: u.is_active !== false,
                    createdAt: u.created_at || new Date().toISOString(),
                    last_activity: u.last_activity || u.updated_at,
                    tipoCuenta: u.tipo_cuenta || 'registrado',
                    birthDay: u.birth_day,
                    birthMonth: u.birth_month,
                    totalQuotes: u.total_quotes || 0
                }));
                
                // Guardar en localStorage
                localStorage.setItem('checkin24hs_users', JSON.stringify(normalizedUsers));
                
                // Actualizar variable global
                allUsersData = normalizedUsers;
                
                // Recargar tabla
                loadUsersTable(normalizedUsers.slice(0, 20));
                updateDashboardStats(normalizedUsers);
                
                alert(`‚úÖ ${normalizedUsers.length} usuarios restaurados desde Supabase`);
                console.log('‚úÖ Usuarios restaurados:', normalizedUsers.length);
                
            } catch (error) {
                console.error('‚ùå Error restaurando usuarios:', error);
                alert('‚ùå Error al restaurar usuarios: ' + error.message);
            }
        }
        
        // Funci√≥n para mostrar modal de importar usuarios
        window.showImportUsersModal = function() {
            console.log('üì• Abriendo modal de importar usuarios...');
            
            const modal = document.getElementById('importUsersModal');
            if (!modal) {
                alert('‚ùå Error: Modal no encontrado');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('importUsersForm').reset();
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('fileFormat').value = 'auto';
            
            // Agregar evento para vista previa
            const fileInput = document.getElementById('usersFile');
            fileInput.removeEventListener('change', previewImportFile);
            fileInput.addEventListener('change', previewImportFile);
            
            // Mostrar modal
            modal.style.display = 'flex';
        }
        
        // Funci√≥n para cerrar modal de importar usuarios
        function closeImportUsersModal() {
            const modal = document.getElementById('importUsersModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para previsualizar archivo antes de importar
        function previewImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const format = document.getElementById('fileFormat').value;
                
                try {
                    let preview = '';
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        const data = JSON.parse(content);
                        const previewData = Array.isArray(data) ? data.slice(0, 3) : [data];
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${JSON.stringify(previewData, null, 2)}</pre>`;
                        if ((Array.isArray(data) ? data.length : 1) > 3) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y ${(Array.isArray(data) ? data.length : 1) - 3} m√°s</p>`;
                        }
                    } else {
                        const lines = content.split('\n').slice(0, 5);
                        preview = `<pre style="font-size: 0.8rem; white-space: pre-wrap;">${lines.join('\n')}</pre>`;
                        if (content.split('\n').length > 5) {
                            preview += `<p style="color: #666; font-size: 0.85rem;">... y m√°s l√≠neas</p>`;
                        }
                    }
                    
                    document.getElementById('previewContent').innerHTML = preview;
                    document.getElementById('importPreview').style.display = 'block';
                } catch (error) {
                    console.error('Error en vista previa:', error);
                    document.getElementById('previewContent').innerHTML = `<p style="color: #dc3545;">Error al leer el archivo: ${error.message}</p>`;
                    document.getElementById('importPreview').style.display = 'block';
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Funci√≥n para importar usuarios
        function importUsers(event) {
            event.preventDefault();
            console.log('üì• Importando usuarios...');
            
            const fileInput = document.getElementById('usersFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ùå Por favor selecciona un archivo');
                return;
            }
            
            const format = document.getElementById('fileFormat').value;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importedUsers = [];
                    const content = e.target.result;
                    
                    // Parsear seg√∫n el formato
                    if (format === 'json' || (format === 'auto' && file.name.endsWith('.json'))) {
                        importedUsers = JSON.parse(content);
                        if (!Array.isArray(importedUsers)) {
                            importedUsers = [importedUsers];
                        }
                    } else {
                        // Parsear CSV
                        importedUsers = parseCSV(content);
                    }
                    
                    if (importedUsers.length === 0) {
                        alert('‚ùå El archivo no contiene usuarios v√°lidos');
                        return;
                    }
                    
                    // Procesar e importar usuarios
                    processImportedUsers(importedUsers);
                    
                } catch (error) {
                    console.error('Error importando usuarios:', error);
                    alert('‚ùå Error al procesar el archivo: ' + error.message);
                }
            };
            
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        // Funci√≥n para parsear CSV
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            // Detectar delimitador
            const delimiter = csvContent.includes(';') ? ';' : ',';
            
            // Obtener headers
            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            
            // Parsear datos
            const users = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                if (values.length === 0 || values.every(v => !v)) continue;
                
                const user = {};
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    // Mapear headers comunes
                    if (header.includes('nombre') || header.includes('name')) {
                        user.name = value;
                    } else if (header.includes('email') || header.includes('correo')) {
                        user.email = value;
                    } else if (header.includes('telefono') || header.includes('phone') || header.includes('tel')) {
                        user.phone = value;
                    } else if (header.includes('apellido') || header.includes('lastname') || header.includes('surname')) {
                        user.lastName = value;
                    } else {
                        user[header] = value;
                    }
                });
                
                if (user.name || user.email || user.phone) {
                    users.push(user);
                }
            }
            
            return users;
        }
        
        // Funci√≥n para procesar usuarios importados con validaci√≥n de duplicados
        function processImportedUsers(importedUsers) {
            console.log('üîÑ Procesando usuarios importados:', importedUsers.length);
            
            // Cargar usuarios existentes
            const existingUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            
            let added = 0;
            let skipped = 0;
            const errors = [];
            
            importedUsers.forEach((importedUser, index) => {
                try {
                    // Validar que tenga nombre y (email o tel√©fono)
                    if (!importedUser.name && !importedUser.nombre) {
                        errors.push(`Fila ${index + 1}: Falta el nombre`);
                        skipped++;
                        return;
                    }
                    
                    const name = importedUser.name || importedUser.nombre || '';
                    const email = (importedUser.email || importedUser.correo || '').toLowerCase().trim();
                    const phone = (importedUser.phone || importedUser.telefono || importedUser.tel || '').trim();
                    
                    if (!email && !phone) {
                        errors.push(`Fila ${index + 1}: Falta email y tel√©fono`);
                        skipped++;
                        return;
                    }
                    
                    // Buscar duplicados
                    let duplicate = null;
                    
                    if (email) {
                        // Buscar por email
                        duplicate = existingUsers.find(u => u.email && u.email.toLowerCase().trim() === email);
                        if (duplicate) {
                            console.log(`‚ö†Ô∏è Usuario con email ${email} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    if (!email && phone) {
                        // Si no hay email, buscar por tel√©fono
                        const cleanPhone = phone.replace(/\D/g, '');
                        duplicate = existingUsers.find(u => {
                            if (!u.phone) return false;
                            const existingPhone = u.phone.replace(/\D/g, '');
                            return existingPhone === cleanPhone;
                        });
                        
                        if (duplicate) {
                            console.log(`‚ö†Ô∏è Usuario con tel√©fono ${phone} ya existe, se mantiene el original`);
                            skipped++;
                            return;
                        }
                    }
                    
                    // Crear nuevo usuario
                    const newUser = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: name,
                        email: email || null,
                        phone: phone || null,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        tipoCuenta: 'importado',
                        source: 'import'
                    };
                    
                    // Agregar apellido si existe
                    if (importedUser.lastName || importedUser.apellido) {
                        newUser.lastName = importedUser.lastName || importedUser.apellido;
                        newUser.name = `${name} ${newUser.lastName}`.trim();
                    }
                    
                    existingUsers.push(newUser);
                    added++;
                    
                } catch (error) {
                    console.error(`Error procesando usuario ${index + 1}:`, error);
                    errors.push(`Fila ${index + 1}: ${error.message}`);
                    skipped++;
                }
            });
            
            // Guardar usuarios actualizados
            localStorage.setItem('checkin24hs_users', JSON.stringify(existingUsers));
            
            // Mostrar resumen
            let message = `‚úÖ Importaci√≥n completada:\n\n`;
            message += `‚Ä¢ Agregados: ${added}\n`;
            message += `‚Ä¢ Omitidos (duplicados): ${skipped}\n`;
            if (errors.length > 0) {
                message += `‚Ä¢ Errores: ${errors.length}\n\n`;
                message += `Errores:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) message += `\n... y ${errors.length - 5} m√°s`;
            }
            
            alert(message);
            
            // Cerrar modal
            closeImportUsersModal();
            
            // Actualizar tabla
            loadUsersData();
            
            console.log(`‚úÖ Importaci√≥n: ${added} agregados, ${skipped} omitidos`);
        }

        // Funci√≥n para crear usuario de prueba
        function createTestUser() {
            // Implementar creaci√≥n de usuario de prueba
            console.log('Creando usuario de prueba...');
        }

        // Funci√≥n para crear usuarios de prueba
        function crearUsuariosPrueba() {
            // Implementar creaci√≥n de usuarios de prueba
            console.log('Creando usuarios de prueba...');
        }

        // Funci√≥n para mostrar promociones de hoteles
        window.showHotelPromotions = function() {
            console.log('üè® Mostrando promociones de hoteles...');
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            if (hotels.length === 0) {
                alert('No hay hoteles registrados. Primero agregue al menos un hotel.');
                return;
            }
            
            // Mostrar modal de promociones
            if (typeof showHotelPromotionsModal === 'function') {
                showHotelPromotionsModal(hotels);
            } else {
                console.error('showHotelPromotionsModal no est√° definida');
            }
        };
        
        // Funci√≥n para cambiar entre pesta√±as de Hoteles
        function showHotelsTab(tab) {
            console.log('üîÑ Cambiando a pesta√±a:', tab);
            
            // Ocultar todos los contenidos de pesta√±as
            const hotelsContent = document.getElementById('hotels-tab-content');
            const promotionsContent = document.getElementById('promotions-tab-content');
            
            // Ocultar todos los botones activos
            const hotelsBtn = document.getElementById('hotels-tab-btn');
            const promotionsBtn = document.getElementById('promotions-tab-btn');
            
            if (tab === 'hotels') {
                if (hotelsContent) hotelsContent.style.display = 'block';
                if (promotionsContent) promotionsContent.style.display = 'none';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#1976d2';
                    hotelsBtn.style.color = 'white';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#f0f0f0';
                    promotionsBtn.style.color = '#333';
                }
            } else if (tab === 'promotions') {
                if (hotelsContent) hotelsContent.style.display = 'none';
                if (promotionsContent) promotionsContent.style.display = 'block';
                if (hotelsBtn) {
                    hotelsBtn.style.background = '#f0f0f0';
                    hotelsBtn.style.color = '#333';
                }
                if (promotionsBtn) {
                    promotionsBtn.style.background = '#1976d2';
                    promotionsBtn.style.color = 'white';
                }
                
                // Cargar contenido de promociones
                loadHotelPromotionsContent();
            }
        }
        
        // Funci√≥n para cargar el contenido de promociones dentro de la secci√≥n
        function loadHotelPromotionsContent() {
            const contentDiv = document.getElementById('hotel-promotions-content');
            if (!contentDiv) return;
            
            // Cargar datos de hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Generar el contenido de promociones (similar al modal pero sin el modal)
            contentDiv.innerHTML = `
                    <!-- Pesta√±as de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                    <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">üî• Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">‚ûï Crear Promoci√≥n</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìä Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìà Analytics</button>
                    </div>
                    
                    <!-- Contenido de pesta√±as -->
                    <div id="promotion-content">
                    <!-- Pesta√±a de Promociones Activas -->
                    <div id="active-tab" class="promotion-tab-content" style="display: block;">
                        <h3 style="margin-bottom: 16px; color: #333;">üî• Promociones Activas</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${hotels.map(hotel => `
                                <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                        <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                    </div>
                                    <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                        <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ‚≠ê</span>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚úèÔ∏è Editar</button>
                                        <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üëÅÔ∏è Ver</button>
                                        <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚è∏Ô∏è Pausar</button>
                                    </div>
                                </div>
                            `).join('')}
                                </div>
                            </div>
                            
                    <!-- Pesta√±a de Crear Promoci√≥n -->
                    <div id="create-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">‚ûï Crear Nueva Promoci√≥n</h3>
                        
                        <form id="createPromotionForm" style="display: grid; gap: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                    <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Seleccionar hotel</option>
                                        ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                    </select>
                                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoci√≥n</label>
                                    <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="discount">Descuento</option>
                                        <option value="package">Paquete</option>
                                        <option value="early-bird">Early Bird</option>
                                        <option value="last-minute">Last Minute</option>
                                    </select>
                                                </div>
                                                </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                    <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Inicio</label>
                                    <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                    </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Fin</label>
                                    <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Estado</label>
                                    <select id="promotionStatus" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="active">Activa</option>
                                        <option value="paused">Pausada</option>
                                    </select>
                                        </div>
                                        </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripci√≥n</label>
                                <textarea id="promotionDescription" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="showHotelsTab('hotels')" style="background: #f0f0f0; color: #333; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoci√≥n</button>
                                        </div>
                        </form>
                                        </div>
                                        
                    <!-- Pesta√±a de Historial -->
                    <div id="history-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">üìä Historial de Promociones</h3>
                        <p style="color: #666;">No hay historial de promociones disponibles.</p>
                                        </div>
                                        
                    <!-- Pesta√±a de Analytics -->
                    <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                        <h3 style="margin-bottom: 16px; color: #333;">üìà Analytics de Promociones</h3>
                        <p style="color: #666;">No hay datos de analytics disponibles.</p>
                                        </div>
                </div>
            `;
            
            // Agregar event listener al formulario
            const form = document.getElementById('createPromotionForm');
            if (form) {
                form.onsubmit = function(e) {
                    e.preventDefault();
                    savePromotion();
                };
            }
        }
        
        // Funci√≥n para mostrar modal de promociones de hoteles
        function showHotelPromotionsModal(hotels) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">üè® Promociones de Hoteles</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                            </div>
                            
                    <!-- Pesta√±as de promociones -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showPromotionTab('active')" class="promotion-tab active" data-tab="active" style="padding: 12px 20px; border: none; background: #ff9800; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">üî• Promociones Activas</button>
                        <button onclick="showPromotionTab('create')" class="promotion-tab" data-tab="create" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">‚ûï Crear Promoci√≥n</button>
                        <button onclick="showPromotionTab('history')" class="promotion-tab" data-tab="history" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìä Historial</button>
                        <button onclick="showPromotionTab('analytics')" class="promotion-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìà Analytics</button>
                        </div>
                        
                    <!-- Contenido de pesta√±as -->
                    <div id="promotion-content">
                        <!-- Pesta√±a de Promociones Activas -->
                        <div id="active-tab" class="promotion-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">üî• Promociones Activas</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                                ${hotels.map(hotel => `
                                    <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <h4 style="margin: 0; color: #333;">${hotel.name}</h4>
                                            <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">Activo</span>
                                        </div>
                                        <p style="margin: 0 0 12px 0; color: #666;">${hotel.location}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <span style="font-weight: 500; color: #ff9800;">$${hotel.price || 'Consultar'}</span>
                                            <span style="font-size: 0.9rem; color: #666;">${hotel.rating || 'N/A'} ‚≠ê</span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="editHotelPromotion('${hotel.id}')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚úèÔ∏è Editar</button>
                                            <button onclick="viewHotelPromotion('${hotel.id}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">üëÅÔ∏è Ver</button>
                                            <button onclick="deactivateHotelPromotion('${hotel.id}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">‚è∏Ô∏è Pausar</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Pesta√±a de Crear Promoci√≥n -->
                        <div id="create-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">‚ûï Crear Nueva Promoci√≥n</h3>
                            
                            <form id="createPromotionForm" style="display: grid; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel</label>
                                        <select id="promotionHotel" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">Seleccionar hotel</option>
                                            ${hotels.map(hotel => `<option value="${hotel.id}">${hotel.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de Promoci√≥n</label>
                                        <select id="promotionType" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="discount">Descuento</option>
                                            <option value="package">Paquete</option>
                                            <option value="early-bird">Early Bird</option>
                                            <option value="last-minute">Last Minute</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descuento (%)</label>
                                        <input type="number" id="promotionDiscount" min="0" max="100" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Precio Promocional</label>
                                        <input type="text" id="promotionPrice" placeholder="Ej: $150 USD" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripci√≥n de la Promoci√≥n</label>
                                    <textarea id="promotionDescription" rows="4" placeholder="Describe los beneficios de esta promoci√≥n..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Inicio</label>
                                        <input type="date" id="promotionStartDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Fin</label>
                                        <input type="date" id="promotionEndDate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                                    <button type="submit" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Crear Promoci√≥n</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Pesta√±a de Historial -->
                        <div id="history-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">üìä Historial de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">üìä</span>
                                <p style="margin: 16px 0 0 0; color: #666;">El historial de promociones estar√° disponible pr√≥ximamente</p>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a de Analytics -->
                        <div id="analytics-tab" class="promotion-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">üìà Analytics de Promociones</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <span style="font-size: 3rem; opacity: 0.5;">üìà</span>
                                <p style="margin: 16px 0 0 0; color: #666;">Los analytics de promociones estar√° disponible pr√≥ximamente</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners para pesta√±as
            const tabs = modal.querySelectorAll('.promotion-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todas las pesta√±as
                    tabs.forEach(t => t.classList.remove('active'));
                    t.style.background = '#f0f0f0';
                    t.style.color = '#333';
                    
                    // Agregar clase active a la pesta√±a clickeada
                    this.classList.add('active');
                    this.style.background = '#ff9800';
                    this.style.color = 'white';
                    
                    // Mostrar contenido correspondiente
                    const tabName = this.getAttribute('data-tab');
                    showPromotionTab(tabName);
                });
            });
            
            // Event listener para el formulario
            const form = modal.querySelector('#createPromotionForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createHotelPromotion();
                });
            }
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Funci√≥n para mostrar herramientas de marketing
        window.showMarketingTools = function() {
            console.log('üì¢ Mostrando herramientas de marketing...');
            
            // Cargar datos de usuarios
            if (typeof loadUsersData === 'function') {
                const users = loadUsersData();
                
                // Crear y mostrar modal de herramientas de marketing
                if (typeof showMarketingModal === 'function') {
                    showMarketingModal(users);
                } else {
                    console.error('showMarketingModal no est√° definida');
                }
            } else {
                console.error('loadUsersData no est√° definida');
            }
        };
        
        // Funci√≥n para mostrar modal de herramientas de marketing
        function showMarketingModal(users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 95%; max-height: 95%; overflow-y: auto; width: 1000px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">üì¢ Herramientas de Marketing</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Pesta√±as de herramientas -->
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e0e0e0;">
                        <button onclick="showMarketingTab('segments')" class="marketing-tab active" data-tab="segments" style="padding: 12px 20px; border: none; background: #4caf50; color: white; border-radius: 8px 8px 0 0; cursor: pointer;">üë• Segmentaci√≥n</button>
                        <button onclick="showMarketingTab('campaigns')" class="marketing-tab" data-tab="campaigns" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìß Campa√±as</button>
                        <button onclick="showMarketingTab('templates')" class="marketing-tab" data-tab="templates" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìù Plantillas</button>
                        <button onclick="showMarketingTab('analytics')" class="marketing-tab" data-tab="analytics" style="padding: 12px 20px; border: none; background: #f0f0f0; color: #333; border-radius: 8px 8px 0 0; cursor: pointer;">üìä Analytics</button>
                    </div>
                    
                    <!-- Contenido de pesta√±as -->
                    <div id="marketing-content">
                        <!-- Pesta√±a de Segmentaci√≥n -->
                        <div id="segments-tab" class="marketing-tab-content" style="display: block;">
                            <h3 style="margin-bottom: 16px; color: #333;">üë• Segmentaci√≥n de Usuarios</h3>
                            
                            <!-- Segmentos predefinidos -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">‚úÖ Usuarios Activos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han tenido actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'active' || u.status === 'Activo').length} usuarios</span>
                                        <button onclick="exportSegment('active')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">üìä Con Cotizaciones</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios que han solicitado cotizaciones</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length} usuarios</span>
                                        <button onclick="exportSegment('withQuotes')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">üÜï Nuevos este Mes</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios registrados en el mes actual</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => {
                                            const userDate = new Date(u.createdAt);
                                            const currentDate = new Date();
                                            return userDate.getMonth() === currentDate.getMonth() && 
                                                   userDate.getFullYear() === currentDate.getFullYear();
                                        }).length} usuarios</span>
                                        <button onclick="exportSegment('newThisMonth')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">‚ùå Inactivos</h4>
                                    <p style="margin: 0 0 12px 0; color: #666;">Usuarios sin actividad reciente</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${users.filter(u => u.status === 'inactive' || u.status === 'Inactivo').length} usuarios</span>
                                        <button onclick="exportSegment('inactive')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Exportar</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Segmento personalizado -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">üîß Crear Segmento Personalizado</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Criterio:</label>
                                        <select id="customSegmentCriteria" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="status">Estado</option>
                                            <option value="cotizaciones">Cotizaciones</option>
                                            <option value="fechaRegistro">Fecha de Registro</option>
                                            <option value="tipoCuenta">Tipo de Cuenta</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Valor:</label>
                                        <input type="text" id="customSegmentValue" placeholder="Ej: Activo, >0, etc." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div style="display: flex; align-items: end;">
                                        <button onclick="createCustomSegment()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Crear Segmento</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a de Campa√±as -->
                        <div id="campaigns-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">üìß Gesti√≥n de Campa√±as</h3>
                            
                            <!-- Crear nueva campa√±a -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">üÜï Nueva Campa√±a</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre de la Campa√±a:</label>
                                        <input type="text" id="campaignName" placeholder="Ej: Promoci√≥n Verano 2025" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Segmento Objetivo:</label>
                                        <select id="campaignSegment" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="all">Todos los usuarios</option>
                                            <option value="active">Usuarios activos</option>
                                            <option value="withQuotes">Con cotizaciones</option>
                                            <option value="newThisMonth">Nuevos este mes</option>
                                            <option value="inactive">Inactivos</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tipo de Campa√±a:</label>
                                        <select id="campaignType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="email">Email Marketing</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="sms">SMS</option>
                                            <option value="push">Push Notification</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Mensaje:</label>
                                    <textarea id="campaignMessage" placeholder="Escribe tu mensaje aqu√≠..." rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                                </div>
                                <button onclick="createCampaign()" style="background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">üöÄ Crear Campa√±a</button>
                            </div>
                            
                            <!-- Campa√±as existentes -->
                            <div>
                                <h4 style="margin-bottom: 16px; color: #333;">üìã Campa√±as Existentes</h4>
                                <div id="campaignsList" style="display: grid; gap: 12px;">
                                    <!-- Las campa√±as se cargar√°n din√°micamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a de Plantillas -->
                        <div id="templates-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">üìù Plantillas de Mensajes</h3>
                            
                            <!-- Plantillas predefinidas -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #2e7d32;">üéâ Bienvenida</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¬°Bienvenido a Checkin24hs! Descubre nuestras mejores ofertas de hoteles.</p>
                                    <button onclick="useTemplate('welcome')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #f57c00;">üî• Oferta Especial</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¬°Oferta especial por tiempo limitado! Descuentos exclusivos en hoteles premium.</p>
                                    <button onclick="useTemplate('specialOffer')" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1976d2;">üìÖ Recordatorio</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">No olvides revisar nuestras nuevas ofertas. ¬°Tu pr√≥xima aventura te espera!</p>
                                    <button onclick="useTemplate('reminder')" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                                
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 8px 0; color: #7b1fa2;">üéØ Reactivaci√≥n</h4>
                                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px;">¬°Te extra√±amos! Vuelve a descubrir las mejores ofertas en Checkin24hs.</p>
                                    <button onclick="useTemplate('reactivation')" style="background: #9c27b0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Usar Plantilla</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a de Analytics -->
                        <div id="analytics-tab" class="marketing-tab-content" style="display: none;">
                            <h3 style="margin-bottom: 16px; color: #333;">üìä Analytics de Marketing</h3>
                            
                            <!-- M√©tricas de engagement -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #2e7d32; font-size: 24px;">${users.length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Audiencia Total</p>
                                </div>
                                <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #f57c00; font-size: 24px;">${Math.round((users.filter(u => u.status === 'active' || u.status === 'Activo').length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Engagement</p>
                                </div>
                                <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #1976d2; font-size: 24px;">${users.filter(u => u.cotizaciones && u.cotizaciones > 0).length}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Conversiones</p>
                                </div>
                                <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                                    <h4 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((users.filter(u => u.cotizaciones && u.cotizaciones > 0).length / users.length) * 100)}%</h4>
                                    <p style="margin: 4px 0 0 0; color: #666;">Tasa de Conversi√≥n</p>
                                </div>
                            </div>
                            
                            <!-- Gr√°fico de engagement por mes -->
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #333;">üìà Engagement por Mes</h4>
                                <div style="height: 200px; display: flex; align-items: end; gap: 8px; padding: 16px;">
                                    ${generateEngagementChart(users)}
                                </div>
                            </div>
                            
                            <!-- Recomendaciones -->
                            <div style="background: #fff3e0; padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 16px 0; color: #f57c00;">üí° Recomendaciones de Marketing</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li style="margin-bottom: 8px;">Enf√≥cate en reactivar usuarios inactivos con ofertas especiales</li>
                                    <li style="margin-bottom: 8px;">Crea campa√±as personalizadas para usuarios con cotizaciones</li>
                                    <li style="margin-bottom: 8px;">Implementa un programa de fidelizaci√≥n para usuarios activos</li>
                                    <li style="margin-bottom: 8px;">Optimiza el timing de las campa√±as basado en el engagement</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funci√≥n para cambiar pesta√±as de marketing
        function showMarketingTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.marketing-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.marketing-tab').forEach(btn => {
                btn.style.background = '#f0f0f0';
                btn.style.color = '#333';
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Activar bot√≥n seleccionado
            event.target.style.background = '#4caf50';
            event.target.style.color = 'white';
        }
        
        // Funci√≥n para exportar segmentos
        function exportSegment(segmentType) {
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(segmentType) {
                case 'active':
                    segmentUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    segmentUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    segmentUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Tel√©fono,Estado,Fecha Registro\n' +
                segmentUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `segmento_${segmentType}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Segmento "${segmentType}" exportado correctamente (${segmentUsers.length} usuarios)`);
        }
        
        // Funci√≥n para crear segmento personalizado
        function createCustomSegment() {
            const criteria = document.getElementById('customSegmentCriteria').value;
            const value = document.getElementById('customSegmentValue').value;
            
            if (!value) {
                alert('‚ùå Por favor ingresa un valor para el segmento');
                return;
            }
            
            const users = loadUsersData();
            let segmentUsers = [];
            
            switch(criteria) {
                case 'status':
                    segmentUsers = users.filter(u => u.status === value);
                    break;
                case 'cotizaciones':
                    segmentUsers = users.filter(u => u.cotizaciones && u.cotizaciones > parseInt(value));
                    break;
                case 'tipoCuenta':
                    segmentUsers = users.filter(u => u.tipoCuenta === value);
                    break;
            }
            
            if (segmentUsers.length === 0) {
                alert('‚ùå No se encontraron usuarios con los criterios especificados');
                return;
            }
            
            alert(`‚úÖ Segmento personalizado creado: ${segmentUsers.length} usuarios encontrados`);
            exportSegment('custom');
        }
        
        // Funci√≥n para crear campa√±a
        function createCampaign() {
            const name = document.getElementById('campaignName').value;
            const segment = document.getElementById('campaignSegment').value;
            const type = document.getElementById('campaignType').value;
            const message = document.getElementById('campaignMessage').value;
            
            if (!name || !message) {
                alert('‚ùå Por favor completa todos los campos requeridos');
                return;
            }
            
            const campaign = {
                id: 'camp-' + Date.now(),
                name: name,
                segment: segment,
                type: type,
                message: message,
                createdAt: new Date().toISOString(),
                status: 'draft'
            };
            
            // Guardar campa√±a en localStorage
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            campaigns.push(campaign);
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert('‚úÖ Campa√±a creada correctamente');
            
            // Limpiar formulario
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignMessage').value = '';
            
            // Actualizar lista de campa√±as
            loadCampaigns();
        }
        
        // Funci√≥n para cargar campa√±as
        function loadCampaigns() {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaignsList = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                campaignsList.innerHTML = '<p style="color: #666; text-align: center;">No hay campa√±as creadas</p>';
                return;
            }
            
            campaignsList.innerHTML = campaigns.map(campaign => `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: #333;">${campaign.name}</h5>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${campaign.message.substring(0, 100)}${campaign.message.length > 100 ? '...' : ''}</p>
                            <div style="display: flex; gap: 12px; font-size: 12px; color: #666;">
                                <span>Segmento: ${campaign.segment}</span>
                                <span>Tipo: ${campaign.type}</span>
                                <span>Estado: ${campaign.status}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="sendCampaign('${campaign.id}')" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Enviar</button>
                            <button onclick="deleteCampaign('${campaign.id}')" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Eliminar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Funci√≥n para usar plantilla
        function useTemplate(templateType) {
            const templates = {
                welcome: '¬°Bienvenido a Checkin24hs! üè® Descubre nuestras mejores ofertas de hoteles y disfruta de descuentos exclusivos. ¬°Tu pr√≥xima aventura te espera!',
                specialOffer: 'üî• ¬°OFERTA ESPECIAL POR TIEMPO LIMITADO! üî• Descuentos exclusivos en hoteles premium. ¬°No te pierdas esta oportunidad √∫nica!',
                reminder: 'üìÖ ¬øYa planificaste tu pr√≥xima escapada? No olvides revisar nuestras nuevas ofertas. ¬°Tu pr√≥xima aventura te espera en Checkin24hs!',
                reactivation: 'üëã ¬°Te extra√±amos! Vuelve a descubrir las mejores ofertas en Checkin24hs. Tenemos descuentos especiales esper√°ndote.'
            };
            
            const message = templates[templateType];
            if (message) {
                // Cambiar a la pesta√±a de campa√±as
                showMarketingTab('campaigns');
                
                // Llenar el formulario con la plantilla
                setTimeout(() => {
                    document.getElementById('campaignMessage').value = message;
                }, 100);
            }
        }
        
        // Funci√≥n para generar gr√°fico de engagement
        function generateEngagementChart(users) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
            const engagement = months.map((month, index) => {
                const monthUsers = users.filter(user => {
                    const userDate = new Date(user.createdAt);
                    return userDate.getMonth() === index;
                });
                return monthUsers.length;
            });
            
            const maxEngagement = Math.max(...engagement);
            
            return engagement.map((value, index) => `
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div style="width: 100%; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div style="height: ${(value / maxEngagement) * 150}px; background: #2196f3; transition: height 0.3s;"></div>
                    </div>
                    <span style="font-size: 12px; color: #666;">${months[index]}</span>
                    <span style="font-size: 10px; color: #999;">${value}</span>
                </div>
            `).join('');
        }
        
        // Funci√≥n para enviar campa√±a
        function sendCampaign(campaignId) {
            const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (!campaign) {
                alert('‚ùå Campa√±a no encontrada');
                return;
            }
            
            // Simular env√≠o de campa√±a
            const users = loadUsersData();
            let targetUsers = [];
            
            switch(campaign.segment) {
                case 'all':
                    targetUsers = users;
                    break;
                case 'active':
                    targetUsers = users.filter(u => u.status === 'active' || u.status === 'Activo');
                    break;
                case 'withQuotes':
                    targetUsers = users.filter(u => u.cotizaciones && u.cotizaciones > 0);
                    break;
                case 'newThisMonth':
                    targetUsers = users.filter(u => {
                        const userDate = new Date(u.createdAt);
                        const currentDate = new Date();
                        return userDate.getMonth() === currentDate.getMonth() && 
                               userDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'inactive':
                    targetUsers = users.filter(u => u.status === 'inactive' || u.status === 'Inactivo');
                    break;
            }
            
            // Actualizar estado de la campa√±a
            campaign.status = 'sent';
            campaign.sentAt = new Date().toISOString();
            campaign.recipients = targetUsers.length;
            
            localStorage.setItem('marketing_campaigns', JSON.stringify(campaigns));
            
            alert(`‚úÖ Campa√±a "${campaign.name}" enviada a ${targetUsers.length} usuarios`);
            
            // Actualizar lista de campa√±as
            loadCampaigns();
        }
        
        // Funci√≥n para eliminar campa√±a
        function deleteCampaign(campaignId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta campa√±a?')) {
                const campaigns = JSON.parse(localStorage.getItem('marketing_campaigns') || '[]');
                const updatedCampaigns = campaigns.filter(c => c.id !== campaignId);
                localStorage.setItem('marketing_campaigns', JSON.stringify(updatedCampaigns));
                
                alert('‚úÖ Campa√±a eliminada correctamente');
                loadCampaigns();
            }
        }

        // Funci√≥n para mostrar analytics de usuarios
        function showUserAnalytics() {
            console.log('üìä Mostrando analytics de usuarios...');
            
            // Cargar datos de usuarios
            const users = loadUsersData();
            
            // Calcular estad√≠sticas
            const stats = calculateUserStats(users);
            
            // Crear y mostrar modal de analytics
            showAnalyticsModal(stats, users);
        }
        
        // Funci√≥n para calcular estad√≠sticas de usuarios
        function calculateUserStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo').length;
            const inactiveUsers = users.filter(user => user.status === 'inactive' || user.status === 'Inactivo').length;
            
            // Usuarios por mes (√∫ltimos 6 meses)
            const monthlyStats = {};
            const currentDate = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                monthlyStats[monthKey] = 0;
            }
            
            users.forEach(user => {
                const userDate = new Date(user.createdAt);
                const monthKey = userDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                if (monthlyStats[monthKey] !== undefined) {
                    monthlyStats[monthKey]++;
                }
            });
            
            // Usuarios por tipo de cuenta
            const accountTypes = {};
            users.forEach(user => {
                const type = user.tipoCuenta || 'registrado';
                accountTypes[type] = (accountTypes[type] || 0) + 1;
            });
            
            // Usuarios con cotizaciones
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0).length;
            
            return {
                totalUsers,
                activeUsers,
                inactiveUsers,
                monthlyStats,
                accountTypes,
                usersWithQuotes,
                usersWithoutQuotes: totalUsers - usersWithQuotes
            };
        }
        
        // Funci√≥n para mostrar modal de analytics
        function showAnalyticsModal(stats, users) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333;">üìä An√°lisis de Usuarios</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <!-- Estad√≠sticas principales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #1976d2; font-size: 24px;">${stats.totalUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Total Usuarios</p>
                        </div>
                        <div style="background: #e8f5e8; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #2e7d32; font-size: 24px;">${stats.activeUsers}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Usuarios Activos</p>
                        </div>
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #f57c00; font-size: 24px;">${stats.usersWithQuotes}</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Con Cotizaciones</p>
                        </div>
                        <div style="background: #f3e5f5; padding: 16px; border-radius: 8px; text-align: center;">
                            <h3 style="margin: 0; color: #7b1fa2; font-size: 24px;">${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%</h3>
                            <p style="margin: 4px 0 0 0; color: #666;">Tasa de Actividad</p>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico de usuarios por mes -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">üìà Registros por Mes</h3>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            ${Object.entries(stats.monthlyStats).map(([month, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 500;">${month}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="width: 200px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${(count / Math.max(...Object.values(stats.monthlyStats))) * 100}%; height: 100%; background: #2196f3;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 30px; text-align: right;">${count}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Tipos de cuenta -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">üë• Distribuci√≥n por Tipo de Cuenta</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${Object.entries(stats.accountTypes).map(([type, count]) => `
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                                    <h4 style="margin: 0; color: #333; font-size: 18px;">${count}</h4>
                                    <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">${type}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Acciones r√°pidas -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: #333;">‚ö° Acciones R√°pidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button onclick="exportActiveUsers()" style="background: #4caf50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                üìß Exportar Usuarios Activos
                            </button>
                            <button onclick="exportUsersWithQuotes()" style="background: #ff9800; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                üìä Exportar Con Cotizaciones
                            </button>
                            <button onclick="generateUserReport()" style="background: #2196f3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer;">
                                üìã Generar Reporte Completo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabla de usuarios recientes -->
                    <div>
                        <h3 style="margin-bottom: 16px; color: #333;">üÜï Usuarios Recientes</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Usuario</th>
                                        <th style="padding: 8px; text-align: left; font-size: 14px;">Email</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Estado</th>
                                        <th style="padding: 8px; text-align: center; font-size: 14px;">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.slice(0, 5).map(user => `
                                        <tr style="border-bottom: 1px solid #eee;">
                                            <td style="padding: 8px; font-size: 14px;">${user.name}</td>
                                            <td style="padding: 8px; font-size: 14px;">${user.email}</td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">
                                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; ${user.status === 'active' || user.status === 'Activo' ? 'background: #e8f5e8; color: #2e7d32;' : 'background: #ffebee; color: #c62828;'}">
                                                    ${user.status === 'active' || user.status === 'Activo' ? 'Activo' : 'Inactivo'}
                                                </span>
                                            </td>
                                            <td style="padding: 8px; text-align: center; font-size: 14px;">${new Date(user.createdAt).toLocaleDateString('es-ES')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Funciones auxiliares para las acciones r√°pidas
        function exportActiveUsers() {
            const users = loadUsersData();
            const activeUsers = users.filter(user => user.status === 'active' || user.status === 'Activo');
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Tel√©fono,Estado,Fecha Registro\n' +
                activeUsers.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.status}","${new Date(user.createdAt).toLocaleDateString('es-ES')}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_activos.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Usuarios activos exportados correctamente');
        }
        
        function exportUsersWithQuotes() {
            const users = loadUsersData();
            const usersWithQuotes = users.filter(user => user.cotizaciones && user.cotizaciones > 0);
            
            const csvContent = 'data:text/csv;charset=utf-8,' + 
                'Nombre,Email,Tel√©fono,Cotizaciones,Estado\n' +
                usersWithQuotes.map(user => 
                    `"${user.name}","${user.email}","${user.phone || ''}","${user.cotizaciones || 0}","${user.status}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'usuarios_con_cotizaciones.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Usuarios con cotizaciones exportados correctamente');
        }
        
        function generateUserReport() {
            const users = loadUsersData();
            const stats = calculateUserStats(users);
            
            const report = `
REPORTE DE USUARIOS - CHECKIN24HS
Fecha: ${new Date().toLocaleDateString('es-ES')}

ESTAD√çSTICAS GENERALES:
- Total de usuarios: ${stats.totalUsers}
- Usuarios activos: ${stats.activeUsers}
- Usuarios inactivos: ${stats.inactiveUsers}
- Tasa de actividad: ${Math.round((stats.activeUsers / stats.totalUsers) * 100)}%
- Usuarios con cotizaciones: ${stats.usersWithQuotes}
- Usuarios sin cotizaciones: ${stats.usersWithoutQuotes}

DISTRIBUCI√ìN POR TIPO DE CUENTA:
${Object.entries(stats.accountTypes).map(([type, count]) => `- ${type}: ${count}`).join('\n')}

REGISTROS POR MES:
${Object.entries(stats.monthlyStats).map(([month, count]) => `- ${month}: ${count} usuarios`).join('\n')}

USUARIOS RECIENTES (√∫ltimos 10):
${users.slice(0, 10).map(user => `- ${user.name} (${user.email}) - ${new Date(user.createdAt).toLocaleDateString('es-ES')}`).join('\n')}
            `;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_usuarios_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Reporte completo generado correctamente');
        }

        // Funci√≥n para exportar emails para campa√±a
        function exportEmailsForCampaign() {
            // Implementar exportaci√≥n de emails
            console.log('Exportando emails para campa√±a...');
        }

        // Funci√≥n para exportar tel√©fonos para WhatsApp
        function exportPhonesForWhatsApp() {
            // Implementar exportaci√≥n de tel√©fonos
            console.log('Exportando tel√©fonos para WhatsApp...');
        }

        // Funci√≥n para generar reporte de usuarios activos
        function generateActiveUsersReport() {
            // Implementar reporte
            console.log('Generando reporte de usuarios activos...');
        }

        // Funci√≥n para crear segmento de usuarios de cotizaciones
        function createQuoteUsersSegment() {
            // Implementar segmento
            console.log('Creando segmento de usuarios de cotizaciones...');
        }

        // Funci√≥n para cargar datos de usuarios
        async function loadUsersData() {
            try {
                // Primero, sincronizar usuarios desde reservas
                syncUsersFromReservations();
                
                let allUsers = [];
                
                // 1. Intentar cargar desde Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const supabaseUsers = await window.supabaseClient.getUsers();
                        if (supabaseUsers && supabaseUsers.length > 0) {
                            console.log(`‚òÅÔ∏è ${supabaseUsers.length} usuarios cargados desde Supabase`);
                            allUsers = supabaseUsers.map(u => ({
                                id: u.id,
                                name: u.name || u.nombre || '',
                                email: u.email,
                                phone: u.phone || u.telefono || '',
                                status: u.status || u.is_active ? 'active' : 'inactive',
                                is_active: u.is_active !== false,
                                createdAt: u.created_at || u.createdAt || new Date().toISOString(),
                                last_activity: u.last_activity || u.updated_at,
                                tipoCuenta: u.tipo_cuenta || u.tipoCuenta || 'registrado',
                                birthDay: u.birth_day || u.birthDay,
                                birthMonth: u.birth_month || u.birthMonth,
                                totalQuotes: u.total_quotes || u.totalQuotes || 0
                            }));
                            
                            // Guardar tambi√©n en localStorage como backup
                            localStorage.setItem('checkin24hs_users', JSON.stringify(allUsers));
                        }
                    } catch (supabaseError) {
                        console.warn('‚ö†Ô∏è Error cargando de Supabase, usando localStorage:', supabaseError);
                    }
                }
                
                // 2. Si no hay usuarios de Supabase, cargar de localStorage
                if (allUsers.length === 0) {
                    // Cargar usuarios desde checkin24hs_users (dashboard)
                    const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Cargar usuarios desde clientesDB (index.html)
                    const mobileUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                    
                    console.log('üîç Datos encontrados en localStorage:', {
                        checkin24hs_users: dashboardUsers.length,
                        clientesDB: mobileUsers.length
                    });
                    
                    // Combinar usuarios √∫nicos
                    allUsers = [...dashboardUsers];
                    
                    // Agregar usuarios m√≥viles que no est√©n en dashboard
                    mobileUsers.forEach(mobileUser => {
                        const exists = allUsers.find(user => user.email === mobileUser.email);
                        if (!exists) {
                            // Convertir formato de usuario m√≥vil a formato dashboard
                            const convertedUser = {
                                id: mobileUser.id,
                                name: mobileUser.name,
                                email: mobileUser.email,
                                phone: mobileUser.phone,
                                status: mobileUser.status || 'active',
                                createdAt: mobileUser.fechaRegistro || new Date().toISOString(),
                                tipoCuenta: mobileUser.tipoCuenta || 'registrado',
                                birthDay: mobileUser.birthDay,
                                birthMonth: mobileUser.birthMonth
                            };
                            allUsers.push(convertedUser);
                        }
                    });
                }
                
                console.log(`üìä Total usuarios cargados: ${allUsers.length}`);
                
                // Guardar todos los usuarios en variable global
                allUsersData = allUsers;
                
                // Actualizar tabla de usuarios (solo primeros 20)
                loadUsersTable(allUsers.slice(0, 20));
                
                // Actualizar estad√≠sticas
                updateDashboardStats(allUsers);
                
                return allUsers;
            } catch (error) {
                console.error('‚ùå Error al cargar usuarios:', error);
                return [];
            }
        }

        // Funci√≥n para sincronizar usuarios desde reservas (versi√≥n silenciosa)
        function syncUsersFromReservations() {
            try {
                // Obtener todas las reservas
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                
                if (reservations.length === 0) {
                    return;
                }
                
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const existingEmails = new Set(users.map(user => 
                    user.email ? user.email.toLowerCase() : ''
                ));
                
                let newUsersCount = 0;
                const processedEmails = new Set();
                
                // Procesar cada reserva
                reservations.forEach(reservation => {
                    if (!reservation.clientEmail) {
                        return;
                    }
                    
                    const email = reservation.clientEmail.toLowerCase();
                    
                    // Si ya procesamos este email, saltar
                    if (processedEmails.has(email)) {
                        return;
                    }
                    
                    processedEmails.add(email);
                    
                    if (!existingEmails.has(email)) {
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
                        }
                        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: reservation.clientName || '',
                            email: reservation.clientEmail,
                            phone: reservation.clientPhone || '',
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.reservationDate || new Date().toISOString(),
                            last_activity: reservation.updatedAt || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(email);
                        newUsersCount++;
                        console.log('‚úÖ Usuario sincronizado desde reserva:', newUser.email);
                    }
                });
                
                // Guardar usuarios actualizados si hay nuevos
                if (newUsersCount > 0) {
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log(`üîÑ Sincronizaci√≥n autom√°tica: ${newUsersCount} nuevos usuarios agregados desde reservas`);
                }
                
            } catch (error) {
                console.error('‚ùå Error al sincronizar usuarios desde reservas:', error);
            }
        }

        // Funci√≥n para actualizar estad√≠sticas del dashboard
        function updateDashboardStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const newUsersThisMonth = users.filter(user => {
                const userDate = new Date(user.createdAt);
                const currentDate = new Date();
                return userDate.getMonth() === currentDate.getMonth() && 
                       userDate.getFullYear() === currentDate.getFullYear();
            }).length;
            
            // Actualizar contadores en el dashboard
            const totalUsersElement = document.querySelector('#totalUsers');
            const activeUsersElement = document.querySelector('#activeUsers');
            const newUsersElement = document.querySelector('#newUsers');
            
            if (totalUsersElement) totalUsersElement.textContent = totalUsers;
            if (activeUsersElement) activeUsersElement.textContent = activeUsers;
            if (newUsersElement) newUsersElement.textContent = newUsersThisMonth;
            
            console.log('üìä Estad√≠sticas actualizadas:', {
                total: totalUsers,
                active: activeUsers,
                newThisMonth: newUsersThisMonth
            });
        }

        // Funci√≥n para sincronizar con index.html
        function syncWithIndexHTML() {
            console.log('üîÑ Sincronizando datos de usuarios...');
            
            // Cargar datos actualizados
            const users = loadUsersData();
            
            // Guardar todos los usuarios en variable global
            allUsersData = users;
            
            // Actualizar interfaz
            updateDashboardStats(users);
            loadUsersTable(users.slice(0, 20));
            
            console.log('‚úÖ Sincronizaci√≥n completada');
        }
        
        // Funci√≥n para iniciar sincronizaci√≥n autom√°tica
        function startAutoSync() {
            // Sincronizar cada 30 segundos
            setInterval(() => {
                syncWithIndexHTML();
            }, 30000);
            
            console.log('üîÑ Sincronizaci√≥n autom√°tica iniciada (cada 30 segundos)');
        }

        // Variable global para almacenar todos los usuarios
        let allUsersData = [];
        
        // Funci√≥n para buscar usuarios
        function searchUsers() {
            const searchInput = document.getElementById('usersSearchInput');
            const searchInfo = document.getElementById('usersSearchInfo');
            const searchCount = document.getElementById('usersSearchCount');
            
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (searchTerm === '') {
                // Si no hay b√∫squeda, mostrar los primeros 20
                loadUsersTable(allUsersData.slice(0, 20));
                if (searchInfo) searchInfo.style.display = 'none';
                return;
            }
            
            // Filtrar usuarios por t√©rmino de b√∫squeda
            const filteredUsers = allUsersData.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                const phone = (user.phone || '').toLowerCase();
                
                return name.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       phone.includes(searchTerm);
            });
            
            // Mostrar resultados
            loadUsersTable(filteredUsers);
            
            // Mostrar informaci√≥n de b√∫squeda
            if (searchInfo && searchCount) {
                searchInfo.style.display = 'block';
                searchCount.textContent = filteredUsers.length;
            }
            
            console.log(`üîç B√∫squeda: "${searchTerm}" - ${filteredUsers.length} resultados`);
        }
        
        // Funci√≥n para cargar tabla de usuarios
        function loadUsersTable(users) {
            console.log('üîÑ Cargando tabla de usuarios con:', users.length, 'usuarios');
            
            const tableBody = document.querySelector('#usersTableBody');
            if (!tableBody) {
                console.error('‚ùå No se encontr√≥ la tabla de usuarios');
                return;
            }
            
            console.log('‚úÖ Tabla encontrada, limpiando contenido...');
            
            // Limpiar tabla
            tableBody.innerHTML = '';
            
            if (users.length === 0) {
                console.log('üìù No hay usuarios, mostrando mensaje vac√≠o');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-users"></i> No hay usuarios registrados
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agregar usuarios a la tabla
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const userType = user.tipoCuenta || 'registrado';
                const userSource = user.fechaRegistro ? 'M√≥vil' : (user.tipoCuenta === 'cliente_reserva' ? 'Reserva' : 'Dashboard');
                const cotizaciones = user.cotizaciones ? user.cotizaciones.length : 0;
                const ultimaActividad = user.last_activity || user.ultimaActividad || user.updatedAt || user.createdAt || user.created_at;
                
                row.innerHTML = `
                    <td style="padding: 12px;">
                        <div class="user-info">
                            <div class="user-name">${user.name || 'Sin nombre'}</div>
                            <div class="user-type">${userType} - ${userSource}</div>
                        </div>
                    </td>
                    <td style="padding: 12px;">${user.email || 'Sin email'}</td>
                    <td style="padding: 12px; text-align: center;">${user.phone || 'Sin tel√©fono'}</td>
                    <td style="padding: 12px; text-align: center;">${cotizaciones}</td>
                    <td style="padding: 12px; text-align: center;">${formatDate(ultimaActividad)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span class="status-badge ${user.status === 'active' || user.status === 'activo' ? 'active' : 'inactive'}">
                            ${user.status === 'active' || user.status === 'activo' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="action-btn marketing" onclick="showMarketingTools('${user.id}')" title="Marketing">
                            <i class="fas fa-bullhorn"></i>
                        </button>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editUser('${user.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" onclick="deleteUser('${user.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            console.log('‚úÖ Tabla de usuarios actualizada:', users.length, 'usuarios');
            console.log('üìã Filas agregadas a la tabla');
            
            // Mostrar informaci√≥n si hay m√°s usuarios disponibles (solo si no hay b√∫squeda activa)
            const searchInput = document.getElementById('usersSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allUsersData.length > users.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'users-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando ${users.length} de ${allUsersData.length} usuarios. Usa el buscador para encontrar m√°s usuarios.`;
                
                const tableContainer = tableBody.closest('.activity-card');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay b√∫squeda activa
                const existingInfo = document.querySelector('.users-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Funci√≥n para editar usuario
        async function editUser(userId) {
            console.log('‚úèÔ∏è Editando usuario:', userId);
            
            // Primero buscar en allUsersData (datos que se muestran en la tabla)
            let user = null;
            if (typeof allUsersData !== 'undefined' && allUsersData.length > 0) {
                user = allUsersData.find(u => u.id === userId || u.id == userId);
            }
            
            // Si no se encuentra, buscar en Supabase
            if (!user && window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    const users = await window.supabaseClient.getUsers();
                    user = users.find(u => u.id === userId || u.id == userId);
                } catch (error) {
                    console.error('Error cargando usuario de Supabase:', error);
                }
            }
            
            // Fallback a localStorage (checkin24hs_users y clientesDB)
            if (!user) {
                const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const clientesUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                const allLocalUsers = [...dashboardUsers, ...clientesUsers];
                user = allLocalUsers.find(u => u.id === userId || u.id == userId);
            }
            
            if (!user) {
                alert('‚ùå Usuario no encontrado');
                return;
            }
            
            // Obtener valores soportando ambos formatos
            const userName = user.name || user.nombre || '';
            const userEmail = user.email || '';
            const userPhone = user.phone || user.telefono || '';
            const userStatus = user.status || user.estado || 'Activo';
            const userType = user.type || user.tipo || 'cliente_reserva';
            
            // Crear modal de edici√≥n
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'editUserModalDynamic';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 500px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">‚úèÔ∏è Editar Usuario</h2>
                        <button onclick="document.getElementById('editUserModalDynamic').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <form id="editUserForm" onsubmit="saveUserChanges(event, '${userId}')">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre *</label>
                            <input type="text" id="editUserName" value="${userName}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email *</label>
                            <input type="email" id="editUserEmail" value="${userEmail}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tel√©fono</label>
                            <input type="tel" id="editUserPhone" value="${userPhone}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tipo de Usuario</label>
                            <select id="editUserType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="cliente_reserva" ${userType === 'cliente_reserva' ? 'selected' : ''}>Cliente - Reserva</option>
                                <option value="cliente_cotizacion" ${userType === 'cliente_cotizacion' ? 'selected' : ''}>Cliente - Cotizaci√≥n</option>
                                <option value="agente" ${userType === 'agente' ? 'selected' : ''}>Agente</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Estado</label>
                            <select id="editUserStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="Activo" ${userStatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                <option value="Inactivo" ${userStatus === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="document.getElementById('editUserModalDynamic').remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">Cancelar</button>
                            <button type="submit" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }
        
        async function saveUserChanges(event, userId) {
            event.preventDefault();
            
            const updates = {
                name: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                phone: document.getElementById('editUserPhone').value,
                type: document.getElementById('editUserType').value,
                status: document.getElementById('editUserStatus').value,
                updated_at: new Date().toISOString()
            };
            
            console.log('üíæ Guardando cambios del usuario:', userId, updates);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateUser(userId, updates);
                    console.log('‚úÖ Usuario actualizado en Supabase');
                    alert('‚úÖ Usuario actualizado correctamente');
                    document.getElementById('editUserModalDynamic').remove();
                    loadUsersTable();
                    return;
                }
            } catch (error) {
                console.error('Error actualizando usuario:', error);
            }
            
            // Fallback localStorage - buscar en ambos storages
            let updated = false;
            
            // Intentar en checkin24hs_users
            const dashboardUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
            const dashIndex = dashboardUsers.findIndex(u => u.id === userId || u.id == userId);
            if (dashIndex !== -1) {
                dashboardUsers[dashIndex] = { ...dashboardUsers[dashIndex], ...updates };
                localStorage.setItem('checkin24hs_users', JSON.stringify(dashboardUsers));
                updated = true;
            }
            
            // Intentar tambi√©n en clientesDB
            const clientesUsers = JSON.parse(localStorage.getItem('clientesDB') || '[]');
            const clientIndex = clientesUsers.findIndex(u => u.id === userId || u.id == userId);
            if (clientIndex !== -1) {
                clientesUsers[clientIndex] = { ...clientesUsers[clientIndex], ...updates };
                localStorage.setItem('clientesDB', JSON.stringify(clientesUsers));
                updated = true;
            }
            
            if (updated) {
                alert('‚úÖ Usuario actualizado correctamente');
                document.getElementById('editUserModalDynamic').remove();
                // Recargar datos
                if (typeof loadUsersData === 'function') {
                    loadUsersData();
                }
            } else {
                alert('‚ùå No se pudo actualizar el usuario');
            }
        }

        // Funci√≥n para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Fecha inv√°lida';
            }
        }
        
        // Funci√≥n para eliminar usuario
        async function deleteUser(userId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar este usuario?')) {
                try {
                    // Eliminar de Supabase si est√° inicializado
                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        try {
                            await window.supabaseClient.deleteUser(userId);
                            console.log('‚úÖ Usuario eliminado de Supabase:', userId);
                        } catch (supabaseError) {
                            console.warn('‚ö†Ô∏è Error al eliminar de Supabase (continuando con localStorage):', supabaseError);
                        }
                    }
                    
                    // Cargar usuarios actuales
                    const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Filtrar el usuario a eliminar
                    const updatedUsers = users.filter(user => user.id !== userId);
                    
                    // Guardar usuarios actualizados
                    localStorage.setItem('checkin24hs_users', JSON.stringify(updatedUsers));
                    
                    // Tambi√©n eliminar de clientesDB si existe
                    const clientesDB = JSON.parse(localStorage.getItem('clientesDB') || '[]');
                    const updatedClientesDB = clientesDB.filter(c => c.id !== userId);
                    localStorage.setItem('clientesDB', JSON.stringify(updatedClientesDB));
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('‚úÖ Usuario eliminado:', userId);
                    alert('‚úÖ Usuario eliminado correctamente');
                } catch (error) {
                    console.error('‚ùå Error al eliminar usuario:', error);
                    alert('‚ùå Error al eliminar usuario');
                }
            }
        }
        
        // Funci√≥n para eliminar todos los usuarios
        async function deleteAllUsers() {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODOS los usuarios registrados?\n\nEsta acci√≥n eliminar√° todos los usuarios de la aplicaci√≥n m√≥vil (index.html) y no se puede deshacer.')) {
                try {
                    // Obtener usuarios antes de eliminar para intentar eliminarlos de Supabase
                    const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    
                    // Intentar eliminar de Supabase si est√° inicializado
                    if (window.supabaseClient && window.supabaseClient.isInitialized() && users.length > 0) {
                        console.log('üóëÔ∏è Eliminando usuarios de Supabase...');
                        let deletedFromSupabase = 0;
                        let errorsFromSupabase = 0;
                        
                        for (const user of users) {
                            try {
                                await window.supabaseClient.deleteUser(user.id);
                                deletedFromSupabase++;
                            } catch (error) {
                                // Ignorar errores si el usuario no existe en Supabase
                                errorsFromSupabase++;
                                console.log(`‚ÑπÔ∏è Usuario ${user.id} no existe en Supabase o ya fue eliminado`);
                            }
                        }
                        
                        console.log(`‚úÖ ${deletedFromSupabase} usuarios eliminados de Supabase`);
                        if (errorsFromSupabase > 0) {
                            console.log(`‚ÑπÔ∏è ${errorsFromSupabase} usuarios no encontrados en Supabase (probablemente solo en localStorage)`);
                        }
                    }
                    
                    // Eliminar usuarios de checkin24hs_users (dashboard)
                    localStorage.removeItem('checkin24hs_users');
                    
                    // Eliminar usuarios de clientesDB (index.html)
                    localStorage.removeItem('clientesDB');
                    
                    // Eliminar usuario actual si existe
                    localStorage.removeItem('currentUser');
                    
                    // Recargar tabla
                    loadUsersData();
                    
                    console.log('üóëÔ∏è Todos los usuarios eliminados');
                    alert('‚úÖ Todos los usuarios han sido eliminados correctamente\n\n- Usuarios del dashboard eliminados\n- Usuarios de la app m√≥vil eliminados\n- Sesiones activas cerradas');
                    
                    // Actualizar estad√≠sticas
                    updateDashboardStats([]);
                    
                } catch (error) {
                    console.error('‚ùå Error al eliminar usuarios:', error);
                    alert('‚ùå Error al eliminar usuarios');
                }
            }
        }

        // Funci√≥n para eliminar usuarios duplicados
        async function removeDuplicateUsers() {
            try {
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const originalCount = users.length;
                
                if (users.length === 0) {
                    alert('‚ÑπÔ∏è No hay usuarios para procesar');
                    return;
                }
                
                // Crear mapa para detectar duplicados por nombre (case insensitive)
                const uniqueUsers = [];
                const seenNames = new Set();
                
                users.forEach(user => {
                    const name = (user.name || '').toLowerCase().trim();
                    if (name && !seenNames.has(name)) {
                        seenNames.add(name);
                        uniqueUsers.push(user);
                    }
                });
                
                const duplicatesRemoved = originalCount - uniqueUsers.length;
                
                if (duplicatesRemoved === 0) {
                    alert('‚úÖ No se encontraron usuarios duplicados');
                    return;
                }
                
                // Guardar usuarios √∫nicos
                localStorage.setItem('checkin24hs_users', JSON.stringify(uniqueUsers));
                
                // Actualizar en Supabase - eliminar todos y reinsertar √∫nicos
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Actualizando usuarios √∫nicos en Supabase...');
                    // Primero eliminar todos los usuarios de la tabla
                    await window.supabaseClient.client.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    
                    // Insertar usuarios √∫nicos
                    for (const user of uniqueUsers) {
                        try {
                            await window.supabaseClient.client.from('users').insert({
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                tipo_cuenta: 'cliente_reserva'
                            });
                        } catch (e) {
                            // Ignorar errores de inserci√≥n
                        }
                    }
                }
                
                // Recargar tabla
                loadUsersData();
                
                alert(`‚úÖ Duplicados eliminados:\n- Usuarios originales: ${originalCount}\n- Duplicados removidos: ${duplicatesRemoved}\n- Usuarios √∫nicos: ${uniqueUsers.length}`);
                
            } catch (error) {
                console.error('‚ùå Error al eliminar duplicados:', error);
                alert('‚ùå Error al eliminar duplicados: ' + error.message);
            }
        }

        // Funci√≥n para fusionar usuarios duplicados por email o tel√©fono
        async function mergeDuplicateUsers() {
            try {
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const originalCount = users.length;
                
                if (users.length === 0) {
                    alert('‚ÑπÔ∏è No hay usuarios para procesar');
                    return;
                }
                
                // Mapas para detectar duplicados
                const emailMap = new Map(); // email -> array de usuarios
                const phoneMap = new Map(); // phone -> array de usuarios
                
                // Agrupar usuarios por email y tel√©fono
                users.forEach(user => {
                    const email = (user.email || '').toLowerCase().trim();
                    const phone = (user.phone || '').replace(/\D/g, ''); // Solo d√≠gitos
                    
                    if (email) {
                        if (!emailMap.has(email)) emailMap.set(email, []);
                        emailMap.get(email).push(user);
                    }
                    
                    if (phone && phone.length >= 8) { // Solo tel√©fonos v√°lidos
                        if (!phoneMap.has(phone)) phoneMap.set(phone, []);
                        phoneMap.get(phone).push(user);
                    }
                });
                
                // Funci√≥n para fusionar dos usuarios
                const mergeUsers = (user1, user2) => {
                    return {
                        id: user1.id,
                        name: user1.name || user2.name,
                        email: user1.email || user2.email,
                        phone: user1.phone || user2.phone,
                        status: user1.status || user2.status || 'active',
                        is_active: user1.is_active !== false && user2.is_active !== false,
                        createdAt: user1.createdAt || user2.createdAt || new Date().toISOString(),
                        created_at: user1.created_at || user2.created_at || new Date().toISOString(),
                        last_activity: user1.last_activity > user2.last_activity ? user1.last_activity : user2.last_activity,
                        rewards_points: Math.max(user1.rewards_points || 0, user2.rewards_points || 0),
                        tipoCuenta: user1.tipoCuenta || user2.tipoCuenta || 'cliente_reserva',
                        totalQuotes: (user1.totalQuotes || 0) + (user2.totalQuotes || 0),
                        birthDay: user1.birthDay || user2.birthDay,
                        birthMonth: user1.birthMonth || user2.birthMonth
                    };
                };
                
                // Rastrear usuarios ya fusionados
                const mergedIds = new Set();
                const mergedUsers = [];
                let mergeCount = 0;
                
                // Fusionar por email
                emailMap.forEach((usersWithEmail, email) => {
                    if (usersWithEmail.length > 1) {
                        let merged = usersWithEmail[0];
                        for (let i = 1; i < usersWithEmail.length; i++) {
                            merged = mergeUsers(merged, usersWithEmail[i]);
                            mergedIds.add(usersWithEmail[i].id);
                            mergeCount++;
                        }
                        mergedIds.add(usersWithEmail[0].id);
                        mergedUsers.push(merged);
                        console.log(`üîó Fusionados ${usersWithEmail.length} usuarios con email: ${email}`);
                    }
                });
                
                // Fusionar por tel√©fono (solo si no fueron fusionados por email)
                phoneMap.forEach((usersWithPhone, phone) => {
                    const unfusedUsers = usersWithPhone.filter(u => !mergedIds.has(u.id));
                    if (unfusedUsers.length > 1) {
                        let merged = unfusedUsers[0];
                        for (let i = 1; i < unfusedUsers.length; i++) {
                            merged = mergeUsers(merged, unfusedUsers[i]);
                            mergedIds.add(unfusedUsers[i].id);
                            mergeCount++;
                        }
                        mergedIds.add(unfusedUsers[0].id);
                        mergedUsers.push(merged);
                        console.log(`üîó Fusionados ${unfusedUsers.length} usuarios con tel√©fono: ${phone}`);
                    }
                });
                
                // Agregar usuarios que no fueron fusionados
                users.forEach(user => {
                    if (!mergedIds.has(user.id)) {
                        mergedUsers.push(user);
                    }
                });
                
                if (mergeCount === 0) {
                    alert('‚úÖ No se encontraron usuarios para fusionar\n\nNo hay usuarios con el mismo email o tel√©fono.');
                    return;
                }
                
                // Guardar usuarios fusionados
                localStorage.setItem('checkin24hs_users', JSON.stringify(mergedUsers));
                
                // Actualizar en Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Actualizando usuarios fusionados en Supabase...');
                    await window.supabaseClient.client.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    
                    for (const user of mergedUsers) {
                        try {
                            await window.supabaseClient.client.from('users').insert({
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                tipo_cuenta: user.tipoCuenta || 'cliente_reserva'
                            });
                        } catch (e) {
                            // Ignorar errores
                        }
                    }
                }
                
                // Recargar tabla
                loadUsersData();
                
                alert(`‚úÖ Usuarios fusionados:\n- Usuarios originales: ${originalCount}\n- Fusiones realizadas: ${mergeCount}\n- Usuarios resultantes: ${mergedUsers.length}\n\nLos datos complementarios fueron combinados.`);
                
            } catch (error) {
                console.error('‚ùå Error al fusionar usuarios:', error);
                alert('‚ùå Error al fusionar usuarios: ' + error.message);
            }
        }

        // ===== FUNCIONES DE RESERVAS =====

        // Funci√≥n para inicializar base de datos de reservas
        async function initReservationsDB() {
            console.log('Inicializando base de datos de reservas...');
            
            // SIEMPRE intentar cargar desde Supabase primero cuando est√° disponible
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Supabase disponible, cargando reservas desde la nube...');
                    const supabaseReservations = await window.supabaseClient.getReservations();
                    if (supabaseReservations && supabaseReservations.length > 0) {
                        localStorage.setItem('reservationsDB', JSON.stringify(supabaseReservations));
                        console.log(`‚úÖ ${supabaseReservations.length} reservas cargadas desde Supabase`);
                        
                        // IMPORTANTE: Actualizar estad√≠sticas despu√©s de cargar reservas
                        console.log('üîÑ Actualizando estad√≠sticas con las reservas cargadas...');
                        if (typeof updateStats === 'function') {
                            updateStats();
                        }
                        if (typeof loadMonthlySales === 'function') {
                            loadMonthlySales();
                        }
                        return;
                    } else {
                        console.log('‚ÑπÔ∏è No hay reservas en Supabase. El sistema est√° listo para agregar reservas reales.');
                        localStorage.setItem('reservationsDB', JSON.stringify([]));
                        return;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error al cargar reservas desde Supabase:', error);
            }
            
            // Solo usar localStorage como fallback si Supabase no est√° disponible
            const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            if (existingReservations.length > 0) {
                console.log(`üíæ Usando ${existingReservations.length} reservas de localStorage (modo offline)`);
            } else {
                console.log('‚ÑπÔ∏è No hay reservas disponibles');
                localStorage.setItem('reservationsDB', JSON.stringify([]));
            }
        }

        // Variable global para almacenar todas las reservas
        let allReservationsData = [];
        
        // Funci√≥n para cargar tabla de reservas
        async function loadReservationsTable(searchFilter = '') {
            console.log('üîÑ Cargando tabla de reservas...');
            
            const tbody = document.getElementById('reservationsTableBody');
            if (!tbody) {
                console.error('‚ùå Tbody de reservas no encontrado');
                return;
            }
            
            // Intentar cargar desde Supabase primero
            let reservations = [];
            let loadedFromSupabase = false;
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando reservas desde Supabase...');
                    reservations = await window.supabaseClient.getReservations();
                    console.log(`‚úÖ ${reservations.length} reservas cargadas desde Supabase`);
                    loadedFromSupabase = true;
                    
                    // IMPORTANTE: Guardar en localStorage para que otras funciones tengan acceso
                    localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                    console.log('üíæ Reservas guardadas en localStorage');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                console.log('üíæ Cargando reservas desde localStorage...');
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            console.log(`üìã Encontradas ${reservations.length} reservas`);
            
            // Guardar todas las reservas en variables globales (para filtros)
            allReservationsData = reservations;
            allReservationsForFilter = reservations;
            
            // Cargar hoteles en el filtro
            loadHotelsForReservationFilter();
            
            // Si se cargaron datos frescos de Supabase, actualizar las estad√≠sticas
            if (loadedFromSupabase) {
                console.log('üîÑ Actualizando estad√≠sticas con datos frescos de Supabase...');
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            }
            
            // Ordenar reservas por fecha de check-in (m√°s recientes primero)
            reservations.sort((a, b) => {
                const dateA = new Date(a.check_in || a.checkIn || a.createdAt || 0);
                const dateB = new Date(b.check_in || b.checkIn || b.createdAt || 0);
                return dateB - dateA; // M√°s reciente primero
            });
            
            // Filtrar por m√∫ltiples campos si hay un filtro
            if (searchFilter && searchFilter.trim() !== '') {
                const filter = searchFilter.trim().toLowerCase();
                reservations = reservations.filter(reservation => {
                    // Buscar en c√≥digo de reserva (snake_case y camelCase)
                    const code = (reservation.reservation_code || reservation.reservationCode || reservation.code || '').toLowerCase();
                    
                    // Buscar en email del cliente
                    const email = (reservation.client_email || reservation.clientEmail || reservation.email || '').toLowerCase();
                    
                    // Buscar en nombre del cliente
                    const clientName = (reservation.client_name || reservation.clientName || reservation.name || '').toLowerCase();
                    
                    // Buscar en nombre del hotel
                    const hotelName = (reservation.hotel_name || reservation.hotelName || reservation.hotel || '').toLowerCase();
                    
                    // Buscar en tel√©fono
                    const phone = (reservation.client_phone || reservation.clientPhone || reservation.phone || '').toLowerCase();
                    
                    // Buscar en ID de reserva
                    const id = (reservation.id || '').toString().toLowerCase();
                    
                    // Buscar en estado
                    const status = (reservation.status || '').toLowerCase();
                    
                    // Buscar en agente
                    const agentName = (reservation.agent_name || reservation.agentName || '').toLowerCase();
                    
                    // Buscar en total (como string)
                    const total = (reservation.total_amount || reservation.totalAmount || '').toString();
                    
                    // Buscar en fechas
                    const checkIn = (reservation.check_in || reservation.checkIn || '').toLowerCase();
                    const checkOut = (reservation.check_out || reservation.checkOut || '').toLowerCase();
                    
                    // Verificar b√∫squeda parcial o exacta en cualquier campo
                    return code.includes(filter) ||
                           email.includes(filter) ||
                           clientName.includes(filter) ||
                           hotelName.includes(filter) ||
                           phone.includes(filter) ||
                           id.includes(filter) ||
                           status.includes(filter) ||
                           agentName.includes(filter) ||
                           total.includes(filter) ||
                           checkIn.includes(filter) ||
                           checkOut.includes(filter);
                });
                console.log(`üîç Filtradas ${reservations.length} reservas que contienen "${searchFilter}"`);
            } else {
                // Si no hay b√∫squeda, mostrar solo las √∫ltimas 20
                reservations = reservations.slice(0, 20);
                console.log(`üìã Mostrando las √∫ltimas 20 reservas de ${allReservationsData.length} totales`);
            }
            
            tbody.innerHTML = '';

            if (reservations.length === 0) {
                // Mostrar mensaje si no hay reservas
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-calendar" style="font-size: 3rem; color: #ddd;"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: #333;">${searchFilter ? 'No se encontraron reservas' : 'No hay reservas registradas'}</h3>
                        <p style="margin-bottom: 20px; color: #666;">${searchFilter ? `No hay reservas con c√≥digo que contenga "${searchFilter}"` : 'Comienza agregando tu primera reserva'}</p>
                        ${!searchFilter ? `<button onclick="addNewReservation()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nueva Reserva
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            reservations.forEach(reservation => {
                // Normalizar campos (soportar snake_case de Supabase y camelCase de localStorage)
                const clientName = reservation.client_name || reservation.clientName || 'Sin nombre';
                const clientEmail = reservation.client_email || reservation.clientEmail || '';
                const hotelName = reservation.hotel_name || reservation.hotelName || 'Sin hotel';
                const checkIn = reservation.check_in || reservation.checkIn || '';
                const checkOut = reservation.check_out || reservation.checkOut || '';
                const reservationCode = reservation.reservation_code || reservation.reservationCode || 'N/A';
                const totalAmount = reservation.total_amount || reservation.totalAmount || 0;
                const status = reservation.status || 'Pendiente';
                const paymentStatus = reservation.payment_status || reservation.paymentStatus || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500; color: #1976d2;">
                        <strong>${reservationCode}</strong>
                    </td>
                    <td>
                        <div>
                            <div class="hotel-name">${clientName}</div>
                            <div class="hotel-location">${clientEmail}</div>
                        </div>
                    </td>
                    <td>${hotelName}</td>
                    <td style="text-align: center;">
                        <div>
                            <div><strong>Entrada:</strong> ${formatDate(checkIn)}</div>
                            <div><strong>Salida:</strong> ${formatDate(checkOut)}</div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <span class="status-${status.toLowerCase()}">${status}</span>
                    </td>
                    <td style="text-align: center;">
                        <strong>$${Number(totalAmount).toLocaleString()}</strong>
                        ${paymentStatus ? `<div style="font-size: 0.8em; color: #666;">${paymentStatus}</div>` : ''}
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewReservation('${reservation.id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button onclick="editReservation('${reservation.id}')" class="action-btn edit" title="Modificar">
                            <span class="material-icons">edit</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`‚úÖ Tabla de reservas cargada con ${reservations.length} reservas`);
            
            // Mostrar informaci√≥n si hay m√°s reservas disponibles (solo si no hay b√∫squeda activa)
            const searchInput = document.getElementById('reservationSearchInput');
            const isSearching = searchInput && searchInput.value.trim() !== '';
            
            if (!isSearching && allReservationsData.length > reservations.length) {
                // Eliminar mensaje anterior si existe
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'reservations-info-message';
                infoDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.9rem; text-align: center;';
                infoDiv.innerHTML = `Mostrando las √∫ltimas ${reservations.length} reservas de ${allReservationsData.length} totales. Usa el buscador para encontrar m√°s reservas.`;
                
                const tableContainer = tbody.closest('.activity-card') || tbody.closest('div');
                if (tableContainer) {
                    tableContainer.appendChild(infoDiv);
                }
            } else if (isSearching) {
                // Eliminar mensaje informativo cuando hay b√∫squeda activa
                const existingInfo = document.querySelector('.reservations-info-message');
                if (existingInfo) existingInfo.remove();
            }
        }

        // Funci√≥n para filtrar reservas por c√≥digo
        function filterReservationsByCode(searchValue) {
            console.log('üîç Filtrando reservas por c√≥digo:', searchValue);
            loadReservationsTable(searchValue);
        }

        // Funci√≥n para actualizar estad√≠sticas de reservas
        function updateReservationsStats() {
            console.log('üìä Actualizando estad√≠sticas de reservas...');
            
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Actualizar contadores
            const totalReservationsElement = document.getElementById('totalReservations');
            const confirmedReservationsElement = document.getElementById('confirmedReservations');
            const modifiedReservationsElement = document.getElementById('modifiedReservations');
            const canceledReservationsElement = document.getElementById('canceledReservations');
            // Actualizar cantidad de Reservas Futuras
            const futureReservationsCountElement = document.getElementById('futureReservationsCount');
            
            if (totalReservationsElement) {
                totalReservationsElement.textContent = reservations.length;
            }
            
            if (confirmedReservationsElement) {
                const confirmed = reservations.filter(r => r.status === 'Confirmada').length;
                confirmedReservationsElement.textContent = confirmed;
            }
            
            if (modifiedReservationsElement) {
                const modified = reservations.filter(r => r.status === 'Modificada').length;
                modifiedReservationsElement.textContent = modified;
            }
            
            if (canceledReservationsElement) {
                const canceled = reservations.filter(r => r.status === 'Cancelada').length;
                canceledReservationsElement.textContent = canceled;
            }
            
            if (futureReservationsCountElement) {
                // Obtener fecha de hoy en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Funci√≥n auxiliar para normalizar fechas
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return null;
                    if (dateStr.includes('T')) {
                        return dateStr.split('T')[0];
                    }
                    return dateStr;
                };
                
                // Filtrar reservas futuras (checkIn >= hoy) que no est√©n canceladas
                const futureReservations = reservations.filter(reservation => {
                    // Excluir canceladas
                    const status = reservation.status || '';
                    if (status === 'Cancelada' || status === 'cancelada') {
                        return false;
                    }
                    
                    // Verificar si tiene checkIn
                    if (!reservation.checkIn) {
                        return false;
                    }
                    
                    // Normalizar fecha de checkIn
                    const checkInDate = normalizeDate(reservation.checkIn);
                    if (!checkInDate) {
                        return false;
                    }
                    
                    // Comparar con fecha de hoy (checkIn >= hoy)
                    return checkInDate >= todayStr;
                });
                
                const count = futureReservations.length;
                futureReservationsCountElement.textContent = count;
                
                console.log(`‚úÖ Cantidad de Reservas Futuras actualizada: ${count} reservas`);
            }
            
            console.log(`‚úÖ Estad√≠sticas de reservas actualizadas: ${reservations.length} reservas`);
            
            // Actualizar ventas mensuales si el dashboard est√° visible
            if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                loadMonthlySales();
            }
        }

        // Funci√≥n para mostrar modal de Cantidad de Reservas Futuras
        window.showTotalRevenueModal = function() {
            console.log('üìä Abriendo modal de Cantidad de Reservas Futuras...');
            
            // Obtener todas las reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Obtener fecha de hoy en formato YYYY-MM-DD (fecha local)
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Funci√≥n auxiliar para normalizar fechas
            function normalizeDate(dateStr) {
                if (!dateStr) return null;
                if (dateStr.includes('T')) {
                    return dateStr.split('T')[0];
                }
                return dateStr;
            }
            
            // Filtrar reservas futuras (checkIn >= hoy) que no est√©n canceladas
            const futureReservations = reservations.filter(reservation => {
                // Excluir canceladas
                const status = reservation.status || '';
                if (status === 'Cancelada' || status === 'cancelada') {
                    return false;
                }
                
                // Verificar si tiene checkIn
                if (!reservation.checkIn) {
                    return false;
                }
                
                // Normalizar fecha de checkIn
                const checkInDate = normalizeDate(reservation.checkIn);
                if (!checkInDate) {
                    return false;
                }
                
                // Comparar con fecha de hoy (checkIn >= hoy)
                return checkInDate >= todayStr;
            });
            
            // Calcular cantidad de reservas futuras
            const futureReservationsCount = futureReservations.length;
            
            console.log('üìä Reservas futuras:', {
                cantidad: futureReservationsCount,
                fechaHoy: todayStr
            });
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #333; font-size: 1.5rem;">üìÖ Cantidad de Reservas Futuras</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 8px; padding: 30px; text-align: center;">
                        <div style="width: 80px; height: 80px; background-color: #9c27b0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                            <span class="material-icons" style="color: white; font-size: 40px;">event</span>
                        </div>
                        <h3 style="margin: 0; font-size: 3rem; color: #333; font-weight: 700;">${futureReservationsCount}</h3>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 1.1rem; font-weight: 500;">Reservas Futuras</p>
                        <p style="margin: 12px 0 0 0; color: #999; font-size: 0.9rem;">Reservas desde hoy (${todayStr}) hacia adelante</p>
                    </div>
                    
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="margin: 0; color: #666; font-size: 0.9rem; text-align: center;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</span>
                            Solo se incluyen reservas confirmadas o modificadas (no canceladas)
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // Funci√≥n para cargar ventas mensuales con filtros
        function loadMonthlySales(filterFrom = null, filterTo = null, filterHotelId = 'all') {
            console.log('üìä Cargando ventas mensuales...', { filterFrom, filterTo, filterHotelId });
            
            const monthlySalesContent = document.getElementById('monthlySalesContent');
            if (!monthlySalesContent) {
                console.error('‚ùå Contenedor de ventas mensuales no encontrado');
                return;
            }
            
            // Obtener todas las reservas
            let reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // DEBUG: Mostrar estructura de la primera reserva
            if (reservations.length > 0) {
                console.log('üîç DEBUG - Primera reserva:', JSON.stringify(reservations[0], null, 2));
                console.log('üîç DEBUG - Campos de monto disponibles:', {
                    totalAmount: reservations[0].totalAmount,
                    total_amount: reservations[0].total_amount,
                    amount: reservations[0].amount,
                    price: reservations[0].price
                });
                console.log('üîç DEBUG - Campos de fecha disponibles:', {
                    checkIn: reservations[0].checkIn,
                    check_in: reservations[0].check_in
                });
            }
            
            if (!reservations || reservations.length === 0) {
                // Restaurar estilos por defecto
                monthlySalesContent.style.display = 'flex';
                monthlySalesContent.style.alignItems = 'center';
                monthlySalesContent.style.justifyContent = 'center';
                monthlySalesContent.style.background = '#f5f5f5';
                monthlySalesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtro de hotel (buscar en camelCase y snake_case)
            if (filterHotelId && filterHotelId !== 'all') {
                reservations = reservations.filter(reservation => {
                    const hotelId = reservation.hotelId || reservation.hotel_id;
                    return hotelId === filterHotelId || 
                           hotelId === parseInt(filterHotelId) ||
                           (hotelId && hotelId.toString() === filterHotelId.toString());
                });
                console.log(`üè® Filtrado por hotel ${filterHotelId}: ${reservations.length} reservas`);
            }
            
            // Objeto para agrupar ventas por mes/a√±o
            const monthlySales = {};
            
            // Procesar cada reserva
            reservations.forEach(reservation => {
                // Obtener fecha de check-in (buscar en camelCase y snake_case)
                const checkInDate = reservation.checkIn || reservation.check_in;
                // Buscar monto en diferentes campos posibles (camelCase y snake_case)
                const totalAmount = parseFloat(reservation.totalAmount) || 
                                   parseFloat(reservation.total_amount) || 
                                   parseFloat(reservation.amount) || 
                                   parseFloat(reservation.price) || 0;
                
                if (!checkInDate || totalAmount <= 0) {
                    console.log('‚ö†Ô∏è Reserva saltada:', { checkInDate, totalAmount, reservation: reservation.reservation_code || reservation.reservationCode });
                    return; // Saltar reservas sin fecha de check-in o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = checkInDate;
                if (checkInDate.includes('T')) {
                    dateStr = checkInDate.split('T')[0];
                }
                
                // Extraer a√±o y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inv√°lido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inv√°lida
                }
                
                // Crear clave √∫nica para mes/a√±o (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToYear = parseInt(filterTo.split('-')[0]);
                    const filterToMonth = parseInt(filterTo.split('-')[1]);
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (despu√©s del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlySales[monthKey]) {
                    monthlySales[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        count: 0
                    };
                }
                
                // Sumar venta (solo si no est√° cancelada)
                if (reservation.status !== 'Cancelada') {
                    monthlySales[monthKey].total += totalAmount;
                    monthlySales[monthKey].count += 1;
                }
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() devuelve 0-11
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                // Ajustar si el mes es negativo (a√±o anterior)
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                // Ajustar si el mes es mayor a 12 (a√±o siguiente)
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalSalesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlySales[monthKey]) {
                    // Si hay datos para este mes, usar los datos reales
                    return monthlySales[monthKey];
                } else {
                    // Si no hay datos, crear entrada con valores en 0
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por a√±o y mes (m√°s reciente primero para mostrar: futuro -> presente -> pasado)
            finalSalesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year; // A√±o m√°s reciente primero
                }
                return b.month - a.month; // Mes m√°s reciente primero
            });
            
            // Nombres de meses en espa√±ol
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/A√±o</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Reservas</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalSalesArray.forEach(sale => {
                const monthName = monthNames[sale.month - 1];
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${sale.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${sale.count}</td>
                        <td style="padding: 10px; text-align: right; color: #1976d2; font-weight: 600;">$${sale.total.toLocaleString('es-AR')}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor para que no use flex cuando hay tabla
            monthlySalesContent.style.display = 'block';
            monthlySalesContent.style.alignItems = 'stretch';
            monthlySalesContent.style.justifyContent = 'flex-start';
            monthlySalesContent.style.background = 'transparent';
            monthlySalesContent.innerHTML = html;
            
            console.log(`‚úÖ Ventas mensuales cargadas: ${finalSalesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Funci√≥n para cargar hoteles en el selector de filtro
        function loadHotelsForMonthlySalesFilter() {
            const hotelFilter = document.getElementById('hotelFilter');
            if (!hotelFilter) {
                return;
            }
            
            // Obtener hoteles
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            // Limpiar opciones excepto "Todos los hoteles"
            hotelFilter.innerHTML = '<option value="all">Todos los hoteles</option>';
            
            // Agregar hoteles
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name || `Hotel ${hotel.id}`;
                hotelFilter.appendChild(option);
            });
            
            console.log(`‚úÖ ${hotels.length} hoteles cargados en el filtro`);
        }
        
        // Funci√≥n para aplicar filtros de ventas mensuales
        function applyMonthlySalesFilters() {
            const monthFrom = document.getElementById('monthFilterFrom').value;
            const monthTo = document.getElementById('monthFilterTo').value;
            const hotelId = document.getElementById('hotelFilter').value;
            
            // Validar que si hay "desde", tambi√©n debe haber "hasta" o viceversa (opcional, pero mejor si ambos est√°n)
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('‚ö†Ô∏è El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlySales(monthFrom || null, monthTo || null, hotelId || 'all');
        }
        
        // Funci√≥n para limpiar filtros de ventas mensuales
        function clearMonthlySalesFilters() {
            document.getElementById('monthFilterFrom').value = '';
            document.getElementById('monthFilterTo').value = '';
            document.getElementById('hotelFilter').value = 'all';
            loadMonthlySales(null, null, 'all');
        }
        
        // Funci√≥n para cargar gastos mensuales con filtros
        function loadMonthlyExpenses(filterFrom = null, filterTo = null, filterCategory = 'all', filterType = 'all') {
            console.log('üí∞ Cargando gastos mensuales...', { filterFrom, filterTo, filterCategory, filterType });
            
            const monthlyExpensesContent = document.getElementById('monthlyExpensesContent');
            if (!monthlyExpensesContent) {
                console.error('‚ùå Contenedor de gastos mensuales no encontrado');
                return;
            }
            
            // Obtener todos los gastos
            let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            if (!expenses || expenses.length === 0) {
                monthlyExpensesContent.style.display = 'flex';
                monthlyExpensesContent.style.alignItems = 'center';
                monthlyExpensesContent.style.justifyContent = 'center';
                monthlyExpensesContent.style.background = '#f5f5f5';
                monthlyExpensesContent.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Sin datos disponibles</p>';
                return;
            }
            
            // Aplicar filtros
            if (filterCategory && filterCategory !== 'all') {
                expenses = expenses.filter(expense => expense.category === filterCategory);
                console.log(`üìÇ Filtrado por categor√≠a ${filterCategory}: ${expenses.length} gastos`);
            }
            
            if (filterType && filterType !== 'all') {
                expenses = expenses.filter(expense => expense.type === filterType);
                console.log(`üìã Filtrado por tipo ${filterType}: ${expenses.length} gastos`);
            }
            
            // Objeto para agrupar gastos por mes/a√±o
            const monthlyExpenses = {};
            
            // Procesar cada gasto
            expenses.forEach(expense => {
                const expenseDate = expense.date;
                const totalAmount = parseFloat(expense.amount) || 0;
                
                if (!expenseDate || totalAmount <= 0) {
                    return; // Saltar gastos sin fecha o sin monto
                }
                
                // Normalizar fecha (formato YYYY-MM-DD)
                let dateStr = expenseDate;
                if (dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                
                // Extraer a√±o y mes
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) {
                    return; // Formato de fecha inv√°lido
                }
                
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                
                if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                    return; // Fecha inv√°lida
                }
                
                // Crear clave √∫nica para mes/a√±o (YYYY-MM)
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Aplicar filtro de rango de meses
                if (filterFrom) {
                    const filterFromDate = new Date(filterFrom + '-01');
                    const currentDate = new Date(year, month - 1, 1);
                    if (currentDate < filterFromDate) {
                        return; // Fuera del rango (antes del mes desde)
                    }
                }
                
                if (filterTo) {
                    const filterToDate = new Date(filterTo + '-01');
                    const filterToYear = filterToDate.getFullYear();
                    const filterToMonth = filterToDate.getMonth() + 1;
                    if (year > filterToYear || (year === filterToYear && month > filterToMonth)) {
                        return; // Fuera del rango (despu√©s del mes hasta)
                    }
                }
                
                // Inicializar si no existe
                if (!monthlyExpenses[monthKey]) {
                    monthlyExpenses[monthKey] = {
                        year: year,
                        month: month,
                        total: 0,
                        totalUSD: 0,
                        count: 0
                    };
                }
                
                // Sumar gasto en pesos
                monthlyExpenses[monthKey].total += totalAmount;
                monthlyExpenses[monthKey].count += 1;
                
                // Sumar gasto en USD usando el tipo de cambio del momento del gasto
                const expenseExchangeRate = parseFloat(expense.exchangeRate || expense.exchange_rate) || 0;
                const expenseUSD = parseFloat(expense.usd || expense.usd_amount) || 0;
                
                if (expenseUSD > 0) {
                    // Si ya tiene USD calculado, usarlo directamente
                    monthlyExpenses[monthKey].totalUSD += expenseUSD;
                } else if (expenseExchangeRate > 0) {
                    // Si tiene tipo de cambio, calcular USD
                    monthlyExpenses[monthKey].totalUSD += totalAmount / expenseExchangeRate;
                }
                // Si no tiene tipo de cambio ni USD, no sumar (quedar√° en 0)
            });
            
            // Calcular rango de meses: 4 anteriores + mes actual + 4 siguientes
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Crear array con los 9 meses (4 anteriores + actual + 4 siguientes)
            const monthsToShow = [];
            
            // Agregar 4 meses anteriores
            for (let i = 4; i >= 1; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                while (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Agregar mes actual
            const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            monthsToShow.push({
                year: currentYear,
                month: currentMonth,
                monthKey: currentMonthKey
            });
            
            // Agregar 4 meses siguientes
            for (let i = 1; i <= 4; i++) {
                let year = currentYear;
                let month = currentMonth + i;
                
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                monthsToShow.push({
                    year: year,
                    month: month,
                    monthKey: monthKey
                });
            }
            
            // Crear array final combinando datos reales con meses sin datos
            const finalExpensesArray = monthsToShow.map(monthInfo => {
                const monthKey = monthInfo.monthKey;
                if (monthlyExpenses[monthKey]) {
                    return monthlyExpenses[monthKey];
                } else {
                    return {
                        year: monthInfo.year,
                        month: monthInfo.month,
                        total: 0,
                        totalUSD: 0,
                        count: 0
                    };
                }
            });
            
            // Ordenar por a√±o y mes (m√°s reciente primero)
            finalExpensesArray.sort((a, b) => {
                if (a.year !== b.year) {
                    return b.year - a.year;
                }
                return b.month - a.month;
            });
            
            // Nombres de meses en espa√±ol
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            // Crear tabla HTML
            let html = `
                <div style="overflow-x: auto; background-color: transparent;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left; font-weight: 600; color: #333;">Mes/A√±o</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Gastos</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #333;">Total ARS</th>
                                <th style="padding: 10px; text-align: right; font-weight: 600; color: #2e7d32;">Total USD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            finalExpensesArray.forEach(expense => {
                const monthName = monthNames[expense.month - 1];
                const totalUSD = expense.totalUSD || 0;
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; color: #333; font-weight: 500;">${monthName} ${expense.year}</td>
                        <td style="padding: 10px; text-align: right; color: #666;">${expense.count}</td>
                        <td style="padding: 10px; text-align: right; color: #d32f2f; font-weight: 600;">$${expense.total.toLocaleString('es-AR')}</td>
                        <td style="padding: 10px; text-align: right; color: #2e7d32; font-weight: 600;">$${totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Aplicar estilos al contenedor
            monthlyExpensesContent.style.display = 'block';
            monthlyExpensesContent.style.alignItems = 'stretch';
            monthlyExpensesContent.style.justifyContent = 'flex-start';
            monthlyExpensesContent.style.background = 'transparent';
            monthlyExpensesContent.innerHTML = html;
            
            console.log(`‚úÖ Gastos mensuales cargados: ${finalExpensesArray.length} meses (4 anteriores + actual + 4 siguientes)`);
        }
        
        // Funci√≥n para cargar categor√≠as en el filtro de gastos
        function loadExpenseCategoriesForFilter() {
            const categoryFilter = document.getElementById('expenseCategoryFilter');
            if (!categoryFilter) {
                return;
            }
            
            // Limpiar opciones excepto "Todas las categor√≠as"
            categoryFilter.innerHTML = '<option value="all">Todas las categor√≠as</option>';
            
            // Agregar categor√≠as
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categoryFilter.appendChild(option);
            });
            
            console.log(`‚úÖ ${Object.keys(expenseCategories).length} categor√≠as cargadas en el filtro`);
        }
        
        // Funci√≥n para aplicar filtros de gastos mensuales
        function applyMonthlyExpensesFilters() {
            const monthFrom = document.getElementById('expenseMonthFilterFrom').value;
            const monthTo = document.getElementById('expenseMonthFilterTo').value;
            const category = document.getElementById('expenseCategoryFilter').value;
            const type = document.getElementById('expenseTypeFilter').value;
            
            // Validar que si hay "desde", tambi√©n debe haber "hasta" o viceversa
            if (monthFrom && monthTo) {
                if (monthFrom > monthTo) {
                    alert('‚ö†Ô∏è El mes "Desde" no puede ser posterior al mes "Hasta"');
                    return;
                }
            }
            
            loadMonthlyExpenses(monthFrom || null, monthTo || null, category || 'all', type || 'all');
        }
        
        // Funci√≥n para limpiar filtros de gastos mensuales
        function clearMonthlyExpensesFilters() {
            document.getElementById('expenseMonthFilterFrom').value = '';
            document.getElementById('expenseMonthFilterTo').value = '';
            document.getElementById('expenseCategoryFilter').value = 'all';
            document.getElementById('expenseTypeFilter').value = 'all';
            loadMonthlyExpenses(null, null, 'all', 'all');
        }

        // Funci√≥n para agregar nueva reserva
        function addNewReservation() {
            console.log('üÜï Abriendo formulario para nueva reserva...');
            
            // Limpiar el formulario
            const form = document.getElementById('newReservationForm');
            if (form) {
                form.reset();
            }
            
            // Generar c√≥digo de reserva autom√°tico
            const reservationCodeInput = document.getElementById('newReservationCode');
            if (reservationCodeInput) {
                reservationCodeInput.value = generateReservationCode();
            }
            
            // Establecer fecha m√≠nima como hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newCheckIn').min = today;
            document.getElementById('newCheckOut').min = today;
            
            // Establecer fecha de registro como hoy
            const reservationDateInput = document.getElementById('newReservationDate');
            if (reservationDateInput) {
                reservationDateInput.value = today;
            }
            
            // Cargar hoteles en el select
            loadHotelsForNewReservation();
            
            // Cargar agentes en el select
            loadAgentsForNewReservation();
            
            // Mostrar el modal
            document.getElementById('newReservationModal').style.display = 'block';
            
            console.log('‚úÖ Modal de nueva reserva abierto');
        }

        // Funci√≥n para editar reserva
        async function editReservation(reservationId) {
            console.log('‚úèÔ∏è Editando reserva:', reservationId);
            
            // Buscar primero en Supabase, luego en localStorage
            let reservations = [];
            let reservation = null;
            
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    reservations = await window.supabaseClient.getReservations();
                } catch (error) {
                    console.error('Error cargando reservas de Supabase:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            // Buscar la reserva por ID (puede ser UUID string)
            reservation = reservations.find(r => r.id === reservationId || r.id == reservationId);
            
            if (!reservation) {
                console.error('‚ùå Reserva no encontrada:', reservationId);
                alert('‚ùå Reserva no encontrada');
                return;
            }
            
            console.log('üìã Datos de reserva encontrada:', reservation);
            
            // Funci√≥n auxiliar para normalizar fechas al formato YYYY-MM-DD
            // Evita problemas de zona horaria parseando manualmente
            const normalizeDate = (dateString) => {
                if (!dateString) return '';
                
                // Si ya est√° en formato YYYY-MM-DD, devolverlo tal cual
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                // Si est√° en formato ISO (YYYY-MM-DDTHH:mm:ss), extraer solo la fecha
                const isoMatch = dateString.match(/^(\d{4}-\d{2}-\d{2})/);
                if (isoMatch) {
                    return isoMatch[1];
                }
                
                // Si est√° en formato DD/MM/YYYY o DD-MM-YYYY, convertir manualmente
                const ddmmyyyyMatch = dateString.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
                if (ddmmyyyyMatch) {
                    const day = ddmmyyyyMatch[1];
                    const month = ddmmyyyyMatch[2];
                    const year = ddmmyyyyMatch[3];
                    return `${year}-${month}-${day}`;
                }
                
                // Si est√° en formato YYYY/MM/DD, convertir manualmente
                const yyyymmddMatch = dateString.match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
                if (yyyymmddMatch) {
                    return dateString.replace(/[\/\-]/g, '-');
                }
                
                // Como √∫ltimo recurso, intentar con Date pero usando UTC para evitar problemas de zona horaria
                try {
                    // Si la fecha incluye hora, extraer solo la parte de fecha
                    const dateOnly = dateString.split('T')[0];
                    if (/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) {
                        return dateOnly;
                    }
                    
                    // Parsear manualmente para evitar problemas de zona horaria
                    const date = new Date(dateString + 'T12:00:00'); // Usar mediod√≠a para evitar cambios de d√≠a
                    if (isNaN(date.getTime())) return '';
                    
                    // Usar UTC para evitar problemas de zona horaria
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error('Error normalizando fecha:', dateString, e);
                    return '';
                }
            };
            
            // Llenar el formulario con los datos de la reserva (soportar camelCase y snake_case)
            document.getElementById('editClientName').value = reservation.client_name || reservation.clientName || '';
            document.getElementById('editClientEmail').value = reservation.client_email || reservation.clientEmail || '';
            document.getElementById('editClientPhone').value = reservation.client_phone || reservation.clientPhone || '';
            document.getElementById('editReservationCode').value = reservation.reservation_code || reservation.reservationCode || '';
            document.getElementById('editCheckIn').value = normalizeDate(reservation.check_in || reservation.checkIn);
            document.getElementById('editCheckOut').value = normalizeDate(reservation.check_out || reservation.checkOut);
            document.getElementById('editReservationDate').value = normalizeDate(reservation.reservation_date || reservation.reservationDate);
            document.getElementById('editTotalAmount').value = reservation.total_amount || reservation.totalAmount || 0;
            
            // Cargar hoteles en el select y seleccionar el correcto
            loadHotelsForEdit(reservation.hotel_id || reservation.hotelId);
            
            // Cargar agentes en el select y seleccionar el correcto
            loadAgentsForEdit(reservation.agent_name || reservation.agentName);
            
            // Actualizar el t√≠tulo del modal
            document.getElementById('editReservationTitle').textContent = `Editar Reserva - ${reservation.reservation_code || reservation.reservationCode || reservation.id}`;
            
            // Guardar el ID de la reserva en el formulario
            document.getElementById('editReservationForm').dataset.reservationId = reservationId;
            
            // Mostrar el modal
            document.getElementById('editReservationModal').style.display = 'block';
            
            console.log('‚úÖ Modal de edici√≥n abierto para reserva:', reservation.reservationCode);
        }

        // Funci√≥n para eliminar reserva
        function deleteReservation(reservationId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta reserva?')) {
                console.log('üóëÔ∏è Eliminando reserva:', reservationId);
                
                const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const updatedReservations = reservations.filter(r => r.id !== reservationId);
                
                localStorage.setItem('reservationsDB', JSON.stringify(updatedReservations));
                
                console.log('‚úÖ Reserva eliminada correctamente');
                alert('‚úÖ Reserva eliminada correctamente');
                
                // Actualizar tabla y estad√≠sticas
                loadReservationsTable();
                updateReservationsStats();
            }
        }

        // Funci√≥n para ver detalles de reserva
        async function viewReservation(reservationId) {
            console.log('üëÅÔ∏è Viendo detalles de reserva:', reservationId);
            
            // Buscar en Supabase primero, luego en localStorage
            let reservations = [];
            let reservation = null;
            
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    reservations = await window.supabaseClient.getReservations();
                } catch (error) {
                    console.error('Error cargando reservas de Supabase:', error);
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
            } else {
                reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            }
            
            reservation = reservations.find(r => r.id === reservationId || r.id == reservationId);
            
            if (!reservation) {
                console.error('‚ùå Reserva no encontrada:', reservationId);
                alert('‚ùå Reserva no encontrada');
                return;
            }
            
            // Obtener valores soportando ambos formatos (snake_case y camelCase)
            const clientName = reservation.client_name || reservation.clientName || 'N/A';
            const clientEmail = reservation.client_email || reservation.clientEmail || 'N/A';
            const clientPhone = reservation.client_phone || reservation.clientPhone || 'N/A';
            const hotelName = reservation.hotel_name || reservation.hotelName || 'N/A';
            const checkIn = reservation.check_in || reservation.checkIn || 'N/A';
            const checkOut = reservation.check_out || reservation.checkOut || 'N/A';
            const status = reservation.status || 'N/A';
            const totalAmount = reservation.total_amount || reservation.totalAmount || 0;
            const reservationCode = reservation.reservation_code || reservation.reservationCode || reservation.id;
            const agentName = reservation.agent_name || reservation.agentName || 'Sin asignar';
            
            // Crear modal de detalles
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 10px; box-sizing: border-box;';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto; margin: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">üìÖ ${reservationCode}</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>üë§ Informaci√≥n del Cliente</h3>
                        <p><strong>Nombre:</strong> ${clientName}</p>
                        <p><strong>Email:</strong> ${clientEmail}</p>
                        <p><strong>Tel√©fono:</strong> ${clientPhone}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>üè® Informaci√≥n de la Reserva</h3>
                        <p><strong>Hotel:</strong> ${hotelName}</p>
                        <p><strong>Entrada:</strong> ${formatDate(checkIn)}</p>
                        <p><strong>Salida:</strong> ${formatDate(checkOut)}</p>
                        <p><strong>Agente:</strong> ${agentName}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>üí∞ Informaci√≥n de Pago</h3>
                        <p><strong>Estado:</strong> <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${status === 'Confirmada' ? '#e8f5e9' : status === 'Cancelada' ? '#ffebee' : status === 'Modificada' ? '#e3f2fd' : '#fff3e0'}; color: ${status === 'Confirmada' ? '#2e7d32' : status === 'Cancelada' ? '#c62828' : status === 'Modificada' ? '#1565c0' : '#e65100'};">${status}</span></p>
                        <p><strong>Total:</strong> $${totalAmount.toLocaleString()} USD</p>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="editReservation('${reservation.id}'); this.closest('.modal').remove()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Variable global para almacenar todas las reservas (para filtros)
        let allReservationsForFilter = [];
        
        // Funci√≥n auxiliar para normalizar fechas a formato comparable (YYYY-MM-DD)
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            // Si ya es Date object
            if (dateStr instanceof Date) {
                return dateStr.toISOString().split('T')[0];
            }
            
            // Si es string, intentar parsear
            const dateString = String(dateStr).trim();
            
            // Formato ISO: 2025-12-14 o 2025-12-14T...
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                return dateString.substring(0, 10);
            }
            
            // Formato DD/MM/YYYY
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('/');
                return `${year}-${month}-${day}`;
            }
            
            // Formato DD-MM-YYYY
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('-');
                return `${year}-${month}-${day}`;
            }
            
            // Intentar parsear con Date
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {}
            
            return dateString;
        }
        
        // Funci√≥n para aplicar filtros avanzados de reservas
        function applyReservationFilters() {
            const codeFilter = document.getElementById('filterReservationCode')?.value?.toLowerCase() || '';
            const nameFilter = document.getElementById('filterClientName')?.value?.toLowerCase() || '';
            const checkInFrom = document.getElementById('filterCheckInFrom')?.value || '';
            const checkInTo = document.getElementById('filterCheckInTo')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const hotelFilter = document.getElementById('filterHotel')?.value || '';
            
            console.log('üîç Aplicando filtros:', { codeFilter, nameFilter, checkInFrom, checkInTo, statusFilter, hotelFilter });
            
            let filtered = allReservationsForFilter.filter(r => {
                // Filtro por c√≥digo
                const code = (r.reservation_code || r.reservationCode || '').toLowerCase();
                if (codeFilter && !code.includes(codeFilter)) return false;
                
                // Filtro por nombre
                const clientName = (r.client_name || r.clientName || '').toLowerCase();
                if (nameFilter && !clientName.includes(nameFilter)) return false;
                
                // Filtro por fecha de entrada (desde) - usando normalizaci√≥n
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                const filterFrom = normalizeDate(checkInFrom);
                const filterTo = normalizeDate(checkInTo);
                
                if (filterFrom && checkIn && checkIn < filterFrom) return false;
                
                // Filtro por fecha de entrada (hasta)
                if (filterTo && checkIn && checkIn > filterTo) return false;
                
                // Filtro por estado
                const status = (r.status || '').toUpperCase();
                if (statusFilter && !status.includes(statusFilter.toUpperCase())) return false;
                
                // Filtro por hotel
                const hotelName = (r.hotel_name || r.hotelName || '').toLowerCase();
                if (hotelFilter && !hotelName.toLowerCase().includes(hotelFilter.toLowerCase())) return false;
                
                return true;
            });
            
            console.log(`üìä Filtro aplicado: ${filtered.length} de ${allReservationsForFilter.length} reservas`);
            
            // Actualizar tabla con resultados filtrados
            renderReservationsTable(filtered);
            
            // Mostrar contador de resultados
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `üìä ${filtered.length} de ${allReservationsForFilter.length} reservas`;
            }
        }
        
        // Funci√≥n para limpiar filtros
        function clearReservationFilters() {
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = '';
            document.getElementById('filterCheckInTo').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            document.getElementById('reservationSearchInput').value = '';
            
            renderReservationsTable(allReservationsForFilter);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = '';
            }
        }
        
        // Funci√≥n para filtrar reservas con check-in de hoy
        function filterTodayReservations() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log(`üìÖ Filtrando reservas con check-in de hoy: ${todayStr}`);
            
            const todayReservations = allReservationsForFilter.filter(r => {
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                
                const isToday = checkIn === todayStr;
                if (isToday) {
                    console.log(`‚úÖ Check-in hoy: ${r.reservation_code || r.reservationCode} - ${r.client_name || r.clientName} - $${r.total_amount || r.totalAmount}`);
                }
                return isToday;
            });
            
            console.log(`üìä Reservas con check-in hoy: ${todayReservations.length}`);
            
            // Limpiar otros filtros y establecer fecha de hoy
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = todayStr;
            document.getElementById('filterCheckInTo').value = todayStr;
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            
            renderReservationsTable(todayReservations);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `üìÖ ${todayReservations.length} reserva(s) con check-in hoy (${todayStr})`;
            }
            
            if (todayReservations.length === 0) {
                alert(`‚ÑπÔ∏è No hay reservas con check-in para hoy (${todayStr})`);
            }
        }
        
        // Funci√≥n para filtrar reservas futuras
        function filterFutureReservations() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            console.log(`üîÆ Filtrando reservas futuras desde: ${todayStr}`);
            
            const futureReservations = allReservationsForFilter.filter(r => {
                const checkInRaw = r.check_in || r.checkIn || '';
                const checkIn = normalizeDate(checkInRaw);
                return checkIn && checkIn >= todayStr;
            });
            
            // Ordenar por fecha de check-in
            futureReservations.sort((a, b) => {
                const dateA = normalizeDate(a.check_in || a.checkIn || '');
                const dateB = normalizeDate(b.check_in || b.checkIn || '');
                return dateA.localeCompare(dateB);
            });
            
            console.log(`üìä Reservas futuras: ${futureReservations.length}`);
            
            // Limpiar otros filtros
            document.getElementById('filterReservationCode').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterCheckInFrom').value = todayStr;
            document.getElementById('filterCheckInTo').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterHotel').value = '';
            
            renderReservationsTable(futureReservations);
            
            const countSpan = document.getElementById('filterResultsCount');
            if (countSpan) {
                countSpan.textContent = `üîÆ ${futureReservations.length} reserva(s) futuras desde ${todayStr}`;
            }
        }
        
        // Funci√≥n para cargar hoteles en el filtro
        function loadHotelsForReservationFilter() {
            const filterHotel = document.getElementById('filterHotel');
            if (!filterHotel) return;
            
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            filterHotel.innerHTML = '<option value="">Todos los hoteles</option>';
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.name;
                option.textContent = hotel.name;
                filterHotel.appendChild(option);
            });
        }
        
        // Funci√≥n para renderizar tabla de reservas
        function renderReservationsTable(reservations) {
            const tbody = document.getElementById('reservationsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (reservations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">No se encontraron reservas con los filtros aplicados</td></tr>';
                return;
            }
            
            reservations.forEach(reservation => {
                const code = reservation.reservation_code || reservation.reservationCode || '';
                const clientName = reservation.client_name || reservation.clientName || '';
                const hotelName = reservation.hotel_name || reservation.hotelName || '';
                const checkIn = reservation.check_in || reservation.checkIn || '';
                const checkOut = reservation.check_out || reservation.checkOut || '';
                const status = reservation.status || '';
                const total = reservation.total_amount || reservation.totalAmount || 0;
                const id = reservation.id || '';
                
                // Formatear fechas
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                };
                
                // Color del estado
                let statusColor = '#4caf50';
                let statusBg = '#e8f5e9';
                if (status.toUpperCase().includes('CANCEL')) {
                    statusColor = '#f44336';
                    statusBg = '#ffebee';
                } else if (status.toUpperCase().includes('MODIF')) {
                    statusColor = '#ff9800';
                    statusBg = '#fff3e0';
                } else if (status.toUpperCase().includes('PEND')) {
                    statusColor = '#2196f3';
                    statusBg = '#e3f2fd';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; font-family: monospace; font-size: 12px;">${code}</td>
                    <td style="padding: 12px;">${clientName}</td>
                    <td style="padding: 12px;">${hotelName}</td>
                    <td style="padding: 12px; text-align: center;">
                        <strong>Entrada:</strong> ${formatDate(checkIn)}<br>
                        <strong>Salida:</strong> ${formatDate(checkOut)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ${statusBg}; color: ${statusColor}; font-weight: 500;">
                            ${status}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">$${total.toLocaleString()}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewReservation('${id}')" class="action-btn view" title="Ver">
                            <span class="material-icons">visibility</span>
                        </button>
                        <button onclick="editReservation('${id}')" class="action-btn edit" title="Editar">
                            <span class="material-icons">edit</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funci√≥n para exportar reservas a Excel
        async function exportReservations() {
            console.log('üì§ Exportando reservas a Excel...');
            
            try {
                // Intentar obtener reservas de Supabase primero
                let reservations = [];
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        reservations = await window.supabaseClient.getReservations();
                        console.log(`‚úÖ ${reservations.length} reservas cargadas de Supabase para exportar`);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error cargando de Supabase, usando localStorage:', error);
                        reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    }
                } else {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                if (reservations.length === 0) {
                    alert('‚ö†Ô∏è No hay reservas para exportar');
                    return;
                }
                
                // Preparar datos para Excel (soportar ambos formatos de campos)
                const excelData = reservations.map(reservation => {
                    return {
                        'C√≥digo': reservation.reservation_code || reservation.reservationCode || '',
                        'Cliente': reservation.client_name || reservation.clientName || '',
                        'Email': reservation.client_email || reservation.clientEmail || '',
                        'Tel√©fono': reservation.client_phone || reservation.clientPhone || '',
                        'Hotel': reservation.hotel_name || reservation.hotelName || '',
                        'Fecha Entrada': reservation.check_in || reservation.checkIn || '',
                        'Fecha Salida': reservation.check_out || reservation.checkOut || '',
                        'Fecha Registro': reservation.reservation_date || reservation.reservationDate || '',
                        'Agente': reservation.agent_name || reservation.agentName || '',
                        'Estado': reservation.status || '',
                        'Total': reservation.total_amount || reservation.totalAmount || 0,
                        'Adultos': reservation.adults || '',
                        'Ni√±os': reservation.children || '',
                        'Notas': reservation.notes || ''
                    };
                });
                
                // Crear workbook y worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // C√≥digo
                    { wch: 25 }, // Cliente
                    { wch: 30 }, // Email
                    { wch: 15 }, // Tel√©fono
                    { wch: 30 }, // Hotel
                    { wch: 15 }, // Fecha Entrada
                    { wch: 15 }, // Fecha Salida
                    { wch: 15 }, // Fecha Registro
                    { wch: 20 }, // Agente
                    { wch: 12 }, // Estado
                    { wch: 12 }  // Total
                ];
                ws['!cols'] = colWidths;
                
                // Agregar worksheet al workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Reservas');
                
                // Generar nombre de archivo con fecha
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0];
                const fileName = `Reservas_${dateStr}.xlsx`;
                
                // Descargar archivo
                XLSX.writeFile(wb, fileName);
                
                console.log(`‚úÖ ${reservations.length} reservas exportadas correctamente`);
                alert(`‚úÖ ${reservations.length} reservas exportadas correctamente a ${fileName}`);
                
            } catch (error) {
                console.error('‚ùå Error al exportar reservas:', error);
                alert('‚ùå Error al exportar reservas: ' + error.message);
            }
        }
        
        // Funci√≥n para abrir modal de importaci√≥n
        function importReservations() {
            console.log('üì• Abriendo modal de importaci√≥n...');
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'flex';
                // Limpiar input de archivo
                const fileInput = document.getElementById('importFileInput');
                if (fileInput) {
                    fileInput.value = '';
                }
            }
        }
        
        // Funci√≥n para cerrar modal de importaci√≥n
        function closeImportReservationsModal() {
            const modal = document.getElementById('importReservationsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para procesar archivo Excel importado
        function processImportFile() {
            const fileInput = document.getElementById('importFileInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('‚ö†Ô∏è Por favor selecciona un archivo Excel');
                return;
            }
            
            const file = fileInput.files[0];
            console.log('üì• Procesando archivo:', file.name);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Leer el archivo Excel
                    // Usar cellDates: true para que SheetJS intente parsear fechas autom√°ticamente cuando sea posible
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // Obtener la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON con raw: true para obtener valores originales
                    // Esto nos permite detectar n√∫meros seriales de Excel y convertirlos correctamente
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
                    
                    if (jsonData.length === 0) {
                        alert('‚ö†Ô∏è El archivo Excel est√° vac√≠o o no tiene datos v√°lidos');
                        return;
                    }
                    
                    console.log(`üìã ${jsonData.length} filas encontradas en el archivo`);
                    
                    // Obtener reservas existentes
                    const existingReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    const reservationsMap = new Map();
                    
                    // Crear mapa de reservas existentes por c√≥digo
                    existingReservations.forEach(res => {
                        if (res.reservationCode) {
                            reservationsMap.set(res.reservationCode, res);
                        }
                    });
                    
                    let added = 0;
                    let updated = 0;
                    let errors = 0;
                    const errorMessages = [];
                    
                    // Procesar cada fila del Excel
                    jsonData.forEach((row, index) => {
                        try {
                            // Mapear columnas del Excel a campos de reserva
                            const reservationCode = (row['C√≥digo'] || row['Codigo'] || '').toString().trim();
                            const clientName = (row['Cliente'] || '').toString().trim();
                            const clientEmail = (row['Email'] || '').toString().trim();
                            const clientPhone = (row['Tel√©fono'] || row['Telefono'] || '').toString().trim();
                            const hotelName = (row['Hotel'] || '').toString().trim();
                            const checkIn = (row['Fecha Entrada'] || row['FechaEntrada'] || '').toString().trim();
                            const checkOut = (row['Fecha Salida'] || row['FechaSalida'] || '').toString().trim();
                            const reservationDate = (row['Fecha Registro'] || row['FechaRegistro'] || '').toString().trim();
                            const agentName = (row['Agente'] || '').toString().trim();
                            const status = (row['Estado'] || 'Confirmada').toString().trim();
                            const totalAmount = parseFloat(row['Total'] || 0);
                            
                            // Validar campos requeridos (Email y Tel√©fono son opcionales)
                            if (!reservationCode || !clientName || !checkIn || !checkOut) {
                                errors++;
                                errorMessages.push(`Fila ${index + 2}: Faltan campos requeridos (C√≥digo, Cliente, Fechas)`);
                                return;
                            }
                            
                            // Buscar hotel por nombre
                            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                            const hotel = hotels.find(h => h.name === hotelName);
                            const hotelId = hotel ? hotel.id : '';
                            
                            // Normalizar fechas (formato YYYY-MM-DD)
                            const normalizeDate = (dateStr) => {
                                if (!dateStr) return '';
                                
                                // Convertir a string si es necesario
                                const dateValue = dateStr.toString().trim();
                                
                                // Detectar si es un n√∫mero serial de Excel (puede venir como n√∫mero o string)
                                // Los n√∫meros seriales de Excel suelen ser > 1 (desde 1900) y < 1000000 (hasta ~2174)
                                const numericValue = typeof dateStr === 'number' ? dateStr : parseFloat(dateValue);
                                
                                if (!isNaN(numericValue) && numericValue > 1 && numericValue < 1000000) {
                                    // Es probablemente un n√∫mero serial de Excel
                                    // Excel cuenta d√≠as desde el 1 de enero de 1900 como d√≠a 1
                                    // Hay un bug conocido: Excel trata 1900 como a√±o bisiesto (aunque no lo es)
                                    // La f√≥rmula m√°s precisa para convertir n√∫meros seriales de Excel:
                                    // Usamos 1899-12-30 como base y sumamos el n√∫mero serial
                                    // Esto compensa el bug del a√±o bisiesto 1900
                                    const excelEpoch = new Date(1899, 11, 30); // 30 de diciembre de 1899
                                    const date = new Date(excelEpoch.getTime() + numericValue * 24 * 60 * 60 * 1000);
                                    
                                    if (!isNaN(date.getTime())) {
                                        // Verificar que la fecha sea razonable (entre 1900 y 2100)
                                        const year = date.getFullYear();
                                        if (year >= 1900 && year <= 2100) {
                                            const yearStr = String(date.getFullYear());
                                            const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                            const dayStr = String(date.getDate()).padStart(2, '0');
                                            return `${yearStr}-${monthStr}-${dayStr}`;
                                        }
                                    }
                                }
                                
                                // Si es un objeto Date (cuando SheetJS parsea fechas con cellDates: true)
                                if (dateStr instanceof Date) {
                                    const yearStr = String(dateStr.getFullYear());
                                    const monthStr = String(dateStr.getMonth() + 1).padStart(2, '0');
                                    const dayStr = String(dateStr.getDate()).padStart(2, '0');
                                    return `${yearStr}-${monthStr}-${dayStr}`;
                                }
                                
                                // Si ya est√° en formato YYYY-MM-DD, devolverlo tal cual
                                if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                                    return dateValue;
                                }
                                
                                // Intentar parsear diferentes formatos de fecha
                                let date = null;
                                
                                // Formato con barras DD/MM/YYYY o MM/DD/YYYY
                                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('/');
                                    // Si el primer n√∫mero es > 12, es DD/MM/YYYY, sino intentar MM/DD/YYYY
                                    if (parseInt(parts[0]) > 12) {
                                        // DD/MM/YYYY
                                        date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    } else {
                                        // Intentar MM/DD/YYYY primero
                                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                        // Si la fecha no es v√°lida, intentar DD/MM/YYYY
                                        if (isNaN(date.getTime())) {
                                            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                        }
                                    }
                                }
                                // Formato con guiones DD-MM-YYYY
                                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateValue)) {
                                    const parts = dateValue.split('-');
                                    date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                }
                                // Otros formatos (intentar parseo directo)
                                else {
                                    date = new Date(dateValue);
                                }
                                
                                if (date && !isNaN(date.getTime())) {
                                    // Verificar que la fecha sea razonable
                                    const year = date.getFullYear();
                                    if (year >= 1900 && year <= 2100) {
                                        const yearStr = String(year);
                                        const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                                        const dayStr = String(date.getDate()).padStart(2, '0');
                                        return `${yearStr}-${monthStr}-${dayStr}`;
                                    }
                                }
                                
                                // Si no se pudo parsear, devolver string vac√≠o o el valor original
                                console.warn('‚ö†Ô∏è No se pudo normalizar la fecha:', dateStr);
                                return '';
                            };
                            
                            const normalizedCheckIn = normalizeDate(checkIn);
                            const normalizedCheckOut = normalizeDate(checkOut);
                            const normalizedReservationDate = normalizeDate(reservationDate) || new Date().toISOString().split('T')[0];
                            
                            // Verificar si la reserva ya existe
                            const existingReservation = reservationsMap.get(reservationCode);
                            
                            if (existingReservation) {
                                // Actualizar reserva existente
                                existingReservation.clientName = clientName;
                                existingReservation.clientEmail = clientEmail;
                                existingReservation.clientPhone = clientPhone;
                                existingReservation.hotelId = hotelId;
                                existingReservation.hotelName = hotelName;
                                existingReservation.checkIn = normalizedCheckIn;
                                existingReservation.checkOut = normalizedCheckOut;
                                existingReservation.reservationDate = normalizedReservationDate;
                                existingReservation.agentName = agentName;
                                existingReservation.status = status;
                                existingReservation.totalAmount = totalAmount;
                                existingReservation.updatedAt = new Date().toISOString();
                                updated++;
                            } else {
                                // Crear nueva reserva
                                const newReservation = {
                                    id: 'res-' + Date.now() + '-' + index,
                                    reservationCode: reservationCode,
                                    clientName: clientName,
                                    clientEmail: clientEmail,
                                    clientPhone: clientPhone,
                                    hotelId: hotelId,
                                    hotelName: hotelName,
                                    checkIn: normalizedCheckIn,
                                    checkOut: normalizedCheckOut,
                                    reservationDate: normalizedReservationDate,
                                    agentName: agentName,
                                    status: status,
                                    totalAmount: totalAmount,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                existingReservations.push(newReservation);
                                reservationsMap.set(reservationCode, newReservation);
                                added++;
                                
                                // Guardar o actualizar usuario
                                if (typeof saveUserFromReservation === 'function') {
                                    saveUserFromReservation(newReservation);
                                }
                            }
                        } catch (error) {
                            errors++;
                            errorMessages.push(`Fila ${index + 2}: ${error.message}`);
                            console.error(`Error procesando fila ${index + 2}:`, error);
                        }
                    });
                    
                    // Guardar en localStorage como backup
                    localStorage.setItem('reservationsDB', JSON.stringify(existingReservations));
                    
                    // Subir SOLO las reservas nuevas/actualizadas a Supabase (no todas)
                    let syncSuccess = false;
                    const totalToSync = added + updated;
                    
                    if (window.supabaseClient && window.supabaseClient.isInitialized() && totalToSync > 0) {
                        console.log(`‚òÅÔ∏è Subiendo ${totalToSync} reservas importadas a Supabase...`);
                        
                        let syncErrors = 0;
                        let syncCount = 0;
                        
                        // Preparar SOLO las reservas que se procesaron en esta importaci√≥n
                        const reservationsToSync = [];
                        jsonData.forEach((row, index) => {
                            const reservationCode = (row['C√≥digo'] || row['Codigo'] || '').toString().trim();
                            const clientName = (row['Cliente'] || '').toString().trim();
                            const checkIn = (row['Fecha Entrada'] || row['FechaEntrada'] || '').toString().trim();
                            const checkOut = (row['Fecha Salida'] || row['FechaSalida'] || '').toString().trim();
                            
                            // Solo incluir si tiene datos v√°lidos
                            if (reservationCode && clientName && checkIn && checkOut) {
                                const reservation = reservationsMap.get(reservationCode);
                                if (reservation) {
                                    reservationsToSync.push(reservation);
                                }
                            }
                        });
                        
                        console.log(`üìã ${reservationsToSync.length} reservas v√°lidas para sincronizar`);
                        
                        // Subir en lotes de 10 para mayor velocidad
                        const batchSize = 10;
                        for (let i = 0; i < reservationsToSync.length; i += batchSize) {
                            const batch = reservationsToSync.slice(i, i + batchSize);
                            
                            // Procesar el lote en paralelo
                            const promises = batch.map(async (reservation) => {
                                try {
                                    // Validar que tenga datos requeridos
                                    if (!reservation.reservationCode || !reservation.clientName) {
                                        console.warn('‚ö†Ô∏è Reserva sin datos requeridos, saltando:', reservation);
                                        return { success: false, skipped: true };
                                    }
                                    
                                    // Convertir a formato snake_case para Supabase
                                    const supabaseReservation = {
                                        reservation_code: reservation.reservationCode,
                                        client_name: reservation.clientName,
                                        client_email: reservation.clientEmail || '',
                                        client_phone: reservation.clientPhone || '',
                                        hotel_id: reservation.hotelId || null,
                                        hotel_name: reservation.hotelName || '',
                                        check_in: reservation.checkIn,
                                        check_out: reservation.checkOut,
                                        reservation_date: reservation.reservationDate || reservation.checkIn,
                                        agent_name: reservation.agentName || '',
                                        status: reservation.status || 'Confirmada',
                                        total_amount: parseFloat(reservation.totalAmount) || 0
                                    };
                                    
                                    await window.supabaseClient.createReservation(supabaseReservation);
                                    return { success: true };
                                } catch (error) {
                                    console.error('Error sincronizando reserva:', reservation.reservationCode, error.message);
                                    return { success: false, error: error.message };
                                }
                            });
                            
                            const results = await Promise.all(promises);
                            const successCount = results.filter(r => r.success).length;
                            syncCount += successCount;
                            syncErrors += results.filter(r => !r.success && !r.skipped).length;
                            
                            // Log progreso
                            console.log(`üì§ Progreso: ${Math.min(i + batchSize, reservationsToSync.length)}/${reservationsToSync.length} procesadas (${syncCount} OK)`);
                        }
                        
                        if (syncErrors > 0) {
                            console.warn(`‚ö†Ô∏è ${syncErrors} reservas no se pudieron sincronizar con Supabase`);
                        } else {
                            console.log(`‚úÖ ${syncCount} reservas sincronizadas con Supabase exitosamente`);
                            syncSuccess = true;
                        }
                    } else if (totalToSync === 0) {
                        console.log('‚ÑπÔ∏è No hay reservas nuevas para sincronizar');
                    }
                    
                    // Mostrar resumen
                    let message = `‚úÖ Importaci√≥n completada:\n`;
                    message += `‚Ä¢ ${added} reservas agregadas\n`;
                    message += `‚Ä¢ ${updated} reservas actualizadas\n`;
                    if (syncSuccess) {
                        message += `‚Ä¢ ‚òÅÔ∏è Sincronizadas con la nube\n`;
                    }
                    if (errors > 0) {
                        message += `‚Ä¢ ${errors} errores encontrados\n\n`;
                        message += `Errores:\n${errorMessages.slice(0, 5).join('\n')}`;
                        if (errorMessages.length > 5) {
                            message += `\n... y ${errorMessages.length - 5} m√°s`;
                        }
                    }
                    
                    alert(message);
                    
                    // Cerrar modal
                    closeImportReservationsModal();
                    
                    // Esperar un momento antes de recargar para que Supabase procese
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Actualizar tabla y estad√≠sticas
                    if (typeof loadReservationsTable === 'function') {
                        loadReservationsTable();
                    }
                    if (typeof updateReservationsStats === 'function') {
                        updateReservationsStats();
                    }
                    
                    console.log(`‚úÖ Importaci√≥n completada: ${added} agregadas, ${updated} actualizadas, ${errors} errores`);
                    
                } catch (error) {
                    console.error('‚ùå Error al procesar archivo:', error);
                    alert('‚ùå Error al procesar el archivo Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Funci√≥n para refrescar reservas
        function refreshReservations() {
            console.log('üîÑ Refrescando reservas...');
            loadReservationsTable();
            updateReservationsStats();
        }

        // Funci√≥n para eliminar todas las reservas
        function deleteAllReservations() {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            console.log('üóëÔ∏è Eliminando todas las reservas...');
            
            // Obtener cantidad de reservas
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const count = reservations.length;
            
            if (count === 0) {
                alert('‚ÑπÔ∏è No hay reservas para eliminar');
                return;
            }
            
            // Primera confirmaci√≥n
            const confirmMessage = `‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODAS las reservas?\n\n` +
                                 `Se eliminar√°n ${count} reserva(s).\n\n` +
                                 `Esta acci√≥n NO se puede deshacer.\n\n` +
                                 `Escribe "ELIMINAR" para confirmar:`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === null) {
                // Usuario cancel√≥
                console.log('‚ùå Eliminaci√≥n cancelada por el usuario');
                return;
            }
            
            if (userInput.trim().toUpperCase() !== 'ELIMINAR') {
                alert('‚ùå Confirmaci√≥n incorrecta. La eliminaci√≥n fue cancelada.');
                console.log('‚ùå Confirmaci√≥n incorrecta');
                return;
            }
            
            // Segunda confirmaci√≥n
            if (!confirm(`‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente quieres eliminar las ${count} reserva(s)?\n\nEsta acci√≥n es IRREVERSIBLE.`)) {
                console.log('‚ùå Eliminaci√≥n cancelada en segunda confirmaci√≥n');
                return;
            }
            
            try {
                // Eliminar todas las reservas
                localStorage.setItem('reservationsDB', JSON.stringify([]));
                
                console.log(`‚úÖ ${count} reserva(s) eliminada(s) correctamente`);
                alert(`‚úÖ ${count} reserva(s) eliminada(s) correctamente`);
                
                // Actualizar tabla y estad√≠sticas
                if (typeof loadReservationsTable === 'function') {
                    loadReservationsTable();
                }
                if (typeof updateReservationsStats === 'function') {
                    updateReservationsStats();
                }
                
                // Actualizar ventas mensuales si el dashboard est√° visible
                if (currentSection === 'dashboard' && typeof loadMonthlySales === 'function') {
                    loadMonthlySales();
                }
                
                // Actualizar gastos mensuales si el dashboard est√° visible
                if (currentSection === 'dashboard' && typeof loadMonthlyExpenses === 'function') {
                    loadMonthlyExpenses();
                }
                
            } catch (error) {
                console.error('‚ùå Error al eliminar reservas:', error);
                alert('‚ùå Error al eliminar reservas: ' + error.message);
            }
        }

        // Funci√≥n auxiliar para formatear fechas
        // Evita problemas de zona horaria parseando manualmente fechas YYYY-MM-DD
        function formatDate(dateString) {
            if (!dateString) return 'Sin fecha';
            
            // Si la fecha est√° en formato YYYY-MM-DD, parsearla manualmente para evitar problemas de zona horaria
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                const [year, month, day] = dateString.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                return date.toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // Para otros formatos, usar el m√©todo est√°ndar
            try {
            const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Fecha inv√°lida';
            return date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            } catch (e) {
                console.error('Error formateando fecha:', dateString, e);
                return 'Fecha inv√°lida';
            }
        }

        // Funci√≥n para generar c√≥digo de reserva autom√°tico
        function generateReservationCode() {
            const year = new Date().getFullYear();
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const nextNumber = reservations.length + 1;
            return `RES-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Funci√≥n para cargar hoteles en el select de edici√≥n
        function loadHotelsForEdit(selectedHotelId = '') {
            const hotelSelect = document.getElementById('editHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles del localStorage
            const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                option.selected = hotel.id === selectedHotelId;
                hotelSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${hotels.length} hoteles cargados en el select de edici√≥n`);
        }

        // Funci√≥n para cargar agentes en el select de edici√≥n
        async function loadAgentsForEdit(selectedAgentName = '') {
            const agentSelect = document.getElementById('editAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes de Supabase primero, luego localStorage
            let agents = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    agents = await window.supabaseClient.getAgents();
                } catch (error) {
                    console.error('Error cargando agentes de Supabase:', error);
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
            } else {
                agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            }
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.status !== 'Inactivo' && agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('‚ö†Ô∏è No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                // Soportar ambas estructuras de tabla (code/agency o role)
                const agentCode = agent.code || '';
                const agentAgency = agent.agency || agent.role || '';
                option.textContent = agentCode ? `${agentCode} - ${agent.name} (${agentAgency})` : `${agent.name} (${agentAgency})`;
                option.selected = agent.name === selectedAgentName;
                agentSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${activeAgents.length} agentes cargados en el select de edici√≥n`);
        }

        // Funci√≥n para cerrar modal de edici√≥n de reservas
        window.closeEditReservationModal = function() {
            const modal = document.getElementById('editReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Funci√≥n para cancelar una reserva
        async function cancelReservation() {
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('‚ùå ID de reserva no encontrado');
                alert('‚ùå Error: ID de reserva no encontrado');
                return;
            }
            
            // Confirmar cancelaci√≥n
            if (!confirm('¬øEst√°s seguro de que quieres cancelar esta reserva?')) {
                return;
            }
            
            console.log('üö´ Cancelando reserva:', reservationId);
            
            // Datos a actualizar
            const updates = {
                status: 'Cancelada',
                updated_at: new Date().toISOString()
            };
            
            try {
                // Intentar actualizar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateReservation(reservationId, updates);
                    console.log('‚úÖ Reserva cancelada en Supabase');
                    alert('‚úÖ Reserva cancelada correctamente');
                    
                    // Cerrar modal y recargar tabla
                    closeEditReservationModal();
                    loadReservationsTable();
                    updateReservationsStats();
                    return;
                }
            } catch (error) {
                console.error('‚ùå Error cancelando en Supabase:', error);
            }
            
            // Fallback a localStorage
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId || r.id == reservationId);
            
            if (reservationIndex !== -1) {
                // Cambiar el estado a "Cancelada"
                reservations[reservationIndex].status = 'Cancelada';
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar √∫ltima actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('‚úÖ Reserva cancelada correctamente');
                alert('‚úÖ Reserva cancelada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estad√≠sticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('‚ùå Reserva no encontrada para cancelar');
                alert('‚ùå Error: Reserva no encontrada');
            }
        }

        // Funci√≥n para guardar cambios de la reserva
        async function saveReservationChanges(event) {
            event.preventDefault();
            
            console.log('üíæ Guardando cambios de la reserva...');
            
            const form = document.getElementById('editReservationForm');
            const reservationId = form.dataset.reservationId;
            
            if (!reservationId) {
                console.error('‚ùå ID de reserva no encontrado');
                alert('‚ùå Error: ID de reserva no encontrado');
                return;
            }
            
            // Obtener datos del formulario - Solo tarifa y fechas son editables
            const formData = new FormData(form);
            let checkIn = formData.get('checkIn');
            let checkOut = formData.get('checkOut');
            const totalAmount = parseInt(formData.get('totalAmount'));
            
            // Validar campos requeridos
            if (!checkIn || !checkOut || !totalAmount || totalAmount <= 0) {
                alert('‚ùå Por favor completa todos los campos requeridos (fechas y tarifa)');
                return;
            }
            
            // Asegurar que las fechas est√©n en formato YYYY-MM-DD
            if (!/^\d{4}-\d{2}-\d{2}$/.test(checkIn) || !/^\d{4}-\d{2}-\d{2}$/.test(checkOut)) {
                console.error('Formato de fecha inv√°lido:', { checkIn, checkOut });
                alert('‚ùå Error: Formato de fecha inv√°lido. Por favor, selecciona las fechas nuevamente.');
                return;
            }
            
            // Validar fechas
            if (checkOut <= checkIn) {
                alert('‚ùå La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            // Datos a actualizar (usando snake_case para Supabase)
            const updates = {
                check_in: checkIn,
                check_out: checkOut,
                total_amount: totalAmount,
                status: 'Modificada',
                updated_at: new Date().toISOString()
            };
            
            console.log('üì¶ Actualizando reserva:', reservationId, updates);
            
            try {
                // Intentar actualizar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateReservation(reservationId, updates);
                    console.log('‚úÖ Reserva actualizada en Supabase');
                    alert('‚úÖ Reserva actualizada correctamente');
                    
                    // Cerrar modal y recargar tabla
                    closeEditReservationModal();
                    loadReservationsTable();
                    updateReservationsStats();
                    return;
                }
            } catch (error) {
                console.error('‚ùå Error actualizando en Supabase:', error);
            }
            
            // Fallback a localStorage
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            const reservationIndex = reservations.findIndex(r => r.id === reservationId || r.id == reservationId);
            
            if (reservationIndex !== -1) {
                // Obtener la reserva actual para mantener datos no editables
                const currentReservation = reservations[reservationIndex];
                
                // Obtener reservationDate del formulario si existe
                const reservationDate = formData.get('reservationDate');
                
                // Actualizar solo tarifa y fechas (campos editables)
                // Asegurar que las fechas se guarden en formato correcto (YYYY-MM-DD)
                reservations[reservationIndex].checkIn = checkIn;
                reservations[reservationIndex].checkOut = checkOut;
                reservations[reservationIndex].totalAmount = totalAmount;
                if (reservationDate) {
                    reservations[reservationIndex].reservationDate = reservationDate;
                }
                reservations[reservationIndex].updatedAt = new Date().toISOString();
                
                // Cambiar el estado a "Modificada" cuando se modifica una reserva
                // Si estaba cancelada, cambiar a "Modificada" (celeste)
                // Si estaba confirmada, cambiar a "Modificada" (celeste)
                if (currentReservation.status === 'Cancelada' || currentReservation.status === 'Confirmada' || currentReservation.status === 'Modificada') {
                    reservations[reservationIndex].status = 'Modificada';
                }
                
                localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                
                // Actualizar √∫ltima actividad del usuario
                const reservation = reservations[reservationIndex];
                if (reservation.clientEmail) {
                    updateUserActivity(reservation.clientEmail);
                }
                
                console.log('‚úÖ Reserva modificada correctamente');
                console.log('üìÖ Fechas actualizadas:', { checkIn, checkOut });
                alert('‚úÖ Reserva modificada correctamente');
                
                // Cerrar modal
                closeEditReservationModal();
                
                // Actualizar tabla y estad√≠sticas
                loadReservationsTable();
                updateReservationsStats();
            } else {
                console.error('‚ùå Reserva no encontrada para actualizar');
                alert('‚ùå Error: Reserva no encontrada');
            }
        }

        // Funci√≥n auxiliar para obtener nombre del hotel por ID
        async function getHotelNameById(hotelId) {
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    hotels = await window.supabaseClient.getHotels();
                } catch (error) {
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            const hotel = hotels.find(h => h.id === hotelId);
            return hotel ? hotel.name : 'Hotel no encontrado';
        }

        // Funci√≥n para cargar hoteles en el select de nueva reserva
        async function loadHotelsForNewReservation() {
            const hotelSelect = document.getElementById('newHotelSelect');
            if (!hotelSelect) return;
            
            // Limpiar opciones existentes
            hotelSelect.innerHTML = '<option value="">Seleccionar hotel...</option>';
            
            // Obtener hoteles de Supabase (tienen UUIDs v√°lidos)
            let hotels = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    hotels = await window.supabaseClient.getHotels();
                } catch (error) {
                    console.error('Error cargando hoteles de Supabase:', error);
                    hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                }
            } else {
                hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
            }
            
            hotels.forEach(hotel => {
                const option = document.createElement('option');
                option.value = hotel.id;
                option.textContent = hotel.name;
                hotelSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${hotels.length} hoteles cargados en el select de nueva reserva`);
        }

        // Funci√≥n para cargar agentes en el select de nueva reserva
        async function loadAgentsForNewReservation() {
            const agentSelect = document.getElementById('newAgentSelect');
            if (!agentSelect) return;
            
            // Limpiar opciones existentes
            agentSelect.innerHTML = '<option value="">Seleccionar agente...</option>';
            
            // Obtener agentes de Supabase
            let agents = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    agents = await window.supabaseClient.getAgents();
                } catch (error) {
                    console.error('Error cargando agentes de Supabase:', error);
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
            } else {
                agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            }
            
            // Filtrar solo agentes activos
            const activeAgents = agents.filter(agent => agent.status !== 'Inactivo' && agent.active !== false);
            
            if (activeAgents.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay agentes disponibles';
                option.disabled = true;
                agentSelect.appendChild(option);
                console.log('‚ö†Ô∏è No hay agentes disponibles');
                return;
            }
            
            activeAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name; // Usar el nombre como valor
                // Soportar ambas estructuras de tabla (code/agency o role)
                const agentCode = agent.code || '';
                const agentAgency = agent.agency || agent.role || '';
                option.textContent = agentCode ? `${agentCode} - ${agent.name} (${agentAgency})` : `${agent.name} (${agentAgency})`;
                agentSelect.appendChild(option);
            });
            
            console.log(`‚úÖ ${activeAgents.length} agentes cargados en el select de nueva reserva`);
        }

        // Funci√≥n para cerrar modal de nueva reserva
        window.closeNewReservationModal = function() {
            const modal = document.getElementById('newReservationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Funci√≥n para generar c√≥digo de agente autom√°tico
        function generateAgentCode() {
            const year = new Date().getFullYear();
            const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
            const nextNumber = agents.length + 1;
            return `AGT-${year}-${nextNumber.toString().padStart(3, '0')}`;
        }

        // Funci√≥n para abrir modal de nuevo agente
        function addNewAgent() {
            console.log('üë§ Abriendo formulario para nuevo agente...');
            
            // Limpiar el formulario
            const form = document.getElementById('newAgentForm');
            if (form) {
                form.reset();
            }
            
            // Generar c√≥digo de agente autom√°tico
            const agentCodeInput = document.getElementById('newAgentCode');
            if (agentCodeInput) {
                agentCodeInput.value = generateAgentCode();
            }
            
            // Mostrar el modal
            document.getElementById('newAgentModal').style.display = 'block';
            
            console.log('‚úÖ Modal de nuevo agente abierto');
        }

        // Funci√≥n para cerrar modal de nuevo agente
        window.closeNewAgentModal = function() {
            const modal = document.getElementById('newAgentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Funci√≥n para guardar nuevo agente
        async function saveNewAgent(event) {
            event.preventDefault();
            
            console.log('üíæ Guardando nuevo agente...');
            
            const form = document.getElementById('newAgentForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const agentData = {
                code: formData.get('agentCode'),
                name: formData.get('agentName'),
                agency: formData.get('agentAgency'),
                status: 'Activo',
                commission_rate: 0
            };
            
            // Validar campos requeridos
            if (!agentData.code || !agentData.name || !agentData.agency) {
                alert('‚ùå Por favor completa todos los campos requeridos');
                return;
            }
            
            try {
                let newAgent;
                
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Guardando agente en Supabase...');
                    newAgent = await window.supabaseClient.createAgent(agentData);
                    console.log('‚úÖ Agente guardado en Supabase:', newAgent);
                } else {
                    // Fallback a localStorage
                    console.log('üíæ Guardando agente en localStorage...');
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    
                    // Verificar si el c√≥digo ya existe
                    const existingAgent = agents.find(a => a.code === agentData.code);
                    if (existingAgent) {
                        alert('‚ùå Ya existe un agente con este c√≥digo. Se generar√° un nuevo c√≥digo.');
                        agentData.code = generateAgentCode();
                        document.getElementById('newAgentCode').value = agentData.code;
                    }
                    
                    newAgent = {
                        id: 'agent-' + Date.now(),
                        ...agentData,
                        active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    agents.push(newAgent);
                    localStorage.setItem('agentsDB', JSON.stringify(agents));
                }
                
                console.log('‚úÖ Nuevo agente guardado:', newAgent);
                
                // Cerrar modal
                closeNewAgentModal();
                
                // Mostrar mensaje de √©xito
                alert('‚úÖ Agente creado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error guardando agente:', error);
                alert('‚ùå Error al guardar el agente: ' + error.message);
            }
            
            // Recargar agentes en el select de reservas si est√° abierto
            const agentSelect = document.getElementById('newAgentSelect');
            if (agentSelect) {
                loadAgentsForNewReservation();
            }
            
            // Recargar tabla de agentes si est√° visible
            if (document.getElementById('agents-section')?.style.display !== 'none') {
                loadAgentsTable();
            }
        }

        // ============================================
        // GESTI√ìN DE AGENTES
        // ============================================

        // Funci√≥n para cargar tabla de agentes
        async function loadAgentsTable() {
            console.log('üìã Cargando tabla de agentes...');
            
            const tbody = document.getElementById('agentsTableBody');
            if (!tbody) {
                console.log('‚ö†Ô∏è Tabla de agentes no encontrada');
                return;
            }
            
            // Mostrar loading
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span> Cargando agentes...</td></tr>';
            
            try {
                // Obtener agentes de Supabase
                let agents = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Cargando agentes desde Supabase...');
                    agents = await window.supabaseClient.getAgents();
                    console.log(`‚úÖ ${agents.length} agentes cargados de Supabase`);
                } else {
                    console.log('üíæ Cargando agentes desde localStorage...');
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
                
                // Actualizar estad√≠sticas
                updateAgentsStats(agents);
                
                if (agents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No hay agentes registrados. Haz clic en "Nuevo Agente" para crear uno.</td></tr>';
                    return;
                }
                
                // Obtener reservas para contar por agente
                let reservations = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        reservations = await window.supabaseClient.getReservations();
                    } catch (e) {
                        reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    }
                } else {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
                const sortedAgents = agents.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA;
                });
                
                tbody.innerHTML = sortedAgents.map(agent => {
                    const createdDate = agent.created_at ? new Date(agent.created_at).toLocaleDateString('es-ES') : 'N/A';
                    const isActive = agent.status !== 'Inactivo' && agent.active !== false;
                    
                    // Contar reservas del agente
                    const agentReservations = reservations.filter(r => 
                        r.agent_name === agent.name || 
                        r.agentName === agent.name || 
                        r.agent === agent.name
                    ).length;
                    
                    // Soportar ambas estructuras de tabla
                    const agentCode = agent.code || 'N/A';
                    const agentAgency = agent.agency || agent.role || 'Sin agencia';
                    
                    return `
                        <tr>
                            <td style="padding: 12px;"><strong>${agentCode}</strong></td>
                            <td style="padding: 12px;">${agent.name || 'Sin nombre'}</td>
                            <td style="padding: 12px;">${agentAgency}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="
                                    display: inline-block;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    background: ${isActive ? '#e8f5e9' : '#ffebee'};
                                    color: ${isActive ? '#2e7d32' : '#c62828'};
                                ">${isActive ? 'Activo' : 'Inactivo'}</span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="
                                    display: inline-block;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 12px;
                                    background: #e3f2fd;
                                    color: #1565c0;
                                ">${agentReservations}</span>
                            </td>
                            <td style="padding: 12px;">${createdDate}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="editAgent('${agent.id}')" style="
                                    background: #2196f3;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    margin-right: 4px;
                                " title="Editar agente">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                                </button>
                                <button onclick="deleteAgent('${agent.id}', '${agent.name}')" style="
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                " title="Eliminar agente">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                console.log(`‚úÖ ${agents.length} agentes mostrados en la tabla`);
                
            } catch (error) {
                console.error('‚ùå Error cargando agentes:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">Error al cargar agentes. Intenta actualizar la p√°gina.</td></tr>';
            }
        }

        // Funci√≥n para actualizar estad√≠sticas de agentes
        function updateAgentsStats(agents) {
            const totalAgents = agents.length;
            const activeAgents = agents.filter(a => a.status !== 'Inactivo' && a.active !== false).length;
            const inactiveAgents = totalAgents - activeAgents;
            
            const totalEl = document.getElementById('totalAgents');
            const activeEl = document.getElementById('activeAgents');
            const inactiveEl = document.getElementById('inactiveAgents');
            
            if (totalEl) totalEl.textContent = totalAgents;
            if (activeEl) activeEl.textContent = activeAgents;
            if (inactiveEl) inactiveEl.textContent = inactiveAgents;
        }

        // Funci√≥n para editar agente
        async function editAgent(agentId) {
            console.log('‚úèÔ∏è Editando agente:', agentId);
            
            try {
                // Obtener agentes
                let agents = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    agents = await window.supabaseClient.getAgents();
                } else {
                    agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                }
                
                const agent = agents.find(a => a.id === agentId || a.id == agentId);
                
                if (!agent) {
                    console.error('‚ùå Agente no encontrado:', agentId);
                    alert('‚ùå Agente no encontrado');
                    return;
                }
                
                // Rellenar formulario de edici√≥n (soportar ambas estructuras)
                document.getElementById('editAgentId').value = agent.id;
                document.getElementById('editAgentCode').value = agent.code || '';
                document.getElementById('editAgentName').value = agent.name || '';
                document.getElementById('editAgentAgency').value = agent.agency || agent.role || '';
                document.getElementById('editAgentStatus').value = (agent.status === 'Inactivo' || agent.active === false) ? 'Inactivo' : 'Activo';
                
                // Mostrar modal
                document.getElementById('editAgentModal').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Error al cargar agente para edici√≥n:', error);
                alert('‚ùå Error al cargar los datos del agente');
            }
        }

        // Funci√≥n para cerrar modal de edici√≥n de agente
        function closeEditAgentModal() {
            const modal = document.getElementById('editAgentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para guardar agente editado
        async function saveEditedAgent(event) {
            event.preventDefault();
            
            const agentId = document.getElementById('editAgentId').value;
            const updates = {
                name: document.getElementById('editAgentName').value,
                agency: document.getElementById('editAgentAgency').value,
                status: document.getElementById('editAgentStatus').value,
                active: document.getElementById('editAgentStatus').value === 'Activo'
            };
            
            console.log('üíæ Guardando cambios del agente:', agentId, updates);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.updateAgent(agentId, updates);
                    console.log('‚úÖ Agente actualizado en Supabase');
                } else {
                    // Fallback a localStorage
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    const index = agents.findIndex(a => a.id === agentId || a.id == agentId);
                    if (index !== -1) {
                        agents[index] = { ...agents[index], ...updates, updated_at: new Date().toISOString() };
                        localStorage.setItem('agentsDB', JSON.stringify(agents));
                    }
                }
                
                // Cerrar modal
                closeEditAgentModal();
                
                // Mostrar mensaje de √©xito
                alert('‚úÖ Agente actualizado correctamente');
                
                // Recargar tabla
                loadAgentsTable();
                
                // Tambi√©n actualizar el select de agentes si est√° abierto
                if (document.getElementById('newAgentSelect')) {
                    loadAgentsForNewReservation();
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando agente:', error);
                alert('‚ùå Error al actualizar el agente: ' + error.message);
            }
        }

        // Funci√≥n para eliminar agente
        async function deleteAgent(agentId, agentName) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar al agente "${agentName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            console.log('üóëÔ∏è Eliminando agente:', agentId);
            
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    await window.supabaseClient.deleteAgent(agentId);
                    console.log('‚úÖ Agente eliminado de Supabase');
                } else {
                    // Fallback a localStorage
                    const agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    const filtered = agents.filter(a => a.id !== agentId && a.id != agentId);
                    localStorage.setItem('agentsDB', JSON.stringify(filtered));
                }
                
                // Mostrar mensaje de √©xito
                alert('‚úÖ Agente eliminado correctamente');
                
                // Recargar tabla
                loadAgentsTable();
                
                // Tambi√©n actualizar el select de agentes si est√° abierto
                if (document.getElementById('newAgentSelect')) {
                    loadAgentsForNewReservation();
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando agente:', error);
                alert('‚ùå Error al eliminar el agente: ' + error.message);
            }
        }

        // Funci√≥n para refrescar agentes
        async function refreshAgents() {
            console.log('üîÑ Actualizando lista de agentes...');
            await loadAgentsTable();
            alert('‚úÖ Lista de agentes actualizada');
        }

        // Funci√≥n para guardar nueva reserva
        async function saveNewReservation(event) {
            event.preventDefault();
            
            console.log('üíæ Guardando nueva reserva...');
            
            const form = document.getElementById('newReservationForm');
            
            // Obtener datos del formulario
            const formData = new FormData(form);
            const reservationCode = formData.get('reservationCode') || generateReservationCode();
            const hotelId = formData.get('hotelId');
            const hotelName = await getHotelNameById(hotelId);
            
            // Datos para Supabase (snake_case)
            const reservationData = {
                reservation_code: reservationCode,
                client_name: formData.get('clientName'),
                client_email: formData.get('clientEmail'),
                client_phone: formData.get('clientPhone'),
                hotel_id: hotelId,
                hotel_name: hotelName,
                check_in: formData.get('checkIn'),
                check_out: formData.get('checkOut'),
                reservation_date: formData.get('reservationDate') || new Date().toISOString().split('T')[0],
                agent_name: formData.get('agentName') || '',
                status: 'Confirmada',
                total_amount: parseInt(formData.get('totalAmount')) || 0
            };
            
            // Validar campos requeridos
            if (!reservationData.client_name || !reservationData.client_email || !reservationData.client_phone || !reservationData.hotel_id || 
                !reservationData.check_in || !reservationData.check_out) {
                alert('‚ùå Por favor completa todos los campos requeridos');
                return;
            }
            
            // Validar fechas
            if (reservationData.check_out <= reservationData.check_in) {
                alert('‚ùå La fecha de salida debe ser posterior a la fecha de entrada');
                return;
            }
            
            try {
                let newReservation;
                
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Guardando reserva en Supabase...');
                    newReservation = await window.supabaseClient.createReservation(reservationData);
                    console.log('‚úÖ Reserva guardada en Supabase:', newReservation);
                } else {
                    // Fallback a localStorage (con formato camelCase para compatibilidad)
                    console.log('üíæ Guardando reserva en localStorage...');
                    newReservation = {
                        id: 'res-' + Date.now(),
                        reservationCode: reservationCode,
                        clientName: reservationData.client_name,
                        clientEmail: reservationData.client_email,
                        clientPhone: reservationData.client_phone,
                        hotelId: reservationData.hotel_id,
                        hotelName: reservationData.hotel_name,
                        checkIn: reservationData.check_in,
                        checkOut: reservationData.check_out,
                        reservationDate: reservationData.reservation_date,
                        agentName: reservationData.agent_name,
                        status: reservationData.status,
                        totalAmount: reservationData.total_amount,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    reservations.push(newReservation);
                    localStorage.setItem('reservationsDB', JSON.stringify(reservations));
                }
                
                // Guardar o actualizar usuario en Gesti√≥n de Usuarios
                saveUserFromReservation({
                    clientName: reservationData.client_name,
                    clientEmail: reservationData.client_email,
                    clientPhone: reservationData.client_phone
                });
                
                console.log('‚úÖ Nueva reserva creada:', newReservation);
                alert(`‚úÖ Reserva ${reservationCode} creada correctamente`);
                
                // Cerrar modal
                closeNewReservationModal();
                
                // Actualizar tabla y estad√≠sticas
                loadReservationsTable();
                updateReservationsStats();
                
            } catch (error) {
                console.error('‚ùå Error guardando reserva:', error);
                alert('‚ùå Error al guardar la reserva: ' + error.message);
            }
        }

        // Funci√≥n para guardar usuario desde una reserva (con deduplicaci√≥n por email Y tel√©fono)
        async function saveUserFromReservation(reservationData) {
            try {
                const email = (reservationData.clientEmail || reservationData.client_email || '').trim();
                const phone = (reservationData.clientPhone || reservationData.client_phone || '').trim();
                const name = (reservationData.clientName || reservationData.client_name || '').trim();
                
                // Si no hay email ni tel√©fono, no guardar
                if (!email && !phone) {
                    console.log('‚ö†Ô∏è Usuario sin email ni tel√©fono, no se guarda');
                    return null;
                }
                
                console.log('üíæ Guardando usuario desde reserva:', { name, email, phone });
                
                // Usar Supabase si est√° disponible
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    const result = await window.supabaseClient.upsertUser({ name, email, phone });
                    return result;
                }
                
                // Fallback a localStorage con deduplicaci√≥n mejorada
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`üë• Usuarios existentes: ${users.length}`);
                
                // Buscar usuario existente por email O tel√©fono
                const existingIndex = users.findIndex(user => {
                    const emailMatch = email && user.email && user.email.toLowerCase() === email.toLowerCase();
                    const phoneMatch = phone && user.phone && user.phone === phone;
                    return emailMatch || phoneMatch;
                });
            
                if (existingIndex !== -1) {
                    // Actualizar usuario existente - agregar campos faltantes
                    const existingUser = users[existingIndex];
                    let updated = false;
                    
                    if (!existingUser.email && email) {
                        existingUser.email = email;
                        updated = true;
                    }
                    if (!existingUser.phone && phone) {
                        existingUser.phone = phone;
                        updated = true;
                    }
                    if (!existingUser.name && name) {
                        existingUser.name = name;
                        updated = true;
                    }
                    
                    existingUser.last_activity = new Date().toISOString();
                    existingUser.updatedAt = new Date().toISOString();
                    users[existingIndex] = existingUser;
                    
                    if (updated) {
                        console.log('üîÑ Usuario actualizado con campos faltantes:', existingUser.email || existingUser.phone);
            } else {
                        console.log('‚ÑπÔ∏è Usuario ya existe, sin cambios:', existingUser.email || existingUser.phone);
                    }
                    
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    return existingUser;
                } else {
                    // Crear nuevo usuario
                    const maxId = users.reduce((max, u) => Math.max(max, parseInt(u.id) || 0), 0);
                    const newUser = {
                        id: maxId + 1,
                        name: name,
                        email: email || null,
                        phone: phone || null,
                        status: 'active',
                        is_active: true,
                        createdAt: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        last_activity: new Date().toISOString(),
                        rewards_points: 0,
                        tipoCuenta: 'cliente_reserva',
                        avatar_url: null
                    };
                    
                    users.push(newUser);
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log('‚úÖ Nuevo usuario creado:', newUser.email || newUser.phone);
                    return newUser;
            }
                
            } catch (error) {
                console.error('‚ùå Error al guardar usuario desde reserva:', error);
                return null;
            }
        }
        
        // Funci√≥n para actualizar la √∫ltima actividad de un usuario
        function updateUserActivity(userEmail) {
            try {
                const users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const userIndex = users.findIndex(user => 
                    user.email && user.email.toLowerCase() === userEmail.toLowerCase()
                );
                
                if (userIndex !== -1) {
                    users[userIndex].last_activity = new Date().toISOString();
                    users[userIndex].updatedAt = new Date().toISOString();
                    localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                    console.log('üîÑ √öltima actividad actualizada para:', userEmail);
                }
            } catch (error) {
                console.error('‚ùå Error al actualizar actividad del usuario:', error);
            }
        }
        
        // Funci√≥n para actualizar usuarios desde reservas existentes
        async function updateUsersFromReservations() {
            try {
                console.log('üîÑ Actualizando usuarios desde reservas...');
                
                // Obtener todas las reservas - primero de Supabase, luego de localStorage
                let reservations = [];
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const supabaseReservations = await window.supabaseClient.getReservations();
                        if (supabaseReservations && supabaseReservations.length > 0) {
                            console.log(`‚òÅÔ∏è ${supabaseReservations.length} reservas cargadas de Supabase`);
                            reservations = supabaseReservations;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error cargando de Supabase:', e);
                    }
                }
                
                // Si no hay de Supabase, usar localStorage
                if (reservations.length === 0) {
                    reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                }
                
                console.log(`üìã Encontradas ${reservations.length} reservas`);
            
                if (reservations.length === 0) {
                    alert('‚ÑπÔ∏è No hay reservas para procesar');
                return;
            }
            
                // Obtener usuarios existentes
                let users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                console.log(`üë• Usuarios existentes: ${users.length}`);
                
                // Crear set de identificadores existentes (emails y nombres)
                const existingEmails = new Set();
                users.forEach(user => {
                    if (user.email) existingEmails.add(user.email.toLowerCase());
                    if (user.name) existingEmails.add(user.name.toLowerCase().trim());
                });
                
                let newUsersCount = 0;
                let updatedUsersCount = 0;
                const processedEmails = new Set(); // Para evitar procesar el mismo email m√∫ltiples veces
                
                // Procesar cada reserva
                console.log('üìã Procesando reservas...');
                reservations.forEach((reservation, index) => {
                    // Normalizar campos (Supabase usa snake_case, localStorage usa camelCase)
                    const clientEmail = reservation.clientEmail || reservation.client_email || reservation.customer_email || '';
                    const clientName = reservation.clientName || reservation.client_name || reservation.customer_name || '';
                    const clientPhone = reservation.clientPhone || reservation.client_phone || reservation.customer_phone || '';
                    const reservationCode = reservation.reservationCode || reservation.reservation_code || reservation.code || '';
                    
                    console.log(`üìù Procesando reserva ${index + 1}/${reservations.length}:`, {
                        code: reservationCode,
                        name: clientName,
                        email: clientEmail,
                        phone: clientPhone
                    });
                    
                    // Usar nombre como identificador si no hay email
                    const identifier = clientEmail ? clientEmail.toLowerCase() : (clientName ? clientName.toLowerCase().trim() : '');
                    
                    if (!identifier) {
                        console.warn('‚ö†Ô∏è Reserva sin email ni nombre:', reservationCode);
                return;
            }
            
                    console.log(`üìß Identificador procesado: ${identifier}`);
            
                    // Si ya procesamos este identificador en esta ejecuci√≥n, saltar
                    if (processedEmails.has(identifier)) {
                        console.log(`üîÑ Identificador ${identifier} ya procesado`);
                return;
            }
            
                    processedEmails.add(identifier);
                    console.log(`‚úÖ Identificador ${identifier} agregado a procesados`);
                    
                    if (!existingEmails.has(identifier)) {
                        console.log(`üÜï Identificador ${identifier} no existe, creando nuevo usuario...`);
                        // Calcular nuevo ID
                        let newId = 1;
                        if (users.length > 0) {
                            const numericIds = users.map(u => {
                                const id = parseInt(u.id);
                                return isNaN(id) ? 0 : id;
                            }).filter(id => id > 0);
                            newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : users.length + 1;
        }
        
                        // Crear nuevo usuario desde la reserva
                        const newUser = {
                            id: newId,
                            name: clientName,
                            email: clientEmail,
                            phone: clientPhone,
                            status: 'active',
                            is_active: true,
                            createdAt: reservation.createdAt || reservation.created_at || reservation.reservationDate || reservation.reservation_date || new Date().toISOString(),
                            created_at: reservation.createdAt || reservation.created_at || reservation.reservationDate || reservation.reservation_date || new Date().toISOString(),
                            last_activity: reservation.updatedAt || reservation.updated_at || new Date().toISOString(),
                            rewards_points: 0,
                            tipoCuenta: 'cliente_reserva',
                            avatar_url: null
                        };
                        
                        users.push(newUser);
                        existingEmails.add(identifier);
                        newUsersCount++;
                        console.log('‚úÖ Nuevo usuario creado desde reserva:', newUser.name || newUser.email, newUser);
                        } else {
                        // Actualizar √∫ltima actividad si el usuario ya existe
                        const userIndex = users.findIndex(user => {
                            if (clientEmail && user.email) {
                                return user.email.toLowerCase() === identifier;
                            }
                            // Si no hay email, buscar por nombre
                            return user.name && user.name.toLowerCase().trim() === identifier;
                        });
                        if (userIndex !== -1) {
                            users[userIndex].last_activity = reservation.updatedAt || reservation.updated_at || new Date().toISOString();
                            users[userIndex].updatedAt = new Date().toISOString();
                            // Actualizar datos si est√°n disponibles y faltan
                            if (clientName && !users[userIndex].name) {
                                users[userIndex].name = clientName;
                            }
                            if (clientPhone && !users[userIndex].phone) {
                                users[userIndex].phone = clientPhone;
                            }
                            console.log('üîÑ Usuario actualizado:', users[userIndex].email);
                        }
                        updatedUsersCount++;
                    }
                });
                
                // Guardar todos los usuarios actualizados en localStorage
                localStorage.setItem('checkin24hs_users', JSON.stringify(users));
                console.log('üíæ Usuarios guardados en localStorage:', users.length);
                
                // Sincronizar a Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized() && newUsersCount > 0) {
                    console.log('‚òÅÔ∏è Sincronizando usuarios a Supabase...');
                    for (const user of users) {
                        try {
                            // Usar insert (upsert puede fallar con email vac√≠o)
                            const userData = {
                                name: user.name,
                                email: user.email || null,
                                phone: user.phone || null,
                                is_active: true,
                                created_at: user.created_at || new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                                last_activity: user.last_activity,
                                tipo_cuenta: user.tipoCuenta || 'cliente_reserva'
                            };
                            
                            // Solo hacer upsert si tiene email, sino insert normal
                            let error;
                            if (user.email) {
                                const result = await window.supabaseClient.client
                                    .from('users')
                                    .upsert(userData, { onConflict: 'email' });
                                error = result.error;
                            } else {
                                const result = await window.supabaseClient.client
                                    .from('users')
                                    .insert(userData);
                                error = result.error;
                            }
                            
                            if (error && !error.message?.includes('duplicate')) {
                                console.warn('‚ö†Ô∏è Error sincronizando usuario:', user.name, error);
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error sincronizando usuario:', user.email, e);
                        }
                    }
                    console.log('‚úÖ Usuarios sincronizados a Supabase');
                }
                
                console.log(`‚úÖ Proceso completado: ${newUsersCount} nuevos usuarios, ${updatedUsersCount} usuarios actualizados`);
            
                // Mostrar mensaje de √©xito
                alert(`‚úÖ Actualizaci√≥n completada:\n- ${newUsersCount} nuevos usuarios agregados\n- ${updatedUsersCount} usuarios actualizados\n\n‚òÅÔ∏è Datos sincronizados con Supabase`);
                
                // Recargar datos de usuarios si estamos en la secci√≥n de usuarios
                if (typeof loadUsersData === 'function') {
                    console.log('üîÑ Recargando datos de usuarios...');
                    loadUsersData();
            } else {
                    console.warn('‚ö†Ô∏è Funci√≥n loadUsersData no encontrada');
                    }
                
                } catch (error) {
                console.error('‚ùå Error al actualizar usuarios desde reservas:', error);
                alert('‚ùå Error al actualizar usuarios: ' + error.message);
            }
        }

        // ===== FUNCIONES PARA GESTI√ìN DE GASTOS =====
        
        // Categor√≠as de gastos
        const expenseCategories = {
            'sueldos': 'Sueldos',
            'servicios': 'Servicios',
            'alquiler': 'Alquiler',
            'telefonia': 'Telefon√≠a',
            'publicidad_meta': 'Publicidad Meta',
            'gastos_bancario': 'Gastos Bancario',
            'tecnologia_oficina': 'Tecnolog√≠a de Oficina',
            'varios': 'Varios'
        };

        // Inicializar base de datos de gastos
        function initExpensesDB() {
            console.log('üí∞ Inicializando base de datos de gastos...');
            const existingExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            console.log(`üìä Estado inicial: ${existingExpenses.length} gastos en localStorage`);
            
            // Inicializar presupuestos si no existen
            if (!localStorage.getItem('expensesBudget')) {
                const defaultBudget = {
                    monthly: 50000,
                    quarterly: 150000,
                    yearly: 600000
                };
                localStorage.setItem('expensesBudget', JSON.stringify(defaultBudget));
            }
        }

        // Cargar todos los datos de gastos
        function loadExpensesData() {
            console.log('üí∞ Cargando datos de gastos...');
            loadExpensesTable();
            updateExpensesKPIs();
            updateExpensesCharts();
        }

        // Actualizar categor√≠as seg√∫n tipo de gasto
        function updateExpenseCategories() {
            const categorySelect = document.getElementById('expenseCategory');
            categorySelect.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
            
            // Mostrar todas las categor√≠as sin importar el tipo de gasto
            Object.keys(expenseCategories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = expenseCategories[key];
                categorySelect.appendChild(option);
            });
        }

        // Abrir modal para agregar gasto
        function addNewExpense() {
            document.getElementById('expenseModalTitle').textContent = 'Agregar Gasto';
            document.getElementById('expenseForm').reset();
            // IMPORTANTE: Limpiar el expenseId para evitar sobrescribir gastos existentes
            delete document.getElementById('expenseForm').dataset.expenseId;
            
            // Usar fecha de Argentina
            const argentinaDate = new Date().toLocaleDateString('en-CA', { 
                timeZone: 'America/Argentina/Buenos_Aires' 
            });
            document.getElementById('expenseDate').value = argentinaDate;
            
            // Limpiar campos de tipo de cambio y USD
            document.getElementById('expenseExchangeRate').value = '';
            document.getElementById('expenseUSD').value = '';
            
            // Limpiar campos de imagen
            removeExpenseImage();
            pendingImageFile = null;
            
            // Cargar categor√≠as al abrir el modal
            updateExpenseCategories();
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Cerrar modal de gasto
        function closeExpenseModal() {
            document.getElementById('expenseModal').style.display = 'none';
            document.getElementById('expenseForm').reset();
            // Limpiar el expenseId al cerrar
            delete document.getElementById('expenseForm').dataset.expenseId;
            // Limpiar campos de imagen
            removeExpenseImage();
            pendingImageFile = null;
        }

        // Funci√≥n para calcular USD autom√°ticamente
        function calculateUSD() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const exchangeRate = parseFloat(document.getElementById('expenseExchangeRate').value) || 0;
            const usdField = document.getElementById('expenseUSD');
            
            if (exchangeRate > 0) {
                const usd = amount / exchangeRate;
                usdField.value = usd.toFixed(2);
            } else {
                usdField.value = '0.00';
            }
        }
        
        // ============================================
        // FUNCIONES DE IMAGEN PARA GASTOS
        // ============================================
        
        let cameraStream = null;
        let pendingImageFile = null;
        
        // Preview de imagen desde archivo
        function previewExpenseImage(input) {
            const file = input.files[0];
            if (file) {
                pendingImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('expenseImagePreviewImg').src = e.target.result;
                    document.getElementById('expenseImagePreview').style.display = 'block';
                    document.getElementById('expenseImageName').value = file.name;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Eliminar imagen
        function removeExpenseImage() {
            document.getElementById('expenseImagePreview').style.display = 'none';
            document.getElementById('expenseImagePreviewImg').src = '';
            document.getElementById('expenseImageFile').value = '';
            document.getElementById('expenseImageUrl').value = '';
            document.getElementById('expenseImageName').value = '';
            pendingImageFile = null;
        }
        
        // Abrir c√°mara
        async function openCameraCapture() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraModal').style.display = 'flex';
            } catch (error) {
                console.error('Error accediendo a la c√°mara:', error);
                alert('‚ùå No se pudo acceder a la c√°mara. Verifica los permisos.');
            }
        }
        
        // Cerrar c√°mara
        function closeCameraModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').style.display = 'none';
        }
        
        // Capturar foto
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Convertir a blob
            canvas.toBlob(function(blob) {
                const timestamp = Date.now();
                const file = new File([blob], `comprobante_${timestamp}.jpg`, { type: 'image/jpeg' });
                pendingImageFile = file;
                
                // Mostrar preview
                document.getElementById('expenseImagePreviewImg').src = canvas.toDataURL('image/jpeg');
                document.getElementById('expenseImagePreview').style.display = 'block';
                document.getElementById('expenseImageName').value = file.name;
                
                closeCameraModal();
            }, 'image/jpeg', 0.8);
        }
        
        // Subir imagen a Supabase Storage
        async function uploadExpenseImage(file) {
            if (!file) return null;
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.warn('‚ö†Ô∏è Supabase no disponible, guardando imagen como base64');
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ url: reader.result, name: file.name });
                    reader.readAsDataURL(file);
                });
            }
            
            try {
                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                
                const { data, error } = await window.supabaseClient.client.storage
                    .from('expense-images')
                    .upload(fileName, file);
                
                if (error) throw error;
                
                // Obtener URL p√∫blica
                const { data: urlData } = window.supabaseClient.client.storage
                    .from('expense-images')
                    .getPublicUrl(fileName);
                
                return { url: urlData.publicUrl, name: fileName };
            } catch (error) {
                console.error('‚ùå Error subiendo imagen:', error);
                // Fallback a base64
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ url: reader.result, name: file.name });
                    reader.readAsDataURL(file);
                });
            }
        }
        
        // Guardar gasto
        async function saveExpense(event) {
            event.preventDefault();
            
            const expenseId = document.getElementById('expenseForm').dataset.expenseId;
            
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const exchangeRateValue = document.getElementById('expenseExchangeRate').value;
            const exchangeRate = exchangeRateValue ? parseFloat(exchangeRateValue) : null;
            const usd = (exchangeRate && exchangeRate > 0) ? amount / exchangeRate : null;
            
            console.log('üíæ Guardando gasto:', { amount, exchangeRate, usd });
            
            // Subir imagen si existe
            let imageUrl = document.getElementById('expenseImageUrl').value || null;
            let imageName = document.getElementById('expenseImageName').value || null;
            
            if (pendingImageFile) {
                try {
                    console.log('üì§ Subiendo imagen...');
                    const imageResult = await uploadExpenseImage(pendingImageFile);
                    if (imageResult) {
                        imageUrl = imageResult.url;
                        imageName = imageResult.name;
                        console.log('‚úÖ Imagen subida:', imageUrl);
                    }
                } catch (error) {
                    console.error('‚ùå Error subiendo imagen:', error);
                    alert('‚ö†Ô∏è Error al subir la imagen, pero se guardar√° el gasto sin imagen');
                }
            }
            
            const expenseData = {
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                category: document.getElementById('expenseCategory').value,
                subcategory: document.getElementById('expenseSubcategory').value || '',
                description: document.getElementById('expenseDescription').value,
                amount: amount,
                exchange_rate: exchangeRate,
                usd_amount: usd ? parseFloat(usd.toFixed(2)) : null,
                image_url: imageUrl,
                image_name: imageName,
                // Tambi√©n guardar con nombres alternativos para compatibilidad
                exchangeRate: exchangeRate,
                usd: usd ? parseFloat(usd.toFixed(2)) : null
            };
            
            console.log('üì¶ Datos del gasto:', expenseData);
            
            try {
                // Intentar guardar en Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        if (expenseId) {
                            // Usar el ID tal como est√° (puede ser UUID o n√∫mero)
                            console.log('üîÑ Actualizando gasto con ID:', expenseId);
                            
                            const result = await window.supabaseClient.updateExpense(expenseId, expenseData);
                            
                            if (result) {
                                console.log('‚úÖ Gasto actualizado en Supabase:', result);
                                alert('‚úÖ Gasto actualizado correctamente');
                            } else {
                                throw new Error('No se recibi√≥ respuesta de Supabase');
                            }
                        } else {
                            console.log('‚ûï Creando nuevo gasto...');
                            await window.supabaseClient.createExpense(expenseData);
                            console.log('‚úÖ Gasto guardado en Supabase');
                            alert('‚úÖ Gasto guardado correctamente');
                        }
                    } catch (error) {
                        console.error('‚ùå Error guardando en Supabase:', error);
                        alert('‚ùå Error: ' + error.message);
                        // Fallback a localStorage
                        const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                        const expense = {
                            id: expenseId || Date.now().toString(),
                            ...expenseData,
                            exchangeRate: expenseData.exchange_rate,
                            usd: expenseData.usd_amount,
                createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (expenseId) {
                const index = expenses.findIndex(e => e.id === expenseId);
                if (index !== -1) {
                    expenses[index] = expense;
                }
            } else {
                expenses.push(expense);
            }
                        localStorage.setItem('expensesDB', JSON.stringify(expenses));
                        alert('‚úÖ Gasto guardado correctamente (guardado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no est√° disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const expense = {
                        id: expenseId || Date.now().toString(),
                        ...expenseData,
                        exchangeRate: expenseData.exchange_rate,
                        usd: expenseData.usd_amount,
                        createdAt: expenseId ? expenses.find(e => e.id === expenseId)?.createdAt : new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (expenseId) {
                        const index = expenses.findIndex(e => e.id === expenseId);
                        if (index !== -1) {
                            expenses[index] = expense;
                        }
                    } else {
                        expenses.push(expense);
                    }
            localStorage.setItem('expensesDB', JSON.stringify(expenses));
                    alert('‚úÖ Gasto guardado correctamente (guardado localmente)');
                }
            
            closeExpenseModal();
            loadExpensesData();
            } catch (error) {
                console.error('‚ùå Error guardando gasto:', error);
                alert('‚ùå Error al guardar el gasto');
            }
        }

        // Cargar tabla de gastos
        async function loadExpensesTable() {
            // Intentar cargar desde Supabase primero
            let expenses = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    console.log('‚òÅÔ∏è Cargando gastos desde Supabase...');
                    expenses = await window.supabaseClient.getExpenses();
                    console.log(`‚úÖ ${expenses.length} gastos cargados desde Supabase`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando desde Supabase, usando localStorage:', error);
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
            } else {
                console.log('üíæ Cargando gastos desde localStorage...');
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            }
            
            const tbody = document.getElementById('expensesTableBody');
            const noExpensesMessage = document.getElementById('noExpensesMessage');
            
            if (!tbody) return;
            
            if (expenses.length === 0) {
                tbody.innerHTML = '';
                if (noExpensesMessage) noExpensesMessage.style.display = 'block';
                return;
            }
            
            if (noExpensesMessage) noExpensesMessage.style.display = 'none';
            
            // Ordenar por fecha descendente
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                const categoryName = expenseCategories[expense.category] || expense.category;
                const typeLabel = expense.type === 'fixed' ? 'Fijo' : 'Variable';
                const typeColor = expense.type === 'fixed' ? '#1976d2' : '#f57c00';
                
                // Normalizar nombres de campos (Supabase usa snake_case, localStorage usa camelCase)
                const exchangeRate = expense.exchange_rate || expense.exchangeRate || null;
                const usdAmount = expense.usd_amount || expense.usd || null;
                
                // Formatear fecha en zona horaria Argentina
                const expenseDate = new Date(expense.date + 'T12:00:00');
                const formattedDate = expenseDate.toLocaleDateString('es-AR', { 
                    timeZone: 'America/Argentina/Buenos_Aires',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${categoryName}</td>
                    <td>${expense.subcategory || '-'}</td>
                    <td><span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">${typeLabel}</span></td>
                    <td>${expense.description}</td>
                    <td style="font-weight: 600; color: #d32f2f;">$${expense.amount.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${exchangeRate ? exchangeRate.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td style="font-weight: 600; color: #1976d2;">${usdAmount ? '$' + usdAmount.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
                    <td>
                        <button onclick="editExpense('${expense.id}')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                        </button>
                        <button onclick="deleteExpense('${expense.id}')" style="background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Editar gasto
        async function editExpense(expenseId) {
            // Intentar obtener de Supabase primero, luego localStorage
            let expenses = [];
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                try {
                    expenses = await window.supabaseClient.getExpenses();
                } catch (error) {
                    expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                }
            } else {
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            }
            
            const expense = expenses.find(e => e.id === expenseId || e.id === parseInt(expenseId));
            
            if (!expense) {
                alert('‚ùå Gasto no encontrado');
                return;
            }
            
            // Limpiar imagen pendiente
            pendingImageFile = null;
            
            document.getElementById('expenseModalTitle').textContent = 'Editar Gasto';
            document.getElementById('expenseForm').dataset.expenseId = expenseId;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseType').value = expense.type;
            updateExpenseCategories();
            setTimeout(() => {
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseSubcategory').value = expense.subcategory || '';
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                // Normalizar nombres de campos (Supabase usa snake_case)
                const exchangeRate = expense.exchange_rate || expense.exchangeRate || '';
                document.getElementById('expenseExchangeRate').value = exchangeRate;
                // Calcular USD autom√°ticamente al cargar
                calculateUSD();
                
                // Cargar imagen existente si hay
                const imageUrl = expense.image_url || expense.imageUrl || '';
                const imageName = expense.image_name || expense.imageName || '';
                if (imageUrl) {
                    document.getElementById('expenseImageUrl').value = imageUrl;
                    document.getElementById('expenseImageName').value = imageName;
                    document.getElementById('expenseImagePreviewImg').src = imageUrl;
                    document.getElementById('expenseImagePreview').style.display = 'block';
                } else {
                    removeExpenseImage();
                }
            }, 100);
            
            document.getElementById('expenseModal').style.display = 'block';
        }

        // Eliminar gasto
        async function deleteExpense(expenseId) {
            // Solo admin_total puede eliminar
            if (!isAdminTotal()) {
                alert('‚õî No tienes permisos para eliminar. Solo los administradores pueden realizar esta acci√≥n.');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este gasto?')) return;
            
            try {
                // Intentar eliminar de Supabase primero
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        await window.supabaseClient.deleteExpense(expenseId);
                        console.log('‚úÖ Gasto eliminado de Supabase');
                        alert('‚úÖ Gasto eliminado correctamente (eliminado de la nube)');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error eliminando de Supabase, eliminando de localStorage:', error);
                        // Fallback a localStorage
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const filtered = expenses.filter(e => e.id !== expenseId);
            localStorage.setItem('expensesDB', JSON.stringify(filtered));
                        alert('‚úÖ Gasto eliminado correctamente (eliminado localmente)');
                    }
                } else {
                    // Solo localStorage si Supabase no est√° disponible
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const filtered = expenses.filter(e => e.id !== expenseId);
                    localStorage.setItem('expensesDB', JSON.stringify(filtered));
                    alert('‚úÖ Gasto eliminado correctamente (eliminado localmente)');
                }
            
            loadExpensesData();
            } catch (error) {
                console.error('‚ùå Error eliminando gasto:', error);
                alert('‚ùå Error al eliminar el gasto');
            }
        }

        // Actualizar KPIs de gastos
        function updateExpensesKPIs() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
            
            // Calcular gastos totales
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('totalExpenses').textContent = `$${totalExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Calcular CPA (Costo por Adquisici√≥n)
            const marketingExpenses = expenses
                .filter(e => e.category === 'publicidad_meta')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalReservations = reservations.length;
            const cpa = totalReservations > 0 ? marketingExpenses / totalReservations : 0;
            document.getElementById('cpaValue').textContent = `$${cpa.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpaSubtitle').textContent = `Publicidad Meta: $${marketingExpenses.toLocaleString('es-ES')} / ${totalReservations} reservas`;
            
            // Calcular CPC (Costo por Llamada) - Simulado
            const telecomExpenses = expenses
                .filter(e => e.category === 'telefonia')
                .reduce((sum, e) => sum + e.amount, 0);
            const salesPersonnelExpenses = expenses
                .filter(e => e.category === 'sueldos')
                .reduce((sum, e) => sum + e.amount, 0);
            const totalCalls = totalReservations * 3; // Estimaci√≥n: 3 llamadas por reserva
            const cpc = totalCalls > 0 ? (telecomExpenses + salesPersonnelExpenses) / totalCalls : 0;
            document.getElementById('cpcValue').textContent = `$${cpc.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('cpcSubtitle').textContent = `Telecom + Agentes: $${(telecomExpenses + salesPersonnelExpenses).toLocaleString('es-ES')} / ${totalCalls} llamadas`;
            
            // Calcular variaci√≥n de presupuesto
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000}');
            const currentMonth = new Date().getMonth();
            const monthlyBudget = budget.monthly || 50000;
            const monthlyExpenses = expenses
                .filter(e => {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === new Date().getFullYear();
                })
                .reduce((sum, e) => sum + e.amount, 0);
            const variance = monthlyBudget > 0 ? ((monthlyExpenses - monthlyBudget) / monthlyBudget) * 100 : 0;
            document.getElementById('budgetVariance').textContent = `${variance >= 0 ? '+' : ''}${variance.toFixed(1)}%`;
            document.getElementById('budgetVarianceSubtitle').textContent = `Real: $${monthlyExpenses.toLocaleString('es-ES')} vs Presupuesto: $${monthlyBudget.toLocaleString('es-ES')}`;
            
            // Calcular acumulado en d√≥lares (USD)
            // Los gastos en USD se identifican por currency = 'USD' o se convierten con tipo de cambio
            const exchangeRate = parseFloat(localStorage.getItem('exchangeRateUSD') || '1050'); // Tipo de cambio ARS/USD
            
            // Gastos directamente en USD
            const expensesInUSD = expenses
                .filter(e => e.currency === 'USD')
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Gastos en pesos convertidos a USD
            const expensesInARS = expenses
                .filter(e => e.currency !== 'USD')
                .reduce((sum, e) => sum + e.amount, 0);
            const convertedToUSD = expensesInARS / exchangeRate;
            
            // Total acumulado en USD
            const totalUSD = expensesInUSD + convertedToUSD;
            
            const totalExpensesUSDEl = document.getElementById('totalExpensesUSD');
            const totalExpensesUSDSubtitleEl = document.getElementById('totalExpensesUSDSubtitle');
            
            if (totalExpensesUSDEl) {
                totalExpensesUSDEl.textContent = `$${totalUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} USD`;
            }
            if (totalExpensesUSDSubtitleEl) {
                totalExpensesUSDSubtitleEl.textContent = `TC: $${exchangeRate.toLocaleString('es-AR')} | USD directo: $${expensesInUSD.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
            }
        }

        // Actualizar gr√°ficos de gastos
        function updateExpensesCharts() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            
            updateCompositionChart(expenses);
            updateVariableExpensesChart(expenses);
            updateBudgetChart(expenses);
        }

        // Gr√°fico de composici√≥n (Pie Chart)
        function updateCompositionChart(expenses) {
            const fixedExpenses = expenses
                .filter(e => e.type === 'fixed')
                .reduce((sum, e) => sum + e.amount, 0);
            const variableExpenses = expenses
                .filter(e => e.type === 'variable')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const ctx = document.getElementById('expensesCompositionChart');
            if (!ctx) return;
            
            if (expensesCharts.composition) {
                expensesCharts.composition.destroy();
            }
            
            expensesCharts.composition = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Gastos Fijos', 'Gastos Variables'],
                    datasets: [{
                        data: [fixedExpenses, variableExpenses],
                        backgroundColor: ['#1976d2', '#f57c00'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = fixedExpenses + variableExpenses;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: $${value.toLocaleString('es-ES', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de gastos variables (Bar Chart)
        function updateVariableExpensesChart(expenses) {
            const variableExpenses = expenses.filter(e => e.type === 'variable');
            
            const categories = {
                'sales_personnel': 'Personal Ventas',
                'marketing': 'Marketing',
                'telecom': 'Telecomunicaciones',
                'acquisition': 'Adquisici√≥n'
            };
            
            const data = {};
            Object.keys(categories).forEach(key => {
                data[key] = variableExpenses
                    .filter(e => e.category === key)
                    .reduce((sum, e) => sum + e.amount, 0);
            });
            
            const ctx = document.getElementById('variableExpensesChart');
            if (!ctx) return;
            
            if (expensesCharts.variable) {
                expensesCharts.variable.destroy();
            }
            
            expensesCharts.variable = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(categories),
                    datasets: [{
                        label: 'Monto ($)',
                        data: Object.values(data),
                        backgroundColor: ['#1976d2', '#f57c00', '#388e3c', '#9c27b0'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de Gasto vs Presupuesto (Line Chart)
        function updateBudgetChart(expenses) {
            const period = document.getElementById('budgetPeriodFilter')?.value || 'monthly';
            const budget = JSON.parse(localStorage.getItem('expensesBudget') || '{"monthly": 50000, "quarterly": 150000, "yearly": 600000}');
            
            // Agrupar gastos por per√≠odo
            const groupedExpenses = {};
            const now = new Date();
            
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                let key;
                
                if (period === 'monthly') {
                    key = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
                } else if (period === 'quarterly') {
                    const quarter = Math.floor(expenseDate.getMonth() / 3) + 1;
                    key = `${expenseDate.getFullYear()}-Q${quarter}`;
                } else {
                    key = expenseDate.getFullYear().toString();
                }
                
                if (!groupedExpenses[key]) {
                    groupedExpenses[key] = 0;
                }
                groupedExpenses[key] += expense.amount;
            });
            
            const labels = Object.keys(groupedExpenses).sort();
            const actualData = labels.map(label => groupedExpenses[label] || 0);
            const budgetValue = budget[period] || budget.monthly;
            const budgetData = labels.map(() => budgetValue);
            
            const ctx = document.getElementById('budgetComparisonChart');
            if (!ctx) return;
            
            if (expensesCharts.budget) {
                expensesCharts.budget.destroy();
            }
            
            expensesCharts.budget = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gasto Real',
                            data: actualData,
                            borderColor: '#d32f2f',
                            backgroundColor: 'rgba(211, 47, 47, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Presupuesto',
                            data: budgetData,
                            borderColor: '#388e3c',
                            backgroundColor: 'rgba(56, 142, 60, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filtrar gastos
        function filterExpenses() {
            const searchTerm = document.getElementById('expensesSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#expensesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Exportar gastos
        async function exportExpenses() {
            let expenses = [];
            
            // Intentar obtener de Supabase primero
            try {
                if (window.supabaseClient && typeof window.supabaseClient.getExpenses === 'function') {
                    expenses = await window.supabaseClient.getExpenses();
                    console.log('üìä Gastos obtenidos de Supabase:', expenses.length);
                }
            } catch (error) {
                console.error('Error obteniendo gastos de Supabase:', error);
            }
            
            // Fallback a localStorage
            if (!expenses || expenses.length === 0) {
                expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                console.log('üìä Gastos obtenidos de localStorage:', expenses.length);
            }
            
            if (expenses.length === 0) {
                alert('‚ùå No hay gastos para exportar');
                return;
            }
            
            let csv = 'Fecha,Tipo,Categor√≠a,Subcategor√≠a,Descripci√≥n,Monto,Tipo de Cambio,USD\n';
            expenses.forEach(expense => {
                const categoryName = expenseCategories[expense.category] || expense.category;
                const exchangeRate = expense.exchangeRate || expense.exchange_rate || '';
                const usdAmount = expense.usd || expense.usd_amount || '';
                csv += `"${expense.date}","${expense.type === 'fixed' ? 'Fijo' : 'Variable'}","${categoryName}","${expense.subcategory || ''}","${expense.description}","${expense.amount}","${exchangeRate}","${usdAmount}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `gastos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Gastos exportados correctamente (' + expenses.length + ' registros)');
        }

        // Actualizar gastos
        function refreshExpenses() {
            loadExpensesData();
            alert('‚úÖ Gastos actualizados');
        }

        // Limpiar gastos duplicados
        async function cleanDuplicateExpenses() {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar los gastos duplicados?\n\nEsto eliminar√° gastos que tengan la misma fecha, monto, descripci√≥n y categor√≠a.')) {
                return;
            }
            
            try {
                let result;
                
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    // Limpiar en Supabase
                    result = await window.supabaseClient.cleanDuplicateExpenses();
                } else {
                    // Limpiar en localStorage
                    const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    const uniqueMap = new Map();
                    
                    expenses.forEach(expense => {
                        const key = `${expense.date}|${expense.amount}|${expense.description}|${expense.category}|${expense.subcategory || ''}`;
                        if (!uniqueMap.has(key)) {
                            uniqueMap.set(key, expense);
                        }
                    });
                    
                    const uniqueExpenses = Array.from(uniqueMap.values());
                    const duplicatesRemoved = expenses.length - uniqueExpenses.length;
                    localStorage.setItem('expensesDB', JSON.stringify(uniqueExpenses));
                    result = { deleted: duplicatesRemoved, kept: uniqueExpenses.length };
                }
                
                // Recargar la tabla
                loadExpensesData();
                
                if (result.deleted > 0) {
                    alert(`‚úÖ Limpieza completada:\n\n‚Ä¢ ${result.deleted} duplicados eliminados\n‚Ä¢ ${result.kept} gastos √∫nicos conservados`);
                } else {
                    alert('‚úÖ No se encontraron gastos duplicados');
                }
            } catch (error) {
                console.error('‚ùå Error limpiando duplicados:', error);
                alert('‚ùå Error al limpiar duplicados: ' + error.message);
            }
        }

        // Abrir modal para actualizar tipo de cambio masivamente
        function openMassUpdateExchangeRate() {
            const expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            const withoutTC = expenses.filter(e => !e.exchangeRate && !e.exchange_rate);
            
            const html = `
                <div id="massUpdateTCModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin: 0 0 20px 0; color: #333;">üí± Actualizar Tipo de Cambio Masivo</h2>
                        
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #e65100;">
                                <strong>üìä Resumen:</strong><br>
                                ‚Ä¢ Total de gastos: <strong>${expenses.length}</strong><br>
                                ‚Ä¢ Sin tipo de cambio: <strong style="color: #d32f2f;">${withoutTC.length}</strong>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Tipo de Cambio a aplicar:</label>
                            <input type="number" id="massExchangeRate" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem;" placeholder="Ej: 1050" step="0.01">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="updateOnlyEmpty" checked style="width: 18px; height: 18px;">
                                <span>Solo actualizar gastos <strong>SIN</strong> tipo de cambio (${withoutTC.length} gastos)</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeMassUpdateTCModal()" style="padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: #e0e0e0; font-weight: 600;">
                                Cancelar
                            </button>
                            <button onclick="applyMassExchangeRate()" style="padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: #ff9800; color: white; font-weight: 600;">
                                Aplicar a ${withoutTC.length} gastos
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeMassUpdateTCModal() {
            const modal = document.getElementById('massUpdateTCModal');
            if (modal) modal.remove();
        }
        
        async function applyMassExchangeRate() {
            const exchangeRate = parseFloat(document.getElementById('massExchangeRate').value);
            const onlyEmpty = document.getElementById('updateOnlyEmpty').checked;
            
            if (!exchangeRate || exchangeRate <= 0) {
                alert('‚ùå Por favor ingresa un tipo de cambio v√°lido');
                return;
            }
            
            let expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
            let updated = 0;
            
            expenses = expenses.map(expense => {
                const hasTC = expense.exchangeRate || expense.exchange_rate;
                
                if (onlyEmpty && hasTC) {
                    return expense; // No modificar si ya tiene TC y la opci√≥n est√° activa
                }
                
                const amount = parseFloat(expense.amount) || 0;
                const usd = amount / exchangeRate;
                
                updated++;
                return {
                    ...expense,
                    exchangeRate: exchangeRate,
                    exchange_rate: exchangeRate,
                    usd: usd,
                    usd_amount: usd
                };
            });
            
            // Guardar en localStorage
            localStorage.setItem('expensesDB', JSON.stringify(expenses));
            
            // Actualizar en Supabase
            if (window.supabaseClient) {
                try {
                    for (const expense of expenses) {
                        if (typeof window.supabaseClient.updateExpense === 'function') {
                            await window.supabaseClient.updateExpense(expense.id, {
                                exchange_rate: expense.exchangeRate,
                                usd_amount: expense.usd
                            });
                        }
                    }
                    console.log('‚úÖ Gastos actualizados en Supabase');
                } catch (error) {
                    console.error('Error actualizando en Supabase:', error);
                }
            }
            
            closeMassUpdateTCModal();
            loadExpensesData();
            loadMonthlyExpenses();
            
            alert(`‚úÖ ${updated} gastos actualizados con TC: $${exchangeRate}`);
        }

        // IMPORTANTE: NO inicializar nada hasta verificar autenticaci√≥n
        // Solo inicializar gastos si el usuario est√° autenticado
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
        initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesi√≥n para gastos:', e);
                }
            }
        }
        
        // Verificar autenticaci√≥n cuando el DOM est√© listo (esto se ejecuta ANTES del DOMContentLoaded del dashboard)
        (function() {
            function verifyAuth() {
                console.log('üîê Verificando autenticaci√≥n...');
                checkAuthStatus();
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', verifyAuth);
            } else {
                setTimeout(verifyAuth, 10);
            }
        })();
        
        // Inicializar gastos solo si est√° autenticado (despu√©s de verificar)
        function initExpensesIfAuthenticated() {
            const authSession = localStorage.getItem('dashboard_auth_session');
            if (authSession) {
                try {
                    const session = JSON.parse(authSession);
                    const now = Date.now();
                    if (session.expiresAt && now < session.expiresAt) {
                        // Usuario autenticado, inicializar gastos
                        if (typeof initExpensesDB === 'function') {
                            initExpensesDB();
                        }
                    }
                } catch (e) {
                    console.error('Error al verificar sesi√≥n para gastos:', e);
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExpensesIfAuthenticated);
        } else {
            setTimeout(initExpensesIfAuthenticated, 200);
        }

        // ============================================
        // GESTI√ìN DE ADMINISTRADORES
        // ============================================

        // Cargar administradores en la tabla
        async function loadAdminsTable() {
            const tableBody = document.getElementById('adminsTableBody');
            if (!tableBody) return;

            // Mostrar loading
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Cargando administradores...</td></tr>';

            // Obtener administradores (de Supabase si est√° disponible)
            let admins = [];
            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Cargando administradores desde Supabase...');
                    admins = await window.supabaseClient.getAdmins();
                    // Sincronizar con localStorage como backup
                    if (admins && admins.length > 0) {
                        localStorage.setItem('dashboard_admin_users', JSON.stringify(admins));
                    }
                    console.log(`‚úÖ ${admins.length} administradores cargados de Supabase`);
                } else {
                    admins = getAdminUsers();
                }
            } catch (error) {
                console.error('‚ùå Error cargando administradores:', error);
                admins = getAdminUsers();
            }

            tableBody.innerHTML = '';

            admins.forEach(admin => {
                const row = document.createElement('tr');
                const roleText = admin.role === 'admin_total' ? 'Administrador Total' : 'Usuario';
                const roleBadge = admin.role === 'admin_total' ? 
                    '<span style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Admin Total</span>' :
                    '<span style="background: #666; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Usuario</span>';
                
                const statusBadge = admin.status === 'active' ?
                    '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Activo</span>' :
                    '<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Inactivo</span>';

                // Soportar ambas estructuras de campo (camelCase y snake_case)
                const lastLoginValue = admin.lastLogin || admin.last_login;
                const lastLogin = lastLoginValue ? new Date(lastLoginValue).toLocaleString('es-ES') : 'Nunca';

                row.innerHTML = `
                    <td style="padding: 12px;">${admin.username}</td>
                    <td style="padding: 12px;">${admin.name}</td>
                    <td style="padding: 12px;">${admin.email || '-'}</td>
                    <td style="padding: 12px; text-align: center;">${roleBadge}</td>
                    <td style="padding: 12px; text-align: center;">${lastLogin}</td>
                    <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button class="btn-edit" onclick="editAdmin('${admin.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-edit" onclick="showResetPasswordModal('${admin.id}')" title="Resetear Contrase√±a" style="background: #ff9800;">
                                <i class="fas fa-key"></i>
                            </button>
                            ${admin.status === 'active' ? 
                                `<button class="btn-delete" onclick="deactivateAdmin('${admin.id}')" title="Dar de Baja">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button class="btn-edit" onclick="activateAdmin('${admin.id}')" title="Activar" style="background: #4caf50;">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Actualizar estad√≠sticas
            updateAdminStats(admins);
        }

        // Actualizar estad√≠sticas de administradores
        function updateAdminStats(admins = null) {
            if (!admins) {
                admins = getAdminUsers();
            }
            const total = admins.length;
            const totalAdmins = admins.filter(a => a.role === 'admin_total').length;
            const totalUsers = admins.filter(a => a.role === 'usuario').length;
            const active = admins.filter(a => a.status === 'active').length;

            document.getElementById('totalAdmins').textContent = total;
            document.getElementById('totalAdminsTotal').textContent = totalAdmins;
            document.getElementById('totalAdminsUser').textContent = totalUsers;
            document.getElementById('activeAdmins').textContent = active;
        }

        // Mostrar modal para nuevo administrador
        function showNewAdminModal() {
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden crear nuevos administradores');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Nuevo Administrador';
            document.getElementById('adminId').value = '';
            document.getElementById('adminForm').reset();
            document.getElementById('adminPassword').required = true;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Editar administrador
        function editAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden editar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('‚ùå Administrador no encontrado');
                return;
            }

            document.getElementById('adminModalTitle').textContent = 'Editar Administrador';
            document.getElementById('adminId').value = admin.id;
            document.getElementById('adminUsername').value = admin.username;
            document.getElementById('adminName').value = admin.name;
            document.getElementById('adminEmail').value = admin.email || '';
            document.getElementById('adminRole').value = admin.role;
            document.getElementById('adminStatus').value = admin.status;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').required = false;
            document.getElementById('adminModal').style.display = 'block';
        }

        // Guardar administrador
        async function saveAdmin(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden guardar administradores');
                return;
            }

            const adminId = document.getElementById('adminId').value;
            const username = document.getElementById('adminUsername').value.trim();
            const name = document.getElementById('adminName').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const role = document.getElementById('adminRole').value;
            const status = document.getElementById('adminStatus').value;
            const password = document.getElementById('adminPassword').value;

            try {
                // Obtener administradores (de Supabase si est√° disponible)
                let admins = [];
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    admins = await window.supabaseClient.getAdmins();
                } else {
                    admins = getAdminUsers();
                }

            if (adminId) {
                // Editar
                const adminIndex = admins.findIndex(a => a.id === adminId);
                if (adminIndex === -1) {
                    alert('‚ùå Administrador no encontrado');
                    return;
                }

                // Verificar que el username no est√© en uso por otro admin
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase() && a.id !== adminId);
                if (usernameExists) {
                    alert('‚ùå El nombre de usuario ya est√° en uso');
                    return;
                }

                    const updates = {
                        username: username,
                        name: name,
                        email: email,
                        role: role,
                        status: status,
                        updated_at: new Date().toISOString()
                    };
                
                if (password && password.length >= 6) {
                        updates.password_hash = password;
                } else if (password && password.length > 0) {
                    alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }

                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        console.log('‚òÅÔ∏è Actualizando administrador en Supabase...');
                        await window.supabaseClient.updateAdmin(adminId, updates);
                        console.log('‚úÖ Administrador actualizado en Supabase');
                    } else {
                        // Fallback a localStorage
                        admins[adminIndex] = { ...admins[adminIndex], ...updates };
                saveAdminUsers(admins);
                    }
                    
                alert('‚úÖ Administrador actualizado correctamente');
            } else {
                // Nuevo
                if (!password || password.length < 6) {
                    alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }

                // Verificar que el username no est√© en uso
                const usernameExists = admins.some(a => a.username.toLowerCase() === username.toLowerCase());
                if (usernameExists) {
                    alert('‚ùå El nombre de usuario ya est√° en uso');
                    return;
                }

                const newAdmin = {
                    username: username,
                        password_hash: password,
                    name: name,
                    email: email,
                    role: role,
                    status: status,
                        created_at: new Date().toISOString(),
                        last_login: null
                };

                    if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                        console.log('‚òÅÔ∏è Creando administrador en Supabase...');
                        await window.supabaseClient.createAdmin(newAdmin);
                        console.log('‚úÖ Administrador creado en Supabase');
                    } else {
                        // Fallback a localStorage
                        newAdmin.id = 'admin-' + Date.now();
                admins.push(newAdmin);
                saveAdminUsers(admins);
                    }
                    
                alert('‚úÖ Administrador creado correctamente');
            }

            closeAdminModal();
            loadAdminsTable();
                
            } catch (error) {
                console.error('‚ùå Error guardando administrador:', error);
                alert('Error al guardar el administrador: ' + error.message);
            }
        }

        // Dar de baja administrador
        function deactivateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden dar de baja administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('‚ùå Administrador no encontrado');
                return;
            }

            if (confirm(`¬øEst√°s seguro de que quieres dar de baja a ${admin.name}?`)) {
                admin.status = 'inactive';
                saveAdminUsers(admins);
                loadAdminsTable();
                alert('‚úÖ Administrador dado de baja correctamente');
            }
        }

        // Activar administrador
        function activateAdmin(adminId) {
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden activar administradores');
                return;
            }

            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('‚ùå Administrador no encontrado');
                return;
            }

            admin.status = 'active';
            saveAdminUsers(admins);
            loadAdminsTable();
            alert('‚úÖ Administrador activado correctamente');
        }

        // Mostrar modal para resetear contrase√±a
        function showResetPasswordModal(adminId) {
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden resetear contrase√±as');
                return;
            }

            document.getElementById('resetAdminId').value = adminId;
            document.getElementById('resetPasswordForm').reset();
            document.getElementById('resetPasswordModal').style.display = 'block';
        }

        // Resetear contrase√±a
        async function resetAdminPassword(event) {
            event.preventDefault();
            
            if (!isAdminTotal()) {
                alert('‚ùå Solo los administradores totales pueden resetear contrase√±as');
                return;
            }

            const adminId = document.getElementById('resetAdminId').value;
            const password = document.getElementById('resetPassword').value;
            const passwordConfirm = document.getElementById('resetPasswordConfirm').value;

            if (password !== passwordConfirm) {
                alert('‚ùå Las contrase√±as no coinciden');
                return;
            }

            if (password.length < 6) {
                alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Actualizando contrase√±a en Supabase...');
                    await window.supabaseClient.updateAdmin(adminId, { password_hash: password });
                    console.log('‚úÖ Contrase√±a actualizada en Supabase');
                } else {
                    // Fallback a localStorage
            const admins = getAdminUsers();
            const admin = admins.find(a => a.id === adminId);
            if (!admin) {
                alert('‚ùå Administrador no encontrado');
                return;
            }
            admin.password = password;
                    admin.password_hash = password;
            saveAdminUsers(admins);
                }

            closeResetPasswordModal();
            alert('‚úÖ Contrase√±a reseteada correctamente');
            } catch (error) {
                console.error('‚ùå Error al resetear contrase√±a:', error);
                alert('Error al resetear contrase√±a: ' + error.message);
            }
        }

        // Cerrar modales
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        // Refrescar administradores
        function refreshAdmins() {
            loadAdminsTable();
        }

        // ============================================
        // FUNCIONES DE BACKUP Y RESTAURACI√ìN
        // ============================================
        
        async function createFullBackup() {
            try {
                showLoading();
                console.log('üíæ Creando backup completo...');
                
                // Recopilar todos los datos
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    createdBy: getCurrentUserName() || 'Sistema',
                    data: {}
                };
                
                // Obtener datos de Supabase si est√° disponible
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        backupData.data.hotels = await window.supabaseClient.getHotels();
                        backupData.data.reservations = await window.supabaseClient.getReservations();
                        backupData.data.quotes = await window.supabaseClient.getQuotes();
                        backupData.data.expenses = await window.supabaseClient.getExpenses();
                        backupData.data.agents = await window.supabaseClient.getAgents();
                        backupData.source = 'supabase';
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error obteniendo datos de Supabase, usando localStorage');
                    }
                }
                
                // Fallback a localStorage
                if (!backupData.data.hotels) {
                    backupData.data.hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                    backupData.data.reservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                    backupData.data.quotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                    backupData.data.expenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                    backupData.data.agents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                    backupData.data.users = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                    backupData.data.admins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                    backupData.source = 'localStorage';
                }
                
                // Crear y descargar archivo
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                const time = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
                a.href = url;
                a.download = `backup_checkin24hs_${date}_${time}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideLoading();
                
                // Resumen del backup
                const summary = `
‚úÖ BACKUP CREADO EXITOSAMENTE

üìä Resumen:
‚Ä¢ Hoteles: ${backupData.data.hotels?.length || 0}
‚Ä¢ Reservas: ${backupData.data.reservations?.length || 0}
‚Ä¢ Cotizaciones: ${backupData.data.quotes?.length || 0}
‚Ä¢ Gastos: ${backupData.data.expenses?.length || 0}
‚Ä¢ Agentes: ${backupData.data.agents?.length || 0}

üìÅ Archivo: backup_checkin24hs_${date}_${time}.json
üîÑ Fuente: ${backupData.source === 'supabase' ? 'Supabase (nube)' : 'LocalStorage (local)'}
                `;
                alert(summary);
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Error creando backup:', error);
                alert('‚ùå Error al crear el backup: ' + error.message);
            }
        }
        
        function showRestoreBackupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'restoreBackupModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>üîÑ Restaurar Backup</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <p style="color: #e65100; font-weight: 500;">
                                <span class="material-icons" style="vertical-align: middle;">warning</span>
                                ATENCI√ìN: Esta acci√≥n reemplazar√° todos los datos actuales con los del backup.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seleccionar archivo de backup (.json)</label>
                            <input type="file" id="backupFileInput" accept=".json" class="form-control" style="padding: 12px;">
                        </div>
                        <div id="backupPreview" style="display: none; margin-top: 16px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
                            <h4 style="margin-bottom: 8px;">üìã Contenido del backup:</h4>
                            <div id="backupPreviewContent"></div>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="form-button secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                        <button class="form-button" id="restoreBackupBtn" style="background: #f44336; color: white;" onclick="executeRestoreBackup()" disabled>
                            <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">restore</span>
                            Restaurar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Manejar selecci√≥n de archivo
            document.getElementById('backupFileInput').addEventListener('change', previewBackupFile);
        }
        
        let pendingBackupData = null;
        
        function previewBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    pendingBackupData = data;
                    
                    // Mostrar preview
                    const preview = document.getElementById('backupPreview');
                    const content = document.getElementById('backupPreviewContent');
                    
                    content.innerHTML = `
                        <p><strong>üìÖ Fecha:</strong> ${new Date(data.timestamp).toLocaleString('es-AR')}</p>
                        <p><strong>üë§ Creado por:</strong> ${data.createdBy || 'Desconocido'}</p>
                        <p><strong>üîÑ Versi√≥n:</strong> ${data.version || '1.0'}</p>
                        <hr style="margin: 12px 0;">
                        <p>üè® Hoteles: <strong>${data.data?.hotels?.length || 0}</strong></p>
                        <p>üìã Reservas: <strong>${data.data?.reservations?.length || 0}</strong></p>
                        <p>üí∞ Cotizaciones: <strong>${data.data?.quotes?.length || 0}</strong></p>
                        <p>üíµ Gastos: <strong>${data.data?.expenses?.length || 0}</strong></p>
                        <p>üë• Agentes: <strong>${data.data?.agents?.length || 0}</strong></p>
                    `;
                    
                    preview.style.display = 'block';
                    document.getElementById('restoreBackupBtn').disabled = false;
                    
                } catch (error) {
                    alert('‚ùå El archivo no es un backup v√°lido');
                    pendingBackupData = null;
                }
            };
            reader.readAsText(file);
        }
        
        async function executeRestoreBackup() {
            if (!pendingBackupData) {
                alert('‚ùå No hay backup seleccionado');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s SEGURO de que deseas restaurar este backup?\n\nTodos los datos actuales ser√°n reemplazados.')) {
                return;
            }
            
            try {
                showLoading();
                console.log('üîÑ Restaurando backup...');
                
                const data = pendingBackupData.data;
                
                // Guardar en localStorage como fallback
                if (data.hotels) localStorage.setItem('hotelsDB', JSON.stringify(data.hotels));
                if (data.reservations) localStorage.setItem('reservationsDB', JSON.stringify(data.reservations));
                if (data.quotes) localStorage.setItem('quotesDB', JSON.stringify(data.quotes));
                if (data.expenses) localStorage.setItem('expensesDB', JSON.stringify(data.expenses));
                if (data.agents) localStorage.setItem('agentsDB', JSON.stringify(data.agents));
                if (data.users) localStorage.setItem('checkin24hs_users', JSON.stringify(data.users));
                if (data.admins) localStorage.setItem('dashboard_admin_users', JSON.stringify(data.admins));
                
                // Si Supabase est√° disponible, sincronizar con la nube
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    console.log('‚òÅÔ∏è Sincronizando con Supabase...');
                    // Nota: La sincronizaci√≥n completa con Supabase requiere borrar y recrear registros
                    // Por ahora solo actualizamos localStorage
                }
                
                hideLoading();
                
                // Cerrar modal
                const modal = document.getElementById('restoreBackupModal');
                if (modal) modal.remove();
                
                alert('‚úÖ Backup restaurado exitosamente.\n\nLa p√°gina se recargar√° para aplicar los cambios.');
                
                // Recargar p√°gina
                window.location.reload();
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Error restaurando backup:', error);
                alert('‚ùå Error al restaurar: ' + error.message);
            }
        }
        
        async function checkSyncStatus() {
            const indicator = document.getElementById('syncStatusIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            indicator.style.display = 'block';
            statusText.innerHTML = '‚è≥ Verificando estado de sincronizaci√≥n...';
            
            try {
                let status = [];
                
                // Verificar Supabase
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    status.push('‚úÖ Supabase: Conectado');
                    
                    // Verificar datos de todas las tablas
                    const hotels = await window.supabaseClient.getHotels();
                    const reservations = await window.supabaseClient.getReservations();
                    const agents = await window.supabaseClient.getAgents();
                    
                    let users = [], quotes = [], expenses = [], admins = [];
                    try { users = await window.supabaseClient.getUsers() || []; } catch(e) {}
                    try { quotes = await window.supabaseClient.getQuotes() || []; } catch(e) {}
                    try { expenses = await window.supabaseClient.getExpenses() || []; } catch(e) {}
                    try { admins = await window.supabaseClient.getAdmins() || []; } catch(e) {}
                    
                    status.push(`<strong>üìä DATOS EN SUPABASE:</strong>`);
                    status.push(`&nbsp;&nbsp;üè® Hoteles: ${hotels.length}`);
                    status.push(`&nbsp;&nbsp;üìÖ Reservas: ${reservations.length}`);
                    status.push(`&nbsp;&nbsp;üë• Agentes: ${agents.length}`);
                    status.push(`&nbsp;&nbsp;üë§ Usuarios: ${users.length}`);
                    status.push(`&nbsp;&nbsp;üìã Cotizaciones: ${quotes.length}`);
                    status.push(`&nbsp;&nbsp;üí∞ Gastos: ${expenses.length}`);
                    status.push(`&nbsp;&nbsp;üîê Administradores: ${admins.length}`);
                    
                    // Verificar Realtime
                    if (window.supabaseClient.client.realtime) {
                        status.push('‚úÖ Realtime: Activo (sincronizaci√≥n en tiempo real)');
                    } else {
                        status.push('‚ö†Ô∏è Realtime: No disponible');
                    }
                } else {
                    status.push('‚ö†Ô∏è Supabase: No conectado (usando localStorage)');
                }
                
                // Verificar localStorage
                const localHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                const localReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                const localAgents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                const localUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                const localQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                const localExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                const localAdmins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                
                status.push(`<strong>üíæ DATOS LOCALES:</strong>`);
                status.push(`&nbsp;&nbsp;üè® Hoteles: ${localHotels.length}`);
                status.push(`&nbsp;&nbsp;üìÖ Reservas: ${localReservations.length}`);
                status.push(`&nbsp;&nbsp;üë• Agentes: ${localAgents.length}`);
                status.push(`&nbsp;&nbsp;üë§ Usuarios: ${localUsers.length}`);
                status.push(`&nbsp;&nbsp;üìã Cotizaciones: ${localQuotes.length}`);
                status.push(`&nbsp;&nbsp;üí∞ Gastos: ${localExpenses.length}`);
                status.push(`&nbsp;&nbsp;üîê Administradores: ${localAdmins.length}`);
                
                statusText.innerHTML = status.join('<br>');
                
            } catch (error) {
                statusText.innerHTML = '‚ùå Error verificando sincronizaci√≥n: ' + error.message;
            }
        }
        
        // Funci√≥n para sincronizar TODAS las tablas a Supabase
        async function syncAllTablesToSupabase() {
            const indicator = document.getElementById('syncStatusIndicator');
            const statusText = document.getElementById('syncStatusText');
            
            indicator.style.display = 'block';
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                statusText.innerHTML = '‚ùå Error: Supabase no est√° conectado';
                return;
            }
            
            const results = {
                hotels: { synced: 0, errors: 0 },
                reservations: { synced: 0, errors: 0 },
                agents: { synced: 0, errors: 0 },
                users: { synced: 0, errors: 0 },
                quotes: { synced: 0, errors: 0 },
                expenses: { synced: 0, errors: 0 },
                admins: { synced: 0, errors: 0 }
            };
            
            try {
                // 1. SINCRONIZAR HOTELES
                statusText.innerHTML = 'üè® Sincronizando hoteles...';
                const localHotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
                for (const hotel of localHotels) {
                    try {
                        await window.supabaseClient.upsertHotel(hotel);
                        results.hotels.synced++;
                    } catch (e) {
                        console.error('Error sync hotel:', e);
                        results.hotels.errors++;
                    }
                }
                
                // 2. SINCRONIZAR RESERVAS
                statusText.innerHTML = 'üìÖ Sincronizando reservas...';
                const localReservations = JSON.parse(localStorage.getItem('reservationsDB') || '[]');
                for (const reservation of localReservations) {
                    try {
                        await window.supabaseClient.createReservation(reservation);
                        results.reservations.synced++;
                    } catch (e) {
                        results.reservations.errors++;
                    }
                }
                
                // 3. SINCRONIZAR AGENTES
                statusText.innerHTML = 'üë• Sincronizando agentes...';
                const localAgents = JSON.parse(localStorage.getItem('agentsDB') || '[]');
                for (const agent of localAgents) {
                    try {
                        if (agent.id) {
                            await window.supabaseClient.updateAgent(agent.id, agent);
                        } else {
                            await window.supabaseClient.createAgent(agent);
                        }
                        results.agents.synced++;
                    } catch (e) {
                        results.agents.errors++;
                    }
                }
                
                // 4. SINCRONIZAR USUARIOS
                statusText.innerHTML = 'üë§ Sincronizando usuarios...';
                const localUsers = JSON.parse(localStorage.getItem('checkin24hs_users') || '[]');
                for (const user of localUsers) {
                    try {
                        if (typeof window.supabaseClient.upsertUser === 'function') {
                            await window.supabaseClient.upsertUser(user);
                        } else if (typeof window.supabaseClient.createUser === 'function') {
                            await window.supabaseClient.createUser(user);
                        }
                        results.users.synced++;
                    } catch (e) {
                        results.users.errors++;
                    }
                }
                
                // 5. SINCRONIZAR COTIZACIONES
                statusText.innerHTML = 'üìã Sincronizando cotizaciones...';
                const localQuotes = JSON.parse(localStorage.getItem('quotesDB') || '[]');
                for (const quote of localQuotes) {
                    try {
                        if (typeof window.supabaseClient.createQuote === 'function') {
                            await window.supabaseClient.createQuote(quote);
                        }
                        results.quotes.synced++;
                    } catch (e) {
                        results.quotes.errors++;
                    }
                }
                
                // 6. SINCRONIZAR GASTOS (con verificaci√≥n de duplicados)
                statusText.innerHTML = 'üí∞ Sincronizando gastos...';
                const localExpenses = JSON.parse(localStorage.getItem('expensesDB') || '[]');
                for (const expense of localExpenses) {
                    try {
                        // Verificar si el gasto ya existe antes de crearlo
                        if (typeof window.supabaseClient.expenseExists === 'function') {
                            const exists = await window.supabaseClient.expenseExists(expense);
                            if (exists) {
                                console.log('‚è≠Ô∏è Gasto ya existe, saltando:', expense.description);
                                results.expenses.synced++; // Contamos como sincronizado
                                continue;
                            }
                        }
                        if (typeof window.supabaseClient.createExpense === 'function') {
                            await window.supabaseClient.createExpense(expense);
                        }
                        results.expenses.synced++;
                    } catch (e) {
                        results.expenses.errors++;
                    }
                }
                
                // 7. SINCRONIZAR ADMINISTRADORES
                statusText.innerHTML = 'üîê Sincronizando administradores...';
                const localAdmins = JSON.parse(localStorage.getItem('dashboard_admin_users') || '[]');
                for (const admin of localAdmins) {
                    try {
                        if (typeof window.supabaseClient.createAdmin === 'function') {
                            await window.supabaseClient.createAdmin(admin);
                        }
                        results.admins.synced++;
                    } catch (e) {
                        results.admins.errors++;
                    }
                }
                
                // Mostrar resumen
                let summary = ['<strong>‚úÖ SINCRONIZACI√ìN COMPLETADA</strong>', ''];
                summary.push(`üè® Hoteles: ${results.hotels.synced} sincronizados${results.hotels.errors > 0 ? `, ${results.hotels.errors} errores` : ''}`);
                summary.push(`üìÖ Reservas: ${results.reservations.synced} sincronizadas${results.reservations.errors > 0 ? `, ${results.reservations.errors} errores` : ''}`);
                summary.push(`üë• Agentes: ${results.agents.synced} sincronizados${results.agents.errors > 0 ? `, ${results.agents.errors} errores` : ''}`);
                summary.push(`üë§ Usuarios: ${results.users.synced} sincronizados${results.users.errors > 0 ? `, ${results.users.errors} errores` : ''}`);
                summary.push(`üìã Cotizaciones: ${results.quotes.synced} sincronizadas${results.quotes.errors > 0 ? `, ${results.quotes.errors} errores` : ''}`);
                summary.push(`üí∞ Gastos: ${results.expenses.synced} sincronizados${results.expenses.errors > 0 ? `, ${results.expenses.errors} errores` : ''}`);
                summary.push(`üîê Administradores: ${results.admins.synced} sincronizados${results.admins.errors > 0 ? `, ${results.admins.errors} errores` : ''}`);
                
                statusText.innerHTML = summary.join('<br>');
                
                // Refrescar datos
                setTimeout(() => {
                    loadAdminsTable();
                }, 1000);
                
            } catch (error) {
                statusText.innerHTML = '‚ùå Error en sincronizaci√≥n: ' + error.message;
                console.error('Error sync:', error);
            }
        }

        // Mostrar/ocultar men√∫ de administradores seg√∫n el rol
        function updateAdminMenuVisibility() {
            const adminMenuLink = document.getElementById('adminMenuLink');
            if (adminMenuLink) {
                if (isAdminTotal()) {
                    adminMenuLink.style.display = 'block';
                } else {
                    adminMenuLink.style.display = 'none';
                }
            }
        }

        // Cargar administradores cuando se muestra la secci√≥n
        if (typeof window.showSection === 'function') {
            const originalShowSection = window.showSection;
            window.showSection = function(section, event) {
                originalShowSection(section, event);
                if (section === 'administrators') {
                    setTimeout(() => {
                        loadAdminsTable();
                        updateAdminMenuVisibility();
                    }, 100);
                }
            };
        }

        // Actualizar visibilidad del men√∫ al iniciar sesi√≥n
        // Esto se ejecuta despu√©s de que showDashboard se define
        setTimeout(() => {
            if (typeof updateAdminMenuVisibility === 'function') {
                // Verificar si ya hay sesi√≥n activa
                const authSession = localStorage.getItem('dashboard_auth_session');
                if (authSession) {
                    updateAdminMenuVisibility();
                }
            }
        }, 500);
    </script>
    
    <!-- Modales para Administradores -->
    <!-- Modal Nuevo/Editar Administrador -->
    <div id="adminModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h2 class="modal-title" id="adminModalTitle">Nuevo Administrador</h2>
            <form id="adminForm" onsubmit="saveAdmin(event)">
                <input type="hidden" id="adminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Usuario *</label>
                    <input type="text" id="adminUsername" class="form-input" required placeholder="Nombre de usuario">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="adminName" class="form-input" required placeholder="Nombre completo">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="adminEmail" class="form-input" required placeholder="email@ejemplo.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rol *</label>
                    <select id="adminRole" class="form-input" required>
                        <option value="admin_total">Administrador Total</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
                
                <div class="form-group" id="adminPasswordGroup">
                    <label class="form-label">Contrase√±a *</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="M√≠nimo 6 caracteres">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Dejar en blanco para mantener la contrase√±a actual (solo al editar)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <select id="adminStatus" class="form-input">
                        <option value="active">Activo</option>
                        <option value="inactive">Inactivo</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAdminModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Resetear Contrase√±a -->
    <div id="resetPasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeResetPasswordModal()">&times;</span>
            <h2 class="modal-title">Resetear Contrase√±a</h2>
            <form id="resetPasswordForm" onsubmit="resetAdminPassword(event)">
                <input type="hidden" id="resetAdminId" value="">
                
                <div class="form-group">
                    <label class="form-label">Nueva Contrase√±a *</label>
                    <input type="password" id="resetPassword" class="form-input" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirmar Contrase√±a *</label>
                    <input type="password" id="resetPasswordConfirm" class="form-input" required placeholder="Confirma la contrase√±a" minlength="6">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Resetear Contrase√±a</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== MODALES PROGRAMA FLEXI ==================== -->
    
    <!-- Modal Nuevo Programa Flexi -->
    <div id="newFlexiProgramModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">add_circle</span>
                    Nuevo Programa Flexi
                </h2>
                <button onclick="closeNewFlexiProgramModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="newFlexiProgramForm" onsubmit="saveFlexiProgram(event)" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hotel *</label>
                    <select id="flexiProgramHotel" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="">Seleccionar hotel...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Cupos por Voucher *</label>
                        <input type="number" id="flexiProgramCupos" min="1" required placeholder="Ej: 8" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <small style="color: #666; font-size: 12px;">Noches √ó Personas (ej: 4 noches √ó 2 personas = 8 cupos)</small>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Precio USD *</label>
                        <input type="number" id="flexiProgramPrecio" min="0" step="0.01" required placeholder="Ej: 1500" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Inicio Periodo de Uso *</label>
                        <input type="date" id="flexiProgramFechaInicio" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fin Periodo de Uso *</label>
                        <input type="date" id="flexiProgramFechaFin" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Descripci√≥n</label>
                    <textarea id="flexiProgramDescripcion" rows="3" placeholder="Descripci√≥n del programa (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeNewFlexiProgramModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #9c27b0; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                        Guardar Programa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Emitir Voucher -->
    <div id="emitVoucherModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">card_giftcard</span>
                    Emitir Voucher Flexi
                </h2>
                <button onclick="closeEmitVoucherModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="emitVoucherForm" onsubmit="saveFlexiVoucher(event)" style="padding: 24px;">
                <div class="form-section" style="margin-bottom: 20px;">
                    <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">person</span>
                        Informaci√≥n del Cliente
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre Completo *</label>
                            <input type="text" id="voucherClienteNombre" required placeholder="Nombre del cliente" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email *</label>
                            <input type="email" id="voucherClienteEmail" required placeholder="email@ejemplo.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tel√©fono *</label>
                        <input type="tel" id="voucherClienteTelefono" required placeholder="+56 9 1234 5678" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 style="color: #4caf50; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">confirmation_number</span>
                        Informaci√≥n del Voucher
                    </h3>
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Programa Flexi *</label>
                        <select id="voucherPrograma" required onchange="onProgramaChange()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="">Seleccionar programa...</option>
                        </select>
                    </div>
                    <div id="voucherProgramaInfo" style="display: none; background: #e8f5e9; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div>
                                <strong style="color: #2e7d32;">Hotel</strong>
                                <p id="voucherInfoHotel" style="margin: 4px 0 0 0;">-</p>
                            </div>
                            <div>
                                <strong style="color: #2e7d32;">Cupos</strong>
                                <p id="voucherInfoCupos" style="margin: 4px 0 0 0;">-</p>
                            </div>
                            <div>
                                <strong style="color: #2e7d32;">Periodo</strong>
                                <p id="voucherInfoPeriodo" style="margin: 4px 0 0 0;">-</p>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">C√≥digo de Voucher</label>
                            <input type="text" id="voucherCodigo" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f5f5f5; font-weight: bold; letter-spacing: 1px;">
                            <small style="color: #666; font-size: 12px;">Se genera autom√°ticamente</small>
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha de Venta *</label>
                            <input type="date" id="voucherFechaVenta" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Notas</label>
                        <textarea id="voucherNotas" rows="2" placeholder="Notas adicionales (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeEmitVoucherModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" class="form-button" style="background: #4caf50; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        Emitir Voucher
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Canje -->
    <div id="registerCanjeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 650px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">swap_horiz</span>
                    Registrar Canje de Cupos
                </h2>
                <button onclick="closeRegisterCanjeModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <form id="registerCanjeForm" onsubmit="saveFlexiCanje(event)" style="padding: 24px;">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">C√≥digo de Voucher *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="canjeVoucherCodigo" required placeholder="Ej: FLEXI-LLAO-2024-001" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; text-transform: uppercase;">
                        <button type="button" onclick="buscarVoucherParaCanje()" class="form-button" style="background: #ff9800; color: white;">
                            <span class="material-icons">search</span>
                        </button>
                    </div>
                </div>
                
                <div id="canjeVoucherInfo" style="display: none; background: #fff3e0; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; color: #e65100;">üìã Informaci√≥n del Voucher</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div>
                            <strong>Cliente:</strong>
                            <span id="canjeInfoCliente">-</span>
                        </div>
                        <div>
                            <strong>Hotel:</strong>
                            <span id="canjeInfoHotel">-</span>
                        </div>
                        <div>
                            <strong>Cupos Disponibles:</strong>
                            <span id="canjeInfoCuposDisponibles" style="font-weight: bold; color: #4caf50;">-</span>
                        </div>
                        <div>
                            <strong>Periodo de Uso:</strong>
                            <span id="canjeInfoPeriodo">-</span>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="margin-bottom: 20px;">
                    <h3 style="color: #ff9800; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons">event</span>
                        Datos del Canje (Reserva)
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Check-in *</label>
                            <input type="date" id="canjeCheckIn" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fecha Check-out *</label>
                            <input type="date" id="canjeCheckOut" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">N√∫mero de Personas *</label>
                            <input type="number" id="canjePersonas" min="1" required placeholder="Ej: 2" onchange="calcularCuposCanje()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Cupos a Usar</label>
                            <input type="number" id="canjeCuposUsar" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #fff3e0; font-weight: bold; color: #e65100;">
                            <small style="color: #666; font-size: 12px;">Noches √ó Personas = Cupos</small>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Notas del Canje</label>
                        <textarea id="canjeNotas" rows="2" placeholder="Observaciones adicionales (opcional)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>

                <div id="canjeWarning" style="display: none; background: #ffebee; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f44336;">
                    <span class="material-icons" style="vertical-align: middle; color: #f44336; margin-right: 8px;">warning</span>
                    <span id="canjeWarningText" style="color: #c62828;"></span>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeRegisterCanjeModal()" class="form-button secondary">Cancelar</button>
                    <button type="submit" id="btnRegistrarCanje" class="form-button" style="background: #ff9800; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">check_circle</span>
                        Registrar Canje
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalles Voucher -->
    <div id="voucherDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">visibility</span>
                    Detalles del Voucher
                </h2>
                <button onclick="closeVoucherDetailModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <div id="voucherDetailContent" style="padding: 24px;">
                <!-- Contenido se carga din√°micamente -->
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #e0e0e0;">
                <button type="button" onclick="closeVoucherDetailModal()" class="form-button secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Anular Canje -->
    <div id="anularCanjeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons">undo</span>
                    Anular Canje
                </h2>
                <button onclick="closeAnularCanjeModal()" class="close-btn" style="color: white; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 24px;">
                <input type="hidden" id="anularCanjeId">
                <div style="background: #ffebee; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; color: #c62828;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">warning</span>
                        <strong>¬øEst√°s seguro de anular este canje?</strong>
                    </p>
                    <p style="margin: 12px 0 0 0; color: #666;" id="anularCanjeInfo"></p>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Motivo de Anulaci√≥n *</label>
                    <select id="anularCanjeMotivo" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="">Seleccionar motivo...</option>
                        <option value="cancelacion_cliente">Cancelaci√≥n solicitada por cliente (>7 d√≠as)</option>
                        <option value="cambio_fechas">Cambio de fechas (permitido 1 vez)</option>
                        <option value="error_registro">Error en registro</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="anularCanjeReintegrar" checked style="width: 18px; height: 18px;">
                        <span>Reintegrar cupos al voucher</span>
                    </label>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                        Si se anula con menos de 7 d√≠as de antelaci√≥n, los cupos se pierden seg√∫n pol√≠tica.
                    </small>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" onclick="closeAnularCanjeModal()" class="form-button secondary">Cancelar</button>
                    <button type="button" onclick="confirmarAnularCanje()" class="form-button" style="background: #f44336; color: white;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">delete</span>
                        Confirmar Anulaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FIN MODALES PROGRAMA FLEXI ==================== -->

    <!-- ==================== SCRIPT PROGRAMA FLEXI ==================== -->
    <script>
    // =====================================================
    // PROGRAMA FLEXI - Sistema de Gesti√≥n de Vouchers
    // =====================================================

    // Almacenamiento de datos
    let flexiPrograms = [];
    let flexiVouchers = [];
    let flexiCanjes = [];
    let currentVoucherForCanje = null;

    // =====================================================
    // INICIALIZACI√ìN Y CARGA DE DATOS
    // =====================================================

    function initFlexiData() {
        console.log('üé´ Inicializando Programa Flexi...');
        loadFlexiDataFromStorage();
        updateFlexiStats();
        renderFlexiProgramsTable();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        checkExpiredVouchers();
    }

    function loadFlexiDataFromStorage() {
        try {
            const storedPrograms = localStorage.getItem('flexi_programs');
            const storedVouchers = localStorage.getItem('flexi_vouchers');
            const storedCanjes = localStorage.getItem('flexi_canjes');
            
            flexiPrograms = storedPrograms ? JSON.parse(storedPrograms) : [];
            flexiVouchers = storedVouchers ? JSON.parse(storedVouchers) : [];
            flexiCanjes = storedCanjes ? JSON.parse(storedCanjes) : [];
            
            console.log(`‚úÖ Datos Flexi cargados: ${flexiPrograms.length} programas, ${flexiVouchers.length} vouchers, ${flexiCanjes.length} canjes`);
        } catch (error) {
            console.error('‚ùå Error cargando datos Flexi:', error);
            flexiPrograms = [];
            flexiVouchers = [];
            flexiCanjes = [];
        }
    }

    function saveFlexiDataToStorage() {
        try {
            localStorage.setItem('flexi_programs', JSON.stringify(flexiPrograms));
            localStorage.setItem('flexi_vouchers', JSON.stringify(flexiVouchers));
            localStorage.setItem('flexi_canjes', JSON.stringify(flexiCanjes));
            console.log('üíæ Datos Flexi guardados');
        } catch (error) {
            console.error('‚ùå Error guardando datos Flexi:', error);
        }
    }

    function refreshFlexiData() {
        loadFlexiDataFromStorage();
        updateFlexiStats();
        renderFlexiProgramsTable();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        checkExpiredVouchers();
        showNotification('‚úÖ Datos actualizados correctamente', 'success');
    }

    // =====================================================
    // ESTAD√çSTICAS
    // =====================================================

    function updateFlexiStats() {
        const today = new Date().toISOString().split('T')[0];
        
        // Contar vouchers por estado
        let active = 0, partial = 0, used = 0, expired = 0;
        let totalCuposDisponibles = 0;
        
        flexiVouchers.forEach(v => {
            if (v.estado === 'Vencido' || v.fechaFinUso < today) {
                expired++;
            } else if (v.cuposDisponibles === 0) {
                used++;
            } else if (v.cuposDisponibles < v.cuposIniciales) {
                partial++;
                totalCuposDisponibles += v.cuposDisponibles;
            } else {
                active++;
                totalCuposDisponibles += v.cuposDisponibles;
            }
        });
        
        document.getElementById('totalFlexiVouchers').textContent = flexiVouchers.length;
        document.getElementById('activeFlexiVouchers').textContent = active;
        document.getElementById('partialFlexiVouchers').textContent = partial;
        document.getElementById('usedFlexiVouchers').textContent = used;
        document.getElementById('expiredFlexiVouchers').textContent = expired;
        document.getElementById('totalCuposDisponibles').textContent = totalCuposDisponibles;
    }

    // =====================================================
    // VERIFICACI√ìN DE VENCIMIENTO (RF-ADM-008)
    // =====================================================

    function checkExpiredVouchers() {
        const today = new Date().toISOString().split('T')[0];
        let updated = false;
        
        flexiVouchers.forEach(voucher => {
            if (voucher.estado !== 'Vencido' && voucher.fechaFinUso < today) {
                voucher.estado = 'Vencido';
                updated = true;
                console.log(`‚è∞ Voucher ${voucher.codigo} marcado como vencido`);
            }
        });
        
        if (updated) {
            saveFlexiDataToStorage();
            updateFlexiStats();
            renderFlexiVouchersTable();
        }
    }

    // =====================================================
    // PROGRAMAS FLEXI (RF-ADM-001)
    // =====================================================

    window.openNewFlexiProgramModal = function() {
        const form = document.getElementById('newFlexiProgramForm');
        const modal = document.getElementById('newFlexiProgramModal');
        if (form) form.reset();
        if (typeof loadHotelsForFlexiProgram === 'function') {
            loadHotelsForFlexiProgram();
        }
        if (modal) modal.style.display = 'flex';
    };

    window.closeNewFlexiProgramModal = function() {
        const modal = document.getElementById('newFlexiProgramModal');
        if (modal) modal.style.display = 'none';
    }

    function loadHotelsForFlexiProgram() {
        const select = document.getElementById('flexiProgramHotel');
        select.innerHTML = '<option value="">Seleccionar hotel...</option>';
        
        // Cargar hoteles desde el almacenamiento
        const hoteles = JSON.parse(localStorage.getItem('hotels') || '[]');
        hoteles.forEach(hotel => {
            if (hotel.status === 'active' || hotel.estado === 'Activo') {
                const option = document.createElement('option');
                option.value = hotel.id || hotel.nombre;
                option.textContent = hotel.nombre || hotel.name;
                select.appendChild(option);
            }
        });
    }

    function saveFlexiProgram(event) {
        event.preventDefault();
        
        const hotelSelect = document.getElementById('flexiProgramHotel');
        const hotelId = hotelSelect.value;
        const hotelName = hotelSelect.options[hotelSelect.selectedIndex].text;
        
        const program = {
            id: 'PROG-' + Date.now(),
            hotelId: hotelId,
            hotelName: hotelName,
            cuposPorVoucher: parseInt(document.getElementById('flexiProgramCupos').value),
            precioUSD: parseFloat(document.getElementById('flexiProgramPrecio').value),
            fechaInicio: document.getElementById('flexiProgramFechaInicio').value,
            fechaFin: document.getElementById('flexiProgramFechaFin').value,
            descripcion: document.getElementById('flexiProgramDescripcion').value,
            estado: 'Activo',
            fechaCreacion: new Date().toISOString()
        };
        
        flexiPrograms.push(program);
        saveFlexiDataToStorage();
        renderFlexiProgramsTable();
        closeNewFlexiProgramModal();
        showNotification('‚úÖ Programa Flexi creado exitosamente', 'success');
    }

    function renderFlexiProgramsTable() {
        const tbody = document.getElementById('flexiProgramsTableBody');
        if (!tbody) return;
        
        if (flexiPrograms.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">inventory_2</span>
                        <p style="margin-top: 16px;">No hay programas Flexi configurados</p>
                        <button onclick="openNewFlexiProgramModal()" class="form-button" style="background: #9c27b0; color: white; margin-top: 12px;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                            Crear Primer Programa
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiPrograms.map(program => {
            const estadoBadge = program.estado === 'Activo' 
                ? '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Activo</span>'
                : '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Inactivo</span>';
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; font-weight: 500;">${program.hotelName}</td>
                    <td style="padding: 12px; text-align: center;">${program.cuposPorVoucher} cupos</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #4caf50;">$${program.precioUSD.toLocaleString()}</td>
                    <td style="padding: 12px; text-align: center;">${formatDateRange(program.fechaInicio, program.fechaFin)}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editFlexiProgram('${program.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;">
                            <span class="material-icons" style="font-size: 16px;">edit</span>
                        </button>
                        <button onclick="deleteFlexiProgram('${program.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #f44336; color: white;">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function editFlexiProgram(programId) {
        // TODO: Implementar edici√≥n de programa
        showNotification('‚ö†Ô∏è Funci√≥n de edici√≥n en desarrollo', 'warning');
    }

    function deleteFlexiProgram(programId) {
        if (confirm('¬øEst√°s seguro de eliminar este programa? Esta acci√≥n no se puede deshacer.')) {
            flexiPrograms = flexiPrograms.filter(p => p.id !== programId);
            saveFlexiDataToStorage();
            renderFlexiProgramsTable();
            showNotification('‚úÖ Programa eliminado', 'success');
        }
    }

    // =====================================================
    // EMISI√ìN DE VOUCHERS (RF-ADM-002/003)
    // =====================================================

    window.openEmitVoucherModal = function() {
        const form = document.getElementById('emitVoucherForm');
        const info = document.getElementById('voucherProgramaInfo');
        if (form) form.reset();
        if (info) info.style.display = 'none';
        if (typeof loadProgramsForVoucher === 'function') {
            loadProgramsForVoucher();
        }
        if (typeof generateVoucherCode === 'function') {
            generateVoucherCode();
        }
        const fechaVenta = document.getElementById('voucherFechaVenta');
        if (fechaVenta) fechaVenta.value = new Date().toISOString().split('T')[0];
        const modal = document.getElementById('emitVoucherModal');
        if (modal) modal.style.display = 'flex';
    };

    window.closeEmitVoucherModal = function() {
        const modal = document.getElementById('emitVoucherModal');
        if (modal) modal.style.display = 'none';
    };
    }

    function loadProgramsForVoucher() {
        const select = document.getElementById('voucherPrograma');
        select.innerHTML = '<option value="">Seleccionar programa...</option>';
        
        flexiPrograms.filter(p => p.estado === 'Activo').forEach(program => {
            const option = document.createElement('option');
            option.value = program.id;
            option.textContent = `${program.hotelName} - ${program.cuposPorVoucher} cupos - $${program.precioUSD}`;
            option.dataset.program = JSON.stringify(program);
            select.appendChild(option);
        });
    }

    function onProgramaChange() {
        const select = document.getElementById('voucherPrograma');
        const infoDiv = document.getElementById('voucherProgramaInfo');
        
        if (select.value && select.selectedOptions[0].dataset.program) {
            const program = JSON.parse(select.selectedOptions[0].dataset.program);
            document.getElementById('voucherInfoHotel').textContent = program.hotelName;
            document.getElementById('voucherInfoCupos').textContent = program.cuposPorVoucher + ' cupos';
            document.getElementById('voucherInfoPeriodo').textContent = formatDateRange(program.fechaInicio, program.fechaFin);
            infoDiv.style.display = 'block';
            
            // Regenerar c√≥digo con prefijo del hotel
            const hotelPrefix = program.hotelName.substring(0, 4).toUpperCase().replace(/\s/g, '');
            const year = new Date().getFullYear();
            const sequence = String(flexiVouchers.filter(v => v.hotelName === program.hotelName).length + 1).padStart(3, '0');
            document.getElementById('voucherCodigo').value = `FLEXI-${hotelPrefix}-${year}-${sequence}`;
        } else {
            infoDiv.style.display = 'none';
        }
    }

    function generateVoucherCode() {
        const timestamp = Date.now().toString(36).toUpperCase();
        document.getElementById('voucherCodigo').value = `FLEXI-${timestamp}`;
    }

    function saveFlexiVoucher(event) {
        event.preventDefault();
        
        const select = document.getElementById('voucherPrograma');
        if (!select.value) {
            showNotification('‚ö†Ô∏è Debes seleccionar un programa', 'warning');
            return;
        }
        
        const program = JSON.parse(select.selectedOptions[0].dataset.program);
        
        const voucher = {
            id: 'VCH-' + Date.now(),
            codigo: document.getElementById('voucherCodigo').value,
            programaId: program.id,
            hotelId: program.hotelId,
            hotelName: program.hotelName,
            clienteNombre: document.getElementById('voucherClienteNombre').value,
            clienteEmail: document.getElementById('voucherClienteEmail').value,
            clienteTelefono: document.getElementById('voucherClienteTelefono').value,
            cuposIniciales: program.cuposPorVoucher,
            cuposDisponibles: program.cuposPorVoucher,
            precioUSD: program.precioUSD,
            fechaVenta: document.getElementById('voucherFechaVenta').value,
            fechaInicioUso: program.fechaInicio,
            fechaFinUso: program.fechaFin,
            estado: 'Activo',
            notas: document.getElementById('voucherNotas').value,
            fechaCreacion: new Date().toISOString()
        };
        
        flexiVouchers.push(voucher);
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        closeEmitVoucherModal();
        showNotification(`‚úÖ Voucher ${voucher.codigo} emitido exitosamente`, 'success');
    }

    function renderFlexiVouchersTable() {
        const tbody = document.getElementById('flexiVouchersTableBody');
        if (!tbody) return;
        
        if (flexiVouchers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">card_giftcard</span>
                        <p style="margin-top: 16px;">No hay vouchers emitidos</p>
                        <button onclick="openEmitVoucherModal()" class="form-button" style="background: #4caf50; color: white; margin-top: 12px;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">add</span>
                            Emitir Primer Voucher
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiVouchers.map(voucher => {
            const estadoBadge = getEstadoBadge(voucher);
            const cuposDisplay = `<span style="font-weight: bold; color: ${voucher.cuposDisponibles > 0 ? '#4caf50' : '#f44336'};">${voucher.cuposDisponibles}</span>/${voucher.cuposIniciales}`;
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px; font-family: monospace; font-weight: bold; color: #9c27b0;">${voucher.codigo}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${voucher.clienteNombre}</div>
                        <div style="font-size: 12px; color: #666;">${voucher.clienteEmail}</div>
                    </td>
                    <td style="padding: 12px;">${voucher.hotelName}</td>
                    <td style="padding: 12px; text-align: center;">${cuposDisplay}</td>
                    <td style="padding: 12px; text-align: center; font-size: 12px;">${formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso)}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewVoucherDetail('${voucher.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;" title="Ver detalles">
                            <span class="material-icons" style="font-size: 16px;">visibility</span>
                        </button>
                        ${voucher.cuposDisponibles > 0 && voucher.estado !== 'Vencido' ? `
                        <button onclick="quickCanje('${voucher.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #ff9800; color: white;" title="Registrar canje">
                            <span class="material-icons" style="font-size: 16px;">swap_horiz</span>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getEstadoBadge(voucher) {
        const today = new Date().toISOString().split('T')[0];
        
        if (voucher.estado === 'Vencido' || voucher.fechaFinUso < today) {
            return '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Vencido</span>';
        } else if (voucher.cuposDisponibles === 0) {
            return '<span style="background: #e3f2fd; color: #1565c0; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Usado</span>';
        } else if (voucher.cuposDisponibles < voucher.cuposIniciales) {
            return '<span style="background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Parcial</span>';
        }
        return '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Activo</span>';
    }

    function filterFlexiVouchers(searchTerm) {
        const tbody = document.getElementById('flexiVouchersTableBody');
        const rows = tbody.querySelectorAll('tr');
        const term = searchTerm.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    }

    // =====================================================
    // CANJE DE CUPOS (RF-ADM-004, RF-ADM-005)
    // =====================================================

    function openRegisterCanjeModal() {
        document.getElementById('registerCanjeForm').reset();
        document.getElementById('canjeVoucherInfo').style.display = 'none';
        document.getElementById('canjeWarning').style.display = 'none';
        currentVoucherForCanje = null;
        document.getElementById('registerCanjeModal').style.display = 'flex';
    }

    window.closeRegisterCanjeModal = function() {
        const modal = document.getElementById('registerCanjeModal');
        if (modal) modal.style.display = 'none';
    };
        currentVoucherForCanje = null;
    }

    function quickCanje(voucherId) {
        const voucher = flexiVouchers.find(v => v.id === voucherId);
        if (voucher) {
            openRegisterCanjeModal();
            document.getElementById('canjeVoucherCodigo').value = voucher.codigo;
            buscarVoucherParaCanje();
        }
    }

    function buscarVoucherParaCanje() {
        const codigo = document.getElementById('canjeVoucherCodigo').value.toUpperCase().trim();
        const voucher = flexiVouchers.find(v => v.codigo.toUpperCase() === codigo);
        const infoDiv = document.getElementById('canjeVoucherInfo');
        const warningDiv = document.getElementById('canjeWarning');
        
        if (!voucher) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Voucher no encontrado. Verifica el c√≥digo.';
            currentVoucherForCanje = null;
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        // Verificar estado
        if (voucher.estado === 'Vencido' || voucher.fechaFinUso < today) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Este voucher est√° vencido y no puede ser canjeado.';
            currentVoucherForCanje = null;
            return;
        }
        
        if (voucher.cuposDisponibles <= 0) {
            infoDiv.style.display = 'none';
            warningDiv.style.display = 'block';
            document.getElementById('canjeWarningText').textContent = 'Este voucher no tiene cupos disponibles.';
            currentVoucherForCanje = null;
            return;
        }
        
        // Mostrar informaci√≥n del voucher
        currentVoucherForCanje = voucher;
        document.getElementById('canjeInfoCliente').textContent = voucher.clienteNombre;
        document.getElementById('canjeInfoHotel').textContent = voucher.hotelName;
        document.getElementById('canjeInfoCuposDisponibles').textContent = voucher.cuposDisponibles + ' cupos';
        document.getElementById('canjeInfoPeriodo').textContent = formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso);
        
        // Establecer fechas m√≠nimas y m√°ximas
        document.getElementById('canjeCheckIn').min = voucher.fechaInicioUso;
        document.getElementById('canjeCheckIn').max = voucher.fechaFinUso;
        document.getElementById('canjeCheckOut').min = voucher.fechaInicioUso;
        document.getElementById('canjeCheckOut').max = voucher.fechaFinUso;
        
        infoDiv.style.display = 'block';
        warningDiv.style.display = 'none';
    }

    function calcularCuposCanje() {
        const checkIn = document.getElementById('canjeCheckIn').value;
        const checkOut = document.getElementById('canjeCheckOut').value;
        const personas = parseInt(document.getElementById('canjePersonas').value) || 0;
        
        if (checkIn && checkOut && personas > 0) {
            const noches = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
            const cupos = noches * personas;
            document.getElementById('canjeCuposUsar').value = cupos;
            
            // Validar contra cupos disponibles
            const warningDiv = document.getElementById('canjeWarning');
            if (currentVoucherForCanje && cupos > currentVoucherForCanje.cuposDisponibles) {
                warningDiv.style.display = 'block';
                document.getElementById('canjeWarningText').textContent = `Los cupos necesarios (${cupos}) exceden los disponibles (${currentVoucherForCanje.cuposDisponibles}).`;
            } else if (noches <= 0) {
                warningDiv.style.display = 'block';
                document.getElementById('canjeWarningText').textContent = 'La fecha de check-out debe ser posterior a la de check-in.';
            } else {
                warningDiv.style.display = 'none';
            }
        }
    }

    // Calcular cupos cuando cambian las fechas
    document.addEventListener('DOMContentLoaded', function() {
        const checkInInput = document.getElementById('canjeCheckIn');
        const checkOutInput = document.getElementById('canjeCheckOut');
        
        if (checkInInput) checkInInput.addEventListener('change', calcularCuposCanje);
        if (checkOutInput) checkOutInput.addEventListener('change', calcularCuposCanje);
    });

    function saveFlexiCanje(event) {
        event.preventDefault();
        
        if (!currentVoucherForCanje) {
            showNotification('‚ö†Ô∏è Debes buscar y seleccionar un voucher v√°lido', 'warning');
            return;
        }
        
        const cuposUsar = parseInt(document.getElementById('canjeCuposUsar').value);
        
        if (cuposUsar > currentVoucherForCanje.cuposDisponibles) {
            showNotification('‚ö†Ô∏è Los cupos necesarios exceden los disponibles', 'error');
            return;
        }
        
        const checkIn = document.getElementById('canjeCheckIn').value;
        const checkOut = document.getElementById('canjeCheckOut').value;
        
        // Validar fechas dentro del periodo de uso
        if (checkIn < currentVoucherForCanje.fechaInicioUso || checkOut > currentVoucherForCanje.fechaFinUso) {
            showNotification('‚ö†Ô∏è Las fechas deben estar dentro del periodo de uso del voucher', 'error');
            return;
        }
        
        const canje = {
            id: 'CANJE-' + Date.now(),
            voucherId: currentVoucherForCanje.id,
            voucherCodigo: currentVoucherForCanje.codigo,
            clienteNombre: currentVoucherForCanje.clienteNombre,
            hotelName: currentVoucherForCanje.hotelName,
            checkIn: checkIn,
            checkOut: checkOut,
            personas: parseInt(document.getElementById('canjePersonas').value),
            cuposUsados: cuposUsar,
            notas: document.getElementById('canjeNotas').value,
            estado: 'Confirmado',
            fechaRegistro: new Date().toISOString()
        };
        
        // Actualizar cupos disponibles del voucher (RF-ADM-005)
        const voucherIndex = flexiVouchers.findIndex(v => v.id === currentVoucherForCanje.id);
        if (voucherIndex !== -1) {
            flexiVouchers[voucherIndex].cuposDisponibles -= cuposUsar;
            
            // Actualizar estado del voucher
            if (flexiVouchers[voucherIndex].cuposDisponibles === 0) {
                flexiVouchers[voucherIndex].estado = 'Usado';
            } else {
                flexiVouchers[voucherIndex].estado = 'Parcial';
            }
        }
        
        flexiCanjes.push(canje);
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        closeRegisterCanjeModal();
        showNotification(`‚úÖ Canje registrado: ${cuposUsar} cupos usados`, 'success');
    }

    function renderFlexiCanjesTable() {
        const tbody = document.getElementById('flexiCanjesTableBody');
        if (!tbody) return;
        
        if (flexiCanjes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #e0e0e0;">history</span>
                        <p style="margin-top: 16px;">No hay canjes registrados</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = flexiCanjes.map(canje => {
            const estadoBadge = canje.estado === 'Confirmado'
                ? '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Confirmado</span>'
                : canje.estado === 'Anulado'
                ? '<span style="background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 20px; font-size: 12px;">Anulado</span>'
                : '<span style="background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 20px; font-size: 12px;">No-Show</span>';
            
            return `
                <tr style="border-bottom: 1px solid #e0e0e0; ${canje.estado === 'Anulado' ? 'opacity: 0.6;' : ''}">
                    <td style="padding: 12px; font-family: monospace; color: #9c27b0;">${canje.voucherCodigo}</td>
                    <td style="padding: 12px;">${canje.clienteNombre}</td>
                    <td style="padding: 12px; text-align: center;">${formatDateRange(canje.checkIn, canje.checkOut)}</td>
                    <td style="padding: 12px; text-align: center;">${canje.personas}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #ff9800;">${canje.cuposUsados}</td>
                    <td style="padding: 12px; text-align: center;">${estadoBadge}</td>
                    <td style="padding: 12px; text-align: center;">
                        ${canje.estado === 'Confirmado' ? `
                        <button onclick="openAnularCanjeModal('${canje.id}')" class="form-button" style="padding: 6px 12px; font-size: 12px; background: #f44336; color: white;" title="Anular canje">
                            <span class="material-icons" style="font-size: 16px;">undo</span>
                        </button>
                        <button onclick="marcarNoShow('${canje.id}')" class="form-button secondary" style="padding: 6px 12px; font-size: 12px;" title="Marcar No-Show">
                            <span class="material-icons" style="font-size: 16px;">person_off</span>
                        </button>
                        ` : '-'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // =====================================================
    // ANULACI√ìN DE CANJES (RF-ADM-006)
    // =====================================================

    function openAnularCanjeModal(canjeId) {
        const canje = flexiCanjes.find(c => c.id === canjeId);
        if (!canje) return;
        
        document.getElementById('anularCanjeId').value = canjeId;
        document.getElementById('anularCanjeInfo').textContent = 
            `Voucher: ${canje.voucherCodigo} | Fechas: ${formatDateRange(canje.checkIn, canje.checkOut)} | Cupos: ${canje.cuposUsados}`;
        document.getElementById('anularCanjeMotivo').value = '';
        document.getElementById('anularCanjeReintegrar').checked = true;
        document.getElementById('anularCanjeModal').style.display = 'flex';
    }

    function closeAnularCanjeModal() {
        document.getElementById('anularCanjeModal').style.display = 'none';
    }

    function confirmarAnularCanje() {
        const canjeId = document.getElementById('anularCanjeId').value;
        const motivo = document.getElementById('anularCanjeMotivo').value;
        const reintegrar = document.getElementById('anularCanjeReintegrar').checked;
        
        if (!motivo) {
            showNotification('‚ö†Ô∏è Debes seleccionar un motivo de anulaci√≥n', 'warning');
            return;
        }
        
        const canjeIndex = flexiCanjes.findIndex(c => c.id === canjeId);
        if (canjeIndex === -1) return;
        
        const canje = flexiCanjes[canjeIndex];
        
        // Anular el canje
        flexiCanjes[canjeIndex].estado = 'Anulado';
        flexiCanjes[canjeIndex].motivoAnulacion = motivo;
        flexiCanjes[canjeIndex].fechaAnulacion = new Date().toISOString();
        
        // Reintegrar cupos si corresponde
        if (reintegrar) {
            const voucherIndex = flexiVouchers.findIndex(v => v.id === canje.voucherId);
            if (voucherIndex !== -1) {
                flexiVouchers[voucherIndex].cuposDisponibles += canje.cuposUsados;
                
                // Actualizar estado del voucher
                if (flexiVouchers[voucherIndex].cuposDisponibles === flexiVouchers[voucherIndex].cuposIniciales) {
                    flexiVouchers[voucherIndex].estado = 'Activo';
                } else {
                    flexiVouchers[voucherIndex].estado = 'Parcial';
                }
            }
        }
        
        saveFlexiDataToStorage();
        updateFlexiStats();
        renderFlexiVouchersTable();
        renderFlexiCanjesTable();
        closeAnularCanjeModal();
        
        const msg = reintegrar 
            ? `‚úÖ Canje anulado y ${canje.cuposUsados} cupos reintegrados`
            : `‚úÖ Canje anulado (cupos no reintegrados)`;
        showNotification(msg, 'success');
    }

    function marcarNoShow(canjeId) {
        if (!confirm('¬øMarcar este canje como No-Show? Los cupos NO se reintegrar√°n seg√∫n la pol√≠tica.')) {
            return;
        }
        
        const canjeIndex = flexiCanjes.findIndex(c => c.id === canjeId);
        if (canjeIndex === -1) return;
        
        flexiCanjes[canjeIndex].estado = 'No-Show';
        flexiCanjes[canjeIndex].fechaNoShow = new Date().toISOString();
        
        saveFlexiDataToStorage();
        renderFlexiCanjesTable();
        showNotification('‚ö†Ô∏è Canje marcado como No-Show. Los cupos se perdieron.', 'warning');
    }

    // =====================================================
    // VER DETALLES DEL VOUCHER
    // =====================================================

    function viewVoucherDetail(voucherId) {
        const voucher = flexiVouchers.find(v => v.id === voucherId);
        if (!voucher) return;
        
        const canjesDelVoucher = flexiCanjes.filter(c => c.voucherId === voucherId);
        
        const content = document.getElementById('voucherDetailContent');
        content.innerHTML = `
            <div style="display: grid; gap: 20px;">
                <!-- Informaci√≥n del Voucher -->
                <div style="background: #f3e5f5; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #7b1fa2;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">card_giftcard</span>
                        ${voucher.codigo}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div><strong>Hotel:</strong> ${voucher.hotelName}</div>
                        <div><strong>Estado:</strong> ${getEstadoBadge(voucher)}</div>
                        <div><strong>Cupos:</strong> <span style="font-weight: bold; color: ${voucher.cuposDisponibles > 0 ? '#4caf50' : '#f44336'};">${voucher.cuposDisponibles}/${voucher.cuposIniciales}</span></div>
                        <div><strong>Precio:</strong> $${voucher.precioUSD.toLocaleString()} USD</div>
                        <div><strong>Periodo de Uso:</strong> ${formatDateRange(voucher.fechaInicioUso, voucher.fechaFinUso)}</div>
                        <div><strong>Fecha de Venta:</strong> ${formatDate(voucher.fechaVenta)}</div>
                    </div>
                </div>
                
                <!-- Informaci√≥n del Cliente -->
                <div style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #2e7d32;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">person</span>
                        Cliente
                    </h3>
                    <div style="display: grid; gap: 8px;">
                        <div><strong>Nombre:</strong> ${voucher.clienteNombre}</div>
                        <div><strong>Email:</strong> ${voucher.clienteEmail}</div>
                        <div><strong>Tel√©fono:</strong> ${voucher.clienteTelefono}</div>
                    </div>
                </div>
                
                <!-- Historial de Canjes -->
                <div style="background: #fff3e0; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 16px 0; color: #e65100;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">history</span>
                        Historial de Canjes (${canjesDelVoucher.length})
                    </h3>
                    ${canjesDelVoucher.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ffcc80;">
                                    <th style="padding: 8px; text-align: left;">Fechas</th>
                                    <th style="padding: 8px; text-align: center;">Personas</th>
                                    <th style="padding: 8px; text-align: center;">Cupos</th>
                                    <th style="padding: 8px; text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${canjesDelVoucher.map(c => `
                                    <tr style="border-bottom: 1px solid #ffe0b2;">
                                        <td style="padding: 8px;">${formatDateRange(c.checkIn, c.checkOut)}</td>
                                        <td style="padding: 8px; text-align: center;">${c.personas}</td>
                                        <td style="padding: 8px; text-align: center;">${c.cuposUsados}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            ${c.estado === 'Confirmado' ? '‚úÖ' : c.estado === 'Anulado' ? '‚ùå' : 'üö´'}
                                            ${c.estado}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #666; margin: 0;">No hay canjes registrados para este voucher.</p>'}
                </div>
                
                ${voucher.notas ? `
                <div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
                    <strong>Notas:</strong> ${voucher.notas}
                </div>
                ` : ''}
            </div>
        `;
        
        document.getElementById('voucherDetailModal').style.display = 'flex';
    }

    function closeVoucherDetailModal() {
        document.getElementById('voucherDetailModal').style.display = 'none';
    }

    // =====================================================
    // EXPORTAR DATOS
    // =====================================================

    function exportFlexiVouchers() {
        if (flexiVouchers.length === 0) {
            showNotification('‚ö†Ô∏è No hay vouchers para exportar', 'warning');
            return;
        }
        
        const data = flexiVouchers.map(v => ({
            'C√≥digo': v.codigo,
            'Hotel': v.hotelName,
            'Cliente': v.clienteNombre,
            'Email': v.clienteEmail,
            'Tel√©fono': v.clienteTelefono,
            'Cupos Iniciales': v.cuposIniciales,
            'Cupos Disponibles': v.cuposDisponibles,
            'Precio USD': v.precioUSD,
            'Fecha Venta': v.fechaVenta,
            'Inicio Uso': v.fechaInicioUso,
            'Fin Uso': v.fechaFinUso,
            'Estado': v.estado
        }));
        
        // Crear CSV
        const headers = Object.keys(data[0]);
        const csv = [
            headers.join(','),
            ...data.map(row => headers.map(h => `"${row[h]}"`).join(','))
        ].join('\n');
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Vouchers_Flexi_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('‚úÖ Vouchers exportados correctamente', 'success');
    }

    // =====================================================
    // UTILIDADES
    // =====================================================

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatDateRange(start, end) {
        return `${formatDate(start)} - ${formatDate(end)}`;
    }

    function showNotification(message, type = 'info') {
        // Usar la funci√≥n de notificaci√≥n existente del dashboard o crear una simple
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3'};
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    }

    // =====================================================
    // INICIALIZACI√ìN AL CARGAR
    // =====================================================

    // Inicializar cuando se muestre la secci√≥n Flexi
    const originalShowSection = window.showSection;
    if (originalShowSection) {
        window.showSection = function(section, event) {
            originalShowSection(section, event);
            if (section === 'flexi') {
                setTimeout(() => {
                    initFlexiData();
                }, 100);
            }
        };
    }

    // Tambi√©n inicializar al cargar la p√°gina por si ya estamos en la secci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (document.getElementById('flexi-section') && 
                document.getElementById('flexi-section').style.display !== 'none') {
                initFlexiData();
            }
        }, 500);
    });

    // Agregar estilos de animaci√≥n
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    console.log('üé´ M√≥dulo Programa Flexi cargado correctamente');
    </script>
    <!-- ==================== FIN SCRIPT PROGRAMA FLEXI ==================== -->

    <!-- ==================== SCRIPT FLOR IA / INTERACCIONES / CHATS ==================== -->
    <script>
    // =====================================================
    // M√ìDULO FLOR IA - INTERACCIONES Y CHATS
    // =====================================================

    // Funci√≥n para mostrar tabs de Flor - Ya est√° definida en el head, solo actualizar si es necesario
    // Asegurar que siempre est√© disponible y tambi√©n sin window.
    if (typeof window.showFlorTab === 'undefined' || !window.showFlorTab) {
        window.showFlorTab = function(tabName) {
            console.log('üìë Cambiando a tab Flor:', tabName);
            
            // Ocultar todos los tabs
            document.querySelectorAll('.flor-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones de tab
            document.querySelectorAll('.flor-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#f5f5f5';
                btn.style.color = '#333';
            });
            
            // Mostrar tab seleccionado
            const tabContent = document.getElementById('flor-tab-' + tabName);
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.style.visibility = 'visible';
                tabContent.style.opacity = '1';
                tabContent.classList.add('active');
                console.log('‚úÖ Tab mostrado:', tabName, tabContent);
            } else {
                console.error('‚ùå Tab no encontrado:', 'flor-tab-' + tabName);
            }
            
            // Activar bot√≥n
            const tabBtn = document.querySelector(`.flor-tab[data-tab="${tabName}"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
                if (tabName === 'whatsapp') {
                    tabBtn.style.background = '#25D366';
                    tabBtn.style.color = 'white';
                } else {
                    tabBtn.style.background = '#1976d2';
                    tabBtn.style.color = 'white';
                }
            }
            
            // Cargar datos espec√≠ficos del tab
            if (tabName === 'knowledge' || tabName === 'policies') {
                if (typeof loadHotelsForFlor === 'function') {
                    loadHotelsForFlor();
                }
            }
            if (tabName === 'whatsapp') {
                if (typeof checkWhatsAppConnection === 'function') {
                    checkWhatsAppConnection();
                }
            // Cargar configuraci√≥n guardada
            const savedConfig = localStorage.getItem('whatsappConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    const serverUrlInput = document.getElementById('whatsapp-server-url');
                    const autoReplyCheck = document.getElementById('whatsapp-auto-reply');
                    const businessHoursCheck = document.getElementById('whatsapp-business-hours-only');
                    const outOfHoursMsg = document.getElementById('whatsapp-out-of-hours-message');
                    
                    if (serverUrlInput && config.serverUrl) serverUrlInput.value = config.serverUrl;
                    if (autoReplyCheck) autoReplyCheck.checked = config.autoReply !== false;
                    if (businessHoursCheck) businessHoursCheck.checked = config.businessHoursOnly || false;
                    if (outOfHoursMsg && config.outOfHoursMessage) outOfHoursMsg.value = config.outOfHoursMessage;
                } catch (e) {
                    console.error('Error cargando configuraci√≥n de WhatsApp:', e);
                }
            }
        };
    }
    // Asegurar que tambi√©n est√© disponible sin window.
    showFlorTab = window.showFlorTab;

    // Cargar hoteles para selectores de Flor
    function loadHotelsForFlor() {
        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
        const selectors = ['knowledge-hotel-selector', 'policy-hotel-select'];
        
        selectors.forEach(selectorId => {
            const selector = document.getElementById(selectorId);
            if (selector) {
                selector.innerHTML = '<option value="">-- Seleccione un hotel --</option>';
                hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    option.value = hotel.id;
                    option.textContent = hotel.name || hotel.nombre || 'Hotel sin nombre';
                    selector.appendChild(option);
                });
            }
        });
    }

    // Guardar configuraci√≥n general de Flor (incluye multimodal)
    window.saveFlorGeneral = function() {
        const config = {
            // Configuraci√≥n b√°sica
            name: document.getElementById('flor-name')?.value || 'Flor',
            role: document.getElementById('flor-role')?.value || 'Agente Multimodal de Conversaci√≥n',
            greeting: document.getElementById('flor-greeting')?.value || '',
            personality: document.getElementById('flor-personality')?.value || '',
            // Configuraci√≥n multimodal
            multimodal: {
                audio: {
                    enabled: document.getElementById('audio-enabled')?.checked ?? true,
                    maxDuration: parseInt(document.getElementById('audio-max-duration')?.value) || 45
                },
                imageInput: {
                    enabled: document.getElementById('image-input-enabled')?.checked ?? true
                },
                imageOutput: {
                    enabled: document.getElementById('image-output-enabled')?.checked ?? true,
                    apiEndpoint: document.getElementById('image-api-endpoint')?.value || '/api/hoteles/imagen/{nombre_hotel}'
                }
            }
        };
        localStorage.setItem('flor_general_config', JSON.stringify(config));
        
        // Tambi√©n actualizar el servicio multimodal si existe
        if (typeof florMultimodalService !== 'undefined') {
            florMultimodalService.config.audio.enabled = config.multimodal.audio.enabled;
            florMultimodalService.config.audio.maxDuration = config.multimodal.audio.maxDuration;
            florMultimodalService.config.image.enabled = config.multimodal.imageInput.enabled;
        }
        
        alert('‚úÖ Configuraci√≥n general y multimodal guardada');
        console.log('üíæ Configuraci√≥n Flor guardada:', config);
    };

    // Cargar configuraci√≥n general (incluye multimodal)
    function loadFlorGeneral() {
        const config = JSON.parse(localStorage.getItem('flor_general_config') || '{}');
        
        // Configuraci√≥n b√°sica
        if (config.name) document.getElementById('flor-name').value = config.name;
        if (config.role) document.getElementById('flor-role').value = config.role;
        if (config.greeting) document.getElementById('flor-greeting').value = config.greeting;
        if (config.personality) document.getElementById('flor-personality').value = config.personality;
        
        // Configuraci√≥n multimodal
        if (config.multimodal) {
            const audioEnabled = document.getElementById('audio-enabled');
            const audioMaxDuration = document.getElementById('audio-max-duration');
            const imageInputEnabled = document.getElementById('image-input-enabled');
            const imageOutputEnabled = document.getElementById('image-output-enabled');
            const imageApiEndpoint = document.getElementById('image-api-endpoint');
            
            if (audioEnabled) audioEnabled.checked = config.multimodal.audio?.enabled ?? true;
            if (audioMaxDuration) audioMaxDuration.value = config.multimodal.audio?.maxDuration || 45;
            if (imageInputEnabled) imageInputEnabled.checked = config.multimodal.imageInput?.enabled ?? true;
            if (imageOutputEnabled) imageOutputEnabled.checked = config.multimodal.imageOutput?.enabled ?? true;
            if (imageApiEndpoint) imageApiEndpoint.value = config.multimodal.imageOutput?.apiEndpoint || '/api/hoteles/imagen/{nombre_hotel}';
        }
    }

    // Guardar respuestas predefinidas (incluye multimodales)
    window.saveFlorResponses = function() {
        const responses = {
            // Respuestas generales
            noEntendido: document.getElementById('response-no-entendido')?.value || '',
            transferir: document.getElementById('response-transferir')?.value || '',
            despedida: document.getElementById('response-despedida')?.value || '',
            // Respuestas multimodales - Audio
            audioFallback: document.getElementById('response-audio-fallback')?.value || 'Disculpa, el audio no fue del todo claro. Para atenderte con la rapidez que mereces, ¬øpodr√≠as enviarme tu consulta por escrito, o prefieres que te conecte con un agente ahora mismo?',
            audioProcessing: document.getElementById('response-audio-processing')?.value || 'Un momento, estoy escuchando tu mensaje de voz... üéß',
            // Respuestas multimodales - Im√°genes entrada
            imageFallback: document.getElementById('response-image-fallback')?.value || 'No pude identificar claramente la imagen. ¬øPodr√≠as describirme qu√© est√°s buscando o enviar otra foto con mejor iluminaci√≥n?',
            imageProcessing: document.getElementById('response-image-processing')?.value || 'Un momento, estoy analizando la imagen... üîç',
            imageHotelFound: document.getElementById('response-image-hotel-found')?.value || '¬°Reconozco esa imagen! Se trata de {nombre_hotel}. Te cuento m√°s sobre este hotel:',
            // Respuestas multimodales - Im√°genes salida
            imageSending: document.getElementById('response-image-sending')?.value || 'Aqu√≠ te muestro una foto de {nombre_hotel}:',
            imageNotAvailable: document.getElementById('response-image-not-available')?.value || 'Lo siento, no tengo im√°genes disponibles de este hotel en este momento. ¬øTe gustar√≠a que te conecte con un agente que pueda mostrarte fotos?'
        };
        localStorage.setItem('flor_responses', JSON.stringify(responses));
        
        // Actualizar servicio multimodal si existe
        if (typeof florMultimodalService !== 'undefined') {
            florMultimodalService.config.audio.fallbackMessage = responses.audioFallback;
            florMultimodalService.config.audio.processingMessage = responses.audioProcessing;
            florMultimodalService.config.image.fallbackMessage = responses.imageFallback;
            florMultimodalService.config.image.processingMessage = responses.imageProcessing;
        }
        
        alert('‚úÖ Respuestas guardadas (generales y multimodales)');
        console.log('üíæ Respuestas Flor guardadas:', responses);
    };
    
    // Cargar respuestas predefinidas
    function loadFlorResponses() {
        const responses = JSON.parse(localStorage.getItem('flor_responses') || '{}');
        
        // Generales
        if (responses.noEntendido) document.getElementById('response-no-entendido').value = responses.noEntendido;
        if (responses.transferir) document.getElementById('response-transferir').value = responses.transferir;
        if (responses.despedida) document.getElementById('response-despedida').value = responses.despedida;
        
        // Multimodales - Audio
        if (responses.audioFallback) document.getElementById('response-audio-fallback').value = responses.audioFallback;
        if (responses.audioProcessing) document.getElementById('response-audio-processing').value = responses.audioProcessing;
        
        // Multimodales - Im√°genes entrada
        if (responses.imageFallback) document.getElementById('response-image-fallback').value = responses.imageFallback;
        if (responses.imageProcessing) document.getElementById('response-image-processing').value = responses.imageProcessing;
        if (responses.imageHotelFound) document.getElementById('response-image-hotel-found').value = responses.imageHotelFound;
        
        // Multimodales - Im√°genes salida
        if (responses.imageSending) document.getElementById('response-image-sending').value = responses.imageSending;
        if (responses.imageNotAvailable) document.getElementById('response-image-not-available').value = responses.imageNotAvailable;
    }

    // Guardar pol√≠ticas de hotel
    window.saveFlorPolicies = function() {
        const hotelId = document.getElementById('policy-hotel-select')?.value;
        if (!hotelId) {
            alert('‚ö†Ô∏è Selecciona un hotel primero');
            return;
        }
        
        const policies = JSON.parse(localStorage.getItem('flor_policies') || '{}');
        policies[hotelId] = {
            condicionesReserva: document.getElementById('policy-condiciones-reserva')?.value || '',
            cancelacionModificacion: document.getElementById('policy-cancelacion-modificacion')?.value || ''
        };
        localStorage.setItem('flor_policies', JSON.stringify(policies));
        alert('‚úÖ Pol√≠ticas guardadas para el hotel');
    };

    // Cargar pol√≠ticas de hotel
    window.loadHotelPolicies = function() {
        const hotelId = document.getElementById('policy-hotel-select')?.value;
        const form = document.getElementById('hotel-policies-form');
        
        if (!hotelId) {
            if (form) form.style.display = 'none';
            return;
        }
        
        if (form) form.style.display = 'block';
        
        const policies = JSON.parse(localStorage.getItem('flor_policies') || '{}');
        const hotelPolicies = policies[hotelId] || {};
        
        document.getElementById('policy-condiciones-reserva').value = hotelPolicies.condicionesReserva || '';
        document.getElementById('policy-cancelacion-modificacion').value = hotelPolicies.cancelacionModificacion || '';
    };

    // Toggle AI Config
    window.toggleAIConfig = function() {
        const enabled = document.getElementById('ai-enabled')?.checked;
        const fields = document.getElementById('ai-config-fields');
        if (fields) {
            fields.style.display = enabled ? 'block' : 'none';
        }
    };

    // Actualizar modelo seg√∫n proveedor seleccionado
    window.updateAIModel = function() {
        const provider = document.getElementById('ai-provider')?.value;
        const modelInput = document.getElementById('ai-model');
        const modelHelp = document.getElementById('ai-model-help');
        
        const models = {
            gemini: { default: 'gemini-2.5-flash', help: 'Modelos: gemini-2.5-flash (recomendado), gemini-2.0-flash, gemini-2.5-pro' },
            openai: { default: 'gpt-4o-mini', help: 'Modelos OpenAI: gpt-4o-mini (econ√≥mico), gpt-4o (potente), gpt-4-turbo' },
            claude: { default: 'claude-3-haiku-20240307', help: 'Modelos Claude: claude-3-haiku (r√°pido), claude-3-sonnet, claude-3-opus (potente)' }
        };
        
        if (models[provider]) {
            if (modelInput) modelInput.value = models[provider].default;
            if (modelHelp) modelHelp.textContent = models[provider].help;
        }
    };

    // Guardar configuraci√≥n de IA
    window.saveAIConfig = async function() {
        const config = {
            enabled: document.getElementById('ai-enabled')?.checked || false,
            provider: document.getElementById('ai-provider')?.value || 'gemini',
            apiKey: document.getElementById('ai-api-key')?.value || '',
            model: document.getElementById('ai-model')?.value || 'gemini-2.5-flash'
        };
        
        // Guardar en localStorage
        localStorage.setItem('flor_ai_config', JSON.stringify(config));
        
        // Guardar en Supabase para persistencia en la nube
        if (window.supabaseClient && window.supabaseClient.isInitialized()) {
            try {
                await window.supabaseClient.client
                    .from('system_config')
                    .upsert({
                        key: 'flor_ai_config',
                        value: JSON.stringify(config),
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'key' });
                console.log('‚òÅÔ∏è Configuraci√≥n de IA guardada en Supabase');
            } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo guardar en Supabase:', e);
            }
        }
        
        // Recargar el servicio de IA si est√° disponible
        if (typeof florAIService !== 'undefined') {
            florAIService.loadConfig();
            console.log('üîÑ Servicio de IA recargado');
        }
        
        alert('‚úÖ Configuraci√≥n de IA guardada y sincronizada');
    };

    // Probar conexi√≥n IA
    window.testAIConfig = async function() {
        const provider = document.getElementById('ai-provider')?.value || 'gemini';
        const apiKey = document.getElementById('ai-api-key')?.value || '';
        const model = document.getElementById('ai-model')?.value || 'gemini-1.5-flash';
        
        if (!apiKey) {
            alert('‚ö†Ô∏è Por favor ingresa tu API Key primero');
            return;
        }
        
        alert('üîÑ Probando conexi√≥n con ' + provider.toUpperCase() + '...');
        
        try {
            let response;
            const testMessage = 'Responde solo con: OK';
            
            if (provider === 'gemini') {
                // Primero listar modelos disponibles
                console.log('üìã Listando modelos disponibles...');
                console.log('üîë API Key (primeros 10 chars):', apiKey.substring(0, 10) + '...');
                
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                console.log('üîó URL Lista:', listUrl);
                
                try {
                    const listResponse = await fetch(listUrl);
                    const listData = await listResponse.json();
                    
                    console.log('üì¶ Respuesta completa:', JSON.stringify(listData, null, 2));
                    
                    if (listData.error) {
                        alert('‚ùå Error con API Key:\n\n' + listData.error.message + '\n\nüí° Aseg√∫rate de copiar la API Key COMPLETA desde Google AI Studio.');
                        return;
                    }
                    
                    if (!listData.models || listData.models.length === 0) {
                        alert('‚ùå La API no devolvi√≥ modelos.\n\nRevisa la consola del navegador (F12) para m√°s detalles.');
                        console.log('‚ö†Ô∏è Respuesta sin modelos:', listData);
                        return;
                    }
                    
                    // Buscar modelos que soporten generateContent
                    const availableModels = listData.models.filter(m => 
                        m.supportedGenerationMethods?.includes('generateContent')
                    ).map(m => m.name.replace('models/', ''));
                    
                    console.log('‚úÖ Modelos con generateContent:', availableModels);
                    
                    if (availableModels.length === 0) {
                        // Mostrar todos los modelos disponibles
                        const allModels = listData.models.map(m => m.name);
                        alert('‚ö†Ô∏è Modelos encontrados pero ninguno soporta generateContent:\n\n' + allModels.join('\n'));
                        return;
                    }
                    
                    // Preferir modelos flash
                    let modelToUse = availableModels.find(m => m.includes('flash')) || 
                                     availableModels.find(m => m.includes('pro')) || 
                                     availableModels[0];
                    console.log('üéØ Usando modelo:', modelToUse);
                    
                    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKey}`;
                    
                    response = await fetch(geminiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: testMessage }] }],
                            generationConfig: { maxOutputTokens: 100 }
                        })
                    });
                    
                    const responseData = await response.json();
                    console.log('üì® Respuesta generateContent:', responseData);
                    
                    if (responseData.error) {
                        alert('‚ùå Error al generar:\n\n' + responseData.error.message);
                        return;
                    }
                    
                    if (responseData.candidates && responseData.candidates[0]) {
                        const aiResponse = responseData.candidates[0].content?.parts?.[0]?.text || 'Respuesta vac√≠a';
                        alert('‚úÖ ¬°Conexi√≥n exitosa!\n\nModelo: ' + modelToUse + '\n\nRespuesta: ' + aiResponse.substring(0, 200));
                        
                        // Actualizar el campo del modelo
                        if (document.getElementById('ai-model')) {
                            document.getElementById('ai-model').value = modelToUse;
                        }
                        return; // √âxito, salir
                    }
                    
                } catch (e) {
                    console.error('‚ùå Error:', e);
                    alert('‚ùå Error de conexi√≥n: ' + e.message);
                    return;
                }
                return; // Evitar continuar con el c√≥digo de abajo
            } else if (provider === 'openai') {
                // OpenAI API
                response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model || 'gpt-4o-mini',
                        messages: [{ role: 'user', content: testMessage }],
                        max_tokens: 10
                    })
                });
            } else if (provider === 'claude') {
                // Claude API (Anthropic)
                response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: model || 'claude-3-haiku-20240307',
                        max_tokens: 10,
                        messages: [{ role: 'user', content: testMessage }]
                    })
                });
            }
            
            if (response && response.ok) {
                const data = await response.json();
                console.log('‚úÖ Respuesta de IA:', data);
                alert('‚úÖ ¬°Conexi√≥n exitosa con ' + provider.toUpperCase() + '!\n\nLa API est√° funcionando correctamente.');
            } else {
                const errorData = await response?.json().catch(() => ({}));
                console.error('‚ùå Error de API:', errorData);
                alert('‚ùå Error de conexi√≥n:\n\n' + (errorData.error?.message || response?.statusText || 'Error desconocido'));
            }
        } catch (error) {
            console.error('‚ùå Error de conexi√≥n:', error);
            alert('‚ùå Error de conexi√≥n:\n\n' + error.message);
        }
    };

    // Verificar conexi√≥n WhatsApp
    // Verificar conexi√≥n con WhatsApp (VERSI√ìN CORREGIDA - usa /api/status y muestra QR correctamente)
    // Funciones de WhatsApp eliminadas
    window.checkWhatsAppConnection = function() {
        console.warn('‚ö†Ô∏è Funciones de WhatsApp han sido eliminadas');
    };
        console.log('üîÑ Verificando conexi√≥n con WhatsApp...');
        
        const statusIndicator = document.getElementById('whatsapp-status-indicator');
        const statusText = document.getElementById('whatsapp-status-text');
        const statusDetail = document.getElementById('whatsapp-status-detail');
        const qrSection = document.getElementById('whatsapp-qr-section');
        const infoSection = document.getElementById('whatsapp-info-section');
        
        // Estado inicial: verificando
        if (statusIndicator) statusIndicator.style.background = '#ffc107';
        if (statusText) statusText.textContent = 'Verificando conexi√≥n...';
        if (statusDetail) statusDetail.textContent = 'Conectando con el servidor...';
        
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || localStorage.getItem('whatsappServerURL') || 'http://localhost:3001';
        
        try {
            const response = await fetch(`${serverUrl}/api/status`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Servidor no responde');
            }
            
            const data = await response.json();
            console.log('üì± Estado de WhatsApp:', data);
            
            if (data.connected || data.whatsapp === 'connected') {
                // Conectado
                if (statusIndicator) statusIndicator.style.background = '#4caf50';
                if (statusText) statusText.textContent = '‚úÖ WhatsApp Conectado';
                if (statusDetail) statusDetail.textContent = 'Listo para recibir y enviar mensajes';
                
                if (qrSection) qrSection.style.display = 'none';
                if (infoSection) {
                    infoSection.style.display = 'block';
                    const phoneEl = document.getElementById('whatsapp-phone-number');
                    const nameEl = document.getElementById('whatsapp-user-name');
                    if (phoneEl) phoneEl.textContent = data.phoneNumber || data.phone || '-';
                    if (nameEl) nameEl.textContent = data.userName || data.name || '-';
                }
            } else if (data.qrCode || data.qr) {
                // Necesita escanear QR
                if (statusIndicator) statusIndicator.style.background = '#ff9800';
                if (statusText) statusText.textContent = 'üì≤ Escanea el c√≥digo QR';
                if (statusDetail) statusDetail.textContent = 'Abre WhatsApp en tu tel√©fono para vincular';
                
                if (infoSection) infoSection.style.display = 'none';
                if (qrSection) {
                    qrSection.style.display = 'block';
                    const qrCodeEl = document.getElementById('whatsapp-qr-code');
                    if (qrCodeEl) {
                        // Si viene como URL de imagen, usarla directamente
                        if (data.qrCode && data.qrCode.startsWith('http')) {
                            qrCodeEl.innerHTML = `<img src="${data.qrCode}" alt="QR Code" style="max-width: 300px; border-radius: 8px;">`;
                        } else if (data.qr) {
                            // Si viene como string QR, generar imagen
                            const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data.qr)}`;
                            qrCodeEl.innerHTML = `<img src="${qrImageUrl}" alt="QR Code" style="max-width: 300px; border-radius: 8px;">`;
                        }
                    }
                }
                
                // Verificar peri√≥dicamente hasta que se conecte
                if (!window.whatsappStatusInterval) {
                    window.whatsappStatusInterval = setInterval(window.checkWhatsAppConnection, 5000);
                }
            } else {
                // Desconectado, esperando QR
                if (statusIndicator) statusIndicator.style.background = '#ff9800';
                if (statusText) statusText.textContent = '‚è≥ Esperando c√≥digo QR...';
                if (statusDetail) statusDetail.textContent = 'El servidor est√° generando el c√≥digo QR';
                
                if (infoSection) infoSection.style.display = 'none';
                if (qrSection) qrSection.style.display = 'none';
                
                // Verificar peri√≥dicamente
                if (!window.whatsappStatusInterval) {
                    window.whatsappStatusInterval = setInterval(window.checkWhatsAppConnection, 3000);
                }
            }
            
        } catch (error) {
            console.error('‚ùå Error conectando con servidor WhatsApp:', error);
            
            if (statusIndicator) statusIndicator.style.background = '#f44336';
            if (statusText) statusText.textContent = '‚ùå Error de conexi√≥n';
            if (statusDetail) statusDetail.textContent = 'No se puede conectar con el servidor. Verifica la URL y que el servidor est√© corriendo.';
            
            if (qrSection) qrSection.style.display = 'none';
            if (infoSection) infoSection.style.display = 'none';
            
            // Detener verificaci√≥n peri√≥dica
            if (window.whatsappStatusInterval) {
                clearInterval(window.whatsappStatusInterval);
                window.whatsappStatusInterval = null;
            }
        }
    };

    // Guardar config WhatsApp
    // Funciones de WhatsApp eliminadas

    // Cargar interacciones
    // VERSI√ìN: 4.0 - FORZAR RECARGA - 2025-12-17-18:30
    window.loadInteractions = async function() {
        const VERSION = '4.0-FORZAR-RECARGA-2025-12-17-18:30';
        console.log('üöÄüöÄüöÄ INICIO loadInteractions - VERSI√ìN ' + VERSION + ' - ' + new Date().toISOString());
        let tbody = null;
        try {
            console.log('üìã Cargando interacciones... [VERSI√ìN ' + VERSION + ' - ' + new Date().toISOString() + ']');
            console.log('üîç DEBUG: Verificando elementos del DOM...');
            console.log('üîç DEBUG: Despu√©s del primer log, continuando...');
            
            // Intentar encontrar el elemento, con m√∫ltiples intentos
            tbody = document.getElementById('interactionsTableBody');
            if (!tbody) {
                console.warn('‚ö†Ô∏è interactionsTableBody no encontrado en primer intento, esperando 200ms...');
                await new Promise(resolve => setTimeout(resolve, 200));
                tbody = document.getElementById('interactionsTableBody');
            }
            
            console.log('üîç DEBUG: interactionsTableBody encontrado:', !!tbody);
            
            if (!tbody) {
                console.error('‚ùå interactionsTableBody no encontrado despu√©s de esperar. Elementos disponibles:', {
                    interactionsSection: !!document.getElementById('interactions'),
                    interactionsTable: !!document.querySelector('#interactions table'),
                    allTables: document.querySelectorAll('table').length
                });
                return;
            }
            
            console.log('‚úÖ Elemento interactionsTableBody encontrado, mostrando cargando...');
        
            // Mostrar cargando
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                        <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px; animation: spin 1s linear infinite;">sync</span>
                        Cargando interacciones...
                    </td>
                </tr>
            `;
            let interactions = [];
            
            // Verificar si Supabase est√° disponible
            console.log('üîç Verificando Supabase...');
            console.log('  - window.supabaseClient existe:', !!window.supabaseClient);
            if (window.supabaseClient) {
                console.log('  - Supabase inicializado:', window.supabaseClient.isInitialized());
            }
            
            if (!window.supabaseClient) {
                console.warn('‚ö†Ô∏è window.supabaseClient no est√° disponible');
            } else if (!window.supabaseClient.isInitialized()) {
                console.warn('‚ö†Ô∏è Supabase no est√° inicializado');
            } else {
                console.log('‚úÖ Supabase disponible, cargando interacciones...');
            }
            
            // Intentar cargar desde Supabase
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                console.log('üì° Llamando a getFlorInteractions(100)...');
                try {
                    interactions = await window.supabaseClient.getFlorInteractions(100);
                    console.log(`üå∏ ${interactions.length} interacciones cargadas desde Supabase`);
                    if (interactions.length > 0) {
                        console.log('üìã Primeras 3 interacciones:', interactions.slice(0, 3).map(i => ({
                            id: i.id,
                            phone: i.phone,
                            user_message: i.user_message?.substring(0, 50),
                            intent: i.intent
                        })));
                    } else {
                        console.warn('‚ö†Ô∏è No se obtuvieron interacciones de Supabase. Verifica:');
                        console.warn('  1. Que haya datos en la tabla flor_interactions');
                        console.warn('  2. Que RLS est√© configurado correctamente');
                        console.warn('  3. Que el servidor de WhatsApp est√© guardando interacciones');
                    }
                } catch (error) {
                    console.error('‚ùå Error al obtener interacciones de Supabase:', error);
                    console.error('‚ùå Stack trace:', error.stack);
                    interactions = [];
                }
            } else {
                console.log('‚ö†Ô∏è Usando fallback a localStorage');
            }
            
            // Fallback a localStorage si no hay en Supabase
            if (interactions.length === 0) {
                const localInteractions = JSON.parse(localStorage.getItem('flor_interactions') || '[]');
                console.log(`üì¶ ${localInteractions.length} interacciones encontradas en localStorage`);
                interactions = localInteractions.map(inter => ({
                    id: inter.id,
                    created_at: inter.date || new Date().toISOString(),
                    phone: inter.client || 'web',
                    user_message: inter.userMessage || '',
                    bot_response: inter.botResponse || '',
                    intent: inter.intent || 'consulta_general',
                    success: inter.status === 'resolved',
                    used_ai: inter.usedAI || false
                }));
            }
            
            if (interactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <span class="material-icons" style="font-size: 48px; color: #ccc; display: block; margin-bottom: 16px;">chat</span>
                            <p style="font-weight: 500; margin-bottom: 8px;">No hay interacciones registradas a√∫n</p>
                            <p style="font-size: 0.85rem; color: #999;">Las interacciones aparecer√°n aqu√≠ cuando Flor responda a mensajes de WhatsApp</p>
                            <p style="font-size: 0.75rem; color: #999; margin-top: 4px;">Aseg√∫rate de que el servidor de WhatsApp est√© guardando interacciones en Supabase</p>
                        </td>
                    </tr>
                `;
                console.log('‚ÑπÔ∏è No hay interacciones para mostrar. Esto es normal si a√∫n no has recibido mensajes o si Flor no ha respondido.');
                return;
            }
            
            // Agrupar interacciones por tel√©fono/sesi√≥n
            const groupedInteractions = {};
            interactions.forEach(inter => {
                const phone = inter.phone || 'web';
                const date = new Date(inter.created_at).toDateString();
                const key = `${phone}_${date}`;
                
                if (!groupedInteractions[key]) {
                    groupedInteractions[key] = {
                        id: inter.id,
                        phone: phone,
                        date: inter.created_at,
                        messageCount: 1,
                        resolvedBy: inter.used_ai ? 'Flor IA' : 'Flor',
                        status: inter.success !== false ? 'resolved' : 'pending',
                        interactions: [inter]
                    };
                } else {
                    groupedInteractions[key].messageCount++;
                    groupedInteractions[key].interactions.push(inter);
                    if (inter.created_at > groupedInteractions[key].date) {
                        groupedInteractions[key].date = inter.created_at;
                    }
                }
            });
            
            const grouped = Object.values(groupedInteractions).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            tbody.innerHTML = grouped.map(interaction => `
                <tr>
                    <td style="padding: 12px;">${new Date(interaction.date).toLocaleString('es-ES')}</td>
                    <td style="padding: 12px;">${interaction.phone || 'Desconocido'}</td>
                    <td style="padding: 12px; text-align: center;">${interaction.messageCount || 0}</td>
                    <td style="padding: 12px;">${interaction.resolvedBy || 'Flor'}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="background: ${interaction.status === 'resolved' ? '#4caf50' : '#ff9800'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                            ${interaction.status === 'resolved' ? 'Resuelto' : 'Pendiente'}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="viewInteraction('${interaction.id}')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                            Ver
                        </button>
                    </td>
                </tr>
            `).join('');
            
            console.log(`‚úÖ ${grouped.length} sesiones de interacciones mostradas`);
        } catch (error) {
            console.error('‚ùå Error cargando interacciones:', error);
            console.error('‚ùå Stack trace completo:', error.stack);
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #d32f2f;">
                            <span class="material-icons" style="font-size: 48px; color: #d32f2f; display: block; margin-bottom: 16px;">error</span>
                            Error al cargar interacciones
                            <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p>
                        </td>
                    </tr>
                `;
            }
        }
    };
    console.log('‚úÖ‚úÖ‚úÖ FUNCI√ìN window.loadInteractions DEFINIDA - VERSI√ìN 4.0 - ' + new Date().toISOString());

    // Cargar chats activos desde Supabase
    // VERSI√ìN: 4.0 - FORZAR RECARGA - 2025-12-17-18:30
    window.loadChats = async function() {
        const VERSION = '4.0-FORZAR-RECARGA-2025-12-17-18:30';
        console.log('üöÄüöÄüöÄ INICIO loadChats - VERSI√ìN ' + VERSION + ' - ' + new Date().toISOString());
        let chatsList = null;
        try {
            console.log('üí¨ Cargando chats activos... [VERSI√ìN ' + VERSION + ' - ' + new Date().toISOString() + ']');
            console.log('üîç DEBUG: Verificando elementos del DOM...');
            console.log('üîç DEBUG: Despu√©s del primer log, continuando...');
            
            // Intentar encontrar el elemento, con m√∫ltiples intentos
            console.log('üîç DEBUG: Buscando elemento chatsList...');
            chatsList = document.getElementById('chatsList');
            console.log('üîç DEBUG: chatsList encontrado:', !!chatsList);
            if (!chatsList) {
                console.warn('‚ö†Ô∏è chatsList no encontrado en primer intento, esperando 200ms...');
                await new Promise(resolve => setTimeout(resolve, 200));
                chatsList = document.getElementById('chatsList');
            }
            
            console.log('üîç DEBUG: chatsList encontrado:', !!chatsList);
            
            if (!chatsList) {
                console.error('‚ùå chatsList no encontrado despu√©s de esperar. Elementos disponibles:', {
                    chatsSection: !!document.getElementById('chats'),
                    chatsContainer: !!document.querySelector('#chats div'),
                    allDivs: document.querySelectorAll('#chats div').length
                });
                return;
            }
            
            console.log('‚úÖ Elemento chatsList encontrado, mostrando cargando...');
        
            // Mostrar cargando
            chatsList.innerHTML = `
                <div style="text-align: center; padding: 40px 16px; color: #666;">
                    <span class="material-icons" style="font-size: 36px; color: #ccc; animation: spin 1s linear infinite;">sync</span>
                    <p style="margin-top: 12px;">Cargando chats...</p>
                </div>
            `;
            
            let chats = [];
            
            // Verificar si Supabase est√° disponible
            console.log('üîç Verificando Supabase...');
            console.log('  - window.supabaseClient existe:', !!window.supabaseClient);
            if (window.supabaseClient) {
                console.log('  - Supabase inicializado:', window.supabaseClient.isInitialized());
            }
            
            if (!window.supabaseClient) {
                console.warn('‚ö†Ô∏è window.supabaseClient no est√° disponible');
            } else if (!window.supabaseClient.isInitialized()) {
                console.warn('‚ö†Ô∏è Supabase no est√° inicializado');
            } else {
                console.log('‚úÖ Supabase disponible, cargando chats...');
            }
            
            // Intentar cargar desde Supabase
            if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                console.log('üì° Llamando a getWhatsAppChats(50)...');
                try {
                    chats = await window.supabaseClient.getWhatsAppChats(50);
                    console.log(`üì± ${chats.length} chats cargados desde Supabase`);
                    if (chats.length > 0) {
                        console.log('üìã Primeros 3 chats:', chats.slice(0, 3).map(c => ({
                            id: c.id,
                            phone: c.phone,
                            name: c.name,
                            last_message: c.last_message?.substring(0, 50)
                        })));
                    } else {
                        console.warn('‚ö†Ô∏è No se obtuvieron chats de Supabase. Verifica:');
                        console.warn('  1. Que haya datos en la tabla whatsapp_chats');
                        console.warn('  2. Que RLS est√© configurado correctamente');
                        console.warn('  3. Que los chats no sean solo broadcasts/grupos');
                    }
                } catch (error) {
                    console.error('‚ùå Error al obtener chats de Supabase:', error);
                    console.error('‚ùå Stack trace:', error.stack);
                    chats = [];
                }
            } else {
                console.log('‚ö†Ô∏è Usando fallback a localStorage');
            }
            
            // Fallback a localStorage si no hay en Supabase
            if (chats.length === 0) {
                const localChats = JSON.parse(localStorage.getItem('flor_active_chats') || '[]');
                console.log(`üì¶ ${localChats.length} chats encontrados en localStorage`);
                chats = localChats.map(chat => ({
                    id: chat.id,
                    phone: chat.phone,
                    name: chat.clientName || chat.phone || 'Cliente',
                    last_message: chat.lastText || null,
                    last_message_time: chat.lastMessage || new Date().toISOString(),
                    unread_count: 0,
                    users: { name: chat.clientName || null }
                }));
            }
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 16px; color: #666;">
                        <span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span>
                        <p style="margin-top: 12px; font-weight: 500;">No hay chats activos</p>
                        <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">Los chats aparecer√°n aqu√≠ cuando recibas mensajes de WhatsApp</p>
                        <p style="margin-top: 4px; font-size: 0.75rem; color: #999;">Aseg√∫rate de que el servidor de WhatsApp est√© guardando mensajes en Supabase</p>
                    </div>
                `;
                console.log('‚ÑπÔ∏è No hay chats para mostrar. Esto es normal si a√∫n no has recibido mensajes.');
                return;
            }
            
            // Renderizar chats
            console.log(`üé® Renderizando ${chats.length} chats...`);
            chatsList.innerHTML = chats.map(chat => {
                const userName = chat.users?.name || chat.name || chat.phone || 'Cliente';
                const lastMessage = chat.last_message || 'Sin mensajes';
                const lastMessageTime = chat.last_message_time ? new Date(chat.last_message_time).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                const unreadBadge = chat.unread_count > 0 
                    ? `<span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">${chat.unread_count}</span>` 
                    : '';
                
                return `
                    <div onclick="selectChat('${chat.id}')" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; ${chat.unread_count > 0 ? 'background: #f0fff4;' : ''}" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${chat.unread_count > 0 ? '#f0fff4' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${userName}${unreadBadge}</strong>
                            <span style="font-size: 0.75rem; color: #999;">${lastMessageTime}</span>
                        </div>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}</p>
                    </div>
                `;
            }).join('');
            
            console.log(`‚úÖ ${chats.length} chats renderizados correctamente`);
            
            // Suscribirse a cambios en tiempo real
            if (window.supabaseClient && window.supabaseClient.isInitialized() && !window.whatsappChatsSubscription) {
                window.whatsappChatsSubscription = window.supabaseClient.subscribeToWhatsAppChats((payload) => {
                    console.log('üì± Cambio en chat detectado, recargando...');
                    window.loadChats();
                });
                
                window.whatsappMessagesSubscription = window.supabaseClient.subscribeToWhatsAppMessages((message) => {
                    console.log('üì± Nuevo mensaje recibido, recargando chats...');
                    window.loadChats();
                });
                
                console.log('‚úÖ Suscripciones en tiempo real activas para chats');
            }
            
            console.log('‚úÖ‚úÖ‚úÖ FIN loadChats - √âxito completo');
        } catch (error) {
            console.error('‚ùå‚ùå‚ùå ERROR en loadChats:', error);
            console.error('‚ùå Tipo de error:', typeof error);
            console.error('‚ùå Mensaje:', error.message);
            console.error('‚ùå Stack trace completo:', error.stack);
            console.error('‚ùå Error completo:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
            if (chatsList) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 16px; color: #d32f2f;">
                        <span class="material-icons" style="font-size: 36px; color: #d32f2f;">error</span>
                        <p style="margin-top: 12px;">Error al cargar chats</p>
                        <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p>
                        <p style="margin-top: 4px; font-size: 0.75rem; color: #999;">Revisa la consola para m√°s detalles</p>
                    </div>
                `;
            } else {
                console.error('‚ùå chatsList no est√° disponible para mostrar el error');
            }
        } finally {
            console.log('üèÅ FINALLY: loadChats termin√≥');
        }
    };
    console.log('‚úÖ‚úÖ‚úÖ FUNCI√ìN window.loadChats DEFINIDA - VERSI√ìN 4.0 - ' + new Date().toISOString());

    // ============================================
    // SOLUCI√ìN ALTERNATIVA: Cargar chats directamente desde Supabase
    // VERSI√ìN: 1.0 - 2025-12-17
    // ============================================
    window.loadChatsDirect = async function() {
        console.log('üöÄüöÄüöÄ INICIO loadChatsDirect - SOLUCI√ìN ALTERNATIVA - ' + new Date().toISOString());
        console.log('üîÑ CARGANDO CHATS DIRECTAMENTE DESDE SUPABASE...');
        const chatsList = document.getElementById('chatsList');
        if (!chatsList) {
            console.error('‚ùå chatsList no encontrado');
            return;
        }

        try {
            chatsList.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span><p>Cargando...</p></div>';

            // Consultar Supabase directamente
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                throw new Error('Supabase no est√° inicializado');
            }

            const { data, error } = await window.supabaseClient.client
                .from('whatsapp_chats')
                .select('*')
                .order('last_message_time', { ascending: false })
                .limit(50);

            if (error) throw error;

            // Filtrar broadcasts y grupos
            const chats = (data || []).filter(chat => {
                const phone = chat.phone || '';
                return !phone.includes('@broadcast') && !phone.includes('@g.us') && !phone.includes('status@');
            });

            console.log(`‚úÖ ${chats.length} chats encontrados`);

            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 16px; color: #666;">
                        <span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span>
                        <p style="margin-top: 12px;">No hay chats activos</p>
                    </div>
                `;
                return;
            }

            // Renderizar chats
            chatsList.innerHTML = chats.map(chat => {
                const phone = chat.phone || 'Sin n√∫mero';
                const name = chat.name || phone;
                const lastMessage = (chat.last_message || 'Sin mensajes').substring(0, 50);
                const lastTime = chat.last_message_time ? new Date(chat.last_message_time).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                const unread = chat.unread_count > 0 ? `<span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">${chat.unread_count}</span>` : '';
                
                const escapedPhone = phone.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const escapedName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div onclick="openChatDirect('${chat.id}', '${escapedPhone}', '${escapedName}')" 
                         style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; ${chat.unread_count > 0 ? 'background: #f0fff4;' : ''}" 
                         onmouseover="this.style.background='#f5f5f5'" 
                         onmouseout="this.style.background='${chat.unread_count > 0 ? '#f0fff4' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${name}${unread}</strong>
                            <span style="font-size: 0.75rem; color: #999;">${lastTime}</span>
                        </div>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}</p>
                    </div>
                `;
            }).join('');

            console.log('‚úÖ Chats renderizados correctamente');
        } catch (error) {
            console.error('‚ùå Error cargando chats:', error);
            chatsList.innerHTML = `
                <div style="text-align: center; padding: 40px 16px; color: #d32f2f;">
                    <span class="material-icons" style="font-size: 36px; color: #d32f2f;">error</span>
                    <p style="margin-top: 12px;">Error al cargar chats</p>
                    <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p>
                </div>
            `;
        }
    };
    console.log('‚úÖ‚úÖ‚úÖ FUNCI√ìN window.loadChatsDirect DEFINIDA - SOLUCI√ìN ALTERNATIVA - ' + new Date().toISOString());

    // Abrir chat y cargar mensajes
    window.openChatDirect = async function(chatId, phone, name) {
        console.log('üí¨ Abriendo chat:', chatId, phone, name);
        
        const chatHeader = document.getElementById('chatHeader');
        const chatMessages = document.getElementById('chatMessages');
        const chatInputContainer = document.getElementById('chatInputContainer');
        
        if (!chatHeader || !chatMessages || !chatInputContainer) {
            console.error('‚ùå Elementos del chat no encontrados');
            return;
        }

        // Actualizar header
        chatHeader.innerHTML = `
            <h3 style="margin: 0; font-size: 1.1rem;">${name}</h3>
            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666;">${phone}</p>
        `;

        // Mostrar input
        chatInputContainer.style.display = 'block';
        chatInputContainer.setAttribute('data-chat-id', chatId);
        chatInputContainer.setAttribute('data-phone', phone);

        // Cargar mensajes
        try {
            chatMessages.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span><p>Cargando mensajes...</p></div>';

            const { data, error } = await window.supabaseClient.client
                .from('whatsapp_messages')
                .select('*')
                .eq('chat_id', chatId)
                .order('created_at', { ascending: true })
                .limit(100);

            if (error) throw error;

            console.log(`‚úÖ ${data?.length || 0} mensajes cargados`);

            if (!data || data.length === 0) {
                chatMessages.innerHTML = '<p style="text-align: center; color: #666; margin-top: 60px;">No hay mensajes en este chat</p>';
                return;
            }

            // Renderizar mensajes
            chatMessages.innerHTML = data.map(msg => {
                const isFromMe = msg.is_from_me;
                // La tabla usa 'body', no 'message'
                const message = (msg.body || msg.message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // Usar sent_at si existe, sino created_at
                const time = (msg.sent_at || msg.created_at) ? new Date(msg.sent_at || msg.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                
                return `
                    <div style="display: flex; justify-content: ${isFromMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                        <div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${isFromMe ? '#dcf8c6' : 'white'}; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            <p style="margin: 0; font-size: 0.9rem; word-wrap: break-word;">${message}</p>
                            <span style="font-size: 0.7rem; color: #999; margin-top: 4px; display: block; text-align: right;">${time}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll al final
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Marcar como le√≠do
            await window.supabaseClient.client
                .from('whatsapp_chats')
                .update({ unread_count: 0 })
                .eq('id', chatId);

        } catch (error) {
            console.error('‚ùå Error cargando mensajes:', error);
            chatMessages.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #d32f2f;">
                    <span class="material-icons" style="font-size: 48px; color: #d32f2f;">error</span>
                    <p style="margin-top: 12px;">Error al cargar mensajes</p>
                    <p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p>
                </div>
            `;
        }
    };

    // Enviar mensaje
    window.sendChatMessageDirect = async function() {
        const input = document.getElementById('chatMessageInput');
        const message = input?.value?.trim();
        const chatInputContainer = document.getElementById('chatInputContainer');
        const phone = chatInputContainer?.getAttribute('data-phone');
        
        if (!message || !phone) {
            console.warn('‚ö†Ô∏è No hay mensaje o tel√©fono');
            return;
        }

        try {
            console.log('üì§ Enviando mensaje a', phone, ':', message);
            
            // Obtener URL del servidor
            const serverUrl = document.getElementById('whatsapp-server-url')?.value || localStorage.getItem('whatsappServerURL') || 'http://localhost:3001';
            
            // Enviar mensaje al servidor
            const response = await fetch(`${serverUrl}/api/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ number: phone, message: message })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Error al enviar mensaje');
            }

            console.log('‚úÖ Mensaje enviado:', result);
            
            // Limpiar input
            input.value = '';
            
            // Recargar mensajes
            const chatId = chatInputContainer?.getAttribute('data-chat-id');
            if (chatId) {
                setTimeout(() => window.openChatDirect(chatId, phone, document.getElementById('chatHeader')?.querySelector('h3')?.textContent || phone), 500);
            }
            
            // Recargar lista de chats
            setTimeout(() => window.loadChatsDirect(), 1000);
            
        } catch (error) {
            console.error('‚ùå Error enviando mensaje:', error);
            alert('Error al enviar mensaje: ' + error.message);
        }
    };

    // Funci√≥n de prueba para verificar datos de Supabase
    window.testSupabaseChats = async function() {
        console.log('üß™ TEST: Verificando datos de Supabase...');
        try {
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                console.error('‚ùå Supabase no est√° inicializado');
                return;
            }
            
            console.log('üì° Consultando whatsapp_chats directamente...');
            const { data, error } = await window.supabaseClient.client
                .from('whatsapp_chats')
                .select('*')
                .order('last_message_time', { ascending: false })
                .limit(10);
            
            if (error) {
                console.error('‚ùå Error en consulta:', error);
                return;
            }
            
            console.log(`‚úÖ Encontrados ${data?.length || 0} chats en Supabase`);
            if (data && data.length > 0) {
                console.log('üìã Primeros 3 chats:', data.slice(0, 3));
                console.log('üìã Todos los chats:', data);
            } else {
                console.warn('‚ö†Ô∏è No hay chats en la tabla whatsapp_chats');
            }
            
            // Probar interacciones tambi√©n
            console.log('üì° Consultando flor_interactions directamente...');
            const { data: interactions, error: interactionsError } = await window.supabaseClient.client
                .from('flor_interactions')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (interactionsError) {
                console.error('‚ùå Error en consulta de interacciones:', interactionsError);
                return;
            }
            
            console.log(`‚úÖ Encontradas ${interactions?.length || 0} interacciones en Supabase`);
            if (interactions && interactions.length > 0) {
                console.log('üìã Primeras 3 interacciones:', interactions.slice(0, 3));
            } else {
                console.warn('‚ö†Ô∏è No hay interacciones en la tabla flor_interactions');
            }
        } catch (error) {
            console.error('‚ùå Error en test:', error);
            console.error('‚ùå Stack:', error.stack);
        }
    };

    // Seleccionar chat
    window.selectChat = function(chatId) {
        console.log('üí¨ Chat seleccionado:', chatId);
        const chats = JSON.parse(localStorage.getItem('flor_active_chats') || '[]');
        const chat = chats.find(c => c.id === chatId);
        
        if (!chat) return;
        
        const header = document.getElementById('chatHeader');
        const messages = document.getElementById('chatMessages');
        const inputContainer = document.getElementById('chatInputContainer');
        
        if (header) {
            header.innerHTML = `<h3 style="margin: 0; font-size: 1.1rem;">${chat.clientName || chat.phone || 'Cliente'}</h3>`;
        }
        
        if (messages && chat.messages) {
            messages.innerHTML = chat.messages.map(msg => `
                <div style="margin-bottom: 12px; display: flex; justify-content: ${msg.fromClient ? 'flex-start' : 'flex-end'};">
                    <div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${msg.fromClient ? '#e3f2fd' : '#1976d2'}; color: ${msg.fromClient ? '#333' : 'white'};">
                        ${msg.text}
                        <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.7;">${new Date(msg.time).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
            messages.scrollTop = messages.scrollHeight;
        }
        
        if (inputContainer) {
            inputContainer.style.display = 'block';
            inputContainer.dataset.chatId = chatId;
        }
    };

    // Enviar mensaje en chat
    window.sendChatMessage = function() {
        const input = document.getElementById('chatMessageInput');
        const container = document.getElementById('chatInputContainer');
        
        if (!input || !input.value.trim()) return;
        
        const chatId = container?.dataset.chatId;
        const message = input.value.trim();
        
        console.log('üì§ Enviando mensaje a chat:', chatId, message);
        
        // Aqu√≠ ir√≠a la l√≥gica para enviar el mensaje v√≠a WhatsApp API
        alert('Mensaje enviado: ' + message + '\n\n(Requiere integraci√≥n con servidor WhatsApp)');
        
        input.value = '';
    };

    // Cargar conocimiento del hotel seleccionado (sincronizado con secci√≥n Hoteles)
    window.loadSelectedHotelKnowledge = function() {
        const hotelId = document.getElementById('knowledge-hotel-selector')?.value;
        const container = document.getElementById('hotels-knowledge-list');
        
        if (!hotelId || !container) {
            container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Seleccione un hotel para ver/editar su base de conocimiento</p>';
            return;
        }
        
        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
        const hotel = hotels.find(h => h.id === hotelId);
        
        if (!hotel) {
            container.innerHTML = '<p style="color: #e53935; text-align: center; padding: 40px;">‚ùå Hotel no encontrado</p>';
            return;
        }
        
        // Cargar conocimiento extra de Flor
        const florKnowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
        const extraKnowledge = florKnowledge[hotelId] || {};
        
        // Obtener im√°genes del hotel
        const mainImage = hotel.mainImage || (hotel.images && hotel.images[0]) || '';
        const galleryImages = hotel.galleryImages || (hotel.images && hotel.images.slice(1)) || [];
        const amenitiesList = Array.isArray(hotel.amenities) ? hotel.amenities.join(', ') : (hotel.amenities || '');
        
        // Construir HTML con informaci√≥n sincronizada + campos extra
        container.innerHTML = `
            <div style="display: grid; gap: 24px;">
                <!-- Informaci√≥n Sincronizada (Solo Lectura) -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span> Informaci√≥n Sincronizada desde Hoteles
                        <span style="font-size: 0.8rem; color: #2e7d32; font-weight: normal;">(Solo lectura - Editar en secci√≥n Hoteles)</span>
                    </h4>
                    
                    <div style="display: grid; gap: 16px;">
                        <!-- Nombre y Ubicaci√≥n -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üè® Nombre del Hotel</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.name || 'No especificado'}</div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üìç Ubicaci√≥n</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.location || 'No especificada'}</div>
                            </div>
                        </div>
                        
                        <!-- Rating y Precio -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">‚≠ê Calificaci√≥n</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.rating || '0'}/5</div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üí∞ Rango de Precio</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${hotel.priceRange || hotel.price_range || 'No especificado'}</div>
                            </div>
                        </div>
                        
                        <!-- Amenidades -->
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üéØ Servicios/Amenidades</label>
                            <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">${amenitiesList || 'No especificados'}</div>
                        </div>
                        
                        <!-- Im√°genes del Hotel -->
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üñºÔ∏è Im√°genes Disponibles</label>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                ${mainImage ? `
                                    <div style="text-align: center;">
                                        <img src="${mainImage}" alt="Principal" style="width: 100px; height: 70px; object-fit: cover; border-radius: 6px; border: 2px solid #4caf50;">
                                        <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">Principal</div>
                                    </div>
                                ` : '<span style="color: #999;">Sin imagen principal</span>'}
                                ${galleryImages.length > 0 ? galleryImages.slice(0, 4).map((img, i) => `
                                    <div style="text-align: center;">
                                        <img src="${img}" alt="Galer√≠a ${i+1}" style="width: 100px; height: 70px; object-fit: cover; border-radius: 6px;">
                                        <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">Galer√≠a ${i+1}</div>
                                    </div>
                                `).join('') : ''}
                                ${galleryImages.length > 4 ? `<div style="display: flex; align-items: center; color: #666;">+${galleryImages.length - 4} m√°s</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Google Maps y Sitio Web -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            ${hotel.googleMaps ? `
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üó∫Ô∏è Google Maps</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                    <a href="${hotel.googleMaps}" target="_blank" style="color: #1976d2; text-decoration: none;">üìç Ver en Google Maps</a>
                                </div>
                            </div>
                            ` : '<div></div>'}
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: #2e7d32;">üåê Sitio Web del Hotel</label>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #a5d6a7;">
                                    ${hotel.website ? `<a href="${hotel.website}" target="_blank" style="color: #1976d2; text-decoration: none;">üîó Visitar sitio web</a>` : '<span style="color: #999;">No configurado</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Acceso Autom√°tico a Sitio Web -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span>ü§ñ</span> Acceso Autom√°tico al Sitio Web
                        <span style="font-size: 0.8rem; color: #2e7d32; font-weight: normal;">(Flor buscar√° informaci√≥n autom√°ticamente)</span>
                    </h4>
                    ${hotel.website ? `
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #a5d6a7;">
                        <p style="margin: 0 0 12px 0; color: #1b5e20;">
                            ‚úÖ <strong>Sitio web configurado:</strong> <a href="${hotel.website}" target="_blank" style="color: #1976d2;">${hotel.website}</a>
                        </p>
                        <p style="margin: 0; font-size: 0.9rem; color: #2e7d32;">
                            üîÑ Cuando un cliente pregunte sobre este hotel, Flor utilizar√° la informaci√≥n del sitio web oficial para dar respuestas precisas y actualizadas.
                        </p>
                    </div>
                    ` : `
                    <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border: 1px solid #ffcc80;">
                        <p style="margin: 0; color: #e65100;">
                            ‚ö†Ô∏è <strong>Sin sitio web configurado.</strong> Ve a <strong>Hoteles ‚Üí Editar</strong> y agrega la URL del sitio web del hotel para que Flor pueda buscar informaci√≥n autom√°ticamente.
                        </p>
                    </div>
                    `}
                </div>
                
                <!-- Informaci√≥n Adicional (Opcional) -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span>üìù</span> Informaci√≥n Adicional del Sitio Web
                        <span style="font-size: 0.8rem; color: #e65100; font-weight: normal;">(Opcional - Solo si quieres agregar info espec√≠fica)</span>
                    </h4>
                    <p style="font-size: 0.85rem; color: #bf360c; margin-bottom: 12px;">
                        üí° Si hay informaci√≥n espec√≠fica que Flor no puede encontrar en el sitio web, puedes agregarla aqu√≠ manualmente.
                    </p>
                    <div>
                        <textarea id="knowledge-website-info" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ffcc80; border-radius: 8px; background: white;" placeholder="Informaci√≥n adicional opcional:&#10;- Promociones especiales no publicadas&#10;- Pol√≠ticas internas&#10;- Datos de contacto directos&#10;- Cualquier informaci√≥n que no est√© en la web...">${extraKnowledge.websiteInfo || ''}</textarea>
                    </div>
                </div>
                
                <!-- Informaci√≥n Extra para Flor (Editable) -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                    <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span>‚úèÔ∏è</span> Informaci√≥n Adicional para Flor
                        <span style="font-size: 0.8rem; color: #1565c0; font-weight: normal;">(Editable)</span>
                    </h4>
                    
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">üìù Descripci√≥n Detallada para Flor</label>
                            <textarea id="knowledge-description" rows="4" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Descripci√≥n ampliada que Flor usar√° para responder consultas. Ejemplo: caracter√≠sticas √∫nicas, ambiente, qu√© hace especial a este hotel...">${extraKnowledge.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">üéØ Detalle de Servicios para Flor</label>
                            <textarea id="knowledge-services-detail" rows="4" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Informaci√≥n detallada de servicios. Ejemplo: horarios de spa, tipo de comida en restaurante, actividades disponibles...">${extraKnowledge.servicesDetail || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">üí∞ Informaci√≥n de Precios para Flor</label>
                            <textarea id="knowledge-pricing" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Informaci√≥n de tarifas. Ejemplo: temporada alta/baja, promociones, qu√© incluye el precio...">${extraKnowledge.pricing || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">üöó C√≥mo Llegar / Transporte</label>
                            <textarea id="knowledge-transport" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Informaci√≥n de transporte. Ejemplo: distancia desde aeropuerto, transfers disponibles, acceso en auto...">${extraKnowledge.transport || ''}</textarea>
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #1565c0;">üìã Notas Adicionales</label>
                            <textarea id="knowledge-notes" rows="3" style="width: 100%; padding: 12px; border: 1px solid #90caf9; border-radius: 8px; background: white;" placeholder="Cualquier otra informaci√≥n relevante que Flor deba saber...">${extraKnowledge.notes || ''}</textarea>
                        </div>
                        
                        <button class="form-button" style="background: #4caf50; color: white; width: fit-content;" onclick="saveHotelKnowledge('${hotelId}')">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">save</span>
                            Guardar Informaci√≥n Adicional
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Guardar ID del hotel seleccionado
        window.currentHotelIdForKnowledge = hotelId;
    };

    // Guardar conocimiento del hotel
    window.saveHotelKnowledge = function(hotelId) {
        // Obtener informaci√≥n sincronizada del hotel
        const hotels = JSON.parse(localStorage.getItem('hotelsDB') || '[]');
        const hotel = hotels.find(h => h.id === hotelId);
        
        // Guardar conocimiento extra de Flor
        const knowledge = JSON.parse(localStorage.getItem('flor_hotel_knowledge') || '{}');
        knowledge[hotelId] = {
            // Informaci√≥n extra editable
            description: document.getElementById('knowledge-description')?.value || '',
            servicesDetail: document.getElementById('knowledge-services-detail')?.value || '',
            pricing: document.getElementById('knowledge-pricing')?.value || '',
            transport: document.getElementById('knowledge-transport')?.value || '',
            notes: document.getElementById('knowledge-notes')?.value || '',
            // Informaci√≥n extra√≠da del sitio web
            websiteInfo: document.getElementById('knowledge-website-info')?.value || '',
            // Referencia a informaci√≥n sincronizada (para acceso r√°pido)
            syncedInfo: hotel ? {
                name: hotel.name,
                location: hotel.location,
                rating: hotel.rating,
                priceRange: hotel.priceRange || hotel.price_range,
                amenities: hotel.amenities,
                mainImage: hotel.mainImage || (hotel.images && hotel.images[0]),
                galleryImages: hotel.galleryImages || (hotel.images && hotel.images.slice(1)),
                googleMaps: hotel.googleMaps,
                website: hotel.website
            } : null,
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem('flor_hotel_knowledge', JSON.stringify(knowledge));
        
        // Tambi√©n actualizar la base de conocimiento de Flor (FlorKnowledgeBase) si est√° disponible
        if (typeof FlorKnowledgeBase !== 'undefined') {
            FlorKnowledgeBase.saveHotelKnowledge(hotelId, knowledge[hotelId]);
        }
        
        alert('‚úÖ Informaci√≥n adicional para Flor guardada');
        console.log('üíæ Conocimiento guardado para hotel:', hotelId, knowledge[hotelId]);
    };

    // Inicializar cuando se carga la secci√≥n
    const florOriginalShowSection = window.showSection;
    if (florOriginalShowSection) {
        window.showSection = function(section, event) {
            florOriginalShowSection(section, event);
            
            if (section === 'flor-config') {
                loadFlorGeneral();
                loadFlorResponses();
                loadHotelsForFlor();
                // Cargar configuraci√≥n de IA desde Supabase
                loadAIConfigFromSupabase();
            }
            if (section === 'interactions') {
                // Esperar a que el DOM est√© listo antes de cargar
                setTimeout(() => {
                    console.log('üîÑ Ejecutando loadInteractions desde showSection...');
                    if (typeof window.loadInteractions === 'function') {
                        window.loadInteractions();
                    } else if (typeof loadInteractions === 'function') {
                        loadInteractions();
                    } else {
                        console.error('‚ùå loadInteractions no est√° definida');
                    }
                }, 100);
            }
            if (section === 'chats') {
                // Esperar a que el DOM est√© listo antes de cargar
                setTimeout(() => {
                    console.log('üîÑüîÑüîÑ CAMBIO A SECCI√ìN CHATS');
                    console.log('üîç Verificando funciones disponibles...');
                    console.log('  - window.cargarChatsAhora existe?', typeof window.cargarChatsAhora);
                    
                    if (typeof window.cargarChatsAhora === 'function') {
                        console.log('‚úÖ‚úÖ‚úÖ LLAMANDO A window.cargarChatsAhora()...');
                        window.cargarChatsAhora();
                    } else {
                        console.error('‚ùå‚ùå‚ùå cargarChatsAhora NO EST√Å DEFINIDA');
                        console.error('‚ö†Ô∏è El script de chats puede no haberse cargado. Recarga la p√°gina.');
                    }
                }, 200);
            }
        };
    }

    console.log('ü§ñ M√≥dulo Flor IA / Interacciones / Chats cargado correctamente');
    </script>
    <!-- ==================== FIN SCRIPT FLOR IA ==================== -->
    
    <!-- Sistema Flor - Chatbot con aprendizaje (deshabilitado - integrado en WhatsApp server) -->
    <!-- <script src="flor-knowledge-base.js"></script> -->
    <!-- <script src="flor-ai-service.js"></script> -->
    <!-- <script src="flor-learning-system.js"></script> -->
    <!-- <script src="flor-agent.js"></script> -->
    
    <!-- Widget Chatbot Flor (deshabilitado) -->
    <!-- <script src="flor-widget.js"></script> -->
    
    <!-- Script de Migraci√≥n (no necesario - ya migrado) -->
    <!-- <script src="migrate-to-supabase.js"></script> -->
    
    <!-- Verificar conexi√≥n con Supabase al cargar -->
    <script>
        // Verificar conexi√≥n cuando el dashboard est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                if (window.supabaseClient && window.supabaseClient.isInitialized()) {
                    try {
                        const testResult = await window.supabaseClient.testConnection();
                        if (testResult.success) {
                            console.log('‚úÖ Conexi√≥n con Supabase verificada correctamente');
                            console.log('üíæ Los datos se guardar√°n en la nube autom√°ticamente');
                        } else {
                            console.warn('‚ö†Ô∏è No se pudo conectar con Supabase:', testResult.error);
                            console.warn('üíæ Se usar√° localStorage como respaldo');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error verificando conexi√≥n con Supabase:', error);
                        console.warn('üíæ Se usar√° localStorage como respaldo');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Supabase no est√° configurado. Los datos se guardar√°n solo en localStorage.');
                    console.warn('üìñ Para activar el guardado en la nube, configura tus credenciales en supabase-config.js');
                }
            }, 1000);
        });
    </script>
    </div>
    <!-- Fin del contenido del Dashboard -->
    
    <!-- SCRIPT PARA CARGAR CHATS - SE EJECUTA SIEMPRE AL FINAL -->
    <script>
    (function() {
        'use strict';
        console.log('üéØüéØüéØüéØüéØ SCRIPT DE CHATS CARGADO - ' + new Date().toISOString());
        console.log('üéØ Este log DEBE aparecer siempre al cargar la p√°gina');
    
    // Funci√≥n para cargar chats directamente - VERSI√ìN FINAL
    window.cargarChatsAhora = async function() {
        console.log('üöÄ EJECUTANDO cargarChatsAhora() - ' + new Date().toISOString());
        const chatsList = document.getElementById('chatsList');
        if (!chatsList) {
            console.error('‚ùå chatsList no encontrado');
            return;
        }
        
        try {
            chatsList.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span><p>Cargando...</p></div>';
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                throw new Error('Supabase no est√° inicializado');
            }
            
            const { data, error } = await window.supabaseClient.client
                .from('whatsapp_chats')
                .select('*')
                .order('last_message_time', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            const chats = (data || []).filter(chat => {
                const phone = chat.phone || '';
                return !phone.includes('@broadcast') && !phone.includes('@g.us') && !phone.includes('status@');
            });
            
            console.log(`‚úÖ ${chats.length} chats encontrados`);
            
            if (chats.length === 0) {
                chatsList.innerHTML = '<div style="text-align: center; padding: 40px 16px; color: #666;"><span class="material-icons" style="font-size: 36px; color: #ccc;">forum</span><p style="margin-top: 12px;">No hay chats activos</p></div>';
                return;
            }
            
            chatsList.innerHTML = chats.map(chat => {
                const phone = (chat.phone || 'Sin n√∫mero').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const name = (chat.name || phone).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const lastMessage = (chat.last_message || 'Sin mensajes').substring(0, 50);
                const lastTime = chat.last_message_time ? new Date(chat.last_message_time).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                const unread = chat.unread_count > 0 ? `<span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">${chat.unread_count}</span>` : '';
                
                return `<div onclick="abrirChatAhora('${chat.id}', '${phone}', '${name}')" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; ${chat.unread_count > 0 ? 'background: #f0fff4;' : ''}" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${chat.unread_count > 0 ? '#f0fff4' : 'white'}'"><div style="display: flex; justify-content: space-between; align-items: center;"><strong>${name}${unread}</strong><span style="font-size: 0.75rem; color: #999;">${lastTime}</span></div><p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessage}</p></div>`;
            }).join('');
            
            console.log('‚úÖ Chats renderizados');
        } catch (error) {
            console.error('‚ùå Error:', error);
            chatsList.innerHTML = `<div style="text-align: center; padding: 40px 16px; color: #d32f2f;"><span class="material-icons" style="font-size: 36px; color: #d32f2f;">error</span><p style="margin-top: 12px;">Error al cargar chats</p><p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p></div>`;
        }
    };
    
    // Funci√≥n para abrir chat
    window.abrirChatAhora = async function(chatId, phone, name) {
        console.log('üí¨ Abriendo chat:', chatId, phone, name);
        const chatHeader = document.getElementById('chatHeader');
        const chatMessages = document.getElementById('chatMessages');
        const chatInputContainer = document.getElementById('chatInputContainer');
        
        if (!chatHeader || !chatMessages || !chatInputContainer) {
            console.error('‚ùå Elementos del DOM no encontrados:', { chatHeader: !!chatHeader, chatMessages: !!chatMessages, chatInputContainer: !!chatInputContainer });
            return;
        }
        
        chatHeader.innerHTML = `<h3 style="margin: 0; font-size: 1.1rem;">${name}</h3><p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #666;">${phone}</p>`;
        chatInputContainer.style.display = 'block';
        chatInputContainer.setAttribute('data-chat-id', chatId);
        chatInputContainer.setAttribute('data-phone', phone);
        
        try {
            console.log('üì• Cargando mensajes para chat_id:', chatId);
            chatMessages.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="material-icons" style="animation: spin 1s linear infinite;">sync</span><p>Cargando mensajes...</p></div>';
            
            if (!window.supabaseClient || !window.supabaseClient.isInitialized()) {
                throw new Error('Supabase no est√° inicializado');
            }
            
            console.log('üîç Consultando whatsapp_messages con chat_id:', chatId);
            const { data, error } = await window.supabaseClient.client
                .from('whatsapp_messages')
                .select('*')
                .eq('chat_id', chatId)
                .order('created_at', { ascending: true })
                .limit(100);
            
            if (error) {
                console.error('‚ùå Error en consulta de mensajes:', error);
                throw error;
            }
            
            console.log(`üì® ${data?.length || 0} mensajes encontrados para chat_id ${chatId}`);
            
            if (!data || data.length === 0) {
                console.warn('‚ö†Ô∏è No hay mensajes en Supabase para este chat_id. Buscando mensajes recientes y filtrando por phone...');
                // Limpiar phone para comparar (remover @c.us si existe y solo n√∫meros)
                const cleanPhone = phone.replace('@c.us', '').replace(/[^0-9]/g, '');
                console.log('üîç Phone limpio para filtrar:', cleanPhone);
                
                // Obtener mensajes recientes (sin filtro de phone porque la columna no es consultable)
                // Obtener m√°s mensajes para tener m√°s probabilidades de encontrar los del chat
                console.log('üì° Consultando todos los mensajes recientes de Supabase...');
                const { data: allMessages, error: allError } = await window.supabaseClient.client
                    .from('whatsapp_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500); // Obtener m√°s mensajes para filtrar
                
                if (allError) {
                    console.error('‚ùå Error obteniendo mensajes:', allError);
                    console.error('‚ùå Detalles del error:', JSON.stringify(allError, null, 2));
                    chatMessages.innerHTML = `<div style="text-align: center; padding: 40px; color: #d32f2f;"><span class="material-icons" style="font-size: 48px; color: #d32f2f;">error</span><p style="margin-top: 12px;">Error al cargar mensajes</p><p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${allError.message || 'Error desconocido'}</p></div>`;
                    return;
                }
                
                console.log(`üìä Total de mensajes obtenidos de Supabase: ${allMessages?.length || 0}`);
                if (allMessages && allMessages.length > 0) {
                    console.log('üìã Primeros 3 mensajes (muestra):', allMessages.slice(0, 3).map(m => ({
                        id: m.id,
                        sender: m.sender,
                        recipient: m.recipient,
                        body: m.body?.substring(0, 30),
                        chat_id: m.chat_id
                    })));
                } else {
                    console.warn('‚ö†Ô∏è No se obtuvieron mensajes de Supabase. Posibles causas:');
                    console.warn('  1. No hay mensajes en la tabla whatsapp_messages');
                    console.warn('  2. RLS est√° bloqueando la consulta');
                    console.warn('  3. La tabla est√° vac√≠a');
                }
                
                // Filtrar mensajes que coincidan con el phone del chat
                // La tabla usa 'sender' o 'recipient' en lugar de 'phone'
                const filteredMessages = (allMessages || []).filter(msg => {
                    // La tabla tiene 'sender' (mensajes entrantes) y 'recipient' (mensajes salientes)
                    const msgPhone = msg.sender || msg.recipient || msg.phone;
                    if (!msgPhone) {
                        console.log('‚ö†Ô∏è Mensaje sin phone/sender/recipient:', msg.id);
                        return false;
                    }
                    const msgPhoneClean = String(msgPhone).replace(/[^0-9]/g, '');
                    const matches = msgPhoneClean === cleanPhone || msgPhoneClean.endsWith(cleanPhone) || cleanPhone.endsWith(msgPhoneClean);
                    if (matches) {
                        console.log(`‚úÖ Mensaje coincide: ${msg.id} - phone: ${msgPhone} (limpio: ${msgPhoneClean}) vs ${cleanPhone}`);
                    }
                    return matches;
                });
                
                console.log(`üì® ${filteredMessages.length} mensajes encontrados despu√©s de filtrar por phone (de ${allMessages?.length || 0} mensajes totales)`);
                
                if (filteredMessages.length > 0) {
                    // Ordenar por fecha ascendente para mostrar cronol√≥gicamente
                    filteredMessages.sort((a, b) => {
                        const dateA = new Date(a.created_at || a.timestamp || 0);
                        const dateB = new Date(b.created_at || b.timestamp || 0);
                        return dateA - dateB;
                    });
                    
                    console.log(`‚úÖ Encontrados ${filteredMessages.length} mensajes para este chat`);
                    chatMessages.innerHTML = filteredMessages.map(msg => {
                        const isFromMe = msg.is_from_me;
                        // La tabla usa 'body', no 'message'
                        const message = (msg.body || msg.message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        // Usar sent_at si existe, sino created_at
                        const time = (msg.sent_at || msg.created_at) ? new Date(msg.sent_at || msg.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                        return `<div style="display: flex; justify-content: ${isFromMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;"><div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${isFromMe ? '#dcf8c6' : 'white'}; box-shadow: 0 1px 2px rgba(0,0,0,0.1);"><p style="margin: 0; font-size: 0.9rem; word-wrap: break-word;">${message}</p><span style="font-size: 0.7rem; color: #999; margin-top: 4px; display: block; text-align: right;">${time}</span></div></div>`;
                    }).join('');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Actualizar los mensajes encontrados para asignarles el chat_id correcto
                    const messagesToUpdate = filteredMessages.filter(msg => !msg.chat_id || msg.chat_id !== chatId);
                    if (messagesToUpdate.length > 0) {
                        console.log(`üîÑ Actualizando ${messagesToUpdate.length} mensajes con chat_id ${chatId}...`);
                        for (const msg of messagesToUpdate) {
                            try {
                                await window.supabaseClient.client
                                    .from('whatsapp_messages')
                                    .update({ chat_id: chatId })
                                    .eq('id', msg.id);
                            } catch (updateError) {
                                console.warn('‚ö†Ô∏è Error actualizando chat_id del mensaje:', updateError);
                            }
                        }
                    }
                    
                    // Usar los mensajes filtrados para la suscripci√≥n
                    data = filteredMessages;
                } else {
                    chatMessages.innerHTML = '<p style="text-align: center; color: #666; margin-top: 60px;">No hay mensajes en este chat</p>';
                    return;
                }
            }
            
            console.log('‚úÖ Renderizando', data.length, 'mensajes');
            chatMessages.innerHTML = data.map(msg => {
                const isFromMe = msg.is_from_me;
                // La tabla usa 'body', no 'message'
                const message = (msg.body || msg.message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // Usar sent_at si existe, sino created_at
                const time = (msg.sent_at || msg.created_at) ? new Date(msg.sent_at || msg.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                return `<div style="display: flex; justify-content: ${isFromMe ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;"><div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${isFromMe ? '#dcf8c6' : 'white'}; box-shadow: 0 1px 2px rgba(0,0,0,0.1);"><p style="margin: 0; font-size: 0.9rem; word-wrap: break-word;">${message}</p><span style="font-size: 0.7rem; color: #999; margin-top: 4px; display: block; text-align: right;">${time}</span></div></div>`;
            }).join('');
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('‚úÖ Mensajes renderizados correctamente');
            
            await window.supabaseClient.client
                .from('whatsapp_chats')
                .update({ unread_count: 0 })
                .eq('id', chatId);
            
            // Suscribirse a nuevos mensajes en tiempo real
            if (window.supabaseClient && typeof window.supabaseClient.subscribeToWhatsAppMessages === 'function') {
                console.log('üîÑ Configurando suscripci√≥n en tiempo real para este chat...');
                window.supabaseClient.subscribeToWhatsAppMessages((newMessage) => {
                    // Solo actualizar si el mensaje es de este chat
                    const messageChatId = newMessage.chat_id || newMessage.new?.chat_id;
                    // La tabla usa 'sender' o 'recipient' en lugar de 'phone'
                    const messagePhone = newMessage.sender || newMessage.recipient || newMessage.phone || newMessage.new?.sender || newMessage.new?.recipient || newMessage.new?.phone;
                    const cleanPhone = phone.replace('@c.us', '').replace(/[^0-9]/g, '');
                    const messageCleanPhone = (messagePhone || '').replace(/[^0-9]/g, '');
                    
                    if (messageChatId === chatId || messageCleanPhone === cleanPhone) {
                        console.log('üì® Nuevo mensaje recibido, recargando chat...');
                        setTimeout(() => {
                            window.abrirChatAhora(chatId, phone, name);
                        }, 500);
                    }
                });
            }
        } catch (error) {
            console.error('‚ùå Error cargando mensajes:', error);
            console.error('‚ùå Stack trace:', error.stack);
            chatMessages.innerHTML = `<div style="text-align: center; padding: 40px; color: #d32f2f;"><span class="material-icons" style="font-size: 48px; color: #d32f2f;">error</span><p style="margin-top: 12px;">Error al cargar mensajes</p><p style="margin-top: 8px; font-size: 0.85rem; color: #999;">${error.message || 'Error desconocido'}</p></div>`;
        }
    };
    
    // Funci√≥n para enviar mensaje
    window.enviarMensajeAhora = async function() {
        const input = document.getElementById('chatMessageInput');
        const message = input?.value?.trim();
        const chatInputContainer = document.getElementById('chatInputContainer');
        const phone = chatInputContainer?.getAttribute('data-phone');
        const chatId = chatInputContainer?.getAttribute('data-chat-id');
        
        if (!message || !phone) {
            console.warn('‚ö†Ô∏è No hay mensaje o tel√©fono para enviar');
            return;
        }
        
        try {
            console.log('üì§ Enviando mensaje a', phone, ':', message);
            const serverUrl = document.getElementById('whatsapp-server-url')?.value || localStorage.getItem('whatsappServerURL') || 'http://localhost:3001';
            const response = await fetch(`${serverUrl}/api/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ number: phone, message: message })
            });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Error al enviar mensaje');
            
            console.log('‚úÖ Mensaje enviado correctamente');
            input.value = '';
            
            // Recargar mensajes despu√©s de enviar
            if (chatId) {
                console.log('üîÑ Recargando mensajes del chat...');
                setTimeout(() => {
                    window.abrirChatAhora(chatId, phone, document.getElementById('chatHeader')?.querySelector('h3')?.textContent || phone);
                }, 1000);
            }
            
            // Recargar lista de chats
            setTimeout(() => window.cargarChatsAhora(), 1500);
        } catch (error) {
            console.error('‚ùå Error enviando mensaje:', error);
            alert('Error al enviar mensaje: ' + error.message);
        }
    };
    
    // Observar cuando se muestra la secci√≥n de chats
    (function() {
        function initObserver() {
            const chatsSection = document.getElementById('chats-section');
            if (!chatsSection) {
                setTimeout(initObserver, 500);
                return;
            }
            
            console.log('‚úÖ chats-section encontrado, configurando observador...');
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const isVisible = chatsSection.style.display !== 'none';
                        if (isVisible) {
                            console.log('üëÅÔ∏è Secci√≥n de chats visible, cargando...');
                            setTimeout(() => {
                                if (typeof window.cargarChatsAhora === 'function') {
                                    window.cargarChatsAhora();
                                }
                            }, 100);
                        }
                    }
                });
            });
            
            observer.observe(chatsSection, { attributes: true, attributeFilter: ['style'] });
            console.log('‚úÖ Observador configurado');
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initObserver);
        } else {
            initObserver();
        }
    })();
    
        console.log('‚úÖ‚úÖ‚úÖ FUNCIONES DE CHATS DEFINIDAS - cargarChatsAhora, abrirChatAhora, enviarMensajeAhora');
    })();

    // ===== GESTI√ìN DE M√öLTIPLES CONEXIONES WHATSAPP =====
    const whatsappInstanceIntervals = {};

    // Abrir modal de conexi√≥n m√∫ltiple
    window.openWhatsAppMultiConnectModal = function() {
        console.log('üîÑ Abriendo modal de WhatsApp m√∫ltiple...');
        const modal = document.getElementById('whatsapp-multi-connect-modal');
        if (modal) {
            console.log('‚úÖ Modal encontrado, mostrando...');
            modal.style.display = 'flex';
            modal.style.zIndex = '10000';
            if (typeof renderWhatsAppInstances === 'function') {
                renderWhatsAppInstances();
            } else {
                console.error('‚ùå renderWhatsAppInstances no est√° definida');
            }
        } else {
            console.error('‚ùå Modal whatsapp-multi-connect-modal no encontrado');
        }
    };

    // Cerrar modal de conexi√≥n m√∫ltiple
    window.closeWhatsAppMultiConnectModal = function() {
        const modal = document.getElementById('whatsapp-multi-connect-modal');
        if (modal) {
            modal.style.display = 'none';
            // Detener todos los intervalos de verificaci√≥n
            Object.values(whatsappInstanceIntervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
            Object.keys(whatsappInstanceIntervals).forEach(key => {
                whatsappInstanceIntervals[key] = null;
            });
        }
    };

    // Renderizar las 4 instancias de WhatsApp
    function renderWhatsAppInstances() {
        const grid = document.getElementById('whatsapp-instances-grid');
        if (!grid) return;

        grid.innerHTML = '';

        for (let i = 1; i <= 4; i++) {
            const instanceCard = createInstanceCard(i);
            grid.appendChild(instanceCard);
            // Verificar estado inicial
            checkWhatsAppInstanceStatus(i);
        }
    }

    // Crear tarjeta de instancia
    function createInstanceCard(instanceNumber) {
        const card = document.createElement('div');
        card.className = 'whatsapp-instance-card disconnected';
        card.id = `whatsapp-instance-${instanceNumber}`;
        
        card.innerHTML = `
            <div class="instance-header">
                <div class="instance-title">
                    <span>üì±</span>
                    <span>WhatsApp ${instanceNumber}</span>
                </div>
                <div class="instance-status disconnected" id="instance-${instanceNumber}-status">
                    ‚è≥ Desconectado
                </div>
            </div>
            
            <div class="instance-info" id="instance-${instanceNumber}-info">
                <div><strong>Estado:</strong> <span id="instance-${instanceNumber}-state">Esperando conexi√≥n</span></div>
                <div><strong>N√∫mero:</strong> <span id="instance-${instanceNumber}-phone">-</span></div>
                <div><strong>Nombre:</strong> <span id="instance-${instanceNumber}-name">-</span></div>
            </div>
            
            <div class="instance-qr-container" id="instance-${instanceNumber}-qr">
                <div style="text-align: center; color: #666;">
                    <p>Haz clic en "Conectar" para generar el c√≥digo QR</p>
                </div>
            </div>
            
            <div class="instance-actions">
                <button class="btn-connect" onclick="connectWhatsAppInstance(${instanceNumber})" id="instance-${instanceNumber}-btn-connect">
                    üîó Conectar
                </button>
                <button class="btn-disconnect" onclick="disconnectWhatsAppInstance(${instanceNumber})" id="instance-${instanceNumber}-btn-disconnect" style="display: none;">
                    üîå Desconectar
                </button>
                <button class="btn-refresh" onclick="refreshWhatsAppInstance(${instanceNumber})" id="instance-${instanceNumber}-btn-refresh">
                    üîÑ Actualizar
                </button>
            </div>
        `;
        
        return card;
    }

    // Conectar instancia de WhatsApp
    window.connectWhatsAppInstance = async function(instanceNumber) {
        console.log(`üîÑ Conectando instancia ${instanceNumber} de WhatsApp...`);
        
        const card = document.getElementById(`whatsapp-instance-${instanceNumber}`);
        const statusEl = document.getElementById(`instance-${instanceNumber}-status`);
        const stateEl = document.getElementById(`instance-${instanceNumber}-state`);
        const qrContainer = document.getElementById(`instance-${instanceNumber}-qr`);
        const btnConnect = document.getElementById(`instance-${instanceNumber}-btn-connect`);
        const btnDisconnect = document.getElementById(`instance-${instanceNumber}-btn-disconnect`);
        
        // Actualizar estado a "conectando"
        card.className = 'whatsapp-instance-card connecting';
        statusEl.className = 'instance-status connecting';
        statusEl.textContent = 'üîÑ Conectando...';
        stateEl.textContent = 'Generando c√≥digo QR...';
        btnConnect.disabled = true;
        btnConnect.textContent = '‚è≥ Conectando...';
        
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://72.61.58.240:3001';
        const baseUrl = serverUrl.replace(/:\d+$/, '');
        const instancePort = 3001 + (instanceNumber - 1);
        const instanceUrl = `${baseUrl}:${instancePort}`;
        
        try {
            const response = await fetch(`${instanceUrl}/api/status`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error(`Servidor no responde en puerto ${instancePort}`);
            }
            
            const data = await response.json();
            
            if (data.connected) {
                updateInstanceCard(instanceNumber, {
                    connected: true,
                    phoneNumber: data.phoneNumber || '-',
                    userName: data.userName || '-',
                    lastActivity: data.lastActivity || 'Ahora'
                });
            } else if (data.qrCode) {
                updateInstanceCard(instanceNumber, {
                    connected: false,
                    qrCode: data.qrCode
                });
                startInstanceStatusCheck(instanceNumber, instanceUrl);
            } else {
                qrContainer.innerHTML = `
                    <div style="text-align: center;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 12px; color: #666;">Generando c√≥digo QR...</p>
                    </div>
                `;
                startInstanceStatusCheck(instanceNumber, instanceUrl);
            }
            
        } catch (error) {
            console.error(`‚ùå Error conectando instancia ${instanceNumber}:`, error);
            
            card.className = 'whatsapp-instance-card error';
            statusEl.className = 'instance-status error';
            statusEl.textContent = '‚ùå Error';
            stateEl.textContent = `Error: ${error.message}`;
            qrContainer.innerHTML = `
                <div style="text-align: center; color: #f44336;">
                    <p>‚ö†Ô∏è No se pudo conectar con el servidor</p>
                    <p style="font-size: 0.85rem; margin-top: 8px;">Verifica que el servidor est√© corriendo en el puerto ${instancePort}</p>
                </div>
            `;
            btnConnect.disabled = false;
            btnConnect.textContent = 'üîó Conectar';
        }
    };

    // Actualizar tarjeta de instancia
    function updateInstanceCard(instanceNumber, data) {
        const card = document.getElementById(`whatsapp-instance-${instanceNumber}`);
        const statusEl = document.getElementById(`instance-${instanceNumber}-status`);
        const stateEl = document.getElementById(`instance-${instanceNumber}-state`);
        const phoneEl = document.getElementById(`instance-${instanceNumber}-phone`);
        const nameEl = document.getElementById(`instance-${instanceNumber}-name`);
        const qrContainer = document.getElementById(`instance-${instanceNumber}-qr`);
        const btnConnect = document.getElementById(`instance-${instanceNumber}-btn-connect`);
        const btnDisconnect = document.getElementById(`instance-${instanceNumber}-btn-disconnect`);
        
        if (data.connected) {
            card.className = 'whatsapp-instance-card connected';
            statusEl.className = 'instance-status connected';
            statusEl.textContent = '‚úÖ Conectado';
            stateEl.textContent = 'Conectado y listo';
            phoneEl.textContent = data.phoneNumber || '-';
            nameEl.textContent = data.userName || '-';
            qrContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 12px;">‚úÖ</div>
                    <p style="color: #4caf50; font-weight: 600;">WhatsApp Conectado</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">Flor IA activa para este n√∫mero</p>
                </div>
            `;
            btnConnect.style.display = 'none';
            btnDisconnect.style.display = 'block';
            
            if (whatsappInstanceIntervals[instanceNumber]) {
                clearInterval(whatsappInstanceIntervals[instanceNumber]);
                whatsappInstanceIntervals[instanceNumber] = null;
            }
        } else if (data.qrCode) {
            card.className = 'whatsapp-instance-card disconnected';
            statusEl.className = 'instance-status disconnected';
            statusEl.textContent = 'üì≤ Escanea QR';
            stateEl.textContent = 'Esperando escaneo del c√≥digo QR';
            qrContainer.innerHTML = `
                <div style="text-align: center;">
                    <img src="${data.qrCode}" alt="QR Code" style="max-width: 200px; border-radius: 8px; border: 3px solid #25D366;">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 12px;">
                        Abre WhatsApp ‚Üí Dispositivos vinculados ‚Üí Vincular dispositivo
                    </p>
                </div>
            `;
            btnConnect.disabled = false;
            btnConnect.textContent = 'üîó Conectar';
            btnConnect.style.display = 'block';
            btnDisconnect.style.display = 'none';
        }
    }

    // Verificar estado de instancia
    async function checkWhatsAppInstanceStatus(instanceNumber) {
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://72.61.58.240:3001';
        const baseUrl = serverUrl.replace(/:\d+$/, '');
        const instancePort = 3001 + (instanceNumber - 1);
        const instanceUrl = `${baseUrl}:${instancePort}`;
        
        try {
            const response = await fetch(`${instanceUrl}/api/status`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.connected) {
                    updateInstanceCard(instanceNumber, {
                        connected: true,
                        phoneNumber: data.phoneNumber || '-',
                        userName: data.userName || '-',
                        lastActivity: data.lastActivity || 'Ahora'
                    });
                } else if (data.qrCode) {
                    updateInstanceCard(instanceNumber, {
                        connected: false,
                        qrCode: data.qrCode
                    });
                }
            }
        } catch (error) {
            console.log(`Instancia ${instanceNumber} no disponible`);
        }
    }

    // Iniciar verificaci√≥n peri√≥dica de estado
    function startInstanceStatusCheck(instanceNumber, instanceUrl) {
        if (whatsappInstanceIntervals[instanceNumber]) {
            clearInterval(whatsappInstanceIntervals[instanceNumber]);
        }
        
        whatsappInstanceIntervals[instanceNumber] = setInterval(async () => {
            try {
                const response = await fetch(`${instanceUrl}/api/status`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.connected) {
                        updateInstanceCard(instanceNumber, {
                            connected: true,
                            phoneNumber: data.phoneNumber || '-',
                            userName: data.userName || '-',
                            lastActivity: data.lastActivity || 'Ahora'
                        });
                    } else if (data.qrCode) {
                        updateInstanceCard(instanceNumber, {
                            connected: false,
                            qrCode: data.qrCode
                        });
                    }
                }
            } catch (error) {
                console.error(`Error verificando instancia ${instanceNumber}:`, error);
            }
        }, 5000);
    }

    // Desconectar instancia
    window.disconnectWhatsAppInstance = async function(instanceNumber) {
        if (!confirm(`¬øEst√°s seguro de desconectar WhatsApp ${instanceNumber}?`)) {
            return;
        }
        
        const serverUrl = document.getElementById('whatsapp-server-url')?.value || 'http://72.61.58.240:3001';
        const baseUrl = serverUrl.replace(/:\d+$/, '');
        const instancePort = 3001 + (instanceNumber - 1);
        const instanceUrl = `${baseUrl}:${instancePort}`;
        
        try {
            const response = await fetch(`${instanceUrl}/api/logout`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const card = document.getElementById(`whatsapp-instance-${instanceNumber}`);
                const statusEl = document.getElementById(`instance-${instanceNumber}-status`);
                const stateEl = document.getElementById(`instance-${instanceNumber}-state`);
                const qrContainer = document.getElementById(`instance-${instanceNumber}-qr`);
                const btnConnect = document.getElementById(`instance-${instanceNumber}-btn-connect`);
                const btnDisconnect = document.getElementById(`instance-${instanceNumber}-btn-disconnect`);
                
                card.className = 'whatsapp-instance-card disconnected';
                statusEl.className = 'instance-status disconnected';
                statusEl.textContent = '‚è≥ Desconectado';
                stateEl.textContent = 'Desconectado';
                qrContainer.innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p>Haz clic en "Conectar" para generar el c√≥digo QR</p>
                    </div>
                `;
                btnConnect.style.display = 'block';
                btnDisconnect.style.display = 'none';
                
                if (whatsappInstanceIntervals[instanceNumber]) {
                    clearInterval(whatsappInstanceIntervals[instanceNumber]);
                    whatsappInstanceIntervals[instanceNumber] = null;
                }
                
                alert('WhatsApp desconectado correctamente');
            } else {
                alert('Error al desconectar WhatsApp');
            }
        } catch (error) {
            console.error('Error desconectando WhatsApp:', error);
            alert('Error al desconectar WhatsApp: ' + error.message);
        }
    };

    // Refrescar instancia
    window.refreshWhatsAppInstance = function(instanceNumber) {
        checkWhatsAppInstanceStatus(instanceNumber);
    };

    // Guardar configuraci√≥n de WhatsApp
    window.saveWhatsAppConfig = function() {
        const config = {
            serverUrl: document.getElementById('whatsapp-server-url')?.value || 'http://72.61.58.240:3001',
            autoReply: document.getElementById('whatsapp-auto-reply')?.checked || false,
            businessHoursOnly: document.getElementById('whatsapp-business-hours-only')?.checked || false,
            outOfHoursMessage: document.getElementById('whatsapp-out-of-hours-message')?.value || ''
        };
        
        localStorage.setItem('whatsappConfig', JSON.stringify(config));
        console.log('‚úÖ Configuraci√≥n de WhatsApp guardada');
        alert('Configuraci√≥n de WhatsApp guardada correctamente');
    };

    // Verificar conexi√≥n con WhatsApp (funci√≥n b√°sica)
    window.checkWhatsAppConnection = function() {
        console.log('üîÑ Verificando conexi√≥n con WhatsApp...');
        // Esta funci√≥n puede ser expandida seg√∫n necesidades
    };

    // Cerrar modal al hacer clic fuera
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('whatsapp-multi-connect-modal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeWhatsAppMultiConnectModal();
                }
            });
        }
    });
    </script>

    <!-- Modal para Conectar M√∫ltiples WhatsApp -->
    <div id="whatsapp-multi-connect-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
                <h2 style="margin: 0; color: #25D366; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">üì±</span>
                    <span>Conectar M√∫ltiples WhatsApp con IA</span>
                </h2>
                <button onclick="if(typeof closeWhatsAppMultiConnectModal === 'function') { closeWhatsAppMultiConnectModal(); } else { document.getElementById('whatsapp-multi-connect-modal').style.display = 'none'; }" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.color='#f44336'" onmouseout="this.style.color='#666'">&times;</button>
            </div>
            
            <div style="margin-bottom: 24px; padding: 16px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                <p style="margin: 0; color: #1565c0; font-size: 0.95rem; line-height: 1.6;">
                    <strong>ü§ñ Con IA Integrada:</strong> Cada n√∫mero de WhatsApp conectado utilizar√° Flor IA para responder autom√°ticamente a los chats e interacciones. 
                    Puedes conectar hasta 4 n√∫meros diferentes, cada uno con su propio QR.
                </p>
            </div>

            <div id="whatsapp-instances-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <!-- Los 4 slots se generan din√°micamente -->
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; padding-top: 16px; border-top: 2px solid #e0e0e0;">
                <button onclick="if(typeof closeWhatsAppMultiConnectModal === 'function') { closeWhatsAppMultiConnectModal(); } else { document.getElementById('whatsapp-multi-connect-modal').style.display = 'none'; }" style="background: #666; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Estilos para el modal de m√∫ltiples WhatsApp */
        #whatsapp-multi-connect-modal {
            position: fixed !important;
            z-index: 99999 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        #whatsapp-multi-connect-modal .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
            z-index: 100000;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .whatsapp-instance-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .whatsapp-instance-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #25D366;
        }

        .whatsapp-instance-card.connected {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .whatsapp-instance-card.disconnected {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .whatsapp-instance-card.error {
            background: #ffebee;
            border-color: #f44336;
        }

        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .instance-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instance-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .instance-status.connected {
            background: #4caf50;
            color: white;
        }

        .instance-status.disconnected {
            background: #ff9800;
            color: white;
        }

        .instance-status.connecting {
            background: #2196f3;
            color: white;
        }

        .instance-status.error {
            background: #f44336;
            color: white;
        }

        .instance-info {
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #666;
        }

        .instance-info strong {
            color: #333;
        }

        .instance-qr-container {
            text-align: center;
            margin: 16px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            padding: 16px;
        }

        .instance-qr-container img {
            max-width: 200px;
            border-radius: 8px;
            border: 3px solid #25D366;
        }

        .instance-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .instance-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .instance-actions .btn-connect {
            background: #25D366;
            color: white;
        }

        .instance-actions .btn-connect:hover {
            background: #1da851;
        }

        .instance-actions .btn-disconnect {
            background: #ef5350;
            color: white;
        }

        .instance-actions .btn-disconnect:hover {
            background: #e53935;
        }

        .instance-actions .btn-refresh {
            background: #2196f3;
            color: white;
        }

        .instance-actions .btn-refresh:hover {
            background: #1976d2;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html> 